<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r1435 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/navi
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2008-May/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r1435%20-%20in%20trunk%3A%20res_noewe/languages%20src/CacheWolf%0A%09src/CacheWolf/navi&In-Reply-To=%3C200805032319.m43NJI4D018684%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001328.html">
   <LINK REL="Next"  HREF="001330.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r1435 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/navi</H1>
    <B>pfeffer at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r1435%20-%20in%20trunk%3A%20res_noewe/languages%20src/CacheWolf%0A%09src/CacheWolf/navi&In-Reply-To=%3C200805032319.m43NJI4D018684%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r1435 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/navi">pfeffer at mail.berlios.de
       </A><BR>
    <I>Sun May  4 01:19:18 CEST 2008</I>
    <P><UL>
        <LI>Previous message: <A HREF="001328.html">[Cachewolf-svn] r1434 - in trunk: docs res_noewe/languages
</A></li>
        <LI>Next message: <A HREF="001330.html">[Cachewolf-svn] r1436 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1329">[ date ]</a>
              <a href="thread.html#1329">[ thread ]</a>
              <a href="subject.html#1329">[ subject ]</a>
              <a href="author.html#1329">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: pfeffer
Date: 2008-05-04 01:19:14 +0200 (Sun, 04 May 2008)
New Revision: 1435

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/src/CacheWolf/Common.java
   trunk/src/CacheWolf/GPSPortOptions.java
   trunk/src/CacheWolf/navi/Navigate.java
Log:
SerialPortOptionsDialog: provide better information while searching for serial port
GotoPanel: renamed &quot;start&quot; to &quot;start GPS&quot;

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2008-05-03 11:11:06 UTC (rev 1434)
+++ trunk/res_noewe/languages/DE.cfg	2008-05-03 23:19:14 UTC (rev 1435)
@@ -347,8 +347,8 @@
 		1501=Aktuell
 		1502=Grad
 		1503=Nordausrichtung
-		1504=Start
-		1505=Stop
+		1504=Start GPS
+		1505=Stop GPS
 		1506=Karte
 		1507=Koordinaten ung%fcltig:
 		1508=Breite
@@ -795,8 +795,18 @@
 		7103=Suchen$u
 		7104=Testen$t
 		7105=GPS-Daten weiterleiten an Host
-		7106=Alle Daten vom GPS-Empf&#228;nger werden an den eingetragenen Host an TCP-Port 23 weitergeleitet. Mit dem Programm HW Virtual Serial Port kann damit ein virtueller COM-Port eingerichtet werden
+		7106=Alle Daten vom GPS-Empf%e4nger werden an den eingetragenen Host an TCP-Port 23 weitergeleitet. Mit dem Programm HW Virtual Serial Port kann damit ein virtueller COM-Port eingerichtet werden
 		7107=Position alle X Sekunden speichern (NMEA-LOG)
+		7108=Fehler: Konnte folgenden seriellen Port nicht %d6ffnen:+
+		7109=Fehler beim Ermitteln der verf%fcgbaren serielle Ports%0a
+		7110=GPS nicht gefunden%0a
+		7111=Versuche+
+		7112= mit+
+		7113= - einige Daten empfangen%0a
+		7114=GPS-Port gefunden%0a
+		7115= - nicht als GPS-Daten erkannt%0a
+		7116= - keine Daten empfangen%0a
+		7117=Anzeige der Daten direkt vom seriellen Port:
 		
 		{..}
 	{..}

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2008-05-03 11:11:06 UTC (rev 1434)
+++ trunk/res_noewe/languages/EN.cfg	2008-05-03 23:19:14 UTC (rev 1435)
@@ -348,8 +348,8 @@
 		1501=Current
 		1502=deg
 		1503=North centered
-		1504=Start
-		1505=Stop
+		1504=Start GPS
+		1505=Stop GPS
 		1506=Map
 		1507=Coordinates are out of range:
 		1508=latitude
@@ -779,6 +779,16 @@
 		7105=Forward GPS data to host
 		7106=All data from GPS will be sent to TCP-port 23%0a and can be redirected there to a serial port%0a by 
 		7107=Interval in sec for logging
+		7108=Error: Failed to open serial port:+
+		7109=Error: Could not get list of available serial ports%0a
+		7110=GPS not found%0a
+		7111=Trying+
+		7112= at+
+		7113= - got some data%0a
+		7114=GPS Port found%0a
+		7115= - No GPS data tag found%0a
+		7116= - no data received%0a
+		7117=Displaying data from serial port directly:%0a
 		{..}
 	{..}
 {..}

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2008-05-03 11:11:06 UTC (rev 1434)
+++ trunk/res_noewe/languages/FR.cfg	2008-05-03 23:19:14 UTC (rev 1435)
@@ -347,8 +347,8 @@
 		1501=Actuel
 		1502=Degr%e9
 		1503=Orientation septentrional
-		1504=D%e9marrer
-		1505=Stop
+		1504=D%e9marrer GPS
+		1505=Stop GPS
 		1506=Carte
 		1507=Coordonn%e9es pas valides:
 		1508=Latitude

Modified: trunk/src/CacheWolf/Common.java
===================================================================
--- trunk/src/CacheWolf/Common.java	2008-05-03 11:11:06 UTC (rev 1434)
+++ trunk/src/CacheWolf/Common.java	2008-05-03 23:19:14 UTC (rev 1435)
@@ -1,6 +1,8 @@
 package CacheWolf;
 
 import ewe.io.File;
+import ewe.io.SerialPort;
+import ewe.io.SerialPortOptions;
 import ewe.sys.Convert;
 
 public final class Common {
@@ -132,5 +134,11 @@
 		return e.toString().replace(',', '.');
 
 	}
+	
+	public static String fixSerialPortName(String name) {
+		if (name.startsWith(&quot;/&quot;)) return new String(&quot;..&quot;+name); // on linux (*nix) machines it is quite usual to give the complete file path to the serial port, but ewe expects only &quot;ttyS0&quot; or similar
+		else                      return name;
+	}
 
+
 }

Modified: trunk/src/CacheWolf/GPSPortOptions.java
===================================================================
--- trunk/src/CacheWolf/GPSPortOptions.java	2008-05-03 11:11:06 UTC (rev 1434)
+++ trunk/src/CacheWolf/GPSPortOptions.java	2008-05-03 23:19:14 UTC (rev 1435)
@@ -45,12 +45,8 @@
 	TextDisplay out;
 	boolean run;
 	
-	public mySerialThread(SerialPortOptions spo, TextDisplay td){
-		try {
-			comSp = new SerialPort(spo);
-		} catch (IOException e) {
-			Vm.debug(&quot;Error open COM-Port &quot; + spo.portName);
-		}
+	public mySerialThread(SerialPortOptions spo, TextDisplay td) throws IOException {
+		comSp = new SerialPort(spo);
 		out = td;
 	}
 	
@@ -144,26 +140,36 @@
 	public void action(String field,Editor ed){
 		if (field.equals(&quot;scan&quot;)){
 			String[] ports = SerialPort.enumerateAvailablePorts();
-			
-			for (int i=0;i&lt;ports.length;i++){
-				// try open with default GPS baudrate
-				if (!testPort(ports[i], 4800)) continue;
-				else {
-					this.portName = ports[i];
-					ed.toControls(&quot;portName&quot;);
-					this.baudRate = 4800;
-					ed.toControls(&quot;baudRate&quot;);
-					break;
+			txtOutput.setText(&quot;&quot;);
+			if (ports == null) {
+				txtOutput.appendText(MyLocale.getMsg(7109, &quot;Could not get list of available serial ports\n&quot;), true);
+			} else {
+				int i;
+				for (i=0; i&lt;ports.length; i++){
+					// try open with default GPS baudrate
+					if (!testPort(ports[i], baudRate)) 	continue;
+					else {
+						this.portName = ports[i];
+						ed.toControls(&quot;portName&quot;);
+						break;
+					}
 				}
+				if (i &gt;= ports.length) txtOutput.appendText(MyLocale.getMsg(7110, &quot;GPS not found\n&quot;), true);
 			}
 		}
 		if (field.equals(&quot;test&quot;)){
 			if (!gpsRunning){
 				ed.fromControls();
-				serThread = new mySerialThread(this, txtOutput);
-				serThread.start();
-				btnTest.setText(&quot;Stop&quot;);
-				gpsRunning = true;
+				txtOutput.setText(MyLocale.getMsg(7117, &quot;Displaying data from serial port directly:\n&quot;));
+				try {
+					this.portName = Common.fixSerialPortName(portName);
+					serThread = new mySerialThread(this, txtOutput);
+					serThread.start();
+					btnTest.setText(&quot;Stop&quot;);
+					gpsRunning = true;
+				} catch (IOException e) {
+					txtOutput.appendText(MyLocale.getMsg(7108, &quot;Failed to open serial port: &quot;) + this.portName + &quot;, IOException: &quot; + e.getMessage() + &quot;\n&quot;, true);
+				}
 			}
 			else {
 				serThread.stop();
@@ -194,48 +200,34 @@
 		int gpsLen;
 		long now;
 		
-		gpsPort = new SerialPort(port, baud);
-		
-		//try to read some data
-		now = new Time().getTime();
-		txtOutput.appendText(&quot;Trying &quot; + port + &quot; at &quot; + baud + &quot; Baud\n&quot;,true);
-		while ( (new Time().getTime() - now) &lt; 2000){
-			gpsLen = gpsPort.nonBlockingRead(gpsBuff,0, gpsBuff.length);
-			if (gpsLen &gt; 0){
-				txtOutput.appendText(&quot;Port found\n&quot;, true);
-				gpsPort.close();
-				return true;
-			}
+		gpsPort = new SerialPort(Common.fixSerialPortName(port), baud);
+		if(gpsPort == null) {
+			txtOutput.appendText(MyLocale.getMsg(7108, &quot;Failed to open serial port: &quot;) + this.portName + &quot;\n&quot;, true);
+			return false;
 		}
-		gpsPort.close();
-		return false;
-	}
-	
-	private boolean testGPS(String port, int baud){
-		SerialPort gpsPort; 
-		byte[] gpsBuff = new byte[1024];
-		int gpsLen;
-		long now;
 		
-		gpsPort = new SerialPort(port, baud);
-		
 		//try to read some data
 		now = new Time().getTime();
-		Vm.debug(&quot;Trying &quot; + port + &quot; at &quot; + baud + &quot; Baud&quot;);
+		txtOutput.appendText(MyLocale.getMsg(7111, &quot;Trying &quot;) + port + MyLocale.getMsg(7112, &quot; at &quot;) + baud + &quot; Baud\n&quot;, true);
+		boolean gotdata = false;
 		while ( (new Time().getTime() - now) &lt; 3000){
 			gpsLen = gpsPort.nonBlockingRead(gpsBuff,0, gpsBuff.length);
-			Vm.debug(&quot;Len:&quot; + gpsLen);
 			if (gpsLen &gt; 0){
+				if (!gotdata) txtOutput.appendText(MyLocale.getMsg(7113, &quot; - got some data\n&quot;), true);
+				gotdata = true;
 				String tmp = mString.fromAscii(gpsBuff,0,gpsLen);
-				Vm.debug(tmp);
-				if (tmp.startsWith(&quot;$GP&quot;)){
-					Vm.debug(&quot;GPS Port found&quot;);
+				if (tmp.indexOf(&quot;$GP&quot;, 0) &gt;= 0){
+					txtOutput.appendText(MyLocale.getMsg(7114, &quot;GPS Port found\n&quot;), true);
 					gpsPort.close();
 					return true;
 				}
 			}
+			Vm.sleep(200);
 		}
+		if (gotdata) txtOutput.appendText(MyLocale.getMsg(7115, &quot; - No GPS data tag found\n&quot;), true);
+		else         txtOutput.appendText(MyLocale.getMsg(7116, &quot; - no data received\n&quot;), true);
 		gpsPort.close();
 		return false;
 	}
-}
\ No newline at end of file
+	
+}

Modified: trunk/src/CacheWolf/navi/Navigate.java
===================================================================
--- trunk/src/CacheWolf/navi/Navigate.java	2008-05-03 11:11:06 UTC (rev 1434)
+++ trunk/src/CacheWolf/navi/Navigate.java	2008-05-03 23:19:14 UTC (rev 1435)
@@ -171,6 +171,7 @@
 
 	public SerialThread(SerialPortOptions spo, CWGPSPoint GPSPoint, String forwardIP) throws IOException {
 		try{
+			spo.portName = CacheWolf.Common.fixSerialPortName(spo.portName);
 			comSp = new SerialPort(spo);
 		} catch (IOException e) {
 			throw new IOException(spo.portName);
@@ -253,3 +254,4 @@
 	}
 }
 
+


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001328.html">[Cachewolf-svn] r1434 - in trunk: docs res_noewe/languages
</A></li>
	<LI>Next message: <A HREF="001330.html">[Cachewolf-svn] r1436 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1329">[ date ]</a>
              <a href="thread.html#1329">[ thread ]</a>
              <a href="subject.html#1329">[ subject ]</a>
              <a href="author.html#1329">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
