<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r3096 - in trunk: lib/net/ax86 lib/org/json	res_noewe src/CacheWolf/imp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2011-September/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r3096%20-%20in%20trunk%3A%20lib/net/ax86%20lib/org/json%0A%09res_noewe%20src/CacheWolf/imp&In-Reply-To=%3C20110917183805.476D4481216%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="003085.html">
   <LINK REL="Next"  HREF="003086.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r3096 - in trunk: lib/net/ax86 lib/org/json	res_noewe src/CacheWolf/imp</H1>
    <B>araber95 at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r3096%20-%20in%20trunk%3A%20lib/net/ax86%20lib/org/json%0A%09res_noewe%20src/CacheWolf/imp&In-Reply-To=%3C20110917183805.476D4481216%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r3096 - in trunk: lib/net/ax86 lib/org/json	res_noewe src/CacheWolf/imp">araber95 at mail.berlios.de
       </A><BR>
    <I>Sat Sep 17 08:38:05 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="003085.html">[Cachewolf-svn] r3094 - trunk/src/CacheWolf/imp
</A></li>
        <LI>Next message: <A HREF="003086.html">[Cachewolf-svn] r3095 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3087">[ date ]</a>
              <a href="thread.html#3087">[ thread ]</a>
              <a href="subject.html#3087">[ subject ]</a>
              <a href="author.html#3087">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: araber95
Date: 2011-09-17 20:38:04 +0200 (Sat, 17 Sep 2011)
New Revision: 3096

Modified:
   trunk/lib/net/ax86/GPS.class
   trunk/lib/net/ax86/GPSException.class
   trunk/lib/net/ax86/GPSHook.class
   trunk/lib/net/ax86/GPSTest.class
   trunk/lib/org/json/JSONArray.class
   trunk/lib/org/json/JSONException.class
   trunk/lib/org/json/JSONObject$Null.class
   trunk/lib/org/json/JSONObject.class
   trunk/lib/org/json/JSONString.class
   trunk/lib/org/json/JSONTokener.class
   trunk/lib/org/json/Test$1Obj.class
   trunk/lib/org/json/Test.class
   trunk/res_noewe/spider.def
   trunk/src/CacheWolf/imp/SpiderGC.java
Log:
import of logs adapted to Groundspeak Update of September/15/2011

Modified: trunk/lib/net/ax86/GPS.class
===================================================================
(Binary files differ)

Modified: trunk/lib/net/ax86/GPSException.class
===================================================================
(Binary files differ)

Modified: trunk/lib/net/ax86/GPSHook.class
===================================================================
(Binary files differ)

Modified: trunk/lib/net/ax86/GPSTest.class
===================================================================
(Binary files differ)

Modified: trunk/lib/org/json/JSONArray.class
===================================================================
(Binary files differ)

Modified: trunk/lib/org/json/JSONException.class
===================================================================
(Binary files differ)

Modified: trunk/lib/org/json/JSONObject$Null.class
===================================================================
(Binary files differ)

Modified: trunk/lib/org/json/JSONObject.class
===================================================================
(Binary files differ)

Modified: trunk/lib/org/json/JSONString.class
===================================================================
(Binary files differ)

Modified: trunk/lib/org/json/JSONTokener.class
===================================================================
(Binary files differ)

Modified: trunk/lib/org/json/Test$1Obj.class
===================================================================
(Binary files differ)

Modified: trunk/lib/org/json/Test.class
===================================================================
(Binary files differ)

Modified: trunk/res_noewe/spider.def
===================================================================
--- trunk/res_noewe/spider.def	2011-09-17 10:54:44 UTC (rev 3095)
+++ trunk/res_noewe/spider.def	2011-09-17 18:38:04 UTC (rev 3096)
@@ -1,49 +1,5 @@
 #============================================================
 # spider.def - Definition file for reading caches from GC.COM
-# Version 1.0 - 20070526 skg
-# Version 2.0 - 20070531 nach GC &#196;nderungen
-# Version 2.1 - 20070601 TB Anpassung an GC &#196;nderung
-# Version 2.2 - 20070602 firstLine erg&#228;nzt. Damit funktionieren jetzt auch die n&#228;chsten Seiten.
-# Version 2.3 - 20070602 sizeRex an GC &#196;nderungen angepasst
-# Version 2.4 - 20070616 neu: Attribute
-# Version 2.5 - 20070629 Anpassungen an Listen&#228;nderung bei GC
-# Version 2.6 - 20070701 Bugfix: Wenn Zentrum exakt in Cachekoordinaten liegt wurde der Cache nicht gespidert
-# Version 2.7 - 20070811 Bugfix fuer verschluesselte Logs
-# Version 2.8 - 20070814 Findet jetzt auch Addi Wpts in eigenen Caches
-# Version 2.9 - 20070817 Bessere Unterscheidung zwischen Werbung vs.normalen Caches + Caches ohne Richtung/Entfenung
-# Version 2.10 - 20070825 Travelbug support
-# Version 2.11 - 20070907 get travelbug mission by tracking number
-# Version 3.0 - 20071010 adaption to new GC-design
-# Version 3.1 - 20071013 Use the given prefix for addi waypoints
-# Version 3.2 - 20071024 longer end sequence for longDescRex
-# Version 3.3 - 20080316 get travelbug name by tracking number
-# Version 3.4 - 20080227 Image comments added
-# Version 3.5 - 20080529 Modified descRex to allow for linebreaks
-# Version 3.6 - 20080531 Modified descRex to avoid Stack overflow in exe
-# Version 3.7 - 20080613 Some lines generalized for proxies replacing the images.
-# Version 4.0 - 20080725 adaption to new GC-design
-# Version 4.1 - 20080725 adaption to new GC-design (images and travelbugs)
-# Version 4.2 - 20081031 Fix for cache type (background image with name of type)
-# Version 4.3 - 20090314 maxDistance string added
-# Version 4.4 - 20090314 firstPageFinds string added
-# Version 4.5 - 20090315 strings for spidering country/state/logId
-# Version 4.6 - 20090406 Fix for country/state (did not work with US caches)
-# Version 4.7 - 20090521 Strings for single cache types added
-# Version 4.8 - 20090805 More specific unavailability detection
-# Version 4.9 - 20091018 Should work now with proxies and cachetypes as background
-# Version 4.10- 20091021 Tags in Description are now correctly closed
-# Version 4.11- 20091023 Reverted last change, because it doesn't work with EWE/EXE
-# Version 5.0 - 20091105 adaption to new GC-design
-# Version 6.0 - 20100113 adaption to new GC-design
-# Version 6.1 - 20100305 better log recognition
-# Version 7.0 - 20100402 adaption to new GC-design
-# Version 7.1 - 20100528 better description recognition
-# Version 8.0 - 20100604 adaption to new GC-design
-# Version 9.0 - 20100630 adaption to new GC-design
-# Version 10.0 - 20100729 adaption to new GC-design DateHiddenrex , optimized cacheOwnerRex araber95
-# Version 11.0 - 20101110 adaption to new GC-design (maybe not complete)
-# Version 12.0 - 20101223 first little adaption to new GC-design (logs)
-# Version 12.0 - 20101224 adaption to new GC-design (decode distance)
 #============================================================
 # A suffix of Rex indicates a regular expression
 # A suffix of ExStart indicates the start of an Extractor search pattern
@@ -51,6 +7,7 @@
 #
 # Important:
 # * When entering spaces into a string ensure to escape them or write them as \\u0020
+# * escaping space should not be necessary
 # * Be sure that you have no hidden spaces at the end of a line or the patterns will not match!
 #------------------------------------------------------------
 #loginPage          = <A HREF="http://www.geocaching.com/login/default.aspx">http://www.geocaching.com/login/default.aspx</A>
@@ -125,25 +82,7 @@
 #--------------------------------------
 #Section2a: Logs
 #--------------------------------------
-# blockRex extrahiert zun&#228;chst aus der gesamten Seite den Logbereich
-blockRex           = &lt;table class=&quot;LogsTable&quot;&gt;((?s).*?)&lt;/table&gt;\\s+&lt;p&gt;
-# singleLogEx extrahiert in einer Schleife alle Logs aus dem Logbereich
-singleLogExStart   = class=&quot;logOwnerProfileName&quot;
-singleLogExEnd     = class=&quot;AlignRight&quot;&gt;
-# iconEx, nameTempEx, dateEx, singleLogEx werden auf einen singleLog angewendet
-iconExStart        = www.geocaching.com/images/icons/
-iconExEnd          = \ alt=&quot;
-nameTempExStart    = &lt;a\ href=
-nameTempExEnd      = /a&gt;
-# Name extrahiert aus nameTemp
-nameExStart        = &gt;
-nameExEnd          = &lt;
-dateExStart        = LogDate&quot;&gt;
-dateExEnd          = &lt;/span&gt;
-logExStart         = class=&quot;LogText&quot;&gt;
-logExEnd           = &lt;/p&gt;
-logIdExStart       = &quot;\ id=&quot;
-logIdExEnd         = &quot;&gt;
+UserTokenRex       = userToken = '((?s).*?)';
 # Die Icons, die einen erfolgreichen Fund signalisieren
 icon_smile         = icon_smile.gif
 icon_camera        = icon_camera.gif

Modified: trunk/src/CacheWolf/imp/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/imp/SpiderGC.java	2011-09-17 10:54:44 UTC (rev 3095)
+++ trunk/src/CacheWolf/imp/SpiderGC.java	2011-09-17 18:38:04 UTC (rev 3096)
@@ -82,6 +82,8 @@
 import ewesoft.xml.MinML;
 import ewesoft.xml.sax.AttributeList;
 
+import org.json.*;
+
 /**
  * Class to spider caches from gc.com
  */
@@ -164,7 +166,7 @@
 	private static Regex RexPropType;
 	private static Regex RexPropDTS;
 	private static Regex RexPropOwn;
-	private static Regex RexLogBlock;
+	private static Regex RexUserToken;
 	private static Extractor exSingleLog;
 	private static Extractor exIcon;
 	private static Extractor exNameTemp;
@@ -1390,14 +1392,7 @@
 			RexPropType = new Regex(p.getProp(&quot;TypeRex&quot;));
 			RexPropDTS = new Regex(p.getProp(&quot;DTSRex&quot;));
 			RexPropOwn = new Regex(p.getProp(&quot;own&quot;));
-			RexLogBlock = new Regex(p.getProp(&quot;blockRex&quot;));
-			exSingleLog = new Extractor(&quot;&quot;, p.getProp(&quot;singleLogExStart&quot;), p.getProp(&quot;singleLogExEnd&quot;), 0, false);
-			exIcon = new Extractor(&quot;&quot;, p.getProp(&quot;iconExStart&quot;), p.getProp(&quot;iconExEnd&quot;), 0, true);
-			exNameTemp = new Extractor(&quot;&quot;, p.getProp(&quot;nameTempExStart&quot;), p.getProp(&quot;nameTempExEnd&quot;), 0, true);
-			exName = new Extractor(&quot;&quot;, p.getProp(&quot;nameExStart&quot;), p.getProp(&quot;nameExEnd&quot;), 0, true);
-			exDate = new Extractor(&quot;&quot;, p.getProp(&quot;dateExStart&quot;), p.getProp(&quot;dateExEnd&quot;), 0, true);
-			exLog = new Extractor(&quot;&quot;, p.getProp(&quot;logExStart&quot;), p.getProp(&quot;logExEnd&quot;), 0, true);
-			exLogId = new Extractor(&quot;&quot;, p.getProp(&quot;logIdExStart&quot;), p.getProp(&quot;logIdExEnd&quot;), 0, true);
+			RexUserToken = new Regex(p.getProp(&quot;UserTokenRex&quot;));
 			icon_smile = p.getProp(&quot;icon_smile&quot;);
 			icon_camera = p.getProp(&quot;icon_camera&quot;);
 			icon_attended = p.getProp(&quot;icon_attended&quot;);
@@ -2671,61 +2666,66 @@
 	 * @return A HTML string containing the logs
 	 */
 	private void getLogs(String completeWebPage, CacheHolderDetail chD) throws Exception {
-		String icon = &quot;&quot;;
-		String name = &quot;&quot;;
-		String logText = &quot;&quot;;
-		String logId = &quot;&quot;;
-		String singleLog = &quot;&quot;;
+
 		final LogList reslts = chD.CacheLogs;
-		RexLogBlock.search(completeWebPage);
-		if (!RexLogBlock.didMatch()) {
-			pref.log(&quot;[SpiderGC.java:getLogs]check blockRex!&quot;, null);
+
+		RexUserToken.search(completeWebPage);
+		if (!RexUserToken.didMatch()) {
+			pref.log(&quot;[SpiderGC.java:getLogs]check RexUserToken!&quot;, null);
 		}
-		final String LogBlock = RexLogBlock.stringMatched(1);
-
-		exSingleLog.set(LogBlock);
+		final String userToken = RexUserToken.stringMatched(1);
+		int idx = 0;
 		int nLogs = 0;
 		boolean foundown = false;
-		while ((singleLog = exSingleLog.findNext()).length() &gt; 0) {
-			nLogs++;
+		boolean fertig = false;
+		do {
+			idx++;
+			String url=&quot;<A HREF="http://www.geocaching.com/seek/geocache.logbook?tkn=">http://www.geocaching.com/seek/geocache.logbook?tkn=</A>&quot;+userToken+&quot;&amp;idx=&quot;+idx+&quot;&amp;num=10&amp;decrypt=false&quot;;
+			UrlFetcher.setRequestorProperty(&quot;Content-Type&quot;, &quot;application/json; charset=UTF-8&quot;);
+			String page=UrlFetcher.fetch(url);
+			final JSONObject resp = new JSONObject(page);
+			if (!resp.getString(&quot;status&quot;).equals(&quot;success&quot;)) {
+				pref.log(&quot;status is &quot; + resp.getString(&quot;status&quot;));
+			}
+			final JSONArray data = resp.getJSONArray(&quot;data&quot;);
+			fertig = data.length() &lt; 10;
+			for (int index = 0; index &lt; data.length(); index++) {
+				nLogs++;
+				final JSONObject entry = data.getJSONObject(index);
 
-			icon = exIcon.findFirst(singleLog);
-			// ' changes to &quot; in UMTS-connection! first char in iconExEnd.
-			icon = icon.substring(0, icon.length() - 1);
+				final String icon = entry.getString(&quot;LogTypeImage&quot;);
+				final String name = entry.getString(&quot;UserName&quot;);
+				String logText = entry.getString(&quot;LogText&quot;);
+				logText = STRreplace.replace(logText, &quot;&lt;br/&gt;&quot;, &quot;&lt;br&gt;&quot;);
+				logText = correctSmilies(logText);
+				final String d = DateFormat.toYYMMDD(entry.getString(&quot;Visited&quot;));
+				final String logId = entry.getString(&quot;LogID&quot;);
 
-			name = exName.findFirst(exNameTemp.findFirst(singleLog));
-
-			logText = exLog.findFirst(singleLog);
-			logText = correctSmilies(logText);
-
-			logId = exLogId.findFirst(singleLog);
-
-			final String ed = exDate.findFirst(singleLog);
-			final String d = DateFormat.toYYMMDD(ed);
-
-			// if this log says this Cache is found by me
-			if ((icon.equals(icon_smile) || icon.equals(icon_camera) || icon.equals(icon_attended)) &amp;&amp; (name.equalsIgnoreCase(SafeXML.clean(pref.myAlias)) || (pref.myAlias2.length() &gt; 0 &amp;&amp; name.equalsIgnoreCase(SafeXML.clean(pref.myAlias2))))) {
-				chD.getParent().setFound(true);
-				chD.getParent().setCacheStatus(d);
-				chD.OwnLogId = logId;
-				chD.OwnLog = new Log(icon, d, name, logText);
-				foundown = true;
-				// pref.log(&quot;own log detected!&quot;);
-			}
-			if (nLogs &lt;= pref.maxLogsToSpider) {
-				reslts.add(new Log(icon, d, name, logText));
-			} else {
-				if (foundown) {
-					break;
+				// if this log says this Cache is found by me
+				if ((icon.equals(icon_smile) || icon.equals(icon_camera) || icon.equals(icon_attended)) &amp;&amp; (name.equalsIgnoreCase(SafeXML.clean(pref.myAlias)) || (pref.myAlias2.length() &gt; 0 &amp;&amp; name.equalsIgnoreCase(SafeXML.clean(pref.myAlias2))))) {
+					chD.getParent().setFound(true);
+					chD.getParent().setCacheStatus(d);
+					// final String logId = entry.getString(&quot;LogID&quot;);
+					chD.OwnLogId = logId;
+					chD.OwnLog = new Log(icon, d, name, logText);
+					foundown = true;
 				}
+				if (nLogs &lt;= pref.maxLogsToSpider) {
+					reslts.add(new Log(icon, d, name, logText));
+				} else {
+					if (foundown) {
+						fertig=true;
+						break;
+					}
+				}
 			}
-		}
+		} while (!fertig);
+
 		if (nLogs &gt; pref.maxLogsToSpider) {
+			// there are more logs
 			reslts.add(Log.maxLog());
-			// pref.log(&quot;MAXLOGS reached (&quot;+pref.maxLogsToSpider+&quot;)&quot;);
 		}
-		// pref.log(nLogs+&quot; checked!&quot;);
-		// return reslts;
+
 	}
 
 	/**


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="003085.html">[Cachewolf-svn] r3094 - trunk/src/CacheWolf/imp
</A></li>
	<LI>Next message: <A HREF="003086.html">[Cachewolf-svn] r3095 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#3087">[ date ]</a>
              <a href="thread.html#3087">[ thread ]</a>
              <a href="subject.html#3087">[ subject ]</a>
              <a href="author.html#3087">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
