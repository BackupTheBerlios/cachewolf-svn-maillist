<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r2093 - trunk/src/CacheWolf
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2009-August/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2093%20-%20trunk/src/CacheWolf&In-Reply-To=%3C200908192009.n7JK9Oi0018069%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002014.html">
   <LINK REL="Next"  HREF="002016.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r2093 - trunk/src/CacheWolf</H1>
    <B>greiol at BerliOS</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2093%20-%20trunk/src/CacheWolf&In-Reply-To=%3C200908192009.n7JK9Oi0018069%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r2093 - trunk/src/CacheWolf">greiol at mail.berlios.de
       </A><BR>
    <I>Wed Aug 19 22:09:24 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002014.html">[Cachewolf-svn] r2092 - trunk/src/CacheWolf/navi
</A></li>
        <LI>Next message: <A HREF="002016.html">[Cachewolf-svn] r2094 - in trunk: . src src/CacheWolf	src/CacheWolf/exp src/CacheWolf/imp src/CacheWolf/navi	src/CacheWolf/utils
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2015">[ date ]</a>
              <a href="thread.html#2015">[ thread ]</a>
              <a href="subject.html#2015">[ subject ]</a>
              <a href="author.html#2015">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: greiol
Date: 2009-08-19 22:09:23 +0200 (Wed, 19 Aug 2009)
New Revision: 2093

Modified:
   trunk/src/CacheWolf/DetailsPanel.java
   trunk/src/CacheWolf/GuiImageBroker.java
   trunk/src/CacheWolf/MainTab.java
Log:
- reduced visibility of properties and parameters
- added curly braces to if statements
- replaced string appending with string buffers
- added calls to super() in internal classes
- removed setNeedsTabelUpdate()

Modified: trunk/src/CacheWolf/DetailsPanel.java
===================================================================
--- trunk/src/CacheWolf/DetailsPanel.java	2009-08-19 00:35:54 UTC (rev 2092)
+++ trunk/src/CacheWolf/DetailsPanel.java	2009-08-19 20:09:23 UTC (rev 2093)
@@ -38,53 +38,51 @@
 public class DetailsPanel extends CellPanel {
 
     // ===== GUI elements =====
-	/** way point id */
+	/** way point id. */
 	private static mInput inpWaypoint;
-	/** way point name */
+	/** way point name. */
 	private static mInput inpName;
-	/** way point hidden date */
+	/** way point hidden date. */
 	private static mInput inpHidden;
-	/** way point owner */
+	/** way point owner. */
 	private static mInput inpOwner;
-	/** way point coordinates, open change coordinates dialog */
+	/** way point coordinates, open change coordinates dialog. */
 	private static mButton btnCoordinates;
-	/** set center to current way point */
+	/** set center to current way point. */
 	private static mButton btnCenter;
-	/** add time stamp to notes */
+	/** add time stamp to notes. */
 	private static mButton btnAddDateTime;
-	/** create a new way point */
+	/** create a new way point. */
 	private static mButton btnNewWpt;
-	/** show details for travel bus in way point */
+	/** show details for travel bus in way point. */
 	private static mButton btnShowBug;
-	/** switch to moving map and center on way point coordinates */
+	/** switch to moving map and center on way point coordinates. */
 	private static mButton btnShowMap;
-	/** set way point as destination and switch to goto ppanel */
+	/** set way point as destination and switch to goto panel. */
 	private static mButton btnGoto;
-	/** add a user picture to way point */
+	/** add a user picture to way point. */
 	private static mButton btnAddPicture;
-	/** toggle blacklist status */
+	/** toggle blacklist status. */
 	private static mButton btnBlack;
-	/** add or edit notes for way point */
+	/** add or edit notes for way point. */
 	private static mButton btnNotes;
-	/** set found date */
+	/** set found date. */
 	private static mButton btnFoundDate;
-	/** set hidden date */
+	/** set hidden date. */
 	private static mButton btnHiddenDate;
-	/** set terrain value */
+	/** set terrain value. */
 	private static mButton btnTerr;
-	/** set difficulty value */
+	/** set difficulty value. */
 	private static mButton btnDiff;
-	/** drop down list with cache types */
+	/** drop down list with cache types. */
 	private static mChoice chcType;
-	/** drop down list with container sizes */
+	/** drop down list with container sizes. */
 	private static mChoice chcSize;
-	/** select way point status */
+	/** select way point status. */
 	private static mComboBox chcStatus;
-	/** toolbar panel */
-	private static CellPanel pnlTools;
-	/** notes for way point */
+	/** notes for way point. */
 	private static mTextPad waypointNotes;
-	/** shows number of additional way points */
+	/** shows number of additional way points. */
 	private static mLabel lblAddiCount;
 	/** FIXME move to image broker? */
 	private static mImage imgBlack, imgBlackNo, imgShowBug, imgShowBugNo, imgNewWpt, imgGoto, imgNotes;
@@ -94,22 +92,22 @@
 	// ===== data handles =====
 	/** FIXME: never used? */
 	private static CacheDB cacheDB;
-	/** waypoint to be displayed */
-	private static CacheHolder ch;
+	/** waypoint to be displayed. */
+	public CacheHolder cache;
 	/** FIXME: never used? */
 	private static int dbIndex = -1;
 	/** panel to display waypoint attributes */
 	private static AttributesViewer attViewer;
-	/** preferences object */
+	/** preferences object. */
 	private static Preferences pref;
-	/** waypoint profile */
+	/** waypoint profile. */
 	private static Profile profile;
 
 	// ===== flags =====
 	/** notes have changes */
-	private boolean dirty_notes;
+	private boolean dirtyNotes;
 	/** details have changed FIXME: make this obsolete */
-	private boolean dirty_details;
+	private boolean dirtyDetails;
 	/** cache is blacklisted FIXME: make this obsolete */
 	private boolean blackStatus;
 	/** blacklist status was changed by user FIXME: make this obsolete */
@@ -117,20 +115,20 @@
 	/** FIXME */
 	private boolean needsTableUpdate;
 	/** screen is VGA or better */
-	private boolean isBigScreen;
+	private final boolean isBigScreen;
 	/** use big icons */
-	private boolean useBigIcons;
+	private final boolean useBigIcons;
+	/** String to display for invalid or not applicable terrain or difficulty values.*/
+	private final static String DTINVALID = &quot;: -.-&quot;;
 
     // TODO: move images to image broker
     //mImage imgBlack, imgBlackNo, imgShowBug, imgShowBugNo, imgNewWpt, imgGoto, imgShowMaps, imgAddImages, imgNotes;
 
-	//FIXME: remove
-	CacheHolder thisCache;
-	
 	/**
 	 * public constructor for detail panels. should only be called from main tab.
 	 */
 	public DetailsPanel() {
+		super();
         // ===== local objects =====
 		/** helper panels to organize layout */
 		CellPanel helperPanel1, helperPanel2, helperPanel3, helperPanel4, helperPanel5;
@@ -141,8 +139,8 @@
 		cacheDB = profile.cacheDB;
 
 		// ===== initialize flags =====
-		dirty_notes = false;
-		dirty_details = false;
+		dirtyNotes = false;
+		dirtyDetails = false;
 		blackStatus = false;
 		blackStatusChanged = false;
 		needsTableUpdate = false;
@@ -150,41 +148,6 @@
 		useBigIcons = pref.useBigIcons;
 
 		// ===== initialize GUI objects =====
-
-		// ----- tools panel ------
-		pnlTools = new CellPanel();
-		btnNewWpt = new mButton(imgNewWpt = new mImage(useBigIcons ? &quot;newwpt_vga.png&quot; : &quot;newwpt.png&quot;));
-		// FIXME: get an image with proper transparency
-		imgNewWpt.transparentColor = new Color(255, 0, 0);
-		btnNewWpt.setToolTip(MyLocale.getMsg(311, &quot;Create Waypoint&quot;));
-
-		btnGoto = new mButton(imgGoto = new mImage(useBigIcons ? &quot;goto_vga.png&quot;	: &quot;goto.png&quot;));
-		// FIXME: get an image with proper transparency
-		imgGoto.transparentColor = Color.White;
-		btnGoto.setToolTip(MyLocale.getMsg(345, &quot;Goto these coordinates&quot;));
-
-		btnShowBug = new mButton(new mImage(useBigIcons ? &quot;bug_no_vga.gif&quot; : &quot;bug_no.gif&quot;));
-		btnShowBug.setToolTip(MyLocale.getMsg(346, &quot;Show travelbugs&quot;));
-
-		btnShowMap = new mButton(new mImage(useBigIcons ? &quot;globe_small_vga.gif&quot; : &quot;globe_small.gif&quot;));
-		btnShowMap.setToolTip(MyLocale.getMsg(347, &quot;Show map&quot;));
-
-		btnAddPicture = new mButton(imgAddImages = new mImage(useBigIcons ? &quot;images_vga.gif&quot; : &quot;images.gif&quot;));
-		btnAddPicture.setToolTip(MyLocale.getMsg(348, &quot;Add user pictures&quot;));
-
-		btnBlack = new mButton(imgBlack = new mImage(useBigIcons ? &quot;no_black_vga.png&quot; : &quot;no_black.png&quot;));
-		// FIXME: get an image with proper transparency
-		imgBlack.transparentColor = Color.Black;
-		btnBlack.setToolTip(MyLocale.getMsg(349, &quot;Toggle Blacklist status&quot;));
-
-		btnNotes = new mButton(imgNotes = new mImage(useBigIcons ? &quot;notes_vga.gif&quot; : &quot;notes.gif&quot;));
-		// FIXME: get an image with proper transparency
-		imgNotes.transparentColor = Color.DarkBlue;
-		btnNotes.setToolTip(MyLocale.getMsg(351, &quot;Add/Edit notes&quot;));
-
-		btnAddDateTime = new mButton(new mImage(useBigIcons ? &quot;date_time_vga.gif&quot; : &quot;date_time.gif&quot;));
-		btnAddDateTime.setToolTip(MyLocale.getMsg(350, &quot;Add timestamp to notes&quot;));
-		
         // ----- main body -----
 
 		helperPanel1 = new CellPanel();
@@ -215,18 +178,7 @@
 		inpHidden.modifyAll(DisplayOnly, 0);
 
 		// ===== put the controls onto the GUI =====
-		// ----- tools panel ------
-		pnlTools.addNext(btnNewWpt);
-		pnlTools.addNext(btnGoto);
-		pnlTools.addNext(btnShowBug);
-		pnlTools.addNext(btnShowMap);
-		pnlTools.addNext(btnAddPicture);
-		pnlTools.addNext(btnBlack);
-		pnlTools.addNext(btnNotes);
-		pnlTools.addLast(btnAddDateTime);
 
-		pnlTools.stretchFirstRow = true;
-
         // ----- helper panels -----
 
 		btnDiff = new mButton(MyLocale.getMsg(1000, &quot;D&quot;) + &quot;: 5.5&quot;);
@@ -261,7 +213,7 @@
 		helperPanel5.addLast(btnHiddenDate, DONTSTRETCH, DONTFILL);
 
 		// ----- main body -----
-		addLast(pnlTools, CellConstants.DONTSTRETCH, CellConstants.WEST).setTag(SPAN, new Dimension(3, 1));
+		addLast(createToolsPanel(), CellConstants.DONTSTRETCH, CellConstants.WEST).setTag(SPAN, new Dimension(3, 1));
 
 		addNext(new mLabel(MyLocale.getMsg(300, &quot;Type:&quot;)), CellConstants.DONTSTRETCH, (CellConstants.DONTFILL | CellConstants.NORTHWEST));
 		addLast(helperPanel1, DONTSTRETCH, HFILL).setTag(CellConstants.SPAN, new Dimension(2, 1));
@@ -305,31 +257,77 @@
 		imgShowBug = new mImage(useBigIcons ? &quot;bug_vga.gif&quot;:&quot;bug.gif&quot;);
 		imgShowBugNo = new mImage(useBigIcons ? &quot;bug_no_vga.gif&quot;:&quot;bug_no.gif&quot;);
 	}
+	
+	private CellPanel createToolsPanel() {
+		final CellPanel pnlTools = new CellPanel();
+		
+		btnNewWpt = new mButton(imgNewWpt = new mImage(useBigIcons ? &quot;newwpt_vga.png&quot; : &quot;newwpt.png&quot;));
+		// FIXME: get an image with proper transparency
+		imgNewWpt.transparentColor = new Color(255, 0, 0);
+		btnNewWpt.setToolTip(MyLocale.getMsg(311, &quot;Create Waypoint&quot;));
 
+		btnGoto = new mButton(imgGoto = new mImage(useBigIcons ? &quot;goto_vga.png&quot;	: &quot;goto.png&quot;));
+		// FIXME: get an image with proper transparency
+		imgGoto.transparentColor = Color.White;
+		btnGoto.setToolTip(MyLocale.getMsg(345, &quot;Goto these coordinates&quot;));
+
+		btnShowBug = new mButton(new mImage(useBigIcons ? &quot;bug_no_vga.gif&quot; : &quot;bug_no.gif&quot;));
+		btnShowBug.setToolTip(MyLocale.getMsg(346, &quot;Show travelbugs&quot;));
+
+		btnShowMap = new mButton(new mImage(useBigIcons ? &quot;globe_small_vga.gif&quot; : &quot;globe_small.gif&quot;));
+		btnShowMap.setToolTip(MyLocale.getMsg(347, &quot;Show map&quot;));
+
+		btnAddPicture = new mButton(imgAddImages = new mImage(useBigIcons ? &quot;images_vga.gif&quot; : &quot;images.gif&quot;));
+		btnAddPicture.setToolTip(MyLocale.getMsg(348, &quot;Add user pictures&quot;));
+
+		btnBlack = new mButton(imgBlack = new mImage(useBigIcons ? &quot;no_black_vga.png&quot; : &quot;no_black.png&quot;));
+		// FIXME: get an image with proper transparency
+		imgBlack.transparentColor = Color.Black;
+		btnBlack.setToolTip(MyLocale.getMsg(349, &quot;Toggle Blacklist status&quot;));
+
+		btnNotes = new mButton(imgNotes = new mImage(useBigIcons ? &quot;notes_vga.gif&quot; : &quot;notes.gif&quot;));
+		// FIXME: get an image with proper transparency
+		imgNotes.transparentColor = Color.DarkBlue;
+		btnNotes.setToolTip(MyLocale.getMsg(351, &quot;Add/Edit notes&quot;));
+
+		btnAddDateTime = new mButton(new mImage(useBigIcons ? &quot;date_time_vga.gif&quot; : &quot;date_time.gif&quot;));
+		btnAddDateTime.setToolTip(MyLocale.getMsg(350, &quot;Add timestamp to notes&quot;));
+		
+		pnlTools.addNext(btnNewWpt);
+		pnlTools.addNext(btnGoto);
+		pnlTools.addNext(btnShowBug);
+		pnlTools.addNext(btnShowMap);
+		pnlTools.addNext(btnAddPicture);
+		pnlTools.addNext(btnBlack);
+		pnlTools.addNext(btnNotes);
+		pnlTools.addLast(btnAddDateTime);
+
+		pnlTools.stretchFirstRow = true;
+		
+		return pnlTools;
+	}
+
 	public void clear() {
 		attViewer.clear();
 	}
 
-	public void setNeedsTableUpdate(boolean tableUpdate) {
-		needsTableUpdate = tableUpdate;
-	}
-
-	public boolean needsTableUpdate() {
+	public boolean getNeedsTableUpdate() {
 		return needsTableUpdate;
 	}
 
 	public boolean isDirty() {
-		return dirty_notes || dirty_details || needsTableUpdate;
+		return dirtyNotes || dirtyDetails || needsTableUpdate;
 	}
 
 	public boolean hasBlackStatusChanged() {
 		return blackStatusChanged;
 	}
 
-	public void setDetails(CacheHolder ch) {
-		thisCache = ch;
-		dirty_notes = false;
-		dirty_details = false;
+	public void setDetails(final CacheHolder ch, boolean isNew) {
+		needsTableUpdate = isNew;
+		cache = ch;
+		dirtyNotes = false;
+		dirtyDetails = false;
 		inpWaypoint.setText(ch.getWayPoint());
 		inpName.setText(ch.getCacheName());
 		btnCoordinates.setText(ch.pos.toString());
@@ -341,8 +339,9 @@
 			chcStatus.setText(ch.getCacheStatus());
 			// If the cache status contains a date, do not overwrite it with
 			// 'found' message
-			if (ch.is_found() == true)
+			if (ch.is_found()) {
 				chcStatus.setText(MyLocale.getMsg(318, &quot;Found&quot;));
+			}
 		}
 		chcType.setInt(CacheType.cw2GuiSelect(ch.getType()));
 		if (ch.is_black()) {
@@ -353,9 +352,10 @@
 		blackStatus = ch.is_black();
 		blackStatusChanged = false;
 		btnBlack.repaintNow();
-		if (inpWaypoint.getText().length() == 0)
+		if (inpWaypoint.getText().length() == 0) {
 			createWptName();
-		if (ch.has_bugs() == true) {
+		}
+		if (ch.has_bugs()) {
 			// btnShowBug.modify(Control.Disabled,1);
 			btnShowBug.image = imgShowBug;
 		} else {
@@ -367,8 +367,8 @@
 
 		attViewer.showImages(ch.getCacheDetails(true).attributes);
 		if (ch.isAddiWpt() || ch.isCustomWpt()) {
-			btnTerr.setText(MyLocale.getMsg(1001, &quot;T&quot;)+&quot;: -.-&quot;);
-			btnDiff.setText(MyLocale.getMsg(1000, &quot;D&quot;)+&quot;: -.-&quot;);
+			btnTerr.setText(MyLocale.getMsg(1001, &quot;T&quot;) + DTINVALID);
+			btnDiff.setText(MyLocale.getMsg(1000, &quot;D&quot;) + DTINVALID);
 			deactivateControl(btnTerr);
 			deactivateControl(btnDiff);
 			deactivateControl(chcSize);
@@ -390,16 +390,18 @@
 			} else {
 				btnTerr.setText(&quot;T: -.-&quot;);
 				ch.setIncomplete(true);
-				if (Global.getPref().debug)
+				if (Global.getPref().debug) {
 					Global.getPref().log(ch.getWayPoint() + &quot; has wrong terrain &quot; + ch.getTerrain());
+				}
 			}
 			if (CacheTerrDiff.isValidTD(ch.getHard())) {
 				btnDiff.setText(MyLocale.getMsg(1000, &quot;D&quot;) + &quot;: &quot; + CacheTerrDiff.longDT(ch.getHard()));
 			} else {
 				btnDiff.setText(&quot;D: -.-&quot;);
 				ch.setIncomplete(true);
-				if (Global.getPref().debug)
+				if (Global.getPref().debug) {
 					Global.getPref().log(ch.getWayPoint() + &quot; has wrong difficulty &quot; + ch.getHard());
+				}
 			}
 		}
 		int addiCount = 0;
@@ -408,10 +410,11 @@
 		} else {
 			addiCount = ch.mainCache.addiWpts.size();
 		}
-		lblAddiCount.setText(MyLocale.getMsg(1044, &quot;Addis&quot;) + &quot;: &quot; + String.valueOf(addiCount));
+		lblAddiCount.setText(MyLocale.getMsg(1044, &quot;Addis&quot;) + &quot;: &quot; + addiCount);
 
-		if (isBigScreen)
+		if (isBigScreen) {
 			waypointNotes.setText(ch.getExistingDetails().getCacheNotes());
+		}
 	}
 
 	/**
@@ -419,7 +422,7 @@
 	 * respective MainWpt
 	 */
 	public void createWptName() {
-		String wpt = inpWaypoint.getText().toUpperCase();
+		final String wpt = inpWaypoint.getText().toUpperCase();
 		if (CacheType.isAddiWpt(CacheType.guiSelect2Cw(chcType.getInt())) 
 				&amp;&amp; Global.mainTab.mainCache != null 
 				&amp;&amp; (Global.mainTab.mainCache.startsWith(&quot;GC&quot;) 
@@ -442,7 +445,7 @@
 	/**
 	 * Method to react to a user input.
 	 */
-	public void onEvent(Event ev) {
+	public void onEvent(final Event ev) {
 		if (ev instanceof DataChangeEvent) {
 			if (ev.target == inpWaypoint) {
 				// If user used lower case -&gt; convert directly to upper case
@@ -467,25 +470,26 @@
 					deactivateControl(btnShowBug);
 					deactivateControl(btnBlack);
 					chcSize.select(0);
-					btnTerr.setText(MyLocale.getMsg(1001, &quot;T&quot;)+&quot;: -.-&quot;);
-					btnDiff.setText(MyLocale.getMsg(1000, &quot;D&quot;)+&quot;: -.-&quot;);
+					btnTerr.setText(MyLocale.getMsg(1001, &quot;T&quot;) + DTINVALID);
+					btnDiff.setText(MyLocale.getMsg(1000, &quot;D&quot;) + DTINVALID);
 				}
 			}
 			//FIXME: check if something was actually changed, since datacachnge events also occur if you just hop through the fileds with the tab key (Why? don't know!)
-			dirty_details = true;
+			dirtyDetails = true;
 			needsTableUpdate = true;
 		}
 		if (ev instanceof ControlEvent &amp;&amp; ev.type == ControlEvent.PRESSED) {
 			if (ev.target == btnNotes) {
-				dirty_notes = true; // TODO I think this is redundant, because
+				dirtyNotes = true; // TODO I think this is redundant, because
 									// the notes are saved separately by the notes screen itself
-				NotesScreen nsc = new NotesScreen(thisCache
+				final NotesScreen nsc = new NotesScreen(cache
 						.getCacheDetails(true));
 				nsc.execute(this.getFrame(), Gui.CENTER_FRAME);
-				if (isBigScreen)
-					waypointNotes.setText(thisCache.getCacheDetails(true).getCacheNotes());
+				if (isBigScreen) {
+					waypointNotes.setText(cache.getCacheDetails(true).getCacheNotes());
+				}
 			} else if (ev.target == btnShowMap) {
-				Global.mainTab.SwitchToMovingMap(thisCache.pos, true);
+				Global.mainTab.SwitchToMovingMap(cache.pos, true);
 				/*
 				 * try { MapDetailForm mdf = new
 				 * MapDetailForm(thisCache.wayPoint, pref, profile);
@@ -499,53 +503,58 @@
 				// &quot;Travelbugs&quot;,
 				// false, pref);
 				// is.execute();
-				TravelbugInCacheScreen ts = new TravelbugInCacheScreen(thisCache.getCacheDetails(true).Travelbugs.toHtml(),	&quot;Travelbugs&quot;);
+				final TravelbugInCacheScreen ts = new TravelbugInCacheScreen(cache.getCacheDetails(true).Travelbugs.toHtml(),	&quot;Travelbugs&quot;);
 				ts.execute(this.getFrame(), Gui.CENTER_FRAME);
 			} else if (ev.target == btnCenter) {
-				CWPoint cp = new CWPoint(thisCache.LatLon);
-				if (!cp.isValid()) {
-					MessageBox tmpMB = new MessageBox(
+				final CWPoint cp = new CWPoint(cache.LatLon);
+				if (cp.isValid()) {
+					pref.curCentrePt.set(cp);
+					Global.mainTab.updateBearDist();
+				} else {
+					final MessageBox tmpMB = new MessageBox(
 							MyLocale.getMsg(312, &quot;Error&quot;),
 							MyLocale.getMsg(4111, &quot;Coordinates must be entered in the format N DD MM.MMM E DDD MM.MMM&quot;),
 							FormBase.OKB);
 					tmpMB.exec();
-				} else {
-					pref.curCentrePt.set(cp);
-					Global.mainTab.updateBearDist();
 				}
+
 			} else if (ev.target == btnAddDateTime) {
-				dirty_notes = true;
-				String note = thisCache.getCacheDetails(true).getCacheNotes();
-				Time dtm = new Time();
+				dirtyNotes = true;
+				
+				final StringBuffer newNote = new StringBuffer();
+				newNote.append(cache.getCacheDetails(true).getCacheNotes());
+				
+				final Time dtm = new Time();
 				dtm.getTime();
 				dtm.setFormat(&quot;E dd.MM.yyyy '/' HH:mm&quot;);
-				if (note.length() &gt; 0)
-					note = note + &quot;\n&quot; + dtm.toString();
-				else
-					note = note + dtm.toString();
-				note = note + &quot;\n&quot;;
-				thisCache.getCacheDetails(true).setCacheNotes(note);
+				
+				if (newNote.length() &gt; 0) {
+					newNote.append('\n');
+				}
+				newNote.append(dtm.toString()).append('\n');
+				
+				cache.getCacheDetails(true).setCacheNotes(newNote.toString());
 				//FIXME: better use saveDirtyWaypoint()?
-				thisCache.save();
+				cache.save();
 			} else if (ev.target == btnAddPicture) {
-				thisCache.getCacheDetails(true).addUserImage(profile);
+				cache.getCacheDetails(true).addUserImage(profile);
 			} else if (ev.target == btnBlack) {
-				if (thisCache.is_black()) {
-					thisCache.setBlack(false);
+				if (cache.is_black()) {
+					cache.setBlack(false);
 					btnBlack.image = imgBlackNo;
 				} else {
-					thisCache.setBlack(true);
+					cache.setBlack(true);
 					btnBlack.image = imgBlack;
 				}
-				blackStatus = thisCache.is_black();
-				thisCache.setAttributesToAddiWpts();
+				blackStatus = cache.is_black();
+				cache.setAttributesToAddiWpts();
 				btnBlack.repaintNow();
-				dirty_details = true;
+				dirtyDetails = true;
 				blackStatusChanged = true;
 			} else if (ev.target == btnNewWpt) {
-				CacheHolder ch = new CacheHolder();
-				ch.LatLon = thisCache.LatLon;
-				ch.pos = new CWPoint(thisCache.pos);
+				final CacheHolder ch = new CacheHolder();
+				ch.LatLon = cache.LatLon;
+				ch.pos = new CWPoint(cache.pos);
 				ch.setType(CacheType.CW_TYPE_STAGE);
 				ch.setHard(CacheTerrDiff.CW_DT_UNSET);
 				ch.setTerrain(CacheTerrDiff.CW_DT_UNSET);
@@ -553,42 +562,44 @@
 				Global.mainTab.newWaypoint(ch);
 			} else if (ev.target == btnGoto) {
 				// FIXME: if something changed saveDirtyWaypoint();
-				Global.mainTab.gotoP.setDestinationAndSwitch(thisCache);
+				Global.mainTab.gotoP.setDestinationAndSwitch(cache);
 			} else if (ev.target == btnCoordinates) {
 				CWPoint coords = new CWPoint(btnCoordinates.getText(), CWPoint.CW);
-				CoordsScreen cs = new CoordsScreen(true);
+				final CoordsScreen cs = new CoordsScreen(true);
 				cs.setFields(coords, CWPoint.CW);
 				if (cs.execute() == FormBase.IDOK) {
-					dirty_details = true;
+					dirtyDetails = true;
 					coords = cs.getCoords();
-					Global.getProfile().notifyUnsavedChanges(!thisCache.pos.toString().equals(coords.toString()));
-					thisCache.pos.set(coords);
+					Global.getProfile().notifyUnsavedChanges(!cache.pos.toString().equals(coords.toString()));
+					cache.pos.set(coords);
 					btnCoordinates.setText(coords.toString());
-					thisCache.LatLon = coords.toString();
+					cache.LatLon = coords.toString();
 					// If the current centre is valid, calculate the distance and bearing to it
-					CWPoint centre = Global.getPref().curCentrePt;
-					if (centre.isValid())
-						thisCache.calcDistance(centre);
+					final CWPoint centre = Global.getPref().curCentrePt;
+					if (centre.isValid()) {
+						cache.calcDistance(centre);
+					}
 				}
 			} else if (ev.target == btnFoundDate) {
 				// DateChooser.dayFirst=true;
-				DateTimeChooser dc = new DateTimeChooser(Vm.getLocale());
+				final DateTimeChooser dc = new DateTimeChooser(Vm.getLocale());
 				dc.title = MyLocale.getMsg(328, &quot;Date found&quot;);
 				dc.setPreferredSize(240, 240);
 				String foundDate = chcStatus.getText();
-				if (foundDate.startsWith(MyLocale.getMsg(318, &quot;Found&quot;) + &quot; &quot;))
+				if (foundDate.startsWith(MyLocale.getMsg(318, &quot;Found&quot;) + &quot; &quot;)) {
 					foundDate = foundDate.substring(MyLocale.getMsg(318, &quot;Found&quot;).length() + 1);
-				Time t = new Time();
+				}
+				final Time t = new Time();
 				try {
 					t.parse(foundDate, &quot;y-M-d H:m&quot;);
 				} catch (IllegalArgumentException e) {
 					try {
 						t.parse(foundDate, &quot;y-M-d&quot;);
 					} catch (IllegalArgumentException e1) {
-						// No parsable date given - should not appear
+						Global.getPref().log(&quot;No parsable date given - should not appear&quot;, e1, true);
 					}
 				}
-				;
+
 				dc.reset(t);
 				if (dc.execute() == ewe.ui.FormBase.IDOK) {
 					chcStatus.setText(MyLocale.getMsg(318, &quot;Found&quot;) + &quot; &quot;
@@ -596,12 +607,12 @@
 									+ MyLocale.formatLong(dc.month, &quot;00&quot;) + &quot;-&quot;
 									+ MyLocale.formatLong(dc.day, &quot;00&quot;) + &quot; &quot;
 									+ dc.time);
-					dirty_details = true;
+					dirtyDetails = true;
 					// profile.hasUnsavedChanges=true;
 				}
 			} else if (ev.target == btnHiddenDate) {
 				DateChooser.dayFirst = true;
-				DateChooser dc = new DateChooser(Vm.getLocale());
+				final DateChooser dc = new DateChooser(Vm.getLocale());
 				dc.title = MyLocale.getMsg(329, &quot;Hidden date&quot;);
 				dc.setPreferredSize(240, 240);
 				if (inpHidden.getText().length() == 10)
@@ -618,12 +629,12 @@
 					inpHidden.setText(Convert.toString(dc.year) + &quot;-&quot;
 							+ MyLocale.formatLong(dc.month, &quot;00&quot;) + &quot;-&quot;
 							+ MyLocale.formatLong(dc.day, &quot;00&quot;));
-					dirty_details = true;
+					dirtyDetails = true;
 					// profile.hasUnsavedChanges=true;
 				}
 			} else if (ev.target == btnTerr) {
 				int returnValue;
-				TerrDiffForm tdf = new TerrDiffForm(true, 
+				final TerrDiffForm tdf = new TerrDiffForm(true, 
 						decodeTerrDiff(btnTerr, 
 								MyLocale.getMsg(1001, &quot;T&quot;), 
 								CacheType.isCacheWpt(CacheType.guiSelect2Cw(chcType.getInt()))
@@ -632,11 +643,11 @@
 				returnValue = tdf.execute();
 				if (returnValue == 1) {
 					btnTerr.setText(MyLocale.getMsg(1001, &quot;T&quot;) + &quot;: &quot; + CacheTerrDiff.longDT(tdf.getDT()));
-					dirty_details = true;
+					dirtyDetails = true;
 				}
 			} else if (ev.target == btnDiff) {
 				int returnValue;
-				TerrDiffForm tdf = new TerrDiffForm(false, 
+				final TerrDiffForm tdf = new TerrDiffForm(false, 
 						decodeTerrDiff(btnDiff, 
 								MyLocale.getMsg(1001, &quot;D&quot;), 
 								CacheType.isCacheWpt(CacheType.guiSelect2Cw(chcType.getInt()))
@@ -647,7 +658,7 @@
 				if (returnValue == 1) {
 					btnDiff.setText(MyLocale.getMsg(1000, &quot;D&quot;) + &quot;: &quot;
 							+ CacheTerrDiff.longDT(tdf.getDT()));
-					dirty_details = true;
+					dirtyDetails = true;
 				}
 			}
 			ev.consumed = true;
@@ -655,13 +666,13 @@
 	}
 	
 	/** allow user input on control item */
-	private void activateControl(Control ctrl) {
+	private void activateControl(final Control ctrl) {
 		if (ctrl.change(0, ControlConstants.Disabled))
 			ctrl.repaint();
 	}
 
 	/** block user input on control item */
-	private void deactivateControl(Control ctrl) {
+	private void deactivateControl(final Control ctrl) {
 		if (ctrl.change(ControlConstants.Disabled, 0))
 			ctrl.repaint();
 	}
@@ -682,85 +693,85 @@
 		if (chcStatus.getText().startsWith(MyLocale.getMsg(318, &quot;Found&quot;))
 				&amp;&amp; chcStatus.getText().length() &gt;= MyLocale
 						.getMsg(318, &quot;Found&quot;).length() + 11) {
-			thisCache.setCacheStatus(chcStatus.getText().substring(
+			cache.setCacheStatus(chcStatus.getText().substring(
 					MyLocale.getMsg(318, &quot;Found&quot;).length() + 1));
 		} else {
-			thisCache.setCacheStatus(chcStatus.getText());
+			cache.setCacheStatus(chcStatus.getText());
 		}
-		if (!thisCache.is_found() &amp;&amp; thisCache.getCacheStatus().length() &gt;= 10
-				&amp;&amp; thisCache.getCacheStatus().charAt(4) == '-') {
+		if (!cache.is_found() &amp;&amp; cache.getCacheStatus().length() &gt;= 10
+				&amp;&amp; cache.getCacheStatus().charAt(4) == '-') {
 			// Use same heuristic condition as in setDetails(CacheHolder) to
 			// determine, if this
 			// cache
 			// has to considered as found.
-			thisCache.setFound(true);
+			cache.setFound(true);
 		} else {
-			thisCache.setFound(chcStatus.getText().startsWith(
+			cache.setFound(chcStatus.getText().startsWith(
 					MyLocale.getMsg(318, &quot;Found&quot;)));
 		}
-		thisCache.setCacheOwner(inpOwner.getText().trim());
-		thisCache.setOwned(thisCache.getCacheStatus().equals(
+		cache.setCacheOwner(inpOwner.getText().trim());
+		cache.setOwned(cache.getCacheStatus().equals(
 				MyLocale.getMsg(320, &quot;Owner&quot;)));
 		// Avoid setting is_owned if alias is empty and username is empty
-		if (thisCache.is_owned() == false) {
-			thisCache.setOwned((!pref.myAlias.equals(&quot;&quot;) &amp;&amp; pref.myAlias
-					.equals(thisCache.getCacheOwner()))
+		if (!cache.is_owned()) {
+			cache.setOwned((!pref.myAlias.equals(&quot;&quot;) &amp;&amp; pref.myAlias
+					.equals(cache.getCacheOwner()))
 					|| (!pref.myAlias2.equals(&quot;&quot;) &amp;&amp; pref.myAlias2
-							.equals(thisCache.getCacheOwner())));
+							.equals(cache.getCacheOwner())));
 		}
-		thisCache.setBlack(blackStatus);
-		String oldWaypoint = thisCache.getWayPoint();
-		thisCache.setWayPoint(inpWaypoint.getText().toUpperCase().trim());
-		thisCache.setCacheSize(CacheSize.guiSizeStrings2CwSize(chcSize
+		cache.setBlack(blackStatus);
+		final String oldWaypoint = cache.getWayPoint();
+		cache.setWayPoint(inpWaypoint.getText().toUpperCase().trim());
+		cache.setCacheSize(CacheSize.guiSizeStrings2CwSize(chcSize
 				.getText()));
 		// If the waypoint does not have a name, give it one
-		if (thisCache.getWayPoint().equals(&quot;&quot;)) {
-			thisCache.setWayPoint(profile.getNewWayPointName());
+		if (cache.getWayPoint().equals(&quot;&quot;)) {
+			cache.setWayPoint(profile.getNewWayPointName());
 		}
 		// Don't allow single letter names=&gt; Problems in updateBearingDistance
 		// This is a hack but faster than slowing down the loop in
 		// updateBearingDistance
-		if (thisCache.getWayPoint().length() &lt; 2)
-			thisCache.setWayPoint(thisCache.getWayPoint() + &quot; &quot;);
-		thisCache.setCacheName(inpName.getText().trim());
-		thisCache.LatLon = thisCache.pos.toString();
-		thisCache.setDateHidden(inpHidden.getText().trim());
-		byte oldType = thisCache.getType();
-		thisCache.setType(CacheType.guiSelect2Cw(chcType.getInt()));
+		if (cache.getWayPoint().length() &lt; 2)
+			cache.setWayPoint(cache.getWayPoint() + &quot; &quot;);
+		cache.setCacheName(inpName.getText().trim());
+		cache.LatLon = cache.pos.toString();
+		cache.setDateHidden(inpHidden.getText().trim());
+		final byte oldType = cache.getType();
+		cache.setType(CacheType.guiSelect2Cw(chcType.getInt()));
 		// thisCache.saveCacheDetails(profile.dataDir); // this is redundant,
 		// because all changes
 		// affecting the details are immediately saved
 		// Now update the table
 		
-		thisCache.checkIncomplete();
+		cache.checkIncomplete();
 		
 		/*
 		 * The references have to be rebuilt if: - the cachetype changed from
 		 * addi-&gt;normal or normal-&gt;addi - the old cachetype or the new cachetype
 		 * were 'addi' and the waypointname has changed
 		 */
-		if (CacheType.isAddiWpt(thisCache.getType()) != CacheType.isAddiWpt(oldType)
-				|| ((CacheType.isAddiWpt(thisCache.getType()) || CacheType
-						.isAddiWpt(oldType)) &amp;&amp; !thisCache.getWayPoint()
+		if (CacheType.isAddiWpt(cache.getType()) != CacheType.isAddiWpt(oldType)
+				|| ((CacheType.isAddiWpt(cache.getType()) || CacheType
+						.isAddiWpt(oldType)) &amp;&amp; !cache.getWayPoint()
 						.equals(oldWaypoint))) {
 			// If we changed the type to addi, check that a parent exists
 			//FIXME: if cache was renamed we need to rebuild CacheDB.hashDB first
-			if (CacheType.isAddiWpt(thisCache.getType())) {
-				profile.setAddiRef(thisCache);
+			if (CacheType.isAddiWpt(cache.getType())) {
+				profile.setAddiRef(cache);
 			} else {
 				// rebuild links between caches
 				profile.buildReferences();
 			}
 		} else {
 			// set status also on addi wpts
-			thisCache.setAttributesToAddiWpts();
+			cache.setAttributesToAddiWpts();
 		}
-		thisCache.setHard(decodeTerrDiff(btnDiff,MyLocale.getMsg(1000, &quot;D&quot;),thisCache.isCacheWpt()));
-		thisCache.setTerrain(decodeTerrDiff(btnTerr,MyLocale.getMsg(1001, &quot;T&quot;),thisCache.isCacheWpt()));
-		dirty_notes = false;
-		dirty_details = false;
-		setNeedsTableUpdate(false);
-		thisCache.getFreshDetails().hasUnsavedChanges = true;
+		cache.setHard(decodeTerrDiff(btnDiff,MyLocale.getMsg(1000, &quot;D&quot;),cache.isCacheWpt()));
+		cache.setTerrain(decodeTerrDiff(btnTerr,MyLocale.getMsg(1001, &quot;T&quot;),cache.isCacheWpt()));
+		dirtyNotes = false;
+		dirtyDetails = false;
+		needsTableUpdate = false;
+		cache.getFreshDetails().hasUnsavedChanges = true;
 	}
 	
 	/**
@@ -772,7 +783,7 @@
 	 * @return 0 for additional or custum waypoints, -1 for caches if td is not valid, parsed byte otherwise
 	 */
 	private byte decodeTerrDiff(mButton button, String td, boolean isCache) {
-		StringBuffer tdv = new StringBuffer(2);
+		final StringBuffer tdv = new StringBuffer(2);
 		
 		// terrain and difficulty are always unset for non cache waypoints
 		if (! isCache) return CacheTerrDiff.CW_DT_UNSET;
@@ -785,22 +796,23 @@
 		buttonText=tdv.append(buttonText.charAt(0)).append(buttonText.charAt(2)).toString();
 
 		// unset value is invalid
-		if (buttonText.equals(&quot;--&quot;)) return CacheTerrDiff.CW_DT_ERROR;
+		if (&quot;--&quot;.equals(buttonText)) return CacheTerrDiff.CW_DT_ERROR;
 		
 		return Byte.parseByte(buttonText);
 	}
 
 	private class TravelbugInCacheScreen extends Form {
 
-		private DispPanel disp = new DispPanel();
-		private mButton btCancel;
-		private TravelbugJourneyList tbjList;
+		private final DispPanel disp = new DispPanel();
+		private final mButton btCancel;
+		
 
 		TravelbugInCacheScreen(String text, String title) {
+			super();
 			this.setTitle(title);
 			this.setPreferredSize(pref.myAppWidth, pref.myAppHeight);
 			disp.setHtml(text);
-			ScrollBarPanel sbp = new MyScrollBarPanel(disp,
+			final ScrollBarPanel sbp = new MyScrollBarPanel(disp,
 					ScrollablePanel.NeverShowHorizontalScrollers);
 			this.addLast(sbp);
 			this.addLast(
@@ -818,16 +830,17 @@
 
 		// Subclassed HtmlDisplay with Pop-up menu
 		private class DispPanel extends HtmlDisplay {
-			MenuItem mnuPickupTB, mnuDropTB;
-			MenuItem[] TBMenuItems = new MenuItem[2];
-			Menu mnuPopup;
+			private final MenuItem mnuPickupTB, mnuDropTB;
+			private final MenuItem[] tbMenuItems = new MenuItem[2];
+			private final Menu mnuPopup;
 
 			DispPanel() {
-				TBMenuItems[0] = mnuPickupTB = new MenuItem(MyLocale.getMsg(
+				super();
+				tbMenuItems[0] = mnuPickupTB = new MenuItem(MyLocale.getMsg(
 						6016, &quot;Pick up Travelbug&quot;));
-				TBMenuItems[1] = mnuDropTB = new MenuItem(MyLocale.getMsg(6017,
+				tbMenuItems[1] = mnuDropTB = new MenuItem(MyLocale.getMsg(6017,
 						&quot;Drop Travelbug&quot;));
-				mnuPopup = new Menu(TBMenuItems, &quot;&quot;);
+				mnuPopup = new Menu(tbMenuItems, &quot;&quot;);
 			}
 
 			public void penRightReleased(Point p) {
@@ -843,23 +856,24 @@
 			}
 
 			public void popupMenuEvent(Object selectedItem) {
-				if (selectedItem == mnuPickupTB) {
-					Travelbug tb = TravelbugPickup.pickupTravelbug(thisCache.getCacheDetails(true).Travelbugs);
+				if (selectedItem.equals(mnuPickupTB)) {
+					final Travelbug tb = TravelbugPickup.pickupTravelbug(cache.getCacheDetails(true).Travelbugs);
+					TravelbugJourneyList tbjList;
 					if (tb != null) {
-						dirty_details = true;
+						dirtyDetails = true;
 						// Get the list of my travelbugs
 						tbjList = new TravelbugJourneyList();
 						tbjList.readTravelbugsFile();
 						// Add the tb to this list
 						tbjList.addTbPickup(tb, Global.getProfile().name,
-								thisCache.getWayPoint());
+								cache.getWayPoint());
 						tbjList.saveTravelbugsFile();
-						tbjList = null;
-						setHtml(thisCache.getCacheDetails(true).Travelbugs.toHtml());
+						setHtml(cache.getCacheDetails(true).Travelbugs.toHtml());
 						repaint();
-						thisCache.setHas_bugs(thisCache.getCacheDetails(true).Travelbugs.size() &gt; 0);
+						cache.setHas_bugs(cache.getCacheDetails(true).Travelbugs.size() &gt; 0);
 					}
-				} else if (selectedItem == mnuDropTB) {
+				} else if (selectedItem.equals(mnuDropTB)) {
+					TravelbugJourneyList tbjList;
 					tbjList = new TravelbugJourneyList();
 					tbjList.readTravelbugsFile();
 					TravelbugList tbl = tbjList.getMyTravelbugs();
@@ -868,28 +882,29 @@
 					tbs.execute();
 					if (tbs.selectedItem &gt;= 0) {
 						Travelbug tb = tbl.getTB(tbs.selectedItem);
-						thisCache.getCacheDetails(true).Travelbugs.add(tb);
+						cache.getCacheDetails(true).Travelbugs.add(tb);
 						tbjList.addTbDrop(tb, Global.getProfile().name,
-								thisCache.getWayPoint());
+								cache.getWayPoint());
 					}
 					tbjList.saveTravelbugsFile();
-					tbjList = null;
-					thisCache.setHas_bugs(thisCache.getCacheDetails(true).Travelbugs.size() &gt; 0);
-					setHtml(thisCache.getCacheDetails(true).Travelbugs.toHtml());
+					cache.setHas_bugs(cache.getCacheDetails(true).Travelbugs.size() &gt; 0);
+					setHtml(cache.getCacheDetails(true).Travelbugs.toHtml());
 					repaint();
-					dirty_details = true;
-				} else
+					dirtyDetails = true;
+				} else {
 					super.popupMenuEvent(selectedItem);
+				}
 			}
 		}
 	}
 
 	private class TerrDiffForm extends Form {
-		private mChoice mcDT;
-		private mButton btnOk, btnCancel;
-		private String[] DT = new String[] { &quot;1.0&quot;, &quot;1.5&quot;, &quot;2.0&quot;, &quot;2.5&quot;, &quot;3.0&quot;, &quot;3.5&quot;, &quot;4.0&quot;, &quot;4.5&quot;, &quot;5.0&quot; };
+		private final mChoice mcDT;
+		private final mButton btnOk, btnCancel;
+		private final String[] DT = new String[] { &quot;1.0&quot;, &quot;1.5&quot;, &quot;2.0&quot;, &quot;2.5&quot;, &quot;3.0&quot;, &quot;3.5&quot;, &quot;4.0&quot;, &quot;4.5&quot;, &quot;5.0&quot; };
 
 		public TerrDiffForm(boolean terrain, int startVal) {
+			super();
 			mcDT = new mChoice(DT, (startVal &gt; 0) ? (startVal - 10) / 5 : 0);
 			btnOk = new mButton(MyLocale.getMsg(1605, &quot;OK&quot;));
 			btnCancel = new mButton(MyLocale.getMsg(1604, &quot;Cancel&quot;));

Modified: trunk/src/CacheWolf/GuiImageBroker.java
===================================================================
--- trunk/src/CacheWolf/GuiImageBroker.java	2009-08-19 00:35:54 UTC (rev 2092)
+++ trunk/src/CacheWolf/GuiImageBroker.java	2009-08-19 20:09:23 UTC (rev 2093)
@@ -16,13 +16,16 @@
 
 	/** image to be displayed in case of error */
 	public static Image imageError = new Image(&quot;guiError.png&quot;);
+	
+	/** reference to this object */
+	private static GuiImageBroker ref;
 
 	/**
 	 * images to be displayed for cache types in GUI
 	 * @see getTypeImage
 	 * @see CacheTypes
 	 */
-	private static final Image[] typeImages = {
+	private static final Image[] TYPEIMAGES = {
 		new Image(CacheType.CW_GUIIMG_CUSTOM),		// 0
 		new Image(CacheType.CW_GUIIMG_APE),			// 1
 		new Image(CacheType.CW_GUIIMG_CITO),		// 2
@@ -48,48 +51,58 @@
 	};
 
 	// TODO: move size images here
-	private static final Image[] sizeImages = {
+//	private static final Image[] sizeImages = {
 //		new Image(CacheSize.CW_GUIIMG_NONPHYSICAL),
 //		new Image(CacheSize.CW_GUIIMG_MICRO),
 //		new Image(CacheSize.CW_GUIIMG_SMALL),
 //		new Image(CacheSize.CW_GUIIMG_NORMAL),
 //		new Image(CacheSize.CW_GUIIMG_LARGE),
 //		new Image(CacheSize.CW_GUIIMG_VERYLARGE)
-	};
+//	};
 
-	/** constructor does nothing */
-	private GuiImageBroker() { // no instantiation needed
+	/** thou shallst not instantiate this object */
+	private GuiImageBroker() { }
+	
+	/**
+	 * give a singleton reference to this object to whoever needs one. create one, if not done so already.
+	 * @return reference to CWWrapper
+	 */
+	public static synchronized GuiImageBroker getGuiImageBroker() {
+		if (ref == null) {
+			ref = new GuiImageBroker();
+		}
+		return ref;
 	}
 
 	/**
 	 * select image to be displayed for a given cache type
-	 * @param id internal cache type id
+	 * @param type internal cache type id
 	 * @return &lt;code&gt;Image&lt;/code&gt; object to be displayed
 	 */
-	public static Image getTypeImage(byte id) {
-		switch (id) {
-		case CacheType.CW_TYPE_CUSTOM: return typeImages[0];
-		case CacheType.CW_TYPE_APE: return typeImages[1];
-		case CacheType.CW_TYPE_CITO: return typeImages[2];
-		case CacheType.CW_TYPE_DRIVE_IN: return typeImages[3];
-		case CacheType.CW_TYPE_EARTH: return typeImages[4];
-		case CacheType.CW_TYPE_EVENT: return typeImages[5];
-		case CacheType.CW_TYPE_FINAL: return typeImages[6];
-		case CacheType.CW_TYPE_LETTERBOX: return typeImages[7];
-		case CacheType.CW_TYPE_LOCATIONLESS: return typeImages[8];
-		case CacheType.CW_TYPE_MAZE: return typeImages[9];
-		case CacheType.CW_TYPE_MEGA_EVENT: return typeImages[10];
-		case CacheType.CW_TYPE_MULTI: return typeImages[11];
-		case CacheType.CW_TYPE_PARKING: return typeImages[12];
-		case CacheType.CW_TYPE_QUESTION: return typeImages[13];
-		case CacheType.CW_TYPE_REFERENCE: return typeImages[14];
-		case CacheType.CW_TYPE_STAGE: return typeImages[15];
-		case CacheType.CW_TYPE_TRADITIONAL: return typeImages[16];
-		case CacheType.CW_TYPE_TRAILHEAD: return typeImages[17];
-		case CacheType.CW_TYPE_UNKNOWN: return typeImages[18];
-		case CacheType.CW_TYPE_VIRTUAL: return typeImages[19];
-		case CacheType.CW_TYPE_WEBCAM: return typeImages[20];
-		case CacheType.CW_TYPE_WHEREIGO: return typeImages[21];
+	public static Image getTypeImage(final byte type) {
+		switch (type) {
+		case CacheType.CW_TYPE_CUSTOM: return TYPEIMAGES[0];
+		case CacheType.CW_TYPE_APE: return TYPEIMAGES[1];
+		case CacheType.CW_TYPE_CITO: return TYPEIMAGES[2];
+		case CacheType.CW_TYPE_DRIVE_IN: return TYPEIMAGES[3];
+		case CacheType.CW_TYPE_EARTH: return TYPEIMAGES[4];
+		case CacheType.CW_TYPE_EVENT: return TYPEIMAGES[5];
+		case CacheType.CW_TYPE_FINAL: return TYPEIMAGES[6];
+		case CacheType.CW_TYPE_LETTERBOX: return TYPEIMAGES[7];
+		case CacheType.CW_TYPE_LOCATIONLESS: return TYPEIMAGES[8];
+		case CacheType.CW_TYPE_MAZE: return TYPEIMAGES[9];
+		case CacheType.CW_TYPE_MEGA_EVENT: return TYPEIMAGES[10];
+		case CacheType.CW_TYPE_MULTI: return TYPEIMAGES[11];
+		case CacheType.CW_TYPE_PARKING: return TYPEIMAGES[12];
+		case CacheType.CW_TYPE_QUESTION: return TYPEIMAGES[13];
+		case CacheType.CW_TYPE_REFERENCE: return TYPEIMAGES[14];
+		case CacheType.CW_TYPE_STAGE: return TYPEIMAGES[15];
+		case CacheType.CW_TYPE_TRADITIONAL: return TYPEIMAGES[16];
+		case CacheType.CW_TYPE_TRAILHEAD: return TYPEIMAGES[17];
+		case CacheType.CW_TYPE_UNKNOWN: return TYPEIMAGES[18];
+		case CacheType.CW_TYPE_VIRTUAL: return TYPEIMAGES[19];
+		case CacheType.CW_TYPE_WEBCAM: return TYPEIMAGES[20];
+		case CacheType.CW_TYPE_WHEREIGO: return TYPEIMAGES[21];
 		default: return imageError;
 		}
 	}
@@ -103,24 +116,23 @@
 	 * replaced by the image in x.png.
 	 * Images are NOT checked for size etc.
 	 */
-	public static void customizedSymbols()
-	{
-		FileBugfix dir=new FileBugfix(FileBase.getProgramDirectory()+&quot;/symbols&quot;);
+	public static void customizedSymbols() {
+		final FileBugfix dir = new FileBugfix(FileBase.getProgramDirectory()+&quot;/symbols&quot;);
 		if (dir.isDirectory()){
-			int id;
+			int type;
 			String name = &quot;&quot;;
 			String [] pngFiles;
 			pngFiles=dir.list(&quot;*.png&quot;,0);
-			for (int i=0; i&lt;pngFiles.length; i++) {
+			for (int i=0; i &lt; pngFiles.length; i++) {
 				name = pngFiles[i].substring(0,pngFiles[i].length()-4);
 				try {
-					id = Integer.parseInt (name);
+					type = Integer.parseInt(name);
 				}
 				catch (Exception E){
-					id = -1; //filename invalid for symbols
+					type = -1; //filename invalid for symbols
 				}
-				if (0&lt;=id &amp;&amp; id&lt;=typeImages.length){
-					typeImages[id]= new Image(FileBase.getProgramDirectory()+&quot;/symbols/&quot;+pngFiles[i]);
+				if (0&lt;=type &amp;&amp; type&lt;=TYPEIMAGES.length){
+					TYPEIMAGES[type] = new Image(FileBase.getProgramDirectory()+&quot;/symbols/&quot;+pngFiles[i]);
 				}
 			}
 		}

Modified: trunk/src/CacheWolf/MainTab.java
===================================================================
--- trunk/src/CacheWolf/MainTab.java	2009-08-19 00:35:54 UTC (rev 2092)
+++ trunk/src/CacheWolf/MainTab.java	2009-08-19 20:09:23 UTC (rev 2093)
@@ -156,11 +156,11 @@
 			// Update chD with Details
 			if(detP.isDirty()) {
 				cacheDirty=true;
-				boolean needTableUpdate = detP.needsTableUpdate();
+				boolean needTableUpdate = detP.getNeedsTableUpdate();
 				detP.saveDirtyWaypoint();
 				if (needTableUpdate) {
 					tbP.myMod.updateRows();// This sorts the waypoint (if it is new) into the right position
-					tbP.selectRow(profile.getCacheIndex(detP.thisCache.getWayPoint()));
+					tbP.selectRow(profile.getCacheIndex(detP.cache.getWayPoint()));
 				}
 				//was tbP.refreshTable();
 				tbP.tc.update(true); // Update and repaint
@@ -202,11 +202,13 @@
 			}
 			break;
 		case 1:  // DetailsPanel
+			boolean newCache = false;
 			if (chD==null) { // Empty DB - show a dummy detail
-				newWaypoint(ch=new CacheHolder()); 
+				newWaypoint(ch=new CacheHolder());
+				newCache = true;
 			}
 			MyLocale.setSIPOff();
-			detP.setDetails(ch);
+			detP.setDetails(ch, newCache);
 			break;
 		case 2: // Description Panel
 			MyLocale.setSIPOff();
@@ -321,11 +323,10 @@
 		cacheDB.add(pCh);
 		Global.getProfile().notifyUnsavedChanges(true); // Just to be sure 
 		tbP.myMod.numRows++;
-		detP.setDetails(pCh);
+		detP.setDetails(pCh, true);
 		oldCard=1;
 		if (this.cardPanel.selectedItem != 1) select(detP);
 		solverP.setInstructions(pCh);
-		detP.setNeedsTableUpdate(true);
 		//tbP.refreshTable(); // moved this instruction to onLeavingPanel
 
 	}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002014.html">[Cachewolf-svn] r2092 - trunk/src/CacheWolf/navi
</A></li>
	<LI>Next message: <A HREF="002016.html">[Cachewolf-svn] r2094 - in trunk: . src src/CacheWolf	src/CacheWolf/exp src/CacheWolf/imp src/CacheWolf/navi	src/CacheWolf/utils
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2015">[ date ]</a>
              <a href="thread.html#2015">[ thread ]</a>
              <a href="subject.html#2015">[ subject ]</a>
              <a href="author.html#2015">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
