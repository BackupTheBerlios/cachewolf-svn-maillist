<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r2989 - in trunk/src/CacheWolf/view: ewe pda
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2011-April/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2989%20-%20in%20trunk/src/CacheWolf/view%3A%20ewe%20pda&In-Reply-To=%3C20110423122854.84B044814C9%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002979.html">
   <LINK REL="Next"  HREF="002981.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r2989 - in trunk/src/CacheWolf/view: ewe pda</H1>
    <B>apreisser at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2989%20-%20in%20trunk/src/CacheWolf/view%3A%20ewe%20pda&In-Reply-To=%3C20110423122854.84B044814C9%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r2989 - in trunk/src/CacheWolf/view: ewe pda">apreisser at mail.berlios.de
       </A><BR>
    <I>Sat Apr 23 02:28:54 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="002979.html">[Cachewolf-svn] r2988 - in trunk/src/CacheWolf: . model view
</A></li>
        <LI>Next message: <A HREF="002981.html">[Cachewolf-svn] r2990 - trunk/src/CacheWolf/view
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2980">[ date ]</a>
              <a href="thread.html#2980">[ thread ]</a>
              <a href="subject.html#2980">[ subject ]</a>
              <a href="author.html#2980">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: apreisser
Date: 2011-04-23 14:28:54 +0200 (Sat, 23 Apr 2011)
New Revision: 2989

Added:
   trunk/src/CacheWolf/view/ewe/TravelbugJourneyScreen.java
   trunk/src/CacheWolf/view/ewe/TravelbugMenu.java
   trunk/src/CacheWolf/view/pda/PDADateTimeChooser.java
   trunk/src/CacheWolf/view/pda/PDAEmptyButton.java
   trunk/src/CacheWolf/view/pda/PDAListButton.java
   trunk/src/CacheWolf/view/pda/PDAListButtonObject.java
   trunk/src/CacheWolf/view/pda/PDAMenu.java
   trunk/src/CacheWolf/view/pda/PDAMenuButton.java
   trunk/src/CacheWolf/view/pda/PDAMenuButtonObject.java
   trunk/src/CacheWolf/view/pda/PDAOptionPane.java
   trunk/src/CacheWolf/view/pda/PDATravelbugDetailMenu.java
   trunk/src/CacheWolf/view/pda/PDATravelbugDetailPanel.java
   trunk/src/CacheWolf/view/pda/PDATravelbugJourneyScreen.java
   trunk/src/CacheWolf/view/pda/PDATravelbugMenuPanel.java
   trunk/src/CacheWolf/view/pda/PDATravelbugSortMenu.java
Log:
More PDA-friendly TravelbugScreen implemented.
This version is in an early experimental state and and can only be activated by directly editing Your pref.xml (See Preferences.java line 791 how set MobileGui to true)

Copied: trunk/src/CacheWolf/view/ewe/TravelbugJourneyScreen.java (from rev 2879, trunk/src/CacheWolf/TravelbugJourneyScreen.java)
===================================================================
--- trunk/src/CacheWolf/view/ewe/TravelbugJourneyScreen.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/ewe/TravelbugJourneyScreen.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,782 @@
+/*
+GNU General Public License
+CacheWolf is a software for PocketPC, Win and Linux that
+enables paperless caching.
+It supports the sites geocaching.com and opencaching.de
+
+Copyright (C) 2006  CacheWolf development team
+See <A HREF="http://developer.berlios.de/projects/cachewolf/">http://developer.berlios.de/projects/cachewolf/</A>
+for more information.
+Contact: 	<A HREF="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">bilbowolf at users.berlios.de</A>
+			<A HREF="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">kalli at users.berlios.de</A>
+
+This program is free software; you can redistribute it and/or modify
+it under the terms of the GNU General Public License as published by
+the Free Software Foundation; version 2 of the License.
+
+This program is distributed in the hope that it will be useful,
+but WITHOUT ANY WARRANTY; without even the implied warranty of
+MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+GNU General Public License for more details.
+
+You should have received a copy of the GNU General Public License
+along with this program; if not, write to the Free Software
+Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
+ */
+package CacheWolf.view.ewe;
+
+/**
+ * A list to manage the travelbugs. Each row represents one @see TravelbugJourney.
+ * The lower half of the screen which is separated from the top by a splitter bar,
+ * contains four tabs: One for the travelbug, one for the source (where the travelbug 
+ * was picked up), one for the destination (where the travelbug was dropped) and one
+ * for the mission. These tabs are used for inputting data about the travelbug journey.
+ * The travelbugs are read from file travelbugs.xml which is stored in the base directory.
+ * When the screen is closed, all data is written back to the file.
+ * @author salzkammergut
+ */
+
+import CacheWolf.CacheDB;
+import CacheWolf.CacheHolder;
+import CacheWolf.CacheHolderDetail;
+import CacheWolf.DateTimeChooser;
+import CacheWolf.Global;
+import CacheWolf.MyLocale;
+import CacheWolf.MyScrollBarPanel;
+import CacheWolf.TableColumnChooser;
+import CacheWolf.Travelbug;
+import CacheWolf.TravelbugJourney;
+import CacheWolf.TravelbugList;
+import CacheWolf.TravelbugPickup;
+import CacheWolf.imp.SpiderGC;
+import CacheWolf.model.TravelBugScreenModel;
+import CacheWolf.utils.CWWrapper;
+import ewe.fx.Color;
+import ewe.fx.Dimension;
+import ewe.fx.FontMetrics;
+import ewe.fx.IImage;
+import ewe.fx.IconAndText;
+import ewe.fx.Image;
+import ewe.fx.Point;
+import ewe.fx.Rect;
+import ewe.fx.mImage;
+import ewe.sys.Convert;
+import ewe.sys.Time;
+import ewe.sys.Vm;
+import ewe.ui.CellConstants;
+import ewe.ui.CellPanel;
+import ewe.ui.Control;
+import ewe.ui.ControlConstants;
+import ewe.ui.ControlEvent;
+import ewe.ui.DataChangeEvent;
+import ewe.ui.Event;
+import ewe.ui.Form;
+import ewe.ui.FormEvent;
+import ewe.ui.Gui;
+import ewe.ui.HtmlDisplay;
+import ewe.ui.IKeys;
+import ewe.ui.Menu;
+import ewe.ui.MenuItem;
+import ewe.ui.MultiPanelEvent;
+import ewe.ui.PanelSplitter;
+import ewe.ui.PenEvent;
+import ewe.ui.ScrollablePanel;
+import ewe.ui.SplittablePanel;
+import ewe.ui.TableCellAttributes;
+import ewe.ui.TableControl;
+import ewe.ui.TableModel;
+import ewe.ui.mButton;
+import ewe.ui.mCheckBox;
+import ewe.ui.mInput;
+import ewe.ui.mLabel;
+import ewe.ui.mTabbedPanel;
+
+public class TravelbugJourneyScreen extends Form {
+
+	// ============= VIEW
+	/** The list control */
+	// Set to Public to implement MVC-Pattern [AP]
+	public tbListControl tcTbJourneyList;
+	/** The list model */
+	// Set to Public to implement MVC-Pattern [AP]
+	public tbListTableModel modTbJourneyList;
+	/** The actual journeys */
+
+	/** The panel for the lower half of the screen */
+	private CellPanel lowerpane;
+	private mInput inpName, inpTrackingNo,
+			inpFromDate, inpFromProfile, inpFromWaypoint,
+			inpToDate, inpToProfile, inpToWaypoint;
+	private mLabel lblId;
+	private mButton btnFromDate, btnToDate;
+	private mCheckBox chkFromLogged, chkToLogged;
+	private HtmlDisplay txtMission;
+	private mTabbedPanel pnlTab;
+
+	/** The currently selected row */
+	// Set to Public to implement MVC-Pattern [AP]
+	public int selectedRow = -1;
+
+	/** A label which holds the number of currently displayed travelbug journeys */
+	private mLabel lblNumVisibleJourneys;
+	private final Color RED = new Color(255, 0, 0);
+	private int exitKeys[] = { 75009 };
+
+	// =========== CONTROLLER
+	public TravelbugMenu mnuTBMenu;
+	// ========== MODEL
+	public TravelBugScreenModel model;
+
+	/**
+	 * A flag to track whether the current cache has to be saved because a
+	 * travelbug was added to or taken from it.
+	 */
+	// Set to Public to implement MVC-Pattern [AP]
+	public boolean chDmodified = false;
+
+	// =========== MODEL
+	// Set to Public to implement MVC-Pattern [AP]
+//	public TravelbugJourneyList tblMyTravelbugJourneys;
+	/** List of TBs in the current cache */
+	// Set to Public to implement MVC-Pattern [AP]
+	public TravelbugList tblSrcCache;
+	/** The current cache */
+	// Set to Public to implement MVC-Pattern [AP]
+	public CacheHolderDetail chD;
+	/** The base data of the current cache */
+	// Set to Public to implement MVC-Pattern [AP]
+	public CacheHolder ch;
+	/** The name of the current waypoint */
+	// Set to Public to implement MVC-Pattern [AP]
+	public String waypoint = &quot;&quot;;
+
+	public TravelbugJourneyScreen(TravelBugScreenModel newModel) {
+		model = newModel;
+		CacheDB cacheDB = Global.getProfile().cacheDB;
+		SplittablePanel split = new SplittablePanel(PanelSplitter.VERTICAL);
+		// On modern PDAs the splitter is to small to move it with the stylus.
+		// We will make it a littler thicker
+		MyLocale.setSplitterSize(split);
+		CellPanel tablepane = split.getNextPanel();
+		int curCacheNo = Global.mainTab.tbP.getSelectedCache();
+		String cache = &quot;&quot;;
+		if (curCacheNo &gt;= 0 &amp;&amp; curCacheNo &lt; cacheDB.size()) {
+			ch = cacheDB.get(curCacheNo);
+			cache = MyLocale.getMsg(6022, &quot;: Current cache: &quot;) + ch.getWayPoint() + &quot; - &quot; + ch.getCacheName();
+			waypoint = ch.getWayPoint();
+			chD = ch.getCacheDetails(true);
+			tblSrcCache = ch.getCacheDetails(true).Travelbugs;
+		}
+		title = &quot;Travelbugs&quot; + cache;
+		tcTbJourneyList = new tbListControl(model);
+		tcTbJourneyList.setTableModel(modTbJourneyList = new tbListTableModel());
+		tablepane.addLast(new MyScrollBarPanel(tcTbJourneyList, ScrollablePanel.AlwaysShowVerticalScrollers), STRETCH,
+				FILL);
+
+		lowerpane = split.getNextPanel();
+
+		pnlTab = new mTabbedPanel();
+		pnlTab.extraControlsRight = lblNumVisibleJourneys = new mLabel(&quot;  0&quot;);
+		// ------------------------------------------------
+		// SET Menu
+		// ------------------------------------------------
+		mnuTBMenu = new TravelbugMenu(model);
+		mnuTBMenu.view = this;
+
+		addLast(mnuTBMenu, HSTRETCH, HFILL);
+
+		// ------------------------------------------------
+		// First Tab - Name &amp; Tracking #
+		// ------------------------------------------------
+		CellPanel pnlName = new CellPanel();
+		pnlName.addNext(new mLabel(MyLocale.getMsg(6025, &quot;Name:&quot;)), DONTSTRETCH, DONTFILL);
+		pnlName.addLast(inpName = new mInput(), HSTRETCH, HFILL);
+		pnlName.addNext(new mLabel(MyLocale.getMsg(6026, &quot;Tracking #:&quot;)), DONTSTRETCH, DONTFILL);
+		pnlName.addLast(inpTrackingNo = new mInput(), HSTRETCH, HFILL);
+		pnlName.addNext(new mLabel(MyLocale.getMsg(6027, &quot;ID/GUID:&quot;)), DONTSTRETCH, DONTFILL);
+		pnlName.addLast(lblId = new mLabel(&quot;&quot;), HSTRETCH, HFILL);
+		pnlTab.addCard(pnlName, MyLocale.getMsg(6028, &quot;Name&quot;), &quot;Name&quot;);
+
+		// ------------------------------------------------
+		// Second Tab - Where was the TB picked up from
+		// ------------------------------------------------
+		CellPanel pnlFrom = new CellPanel();
+		pnlFrom.addNext(new mLabel(MyLocale.getMsg(6029, &quot;Profile/Cache:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		pnlFrom.addNext(inpFromProfile = new mInput(), HSTRETCH, HFILL);
+		pnlFrom.addLast(inpFromWaypoint = new mInput(), HSTRETCH, HFILL);
+
+		pnlFrom.addNext(new mLabel(MyLocale.getMsg(6030, &quot;Date found:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		pnlFrom.addNext(inpFromDate = new mInput(), CellConstants.HSTRETCH, (CellConstants.HFILL | CellConstants.WEST));
+		pnlFrom.addLast(btnFromDate = new mButton(new mImage(&quot;calendar.png&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		btnFromDate.modify(0, ControlConstants.TakesKeyFocus);
+
+		pnlFrom.addNext(new mLabel(MyLocale.getMsg(6031, &quot;Logged:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		pnlFrom.addLast(chkFromLogged = new mCheckBox(&quot;&quot;), DONTSTRETCH, DONTFILL | WEST);
+		chkFromLogged.exitKeys = exitKeys;
+		pnlFrom.addLast(new mLabel(&quot;&quot;));
+
+		pnlTab.addCard(pnlFrom, MyLocale.getMsg(6032, &quot;From&quot;), &quot;From&quot;);
+
+		// ------------------------------------------------
+		// Third Tab - Where was the TB dropped
+		// ------------------------------------------------
+		CellPanel pnlTo = new CellPanel();
+		pnlTo.addNext(new mLabel(MyLocale.getMsg(6029, &quot;Profile/Cache:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		pnlTo.addNext(inpToProfile = new mInput(), HSTRETCH, HFILL);
+		pnlTo.addLast(inpToWaypoint = new mInput(), HSTRETCH, HFILL);
+
+		pnlTo.addNext(new mLabel(MyLocale.getMsg(6033, &quot;Date dropped:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		pnlTo.addNext(inpToDate = new mInput(), CellConstants.HSTRETCH, (CellConstants.HFILL | CellConstants.WEST));
+		// inpToDate.modifyAll(DisplayOnly,0);
+		pnlTo.addLast(btnToDate = new mButton(new mImage(&quot;calendar.png&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		btnToDate.modify(0, ControlConstants.TakesKeyFocus);
+		// pnlTo.addLast(new mLabel(&quot;&quot;));
+
+		pnlTo.addNext(new mLabel(MyLocale.getMsg(6031, &quot;Logged:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		pnlTo.addLast(chkToLogged = new mCheckBox(&quot;&quot;), DONTSTRETCH, DONTFILL | WEST);
+		chkToLogged.exitKeys = exitKeys;
+		pnlTo.addLast(new mLabel(&quot;&quot;));
+
+		pnlTab.addCard(pnlTo, MyLocale.getMsg(6034, &quot;To&quot;), &quot;To&quot;);
+
+		// ------------------------------------------------
+		// Last Panel - TB Mission
+		// ------------------------------------------------
+		CellPanel pnlDest = new CellPanel();
+		pnlDest.addLast(new mLabel(MyLocale.getMsg(6035, &quot;Mission:&quot;)));
+		pnlDest.addLast(txtMission = new HtmlDisplay(), STRETCH, FILL);
+		txtMission.rows = 3;
+		pnlTab.addCard(pnlDest, MyLocale.getMsg(6036, &quot;Mission&quot;), &quot;Mission&quot;);
+
+		lowerpane.addLast(pnlTab, STRETCH, FILL);
+
+		split.setSplitter(PanelSplitter.AFTER | PanelSplitter.HIDDEN, PanelSplitter.BEFORE | PanelSplitter.HIDDEN, 0);
+		addLast(split, STRETCH, FILL);
+
+		modTbJourneyList.numRows = model.allTravelbugJourneys.size();
+		// Get the columns to display and their widths from preferences
+		modTbJourneyList.columnMap =
+				TableColumnChooser.str2Array(Global.getPref().travelbugColMap, 0, 11, 0, -1);
+		modTbJourneyList.colWidth =
+				TableColumnChooser.str2Array(Global.getPref().travelbugColWidth, 10, 1024, 50, -1);
+		modTbJourneyList.numCols = modTbJourneyList.columnMap.length;
+
+		modTbJourneyList.select(0, 12, true);
+		/* Restore the saved setting about showing only non-logged bugs */
+		if (Global.getPref().travelbugShowOnlyNonLogged) {
+			tcTbJourneyList.toggleNonLogged();
+		}
+		updateNumBugs();
+
+	}
+
+	/** Indicate the number of journeys currently displayed */
+	private void updateNumBugs() {
+		lblNumVisibleJourneys.setText(&quot;&quot; + modTbJourneyList.numRows);
+		lblNumVisibleJourneys.repaint();
+	}
+
+	/** The control which had the last focus */
+	private Control currentControl;
+
+	public void onEvent(Event ev) {
+		// Update the table from the input form
+		if ((ev instanceof MultiPanelEvent || ev instanceof ControlEvent || ev instanceof DataChangeEvent)
+				&amp;&amp; selectedRow != -1 &amp;&amp;
+				selectedRow &lt; model.allTravelbugJourneys.size()) {
+			TravelbugJourney tbj = model.allTravelbugJourneys.getTBJourney(selectedRow);
+			if (currentControl == inpName)
+				tbj.getTb().setName(inpName.getText());
+			else if (currentControl == inpTrackingNo)
+				tbj.getTb().setTrackingNo(inpTrackingNo.getText());
+			else if (currentControl == inpFromProfile)
+				tbj.setFromProfile(inpFromProfile.getText());
+			else if (currentControl == inpFromWaypoint)
+				tbj.setFromWaypoint(inpFromWaypoint.getText());
+			else if (currentControl == inpFromDate)
+				tbj.setFromDate(inpFromDate.getText());
+			else if (currentControl == chkFromLogged)
+				tbj.setFromLogged(chkFromLogged.state);
+			else if (currentControl == inpToProfile)
+				tbj.setToProfile(inpToProfile.getText());
+			else if (currentControl == inpToWaypoint)
+				tbj.setToWaypoint(inpToWaypoint.getText());
+			else if (currentControl == inpToDate)
+				tbj.setToDate(inpToDate.getText());
+			else if (currentControl == chkToLogged)
+				tbj.setToLogged(chkToLogged.state);
+			// else if (ev.target==txtMission)
+			// tb.setMission(txtMission.getText());
+			tcTbJourneyList.repaint();
+		}
+		if (ev instanceof ControlEvent &amp;&amp; ev.type == ControlEvent.PRESSED &amp;&amp; selectedRow != -1) {
+			if (ev.target == inpTrackingNo) {
+				pnlTab.selectNextTab(true, true);
+				Gui.takeFocus(inpFromProfile, ControlConstants.ByKeyboard);
+				pnlTab.repaint();
+			}
+			if (ev.target == inpFromDate)
+				Gui.takeFocus(chkFromLogged, ControlConstants.ByKeyboard);
+			if (ev.target == inpToDate)
+				Gui.takeFocus(chkToLogged, ControlConstants.ByKeyboard);
+			if (ev.target == btnFromDate || ev.target == btnToDate) {
+				mInput inpDate = ev.target == btnFromDate ? inpFromDate : inpToDate;
+				DateTimeChooser dc = new DateTimeChooser(Vm.getLocale());
+				dc.title = MyLocale.getMsg(328, &quot;Date found&quot;);
+				dc.setPreferredSize(240, 240);
+				String foundDate = inpDate.getText();
+				Time t = new Time();
+				try {
+					t.parse(foundDate, &quot;y-M-d H:m&quot;);
+				} catch (IllegalArgumentException e) {
+					try {
+						t.parse(foundDate, &quot;y-M-d&quot;);
+					} catch (IllegalArgumentException e1) {
+						// Can't parse date - should not happen
+					}
+				}
+				;
+				dc.reset(t);
+				if (dc.execute() == ewe.ui.FormBase.IDOK) {
+					inpDate.setText(Convert.toString(dc.year) + &quot;-&quot; + MyLocale.formatLong(dc.month, &quot;00&quot;) + &quot;-&quot;
+							+ MyLocale.formatLong(dc.day, &quot;00&quot;) + &quot; &quot; + dc.time);
+					if (ev.target == btnFromDate) {
+						model.allTravelbugJourneys.getTBJourney(selectedRow).setFromDate(inpDate.getText());
+						Gui.takeFocus(chkFromLogged, ControlConstants.ByKeyboard);
+					} else {
+						model.allTravelbugJourneys.getTBJourney(selectedRow).setToDate(inpDate.getText());
+						Gui.takeFocus(chkToLogged, ControlConstants.ByKeyboard);
+					}
+					tcTbJourneyList.repaint();
+				}
+			}
+		}
+		if (ev instanceof ControlEvent &amp;&amp; ev.type == ControlEvent.EXITED) {
+			pnlTab.selectNextTab(true, true);
+			if (ev.target == chkFromLogged)
+				Gui.takeFocus(inpToProfile, ControlConstants.ByKeyboard);
+			if (ev.target == chkToLogged)
+				Gui.takeFocus(txtMission, ControlConstants.ByKeyboard);
+		}
+		// The user closed the travelbugs screen
+		if (ev instanceof FormEvent &amp;&amp; ev.type == FormEvent.CLOSED &amp;&amp; chD != null) {
+			model.allTravelbugJourneys.saveTravelbugsFile();
+			model.allTravelbugJourneys.clear();
+			// Save the flag about showing non-logged journeys only
+			boolean old = Global.getPref().travelbugShowOnlyNonLogged;
+			Global.getPref().travelbugShowOnlyNonLogged = (tcTbJourneyList.mnuToggleList.modifiers &amp; MenuItem.Checked) == MenuItem.Checked;
+			String travelbugColWidth = modTbJourneyList.getColWidths();
+			// If the preferences changed, save the pref.xml file
+			Vm.showWait(true);
+			if (!Global.getPref().travelbugColWidth.equals(travelbugColWidth) ||
+					old != Global.getPref().travelbugShowOnlyNonLogged) {
+				Global.getPref().travelbugColWidth = travelbugColWidth;
+				Global.getPref().savePreferences();
+			}
+			// If the list of travelbugs in the cache was modified, we need to
+			// save the cache too
+			if (chDmodified) {
+				ch.setHas_bugs(chD.Travelbugs.size() &gt; 0);
+				ch.save();
+			}
+			Vm.showWait(false);
+			chD = null;
+		}
+		updateNumBugs();
+		currentControl = Gui.focusedControl();
+	}
+
+	// ==============================================================
+	// tbListTableModel
+	// ==============================================================
+	class tbListTableModel extends TableModel {
+		private FontMetrics fm;
+		private Image imgRed;
+
+		tbListTableModel() {
+
+			fillToEqualHeights = true;
+			allRowsSameSize = true;
+			hasRowHeaders = false;
+			// shadeAlternateRows=true;
+			cursorSize = new Dimension(12, 1);
+			clipData = true;
+			fm = getFontMetrics();
+			// A red dot indicates that the journey has not been completely
+			// logged
+			imgRed = new Image(&quot;red.png&quot;);
+		}
+
+		private int colWidth[];
+		private int columnMap[];
+
+		public Object getCellText(int row, int col) {
+			return null;
+		}
+
+		public Object getCellData(int row, int col) {
+			if (row == -1) {
+				return TravelbugJourney.getElementNameByNumber(columnMap[col]);
+			} else {
+				int map = columnMap[col];
+				// If we have not yet logged the from or the to, a red dot is
+				// placed in front of the first item
+				if (col == 0 &amp;&amp; (!model.allTravelbugJourneys.getTBJourney(row).getFromLogged() ||
+						!model.allTravelbugJourneys.getTBJourney(row).getToLogged())) {
+					// Is it a column with a checkbox?
+					if (map != 7 &amp;&amp; map != 11)
+						return new IconAndText((IImage) imgRed, (String) model.allTravelbugJourneys.getTBJourney(row)
+								.getElementByNumber(map), fm);
+					else { // Checkbox - special treatment
+						IconAndText iat = new IconAndText(imgRed, &quot;&quot;, fm);
+						iat.addColumn(model.allTravelbugJourneys.getTBJourney(row).getElementByNumber(map));
+						return iat;
+					}
+				} else
+					return model.allTravelbugJourneys.getTBJourney(row).getElementByNumber(map);
+			}
+		}
+
+		public int calculateRowHeight(int row) {
+			return charHeight + 2;
+		}
+
+		public int calculateColWidth(int col) {
+			if (col == -1)
+				return 0;
+			else if (col &lt; numCols)
+				return colWidth[columnMap[col]];
+			else
+				return 0;
+		}
+
+		public TableCellAttributes getCellAttributes(int row, int col, boolean isSelected, TableCellAttributes ta) {
+			ta = super.getCellAttributes(row, col, isSelected, ta);
+			ta.alignment = CellConstants.LEFT;
+			ta.anchor = CellConstants.LEFT;
+			// Color the elements red, if we have not yet logged
+			if (row &gt;= 0)
+				switch (columnMap[col]) {
+				case 6: // fromDate
+					if (!model.allTravelbugJourneys.getTBJourney(row).getFromLogged())
+						ta.foreground = RED;
+					break;
+				case 10: // toDate
+					if (!model.allTravelbugJourneys.getTBJourney(row).getToLogged())
+						ta.foreground = RED;
+					break;
+				}
+			return ta;
+		}
+
+		public void showFields(TravelbugJourney tbj) {
+			inpName.setText(tbj.getTb().getName());
+			inpTrackingNo.setText(tbj.getTb().getTrackingNo());
+			lblId.setText(tbj.getTb().getGuid());
+			inpFromProfile.setText(tbj.getFromProfile());
+			inpFromWaypoint.setText(tbj.getFromWaypoint());
+			inpFromDate.setText(tbj.getFromDate());
+			chkFromLogged.setState(tbj.getFromLogged());
+			inpToProfile.setText(tbj.getToProfile());
+			inpToWaypoint.setText(tbj.getToWaypoint());
+			inpToDate.setText(tbj.getToDate());
+			chkToLogged.setState(tbj.getToLogged());
+			txtMission.setHtml(tbj.getTb().getMission());
+		}
+
+		private boolean sortAsc = false;
+		private int sortedBy = -1;
+		private int lastRow = -1;
+		public int penEventModifiers;
+
+		public boolean penPressed(Point onTable, Point cell) {
+			boolean retval = false;
+			if (cell != null &amp;&amp; cell.y == -1) { // Hit a header =&gt; sort the
+				// table accordingly
+				Vm.showWait(true);
+				if (cell.x == sortedBy)
+					sortAsc = !sortAsc;
+				else
+					sortAsc = false;
+				sortedBy = cell.x;
+				// Check whether the list only shows non-logged journeys. If so,
+				// a subset
+				// of the table must be sorted
+				if ((tcTbJourneyList.mnuToggleList.modifiers &amp; MenuItem.Checked) == MenuItem.Checked) {
+					model.allTravelbugJourneys.sortFirstHalf(columnMap[cell.x], sortAsc, modTbJourneyList.numRows);
+				} else { // Showing all journeys - sort the full table
+					model.allTravelbugJourneys.sort(columnMap[cell.x], sortAsc);
+				}
+				tcTbJourneyList.repaint();
+				Vm.showWait(false);
+				retval = true;
+			} else if (cell != null &amp;&amp; cell.y &gt;= 0 &amp;&amp; (penEventModifiers &amp; IKeys.SHIFT) &gt; 0) {
+				// A range of rows can be marked by shift-click on the first and
+				// last row
+				if (lastRow != -1) { // Second row being marked with shift key
+					// pressed
+					if (lastRow &lt; cell.y)
+						toggleSelect(lastRow, cell.y);
+					else
+						toggleSelect(cell.y, lastRow);
+					lastRow = -1;
+					retval = true;
+				} else { // Remember this row as start of range, but don't
+					// toggle yet
+					lastRow = cell.y;
+				}
+			} else { // Single row marked
+				lastRow = -1;
+			}
+			return retval;
+		}
+
+		/** Select a range of rows */
+		private void toggleSelect(int fromRow, int toRow) {
+			tcTbJourneyList.clearSelection(null);
+			tcTbJourneyList.addToSelection(new Rect(0, fromRow, numCols, toRow - fromRow + 1), false, true);
+		}
+
+		/**
+		 * Return the column widths as a comma delimited string for storing in
+		 * the preferences
+		 * 
+		 * @return
+		 */
+		private String getColWidths() {
+			// Update the list with the current widths
+			for (int col = 0; col &lt; numCols; col++) {
+				colWidth[columnMap[col]] = getColWidth(col);
+			}
+			// Convert to string
+			StringBuffer sb = new StringBuffer(40);
+			for (int i = 0; i &lt; colWidth.length; i++) {
+				if (sb.length() != 0)
+					sb.append(',');
+				sb.append(colWidth[i]);
+			}
+			return sb.toString();
+		}
+	}
+
+	// ==============================================================
+	// tbListControl
+	// ==============================================================
+	class tbListControl extends TableControl {
+		private MenuItem mnuNewTB, mnuDeleteTB, mnuGetMission, mnuOpenOnline, mnuDropTB, mnuPickupTB, mnuDeleteTBs;
+		public MenuItem mnuToggleList;
+		private Menu mnuFullMenu, mnuDeleteMenu;
+		private TravelBugScreenModel tbModel;
+
+		tbListControl(TravelBugScreenModel tbModel) {
+			this.tbModel = tbModel;
+			MenuItem[] TBMenuItems = new MenuItem[10];
+			TBMenuItems[0] = mnuPickupTB = new MenuItem(MyLocale.getMsg(6040, &quot;Pick up TB from current cache&quot;));
+			TBMenuItems[1] = mnuDropTB = new MenuItem(MyLocale.getMsg(6041, &quot;Drop TB in cache&quot;));
+			TBMenuItems[2] = new MenuItem(&quot;-&quot;);
+			TBMenuItems[3] = mnuNewTB = new MenuItem(MyLocale.getMsg(6042, &quot;New Travelbug&quot;));
+			TBMenuItems[4] = mnuDeleteTB = new MenuItem(MyLocale.getMsg(6043, &quot;Delete Travelbug&quot;));
+			TBMenuItems[5] = new MenuItem(&quot;-&quot;);
+			TBMenuItems[6] = mnuGetMission = new MenuItem(MyLocale.getMsg(6044, &quot;Get Mission&quot;));
+			TBMenuItems[7] = mnuOpenOnline = new MenuItem(MyLocale.getMsg(6045, &quot;Open on-line&quot;));
+			TBMenuItems[8] = new MenuItem(&quot;-&quot;);
+			TBMenuItems[9] = mnuToggleList = new MenuItem(MyLocale.getMsg(6046, &quot;Show only not logged&quot;));
+			mnuFullMenu = new Menu(TBMenuItems, &quot;&quot;);
+			// A second pop-up menu with only one entry, if a range of rows is
+			// selected
+			MenuItem[] TBMenuItemsDel = new MenuItem[1];
+			TBMenuItemsDel[0] = mnuDeleteTBs = new MenuItem(MyLocale.getMsg(6047, &quot;Delete selected Travelbugs&quot;));
+			mnuDeleteMenu = new Menu(TBMenuItemsDel, &quot;&quot;);
+			mnuDropTB.modifiers |= MenuItem.Disabled;
+			mnuDeleteTB.modifiers |= MenuItem.Disabled;
+			mnuGetMission.modifiers |= MenuItem.Disabled;
+			mnuOpenOnline.modifiers |= MenuItem.Disabled;
+		}
+
+		public void onEvent(Event ev) {
+			if (ev instanceof PenEvent) {
+				modTbJourneyList.penEventModifiers = ((PenEvent) ev).modifiers;
+			}
+
+			Rect sel = getSelection();
+			if (sel.y &lt; tbModel.allTravelbugJourneys.size()) {
+				mnuDeleteTB.modifiers &amp;= ~MenuItem.Disabled;
+				mnuGetMission.modifiers &amp;= ~MenuItem.Disabled;
+				mnuOpenOnline.modifiers &amp;= ~MenuItem.Disabled;
+				if (tbModel.allTravelbugJourneys.getTBJourney(sel.y).inMyPosession())
+					mnuDropTB.modifiers &amp;= ~MenuItem.Disabled;
+				else
+					mnuDropTB.modifiers |= MenuItem.Disabled;
+			} else {
+				mnuDeleteTB.modifiers |= MenuItem.Disabled;
+				mnuGetMission.modifiers |= MenuItem.Disabled;
+				mnuOpenOnline.modifiers |= MenuItem.Disabled;
+			}
+			// If more than one row is selected, show the limited pop-up menu
+			if (sel.height &gt; 1)
+				setMenu(mnuDeleteMenu);
+			else
+				setMenu(mnuFullMenu);
+			if (ev instanceof PenEvent)
+				modTbJourneyList.penEventModifiers = ((PenEvent) ev).modifiers;
+			super.onEvent(ev);
+		}
+
+		private Rect getSelection() {
+			Rect sel = getSelection(null);
+			return sel;
+		}
+
+		public void penRightReleased(Point p) {
+			menuState.doShowMenu(p, true, null); // direct call (not through
+			// doMenu) is neccesary
+			// because it will exclude
+			// the whole table
+		}
+
+		public void penHeld(Point p) {
+			menuState.doShowMenu(p, true, null);
+		}
+
+		public void popupMenuEvent(Object selectedItem) {
+			if (selectedItem == mnuPickupTB) {
+				Travelbug tb = TravelbugPickup.pickupTravelbug(tblSrcCache);
+				if (tb != null) {
+					chDmodified = true;
+					tbModel.allTravelbugJourneys.addTbPickup(tb, Global.getProfile().name, waypoint);
+					modTbJourneyList.numRows = tbModel.allTravelbugJourneys.size();
+					tcTbJourneyList.repaint();
+				}
+			}
+			if (selectedItem == mnuDropTB) {
+				if (selectedRow &gt;= 0 &amp;&amp; selectedRow &lt; modTbJourneyList.numRows) {
+					Travelbug tb = tbModel.allTravelbugJourneys.getTBJourney(selectedRow).getTb();
+					chD.Travelbugs.add(tb);
+					tbModel.allTravelbugJourneys.addTbDrop(tb, Global.getProfile().name, waypoint);
+					chDmodified = true;
+					ch.setHas_bugs(true);
+				}
+				repaint();
+			}
+			if (selectedItem == mnuNewTB) {
+				TravelbugJourney tbj = new TravelbugJourney(&quot;New&quot;);
+				tbj.setFromProfile(Global.getProfile().name);
+				tbj.setFromWaypoint(waypoint);
+				tbModel.allTravelbugJourneys.add(tbj);
+				modTbJourneyList.numRows = tbModel.allTravelbugJourneys.size();
+				cursorTo(tbModel.allTravelbugJourneys.size() - 1, 1, true);
+				tcTbJourneyList.repaint();
+			}
+			if (selectedItem == mnuDeleteTB &amp;&amp; selectedRow &gt;= 0) {
+				tbModel.allTravelbugJourneys.remove(selectedRow);
+				modTbJourneyList.numRows = tbModel.allTravelbugJourneys.size();
+				if (selectedRow &gt; 0)
+					cursorTo(selectedRow - 1, 0, true);
+				else
+					modTbJourneyList.showFields(new TravelbugJourney(&quot;&quot;));
+				tcTbJourneyList.repaint();
+			}
+			/*
+			 * Delete a group of travelbugs which have been marked with
+			 * Shift-Click
+			 */
+			if (selectedItem == mnuDeleteTBs) {
+				Rect sel = getSelection();
+				for (int i = 0; i &lt; sel.height; i++)
+					tbModel.allTravelbugJourneys.remove(sel.y);
+				modTbJourneyList.numRows = tbModel.allTravelbugJourneys.size();
+				if (sel.y &lt; modTbJourneyList.numRows)
+					cursorTo(sel.y, 0, true);
+				else
+					modTbJourneyList.showFields(new TravelbugJourney(&quot;&quot;));
+				tcTbJourneyList.repaint();
+			}
+			if (selectedItem == mnuGetMission &amp;&amp; selectedRow &gt; -1) {
+				TravelbugJourney tbj = tbModel.allTravelbugJourneys.getTBJourney(selectedRow);
+				SpiderGC spider = new SpiderGC(Global.getPref(), Global.getProfile());
+				Vm.showWait(true);
+
+				// if we have an ID, get mission by ID
+				if (tbj.getTb().getGuid().length() != 0) {
+					tbj.getTb().setMission(spider.getBugMissionByGuid(tbj.getTb().getGuid()));
+				} else {
+					// try to get mission and name by tracking number
+					boolean suceeded = false;
+					if (tbj.getTb().getTrackingNo().length() != 0) {
+						suceeded = spider.getBugMissionAndNameByTrackNr(tbj.getTb());
+					}
+					// if this has't worked, try to get ID by name
+					if (!suceeded) {
+						tbj.getTb().setGuid(spider.getBugId(tbj.getTb().getName().trim()));
+						// if we have an ID now, get mission by ID
+						if (tbj.getTb().getGuid().length() != 0) {
+							tbj.getTb().setMission(spider.getBugMissionByGuid(tbj.getTb().getGuid()));
+						}
+					}
+				}
+
+				Vm.showWait(false);
+				tcTbJourneyList.repaint();
+				txtMission.setHtml(tbj.getTb().getMission());
+				inpName.setText(tbj.getTb().getName());
+				lblId.setText(tbj.getTb().getGuid());
+				lowerpane.repaint();
+			}
+			if (selectedItem == mnuOpenOnline &amp;&amp; selectedRow &gt;= 0) {
+				TravelbugJourney tbj = tbModel.allTravelbugJourneys.getTBJourney(selectedRow);
+				SpiderGC spider = new SpiderGC(Global.getPref(), Global.getProfile());
+				Vm.showWait(true);
+				// First check whether ID is set, if not get it
+				if (tbj.getTb().getGuid().length() == 0)
+					tbj.getTb().setGuid(spider.getBugId(tbj.getTb().getName()));
+				if (tbj.getTb().getGuid().length() != 0) {
+					Vm.showWait(false);
+					try {
+						String s;
+						if (tbj.getTb().getGuid().length() &gt; 10)
+							s = &quot;<A HREF="http://www.geocaching.com/track/details.aspx?guid=">http://www.geocaching.com/track/details.aspx?guid=</A>&quot; + tbj.getTb().getGuid();
+						else
+							s = &quot;<A HREF="http://www.geocaching.com/track/details.aspx?id=">http://www.geocaching.com/track/details.aspx?id=</A>&quot; + tbj.getTb().getGuid();
+
+						CWWrapper.exec(Global.getPref().browser, s);
+						Global.getPref().log(&quot;Executed: \&quot;&quot; + Global.getPref().browser + &quot;\&quot; \&quot;&quot; + s + &quot;\&quot;&quot;);
+					} catch (Exception ioex) {
+						Global.getPref().log(&quot;Ignored Exception&quot;, ioex, true);
+					}
+				}
+			}
+			if (selectedItem == mnuToggleList) {
+				toggleNonLogged();
+			}
+			updateNumBugs();
+		}
+
+		/**
+		 * Toggle between displaying all journeys or just those which still need
+		 * to be logged
+		 */
+		public void toggleNonLogged() {
+			mnuToggleList.modifiers ^= MenuItem.Checked;
+			if ((mnuToggleList.modifiers &amp; MenuItem.Checked) == MenuItem.Checked) {
+				// First sort the non-logged items to the top
+				tbModel.allTravelbugJourneys.sort(TravelbugJourney.BOTHLOGGED, false);
+				// modListTable.numRows=tblMyTravelbugJourneys.size();
+				modTbJourneyList.numRows = tbModel.allTravelbugJourneys.countNonLogged();
+			} else {
+				modTbJourneyList.numRows = tbModel.allTravelbugJourneys.size();
+			}
+			tcTbJourneyList.repaint();
+		}
+
+		public void cursorTo(int row, int col, boolean selectNew) {
+			super.cursorTo(row, col, selectNew);
+			selectedRow = row;
+			if (row &gt;= 0) {
+				modTbJourneyList.showFields(tbModel.allTravelbugJourneys.getTBJourney(row));
+			} else {
+				modTbJourneyList.showFields(new TravelbugJourney(&quot;&quot;));
+			}
+		}
+	}
+
+}

Added: trunk/src/CacheWolf/view/ewe/TravelbugMenu.java
===================================================================
--- trunk/src/CacheWolf/view/ewe/TravelbugMenu.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/ewe/TravelbugMenu.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,176 @@
+package CacheWolf.view.ewe;
+
+import CacheWolf.Global;
+import CacheWolf.MyLocale;
+import CacheWolf.Travelbug;
+import CacheWolf.TravelbugJourney;
+import CacheWolf.TravelbugList;
+import CacheWolf.TravelbugPickup;
+import CacheWolf.imp.SpiderGC;
+import CacheWolf.model.TravelBugScreenModel;
+import CacheWolf.utils.CWWrapper;
+import ewe.fx.Rect;
+import ewe.sys.Vm;
+import ewe.ui.Event;
+import ewe.ui.Menu;
+import ewe.ui.MenuBar;
+import ewe.ui.MenuEvent;
+import ewe.ui.MenuItem;
+import ewe.ui.PullDownMenu;
+
+/**
+ * Controller for the {@link TravelbugList}. Preferrably used by
+ * {@link TravelbugJourneyScreen}
+ * 
+ * @author andi
+ * 
+ */
+public class TravelbugMenu extends MenuBar {
+	private MenuItem mnuNewTB;
+	private MenuItem mnuDeleteTB;
+	private MenuItem mnuGetMission;
+	private MenuItem mnuOpenOnline;
+	private MenuItem mnuDropTB;
+	private MenuItem mnuPickupTB;
+	private MenuItem mnuDeleteTBs;
+
+	/**
+	 * The model controlled by this
+	 */
+	/**
+	 * The View displaying the model for this
+	 */
+	public TravelbugJourneyScreen view;
+	private TravelBugScreenModel model;
+
+	
+	public TravelbugMenu(TravelBugScreenModel model) {
+		this.model = model;
+		MenuItem[] TBMenuItems = new MenuItem[9];
+		TBMenuItems[0] = mnuPickupTB = new MenuItem(MyLocale.getMsg(6040, &quot;Pick up TB from current cache&quot;));
+		TBMenuItems[1] = mnuDropTB = new MenuItem(MyLocale.getMsg(6041, &quot;Drop TB in cache&quot;));
+		TBMenuItems[2] = new MenuItem(&quot;-&quot;);
+		TBMenuItems[3] = mnuNewTB = new MenuItem(MyLocale.getMsg(6042, &quot;New Travelbug&quot;));
+		TBMenuItems[4] = mnuDeleteTB = new MenuItem(MyLocale.getMsg(6043, &quot;Delete Travelbug&quot;));
+		TBMenuItems[5] = new MenuItem(&quot;-&quot;);
+		TBMenuItems[6] = mnuGetMission = new MenuItem(MyLocale.getMsg(6044, &quot;Get Mission&quot;));
+		TBMenuItems[7] = mnuOpenOnline = new MenuItem(MyLocale.getMsg(6045, &quot;Open on-line&quot;));
+		TBMenuItems[8] = new MenuItem(&quot;-&quot;);
+		// A second pop-up menu with only one entry, if a range of rows is
+		// selected
+		MenuItem[] TBMenuItemsDel = new MenuItem[1];
+		TBMenuItemsDel[0] = mnuDeleteTBs = new MenuItem(MyLocale.getMsg(6047, &quot;Delete selected Travelbugs&quot;));
+		// mnuDropTB.modifiers |= MenuItem.Disabled;
+		// mnuDeleteTB.modifiers |= MenuItem.Disabled;
+		// mnuGetMission.modifiers |= MenuItem.Disabled;
+		// mnuOpenOnline.modifiers |= MenuItem.Disabled;
+
+		this.addMenu(new PullDownMenu(MyLocale.getMsg(120, &quot;Application&quot;), new Menu(TBMenuItems, null)));
+
+	}
+
+	public void onEvent(Event event) {
+		if (event instanceof MenuEvent) {
+			MenuEvent mev = (MenuEvent) event;
+			if (mev.selectedItem == mnuPickupTB) {
+				Travelbug tb = TravelbugPickup.pickupTravelbug(view.tblSrcCache);
+				if (tb != null) {
+					view.chDmodified = true;
+					model.allTravelbugJourneys.addTbPickup(tb, Global.getProfile().name, view.waypoint);
+					view.modTbJourneyList.numRows = model.allTravelbugJourneys.size();
+					view.repaint();
+				}
+
+			} else if (mev.selectedItem == mnuDropTB) {
+				if (view.selectedRow &gt;= 0 &amp;&amp; view.selectedRow &lt; view.modTbJourneyList.numRows) {
+					Travelbug tb = model.allTravelbugJourneys.getTBJourney(view.selectedRow).getTb();
+					view.chD.Travelbugs.add(tb);
+					model.allTravelbugJourneys.addTbDrop(tb, Global.getProfile().name, view.waypoint);
+					view.chDmodified = true;
+					view.ch.setHas_bugs(true);
+				}
+				view.repaint();
+			} else if (mev.selectedItem == mnuNewTB) {
+				TravelbugJourney tbj = new TravelbugJourney(&quot;New&quot;);
+				tbj.setFromProfile(Global.getProfile().name);
+				tbj.setFromWaypoint(view.waypoint);
+				model.allTravelbugJourneys.add(tbj);
+				view.modTbJourneyList.numRows = model.allTravelbugJourneys.size();
+				// view.cursorTo(view.tblMyTravelbugJourneys.size()-1,1,true);
+				view.repaint();
+			} else if (mev.selectedItem == mnuDeleteTB &amp;&amp; view.selectedRow &gt;= 0) {
+				model.allTravelbugJourneys.remove(view.selectedRow);
+				view.modTbJourneyList.numRows = model.allTravelbugJourneys.size();
+				if (view.selectedRow &gt; 0) {
+					// cursorTo(view.selectedRow-1,0,true);
+				} else {
+					// view.modTbJourneyList.showFields(new
+					// TravelbugJourney(&quot;&quot;));
+				}
+				view.repaint();
+			}
+			/*
+			 * Delete a group of travelbugs which have been marked with
+			 * Shift-Click
+			 */
+			if (mev.selectedItem == mnuDeleteTBs) {
+				Rect sel = view.tcTbJourneyList.getSelection(null);
+				for (int i = 0; i &lt; sel.height; i++)
+					model.allTravelbugJourneys.remove(sel.y);
+				view.modTbJourneyList.numRows = model.allTravelbugJourneys.size();
+				if (sel.y &lt; view.modTbJourneyList.numRows) {
+					// cursorTo(sel.y,0,true);
+				} else {
+					view.modTbJourneyList.showFields(new TravelbugJourney(&quot;&quot;));
+				}
+				view.repaint();
+			} else if (mev.selectedItem == mnuGetMission &amp;&amp; view.selectedRow &gt; -1) {
+				TravelbugJourney tbj = model.allTravelbugJourneys.getTBJourney(view.selectedRow);
+				SpiderGC spider = new SpiderGC(Global.getPref(), Global.getProfile());
+				Vm.showWait(true);
+
+				// if we have an ID, get mission by ID
+				if (tbj.getTb().getGuid().length() != 0) {
+					tbj.getTb().setMission(spider.getBugMissionByGuid(tbj.getTb().getGuid()));
+				} else {
+					// try to get mission and name by tracking number
+					boolean suceeded = false;
+					if (tbj.getTb().getTrackingNo().length() != 0) {
+						suceeded = spider.getBugMissionAndNameByTrackNr(tbj.getTb());
+					}
+					// if this has't worked, try to get ID by name
+					if (!suceeded) {
+						tbj.getTb().setGuid(spider.getBugId(tbj.getTb().getName().trim()));
+						// if we have an ID now, get mission by ID
+						if (tbj.getTb().getGuid().length() != 0) {
+							tbj.getTb().setMission(spider.getBugMissionByGuid(tbj.getTb().getGuid()));
+						}
+					}
+				}
+			} else if (mev.selectedItem == mnuOpenOnline &amp;&amp; view.selectedRow &gt;= 0) {
+				TravelbugJourney tbj = model.allTravelbugJourneys.getTBJourney(view.selectedRow);
+				SpiderGC spider = new SpiderGC(Global.getPref(), Global.getProfile());
+				Vm.showWait(true);
+				// First check whether ID is set, if not get it
+				if (tbj.getTb().getGuid().length() == 0)
+					tbj.getTb().setGuid(spider.getBugId(tbj.getTb().getName()));
+				if (tbj.getTb().getGuid().length() != 0) {
+					Vm.showWait(false);
+					try {
+						String s;
+						if (tbj.getTb().getGuid().length() &gt; 10)
+							s = &quot;<A HREF="http://www.geocaching.com/track/details.aspx?guid=">http://www.geocaching.com/track/details.aspx?guid=</A>&quot; + tbj.getTb().getGuid();
+						else
+							s = &quot;<A HREF="http://www.geocaching.com/track/details.aspx?id=">http://www.geocaching.com/track/details.aspx?id=</A>&quot; + tbj.getTb().getGuid();
+
+						CWWrapper.exec(Global.getPref().browser, s);
+						Global.getPref().log(&quot;Executed: \&quot;&quot; + Global.getPref().browser + &quot;\&quot; \&quot;&quot; + s + &quot;\&quot;&quot;);
+					} catch (Exception ioex) {
+						Global.getPref().log(&quot;Ignored Exception&quot;, ioex, true);
+					}
+				}
+			}
+
+		}
+	}
+}


Property changes on: trunk/src/CacheWolf/view/ewe/TravelbugMenu.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDADateTimeChooser.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDADateTimeChooser.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDADateTimeChooser.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,253 @@
+package CacheWolf.view.pda;
+
+import CacheWolf.MyLocale;
+import ewe.fx.Color;
+import ewe.fx.Font;
+import ewe.fx.Rect;
+import ewe.sys.Convert;
+import ewe.sys.Time;
+import ewe.ui.CellPanel;
+import ewe.ui.ControlEvent;
+import ewe.ui.Form;
+import ewe.ui.Gui;
+import ewe.ui.Panel;
+import ewe.ui.mButton;
+import ewe.ui.mLabel;
+import ewe.util.Grid;
+
+public class PDADateTimeChooser extends Form  {
+
+	private int year; 
+	private int month; 
+	private int day; 
+
+	private int hour; 
+	public int getHour() {
+		return hour;
+	}
+
+	public int getMinute() {
+		return minute;
+	}
+
+	private int minute; 
+
+	private	mLabel lbDay;
+	private mLabel lbMonth;
+	private mLabel lbYear;
+	private mLabel lbHour;
+	private mLabel lbMinute;
+	private mLabel lbSep;
+	
+	private mButton btDayUp;
+	private mButton btMonthUp;
+	private mButton btYearUp;
+	private mButton btHourUp;
+	private mButton btMinuteUp;
+
+	private mButton btDayDown;
+	private mButton btMonthDown;
+	private mButton btYearDown;
+	private mButton btHourDown;
+	private mButton btMinuteDown;
+
+	private mButton btSet;
+	private mButton btTime;
+	private mButton btCalendar;
+	private mButton btCancel;
+
+	public PDADateTimeChooser (){
+		int screenWidth = MyLocale.getScreenWidth();
+		String string = &quot;SET TIME CANCEL&quot;;
+		int fontsize =  screenWidth/string.length();
+		Rect size = Gui.getSize(getFontMetrics(), string, 5,0);
+		while (size.width &lt; screenWidth) {
+			fontsize += 5;
+			font = new Font(getFont().getName(), Font.BOLD,fontsize);
+			size = Gui.getSize(getFontMetrics(), string, 5, 0);
+		}
+
+		backGround = Color.White;
+
+		lbDay = new mLabel(&quot;&quot;);
+		lbDay.anchor=mLabel.CENTER;
+		lbMonth = new mLabel (&quot;&quot;);
+		lbMonth.anchor=mLabel.CENTER;
+		lbYear = new mLabel (&quot;&quot;);
+		lbYear.anchor=mLabel.CENTER;
+		lbHour = new mLabel (&quot;HH&quot;);
+		lbHour.anchor=mLabel.CENTER;
+		lbSep = new mLabel(&quot;:&quot;);
+		lbMinute = new mLabel (&quot;MM&quot;);
+		lbMinute.anchor=mLabel.CENTER;
+
+		btDayUp = new mButton (&quot; ^^ &quot;);btDayUp.backGround=Color.LightBlue;
+		btMonthUp = new mButton (&quot; ^^ &quot;);btMonthUp.backGround=Color.LightBlue;
+		btYearUp = new mButton (&quot;  ^^  &quot;);btYearUp.backGround=Color.LightBlue;
+		btHourUp = new mButton (&quot;  ^^  &quot;);btHourUp.backGround=Color.LightBlue;
+		btMinuteUp = new mButton (&quot;  ^^  &quot;);btMinuteUp.backGround=Color.LightBlue;
+
+		btDayDown = new mButton (&quot;vv&quot;);btDayDown.backGround=Color.LightBlue;
+		btMonthDown = new mButton (&quot;vv&quot;);btMonthDown.backGround=Color.LightBlue;
+		btYearDown = new mButton (&quot; vv &quot;);btYearDown.backGround=Color.LightBlue;
+		btHourDown = new mButton (&quot; vv &quot;);btHourDown.backGround=Color.LightBlue;
+		btMinuteDown = new mButton (&quot; vv &quot;);btMinuteDown.backGround=Color.LightBlue;
+		
+		btSet = new mButton (&quot;Set&quot;);btSet.backGround=Color.Sand;
+		btTime = new mButton (&quot;Time&quot;);btTime.backGround=Color.Sand;
+		btCalendar  = new mButton(&quot;Cal&quot;);btCalendar.backGround=Color.Sand;
+		btCancel = new mButton (&quot;Cancel&quot;);btCancel.backGround=Color.Sand;
+
+		layoutCalendar();
+		
+		addListener(this);
+	}
+
+	
+	private void layoutCalendar() {
+		removeAll();
+		addNext (lbDay,HSTRETCH,HFILL);
+		addNext (lbMonth,HSTRETCH,HFILL);
+		addLast (lbYear,HSTRETCH,HFILL);
+
+		addNext (btDayUp,HSTRETCH,HFILL);
+		addNext (btMonthUp,HSTRETCH,HFILL);
+		addLast (btYearUp,HSTRETCH,HFILL);
+
+		addNext (btDayDown,HSTRETCH,HFILL);
+		addNext (btMonthDown,HSTRETCH,HFILL);
+		addLast (btYearDown,HSTRETCH,HFILL);
+		
+		addNext (btSet, HSTRETCH,CENTER|HFILL);
+		addNext (btTime, HSTRETCH,CENTER|HFILL);
+		addLast (btCancel, HSTRETCH,CENTER|HFILL);
+	}
+	
+	private void layoutTime() {
+		removeAll ();
+		Panel p = new CellPanel();
+		p.addNext (lbHour, HSTRETCH,HFILL);
+		p.addNext (lbSep,DONTSTRETCH,DONTFILL);
+		p.addLast (lbMinute, HSTRETCH,CENTER);
+		p.addNext (btHourUp, HSTRETCH,HFILL);
+		p.addNext(new mLabel(&quot;&quot;));
+		p.addLast (btMinuteUp, HSTRETCH,HFILL);
+		p.addNext (btHourDown, HSTRETCH,HFILL);
+		p.addNext(new mLabel(&quot;&quot;));
+		p.addLast (btMinuteDown, HSTRETCH,HFILL);
+		
+		addLast (p, HSTRETCH,HFILL);
+
+		Panel p1 = new CellPanel();
+		p1.addNext(btSet, HSTRETCH,CENTER|HFILL);
+		p1.addNext(btCalendar, HSTRETCH,CENTER|HFILL);
+		p1.addLast(btCancel, HSTRETCH,CENTER|HFILL);
+		addLast (p1, HSTRETCH,CENTER|HFILL);
+	}
+
+	public int getDay() {
+		return day;
+	}
+
+	public int getMonth() {
+		return month;
+	}
+
+	public String getTime() {
+		return Convert.toString(year) + &quot;-&quot; + MyLocale.formatLong(month, &quot;00&quot;) + &quot;-&quot;
+		+ MyLocale.formatLong(day, &quot;00&quot;) + &quot; &quot; + MyLocale.formatLong(hour, &quot;00&quot;) +
+		&quot;:&quot;+MyLocale.formatLong(minute, &quot;00&quot;);
+	}
+
+	public int getYear() {
+		return year;
+	}
+
+	public void reset(Time t) {
+		year = t.year;
+		month = t.month;
+		day = t.day;
+		hour = t.hour;
+		minute=t.minute;
+
+		lbDay.setText(Integer.toString(day));
+		lbMonth.setText(Integer.toString(month));
+		lbYear.setText(Integer.toString(year));
+		lbHour.setText(Integer.toString(hour));
+		lbMinute.setText(MyLocale.formatLong(minute, &quot;00&quot;));
+	}
+	
+	public void onControlEvent(ControlEvent ev) {
+		switch (ev.type) {
+		case ControlEvent.PRESSED:
+			if (ev.target == btDayUp &amp;&amp; day &lt; 31) {
+				day++;
+				lbDay.setText(Integer.toString(day));
+			}
+			else if (ev.target == btDayDown &amp;&amp; day &gt; 1){
+				day--;
+				lbDay.setText(Integer.toString(day));
+			}
+			
+			else if (ev.target == btMonthUp &amp;&amp; month &lt; 12){
+				month++;
+				lbMonth.setText(Integer.toString(month));
+			}
+			else if (ev.target == btMonthDown &amp;&amp; month &gt; 1){
+				month--;
+				lbMonth.setText(Integer.toString(month));
+			}
+
+			else if (ev.target == btYearUp){
+				year++;
+				lbYear.setText(Integer.toString(year));
+			}
+			else if (ev.target == btYearDown){
+				year--;
+				lbYear.setText(Integer.toString(year));
+			}
+			
+			else if (ev.target == btHourUp &amp;&amp; hour &lt; 23){
+				hour++;
+				lbHour.setText(Integer.toString(hour));
+			}
+			else if (ev.target == btHourDown &amp;&amp; hour &gt; 0){
+				hour--;
+				lbHour.setText(Integer.toString(hour));
+			}
+			else if (ev.target == btMinuteUp &amp;&amp; minute &lt; 59){
+				minute++;
+				lbMinute.setText(MyLocale.formatLong(minute, &quot;00&quot;));
+			}
+			else if (ev.target == btMinuteDown &amp;&amp; minute &gt; 0){
+				minute--;
+				lbMinute.setText(MyLocale.formatLong(minute, &quot;00&quot;));
+			}
+
+			else if (ev.target == btSet){
+				exit(IDOK);
+			}
+			else if (ev.target == btTime){
+				Gui.flashMessage(&quot;Uhrzeit anzeigen&quot;, 1000, this, 0);
+				made=false;
+				layoutTime();
+				make(true);
+				relayoutMe(true);
+				reShow(0,0,width,height);
+			}
+			else if (ev.target == btCalendar){
+				Gui.flashMessage(&quot;Calendar anzeigen!&quot;, 1000, this, 0);
+				made=false;
+				layoutCalendar();
+				make(true);
+				relayoutMe(true);
+				reShow(0,0,width,height);				
+			}
+			else if (ev.target == btCancel){
+				exit(IDNO);
+			}
+			
+		}
+		super.onControlEvent(ev);
+	}
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDADateTimeChooser.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDAEmptyButton.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDAEmptyButton.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDAEmptyButton.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,7 @@
+package CacheWolf.view.pda;
+
+import ewe.ui.mButton;
+
+public class PDAEmptyButton extends mButton {
+
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDAEmptyButton.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDAListButton.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDAListButton.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDAListButton.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,42 @@
+package CacheWolf.view.pda;
+
+import ewe.fx.Color;
+import ewe.fx.Font;
+import ewe.ui.CellConstants;
+import ewe.ui.mButton;
+
+public class PDAListButton extends mButton {
+
+	public String fromText;
+	public String toText;
+	public boolean toLogged;
+	public boolean fromLogged;
+	
+	public PDAListButton(String newText, String newAction) {
+		super(newText);
+		action = newAction;
+		buttonObject = new PDAListButtonObject(this);
+
+		backGround = Color.White;
+		foreGround = Color.Black;
+
+		font = new Font(getFont().getName(), Font.BOLD, 40);
+		anchor = CellConstants.WEST;
+		textPosition=2;
+	}
+
+	public void make(boolean paramBoolean) {
+		if (this.buttonObject != null)
+			return;
+		this.buttonObject = new PDAListButtonObject(this);
+	}
+	
+//	public Dimension getPreferredSize(Dimension paramDimension) {
+//		Dimension size = super.getPreferredSize(paramDimension);
+//		FontMetrics fm = new FontMetrics(font, getWindow());
+//		size.height = (int)(fm.getHeight()*2.5);
+//		size.width=fm.getTextWidth(text);
+//		return size;
+//	}
+
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDAListButton.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDAListButtonObject.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDAListButtonObject.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDAListButtonObject.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,58 @@
+package CacheWolf.view.pda;
+
+import ewe.fx.Color;
+import ewe.fx.Font;
+import ewe.fx.Graphics;
+import ewe.fx.Rect;
+import ewe.ui.ButtonObject;
+
+public class PDAListButtonObject extends ButtonObject {
+	private PDAListButton pdaListButton;
+
+	public PDAListButtonObject(PDAListButton pdaListButton) {
+		super(pdaListButton);
+		this.pdaListButton = pdaListButton;
+	}
+
+	public void paint(Graphics paramGraphics) {
+		if ((this.soft) &amp;&amp; (this.control != null))
+			this.control.doBackground(paramGraphics);
+		if (this.text == null)
+			this.text = &quot;&quot;;
+		drawButton(paramGraphics);
+		Rect localRect1 = paramGraphics.reduceClip(new Rect(this.borderWidth, this.borderWidth, this.size.width
+				- (this.borderWidth * 2), this.size.height - (this.borderWidth * 2)));
+		try {
+			paramGraphics.setColor(foreground);
+			int x = 10;
+			if (this.image != null) {
+				int y = (size.height - image.getHeight()) / 2;
+				this.image.draw(paramGraphics, 10, y, 0);
+				x += image.getWidth();
+				x += 10;
+			}
+			paramGraphics.setFont(this.font);
+			paramGraphics.drawText(text, x, 10);
+			Font tmpFont = new Font(font.getName(), Font.BOLD, 20);
+			paramGraphics.setFont(tmpFont);
+			if (pdaListButton.fromText != null) {
+				paramGraphics.drawText(pdaListButton.fromText, x + 15, 45);
+			}
+			if (!pdaListButton.fromLogged) {
+				paramGraphics.setColor(new Color(255, 0, 0));
+				paramGraphics.fillEllipse(x, 50, 10, 10);
+				paramGraphics.setColor(foreground);
+			}
+			if (pdaListButton.toText != null) {
+				paramGraphics.drawText(pdaListButton.toText, x + 15, 70);
+			}
+			if (!pdaListButton.toLogged) {
+				paramGraphics.setColor(new Color(255, 0, 0));
+				paramGraphics.fillEllipse(x, 75, 10, 10);
+				paramGraphics.setColor(foreground);
+			}
+		} finally {
+			paramGraphics.restoreClip(localRect1);
+		}
+	}
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDAListButtonObject.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDAMenu.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDAMenu.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDAMenu.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,40 @@
+package CacheWolf.view.pda;
+
+import CacheWolf.MyLocale;
+import ewe.ui.ControlEvent;
+import ewe.ui.Form;
+
+public abstract class PDAMenu extends Form {
+
+	protected static final String CANCEL = &quot;__Cancel_Exit__&quot;;
+
+	public abstract void actionPerformed(String actionCommand);
+
+	public PDAMenu(){
+		setPreferredSize(MyLocale.getScreenWidth(), MyLocale.getScreenHeight());
+	}
+	
+	public void onControlEvent(ControlEvent paramEvent) {
+		switch (paramEvent.type) {
+		case ControlEvent.PRESSED:
+			if (paramEvent.action.equals(CANCEL)) {
+				exit(0);
+				
+			} else {
+				actionPerformed(paramEvent.action);
+			}
+		}
+		super.onControlEvent(paramEvent);
+	}
+
+	protected void buildMenu() {
+		PDAMenuButton button = new PDAMenuButton(MyLocale.getMsg(6057, &quot;Back&quot;), CANCEL);
+		addLast(button);
+	}
+
+	protected void addMenuItem(String item, String actionCommand) {
+		PDAMenuButton button = new PDAMenuButton(item, actionCommand);
+		addLast(button);
+	}
+
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDAMenu.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDAMenuButton.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDAMenuButton.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDAMenuButton.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,35 @@
+package CacheWolf.view.pda;
+
+import ewe.fx.Color;
+import ewe.fx.Font;
+import ewe.ui.CellConstants;
+import ewe.ui.mButton;
+
+public class PDAMenuButton extends mButton {
+
+	public String fromText;
+	public String toText;
+	public boolean toLogged;
+	public boolean fromLogged;
+
+	public PDAMenuButton(String newText, String newAction) {
+		super(newText);
+		action = newAction;
+
+		minHeight = 200;
+		preferredHeight=200;
+		maxHeight=200;
+		backGround = Color.Sand;
+		foreGround = Color.Black;
+
+		font = new Font(getFont().getName(), Font.BOLD, 40);
+		anchor = CellConstants.WEST;
+		textPosition = 2;
+	}
+	
+	public void make(boolean paramBoolean) {
+		if (this.buttonObject != null)
+			return;
+		this.buttonObject = new PDAMenuButtonObject(this);
+	}
+}
\ No newline at end of file


Property changes on: trunk/src/CacheWolf/view/pda/PDAMenuButton.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDAMenuButtonObject.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDAMenuButtonObject.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDAMenuButtonObject.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,24 @@
+package CacheWolf.view.pda;
+
+import ewe.fx.Dimension;
+import ewe.ui.ButtonObject;
+
+public class PDAMenuButtonObject extends ButtonObject{
+	private PDAMenuButton pdaMenuButton;
+	private Dimension calculateSize;
+
+	public PDAMenuButtonObject(PDAMenuButton pdaListButton) {
+		super(pdaListButton);
+		this.pdaMenuButton = pdaListButton;
+	}
+
+	  public Dimension calculateSize(Dimension paramDimension){
+		  calculateSize = super.calculateSize(paramDimension);
+		  if (calculateSize.height &lt; 100){
+			  calculateSize.height=100;
+			  paramDimension.height=100;
+		  }
+		  return calculateSize;
+	  }
+
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDAMenuButtonObject.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDAOptionPane.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDAOptionPane.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDAOptionPane.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,49 @@
+package CacheWolf.view.pda;
+
+import CacheWolf.Preferences;
+import ewe.fx.Color;
+import ewe.fx.Font;
+import ewe.ui.ControlEvent;
+import ewe.ui.Form;
+import ewe.ui.Frame;
+import ewe.ui.Gui;
+import ewe.ui.mLabel;
+
+public class PDAOptionPane extends Form {
+	public static final int CANCEL = 0;
+	public static final int OK = 1;
+	private static final String OK_STR = &quot;OK&quot;;
+	private static final String CANCEL_STR = &quot;CANCEL&quot;;
+
+	private int result = CANCEL;
+
+	public static int showConfirmDialog(Frame parent, String title, String message) {
+		PDAOptionPane pane = new PDAOptionPane();
+		pane.title = title;
+		pane.backGround=new Color(255,128,128);
+		Font tmpFont = new Font(&quot;Helvetica&quot;, Font.BOLD, Preferences.getPrefObject().fontSize * 2);
+		mLabel messageLabel = new mLabel(message);
+		messageLabel.font=tmpFont;
+		pane.addLast(messageLabel, HFILL, HSTRETCH);
+		PDAMenuButton button = new PDAMenuButton(&quot;OK&quot;, OK_STR);
+		pane.addNext(button, FILL, STRETCH);
+		button = new PDAMenuButton(&quot;Abbruch&quot;, CANCEL_STR);
+		pane.addLast(button, FILL, STRETCH);
+		pane.setLocation(0, 0);
+		pane.execute(null, Gui.FILL_FRAME);
+		return pane.result;
+	}
+
+	public void onControlEvent(ControlEvent event) {
+		switch (event.type) {
+		case ControlEvent.PRESSED:
+			String action = event.action;
+			if (action.equals(OK_STR)) {
+				result = OK;
+				exit(0);
+			} else if (action.equals(CANCEL_STR)) {
+				exit(0);
+			}
+		}
+	}
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDAOptionPane.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDATravelbugDetailMenu.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDATravelbugDetailMenu.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDATravelbugDetailMenu.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,188 @@
+package CacheWolf.view.pda;
+
+import CacheWolf.CacheDB;
+import CacheWolf.CacheHolder;
+import CacheWolf.CacheHolderDetail;
+import CacheWolf.Global;
+import CacheWolf.MyLocale;
+import CacheWolf.Travelbug;
+import CacheWolf.TravelbugJourney;
+import CacheWolf.imp.SpiderGC;
+import CacheWolf.utils.CWWrapper;
+import ewe.sys.Vm;
+
+public class PDATravelbugDetailMenu extends PDAMenu {
+
+	private static final String BROWSER = &quot;browser&quot;;
+
+	private static final String SPIDER = &quot;spider&quot;;
+
+	private static final String DELETE = &quot;delete&quot;;
+
+	private static final String EXIT = &quot;exit&quot;;
+
+	private static final String DROP = &quot;drop&quot;;
+
+	private PDATravelbugDetailPanel view;
+
+	private PDATravelbugJourneyScreen journeyScreen;
+
+	public PDATravelbugDetailMenu(PDATravelbugDetailPanel view, PDATravelbugJourneyScreen journeyScreen) {
+		this.view = view;
+		this.journeyScreen = journeyScreen;
+
+		setTitle(&quot;TravelBugDetail - Menu&quot;);
+
+		addMenuItem(MyLocale.getMsg(6041, &quot;Drop TB in cache&quot;), DROP);
+		addMenuItem(MyLocale.getMsg(6044, &quot;Get mission (and name)&quot;), SPIDER);
+		addMenuItem(MyLocale.getMsg(6045, &quot;Open on-line&quot;), BROWSER);
+		addMenuItem(MyLocale.getMsg(6043, &quot;Delete Travelbug&quot;), DELETE);
+		addMenuItem(MyLocale.getMsg(6061, &quot;Close&quot;), EXIT);
+
+		buildMenu();
+
+	}
+
+	public void actionPerformed(String action) {
+		if (action.equals(DROP)) {
+			Travelbug tb = view.getTravelbug().getTb();
+			int curCacheNo = Global.mainTab.tbP.getSelectedCache();
+			CacheDB cacheDB = Global.getProfile().cacheDB;
+			if (curCacheNo &gt;= 0 &amp;&amp; curCacheNo &lt; cacheDB.size()) {
+				CacheHolder ch = cacheDB.get(curCacheNo);
+				CacheHolderDetail cacheDetails = ch.getCacheDetails(true);
+				cacheDetails.Travelbugs.add(tb);
+				journeyScreen.model.allTravelbugJourneys.addTbDrop(tb, Global.getProfile().name, ch.getWayPoint());
+				ch.setHas_bugs(true);
+				ch.save();
+				//Set Input fields to the new Values:
+				view.getInpToWaypoint().setText(view.getTravelbug().getToWaypoint());
+				view.getInpToProfile().setText(view.getTravelbug().getToProfile());
+				view.getInpToDate().setText(view.getTravelbug().getToDate());
+				//Save now. The action won't recognize the changes:
+				journeyScreen.model.allTravelbugJourneys.saveTravelbugsFile();	
+			}
+			journeyScreen.setupTBButtons();
+			exit(0);
+		} else if (action.equals(BROWSER)) {
+			SpiderGC spider = new SpiderGC(Global.getPref(), Global.getProfile());
+			Vm.showWait(true);
+			// First check whether ID is set, if not get it
+			Travelbug tb = view.getTravelbug().getTb();
+			if (tb.getGuid().length() == 0) {
+				tb.setGuid(spider.getBugId(tb.getName()));
+			}
+			if (tb.getGuid().length() != 0) {
+				Vm.showWait(false);
+				try {
+					String s;
+					if (tb.getGuid().length() &gt; 10)
+						s = &quot;<A HREF="http://www.geocaching.com/track/details.aspx?guid=">http://www.geocaching.com/track/details.aspx?guid=</A>&quot; + tb.getGuid();
+					else
+						s = &quot;<A HREF="http://www.geocaching.com/track/details.aspx?id=">http://www.geocaching.com/track/details.aspx?id=</A>&quot; + tb.getGuid();
+
+					CWWrapper.exec(Global.getPref().browser, s);
+					Global.getPref().log(&quot;Executed: \&quot;&quot; + Global.getPref().browser + &quot;\&quot; \&quot;&quot; + s + &quot;\&quot;&quot;);
+				} catch (Exception ioex) {
+					Global.getPref().log(&quot;Ignored Exception&quot;, ioex, true);
+				}
+			}
+			exit(0);
+		} else if (action.equals(SPIDER)) {
+			Travelbug tb = view.getTravelbug().getTb();
+			SpiderGC spider = new SpiderGC(Global.getPref(), Global.getProfile());
+			Vm.showWait(true);
+
+			// if we have an ID, get mission by ID
+			if (tb.getGuid().length() != 0) {
+				tb.setMission(spider.getBugMissionByGuid(tb.getGuid()));
+			} else {
+				// try to get mission and name by tracking number
+				boolean suceeded = false;
+				if (tb.getTrackingNo().length() != 0) {
+					suceeded = spider.getBugMissionAndNameByTrackNr(tb);
+				}
+				// if this has't worked, try to get ID by name
+				if (!suceeded) {
+					tb.setGuid(spider.getBugId(tb.getName().trim()));
+					// if we have an ID now, get mission by ID
+					if (tb.getGuid().length() != 0) {
+						tb.setMission(spider.getBugMissionByGuid(tb.getGuid()));
+					}
+				}
+			}
+			journeyScreen.model.allTravelbugJourneys.saveTravelbugsFile();
+			Vm.showWait(false);
+			exit(0);
+		} else if (action.equals(DELETE)) {
+			// LOESCHEN DES TB's aus der Datenbank ist Boese!!!
+			// Erst mal eine Sicherheitesabfrage bauen:
+			int r = PDAOptionPane.showConfirmDialog(this.getFrame(), &quot;Sind Sie Sicher???&quot;,
+					&quot;Wollen Sie wirklich den TB l&#246;schen??&quot;);
+			if (r == PDAOptionPane.OK) {
+				for (int i = 0; i &lt; journeyScreen.model.allTravelbugJourneys.size(); i++) {
+					TravelbugJourney tbJourney =
+							journeyScreen.model.allTravelbugJourneys.getTBJourney(i);
+					if (tbJourney.getTb().getTrackingNo().equals(view.getTravelbug().getTb().getTrackingNo())) {
+						journeyScreen.model.allTravelbugJourneys.remove(i);
+						journeyScreen.model.allTravelbugJourneys.saveTravelbugsFile();
+						journeyScreen.setupTBButtons();
+						break;
+					}
+				}
+			}
+		} else if (action.equals(EXIT)) {
+			boolean changed = false;
+			if (!view.getInpName().text.equals(view.getTravelbug().getTb().getName())) {
+				view.getTravelbug().getTb().setName(view.getInpName().text);
+				changed = true;
+			}
+			if (!view.getInpTrackingNo().text.equals(view.getTravelbug().getTb().getTrackingNo())) {
+				view.getTravelbug().getTb().setTrackingNo(view.getInpTrackingNo().text);
+				changed = true;
+			}
+
+			if (!view.getInpFromProfile().text.equals(view.getTravelbug().getFromProfile())) {
+				view.getTravelbug().setFromProfile(view.getInpFromProfile().text);
+				changed = true;
+			}
+			if (!view.getInpFromWaypoint().text.equals(view.getTravelbug().getFromWaypoint())) {
+				view.getTravelbug().setFromWaypoint(view.getInpFromWaypoint().text);
+				changed = true;
+			}
+			if (!view.getInpFromDate().text.equals(view.getTravelbug().getFromDate())) {
+				view.getTravelbug().setFromDate(view.getInpFromDate().text);
+				changed = true;
+			}
+			if (view.getTravelbug().getFromLogged() != view.getChkFromLogged().state) {
+				view.getTravelbug().setFromLogged(view.getChkFromLogged().state);
+				changed = true;
+			}
+
+			if (!view.getInpToProfile().text.equals(view.getTravelbug().getToProfile())) {
+				view.getTravelbug().setToProfile(view.getInpToProfile().text);
+				changed = true;
+			}
+			if (!view.getInpToWaypoint().text.equals(view.getTravelbug().getToWaypoint())) {
+				view.getTravelbug().setToWaypoint(view.getInpToWaypoint().text);
+				changed = true;
+			}
+			if (!view.getInpToDate().text.equals(view.getTravelbug().getToDate())) {
+				view.getTravelbug().setToDate(view.getInpToDate().text);
+				changed = true;
+			}
+			if (view.getTravelbug().getToLogged() != view.getChkToLogged().state) {
+				view.getTravelbug().setToLogged(view.getChkToLogged().state);
+				changed = true;
+			}
+
+			if (changed) {
+				journeyScreen.model.allTravelbugJourneys.saveTravelbugsFile();
+				journeyScreen.createShowSet();
+			}
+
+			exit(1);
+		}
+	}
+
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDATravelbugDetailMenu.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDATravelbugDetailPanel.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDATravelbugDetailPanel.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDATravelbugDetailPanel.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,290 @@
+package CacheWolf.view.pda;
+
+import CacheWolf.MyLocale;
+import CacheWolf.Preferences;
+import CacheWolf.TravelbugJourney;
+import ewe.fx.Color;
+import ewe.fx.Dimension;
+import ewe.fx.Font;
+import ewe.fx.mImage;
+import ewe.sys.Convert;
+import ewe.sys.Time;
+import ewe.sys.Vm;
+import ewe.ui.CardPanel;
+import ewe.ui.CellConstants;
+import ewe.ui.CellPanel;
+import ewe.ui.ControlConstants;
+import ewe.ui.ControlEvent;
+import ewe.ui.Form;
+import ewe.ui.Gui;
+import ewe.ui.HtmlDisplay;
+import ewe.ui.SipButton;
+import ewe.ui.WindowConstants;
+import ewe.ui.mButton;
+import ewe.ui.mCheckBox;
+import ewe.ui.mInput;
+import ewe.ui.mLabel;
+
+public class PDATravelbugDetailPanel extends Form {
+
+	private static final String MENUE = &quot;MENUE&quot;;
+
+	private static final String BACK = &quot;back&quot;;
+
+	private static final String FORWARD = &quot;Vor&quot;;
+
+	private static final String FROM_DATE = &quot;from_date&quot;;
+
+	private static final String TO_DATE = &quot;to_date&quot;;
+
+	private TravelbugJourney travelbug;
+
+	public TravelbugJourney getTravelbug() {
+		return travelbug;
+	}
+
+	private CardPanel pnlTab;
+
+	private mInput inpName;
+
+	public mInput getInpName() {
+		return inpName;
+	}
+
+	private mInput inpTrackingNo;
+
+	public mInput getInpTrackingNo() {
+		return inpTrackingNo;
+	}
+
+	private mLabel lblId;
+
+	private mInput inpFromProfile;
+
+	public mInput getInpFromProfile() {
+		return inpFromProfile;
+	}
+
+	private mInput inpFromWaypoint;
+
+	public mInput getInpFromWaypoint() {
+		return inpFromWaypoint;
+	}
+
+	private mInput inpFromDate;
+
+	public mInput getInpFromDate() {
+		return inpFromDate;
+	}
+
+	private mButton btnFromDate;
+
+	private mCheckBox chkFromLogged;
+
+	public mCheckBox getChkFromLogged() {
+		return chkFromLogged;
+	}
+
+	private mInput inpToProfile;
+
+	public mInput getInpToProfile() {
+		return inpToProfile;
+	}
+
+	private mInput inpToWaypoint;
+
+	public mInput getInpToWaypoint() {
+		return inpToWaypoint;
+	}
+
+	private mInput inpToDate;
+
+	public mInput getInpToDate() {
+		return inpToDate;
+	}
+
+	private mButton btnToDate;
+
+	private mCheckBox chkToLogged;
+
+	public mCheckBox getChkToLogged() {
+		return chkToLogged;
+	}
+
+	private HtmlDisplay txtMission;
+
+	private PDATravelbugJourneyScreen view;
+
+	public PDATravelbugDetailPanel(TravelbugJourney tbJourney, PDATravelbugJourneyScreen view) {
+		SipButton.sipButtonSize = new Dimension(35, 40);
+		Vm.setSIP(Vm.SIP_LEAVE_BUTTON);
+		this.windowFlagsToSet = WindowConstants.FLAG_SHOW_SIP_BUTTON;
+		travelbug = tbJourney;
+		this.view = view;
+		setTitle(tbJourney.getTb().getName());
+
+		pnlTab = new CardPanel();
+		addLast(pnlTab);
+
+		// ------------------------------------------------
+		// First Tab - Name &amp; Tracking #
+		// ------------------------------------------------
+		CellPanel pnlName = new CellPanel();
+		CellPanel panel = new CellPanel();
+		panel.backGround = Color.White;
+		panel.addNext(new mLabel(MyLocale.getMsg(6025, &quot;Name:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		inpName = new mInput(tbJourney.getTb().getName());
+		inpName.backGround = Color.White;
+		inpName.borderStyle = BDR_OUTLINE | BF_LEFT | BF_TOP | BF_RIGHT | BF_SQUARE;
+		panel.addLast(inpName, HSTRETCH, HFILL);
+		panel.addNext(new mLabel(MyLocale.getMsg(6026, &quot;Tracking #:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		inpTrackingNo = new mInput(tbJourney.getTb().getTrackingNo());
+		inpTrackingNo.backGround = Color.White;
+		inpTrackingNo.borderStyle = BDR_OUTLINE | BF_LEFT | BF_TOP | BF_RIGHT | BF_SQUARE;
+		panel.addLast(inpTrackingNo, HSTRETCH, HFILL);
+		panel.addNext(new mLabel(MyLocale.getMsg(6027, &quot;ID/GUID:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		lblId = new mLabel(tbJourney.getTb().getGuid());
+		lblId.backGround = Color.White;
+		lblId.borderStyle = BDR_OUTLINE | BF_LEFT | BF_TOP | BF_RIGHT | BF_SQUARE;
+		panel.addLast(lblId, HSTRETCH, HFILL);
+		pnlName.addLast(panel, STRETCH, FILL);
+		// VON-Tab
+		mLabel label = new mLabel(MyLocale.getMsg(6058, &quot;Retrieved:&quot;));
+		Font tmpFont = new Font(&quot;Helvetica&quot;, Font.BOLD, Preferences.getPrefObject().fontSize * 2);
+		label.font = tmpFont;
+		panel.addLast(label, DONTSTRETCH, DONTFILL | WEST);
+		panel.addNext(new mLabel(MyLocale.getMsg(6029, &quot;Profile/Cache:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		inpFromProfile = new mInput(tbJourney.getFromProfile());
+		panel.addNext(inpFromProfile, HSTRETCH, HFILL);
+		inpFromWaypoint = new mInput(tbJourney.getFromWaypoint());
+		panel.addLast(inpFromWaypoint, HSTRETCH, HFILL);
+
+		panel.addNext(new mLabel(MyLocale.getMsg(6059, &quot;Date:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		inpFromDate = new mInput(tbJourney.getFromDate());
+		panel.addNext(inpFromDate, CellConstants.HSTRETCH, (CellConstants.HFILL | CellConstants.WEST));
+		btnFromDate = new mButton(new mImage(&quot;calendar.png&quot;));
+		btnFromDate.action = FROM_DATE;
+		panel.addLast(btnFromDate, DONTSTRETCH, HFILL | WEST);
+		btnFromDate.modify(0, ControlConstants.TakesKeyFocus);
+
+		panel.addNext(new mLabel(MyLocale.getMsg(6031, &quot;Logged:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		chkFromLogged = new mCheckBox(&quot;&quot;);
+		chkFromLogged.setState(tbJourney.getFromLogged());
+		panel.addLast(chkFromLogged, DONTSTRETCH, DONTFILL | WEST);
+		chkFromLogged.exitKeys = exitKeys;
+		// To-Tab
+		label = new mLabel(MyLocale.getMsg(6060, &quot;Dropped off:&quot;));
+		label.font = tmpFont;
+		panel.addLast(label, DONTSTRETCH, DONTFILL | WEST);
+		panel.addNext(new mLabel(MyLocale.getMsg(6029, &quot;Profile/Cache:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		inpToProfile = new mInput(tbJourney.getToProfile());
+		panel.addNext(inpToProfile, HSTRETCH, HFILL);
+		inpToWaypoint = new mInput(tbJourney.getToWaypoint());
+		panel.addLast(inpToWaypoint, HSTRETCH, HFILL);
+
+		panel.addNext(new mLabel(MyLocale.getMsg(6059, &quot;Date:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		inpToDate = new mInput(tbJourney.getToDate());
+		panel.addNext(inpToDate, CellConstants.HSTRETCH, (CellConstants.HFILL | CellConstants.WEST));
+		btnToDate = new mButton(new mImage(&quot;calendar.png&quot;));
+		btnToDate.action = TO_DATE;
+		panel.addLast(btnToDate, DONTSTRETCH, HFILL | WEST);
+		btnToDate.modify(0, ControlConstants.TakesKeyFocus);
+
+		panel.addNext(new mLabel(MyLocale.getMsg(6031, &quot;Logged:&quot;)), DONTSTRETCH, DONTFILL | WEST);
+		chkToLogged = new mCheckBox(&quot;&quot;);
+		chkToLogged.setState(tbJourney.getToLogged());
+		panel.addLast(chkToLogged, DONTSTRETCH, DONTFILL | WEST);
+		chkToLogged.exitKeys = exitKeys;
+
+		panel = new CellPanel();
+		PDAMenuButton pdaListButton = new PDAMenuButton(&quot;&lt;&lt;&lt;&quot;, BACK);
+		pdaListButton.change(ControlConstants.Disabled, 0);
+		panel.addNext(pdaListButton, HSTRETCH, HFILL);
+		panel.addNext(new PDAMenuButton(MyLocale.getMsg(6052, &quot;MENU&quot;), MENUE));
+		panel.addLast(new PDAMenuButton(&quot;&gt;&gt;&gt;&quot;, FORWARD), HSTRETCH, HFILL);
+		pnlName.addLast(panel, HSTRETCH, HFILL);
+
+		pnlTab.addItem(pnlName, MyLocale.getMsg(6028, &quot;Name&quot;), &quot;Name&quot;);
+
+		// ------------------------------------------------
+		// Last Panel - TB Mission
+		// ------------------------------------------------
+		CellPanel pnlDest = new CellPanel();
+		label = new mLabel(MyLocale.getMsg(6035, &quot;Mission:&quot;));
+		tmpFont = new Font(&quot;Helvetica&quot;, Font.BOLD, Preferences.getPrefObject().fontSize * 2);
+		label.setFont(tmpFont);
+		pnlDest.addLast(label, DONTSTRETCH, DONTFILL);
+		txtMission = new HtmlDisplay();
+		txtMission.setHtml(tbJourney.getTb().getMission());
+		pnlDest.addLast(txtMission, STRETCH, FILL);
+		txtMission.rows = 3;
+
+		panel = new CellPanel();
+		panel.addNext(new PDAMenuButton(&quot;&lt;&lt;&lt;&quot;, BACK), HSTRETCH, HFILL);
+		panel.addNext(new PDAMenuButton(MyLocale.getMsg(6052, &quot;MENU&quot;), MENUE));
+		pdaListButton = new PDAMenuButton(&quot;&gt;&gt;&gt;&quot;, &quot;&quot;);
+		pdaListButton.change(ControlConstants.Disabled, 0);
+		panel.addLast(pdaListButton, HSTRETCH, HFILL);
+		panel.backGround = new Color(250, 0, 0);
+		pnlDest.addLast(panel, DONTSTRETCH, FILL);
+		pnlTab.addItem(pnlDest, MyLocale.getMsg(6036, &quot;Mission&quot;), &quot;Mission&quot;);
+		SipButton.placeIn(this);
+		Gui.takeFocus(null, ControlConstants.ByKeyboard);
+	}
+
+	public void onControlEvent(ControlEvent paramEvent) {
+		switch (paramEvent.type) {
+		case ControlEvent.PRESSED:
+			String action = paramEvent.action;
+			if (action.equals(FORWARD)) {
+				pnlTab.select(pnlTab.getSelectedItem()+1);
+			} else if (action.equals(BACK)) {
+				pnlTab.select(pnlTab.getSelectedItem()-1);
+//				pnlTab.selectNextTab(false, true);
+			} else if (action.equals(MENUE)) {
+				PDATravelbugDetailMenu detailMenu = new PDATravelbugDetailMenu(this, view);
+				int execute = detailMenu.execute();
+				if (execute == 1){
+					exit(0);
+				}				
+			} else if (action.equals(FROM_DATE) || action.equals(TO_DATE)) {
+				mInput inpDate = action.equals(FROM_DATE) ? inpFromDate : inpToDate;
+				PDADateTimeChooser dc = new PDADateTimeChooser();
+				dc.setTitle(MyLocale.getMsg(328, &quot;Date found&quot;));
+				dc.setLocation(0, 0);
+//				dc.setPreferredSize(240, 240);
+				String foundDate = inpDate.getText();
+				Time t = new Time();
+				try {
+					t.parse(foundDate, &quot;y-M-d H:m&quot;);
+				} catch (IllegalArgumentException e) {
+					try {
+						t.parse(foundDate, &quot;y-M-d&quot;);
+					} catch (IllegalArgumentException e1) {
+						// Can't parse date - should not happen
+					}
+				}
+				dc.reset(t);
+				if (dc.execute() == ewe.ui.FormBase.IDOK) {
+					inpDate.setText(Convert.toString(dc.getYear ()) + &quot;-&quot; + MyLocale.formatLong(dc.getMonth (), &quot;00&quot;) + &quot;-&quot;
+							+ MyLocale.formatLong(dc.getDay(), &quot;00&quot;) + &quot; &quot; + dc.getTime() + &quot; &quot; + MyLocale.formatLong(dc.getHour(), &quot;00&quot;) +
+							&quot;:&quot;+MyLocale.formatLong(dc.getMinute(), &quot;00&quot;));
+				}
+			}
+		}
+	}
+
+	public void focusFirst(int paramInt) {
+		super.focusFirst(paramInt);
+		// Erst mal den Focus so setzen, dass die Tastatur nicht aufgeklappt
+		// wird.
+		// Wenn der TB noch nicht abgelegt wurde, dann den Focus auf den Button
+		// zum ablegen, sonst immer auf die Aufnahme
+		if (travelbug.getToDate().length() == 0 &amp;&amp; travelbug.getFromDate().length() &gt; 0) {
+			Gui.takeFocus(btnToDate, paramInt);
+
+		} else {
+			Gui.takeFocus(btnFromDate, paramInt);
+		}
+	}
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDATravelbugDetailPanel.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDATravelbugJourneyScreen.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDATravelbugJourneyScreen.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDATravelbugJourneyScreen.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,140 @@
+package CacheWolf.view.pda;
+
+import CacheWolf.MyLocale;
+import CacheWolf.TravelbugJourney;
+import CacheWolf.model.TravelBugScreenModel;
+import ewe.graphics.AniImage;
+import ewe.sys.Vm;
+import ewe.ui.CellConstants;
+import ewe.ui.ControlEvent;
+import ewe.ui.Form;
+
+public class PDATravelbugJourneyScreen extends Form {
+	private static final String LINE = &quot;Line&quot;;
+
+	private static final String NEXT_PAGE = &quot;NextPage&quot;;
+
+	private static final String PREV_PAGE = &quot;PrevPage&quot;;
+
+	private static final String MENUE = &quot;Menue&quot;;
+
+	PDAListButton[] listButtons;
+
+	TravelBugScreenModel model;
+	// public boolean onlyLogged = false;
+	// /**
+	// * List of all travelbugs in inventory
+	// */
+	// public TravelbugJourneyList myTravelbugJourneys;
+	//
+	// private Vector tbJourneysShowSet;
+	/**
+	 * The index of the first item in the list shown
+	 */
+	private int firstLine;
+
+	private final int linesOnScreen = 7;
+
+	/**
+	 * The six visible entries in the List
+	 */
+
+	public PDATravelbugJourneyScreen(TravelBugScreenModel travelbugModel) {
+		listButtons = new PDAListButton[linesOnScreen];
+		addListener(this);
+		setTitle(&quot;TravelBugs&quot;);
+
+		model = travelbugModel;
+
+		// backgroundImage = new Image(&quot;bug_vga.gif&quot;);
+		for (int i = 0; i &lt; model.allTravelbugJourneys.size(); i++) {
+			model.shownTravelbugJourneys.add(model.allTravelbugJourneys.getTBJourney(i));
+		}
+
+		firstLine = 0;
+		for (int i = 0; i &lt; linesOnScreen; i++) {
+			listButtons[i] = new PDAListButton(&quot;&quot;, LINE + i);
+			addLast(listButtons[i], CellConstants.STRETCH, CellConstants.FILL);
+		}
+		model.createShowSet();
+		setupTBButtons();
+		PDAMenuButton b1 = new PDAMenuButton(&quot;&lt;&lt;&lt;&quot;, PREV_PAGE);
+		addNext(b1, CellConstants.HSTRETCH, CellConstants.HFILL);
+		b1 = new PDAMenuButton(MyLocale.getMsg(6052, &quot;MENU&quot;), MENUE);
+		b1.anchor = 0;
+		addNext(b1, CellConstants.HSTRETCH, CellConstants.HFILL);
+		b1 = new PDAMenuButton(&quot;&gt;&gt;&gt;&quot;, NEXT_PAGE);
+		b1.anchor = CellConstants.EAST;
+		addLast(b1, CellConstants.HSTRETCH, CellConstants.HFILL);
+	}
+
+	public void onControlEvent(ControlEvent ev) {
+		if (ev instanceof ControlEvent) {
+			switch (ev.type) {
+			case ControlEvent.PRESSED:
+				if (ev.action.equals(NEXT_PAGE) &amp;&amp; model.shownTravelbugJourneys.size() &gt; firstLine + linesOnScreen) {
+					firstLine += linesOnScreen;
+					setupTBButtons();
+				} else if (ev.action.equals(PREV_PAGE) &amp;&amp; firstLine &gt; 0) {
+					firstLine -= linesOnScreen;
+					if (firstLine &lt; 0) {
+						firstLine = 0;
+					}
+					setupTBButtons();
+				} else if (ev.action.startsWith(LINE)) {
+					int line = ev.action.charAt(LINE.length()) - '0';
+					TravelbugJourney tbJourney = (TravelbugJourney) model.shownTravelbugJourneys.get(line + firstLine);
+					Form form = new PDATravelbugDetailPanel(tbJourney, this);
+					form.setPreferredSize(800, 600);
+					form.execute();
+					setupTBButtons();
+				} else if (ev.action.equals(MENUE)) {
+					Form form = new PDATravelbugMenuPanel(this);
+					form.setPreferredSize(800, 600);
+					int execute = form.execute();
+					if (execute == 1){
+						exit(0);
+					}
+					setupTBButtons();
+				}
+				break;
+			default:
+				super.onControlEvent(ev);
+			}
+		}
+	}
+
+	public void setupTBButtons() {
+		for (int i = 0; i &lt; linesOnScreen; i++) {
+			if (i + firstLine &lt; model.shownTravelbugJourneys.size()) {
+				TravelbugJourney tbJourney = (TravelbugJourney) model.shownTravelbugJourneys.get(i + firstLine);
+				String tbName = tbJourney.getTb().getName();
+				listButtons[i].text = tbName;
+				listButtons[i].fromText = tbJourney.getFromWaypoint() + '/' + tbJourney.getFromProfile();
+				listButtons[i].fromLogged = tbJourney.getFromLogged();
+				listButtons[i].toText = tbJourney.getToWaypoint() + '/' + tbJourney.getToProfile();
+				listButtons[i].toLogged = tbJourney.getToLogged();
+				listButtons[i].image = new AniImage(&quot;bug_vga.gif&quot;);
+			} else {
+				listButtons[i].text =
+						listButtons[i].fromText =
+								listButtons[i].toText = &quot;&quot;;
+				listButtons[i].toLogged =
+						listButtons[i].fromLogged = true;
+				listButtons[i].image = null;
+			}
+			listButtons[i].repaint();
+		}
+	}
+
+	public void toggleOnlyLogged() {
+		model.toggleOnlyLogged();
+		firstLine = 0;
+		setupTBButtons();
+	}
+
+	public void createShowSet() {
+		firstLine = 0;
+		model.createShowSet();
+	}
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDATravelbugJourneyScreen.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDATravelbugMenuPanel.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDATravelbugMenuPanel.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDATravelbugMenuPanel.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,101 @@
+package CacheWolf.view.pda;
+
+import CacheWolf.CacheDB;
+import CacheWolf.CacheHolder;
+import CacheWolf.CacheHolderDetail;
+import CacheWolf.Global;
+import CacheWolf.MyLocale;
+import CacheWolf.Travelbug;
+import CacheWolf.TravelbugJourney;
+import CacheWolf.TravelbugList;
+import CacheWolf.TravelbugPickup;
+import CacheWolf.view.ewe.TravelbugJourneyScreen;
+import ewe.fx.Dimension;
+
+public class PDATravelbugMenuPanel extends PDAMenu {
+
+	private static final String RETRIEVE = &quot;retrieve&quot;;
+	private static final String TOGGLE_LOG = &quot;toggle_log&quot;;
+	private static final String NEW_TB = &quot;new_tb&quot;;
+	private static final String EXPERT = &quot;expert_view&quot;;
+	private static final String SORT = &quot;sort&quot;;
+	private static final String EXIT = &quot;exit&quot;;
+	private PDATravelbugJourneyScreen view;
+
+	public PDATravelbugMenuPanel(PDATravelbugJourneyScreen view) {
+		this.view =view;
+		setTitle(MyLocale.getMsg(6053, &quot;Travelbug - Menu&quot;));
+
+		addMenuItem(view.model.onlyLogged ? MyLocale.getMsg(6054, &quot;Show all&quot;) : MyLocale.getMsg(6046, &quot;Show only not logged&quot;),
+				TOGGLE_LOG);
+		addMenuItem(MyLocale.getMsg(6055, &quot;Sort ...&quot;), SORT);
+		addMenuItem(MyLocale.getMsg(6042, &quot;New Travelbug&quot;), NEW_TB);
+		addMenuItem(MyLocale.getMsg(6040, &quot;Pick up TB from current cache&quot;), RETRIEVE);
+		addMenuItem(MyLocale.getMsg(6056, &quot;Expertview&quot;), EXPERT);
+		addMenuItem(MyLocale.getMsg(6061, &quot;Close&quot;), EXIT);
+		buildMenu ();
+	}
+
+	public void actionPerformed(String actionCommand) {
+		if (actionCommand.equals(RETRIEVE)) {
+			int curCacheNo = Global.mainTab.tbP.getSelectedCache();
+			CacheDB cacheDB = Global.getProfile().cacheDB;
+			if (curCacheNo &gt;= 0 &amp;&amp; curCacheNo &lt; cacheDB.size()) {
+				CacheHolder ch = cacheDB.get(curCacheNo);
+				String waypoint = ch.getWayPoint();
+				TravelbugList tblSrcCache = ch.getCacheDetails(true).Travelbugs;
+
+				Travelbug tb = TravelbugPickup.pickupTravelbug(tblSrcCache);
+				if (tb != null) {
+					view.model.allTravelbugJourneys.addTbPickup(tb, Global.getProfile().name, waypoint);
+					CacheHolderDetail cacheDetails = ch.getCacheDetails(true);
+					ch.setHas_bugs(cacheDetails.Travelbugs.size() &gt; 0);
+					ch.save();
+					view.model.allTravelbugJourneys.saveTravelbugsFile();
+				}
+			}
+			view.createShowSet();
+			view.setupTBButtons();
+			exit(0);
+		} else if (actionCommand.equals(TOGGLE_LOG)) {
+			view.toggleOnlyLogged();
+			exit(0);
+		} else if (actionCommand.equals(EXPERT)) {
+			TravelbugJourneyScreen travelbugJourneyScreen = new TravelbugJourneyScreen(view.model);
+			Dimension arg0 = new Dimension();
+			getSize(arg0);
+			travelbugJourneyScreen.setPreferredSize(arg0.width, arg0.height);
+			travelbugJourneyScreen.execute();
+			exit(0);
+			view.exit(0);
+		} else if (actionCommand.equals(NEW_TB)) {
+			int curCacheNo = Global.mainTab.tbP.getSelectedCache();
+			CacheDB cacheDB = Global.getProfile().cacheDB;
+			CacheHolder ch = cacheDB.get(curCacheNo);
+			TravelbugJourney tbj = new TravelbugJourney(&quot;New&quot;);
+			tbj.setFromProfile(Global.getProfile().name);
+			tbj.setFromWaypoint(&quot;&quot;);
+			tbj.setFromLogged(true);
+			view.model.allTravelbugJourneys.add(tbj);
+			CacheHolderDetail cacheDetails = ch.getCacheDetails(true);
+			ch.setHas_bugs(cacheDetails.Travelbugs.size() &gt; 0);
+			ch.save();
+			view.model.allTravelbugJourneys.saveTravelbugsFile();
+			view.createShowSet();
+			view.setupTBButtons();
+			exit(0);
+		} else if (actionCommand.equals(SORT)) {
+			PDATravelbugSortMenu sortMenu = new PDATravelbugSortMenu();
+			sortMenu.execute();
+			if (sortMenu.sortColumn &gt; 0) {
+				view.model.allTravelbugJourneys.sort(sortMenu.sortColumn, sortMenu.ascending);
+				view.createShowSet();
+				view.setupTBButtons();
+			}
+			exit(0);
+		} else if (actionCommand.equals(EXIT)){
+			exit(1);
+		}
+	}
+
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDATravelbugMenuPanel.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain

Added: trunk/src/CacheWolf/view/pda/PDATravelbugSortMenu.java
===================================================================
--- trunk/src/CacheWolf/view/pda/PDATravelbugSortMenu.java	                        (rev 0)
+++ trunk/src/CacheWolf/view/pda/PDATravelbugSortMenu.java	2011-04-23 12:28:54 UTC (rev 2989)
@@ -0,0 +1,86 @@
+package CacheWolf.view.pda;
+
+import CacheWolf.MyLocale;
+import ewe.fx.Rect;
+import ewe.ui.Window;
+
+public class PDATravelbugSortMenu extends PDAMenu {
+	private static final String NAME = &quot;name&quot;;
+	private static final String FROM_WP = &quot;from_wp&quot;;
+	private static final String FROM_DATE = &quot;from_date&quot;;
+	private static final String TO_WP = &quot;to_wp&quot;;
+	private static final String TO_DATE = &quot;to_date&quot;;
+	private static final String TRACK_NR = &quot;track_nw&quot;;
+	private static final String EXIT = &quot;exit&quot;;
+	public int sortColumn = -1;
+	public boolean ascending = true;
+
+	public PDATravelbugSortMenu() {
+		super();
+		PDAMenuButton button = new PDAMenuButton(MyLocale.getMsg(6028, &quot;Name&quot;), NAME);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;^^&quot;, NAME + &quot;_UP&quot;);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;vv&quot;, NAME + &quot;_DOWN&quot;);
+		addLast(button, HSTRETCH, HFILL);
+
+		button = new PDAMenuButton(MyLocale.getMsg(6005, &quot;From Wpt&quot;), FROM_WP);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;^^&quot;, FROM_WP + &quot;_UP&quot;);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;vv&quot;, FROM_WP + &quot;_DOWN&quot;);
+		addLast(button, HSTRETCH, HFILL);
+
+		button = new PDAMenuButton(MyLocale.getMsg(6006, &quot;From Date&quot;), FROM_DATE);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;^^&quot;, FROM_DATE + &quot;_UP&quot;);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;vv&quot;, FROM_DATE + &quot;_DOWN&quot;);
+		addLast(button, HSTRETCH, HFILL);
+
+		button = new PDAMenuButton(MyLocale.getMsg(6009, &quot;To Wpt&quot;), TO_WP);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;^^&quot;, TO_WP + &quot;_UP&quot;);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;vv&quot;, TO_WP + &quot;_DOWN&quot;);
+		addLast(button, HSTRETCH, HFILL);
+
+		button = new PDAMenuButton(MyLocale.getMsg(6010, &quot;To Date&quot;), TO_DATE);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;^^&quot;, TO_DATE + &quot;_UP&quot;);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;vv&quot;, TO_DATE + &quot;_DOWN&quot;);
+		addLast(button, HSTRETCH, HFILL);
+
+		button = new PDAMenuButton(MyLocale.getMsg(6062, &quot;Track-No&quot;), TRACK_NR);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;^^&quot;, TRACK_NR + &quot;_UP&quot;);
+		addNext(button, HSTRETCH, HFILL);
+		button = new PDAMenuButton(&quot;vv&quot;, TRACK_NR + &quot;_DOWN&quot;);
+		addLast(button, HSTRETCH, HFILL);
+
+		button = new PDAMenuButton(MyLocale.getMsg(6057, &quot;Back&quot;), EXIT);
+		addLast(button);
+
+		Rect s = (Rect) Window.getGuiInfo(Window.INFO_SCREEN_RECT, null, new Rect(), 0);
+		setPreferredSize(s.width, s.height);
+	}
+
+	public void actionPerformed(String actionCommand) {
+		if (actionCommand.startsWith(NAME)) {
+			sortColumn = 1;
+		} else if (actionCommand.startsWith(FROM_WP)) {
+			sortColumn = 5;
+		} else if (actionCommand.startsWith(FROM_DATE)) {
+			sortColumn = 6;
+		} else if (actionCommand.startsWith(TO_WP)) {
+			sortColumn = 9;
+		} else if (actionCommand.startsWith(TO_DATE)) {
+			sortColumn = 10;
+		} else if (actionCommand.startsWith(TRACK_NR)) {
+			sortColumn = 2;
+		}
+		ascending = actionCommand.endsWith(&quot;DOWN&quot;);
+		exit(0);
+	}
+}


Property changes on: trunk/src/CacheWolf/view/pda/PDATravelbugSortMenu.java
___________________________________________________________________
Added: svn:mime-type
   + text/plain


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002979.html">[Cachewolf-svn] r2988 - in trunk/src/CacheWolf: . model view
</A></li>
	<LI>Next message: <A HREF="002981.html">[Cachewolf-svn] r2990 - trunk/src/CacheWolf/view
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2980">[ date ]</a>
              <a href="thread.html#2980">[ thread ]</a>
              <a href="subject.html#2980">[ subject ]</a>
              <a href="author.html#2980">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
