<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r2983 - in trunk: res_noewe/webmapservices	src/CacheWolf/imp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2011-April/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2983%20-%20in%20trunk%3A%20res_noewe/webmapservices%0A%09src/CacheWolf/imp&In-Reply-To=%3C20110419135921.0D05D481482%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002973.html">
   <LINK REL="Next"  HREF="002977.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r2983 - in trunk: res_noewe/webmapservices	src/CacheWolf/imp</H1>
    <B>araber95 at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2983%20-%20in%20trunk%3A%20res_noewe/webmapservices%0A%09src/CacheWolf/imp&In-Reply-To=%3C20110419135921.0D05D481482%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r2983 - in trunk: res_noewe/webmapservices	src/CacheWolf/imp">araber95 at mail.berlios.de
       </A><BR>
    <I>Tue Apr 19 03:59:20 CEST 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="002973.html">[Cachewolf-svn] r2982 - trunk/res_noewe/webmapservices
</A></li>
        <LI>Next message: <A HREF="002977.html">[Cachewolf-svn] r2986 - trunk/res_noewe/webmapservices
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2974">[ date ]</a>
              <a href="thread.html#2974">[ thread ]</a>
              <a href="subject.html#2974">[ subject ]</a>
              <a href="author.html#2974">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: araber95
Date: 2011-04-19 15:59:20 +0200 (Tue, 19 Apr 2011)
New Revision: 2983

Modified:
   trunk/res_noewe/webmapservices/us_p.wms
   trunk/src/CacheWolf/imp/OCXMLImporter.java
Log:
1. update us photo with new wms-server
2. OC Import: Handling Status on Update as in gpx-Import (until OC changes gpx export)

Modified: trunk/res_noewe/webmapservices/us_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/us_p.wms	2011-04-16 15:09:59 UTC (rev 2982)
+++ trunk/res_noewe/webmapservices/us_p.wms	2011-04-19 13:59:20 UTC (rev 2983)
@@ -1,22 +1,21 @@
-TakenFromUrl:       <A HREF="http://terraservice.net/">http://terraservice.net/</A>
-GetCapabilitiesUrl: <A HREF="http://terraservice.net/ogccapabilities.ashx?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetCapabilities">http://terraservice.net/ogccapabilities.ashx?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetCapabilities</A>
-Name:               USA photo
+TakenFromUrl:       <A HREF="http://igskmncngs617.cr.usgs.gov/arcgis/services/baseline/ImageServer/WMSServer">http://igskmncngs617.cr.usgs.gov/arcgis/services/baseline/ImageServer/WMSServer</A>
+GetCapabilitiesUrl: <A HREF="http://isse.cr.usgs.gov/ArcGIS/services/Baseline/ImageServer/WMSServer?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetCapabilities">http://isse.cr.usgs.gov/ArcGIS/services/Baseline/ImageServer/WMSServer?SERVICE=WMS&amp;VERSION=1.1.1&amp;REQUEST=GetCapabilities</A>
+Name:               us p
 MapType:                        photo
-MainUrl:            <A HREF="http://terraservice.net/ogcwms.aspx?">http://terraservice.net/ogcwms.aspx?</A>
+MainUrl:            <A HREF="http://isse.cr.usgs.gov/ArcGIS/services/Baseline/ImageServer/WMSServer?">http://isse.cr.usgs.gov/ArcGIS/services/Baseline/ImageServer/WMSServer?</A>
 ServiceTypeUrlPart: SERVICE=WMS
 VersionUrlPart:     VERSION=1.1.1
 CoordinateReferenceSystemCacheWolf:  4326
 CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
 RequestUrlPart:     REQUEST=GetMap
-#LayersUrlPart:     LAYERS=DOQ|USGS Digital Ortho-Quadrangles||
-#LayersUrlPart:     LAYERS=DRG|USGS Raster Graphics (Topo Maps)||
-#LayersUrlPart:     LAYERS=UrbanArea|USGS Urban Areas Ortho-Imagery||
-LayersUrlPart:     LAYERS=DOQ
+#LayersUrlPart:     LAYERS=0|IGSKMNCNGS617/baseline||
+LayersUrlPart:     LAYERS=0
 StylesUrlPart:     STYLES=
-ImageFormatUrlPart:FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84: N 71.5500 W 168.6700
-BoundingBoxBottomRightWGS84: N 17.8400 W 65.1500
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 81.9971 W 170.9250
+BoundingBoxBottomRightWGS84: N 6.2961 W 50.8429
+#BBox_Mitte: N 44.146614 W 110.883977
 MinScale:   0
-MaxScale:   45
-RecommendedScale:   5
-ImageFileExtension: .jpg
+MaxScale:   20
+RecommendedScale:    1 0.75 2
+ImageFileExtension: .png

Modified: trunk/src/CacheWolf/imp/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/imp/OCXMLImporter.java	2011-04-16 15:09:59 UTC (rev 2982)
+++ trunk/src/CacheWolf/imp/OCXMLImporter.java	2011-04-19 13:59:20 UTC (rev 2983)
@@ -203,12 +203,12 @@
 		String finalMessage;
 
 		String lastS =  profile.getLast_sync_opencaching();
-		CWPoint centre = pref.getCurCentrePt(); // No need to clone curCentrePt as centre is only read
+		final CWPoint centre = pref.getCurCentrePt(); // No need to clone curCentrePt as centre is only read
 		if (!centre.isValid()) {
 			(new MessageBox(&quot;Error&quot;, &quot;Coordinates for centre must be set&quot;, FormBase.OKB)).execute();
 			return;
 		}
-		OCXMLImporterScreen importOpt = new OCXMLImporterScreen(
+		final OCXMLImporterScreen importOpt = new OCXMLImporterScreen(
 				MyLocale.getMsg(130,&quot;Download from opencaching&quot;),
 				OCXMLImporterScreen.ALL |
 				OCXMLImporterScreen.DIST |
@@ -226,7 +226,7 @@
 
 		if (dist.length()== 0) return;
 
-		Double distDouble = new Double();
+		final Double distDouble = new Double();
 		distDouble.value = Common.parseDouble(dist);
 		dist = distDouble.toString(0, 1, 0).replace(',', '.');
 		//check, if distance is greater than before
@@ -294,7 +294,7 @@
 		String finalMessage = &quot;&quot;;
 		try{
 			holder = null;
-			String target = profile.dataDir + &quot;dummy.zip&quot;;
+			final String target = profile.dataDir + &quot;dummy.zip&quot;;
 			UrlFetcher.fetchDataFile(address, target);
 
 			//parse
@@ -303,9 +303,9 @@
 				throw new IOException(&quot;no updates available&quot;);
 			}
 
-			ZipFile zif = new ZipFile (target);
+			final ZipFile zif = new ZipFile (target);
 			ZipEntry zipEnt;
-			Enumeration zipEnum = zif.entries();
+			final Enumeration zipEnum = zif.entries();
 			inf.setInfo(&quot;...unzipping update file&quot;);
 			while (zipEnum.hasMoreElements())
 			{
@@ -318,10 +318,10 @@
 				}
 			}
 			zif.close();
-		}catch (ZipException e){
+		}catch (final ZipException e){
 			finalMessage = MyLocale.getMsg(1614,&quot;Error while unzipping udpate file&quot;);
 			success = false;
-		}catch (IOException e){
+		}catch (final IOException e){
 			if (e.getMessage().equalsIgnoreCase(&quot;no updates available&quot;)) { finalMessage = &quot;No updates available&quot;; success = false; }
 			else {
 				if (e.getMessage().equalsIgnoreCase(&quot;could not connect&quot;) ||
@@ -330,11 +330,11 @@
 				} else { finalMessage = &quot;IOException: &quot;+e.getMessage(); }
 				success = false;
 			}
-		}catch (IllegalArgumentException e) {
+		}catch (final IllegalArgumentException e) {
 			finalMessage = MyLocale.getMsg(1621,&quot;Error parsing update file\n this is likely a bug in &quot; + hostname + &quot;\nplease try again later\n, state:&quot;)+&quot; &quot;+state+&quot;, waypoint: &quot;+ holder.getWayPoint();
 			success = false;
 			pref.log(&quot;Parse error: &quot; + state + &quot; &quot; + holder.getWayPoint(),e,true);
-		}catch (Exception e){ // here should be used the correct exception
+		}catch (final Exception e){ // here should be used the correct exception
 			if (holder != null)	finalMessage = MyLocale.getMsg(1615,&quot;Error parsing update file, state:&quot;)+&quot; &quot;+state+&quot;, waypoint: &quot;+ holder.getWayPoint();
 			else finalMessage = MyLocale.getMsg(1615,&quot;Error parsing update file, state:&quot;)+&quot; &quot;+state+&quot;, waypoint: &lt;unkown&gt;&quot;;
 			success = false;
@@ -363,10 +363,10 @@
 		strData =&quot;&quot;;
 
 		if (name.equals(&quot;oc11xml&quot;)){
-			Time lastSync = new Time();
+			final Time lastSync = new Time();
 			try {
 				lastSync.parse(atts.getValue(&quot;date&quot;),&quot;yyyy-MM-dd HH:mm:ss&quot;);
-			}catch (IllegalArgumentException e){
+			}catch (final IllegalArgumentException e){
 				pref.log(&quot;&quot;,e,true);
 			}
 			// reduce time at 1 second to avoid sync problems
@@ -409,7 +409,7 @@
 	}
 
 	public void characters(char[] ch2,int start,int length){
-		String chars = new String(ch2,start,length);
+		final String chars = new String(ch2,start,length);
 		strData += chars;
 		if (debugGPX) pref.log(strData,null);
 	}
@@ -437,13 +437,23 @@
 			//  are there more ? ;
 			if (atts.getValue(&quot;id&quot;).equals(&quot;1&quot;)) {
 				holder.setAvailable(true);
+				holder.setArchived(false);
 			} else {
 				holder.setAvailable(false);
 				if( (atts.getValue(&quot;id&quot;).equals(&quot;3&quot;)) || (atts.getValue(&quot;id&quot;).equals(&quot;6&quot;))|| (atts.getValue(&quot;id&quot;).equals(&quot;7&quot;)) ) {
 					if (!isSyncSingle) {
-						holder=null; // holder.setArchived(true);
+						holder=null;
 						numCacheImported--;
 					}
+					else {
+						// Umsetzung wie in gpx f&#252;r Status 6
+						if (atts.getValue(&quot;id&quot;).equals(&quot;6&quot;)) {
+							holder.setArchived(false);
+						}
+						else {
+							holder.setArchived(true);
+						}
+					}
 				}
 			}
 			return;
@@ -455,7 +465,7 @@
 
 		if(name.equals(&quot;waypoints&quot;)){
 			holder.setWayPoint(atts.getValue(&quot;oc&quot;));
-			String CName = atts.getValue(&quot;nccom&quot;) + &quot; &quot; + atts.getValue(&quot;gccom&quot;);
+			final String CName = atts.getValue(&quot;nccom&quot;) + &quot; &quot; + atts.getValue(&quot;gccom&quot;);
 			if (!CName.equals(&quot; &quot;)) {
 				holder.setCacheOwner(holder.getCacheOwner() + &quot; / &quot; + CName.trim());
 				holder.getCacheDetails(false).attributes.add(7); // wwwlink
@@ -468,9 +478,9 @@
 			if (holder.getWayPoint().length()==0) throw new IllegalArgumentException(&quot;empty waypointname&quot;); // this should not happen - it is likey a bug in opencaching / it happens on 27-12-2006 on cache OC143E
 			return;
 		}
-		
+
 		if (name.equals(&quot;attribute&quot;)) {
-			int id = Integer.parseInt(atts.getValue(&quot;id&quot;));
+			final int id = Integer.parseInt(atts.getValue(&quot;id&quot;));
 			holder.getCacheDetails(false).attributes.add(id);
 			holder.setAttribsAsBits(holder.getCacheDetails(false).attributes.getAttribsAsBits());
 			return;
@@ -511,18 +521,18 @@
 		if (holder==null) return;
 
 		inf.setInfo(MyLocale.getMsg(1612,&quot;Importing Cachlog:&quot;)+&quot; &quot; + numLogImported);
-		
+
 		if (name.equals(&quot;logtype&quot;)){
 			logtype = Convert.toInt(atts.getValue(&quot;id&quot;));
 			switch (logtype) {
 			case 1:
 				logIcon = Log.typeText2Image(&quot;Found&quot;);
 				break;
-			case 2:	
+			case 2:
 				logIcon = Log.typeText2Image(&quot;Not Found&quot;);
 				holder.setNoFindLogs((byte)(holder.getNoFindLogs()+1));
 				break;
-			case 3: 
+			case 3:
 				logIcon = Log.typeText2Image(&quot;Note&quot;);
 			}
 			loggerRecommended = atts.getValue(&quot;recommended&quot;).equals(&quot;1&quot;);
@@ -542,7 +552,7 @@
 		if(name.equals(&quot;id&quot;)){ // &lt;/id&gt;
 			// the guid (=strData) is not part of gpx , so we use id of cacheID
 			holder = getHolder(cacheID, true); // Allocate a new CacheHolder object
-			holder.setOcCacheID(cacheID); 
+			holder.setOcCacheID(cacheID);
 			holder.getCacheDetails(false).URL = &quot;<A HREF="http://">http://</A>&quot; + hostname + &quot;/viewcache.php?cacheid=&quot; + cacheID;
 			return;
 		}
@@ -634,7 +644,7 @@
 
 			if (isHTML)	linebraek = &quot;&lt;br&gt;\n&quot;;
 			else 					linebraek = &quot;\n&quot;;
-			
+
 			     // this is set by &quot;hint&quot; a few lines down: if a long description is already updated, then this one is likely to be in another language
 			if (holder.is_updated())	holder.getCacheDetails(false).LongDescription += linebraek + processingDescLang + &quot;:&quot; +  linebraek + strData  +  linebraek;
 			else 					 	holder.getCacheDetails(false).LongDescription =              processingDescLang + &quot;:&quot; +  linebraek + strData  +  linebraek;
@@ -664,7 +674,7 @@
 				numLogImported++;
 				holder.getCacheDetails(false).hasUnsavedChanges = true; //chD.saveCacheDetails(profile.dataDir);
 			}
-			// 
+			//
 			if((logFinder.toLowerCase().compareTo(user) == 0 || logFinder.equalsIgnoreCase(pref.myAlias2)) &amp;&amp; logtype == 1) {
 				if (incFinds || !holder.is_new()) {
 					// aber vorhandene werden mit gefunden aktualisiert
@@ -678,7 +688,7 @@
 					cacheDB.removeElementAt(cacheDB.getIndex(holder));
 					DBindexID.remove(holder.GetCacheID());
 					// und Dateien l&#246;schen?
-					File tmpFile = new File(profile.dataDir + holder.getWayPoint()+&quot;.xml&quot;);
+					final File tmpFile = new File(profile.dataDir + holder.getWayPoint()+&quot;.xml&quot;);
 					tmpFile.delete();
 					// todo: was ist mit den schon heruntergeladenen Bildern?
 				}
@@ -720,7 +730,7 @@
 		if(name.equals(&quot;picture&quot;)){
 			inf.setInfo(MyLocale.getMsg(1613,&quot;Pictures:&quot;)+&quot; &quot; + ++picCnt);
 			//String fileName = holder.wayPoint + &quot;_&quot; + picUrl.substring(picUrl.lastIndexOf(&quot;/&quot;)+1);
-			ImageInfo ii = new ImageInfo();
+			final ImageInfo ii = new ImageInfo();
 			ii.setTitle(picTitle);
 			ii.setURL(picUrl);
 			getPic(ii);
@@ -732,7 +742,7 @@
 	private CacheHolder getHolder(String guid, boolean create){// See also LOCXMLImporter
 		CacheHolder ch = null;
 		//Integer INTR = (Integer)DBindexID.get(guid);
-		String wp = (String)DBindexID.get(guid);
+		final String wp = (String)DBindexID.get(guid);
 		//if(INTR != null){
 		if(wp != null){
 			//ch = cacheDB.get(INTR.intValue());
@@ -743,13 +753,13 @@
 		return ch;
 	}
 
-	
+
 	private void getImageNamesFromDescription() {
 		String fetchUrl;
 		String imgTag;
 		String imgAltText;
-		Regex imgRegexUrl = new Regex(&quot;(&lt;img[^&gt;]*src=[\&quot;\']([^&gt;^\&quot;^\']*)[^&gt;]*&gt;|&lt;img[^&gt;]*src=([^&gt;^\&quot;^\'^ ]*)[^&gt;]*&gt;)&quot;); //  Ergebnis enthlt keine Anfhrungszeichen
-		Regex imgRegexAlt = new Regex(&quot;(?:alt=[\&quot;\']([^&gt;^\&quot;^\']*)|alt=([^&gt;^\&quot;^\'^ ]*))&quot;); // get alternative text for Pic
+		final Regex imgRegexUrl = new Regex(&quot;(&lt;img[^&gt;]*src=[\&quot;\']([^&gt;^\&quot;^\']*)[^&gt;]*&gt;|&lt;img[^&gt;]*src=([^&gt;^\&quot;^\'^ ]*)[^&gt;]*&gt;)&quot;); //  Ergebnis enthlt keine Anfhrungszeichen
+		final Regex imgRegexAlt = new Regex(&quot;(?:alt=[\&quot;\']([^&gt;^\&quot;^\']*)|alt=([^&gt;^\&quot;^\'^ ]*))&quot;); // get alternative text for Pic
 		imgRegexAlt.setIgnoreCase(true);
 		imgRegexUrl.setIgnoreCase(true);
 		int descIndex=0;
@@ -779,23 +789,23 @@
 				if (!fetchUrl.startsWith(&quot;<A HREF="http://">http://</A>&quot;)) {
 					fetchUrl = new URL(new URL(&quot;<A HREF="http://">http://</A>&quot; + hostname+&quot;/&quot;), fetchUrl).toString();
 				}
-			} catch (MalformedURLException e) {			
-				String ErrMessage = MyLocale.getMsg(1618,&quot;Ignoring error in cache: &quot;) + holder.getWayPoint() + &quot;: ignoring MalformedUrlException: &quot; + e.getMessage()+ &quot; while downloading from URL:&quot; + fetchUrl;
+			} catch (final MalformedURLException e) {
+				final String ErrMessage = MyLocale.getMsg(1618,&quot;Ignoring error in cache: &quot;) + holder.getWayPoint() + &quot;: ignoring MalformedUrlException: &quot; + e.getMessage()+ &quot; while downloading from URL:&quot; + fetchUrl;
 				inf.addWarning(&quot;\n&quot;+ErrMessage);
 				pref.log(ErrMessage,e);
 			}
-			ImageInfo imageInfo = new ImageInfo();
+			final ImageInfo imageInfo = new ImageInfo();
 			imageInfo.setURL(fetchUrl);
 			imageInfo.setTitle(imgAltText);
 			getPic(imageInfo);
 		}
 	}
 
-	
-	private void getPic(ImageInfo imageInfo) { // TODO handling of relativ URLs		
+
+	private void getPic(ImageInfo imageInfo) { // TODO handling of relativ URLs
 		String fileName = holder.getWayPoint() + &quot;_&quot; + imageInfo.getURL().substring(imageInfo.getURL().lastIndexOf('/')+1);
 		fileName = Common.ClearForFileName(fileName).toLowerCase();
-		String target = profile.dataDir + fileName;
+		final String target = profile.dataDir + fileName;
 		imageInfo.setFilename(fileName);
 		try {
 			File ftest = new FileBugfix(target);
@@ -817,7 +827,7 @@
 					}
 				}
 			}
-		} catch (IOException e) {
+		} catch (final IOException e) {
 			String ErrMessage;
 			String wp, n;
 			if (holder != null &amp;&amp; holder.getWayPoint() != null) wp = holder.getWayPoint();
@@ -839,5 +849,5 @@
 		}
 
 	}
-	
+
 }


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002973.html">[Cachewolf-svn] r2982 - trunk/res_noewe/webmapservices
</A></li>
	<LI>Next message: <A HREF="002977.html">[Cachewolf-svn] r2986 - trunk/res_noewe/webmapservices
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2974">[ date ]</a>
              <a href="thread.html#2974">[ thread ]</a>
              <a href="subject.html#2974">[ subject ]</a>
              <a href="author.html#2974">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
