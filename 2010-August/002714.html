<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r2726 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/imp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2010-August/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2726%20-%20in%20trunk%3A%20res_noewe/languages%20src/CacheWolf%0A%09src/CacheWolf/imp&In-Reply-To=%3C20100808192255.66BAD480964%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002713.html">
   <LINK REL="Next"  HREF="002715.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r2726 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/imp</H1>
    <B>araber95 at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2726%20-%20in%20trunk%3A%20res_noewe/languages%20src/CacheWolf%0A%09src/CacheWolf/imp&In-Reply-To=%3C20100808192255.66BAD480964%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r2726 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/imp">araber95 at mail.berlios.de
       </A><BR>
    <I>Sun Aug  8 09:22:55 CEST 2010</I>
    <P><UL>
        <LI>Previous message: <A HREF="002713.html">[Cachewolf-svn] r2725 - trunk
</A></li>
        <LI>Next message: <A HREF="002715.html">[Cachewolf-svn] r2727 - in trunk: . res_noewe/webmapservices	src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2714">[ date ]</a>
              <a href="thread.html#2714">[ thread ]</a>
              <a href="subject.html#2714">[ subject ]</a>
              <a href="author.html#2714">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: araber95
Date: 2010-08-08 21:22:55 +0200 (Sun, 08 Aug 2010)
New Revision: 2726

Added:
   trunk/src/CacheWolf/imp/GCVoteImporter.java
Removed:
   trunk/src/CacheWolf/imp/Rating.java
Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/res_noewe/languages/PL.cfg
   trunk/res_noewe/languages/SV.cfg
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/Preferences.java
Log:
new rater : menu under import

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/res_noewe/languages/DE.cfg	2010-08-08 19:22:55 UTC (rev 2726)
@@ -446,6 +446,7 @@
 		1205=L%f6ser
 		1206=Rechner
 		1207=%c4nderungen im Profil Speichern?
+		1208=Bewertungen von gcvote
 		1300=Letzte Einstellung
 		1301=Profil ausw%e4hlen:
 		1400=Zone

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/res_noewe/languages/EN.cfg	2010-08-08 19:22:55 UTC (rev 2726)
@@ -446,6 +446,7 @@
 		1205=Solver
 		1206=Calc
 		1207=Your profile has unsaved changes. Do you want to save?
+		1208=ratings from GCVote
 		1300=Last Setting
 		1301=Select Profile:
 		1400=Zone

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/res_noewe/languages/FR.cfg	2010-08-08 19:22:55 UTC (rev 2726)
@@ -446,6 +446,7 @@
 		1205=Resoudeur
 		1206=Ordinateur
 		1207=Sauvegarder les changements dans le profil?
+		1208=ratings from GCVote
 		1300=Dernier param%e8tage
 		1301=Choisir profil:
 		1400=Zone

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/res_noewe/languages/NL.cfg	2010-08-08 19:22:55 UTC (rev 2726)
@@ -446,6 +446,7 @@
 		1205=Oplosser
 		1206=Calculator
 		1207=Jouw profiel is veranderd, wil je het profiel opslaan?
+		1208=ratings from GCVote
 		1300=Laatste instellingen
 		1301=Selecteer profiel
 		1400=Zone

Modified: trunk/res_noewe/languages/PL.cfg
===================================================================
--- trunk/res_noewe/languages/PL.cfg	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/res_noewe/languages/PL.cfg	2010-08-08 19:22:55 UTC (rev 2726)
@@ -446,6 +446,7 @@
                 1205=Pomoc
                 1206=Calc
                 1207=Twoj Profil ma niezapisane zmiany. Chcesz zapisac?
+		1208=ratings from GCVote
                 1300=Ostatnie ustawienia
                 1301=Wybierz Profil:
                 1400=Strefa

Modified: trunk/res_noewe/languages/SV.cfg
===================================================================
--- trunk/res_noewe/languages/SV.cfg	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/res_noewe/languages/SV.cfg	2010-08-08 19:22:55 UTC (rev 2726)
@@ -446,6 +446,7 @@
         	1205=Solver
         	1206=Calc
         	1207=Din profil har sparats. Vill du spara?
+		1208=ratings from GCVote
         	1300=senaste inst%e4llningen
         	1301=V%e4lj profil:
         	1400=Zone

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/src/CacheWolf/MainMenu.java	2010-08-08 19:22:55 UTC (rev 2726)
@@ -16,8 +16,8 @@
 import CacheWolf.imp.LOCXMLImporter;
 import CacheWolf.imp.OCXMLImporter;
 import CacheWolf.imp.OCXMLImporterScreen;
-import CacheWolf.imp.Rating;
 import CacheWolf.imp.SpiderGC;
+import CacheWolf.imp.GCVoteImporter;
 import CacheWolf.navi.MapImporter;
 import CacheWolf.navi.MapLoaderGui;
 import CacheWolf.navi.SelectMap;
@@ -54,13 +54,13 @@
 public class MainMenu extends MenuBar {
 	private MenuItem preferences, mnuContext,loadcaches,loadOC, /* savenexit, */ savenoxit,exit,search,searchAll,searchClr;
 	private MenuItem downloadmap, kalibmap, importmap, selectMapPath;
-	private MenuItem spider, spiderAllFinds, update, chkVersion;
+	private MenuItem spider, spiderAllFinds, loadGCVotes, update, chkVersion;
 	private MenuItem about, wolflang, sysinfo, legend;
 	private MenuItem exportGpxNg, exporthtml, exporttop50, exportASC, exportTomTom, exportMSARCSV, exportSpoilerPOI;
 	private MenuItem exportOZI, exportKML, exportTPL, exportExplorist;
 	private MenuItem filtCreate, filtClear, filtInvert, filtSelected, filtNonSelected, filtBlack, filtApply;
 	private MenuItem exportLOC, exportGPS, mnuSeparator=new MenuItem(&quot;-&quot;);
-	private MenuItem orgNewWP, orgCopy, orgMove, orgDelete,orgRebuild,orgCheckNotesAndSolver, orgRater;
+	private MenuItem orgNewWP, orgCopy, orgMove, orgDelete,orgRebuild,orgCheckNotesAndSolver;
 	public MenuItem cacheTour,orgTravelbugs, mnuForceLogin;
 	private MenuItem mnuNewProfile, mnuOpenProfile, mnuDeleteProfile, mnuRenameProfile, mnuEditCenter;
 	private Form father;
@@ -96,6 +96,8 @@
 				spiderAllFinds = new MenuItem(MyLocale.getMsg(217,&quot;Spider all finds from geocaching.com&quot;)),
 				update         = new MenuItem(MyLocale.getMsg(1014,&quot;Update cache data&quot;)),
 				mnuSeparator,
+				loadGCVotes    = new MenuItem(MyLocale.getMsg(1208,&quot;Import ratings from GCVote&quot;)),
+				mnuSeparator,
 				mnuForceLogin  = new MenuItem(MyLocale.getMsg(216,&quot;Always login to GC&quot;)),
 		};
 		Menu importMenu = new Menu(mnuImport, MyLocale.getMsg(175,&quot;Import&quot;));
@@ -219,12 +221,10 @@
 				orgDelete   = new MenuItem(MyLocale.getMsg(143,&quot;Delete&quot;)),
 				orgRebuild   = new MenuItem(MyLocale.getMsg(208,&quot;Rebuild Index&quot;)),
 				orgCheckNotesAndSolver = new MenuItem(MyLocale.getMsg(220,&quot;Check Notes/Solver&quot;)),
-				orgRater = new MenuItem(&quot;Rater&quot;),
 				mnuSeparator,
 				orgTravelbugs = new MenuItem(MyLocale.getMsg(139,&quot;Manage travelbugs&quot;)),
 				cacheTour = new MenuItem(MyLocale.getMsg(198,&quot;Cachetour&quot;)),
 		};
-		if (null == Global.getPref().rater) orgRater.modifiers = MenuItem.Disabled;
 		this.addMenu(new PullDownMenu(MyLocale.getMsg(140,&quot;Organise&quot;),new Menu(organiseMenuItems,null)));
 
 		///////////////////////////////////////////////////////////////////////
@@ -344,6 +344,11 @@
 				profile.readIndex();
 				tbp.resetModel();
 			}
+			if(mev.selectedItem == loadGCVotes){
+                GCVoteImporter sGCV = new GCVoteImporter(pref, profile, true);
+                sGCV.doIt();
+                tbp.resetModel();
+			}
 			if(mev.selectedItem == loadcaches){
 				String dir = pref.getImporterPath(&quot;LocGpxImporter&quot;);
 				FileChooser fc = new FileChooser(FileChooserBase.OPEN|FileChooserBase.MULTI_SELECT, dir);
@@ -687,10 +692,6 @@
 				cacheTour.modifiers^=MenuItem.Checked;
 				Global.mainForm.toggleCacheListVisible();
 			}
-			if(mev.selectedItem == orgRater) {
-				Rating rater = new Rating();
-				rater.run();
-			}
 
 			///////////////////////////////////////////////////////////////////////
 			// &quot;About&quot; pulldown menu

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/src/CacheWolf/Preferences.java	2010-08-08 19:22:55 UTC (rev 2726)
@@ -270,8 +270,6 @@
 	public boolean downloadTBs = true;
 	/** Last mode select in the DataMover for processing cache*/
 	public int processorMode = 0;
-	/** external Cacherating software */
-	public String rater;
 	/** maximum number of logs to store in cache details */
 	public int maxLogsToKeep = DEFAULT_MAX_LOGS_TO_SPIDER;
 	/** keep own logs even when excessing &lt;code&gt;maxLogsToKeep&lt;/code&gt; */
@@ -571,9 +569,6 @@
 		else if (name.equals(&quot;locale&quot;)) {
 			language = atts.getValue(&quot;language&quot;);
 		}
-		else if (name.equals(&quot;rater&quot;)) {
-			rater = SafeXML.cleanback(atts.getValue(&quot;tool&quot;));
-		}
 		else if (name.equals(&quot;FILTERDATA&quot;)) {
 			// Creating a filter object and reading the saved data
 			String id = SafeXML.cleanback(atts.getValue(&quot;id&quot;));
@@ -729,7 +724,6 @@
 				entry = (MapEntry) itPath.next();
 				outp.print(&quot;    &lt;impPath key = \&quot;&quot; + SafeXML.clean(entry.getKey().toString()) + &quot;\&quot; value = \&quot;&quot; + SafeXML.clean(entry.getValue().toString().replace('\\', '/')) + &quot;\&quot;/&gt;\n&quot;);
 			}
-			if (rater != null) outp.print(&quot;    &lt;rater tool=\&quot;&quot;.concat(SafeXML.clean(rater)).concat(&quot;\&quot;/&gt;\n&quot;));
 			outp.print(&quot;    &lt;logkeeping maximum=\&quot;&quot;+SafeXML.strxmlencode(maxLogsToKeep)+&quot;\&quot; keepown=\&quot;&quot;+SafeXML.strxmlencode(alwaysKeepOwnLogs)+&quot;\&quot; /&gt;\n&quot;);
 			outp.print(&quot;    &lt;fillWhiteArea on=\&quot;&quot;+SafeXML.strxmlencode(fillWhiteArea)+&quot;\&quot;/&gt;\n&quot;);
 			outp.print(&quot;    &lt;mapLoader tileSize=\&quot;&quot;+SafeXML.strxmlencode(mapTileSize)+&quot;\&quot; overlapping=\&quot;&quot;+SafeXML.strxmlencode(mapOverlapping)+&quot;\&quot; tilewidth=\&quot;&quot;+SafeXML.strxmlencode(tilewidth)+&quot;\&quot; tileheight=\&quot;&quot;+SafeXML.strxmlencode(tileheight)+&quot;\&quot;/&gt;\n&quot;);

Added: trunk/src/CacheWolf/imp/GCVoteImporter.java
===================================================================
--- trunk/src/CacheWolf/imp/GCVoteImporter.java	                        (rev 0)
+++ trunk/src/CacheWolf/imp/GCVoteImporter.java	2010-08-08 19:22:55 UTC (rev 2726)
@@ -0,0 +1,156 @@
+package CacheWolf.imp;
+
+import ewe.data.Property;
+import ewe.data.PropertyList;
+import ewe.io.BufferedReader;
+import ewe.io.IOException;
+import ewe.io.InputStreamReader;
+import ewe.io.JavaUtf8Codec;
+import ewe.net.Socket;
+import ewe.sys.Handle;
+import ewe.ui.FormBase;
+import ewe.ui.MessageBox;
+import ewe.ui.ProgressBarForm;
+import ewe.util.CharArray;
+import CacheWolf.CacheDB;
+import CacheWolf.CacheHolder;
+import CacheWolf.Common;
+import CacheWolf.Global;
+import CacheWolf.HttpConnection;
+import CacheWolf.MyLocale;
+import CacheWolf.Preferences;
+import CacheWolf.Profile;
+import CacheWolf.imp.SpiderGC.SpiderProperties;
+import CacheWolf.utils.CWWrapper;
+import ewe.io.*;
+import ewesoft.xml.MinML;
+import ewesoft.xml.sax.AttributeList;
+
+
+
+public class GCVoteImporter extends MinML{
+
+	private Profile profile;
+	private CacheDB cacheDB;
+	private String GCVUser;
+	private String GCVPassword;
+	private String GCVURL;
+	private String GCVWaypoints;
+	private String GCVResults;
+	private static Preferences pref;
+	private static SpiderProperties p=null;
+
+	/**
+	*	Constructor initalizing profile and cacheDB
+	*/
+	public GCVoteImporter(Preferences prf, Profile profile, boolean bypass){
+		this.profile=profile;
+		this.cacheDB = profile.cacheDB;
+		pref = prf;
+		if (p == null) {
+			pref.logInit();
+		}
+		// initialiseProperties();
+	}
+
+	/**
+	*	Read cacheDB and check for GCVotes
+	*/
+	public void doIt() {
+		ProgressBarForm pbf = new ProgressBarForm();
+		Handle h = new Handle();
+		this.GCVUser = pref.myAlias;
+		this.GCVPassword = &quot;&quot;;
+
+		int totalWaypoints = cacheDB.countVisible();
+		int countWaypoints = 0;
+
+		pbf.showMainTask = false;
+		pbf.setTask(h, &quot;Import GCVote ratings ...&quot;);
+		pbf.exec();
+
+		for (int o = 0; o &lt; cacheDB.size(); o += 100) {
+		GCVWaypoints = &quot;&quot;;
+			for (int i = o; (i &lt; (o+100)) &amp; (i &lt; cacheDB.size()); i++) {
+				CacheHolder ch = cacheDB.get(i);
+				if (ch.isVisible()) {
+					if (ch.isCacheWpt()) {
+						GCVWaypoints += ch.getWayPoint() + &quot;,&quot;;
+					}
+					countWaypoints++;
+					h.progress = (float) countWaypoints / (float) totalWaypoints;
+					h.changed();
+				}
+			}
+
+			GCVURL = &quot;<A HREF="http://gcvote.de/getVotes.php?">http://gcvote.de/getVotes.php?</A>&quot;;
+			GCVURL += &quot;userName=&quot;+GCVUser+&quot;&amp;password=&quot;+GCVPassword+&quot;&amp;waypoints=&quot;+GCVWaypoints;
+
+			try {
+				if (pref.debug) pref.log(&quot;[GCVote]:Requesting ratings&quot;);
+
+				// request web page <A HREF="http://gcvote.de/getVotes.php">http://gcvote.de/getVotes.php</A>
+				GCVResults = getResponse(GCVURL);
+				if (GCVResults.equals(&quot;&quot;)) {
+					(new MessageBox(MyLocale.getMsg(0,&quot;Error&quot;), MyLocale.getMsg(0,&quot;Error loading GCVote page.%0aPlease check your internet connection.&quot;), FormBase.OKB)).execute();
+					if (pref.debug) pref.log(&quot;[GCVote]:Could not fetch: getVotes.php page&quot;);
+				} else {
+					// parse response for votes
+					if (pref.debug) pref.log(&quot;[GCVote]:GCVotes = &quot;+GCVResults);
+					Reader r = new StringReader(GCVResults);
+					parse(r);
+				}
+			} catch (Exception ex) {
+				ex.printStackTrace();
+			}
+		}
+		pbf.exit(0);
+	}
+
+	/**
+	*	Eventhandler for XML votes
+	*/
+	public void startElement(String name, AttributeList atts){
+		String waypoint;
+		double voteAvg;
+		if(name.equals(&quot;vote&quot;)) {
+			waypoint = atts.getValue(&quot;waypoint&quot;);
+			voteAvg = Common.parseDouble(atts.getValue(&quot;voteAvg&quot;)) * 2.0;
+			// voteCnt = atts.getValue(&quot;voteCnt&quot;);
+			if (pref.debug) pref.log(&quot;[GCVote]:WQaypoint = &quot; + waypoint + &quot;-&quot; + voteAvg);
+
+			CacheHolder cb = cacheDB.get(waypoint);
+			cb.setNumRecommended((int)voteAvg);
+		}
+	}
+
+	/**
+	*	Perform an request to fetch the GCVote results
+	*/
+	public static String getResponse(String address) {
+		CharArray c_data;
+		try{
+			HttpConnection conn;
+			if(pref.myproxy.length() &gt; 0 &amp;&amp; pref.proxyActive){
+				pref.log(&quot;[GCVote]:Using proxy: &quot; + pref.myproxy + &quot; / &quot; +pref.myproxyport);
+			}
+			conn = new HttpConnection(address);
+			conn.setRequestorProperty(&quot;User-Agent&quot;, &quot;Mozilla/5.0 (compatible; Cachewolf; GCVoteImporter)&quot;);
+			conn.setRequestorProperty(&quot;Connection&quot;, &quot;close&quot;);
+			conn.documentIsEncoded = true;
+			if (pref.debug) pref.log(&quot;[GCVote]:Connecting &quot;+address);
+			Socket sock = conn.connect();
+			if (pref.debug) pref.log(&quot;[GCVote]:Connect ok! &quot;+address);
+			JavaUtf8Codec codec = new JavaUtf8Codec();
+			c_data = conn.readText(sock, codec);
+			sock.close();
+			if (pref.debug) pref.log(&quot;[GCVote]:Read data ok &quot;+address);
+			return c_data.toString();
+		}catch(IOException ioex){
+			pref.log(&quot;IOException in fetch&quot;, ioex);
+		}finally{
+			//continue
+		}
+		return &quot;&quot;;
+	}
+}

Deleted: trunk/src/CacheWolf/imp/Rating.java
===================================================================
--- trunk/src/CacheWolf/imp/Rating.java	2010-08-08 13:40:19 UTC (rev 2725)
+++ trunk/src/CacheWolf/imp/Rating.java	2010-08-08 19:22:55 UTC (rev 2726)
@@ -1,60 +0,0 @@
-package CacheWolf.imp;
-
-import CacheWolf.CacheHolder;
-import CacheWolf.Global;
-import CacheWolf.utils.CWWrapper;
-import ewe.sys.Handle;
-import ewe.ui.ProgressBarForm;
-
-/*
- * get rating for a cache from an external tool
- */
-public class Rating {
-
-	String rater;
-
-	public Rating() {
-		rater = Global.getPref().rater;
-	}
-
-	/**
-	 * call the tool defined by Global.getPref().rater with a visible waypoint
-	 * as parameter wait for tool to finish, catch exit code and write it to
-	 * CacheHolder.numRecommended
-	 */
-	public void run() {
-		if (null == rater)
-			return;
-
-		ProgressBarForm pbf = new ProgressBarForm();
-		Handle h = new Handle();
-
-		int totalWaypoints = Global.getProfile().cacheDB.countVisible();
-		int countWaypoints = 0;
-
-		pbf.showMainTask = false;
-		pbf.setTask(h, &quot;Rating ...&quot;);
-		pbf.exec();
-
-		for (int i = 0; i &lt; Global.getProfile().cacheDB.size(); i++) {
-			CacheHolder ch = Global.getProfile().cacheDB.get(i);
-			if (ch.isVisible()) {
-				if (ch.isCacheWpt()) {
-					int rate;
-					try {
-						rate = CWWrapper.exec(rater, ch.getWayPoint(), true, true);
-						ch.setNumRecommended(rate);
-					} catch (Exception ex) {
-						ex.printStackTrace();
-					}
-				}
-				countWaypoints++;
-				h.progress = (float) countWaypoints / (float) totalWaypoints;
-				h.changed();
-			}
-		}
-		pbf.exit(0);
-		Global.mainForm.repaintNow();
-	}
-
-}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002713.html">[Cachewolf-svn] r2725 - trunk
</A></li>
	<LI>Next message: <A HREF="002715.html">[Cachewolf-svn] r2727 - in trunk: . res_noewe/webmapservices	src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2714">[ date ]</a>
              <a href="thread.html#2714">[ thread ]</a>
              <a href="subject.html#2714">[ subject ]</a>
              <a href="author.html#2714">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
