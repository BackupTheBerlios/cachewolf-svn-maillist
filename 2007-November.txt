From salzkammergut at mail.berlios.de  Thu Nov  1 17:50:06 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Thu, 1 Nov 2007 17:50:06 +0100
Subject: [Cachewolf-svn] r1035 - trunk/src/CacheWolf
Message-ID: <200711011650.lA1Go6CB024459@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-01 17:50:03 +0100 (Thu, 01 Nov 2007)
New Revision: 1035

Modified:
   trunk/src/CacheWolf/ShowCacheInBrowser.java
Log:
ShowCacheInBrowser: Fix. Under certain circumstances a picture was shown twice.

Modified: trunk/src/CacheWolf/ShowCacheInBrowser.java
===================================================================
--- trunk/src/CacheWolf/ShowCacheInBrowser.java	2007-10-31 15:09:59 UTC (rev 1034)
+++ trunk/src/CacheWolf/ShowCacheInBrowser.java	2007-11-01 16:50:03 UTC (rev 1035)
@@ -122,7 +122,7 @@
 					int start=0;
 					int pos;
 					int imageNo=0;
-					Regex imgRex = new Regex("src=(?:[^\"|']*?)(?:\"|')(.*?)(?:\"|')");
+					Regex imgRex = new Regex("src=(?:\\s*[^\"|']*?)(?:\"|')(.*?)(?:\"|')");
 					while (start>=0 && (pos=chD.LongDescription.indexOf("<img",start))>0) {
 						s.append(chD.LongDescription.substring(start,pos));
 						imgRex.searchFrom(chD.LongDescription,pos);
@@ -135,11 +135,11 @@
 								s.append("<img src=\"file://"+
 								   Global.getProfile().dataDir+chD.Images.get(imageNo)+"\">");
 								imageNo++;
-								if (imageNo >= chD.Images.getCount())break;
 							}
 						}
 						start=chD.LongDescription.indexOf(">",pos);
 						if (start>=0) start++;
+						if (imageNo >= chD.Images.getCount())break;
 					}
 					if (start>=0) s.append(chD.LongDescription.substring(start));
 					tpl.setParam("DESCRIPTION", s.toString());



From salzkammergut at mail.berlios.de  Thu Nov  1 21:10:07 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Thu, 1 Nov 2007 21:10:07 +0100
Subject: [Cachewolf-svn] r1036 - trunk/src/CacheWolf
Message-ID: <200711012010.lA1KA7oc021538@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-01 21:10:04 +0100 (Thu, 01 Nov 2007)
New Revision: 1036

Modified:
   trunk/src/CacheWolf/MainMenu.java
Log:
MainMenu: Fix: When spidering new caches any changes in the database or newly created waypoints were lost. Now the database is saved before spidering, if there are unsaved changes. 

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2007-11-01 16:50:03 UTC (rev 1035)
+++ trunk/src/CacheWolf/MainMenu.java	2007-11-01 20:10:04 UTC (rev 1036)
@@ -265,6 +265,7 @@
 			///////////////////////////////////////////////////////////////////////
 			if(mev.selectedItem == spider){
 				SpiderGC spGC = new SpiderGC(pref, profile, true);
+				Global.mainTab.saveUnsavedChanges(false);
 				spGC.doIt();
 				cacheDB.clear();
 				profile.readIndex();



From pfeffer at mail.berlios.de  Fri Nov  2 00:03:36 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 2 Nov 2007 00:03:36 +0100
Subject: [Cachewolf-svn] r1037 - in trunk/src/CacheWolf: . navi
Message-ID: <200711012303.lA1N3asU006224@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-02 00:03:31 +0100 (Fri, 02 Nov 2007)
New Revision: 1037

Added:
   trunk/src/CacheWolf/navi/GkPoint.java
Modified:
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
Coordinates transformation: done. it's a static class, easy to use. I also added a method getGermanGkCooordinates in CWPoint. Unfortunately there is now mathematical transformation avaible that provides a precision better than 1m for whole germany. For NRW we have precision to 37cm, when using the special implemented functions.

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-01 20:10:04 UTC (rev 1036)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-01 23:03:31 UTC (rev 1037)
@@ -6,6 +6,7 @@
 import ewe.sys.Locale;
 import ewe.sys.Convert;
 import CacheWolf.navi.TrackPoint;
+import CacheWolf.navi.TransformCoordinates;
 
 import com.bbn.openmap.proj.coords.*;
 import com.bbn.openmap.proj.*;
@@ -447,6 +448,10 @@
 		return Convert.toString((long)utm.easting).replace(',','.');
 	}
 	
+	public String getGermanGkCoordinates() {
+		return TransformCoordinates.wgs84ToGkGermany(this).toString(0, "R:", " H:");
+	}
+	
 	/**
 	 * Method to calculate a projected waypoint
 	 * @param degrees Bearing

Added: trunk/src/CacheWolf/navi/GkPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/GkPoint.java	2007-11-01 20:10:04 UTC (rev 1036)
+++ trunk/src/CacheWolf/navi/GkPoint.java	2007-11-01 23:03:31 UTC (rev 1037)
@@ -0,0 +1,33 @@
+package CacheWolf.navi;
+
+/**
+ * Point in Gau?-Kr?ger Format
+ * @author Robert Arnold
+ *
+ */
+public class GkPoint {
+	double northing;
+	double easting;
+
+	public GkPoint() { super(); }
+	
+	public GkPoint(double e, double n) {
+		easting = e;
+		northing = n;
+	}
+	
+	public String toString() {
+		return toString(0, "R: ", " H: ");
+	}
+
+	
+	public String toString(int decimalplaces, String prefix, String seperator) {
+		ewe.sys.Double n = new ewe.sys.Double();
+		ewe.sys.Double e = new ewe.sys.Double();
+		n.set(northing);
+		e.set(easting);
+		n.decimalPlaces = decimalplaces;
+		e.decimalPlaces = decimalplaces;
+		return prefix + e.toString().replace(',', '.') + seperator + n.toString().replace(',', '.');
+	}
+}
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-01 20:10:04 UTC (rev 1036)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-01 23:03:31 UTC (rev 1037)
@@ -5,23 +5,115 @@
 
 import java.lang.Math;
 
+/**
+ * Class to transform coordinates and shift datums
+ * it uses the 7 parameter Helmert Transformation
+ * programmed according to http://www.geoclub.de/files/GK_nach_GPS.xls 
+ * and http://www.geoclub.de/files/GPS_nach_GK.xls
+ * The only difference to the excel-model is that shifting is done before rotation
+ * this makes calculations easier, without changing the output.
+ * @author Robert Arnold
+ *
+ */
 public class TransformCoordinates {
-//	public Ellipsoid ellipsoid;
-//	public TransformParameters transParams;
 	
-	static final Ellipsoid Bessel = new Ellipsoid(6377397.155, 6356078.962);
-	static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
-	static final TransformParameters GKToWGS84 = new TransformParameters(584.8, 67.0, 400.3, -0.105 * Math.PI/180/3600, -0.013 * Math.PI/180/3600, 2.378 * Math.PI/180/3600, 1/(1 - 10.290 * Math.pow(10, -6)) );
-	static final TransformParameters WGS84ToGK = new TransformParameters(-584.8, -67.0, -400.3, 0.105 * Math.PI/180/3600, 0.013 * Math.PI/180/3600, -2.378 * Math.PI/180/3600, 1- 10.290 * Math.pow(10, -6) );
+	private static final Ellipsoid BESSEL = new Ellipsoid(6377397.155, 6356078.962);
+	private static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
 	
-	public static GKPoint WGS84ToGK(CWPoint ll) {
+
+	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 4 = Deutschland Nord"
+	private static final TransformParameters GK_NORD_GERMANY_TO_WGS84 = new TransformParameters(590.5, 69.5, 411.6, 0.796, 0.052, 3.601, 8.300, false);
+	/** use this for nord Germany, maximum deviation unknown */
+	public static final TransformParameters GK_NORD_GERMANY =  GK_NORD_GERMANY_TO_WGS84; 
+
+	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 3 = Mitte Deutschland"
+	private static final TransformParameters GK_MID_GERMANY_TO_WGS84 = new TransformParameters(584.8, 67.0, 400.3, -0.105, -0.013, 2.378, 10.290, false);
+	/** use this for mid Germany, maximum deviation unknown */
+	public static final TransformParameters GK_MID_GERMANY =  GK_MID_GERMANY_TO_WGS84; 
+
+	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 5 = Deutschland S?d"
+	private static final TransformParameters GK_SOUTH_GERMANY_TO_WGS84 = new TransformParameters(597.1, 71.4, 412.1, -0.894, -0.068, 1.563, 7.580, false);
+	/** use this for south Germany, maximum deviation unknown */
+	public static final TransformParameters GK_SOUTH_GERMANY =  GK_SOUTH_GERMANY_TO_WGS84; 
+
+	// taken from http://www.lverma.nrw.de/produkte/druckschriften/verwaltungsvorschriften/images/gps/TrafopsNRW.pdf for NRW this transform has deviations lower than 34cm.
+	private static final TransformParameters GK_NRW_GERMANY_TO_WGS84 = new TransformParameters(566.1, 116.3, 390.1, -1.11, -0.24, 3.76, 12.6, false);
+	/** use this for NRW in Germany. Deviations less than 34 cm */
+	public static final TransformParameters GK_NRW_GERMANY =  GK_NRW_GERMANY_TO_WGS84; 
+	
+	// taken from http://www.lverma.nrw.de/produkte/druckschriften/verwaltungsvorschriften/images/gps/TrafopsNRW.pdf for NRW this transform has deviations lower than 113cm.
+	// these matches to  http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 3 = Deutschland 1995"
+	private static final TransformParameters GK_GERMANY_1995_TO_WGS84 = new TransformParameters(582, 105, 414, -1.04, -0.35, +3.08, 8.3, false);
+	/** Use this for Germany if there is no more specific available. Deviations less than 113 cm */
+	public static final TransformParameters GK_GERMANY_1995 =  GK_GERMANY_1995_TO_WGS84; 
+
+	// taken from http://www.geodatenzentrum.de/geodaten/gdz_home1.gdz_home_start?gdz_home_para1=Technische%A0Hinweise&gdz_home_para2=Technische%A0Hinweise&gdz_home_menu_nr=10&gdz_home_menu_nr2=1&gdz_home_para3=/auftrag/html/gdz_tech_geo_deu.htm&gdz_home_spr=deu&gdz_home_para0=0
+	private static final TransformParameters GK_GERMANY_BKG_TO_WGS84 = new TransformParameters(586, 87, 409, -0.52, -0.15, 2.82, 9, false);
+	/** Use this for Germany if there is no more specific available. Deviations unknown. Data source: Bundesamt f?r Kartographie und Geod?sie, taken from website on: 1-11-2007 */
+	public static final TransformParameters GK_GERMANY_BKG =  GK_GERMANY_BKG_TO_WGS84; 
+
+	// take from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 2 = Deutschland 2001"
+	private static final TransformParameters GK_GERMANY_2001_TO_WGS84 = new TransformParameters(598.1, 73.7, 418.2, -0.202, -0.045, 2.455, 6.700, false);
+	/** Use this for Germany if there is no more specific available. maximal deviations unknown */
+	public static final TransformParameters GK_GERMANY_2001 =  GK_GERMANY_2001_TO_WGS84; 
+
+	
+
+	private TransformCoordinates() {} // as all members are static, so avoid instantiation
+	
+	/**
+	 * This is the most abstract method: If you don't know 
+	 * when to use another one (if you are in need to do so, you will
+	 * know), use this one.
+	 * @param gk
+	 * @return
+	 */
+	public static CWPoint gkGermanyToWgs84(GkPoint gk) {
+		return  gkToWgs84(gk, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
+	}
+	
+	/**
+	 * This is the most abstract method: If you don't know 
+	 * when to use another one (if you are in need to do so, you will
+	 * know), use this one.
+	 * @param gk
+	 * @return
+	 */
+	public static GkPoint wgs84ToGkGermany(CWPoint ll) {
+		return  wgs84ToGk(ll, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
+	}
+
+	/**
+	 * Call this routine to convert from wgs84 into German Gau?-Kr?ger-Coordinates 
+	 * using the Gau?-Kr?ger Projection and the Bessel ellipsoid
+	 * 	 *  
+	 * @param ll
+	 * @param Gau?-Kr?ger-to-WGS84 transformation parameters, they will be automatically inverted
+	 * @return
+	 */
+	public static GkPoint wgs84ToGk(CWPoint ll, TransformParameters gk2wgs84) {
 		XyzCoordinates wgsxyz = latLon2xyz(ll, 0, WGS84);
-		XyzCoordinates gkxyz = transform(wgsxyz, WGS84ToGK);
-		CWPoint gkll = Xyz2Latlon(gkxyz, Bessel);
-		return projectLatlon2GK(gkll, Bessel);
+		XyzCoordinates gkxyz = transform(wgsxyz, new TransformParameters(gk2wgs84, true));
+		CWPoint gkll = Xyz2Latlon(gkxyz, BESSEL);
+		return projectLatlon2GK(gkll, BESSEL, 3);
 	}
+	/**
+	 * Call this method to convert any Gau?-Kr?ger coordinates into
+	 * wgs84.
+	 * @param gk point to convert
+	 * @param GK2WGS84 Gau?-Kr?ger-to-WGS84 transformation parameters
+	 * @return
+	 */
+	public static CWPoint gkToWgs84(GkPoint gk, TransformParameters gk2wgs84) {
+		CWPoint gkll = GK2LatLon(gk, BESSEL, 3);
+		XyzCoordinates wgsxyz = latLon2xyz(gkll, 0, BESSEL);
+		XyzCoordinates wgs84xyz = transform(wgsxyz, gk2wgs84);
+		CWPoint wgsll = Xyz2Latlon(wgs84xyz, WGS84);
+		return wgsll;
+	}
 	
-	public static XyzCoordinates latLon2xyz(CWPoint ll, double alt, Ellipsoid ellipsoid) {
+	private static XyzCoordinates latLon2xyz(CWPoint ll, double alt, Ellipsoid ellipsoid) {
+		if (!ll.isValid()) throw new IllegalArgumentException("latLon2xyz: invalid lat-lon");
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
 		double N = ellipsoid.a/ Math.sqrt(1 - e2 * Math.pow(Math.sin(ll.latDec / 180*Math.PI), 2));
 		XyzCoordinates ret = new XyzCoordinates(0,0,0);
@@ -31,7 +123,7 @@
 		return ret;
 	}
 	
-	public static XyzCoordinates transform(XyzCoordinates from, TransformParameters transParams) {
+	private static XyzCoordinates transform(XyzCoordinates from, TransformParameters transParams) {
 		Matrix coos = new Matrix(3, 1);
 		coos.matrix[0][0] = from.x;
 		coos.matrix[1][0] = from.y;
@@ -62,7 +154,7 @@
 		return new XyzCoordinates(coos.matrix[0][0], coos.matrix[1][0], coos.matrix[2][0]);
 	}
 	
-	public static CWPoint Xyz2Latlon(XyzCoordinates from, Ellipsoid ellipsoid) {
+	private static CWPoint Xyz2Latlon(XyzCoordinates from, Ellipsoid ellipsoid) {
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
 		double s = Math.sqrt( Math.pow(from.x,2) + Math.pow(from.y,2));
 		double T = Math.atan( from.z * ellipsoid.a / (s * ellipsoid.b));
@@ -77,10 +169,19 @@
 		return ret;
 	}
 	
-	public static GKPoint projectLatlon2GK(CWPoint ll, Ellipsoid ellipsoid) {
+	/**
+	 * Project latlon to Gau?-Kr?ger-Coordinates on ellipsoid
+	 * @param latlon
+	 * @param ellipsoid
+	 * @return
+	 */
+	private static GkPoint projectLatlon2GK(CWPoint latlon, Ellipsoid ellipsoid, int stripewidth) {
+		if (!latlon.isValid()) throw new IllegalArgumentException("projectLatlon2GK: lat-lon not valid");
+		CWPoint ll = new CWPoint(latlon); // copy the point, in order to avoid modifying the parameter latlon
+		if (ll.lonDec < 0) ll.lonDec += 360;
 		int stripe;
-		for (stripe=0; stripe <= 360; stripe += 3) { // TODO -180 bis +180
-			if (Math.abs(ll.lonDec - stripe) < 1.5) break;
+		for (stripe = 0; stripe <= 360; stripe += stripewidth) {
+			if (Math.abs(ll.lonDec - stripe) <= ((float)stripewidth) / 2) break;
 		}
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
 		double l = (ll.lonDec - stripe) /180*Math.PI; // TODO see is int to double works
@@ -101,15 +202,55 @@
 		double h2 = t/24 * N * Math.pow(Math.cos(B),4) * (5 - t*t + 9 * nue*nue + 4*Math.pow(nue, 4)) * Math.pow(l,4);
 		double northing = arclength + h1 + h2;
 		
-		
 		double r1 = N * Math.cos(B) * l;
 		double r2 = N/6 * Math.pow(Math.cos(B), 3) * (1-t*t+nue*nue)*l*l*l;
-		double easting = r1 + r2 + stripe / 3 * 1000000 + 500000;
-		GKPoint ret = new GKPoint();
+		double easting = r1 + r2 + stripe / stripewidth * 1000000 + 500000;
+		GkPoint ret = new GkPoint();
 		ret.easting = easting;
 		ret.northing = northing;
 		return ret;
 	}
+	
+	/**
+	 * Converts Gau?-Kr?ger-coordinates into lat/lon on the respective ellipsoid
+	 * @param gkp
+	 * @param ellipsoid
+	 * @param stripewidth width in degree of the stripe of the Gau?-Kr?ger-System (3 degreee usually used in Gau?-Kr?ger, 6 degree usually in UTM)
+	 * @return
+	 */
+	private static CWPoint GK2LatLon (GkPoint gkp, Ellipsoid ellipsoid, int stripewidth) {
+		double Y0 = Math.floor(gkp.easting / 1000000);
+		double L0 = Y0 * stripewidth; // decimal degree of the center of the stripe
+		double y = gkp.easting - 1000000 * Y0 - 500000;
+		
+		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
+		// note: n1-n6 are similiar to the n1-n6 in projectLatlon2GK, but some term have different factors
+		double n1 = (ellipsoid.a-ellipsoid.b)/(ellipsoid.a+ellipsoid.b);
+		double n2 = (ellipsoid.a+ellipsoid.b)/2 * (1+ Math.pow(n1, 2)/4 + Math.pow(n1, 4)/64);
+		double n3 = n1 * 3/2 - Math.pow(n1, 3) * 27/32  + Math.pow(n1, 5) * 269/32;
+		double n4 = Math.pow(n1, 2) * 21/16 - Math.pow(n1, 4) * 55/32;
+		double n5 = Math.pow(n1, 3) * 151/96 - Math.pow(n1, 5) * 417/128;
+		double n6 = Math.pow(n1, 4) * 1097/512;
+
+		double B0 = gkp.northing / n2;
+		double Bf = B0 + n3 * Math.sin(B0*2) + n4 * Math.sin(B0*4) + n5 * Math.sin(B0*6) + n6 * Math.sin(B0*8);
+		
+		double Nf = ellipsoid.a / Math.sqrt (1- e2 * Math.pow(Math.sin(Bf), 2));
+		double nuef = Math.sqrt(ellipsoid.a * ellipsoid.a / ellipsoid.b / ellipsoid.b * e2 * Math.pow(Math.cos(Bf), 2));
+		double tf = Math.tan(Bf);
+		
+		double la1 = tf / 2 / Nf/Nf * (-1-nuef*nuef) * y*y;
+		double la2 = tf /24 / Math.pow(Nf, 4) * (5 + 3*tf*tf + 6*nuef*nuef - 6*tf*tf * nuef*nuef - 4*Math.pow(nuef, 4) - 9*tf*tf*Math.pow(nuef, 4)) * Math.pow(y, 4);
+	// these deal this less than the overall calculation precision double la3 = tf /720 / Math.pow(Nf, 6) * (-61 - 90*tf*tf - 45*Math.pow(tf,4) - 107*nuef*nuef + 162*tf*tf * Math.pow(nuef, 2) + 45*Math.pow(tf,4)*tf*Math.pow(nuef, 2)) * Math.pow(y, 6);
+	// these deal this less than the overall calculation precision double la4 = tf /40320 / Math.pow(Nf, 8) * (1385+3663*tf*tf - 4095*Math.pow(tf,4) + 1575*Math.pow(nuef, 6)) * Math.pow(y, 8);
+		double lat = (Bf + la1 + la2) * 180 / Math.PI;
+
+		double lo1 = 1 / Nf / Math.cos(Bf) * y;
+		double lo2 = 1 / Math.pow(Nf, 3) / Math.cos(Bf) *  (-1 -tf*tf*2 - nuef*nuef) * Math.pow(y, 3) / 6;
+		double lon = L0 + (lo1 + lo2) * 180/Math.PI;
+		return new CWPoint(lat, lon);
+	}
+	
 }
 
 class XyzCoordinates {
@@ -130,22 +271,41 @@
 }
 
 class TransformParameters {
-	// shift parameter
+	// shift parameter in meter
 	double dx, dy, dz, 
 	// rotation parameter in rad
-	ex, ey, ez, 
+	ex, ey, ez,
 	// scale as multiplicator
 	s;
 	
-	public TransformParameters(double dxi, double dyi, double dzi, double exi, double eyi, double ezi, double si) {
-		dx = dxi; dy = dyi; dz = dzi; ex = exi; ey =eyi; ez = ezi; s = si;
+	/**
+	 * 
+	 * @param d shift in meter
+	 * @param exi rotation in seconds
+	 * @param si deviation of scale multiplied by 10^6 
+	 * @param invert
+	 */
+	public TransformParameters(double dxi, double dyi, double dzi, double exi, double eyi, double ezi, double si, boolean invert) {
+		dx = dxi; dy = dyi; dz = dzi; 
+		ex = exi * Math.PI/180/3600;
+		ey = eyi * Math.PI/180/3600; 
+		ez = ezi * Math.PI/180/3600;
+		s = 1/(1 - si * Math.pow(10, -6));
+		if (invert) invert();
 	}
-}
+	
+	public TransformParameters(TransformParameters tp, boolean invert) {
+		dx = tp.dx;	dy = tp.dy;	dz = tp.dz;
+		ex = tp.ex;	ey = tp.ey;	ez = tp.ez;
+		s = tp.s;
+		if (invert) invert();
+	}
 
-class GKPoint {
-	double northing;
-	double easting;
-	public String toString() {
-		return Double.toString(easting) + ";" + Double.toString(northing);
+	public void invert() {
+		dx *= -1; dy *= -1;	dz *= -1;
+		ex *= -1; ey *= -1;	ez *= -1;
+		s = 1/s;
 	}
 }
+
+



From pfeffer at mail.berlios.de  Fri Nov  2 00:15:10 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 2 Nov 2007 00:15:10 +0100
Subject: [Cachewolf-svn] r1038 - trunk/src/CacheWolf/navi
Message-ID: <200711012315.lA1NFAmK007304@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-02 00:14:57 +0100 (Fri, 02 Nov 2007)
New Revision: 1038

Modified:
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
Coordination transformation: added a comment

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-01 23:03:31 UTC (rev 1037)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-01 23:14:57 UTC (rev 1038)
@@ -12,6 +12,11 @@
  * and http://www.geoclub.de/files/GPS_nach_GK.xls
  * The only difference to the excel-model is that shifting is done before rotation
  * this makes calculations easier, without changing the output.
+ * 
+ * Now, that this is completed: there is a much more precise method right now published
+ * by the Bundesamt f?r Kartographie und Geod?sie for whole Germany: see:
+ *  * http://crs.bkg.bund.de/crseu/crs/descrtrans/BeTA/BETA2007dokumentation.pdf
+ *  * http://crs.bkg.bund.de/crs-eu/ click on "national CRS" -> germany -> DE_DHDN / GK_3 -> DE_DHDN (BeTA, 2007) to ETRS89
  * @author Robert Arnold
  *
  */



From salzkammergut at mail.berlios.de  Fri Nov  2 20:07:07 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Fri, 2 Nov 2007 20:07:07 +0100
Subject: [Cachewolf-svn] r1039 - trunk/src/CacheWolf
Message-ID: <200711021907.lA2J777D021382@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-02 20:07:03 +0100 (Fri, 02 Nov 2007)
New Revision: 1039

Modified:
   trunk/src/CacheWolf/SpiderGC.java
Log:
SpiderGC: Added the number of logs found to the spider log

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-11-01 23:14:57 UTC (rev 1038)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-11-02 19:07:03 UTC (rev 1039)
@@ -789,7 +789,9 @@
 		}
 		if (nLogs>MAXLOGS) {
 			reslts.add(Log.maxLog());
-		}
+			pref.log("Too many logs. MAXLOGS reached ("+MAXLOGS+")");
+		} else
+			pref.log(nLogs+" logs found");
 		return reslts;
 	}
 



From salzkammergut at mail.berlios.de  Fri Nov  2 20:17:32 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Fri, 2 Nov 2007 20:17:32 +0100
Subject: [Cachewolf-svn] r1040 - trunk/src/CacheWolf
Message-ID: <200711021917.lA2JHWHn021959@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-02 20:17:29 +0100 (Fri, 02 Nov 2007)
New Revision: 1040

Modified:
   trunk/src/CacheWolf/Preferences.java
Log:
Preferences: Minor change to eliminate the blank lines in the log to the console (with debug option set to true in pref.xml).

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-02 19:07:03 UTC (rev 1039)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-02 19:17:29 UTC (rev 1040)
@@ -555,7 +555,9 @@
 		Time dtm = new Time();
 		dtm.getTime();
 		dtm.setFormat("dd.MM.yyyy'/'HH:mm");
-		text = dtm.toString()+ ": "+ text + "\n";
+		text = dtm.toString()+ ": "+ text;
+		if (debug) Vm.debug(text);
+		text=text+"\n";
 		File logFile = new File(LOGFILENAME);
 		Stream strout = null;
 		try{
@@ -566,7 +568,6 @@
 		}finally{
 			strout.close();
 		}
-		if (debug) Vm.debug(text);
 	}
 
 	/** Log an exception to the log file with or without a stack trace



From salzkammergut at mail.berlios.de  Fri Nov  2 21:58:53 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Fri, 2 Nov 2007 21:58:53 +0100
Subject: [Cachewolf-svn] r1041 - trunk/src/CacheWolf
Message-ID: <200711022058.lA2KwrBl026906@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-02 21:58:49 +0100 (Fri, 02 Nov 2007)
New Revision: 1041

Modified:
   trunk/src/CacheWolf/Log.java
   trunk/src/CacheWolf/LogList.java
Log:
Logs: Made the parsing of logs from the cache.xml file more robust. Logs that cannot be parsed are now recorded in the log file and are not stored in the loglist (this could have been the cause of NPEs experienced by some users)

Modified: trunk/src/CacheWolf/Log.java
===================================================================
--- trunk/src/CacheWolf/Log.java	2007-11-02 19:17:29 UTC (rev 1040)
+++ trunk/src/CacheWolf/Log.java	2007-11-02 20:58:49 UTC (rev 1041)
@@ -2,6 +2,7 @@
 
 public class Log {
 	private static String MAXLOGICON="MAXLOG";
+	private static String INVALIDLOGICON=null;
 	/** The icon which describes the log e.g. icon_sad */
 	private String icon;
 	/** The date in format yyyy-mm-dd */
@@ -30,8 +31,10 @@
 			logger=logLine.substring(l1,l2);
 			message=logLine.substring(l2+4);
 		} catch (Exception ex) {
-			icon=MAXLOGICON;
+			Global.getPref().log("Error parsing log: "+logLine);
+			icon=INVALIDLOGICON;
 			date="1900-00-00";
+			logger=message="";
 		}
 	}
 	

Modified: trunk/src/CacheWolf/LogList.java
===================================================================
--- trunk/src/CacheWolf/LogList.java	2007-11-02 19:17:29 UTC (rev 1040)
+++ trunk/src/CacheWolf/LogList.java	2007-11-02 20:58:49 UTC (rev 1041)
@@ -28,7 +28,7 @@
 
 	/** Add a Log to the list */
 	public void add(Log log) {
-		logList.add(log);
+		if (log.getIcon()!=null) logList.add(log); // Don't add invalid logs
 	}
 	
 	/** Remove a Log from the list */



From salzkammergut at mail.berlios.de  Fri Nov  2 22:29:21 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Fri, 2 Nov 2007 22:29:21 +0100
Subject: [Cachewolf-svn] r1042 - trunk/src/CacheWolf
Message-ID: <200711022129.lA2LTLOa028598@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-02 22:29:19 +0100 (Fri, 02 Nov 2007)
New Revision: 1042

Modified:
   trunk/src/CacheWolf/Log.java
Log:
Log: Further improvement of log parsing

Modified: trunk/src/CacheWolf/Log.java
===================================================================
--- trunk/src/CacheWolf/Log.java	2007-11-02 20:58:49 UTC (rev 1041)
+++ trunk/src/CacheWolf/Log.java	2007-11-02 21:29:19 UTC (rev 1042)
@@ -31,8 +31,12 @@
 			logger=logLine.substring(l1,l2);
 			message=logLine.substring(l2+4);
 		} catch (Exception ex) {
-			Global.getPref().log("Error parsing log: "+logLine);
-			icon=INVALIDLOGICON;
+			if (logLine.indexOf("<img")<0) { // Have we reached the line that states max logs reached 
+				icon=MAXLOGICON; 
+			} else {
+				Global.getPref().log("Error parsing log: "+logLine);
+				icon=INVALIDLOGICON;
+			}	
 			date="1900-00-00";
 			logger=message="";
 		}



From pfeffer at mail.berlios.de  Sat Nov  3 01:53:18 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sat, 3 Nov 2007 01:53:18 +0100
Subject: [Cachewolf-svn] r1043 - in trunk: res_noewe src/CacheWolf
	src/CacheWolf/navi
Message-ID: <200711030053.lA30rIYM023862@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-03 01:52:58 +0100 (Sat, 03 Nov 2007)
New Revision: 1043

Added:
   trunk/res_noewe/luftbild-nrw.wms
Modified:
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/navi/Area.java
   trunk/src/CacheWolf/navi/MapInfoObject.java
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
WebMapService: all Basics are done. Some Changes still necessary, but mainly only the user interface is still missing :-)

Added: trunk/res_noewe/luftbild-nrw.wms
===================================================================
--- trunk/res_noewe/luftbild-nrw.wms	2007-11-02 21:29:19 UTC (rev 1042)
+++ trunk/res_noewe/luftbild-nrw.wms	2007-11-03 00:52:58 UTC (rev 1043)
@@ -0,0 +1,14 @@
+Name: Luftbild NRW
+MainUrl: http://www.gis2.nrw.de/wmsconnector/wms/luftbild?SERVICE=WMS
+LayersName: Luftbild NRW
+VersionUrlPart: VERSION=1.1.0
+CoordinateReferenceSystemCacheWolf: 31466
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31466
+RequestUrlPart: REQUEST=GetMap
+LayersUrlPart: LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
+StylesUrlPart: STYLES=
+ImageFormatUrlPart: FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 52.7691 E 5.673
+BoundingBoxButtomRightWGS84: N 49.9944 E 10.142
+MinScale: 0.1795783591567183
+MaxScale: 5.611823723647454

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-02 21:29:19 UTC (rev 1042)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-03 00:52:58 UTC (rev 1043)
@@ -34,7 +34,10 @@
 	public static final int UTM = 3;
 	public static final int CW = 4;
 	public static final int REGEX = 5;
+	public static final int LAT_LON = 6;
+	public static final int LON_LAT = 7;
 	
+	
 	/**
 	 * Create CWPoint by using lat and lon 
 	 * @param lat Latitude as decimal
@@ -451,6 +454,10 @@
 	public String getGermanGkCoordinates() {
 		return TransformCoordinates.wgs84ToGkGermany(this).toString(0, "R:", " H:");
 	}
+
+	public String getGermanGkCoordinates(int decimalplaces, String pref, String seperator) {
+		return TransformCoordinates.wgs84ToGkGermany(this).toString(decimalplaces, pref, seperator);
+	}
 	
 	/**
 	 * Method to calculate a projected waypoint
@@ -569,7 +576,22 @@
 		case DMS:	return getNSLetter() + " " + getLatDeg(format) + "? " + getLatMin(format) + "\' " + getLatSec(format) + "\" " 
 						+  getEWLetter() + " " + getLonDeg(format) + "? " + getLonMin(format) + "\' " + getLonSec(format) + "\"";
 		case UTM:	return getUTMZone()  + " E " + getUTMEasting()+ " N " + getUTMNorthing();
-
+		case LON_LAT:
+			Double latD = new Double();
+			latD.decimalPlaces = 8;
+			latD.set(latDec);
+			Double lonD = new Double();
+			lonD.decimalPlaces = 8;
+			lonD.set(lonDec);
+			return latD.toString().replace(',', '.') + "," + lonD.toString().replace(',', '.');
+		case LAT_LON:
+			Double latD2 = new Double();
+			latD2.decimalPlaces = 8;
+			latD2.set(latDec);
+			Double lonD2 = new Double();
+			lonD2.decimalPlaces = 8;
+			lonD2.set(lonDec);
+			return  lonD2.toString().replace(',', '.') + "," + latD2.toString().replace(',', '.');
 		default: return "Unknown Format: " + format;
 
 		}

Modified: trunk/src/CacheWolf/navi/Area.java
===================================================================
--- trunk/src/CacheWolf/navi/Area.java	2007-11-02 21:29:19 UTC (rev 1042)
+++ trunk/src/CacheWolf/navi/Area.java	2007-11-03 00:52:58 UTC (rev 1043)
@@ -134,4 +134,8 @@
 		 if (boundingbox.length() <= q.length() ) return q.startsWith(boundingbox);
 		 else return boundingbox.startsWith(q);
 	 }
+	 
+	 public String toString() {
+		 return topleft.toString() + ", " + buttomright.toString();
+	 }
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapInfoObject.java
===================================================================
--- trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-02 21:29:19 UTC (rev 1042)
+++ trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-03 00:52:58 UTC (rev 1043)
@@ -14,6 +14,7 @@
 import ewe.io.PrintWriter;
 import ewe.sys.*;
 
+
 /**
  * class to read, save and do the calculations for calibrated and calibrating maps
  * @author pfeffer
@@ -420,4 +421,9 @@
 		this.lonDec = lon;
 		this.utmValid = false;
 	}
+	public GCPoint(CWPoint ll, Point px) {
+		super(ll);
+		bitMapX = px.x;
+		bitMapY = px.y;
+	}
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-02 21:29:19 UTC (rev 1042)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-03 00:52:58 UTC (rev 1043)
@@ -10,26 +10,29 @@
 import ewe.sys.*;
 import ewe.sys.Double;
 import ewe.net.*;
+import java.lang.Math;
 
 /**
-*
-*/
+ *
+ */
 
-// Um Karten zu holen!
-// http://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz.&CenP=48.09901667,11.35688333&Lang=EUR0407&Alti=1&Size=600,600&Offs=0.000000,0.000000&Pins=|5748|
-// oder
-// http://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz.&CenP=48.15,11.5833&Alti=2&Lang=EUR0407&Size=900,900&Offs=0,0&MapS=0&Pins=|48.15,11.5833|4|48.15,11.5833&Pins=|48.15,11.5833|1|48.15,%2011.5833||
+//Um Karten zu holen!
+//http://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz.&CenP=48.09901667,11.35688333&Lang=EUR0407&Alti=1&Size=600,600&Offs=0.000000,0.000000&Pins=|5748|
+//oder
+//http://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz.&CenP=48.15,11.5833&Alti=2&Lang=EUR0407&Size=900,900&Offs=0,0&MapS=0&Pins=|48.15,11.5833|4|48.15,11.5833&Pins=|48.15,11.5833|1|48.15,%2011.5833||
 
 
 public class MapLoader {
 	String proxy = new String();
 	String port = new String();
 	InfoBox progressInfobox;
-	
+
 	final static float downloadMapScaleFactorExpedia_east = 3950;
 	final static float MAPBLAST_METERS_PER_PIXEL = 1.0f/2817.947378f;
 	final static float EXPEDIA_METERS_PER_PIXEL = downloadMapScaleFactorExpedia_east * MAPBLAST_METERS_PER_PIXEL; 
 
+	Vector onlineMapServices = new Vector();
+
 	int numMapsY;
 	int numMapsX;
 	double latinc;
@@ -44,7 +47,7 @@
 		proxy = prxy;
 		progressInfobox = null;
 	}
-	
+
 	/**
 	 * download maps from expedia at zoomlevel alti and save the maps and the .wfl 
 	 * in path
@@ -61,50 +64,50 @@
 		double metersPerLon = metersPerLat * java.lang.Math.cos(center.latDec/180*java.lang.Math.PI);
 		topleft = new CWPoint(center.latDec + (radius / metersPerLat), center.lonDec - (radius / metersPerLon));
 		buttomright = new CWPoint(center.latDec - (radius / metersPerLat), center.lonDec + (radius / metersPerLon));
-		
+
 		this.setTiles(topleft, buttomright, scale, size, overlapping);
 	}
-	
+
 	public void setTiles(CWPoint toplefti, CWPoint buttomrighti, int scale, Point size, int overlapping) {
 		//if (toplefti.latDec <= buttomrighti.latDec || toplefti.lonDec >= toplefti.lonDec) throw new IllegalArgumentException("topleft must be left and above buttom right");
 		topleft = new CWPoint(toplefti);
 		buttomright = new CWPoint(buttomrighti);
 		double metersPerLat = (1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0)));
 		double metersPerLon = metersPerLat * java.lang.Math.cos((toplefti.latDec + buttomright.latDec)/2/180*java.lang.Math.PI);
-		
+
 		double pixelsPerLat = metersPerLat / (EXPEDIA_METERS_PER_PIXEL * scale);
 		double pixelsPerLon = metersPerLon / (EXPEDIA_METERS_PER_PIXEL * scale);
 
 		//over all pixelsize without borders
 		double pixelsY = (topleft.latDec - buttomright.latDec) * pixelsPerLat; 
 		double pixelsX = -(topleft.lonDec - buttomright.lonDec) * pixelsPerLon ; 
-		
+
 		//border sizes around given area and overlapping between tiles
 		//int borderX = (int) java.lang.Math.round((float)size.x * (overlapping - 1.0));
 		//int borderY = (int) java.lang.Math.round((float)size.y * (overlapping - 1.0));
 		int borderX = overlapping;
 		int borderY = overlapping;
-		
+
 		numMapsY = (int) java.lang.Math.ceil( (pixelsY + (float)borderY) / (float)(size.y - borderY) );
 		numMapsX = (int) java.lang.Math.ceil( (pixelsX + (float)borderX) / (float)(size.x - borderX) );
-		
+
 		//increments calulated from pixel offset of tiles
 		latinc = (float)-(size.y - borderY) / pixelsPerLat;
 		loninc = (float)(size.x - borderX) / pixelsPerLon;
-		
+
 		//calculation of centre of first tile
-		
+
 		//additional size for borders and rounding
 		double oversizeX = (float)(numMapsX * (size.x - borderX) + borderX) - pixelsX;
 		double oversizeY = (float)(numMapsY * (size.y - borderY) + borderY) - pixelsY;
-		
+
 		//offset for upper left corner
 		double offsetLat = -( ((float)size.y - oversizeY) / 2.0 ) / pixelsPerLat;
 		double offsetLon = ( ((float)size.x - oversizeX) / 2.0 ) / pixelsPerLon;
-		
+
 		topleft.latDec += offsetLat;
 		topleft.lonDec += offsetLon;
-		
+
 		this.tilesSize = new Point();
 		this.tilesSize.set(size);
 		this.tileScale = scale;
@@ -124,12 +127,12 @@
 			lat += latinc;
 		}
 	}
-	
+
 	/*
 	public void loadTo(String a, String b) {
 		//loadTo(a, b, "50.74", "7.095");
 	}
-	*/
+	 */
 
 	public void setProgressInfoBox (InfoBox progrssInfoboxi) {
 		progressInfobox = progrssInfoboxi;
@@ -146,7 +149,7 @@
 		//loadTo((topleft.latDec + buttomright.latDec)/2, (topleft.lonDec + buttomright.lonDec)/2, scaleO, size.x, size.y, path+"/expedia_alti"+scaleO+"_lat"+latD.toString()+"_lon"+lonD.toString());
 		return scaleO;
 	}
-	
+
 	public static String createExpediaFilename(double lat, double lon, int alti) {
 		Double latD = new Double(), lonD = new Double();
 		latD.decimalPlaces = 4;
@@ -155,7 +158,7 @@
 		lonD.set(lon);
 		return "expedia_alti"+alti+"_lat"+latD.toString().replace(',', '.')+"_lon"+lonD.toString().replace(',', '.')+".gif";
 	}
-	
+
 	public void downloadMap(double lat, double lon, int alti, int PixelWidth, int PixelHeight, String path){
 		loadTo(lat, lon, alti, PixelWidth, PixelHeight, path+"/"+createExpediaFilename(lat, lon, alti));
 	}
@@ -244,9 +247,108 @@
 			(new MessageBox("Error", "Error while downloading or saving map:\n"+e.getMessage(), MessageBox.OKB)).exec();
 		}
 		try {
-		cal.saveWFL(dateiF.getDrivePath(), cal.fileNameWFL);
+			cal.saveWFL(dateiF.getDrivePath(), cal.fileNameWFL);
 		} catch (IOException e) {
 			(new MessageBox("Error", "Error saving calibration file:\n"+e.getMessage(), MessageBox.OKB)).exec();
 		}
 	}
+}
+
+class OnlineMapService {
+	String name;
+	String MainUrl; //http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS
+}
+
+class WebMapService extends OnlineMapService {
+	String layersName;
+	String layersUrlPart; //
+	String versionUrlPart; // VERSION=1.1.0
+	int coordinateReferenceSystem; // WGS84: 4326, German GK: 31466 / 
+	String coordinateReferenceSystemUrlPart; //&SRS=EPSG:31466
+	String requestUrlPart;
+	String imageFormatUrlPart; // FORMAT=image/png
+	String stylesUrlPart; // STYLES=
+	Area boundingBox;
+	double minscale;
+	double maxscale;
+	
+	public WebMapService (String filename) throws IOException, IllegalArgumentException{
+		FileInputStream in = new FileInputStream(filename + ".wms");
+		Properties wms = new Properties();
+		wms.load(in);
+		in.close();
+		name = wms.getProperty("Name", null);
+		if (name == null) throw new IllegalArgumentException("WebMapService: property >Name:< missing in file:\n" + filename);
+		MainUrl = wms.getProperty("MainUrl", null);
+		if (MainUrl == null) throw new IllegalArgumentException("WebMapService: property >MainUrl:< missing in file:\n" + filename);
+		layersName = wms.getProperty("LayersName", "missing layersname");
+		layersUrlPart = wms.getProperty("LayersUrlPart", "");
+		versionUrlPart = wms.getProperty("VersionUrlPart", "");
+		coordinateReferenceSystem = Convert.toInt(wms.getProperty("CoordinateReferenceSystemCacheWolf", "0"));
+		if (!TransformCoordinates.isSupported(coordinateReferenceSystem)) throw new IllegalArgumentException("Coordinate reference system not supported by CacheWolf:\n" + coordinateReferenceSystem);
+		coordinateReferenceSystemUrlPart = wms.getProperty("CoordinateReferenceSystemUrlPart", null);
+		if (coordinateReferenceSystemUrlPart == null) throw new IllegalArgumentException("CoordinateReferenceSystemUrlPart: property >MainUrl:< missing in file:\n" + filename);
+		requestUrlPart = wms.getProperty("RequestUrlPart", "");
+		imageFormatUrlPart = wms.getProperty("ImageFormatUrlPart", "REQUEST=GetMap");
+		stylesUrlPart = wms.getProperty("StylesUrlPart", "");
+		String topleftS = wms.getProperty("BoundingBoxTopLeftWGS84", "");
+		String buttomrightS = wms.getProperty("BoundingBoxButtomRightWGS84", "");
+		CWPoint topleft = new CWPoint(topleftS);
+		CWPoint buttomright = new CWPoint(buttomrightS);
+		if (!topleft.isValid()) topleft.set(90, -180);
+		if (!buttomright.isValid()) buttomright.set(-90, 180);
+		boundingBox = new Area (topleft, buttomright);
+		minscale = Convert.toDouble(wms.getProperty("MinScale", "0"));
+		maxscale = Convert.toDouble(wms.getProperty("MaxScale", Convert.toString(java.lang.Double.MAX_VALUE)));
+	}
+
+	public String getUrlForBoundingBox(Area maparea, Point pixelsize) {
+		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + "not covered by service: " + name + "service area: " + boundingBox.toString());
+		double scale = maparea.buttomright.getDistance(maparea.topleft) * 1000 / Math.sqrt(pixelsize.x * pixelsize.x + pixelsize.y * pixelsize.y); // meters per pixel measured diagonal
+		if ( scale < minscale || scale > maxscale) throw new IllegalArgumentException("scale not support by online map service: " + scale + "\n supported scale range: " + minscale + "-" + maxscale);
+		// http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetMap&SRS=EPSG:31466&BBOX=2577567.0149,5607721.7566,2578567.0077,5608721.7602&WIDTH=500&HEIGHT=500&LAYERS=Raster:TK25_KMF:Farbkombination&STYLES=&FORMAT=image/png
+		CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
+		CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
+		String bbox = "BBOX=";
+		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem)) 
+			bbox += buttomleft.getGermanGkCoordinates(3, "",",") + "," + topright.getGermanGkCoordinates(3, "", ",");
+		else if (coordinateReferenceSystem == TransformCoordinates.EPSG_WGS84) 
+			bbox += buttomleft.toString(CWPoint.LON_LAT)  + "," + topright.toString(CWPoint.LON_LAT);
+		else throw new IllegalArgumentException("Coordinate system not supported by cachewolf: " + coordinateReferenceSystem);
+		String ret = MainUrl + "&"+ versionUrlPart + "&" + requestUrlPart + "&" + 
+		coordinateReferenceSystemUrlPart + "&" + bbox + 
+		"&WIDTH=" + pixelsize.x + "&HEIGHT=" + pixelsize.y + "&" + 
+		layersUrlPart + "&" + stylesUrlPart + "&" + imageFormatUrlPart; 
+		return ret;
+	}
+
+	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
+		Vector georef = new Vector(4);
+
+		// calculate a rectangle in the according coordinate reference system
+		CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
+		CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
+		CWPoint topleft;
+		CWPoint buttomright;
+		if (coordinateReferenceSystem == 31466 || coordinateReferenceSystem == 31467) {
+			GkPoint buttomleftgk = TransformCoordinates.wgs84ToGkGermany(buttomleft);
+			GkPoint toprightgk = TransformCoordinates.wgs84ToGkGermany(topright);
+			GkPoint topleftgk = new GkPoint(buttomleftgk.easting, toprightgk.northing);
+			GkPoint buttomrightgk = new GkPoint(toprightgk.easting, buttomleftgk.northing);
+			topleft = TransformCoordinates.gkGermanyToWgs84(topleftgk);
+			buttomright = TransformCoordinates.gkGermanyToWgs84(buttomrightgk);
+		} else if (coordinateReferenceSystem == 4326) {
+			topleft = maparea.topleft;
+			buttomright = maparea.buttomright;
+		} else throw new IllegalArgumentException("getMapInfoObject: Coordinate system not supported by cachewolf: " + coordinateReferenceSystem);
+
+		georef.add(new GCPoint(topleft, new Point(0, 0)));
+		georef.add(new GCPoint(buttomright, new Point(pixelsize.x, pixelsize.y)));
+		georef.add(new GCPoint(buttomleft, new Point(0, pixelsize.y)));
+		georef.add(new GCPoint(topright, new Point(pixelsize.x, 0)));
+		
+		MapInfoObject ret = new MapInfoObject();
+		ret.evalGCP(georef, pixelsize.x, pixelsize.y);
+		return ret;
+	}
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-02 21:29:19 UTC (rev 1042)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-03 00:52:58 UTC (rev 1043)
@@ -21,11 +21,17 @@
  *
  */
 public class TransformCoordinates {
-	
+
+	public static final int EPSG_WGS84 = 4326; 
+	public static final int EPSG_GK2 = 31466; 
+	public static final int EPSG_GK3 = 31467; 
+	public static final int EPSG_GK4 = 31468; 
+	public static final int EPSG_GK5 = 31469; 
+
 	private static final Ellipsoid BESSEL = new Ellipsoid(6377397.155, 6356078.962);
 	private static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
-	
 
+
 	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 4 = Deutschland Nord"
 	private static final TransformParameters GK_NORD_GERMANY_TO_WGS84 = new TransformParameters(590.5, 69.5, 411.6, 0.796, 0.052, 3.601, 8.300, false);
 	/** use this for nord Germany, maximum deviation unknown */
@@ -45,7 +51,7 @@
 	private static final TransformParameters GK_NRW_GERMANY_TO_WGS84 = new TransformParameters(566.1, 116.3, 390.1, -1.11, -0.24, 3.76, 12.6, false);
 	/** use this for NRW in Germany. Deviations less than 34 cm */
 	public static final TransformParameters GK_NRW_GERMANY =  GK_NRW_GERMANY_TO_WGS84; 
-	
+
 	// taken from http://www.lverma.nrw.de/produkte/druckschriften/verwaltungsvorschriften/images/gps/TrafopsNRW.pdf for NRW this transform has deviations lower than 113cm.
 	// these matches to  http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 3 = Deutschland 1995"
 	private static final TransformParameters GK_GERMANY_1995_TO_WGS84 = new TransformParameters(582, 105, 414, -1.04, -0.35, +3.08, 8.3, false);
@@ -60,11 +66,33 @@
 	// take from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 2 = Deutschland 2001"
 	private static final TransformParameters GK_GERMANY_2001_TO_WGS84 = new TransformParameters(598.1, 73.7, 418.2, -0.202, -0.045, 2.455, 6.700, false);
 	/** Use this for Germany if there is no more specific available. maximal deviations unknown */
-	public static final TransformParameters GK_GERMANY_2001 =  GK_GERMANY_2001_TO_WGS84; 
+	public static final TransformParameters GK_GERMANY_2001 =  GK_GERMANY_2001_TO_WGS84;
 
-	
 
 	private TransformCoordinates() {} // as all members are static, so avoid instantiation
+
+	public static boolean isGermanGk(int epsgcode) {
+		boolean ret = false;
+		switch (epsgcode) {
+		case EPSG_GK2:
+		case EPSG_GK3:
+		case EPSG_GK4:
+		case EPSG_GK5: ret = true; 
+		}
+		return ret;
+	}
+
+	public static boolean isSupported(int epsgcode) {
+		boolean ret = false;
+		switch (epsgcode) {
+		case EPSG_WGS84:
+		case EPSG_GK2:
+		case EPSG_GK3:
+		case EPSG_GK4:
+		case EPSG_GK5: ret = true; 
+		}
+		return ret;
+	}
 	
 	/**
 	 * This is the most abstract method: If you don't know 
@@ -76,7 +104,7 @@
 	public static CWPoint gkGermanyToWgs84(GkPoint gk) {
 		return  gkToWgs84(gk, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
 	}
-	
+
 	/**
 	 * This is the most abstract method: If you don't know 
 	 * when to use another one (if you are in need to do so, you will
@@ -116,7 +144,7 @@
 		CWPoint wgsll = Xyz2Latlon(wgs84xyz, WGS84);
 		return wgsll;
 	}
-	
+
 	private static XyzCoordinates latLon2xyz(CWPoint ll, double alt, Ellipsoid ellipsoid) {
 		if (!ll.isValid()) throw new IllegalArgumentException("latLon2xyz: invalid lat-lon");
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
@@ -127,7 +155,7 @@
 		ret.z = (N * Math.pow(ellipsoid.b, 2) / Math.pow(ellipsoid.a , 2) + alt) * Math.sin(ll.latDec /180*Math.PI);
 		return ret;
 	}
-	
+
 	private static XyzCoordinates transform(XyzCoordinates from, TransformParameters transParams) {
 		Matrix coos = new Matrix(3, 1);
 		coos.matrix[0][0] = from.x;
@@ -138,9 +166,9 @@
 		shift.matrix[0][0] = transParams.dx;
 		shift.matrix[1][0] = transParams.dy;
 		shift.matrix[2][0] = transParams.dz;
-		
+
 		coos.add(shift);
-		
+
 		Matrix rotate = new Matrix(3,3);
 		rotate.matrix[0][0] = 1;
 		rotate.matrix[1][1] = 1;
@@ -151,14 +179,14 @@
 		rotate.matrix[1][2] = transParams.ex;
 		rotate.matrix[2][0] = - rotate.matrix[0][2];
 		rotate.matrix[2][1] = - rotate.matrix[1][2];
-		
+
 		rotate.Multiply(coos);
 		coos = rotate;
 		coos.MultiplyByScalar(transParams.s); // scale
-		
+
 		return new XyzCoordinates(coos.matrix[0][0], coos.matrix[1][0], coos.matrix[2][0]);
 	}
-	
+
 	private static CWPoint Xyz2Latlon(XyzCoordinates from, Ellipsoid ellipsoid) {
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
 		double s = Math.sqrt( Math.pow(from.x,2) + Math.pow(from.y,2));
@@ -173,7 +201,7 @@
 		//ret.alt = h;
 		return ret;
 	}
-	
+
 	/**
 	 * Project latlon to Gau?-Kr?ger-Coordinates on ellipsoid
 	 * @param latlon
@@ -194,7 +222,7 @@
 		double N = ellipsoid.a/ Math.sqrt(1- e2 * Math.pow(Math.sin(B),2));
 		double nue = Math.sqrt(Math.pow(ellipsoid.a, 2) / Math.pow(ellipsoid.b, 2)* e2 * Math.pow(Math.cos(B), 2));
 		double t = Math.tan(B);
-		
+
 		double n1 = (ellipsoid.a-ellipsoid.b)/(ellipsoid.a+ellipsoid.b);
 		double n2 = (ellipsoid.a+ellipsoid.b)/2 * (1+ Math.pow(n1, 2)/4 + Math.pow(n1, 4)/64);
 		double n3 = n1 * -3/2 + Math.pow(n1, 3) * 9/16  - Math.pow(n1, 5) * 3/32;
@@ -202,11 +230,11 @@
 		double n5 = Math.pow(n1, 3) * -35/48 + Math.pow(n1, 5) * 105/256;
 		double n6 = Math.pow(n1, 4) * 315/512;
 		double arclength = n2 * (B + n3 * Math.sin(B*2) + n4 * Math.sin(B*4) + n5 * Math.sin(B*6) + n6 * Math.sin(B*8));
-		
+
 		double h1 = t/2 * N * Math.pow(Math.cos(B), 2) * l*l;
 		double h2 = t/24 * N * Math.pow(Math.cos(B),4) * (5 - t*t + 9 * nue*nue + 4*Math.pow(nue, 4)) * Math.pow(l,4);
 		double northing = arclength + h1 + h2;
-		
+
 		double r1 = N * Math.cos(B) * l;
 		double r2 = N/6 * Math.pow(Math.cos(B), 3) * (1-t*t+nue*nue)*l*l*l;
 		double easting = r1 + r2 + stripe / stripewidth * 1000000 + 500000;
@@ -215,7 +243,7 @@
 		ret.northing = northing;
 		return ret;
 	}
-	
+
 	/**
 	 * Converts Gau?-Kr?ger-coordinates into lat/lon on the respective ellipsoid
 	 * @param gkp
@@ -227,7 +255,7 @@
 		double Y0 = Math.floor(gkp.easting / 1000000);
 		double L0 = Y0 * stripewidth; // decimal degree of the center of the stripe
 		double y = gkp.easting - 1000000 * Y0 - 500000;
-		
+
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
 		// note: n1-n6 are similiar to the n1-n6 in projectLatlon2GK, but some term have different factors
 		double n1 = (ellipsoid.a-ellipsoid.b)/(ellipsoid.a+ellipsoid.b);
@@ -239,15 +267,15 @@
 
 		double B0 = gkp.northing / n2;
 		double Bf = B0 + n3 * Math.sin(B0*2) + n4 * Math.sin(B0*4) + n5 * Math.sin(B0*6) + n6 * Math.sin(B0*8);
-		
+
 		double Nf = ellipsoid.a / Math.sqrt (1- e2 * Math.pow(Math.sin(Bf), 2));
 		double nuef = Math.sqrt(ellipsoid.a * ellipsoid.a / ellipsoid.b / ellipsoid.b * e2 * Math.pow(Math.cos(Bf), 2));
 		double tf = Math.tan(Bf);
-		
+
 		double la1 = tf / 2 / Nf/Nf * (-1-nuef*nuef) * y*y;
 		double la2 = tf /24 / Math.pow(Nf, 4) * (5 + 3*tf*tf + 6*nuef*nuef - 6*tf*tf * nuef*nuef - 4*Math.pow(nuef, 4) - 9*tf*tf*Math.pow(nuef, 4)) * Math.pow(y, 4);
-	// these deal this less than the overall calculation precision double la3 = tf /720 / Math.pow(Nf, 6) * (-61 - 90*tf*tf - 45*Math.pow(tf,4) - 107*nuef*nuef + 162*tf*tf * Math.pow(nuef, 2) + 45*Math.pow(tf,4)*tf*Math.pow(nuef, 2)) * Math.pow(y, 6);
-	// these deal this less than the overall calculation precision double la4 = tf /40320 / Math.pow(Nf, 8) * (1385+3663*tf*tf - 4095*Math.pow(tf,4) + 1575*Math.pow(nuef, 6)) * Math.pow(y, 8);
+		// these deal this less than the overall calculation precision double la3 = tf /720 / Math.pow(Nf, 6) * (-61 - 90*tf*tf - 45*Math.pow(tf,4) - 107*nuef*nuef + 162*tf*tf * Math.pow(nuef, 2) + 45*Math.pow(tf,4)*tf*Math.pow(nuef, 2)) * Math.pow(y, 6);
+		// these deal this less than the overall calculation precision double la4 = tf /40320 / Math.pow(Nf, 8) * (1385+3663*tf*tf - 4095*Math.pow(tf,4) + 1575*Math.pow(nuef, 6)) * Math.pow(y, 8);
 		double lat = (Bf + la1 + la2) * 180 / Math.PI;
 
 		double lo1 = 1 / Nf / Math.cos(Bf) * y;
@@ -255,7 +283,7 @@
 		double lon = L0 + (lo1 + lo2) * 180/Math.PI;
 		return new CWPoint(lat, lon);
 	}
-	
+
 }
 
 class XyzCoordinates {
@@ -282,7 +310,7 @@
 	ex, ey, ez,
 	// scale as multiplicator
 	s;
-	
+
 	/**
 	 * 
 	 * @param d shift in meter
@@ -298,7 +326,7 @@
 		s = 1/(1 - si * Math.pow(10, -6));
 		if (invert) invert();
 	}
-	
+
 	public TransformParameters(TransformParameters tp, boolean invert) {
 		dx = tp.dx;	dy = tp.dy;	dz = tp.dz;
 		ex = tp.ex;	ey = tp.ey;	ez = tp.ez;



From bilbowolf at mail.berlios.de  Sat Nov  3 21:25:11 2007
From: bilbowolf at mail.berlios.de (bilbowolf at mail.berlios.de)
Date: Sat, 3 Nov 2007 21:25:11 +0100
Subject: [Cachewolf-svn] r1044 - trunk/src/CacheWolf
Message-ID: <200711032025.lA3KPBKS007294@sheep.berlios.de>

Author: bilbowolf
Date: 2007-11-03 21:25:09 +0100 (Sat, 03 Nov 2007)
New Revision: 1044

Modified:
   trunk/src/CacheWolf/Version.java
Log:
Preparing new BE version

Modified: trunk/src/CacheWolf/Version.java
===================================================================
--- trunk/src/CacheWolf/Version.java	2007-11-03 00:52:58 UTC (rev 1043)
+++ trunk/src/CacheWolf/Version.java	2007-11-03 20:25:09 UTC (rev 1044)
@@ -10,7 +10,7 @@
 	static final String VER_MAJOR = "BE";
 	static final String VER_MINOR = "";
 	static final String VER_BUILD = " ";
-	static final String VER_SVN ="$LastChangedRevision$"; // the number is automatically replaced by subversion to the latest versionnumer of this file (svn:keywords LastChangedRevision)
+	static final String VER_SVN ="$LastChangedRevision$"; //  the number is automatically replaced by subversion to the latest versionnumer of this file (svn:keywords LastChangedRevision)
 	
 	/**
 	 * @return



From pfeffer at mail.berlios.de  Tue Nov  6 18:18:38 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 6 Nov 2007 18:18:38 +0100
Subject: [Cachewolf-svn] r1045 - in trunk: res_noewe src/CacheWolf
	src/CacheWolf/navi
Message-ID: <200711061718.lA6HIctg001252@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-06 18:18:11 +0100 (Tue, 06 Nov 2007)
New Revision: 1045

Modified:
   trunk/res_noewe/luftbild-nrw.wms
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/Common.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/navi/Area.java
   trunk/src/CacheWolf/navi/GkPoint.java
   trunk/src/CacheWolf/navi/MapInfoObject.java
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/MapLoaderGui.java
   trunk/src/CacheWolf/navi/MovingMap.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
WMS now complete. Please refer to luftbild-NRW.wms to define your own WMS
Please notice that scales can have a decimal seperator now and that they can be smaller than 1m per pixel are supported by some WMS


Modified: trunk/res_noewe/luftbild-nrw.wms
===================================================================
--- trunk/res_noewe/luftbild-nrw.wms	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/res_noewe/luftbild-nrw.wms	2007-11-06 17:18:11 UTC (rev 1045)
@@ -1,14 +1,49 @@
-Name: Luftbild NRW
-MainUrl: http://www.gis2.nrw.de/wmsconnector/wms/luftbild?SERVICE=WMS
-LayersName: Luftbild NRW
-VersionUrlPart: VERSION=1.1.0
-CoordinateReferenceSystemCacheWolf: 31466
-CoordinateReferenceSystemUrlPart: SRS=EPSG:31466
-RequestUrlPart: REQUEST=GetMap
-LayersUrlPart: LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
-StylesUrlPart: STYLES=
-ImageFormatUrlPart: FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84: N 52.7691 E 5.673
-BoundingBoxButtomRightWGS84: N 49.9944 E 10.142
-MinScale: 0.1795783591567183
-MaxScale: 5.611823723647454
+# This is an example and explantion of an wms definition file.
+# You can add your own .wms file to the program directory of
+# cachwolf and the new service will be available in the download maps dialog
+#
+# For a list of WMS Services available in Germany see: http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+# This example is made up from there "Digitales Orthophoto" under section "Nordrhein-Westfalen"
+# download the getCapabilieties URL, save and open it in a text editor. 
+# used here: http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+# 
+#friendly name, choose yourself
+Name:	Luftbild NRW 
+# taken from getCapabilieties answer: <HTTP><GET><OnlineResource xlink:href=
+MainUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild? 
+#friendly name of the layer combination, choose yourself
+LayersName: 
+# this is fix
+ServiceTypeUrlPart:	SERVICE=WMS 
+# taken from the getCapabilities request: <WMT_MS_Capabilities version=
+VersionUrlPart:	VERSION=1.1.0 
+# The EPSG-Code, supported by cachewolf: german gau?-kr?ger (31466, 31467, 31468, 31469) and WGS84 (4326)
+# You get a list of supported coordinate systems in the getCapabilieties answer under <Layer><SRS>
+# plases feel free to ask for another coordinate system to be supported by cachewolf if you need it
+CoordinateReferenceSystemCacheWolf:	31466 
+# this usually will match the number above
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466
+# Post not supported by Cachewolf --> dont change this
+RequestUrlPart:	REQUEST=GetMap
+# comma seperated (without spaces) list of layers to combine
+# all of supported layers you get from the getCapabilities request <Layer><Name>
+# these names are to be used. Special characters must be URL-encode
+LayersUrlPart:	LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
+# if the WMS supports different rendering styles, select the one you need here
+# comma seperated (without spaces) list of style commands for map rendering (do not delete this item even if it is empty
+StylesUrlPart:	STYLES=
+# format, dont forget to set ImageFileExtension accordingly
+# you get a list of supported image formats from getCapabilieties answer: <GetMap><Format>
+ImageFormatUrlPart:	FORMAT=image/jpeg
+# Limits of the service in WGS84 coordinates. 
+# You can use any format here, which is accepted by the input coordinates dialog in cachewolf
+# taken from getCapabilieties answer: <BoundingBox SRS="EPSG:4326", dont forget to add "N"/"S" and "E"/"W"
+BoundingBoxTopLeftWGS84:	N 52.7691 E 5.673
+BoundingBoxButtomRightWGS84:	N 49.9944 E 10.142
+# scale range that the service supports in meters per pixel (measured diagonal)
+# taken from the getCapabilities request "<Layer><ScaleHint min="
+MinScale:	0.1795783591567183
+MaxScale:	5.611823723647454
+# set this according to ImageFormatUrlPart
+ImageFileExtension: .jpg
+

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -281,6 +281,19 @@
 	}
 	
 	/**
+	 * shift the point
+	 * @param meters positiv to north (east), negativ to south (west)
+	 * @param direction 0 north-south, 1 east-west
+	 */
+	public void shift(double meters, int direction) {
+		double meters2deglon = 1/(1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0)));
+		switch (direction) { // TODO use ellipsoid distance calculations for better accuracy
+			case 0: latDec += meters *  meters2deglon; return;
+			case 1: lonDec += meters * (meters2deglon / Math.cos(latDec / 180 * Math.PI));return;
+		}
+	}
+
+	/**
 	 * mark the Point as invalid
 	 *
 	 */
@@ -577,21 +590,9 @@
 						+  getEWLetter() + " " + getLonDeg(format) + "? " + getLonMin(format) + "\' " + getLonSec(format) + "\"";
 		case UTM:	return getUTMZone()  + " E " + getUTMEasting()+ " N " + getUTMNorthing();
 		case LON_LAT:
-			Double latD = new Double();
-			latD.decimalPlaces = 8;
-			latD.set(latDec);
-			Double lonD = new Double();
-			lonD.decimalPlaces = 8;
-			lonD.set(lonDec);
-			return latD.toString().replace(',', '.') + "," + lonD.toString().replace(',', '.');
+			return Common.DoubleToString(lonDec, 8) +  "," + Common.DoubleToString(latDec, 8);
 		case LAT_LON:
-			Double latD2 = new Double();
-			latD2.decimalPlaces = 8;
-			latD2.set(latDec);
-			Double lonD2 = new Double();
-			lonD2.decimalPlaces = 8;
-			lonD2.set(lonDec);
-			return  lonD2.toString().replace(',', '.') + "," + latD2.toString().replace(',', '.');
+			return Common.DoubleToString(latDec, 8) +  "," + Common.DoubleToString(lonDec, 8);
 		default: return "Unknown Format: " + format;
 
 		}

Modified: trunk/src/CacheWolf/Common.java
===================================================================
--- trunk/src/CacheWolf/Common.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/Common.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -109,6 +109,7 @@
 	
 	public static String ClearForFileName(String str) {
 		String ret = str.replace('?', '_');
+		ret = str.replace(' ', '-');
 		return ret;
 	}
 	
@@ -141,5 +142,13 @@
 		if (dot < 0) return "";
 		return fn.substring(dot, fn.length());
 	}
+	
+	public static String DoubleToString(double d, int decimalplaces) {
+		ewe.sys.Double e = new ewe.sys.Double();
+		e.set(d);
+		e.decimalPlaces = decimalplaces;
+		return e.toString().replace(',', '.');
 
+	}
+
 }

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -368,7 +368,7 @@
     // Maps
 	//////////////////////////////////////////////////////////////////////////////////////
 
-	public String mapsPath = "maps/standard";
+	private static final String mapsPath = "maps/standard";
 	
 	/**
 	 * Gibt den vom Benutzer gesetzten Pfad zu den Maps
@@ -378,8 +378,11 @@
 	   return customMapsPath;	
 	}
 	
-	void saveCustomMapsPath(String mapspath) {
-		customMapsPath=mapsPath;
+	public void saveCustomMapsPath(String mapspath_) {
+		if (!customMapsPath.equals(mapspath_)) {
+			customMapsPath=new String(mapspath_);
+			savePreferences();
+		}
 	}
 	
 	/**
@@ -391,25 +394,33 @@
 	 * it returns  <baseDir>/maps/expedia - the place where
 	 * the automatically downloaded maps are placed.
 	 * 
-	 * Later the maps-path shall be saved in the preferences
+	 * 
 	 */
 	public String getMapLoadPath() {
+		saveCustomMapsPath(getMapLoadPathInternal());
+		return getCustomMapsPath();
+	}
+	private String getMapLoadPathInternal() {
 		// here could also a list of map-types displayed...
 		// standard dir
-		File t = new FileBugfix(getMapManuallySavePath(false));
+		String ret = getCustomMapsPath(); 
+		if (ret != null) return ret; 
+		ret = getMapManuallySavePath(false);
+		File t = new FileBugfix(ret);
 		String[] f = t.list("*.wfl", File.LIST_ALWAYS_INCLUDE_DIRECTORIES | File.LIST_FILES_ONLY);
 		if (f != null && f.length > 0) return  baseDir + mapsPath;
 		f = t.list("*.wfl", File.LIST_DIRECTORIES_ONLY | File.LIST_ALWAYS_INCLUDE_DIRECTORIES);
 		if (f != null && f.length > 0) { // see if in a subdir of <baseDir>/maps/standard are .wfl files
 			String[] f2;
 			for (int i = 0; i< f.length; i++) {
-				t.set(null, getMapManuallySavePath(false)+"/"+f[i]);
+				t.set(null, ret+"/"+f[i]);
 				f2 = t.list("*.wfl", File.LIST_FILES_ONLY);
-				if (f2 != null && f2.length > 0) return  getMapManuallySavePath(false);
+				if (f2 != null && f2.length > 0) return  ret;
 			}
 		}
 		// lagacy dir 
-		t.set(null, File.getProgramDirectory() + "/maps");
+		ret = File.getProgramDirectory() + "/maps";
+		t.set(null, ret);
 		f = t.list("*.wfl", File.LIST_FILES_ONLY);
 		if (f != null && f.length > 0) {
 			MessageBox inf = new MessageBox("Information", "The directory for calibrated maps \nhas moved in this program version\n to '<profiles directory>/maps/standard'\n Do you want to move your calibrated maps there now?", MessageBox.YESB | MessageBox.NOB);
@@ -418,7 +429,7 @@
 				File spF = new File(sp);
 				if (!spF.exists()) spF.mkdirs();
 				String image;
-				String lagacypath = File.getProgramDirectory() + "/maps/";
+				String lagacypath = ret;
 				for (int i=0; i<f.length; i++) {
 					t.set(null, lagacypath+f[i]);
 					spF.set(null, sp+"/"+f[i]);
@@ -432,7 +443,7 @@
 				t.delete();
 				return sp;
 			}
-			else return  File.getProgramDirectory() + "/maps";
+			else return  ret;
 		}
 		// expedia dir
 		return getMapExpediaLoadPath(); 
@@ -457,9 +468,9 @@
 	/**
 	 * to this path the automatically downloaded maps are saved
 	 */
-	public String getMapExpediaSavePath() {
+	public String getMapDownloadSavePath(String mapkind) {
 		String subdir = Global.getProfile().dataDir.substring(Global.getPref().baseDir.length());
-		String mapsDir = Global.getPref().baseDir + "maps/expedia/" + subdir;
+		String mapsDir = Global.getPref().baseDir + "maps/" + Common.ClearForFileName(mapkind)+ "/" + subdir;
 		if (!(new File(mapsDir).isDirectory())) { // dir exists? 
 			if (new File(mapsDir).mkdirs() == false) // dir creation failed?
 			{(new MessageBox(MyLocale.getMsg(321,"Error"), MyLocale.getMsg(172,"Error: cannot create maps directory: \n")+new File(mapsDir).getParentFile(), MessageBox.OKB)).exec();

Modified: trunk/src/CacheWolf/navi/Area.java
===================================================================
--- trunk/src/CacheWolf/navi/Area.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/Area.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -138,4 +138,8 @@
 	 public String toString() {
 		 return topleft.toString() + ", " + buttomright.toString();
 	 }
+	 
+	 public CWPoint getCenter() {
+		 return new CWPoint((topleft.latDec + buttomright.latDec)/2, (topleft.lonDec + buttomright.lonDec)/2);
+	 }
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/GkPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/GkPoint.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/GkPoint.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -30,4 +30,16 @@
 		e.decimalPlaces = decimalplaces;
 		return prefix + e.toString().replace(',', '.') + seperator + n.toString().replace(',', '.');
 	}
+	
+	/**
+	 * shift the point
+	 * @param meters positiv to north (east), negativ to south (west)
+	 * @param direction 0 north-south, 1 east-west
+	 */
+	public void shift(double meters, int direction) {
+		switch (direction) { // TODO this works corectly only within an 3 degrees stripe
+			case 0: northing += meters; return;
+			case 1: easting += meters; return;
+		}
+	}
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapInfoObject.java
===================================================================
--- trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -32,8 +32,6 @@
 	// lat of lower right corner of image
 
 	public double[] affine = {0,0,0,0};
-	//public double lowlat = 0;
-	//public double lowlon = 0;
 	public double transLatX, transLatY, transLonX, transLonY; // this are needed for the inervers calculation from lat/lon to x/y
 	public CWPoint center = new CWPoint();
 	public float sizeKm = 0; // diagonale
@@ -42,8 +40,11 @@
 	public Point shift = new Point (0,0);
 	public CWPoint OrigUpperLeft; // this is only valid after zooming 
 	public float rotationRad; // contains the rotation of the map == north direction in rad
+	/** full path to the respective worldfile, including ".wfl"*/
 	public String fileNameWFL = new String();
-	public String fileName = new String();
+	/** filename wihout directory */
+//	public String fileName = new String();
+	/** name of the map, introduced to allow 'maps' without an image (empty maps) */ 
 	public String mapName = new String();
 	//private Character digSep = new Character(' ');
 	static private String digSep = MyLocale.getDigSeparator();
@@ -52,7 +53,7 @@
 		//double testA = Convert.toDouble("1,50") + Convert.toDouble("3,00");
 		//if(testA == 4.5) digSep = ","; else digSep = ".";
 	}
-	
+
 	public MapInfoObject(MapInfoObject map) {
 		super (map.topleft, map.buttomright);
 		mapName = map.mapName;
@@ -63,7 +64,7 @@
 		OrigUpperLeft = new CWPoint (map.OrigUpperLeft);
 		zoomFactor = map.zoomFactor;
 		shift.set(map.shift);
-		fileName = new String(map.fileName);
+		//	fileName = new String(map.fileName);
 		fileNameWFL = new String(map.fileNameWFL);
 		mapName = new String(mapName);
 		doCalculations();
@@ -86,8 +87,8 @@
 		topleft.lonDec=0; //left
 		buttomright.latDec = 0; //buttom
 		buttomright.lonDec = 1; //right
-		*/OrigUpperLeft = new CWPoint(topleft);
-		doCalculations();
+		 */OrigUpperLeft = new CWPoint(topleft);
+		 doCalculations();
 	}
 
 	/**
@@ -113,22 +114,35 @@
 		OrigUpperLeft = new CWPoint(topleft);
 		doCalculations();
 	}
-	
+
 	public MapInfoObject(String mapsPath, String thisMap) throws IOException, ArithmeticException {
 		super();
 		loadwfl(mapsPath, thisMap);
 	}
 
+	/**
+	 * 
+	 * @param path
+	 * @param n without ".wfl"
+	 * @return name of the map including fast-find-prefix
+	 */
+	public String setName(String path, String n) {
+		String pref = getFfPrefix();
+		mapName = pref + n;
+		fileNameWFL = path + pref + mapName + ".wfl";
+		return mapName;
+	}
+
 	/** 
 	 * @return the filename of the associated map image, "" if no file is associated, null if associated file could not be found
 	 */
 	public String getImageFilename() {
-		if (fileName == null || fileName.length() > 0) return fileName;
-		if (fileNameWFL.length() == 0) return "";
+		// if (fileName == null || fileName.length() > 0) return fileName; 
+		if (fileNameWFL.length() == 0) return ""; // no image associated (empty map)
 		String n = fileNameWFL.substring(0, fileNameWFL.lastIndexOf("."));
 		return Common.getImageName(n);
 	}
-	
+
 	/**
 	 * Method to load a .wfl-file
 	 * @param mapsPath path to the map inclunding / at the end
@@ -165,7 +179,7 @@
 			buttomright.lonDec = Convert.toDouble(line);
 
 			fileNameWFL = mapsPath + thisMap + ".wfl";
-			fileName = ""; //mapsPath + thisMap + ".png";
+//			fileName = ""; //mapsPath + thisMap + ".png";
 			mapName = thisMap;
 			in.close();
 			if( !topleft.isValid() ) {
@@ -235,7 +249,7 @@
 		affine[1] = beta.matrix[1][0];
 		affine[3] = beta.matrix[2][0];
 		topleft.lonDec = beta.matrix[0][0];
-		
+
 		buttomright = calcLatLon(imageWidth, imageHeight);
 		doCalculations();
 		//Vm.debug("A B C" + affine[0] + " " + affine[2] + " " + affine[4]);
@@ -274,6 +288,11 @@
 		} catch (ArithmeticException ex) { throw new ArithmeticException("Not allowed values in affine\n (matrix cannot be inverted)\n in file \n" + fileNameWFL); }
 	}
 
+	public void saveWFL() throws IOException, IllegalArgumentException {
+		File dateiF = new File(fileNameWFL);
+		String tmp = dateiF.getDrivePath(); // contains the name and the extension
+		saveWFL(tmp, mapName);
+	}
 
 	/**
 	 *	Method to save a world file (.wfl)
@@ -297,14 +316,14 @@
 		if (digSep.equals(",")) towrite=towrite.replace(',', '.');
 		outp.print(towrite);
 		outp.close();
-		this.fileName = ""; // this will be set in getImageFilenam //mapsPath + "/" + mapFileName + ".png";
+//		this.fileName = ""; // this will be set in getImageFilenam //mapsPath + "/" + mapFileName + ".png";
 		this.fileNameWFL = mapsPath + "/" + mapFileName + ".wfl";
 		this.mapName = mapFileName;
 	}
 
 //	public boolean inBound(CWPoint pos){
 	//	boolean isInBound = false;
-		/*
+	/*
 		Vm.debug(mapName);
 		Vm.debug("Top: " + affine[4]);
 		Vm.debug("Bottom: " + lowlat);
@@ -312,8 +331,8 @@
 		Vm.debug("Left: " + affine[5]);
 		Vm.debug("Right: " + lowlon);
 		Vm.debug("Test: " + pos.lonDec);
-		 */
-//		if(topleft.latDec >= pos.latDec && pos.latDec >= buttomright.latDec && topleft.lonDec <= pos.lonDec && pos.lonDec <= buttomright.lonDec) isInBound = true;
+	 */
+//	if(topleft.latDec >= pos.latDec && pos.latDec >= buttomright.latDec && topleft.lonDec <= pos.lonDec && pos.lonDec <= buttomright.lonDec) isInBound = true;
 	//	return isInBound;
 	//}
 
@@ -344,12 +363,12 @@
 		doCalculations(); // TODO lowlat neu berechnen?
 	}
 
-/*	public boolean inBound(double lati, double loni){
+	/*	public boolean inBound(double lati, double loni){
 		boolean isInBound = false;
 		if(topleft.latDec >= lati && lati >= buttomright.latDec && topleft.lonDec <= loni && loni <= buttomright.lonDec) isInBound = true;
 		return isInBound;
 	}
-	*/
+	 */
 	/**
 	 * Method to calculate bitmap x,y of the current map using
 	 * lat and lon target coordinates. There ist no garanty that
@@ -385,7 +404,7 @@
 	public CWPoint calcLatLon(Point p) {
 		return calcLatLon(p.x, p.y);
 	}
-	
+
 	/**
 	 * Get the prefix used for easy and fast finding of the best map
 	 * The filname of the .wfl and respective image should start with this
@@ -395,35 +414,31 @@
 	public String getFfPrefix() {
 		return "FF1"+getEasyFindString()+"E-";
 	}
-	
-/*	public Area getArea(){
-		return new Area(new CWPoint(topleft), new CWPoint(buttomright));
-	} */
 }
 
-/**
- *	Class based on CWPoint but intended to handle bitmap x and y
- *	Used for georeferencing bitmaps.
- */
-class GCPoint extends CWPoint{
-	public int bitMapX = 0;
-	public int bitMapY = 0;
+	/**
+	 *	Class based on CWPoint but intended to handle bitmap x and y
+	 *	Used for georeferencing bitmaps.
+	 */
+	class GCPoint extends CWPoint{
+		public int bitMapX = 0;
+		public int bitMapY = 0;
 
-	public GCPoint(){
-	}
+		public GCPoint(){
+		}
 
-	public GCPoint(CWPoint p) {
-		super(p);
-	}
+		public GCPoint(CWPoint p) {
+			super(p);
+		}
 
-	public GCPoint(double lat, double lon){
-		this.latDec = lat;
-		this.lonDec = lon;
-		this.utmValid = false;
-	}
-	public GCPoint(CWPoint ll, Point px) {
-		super(ll);
-		bitMapX = px.x;
-		bitMapY = px.y;
-	}
-}
\ No newline at end of file
+		public GCPoint(double lat, double lon){
+			this.latDec = lat;
+			this.lonDec = lon;
+			this.utmValid = false;
+		}
+		public GCPoint(CWPoint ll, Point px) {
+			super(ll);
+			bitMapX = px.x;
+			bitMapY = px.y;
+		}
+	}
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -1,8 +1,10 @@
 package CacheWolf.navi;
 
 import CacheWolf.CWPoint;
+import CacheWolf.Common;
 import CacheWolf.HttpConnection;
 import CacheWolf.InfoBox;
+import CacheWolf.Preferences;
 import ewe.ui.*;
 import ewe.io.*;
 import ewe.fx.*;
@@ -12,6 +14,8 @@
 import ewe.net.*;
 import java.lang.Math;
 
+import utils.FileBugfix;
+
 /**
  *
  */
@@ -27,12 +31,8 @@
 	String port = new String();
 	InfoBox progressInfobox;
 
-	final static float downloadMapScaleFactorExpedia_east = 3950;
-	final static float MAPBLAST_METERS_PER_PIXEL = 1.0f/2817.947378f;
-	final static float EXPEDIA_METERS_PER_PIXEL = downloadMapScaleFactorExpedia_east * MAPBLAST_METERS_PER_PIXEL; 
-
 	Vector onlineMapServices = new Vector();
-
+	OnlineMapService currentOnlineMapService;
 	int numMapsY;
 	int numMapsX;
 	double latinc;
@@ -40,15 +40,62 @@
 	CWPoint topleft;
 	CWPoint buttomright;
 	Point tilesSize;
-	int tileScale;
+	float tileScale;
 
 	public MapLoader(String prxy, String prt){
 		port = prt;
 		proxy = prxy;
 		progressInfobox = null;
+		onlineMapServices = new Vector();
+		String dateien[];
+		FileBugfix files = new FileBugfix(".");
+		String FileName;
+		OnlineMapService tempOMS;
+		tempOMS = new ExpediaMapService();
+		onlineMapServices.add(tempOMS);
+		MessageBox f = null; 
+		dateien = files.list("*.wms", File.LIST_FILES_ONLY); //"*.xyz" doesn't work on some systems -> use FileBugFix
+		for(int i = 0; i < dateien.length;i++){
+			FileName = dateien[i];
+			try {
+				tempOMS = new WebMapService(FileName);
+				onlineMapServices.add(tempOMS);
+			}catch(Exception ex){ 
+				if (f == null) (f=new MessageBox("Warning", "Ignoring error while \n reading web map service definition file \n"+ex.toString(), MessageBox.OKB)).exec();
+			}
+		}
+		
 	}
+	
+	public String[] getAvailableOnlineMapServices(){
+		int s = onlineMapServices.size();
+		String[] services = new String[s];
+		for (int i=0; i < s; i++) {
+			services[i]=onlineMapServices.get(i).toString();
+		}
+		return services;
+	}
+	
+	public void setCurrentMapService(int index) {
+		currentOnlineMapService = (OnlineMapService) onlineMapServices.get(index);
+	}
 
 	/**
+	 * calculates the Expedia Alti = scale which fits in distance to its edges
+	 * @param center
+	 * @param distance in meters
+	 * @return meters per pixel calculatet in a way that the circle around center
+	 * is completly within the map
+	 */
+
+	public static float getScale(CWPoint center, float distance, Point size) {
+		float scaleLatO = distance * 2 / size.y;
+		float scaleLonO = distance * 2 / size.x;
+		float scaleO = (scaleLatO < scaleLonO ? scaleLonO : scaleLatO);
+		return scaleO;
+	}
+
+	/**
 	 * download maps from expedia at zoomlevel alti and save the maps and the .wfl 
 	 * in path
 	 * @param center centre of all tiles
@@ -59,7 +106,7 @@
 	 * @param path without "/" at the end
 	 * 
 	 */
-	public void setTiles (CWPoint center, float radius, int scale, Point size, int overlapping) {
+	public void setTiles (CWPoint center, float radius, float scale, Point size, int overlapping) {
 		double metersPerLat = (1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0)));
 		double metersPerLon = metersPerLat * java.lang.Math.cos(center.latDec/180*java.lang.Math.PI);
 		topleft = new CWPoint(center.latDec + (radius / metersPerLat), center.lonDec - (radius / metersPerLon));
@@ -68,16 +115,16 @@
 		this.setTiles(topleft, buttomright, scale, size, overlapping);
 	}
 
-	public void setTiles(CWPoint toplefti, CWPoint buttomrighti, int scale, Point size, int overlapping) {
+	public void setTiles(CWPoint toplefti, CWPoint buttomrighti, float scale, Point size, int overlapping) {
 		//if (toplefti.latDec <= buttomrighti.latDec || toplefti.lonDec >= toplefti.lonDec) throw new IllegalArgumentException("topleft must be left and above buttom right");
 		topleft = new CWPoint(toplefti);
 		buttomright = new CWPoint(buttomrighti);
 		double metersPerLat = (1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0)));
 		double metersPerLon = metersPerLat * java.lang.Math.cos((toplefti.latDec + buttomright.latDec)/2/180*java.lang.Math.PI);
+		double metersperpixel = currentOnlineMapService.getMetersPerPixel(scale);
+		double pixelsPerLat = metersPerLat / metersperpixel;
+		double pixelsPerLon = metersPerLon / metersperpixel;
 
-		double pixelsPerLat = metersPerLat / (EXPEDIA_METERS_PER_PIXEL * scale);
-		double pixelsPerLon = metersPerLon / (EXPEDIA_METERS_PER_PIXEL * scale);
-
 		//over all pixelsize without borders
 		double pixelsY = (topleft.latDec - buttomright.latDec) * pixelsPerLat; 
 		double pixelsX = -(topleft.lonDec - buttomright.lonDec) * pixelsPerLon ; 
@@ -116,40 +163,26 @@
 	public void downlaodTiles(String tilesPath) {
 		double lat = topleft.latDec;
 		double lon = topleft.lonDec;
+		CWPoint center = new CWPoint();
 		for (int row = 1; row <= numMapsY; row++) {
 			lon = topleft.lonDec;
 			for (int col = 1; col <= numMapsX; col++) {
 				if (progressInfobox != null)
-					progressInfobox.setInfo("Downloading calibrated (georeferenced) \n map image from www.expedia.com \n Downloading tile \n row "+row+" / "+numMapsY+" column "+ col + " / "+numMapsX);
-				downloadMap(lat, lon, tileScale, tilesSize.x, tilesSize.y, tilesPath);
+					progressInfobox.setInfo("Downloading calibrated (georeferenced) \n map image \n '" + currentOnlineMapService.getName()+"' \n Downloading tile \n row "+row+" / "+numMapsY+" column "+ col + " / "+numMapsX);
+				center.set(lat, lon);
+				downloadMap(center, tileScale, tilesSize, tilesPath);
+				if (progressInfobox.isClosed) return;
 				lon += loninc;
 			}
 			lat += latinc;
 		}
 	}
 
-	/*
-	public void loadTo(String a, String b) {
-		//loadTo(a, b, "50.74", "7.095");
-	}
-	 */
-
 	public void setProgressInfoBox (InfoBox progrssInfoboxi) {
 		progressInfobox = progrssInfoboxi;
 	}
-	/**
-	 * calculates the Expedia Alti = scale which fits in distance to its edges
-	 * @param center
-	 * @param distance in meters
-	 */
-	public static int getExpediaAlti(CWPoint center, float distance, Point size) {
-		int scaleLatO = (int) java.lang.Math.ceil(( distance * 2 / EXPEDIA_METERS_PER_PIXEL / size.y));
-		int scaleLonO = (int) java.lang.Math.ceil(( distance * 2 / EXPEDIA_METERS_PER_PIXEL / size.x));
-		int scaleO = (scaleLatO < scaleLonO ? scaleLonO : scaleLatO);
-		//loadTo((topleft.latDec + buttomright.latDec)/2, (topleft.lonDec + buttomright.lonDec)/2, scaleO, size.x, size.y, path+"/expedia_alti"+scaleO+"_lat"+latD.toString()+"_lon"+lonD.toString());
-		return scaleO;
-	}
 
+	/*
 	public static String createExpediaFilename(double lat, double lon, int alti) {
 		Double latD = new Double(), lonD = new Double();
 		latD.decimalPlaces = 4;
@@ -158,111 +191,199 @@
 		lonD.set(lon);
 		return "expedia_alti"+alti+"_lat"+latD.toString().replace(',', '.')+"_lon"+lonD.toString().replace(',', '.')+".gif";
 	}
-
 	public void downloadMap(double lat, double lon, int alti, int PixelWidth, int PixelHeight, String path){
 		loadTo(lat, lon, alti, PixelWidth, PixelHeight, path+"/"+createExpediaFilename(lat, lon, alti));
 	}
+	 */
 
-	public void loadTo(double lat, double lon, int alti, int PixelWidth, int PixelHeight, String datei){
-		HttpConnection connImg, conn2;
-		Socket sockImg, sock2;
-		InputStream is;
+	public void downloadMap(Area surArea, Point pixelsize, String path){
+		try {
+			MapInfoObject mio = currentOnlineMapService.getMapInfoObject(surArea, pixelsize);
+			String filename = createFilename(mio.getCenter(), mio.scale);
+			String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
+			String url = currentOnlineMapService.getUrlForBoundingBox(surArea, pixelsize);
+			downloadUrl(url, path+"/"+imagename);
+			mio.saveWFL();
+		} catch (Exception e) {
+			this.progressInfobox.addWarning("Ignoring error during map download, saving or calibration:\n" + e.getMessage()+"\n");
+		}
+	}
+
+	public void downloadMap(CWPoint center, float scale, Point pixelsize, String path){
+		try {
+			MapInfoObject mio = currentOnlineMapService.getMapInfoObject(center, scale, pixelsize);
+			String filename = createFilename(mio.getCenter(), mio.scale);
+			String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
+			String url = currentOnlineMapService.getUrlForCenterScale(center, scale, pixelsize);
+			downloadUrl(url, path+"/"+imagename);
+			mio.saveWFL();
+		} catch (Exception e) {
+			this.progressInfobox.addWarning("Ignoring error during map download, saving or calibration:\n" + e.getMessage()+"\n");
+		}
+	}
+	
+	public String createFilename(CWPoint center, float scale) {
+		String filename = Common.ClearForFileName(currentOnlineMapService.getName()+"_s"+Common.DoubleToString(scale, 1)
+		+ "_c" + center.toString(CWPoint.LAT_LON).replace(',', '-'));
+		return filename;
+	}
+
+	/**
+	 * @param url usual URL. If a redirect is requiered (as in the case of 
+	 * Expedia, add an "R" before "http://" --> Don't download the url, retry until getting a http-redirect
+	 * this is necessary for expedia as it delivers the image only after a http-redirect
+	 * and sometimes doesn't send a redirect on the first try 
+	 * @param datei path and name of file to save to
+	 */
+	public void downloadUrl(String url, String datei){
+		HttpConnection connImg; // TODO move proxy-handling in a global http-class
+		Socket sockImg;
 		FileOutputStream fos;
 		ByteArray daten;
-		String quelle = new String();
-		String zone;
-		// prepare MapInfoObject and get fileprefix
-		File dateiF = new File(datei); // change!!!
-		String tmp = dateiF.getName(); // contains the name and the extension
-		String name = tmp.substring(0, tmp.lastIndexOf("."));
-		float metersPerPixel = (float) (alti)*EXPEDIA_METERS_PER_PIXEL;
-		MapInfoObject cal = new MapInfoObject(metersPerPixel, new CWPoint(lat,lon),  PixelWidth, PixelHeight, name);
-		String pref = cal.getFfPrefix();
-		cal.mapName = pref + cal.mapName;
-		cal.fileNameWFL = pref + cal.fileNameWFL;
-		datei = dateiF.getPath()+"/"+ pref + tmp;
-		// download image
-		if (lon <= -10) zone = "USA0409";
-		else zone = "EUR0809";
-
-		/*
-		 * information from: DownloadMouseMode.properties in project GPSylon ( in directory gpsylon_src-0.5.2\plugins\downloadmousemode\auxiliary\org\dinopolis\gpstool\plugin\downloadmousemode and DownloadMapCalculator.java in Dir gpsylon_src-0.5.2\plugins\downloadmousemode\src\org\dinopolis\gpstool\plugin\downloadmousemode 
-		 * download.map.url.expedia_east=http\://www.expedia.com/pub/agent.dll?qscr=mrdt&ID=3XNsF.&CenP={0,number,#.########},{1,number,#.########}&Lang=EUR0809&Alti={2,number,#}&Size={3,number,#},{4,number,#}&Offs=0.000000,0.000000\&BCheck=1
-		 * download.map.url.expedia_east.title=Url of Expedia Europe
-		 * download.map.scale_factor.expedia_east=3950
-		 */
-		Double latD = new Double();
-		latD.decimalPlaces = 8;
-		latD.set(lat);
-		Double lonD = new Double();
-		lonD.decimalPlaces = 8;
-		lonD.set(lon);
-		quelle = "http://www.expedia.de/pub/agent.dll?qscr=mrdt";
-		quelle = quelle + "&ID=3kQaz.";
-		quelle = quelle + "&CenP=" + latD.toString().replace(',', '.') + "," + lonD.toString().replace(',', '.');
-		quelle = quelle + "&Alti="+Convert.toString(alti)+"&Lang="+zone+"&Size="+Convert.toString(PixelWidth)+","+Convert.toString(PixelHeight)+"&Offs=0,0&MapS=0"; //&Pins=|" + latD.toString().replace(',', '.') + "," + lonD.toString().replace(',', '.') + "|5|";
-		//Vm.debug(lat + "," + lon);
+		String realurl;
+		boolean forceredirect;
+		if (url.startsWith("R")) {
+			forceredirect = true;
+			realurl = url.substring(1, url.length());
+		} else {
+			forceredirect = false;
+			realurl = url;
+		}
 		if(proxy.length()>0){
-			connImg = new HttpConnection(proxy, Convert.parseInt(port), quelle);
+			connImg = new HttpConnection(proxy, Convert.parseInt(port), realurl);
 			//Vm.debug("Loading quelle: " + quelle);
 		}else{
-			connImg = new HttpConnection(quelle);
+			connImg = new HttpConnection(realurl);
 		}
-		//datei = "d:\\temp\\test_map.bmp";
 		connImg.setRequestorProperty("USER_AGENT", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
 		connImg.setRequestorProperty("Connection", "close");
 		connImg.setRequestorProperty("Cookie", "jscript=1; path=/;");
 		connImg.documentIsEncoded = true;
 		try{
-			dateiF = new File(datei);
+			File dateiF = new File(datei);
 			if(!dateiF.exists()){
 				int i=0;
-				quelle = null;
-				while (quelle == null && i < 5) { // this is necessary because expedia sometimes doesn't directly anser with the redirect to the map-image, but give a page in between. Solved the problem by retrying see also: http://www.geoclub.de/viewtopic.php?p=305071#305071
-					sockImg = connImg.connect();
+				sockImg = connImg.connect();
+				String quelle = connImg.getRedirectTo();
+				boolean redirrected = false;
+				while (i < 5 && (quelle != null || (forceredirect && !redirrected))) { // this is necessary because expedia sometimes doesn't directly anser with the redirect to the map-image, but give a page in between. Solved the problem by retrying see also: http://www.geoclub.de/viewtopic.php?p=305071#305071
 					//Vm.debug("Redirect: " + i + connImg.getRedirectTo());
-					quelle = connImg.getRedirectTo();
-					sockImg.close();
+					if (quelle != null) {
+						redirrected = true;
+						sockImg.close();
+						connImg = connImg.getRedirectedConnection(quelle);
+						sockImg = connImg.connect();
+						quelle = connImg.getRedirectTo();
+					}
 					i++;
 				}
 				if (i > 4) throw new IOException("loadTo: failed to download map: didn't get http-redirect");
-				if(proxy.length()>0){
-					connImg = new HttpConnection(proxy, Convert.parseInt(port), quelle);
-				}else{
-					connImg = new HttpConnection(quelle);
-				}
-				connImg.setRequestorProperty("USER_AGENT", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
-				connImg.setRequestorProperty("Connection", "close");
-				connImg.setRequestorProperty("Cookie", "jscript=1; path=/;");
-				connImg.documentIsEncoded = true;
-				sock2 = connImg.connect();
-				daten = connImg.readData(sock2);
+				daten = connImg.readData(sockImg);
 				fos = new FileOutputStream(dateiF);
 				fos.write(daten.toBytes());
 				fos.close();
-				sock2.close();
+				sockImg.close();
 			}
 			//Vm.debug("done");
 		}catch(IOException e){
 			(new MessageBox("Error", "Error while downloading or saving map:\n"+e.getMessage(), MessageBox.OKB)).exec();
 		}
-		try {
-			cal.saveWFL(dateiF.getDrivePath(), cal.fileNameWFL);
-		} catch (IOException e) {
-			(new MessageBox("Error", "Error saving calibration file:\n"+e.getMessage(), MessageBox.OKB)).exec();
-		}
+//		(new MessageBox("Error", "Error saving calibration file:\n"+e.getMessage(), MessageBox.OKB)).exec();
+
 	}
 }
 
 class OnlineMapService {
 	String name;
 	String MainUrl; //http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS
+	/** including "." */
+	String imageFileExt; // ".gif", ".jpg"...
+
+	/** 
+	 * This method is used in case the online map service provides only certain steps of 
+	 * zoomlevels. In this case the scale in meters per pixel must be returned, which
+	 * will be used instead of the wished scale. 
+	 * 
+	 * @param scale
+	 * @return
+	 */
+	public float getMetersPerPixel(float scale) {
+		return scale;
+	}
+
+	public String getImageFileExt() {
+		return imageFileExt;
+	}
+
+	/** 
+	 * Overlaod this to integrate name of layers
+	 * @return friendly service name
+	 */
+	public String getName() {
+		return name;
+	}
+	/**
+	 * Overload this and return the URL to the map image, don't call super
+	 * Alternatively overload getUrlForBoundingBox
+	 * You must overload either this method or getUrlForBoundingBox
+	 * @param center
+	 * @param scale
+	 * @param pixelsize
+	 * @return
+	 */
+	public String getUrlForCenterScale(CWPoint center, float scale, Point pixelsize) {
+		Area bbox = CenterScaleToArea(center, scale, pixelsize);
+		String url = getUrlForBoundingBox(bbox, pixelsize);
+		return url;
+	}
+
+	public String getUrlForBoundingBox(Area surArea, Point pixelsize) {
+		CWPoint center = new CWPoint((surArea.topleft.latDec + surArea.buttomright.latDec)/2, (surArea.topleft.lonDec + surArea.buttomright.lonDec)/2);
+		double radiuslat = (new CWPoint(center.latDec, surArea.buttomright.lonDec)).getDistance(surArea.buttomright);
+		double radiuslon = (new CWPoint(surArea.buttomright.latDec, center.lonDec)).getDistance(surArea.buttomright);
+		float radius, scale;
+		if (radiuslat <= radiuslon) {
+			radius = (float) radiuslon;
+			scale = (float) (radiuslon / (double) pixelsize.x);
+		} else {
+			radius = (float) radiuslat;
+			scale = (float) (radiuslat / (double) pixelsize.y);
+		}
+		String ret = getUrlForCenterScale(center, scale, pixelsize);
+		//int expediaAlti = ((ExpediaMapService)currentOnlineMapService).getZoomlevel(center, radius * 1000, pixelsize);
+		return ret;
+		//throw new IllegalArgumentException("OnlineMapService: getUrlForBoundingBox:\n This method must be overloaded in order to be able to use it");
+	}
+
+	public Area CenterScaleToArea(CWPoint center, float scale, Point pixelsize) {
+		Area bbox = new Area();
+		bbox.topleft = new CWPoint (center);
+		bbox.topleft.shift(-pixelsize.x * scale / 2, 1);
+		bbox.topleft.shift(pixelsize.y * scale /2, 0);
+		bbox.buttomright = new CWPoint (center);
+		bbox.buttomright.shift(pixelsize.x * scale / 2, 1);
+		bbox.buttomright.shift(-pixelsize.y * scale /2, 0);
+		return bbox;
+	}
+	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
+		throw new IllegalArgumentException("OnlineMapService: getMapInfoObject(Area maparea, Point pixelsize):\n This method must be overloaded in order to be able to use it");
+	}
+
+	public MapInfoObject getMapInfoObject(CWPoint center, float scale, Point pixelsize) {
+		return getMapInfoObject(CenterScaleToArea(center, scale, pixelsize), pixelsize);
+		//throw new IllegalArgumentException("OnlineMapService: (CWPoint center, double zoomlevel, Point pixelsize):\n This method must be overloaded in order to be able to use it");
+	}
+	
+	public String toString() {
+		return getName();
+	}
 }
 
 class WebMapService extends OnlineMapService {
 	String layersName;
 	String layersUrlPart; //
 	String versionUrlPart; // VERSION=1.1.0
+	String serviceTypeUrlPart; //"SERVICE=WMS" 
 	int coordinateReferenceSystem; // WGS84: 4326, German GK: 31466 / 
 	String coordinateReferenceSystemUrlPart; //&SRS=EPSG:31466
 	String requestUrlPart;
@@ -271,41 +392,55 @@
 	Area boundingBox;
 	double minscale;
 	double maxscale;
-	
+
+	public String getName() {
+		if (layersName == null || layersName.length() == 0)	return name;
+		return name + "_" + layersName;
+	}
+
+	/**
+	 * 
+	 * @param filename without file extension
+	 * @throws IOException
+	 * @throws IllegalArgumentException
+	 */
 	public WebMapService (String filename) throws IOException, IllegalArgumentException{
-		FileInputStream in = new FileInputStream(filename + ".wms");
+		FileInputStream in = new FileInputStream(filename);
 		Properties wms = new Properties();
 		wms.load(in);
 		in.close();
-		name = wms.getProperty("Name", null);
-		if (name == null) throw new IllegalArgumentException("WebMapService: property >Name:< missing in file:\n" + filename);
-		MainUrl = wms.getProperty("MainUrl", null);
-		if (MainUrl == null) throw new IllegalArgumentException("WebMapService: property >MainUrl:< missing in file:\n" + filename);
-		layersName = wms.getProperty("LayersName", "missing layersname");
-		layersUrlPart = wms.getProperty("LayersUrlPart", "");
-		versionUrlPart = wms.getProperty("VersionUrlPart", "");
-		coordinateReferenceSystem = Convert.toInt(wms.getProperty("CoordinateReferenceSystemCacheWolf", "0"));
+		name = wms.getProperty("Name", "").trim();
+		if (name == "") throw new IllegalArgumentException("WebMapService: property >Name:< missing in file:\n" + filename);
+		MainUrl = wms.getProperty("MainUrl", "").trim();;
+		if (MainUrl == "") throw new IllegalArgumentException("WebMapService: property >MainUrl:< missing in file:\n" + filename);
+		layersName = wms.getProperty("LayersName", "missing layersname").trim();
+		serviceTypeUrlPart = wms.getProperty("ServiceTypeUrlPart", "SERVICE=WMS").trim();
+		layersUrlPart = wms.getProperty("LayersUrlPart", "").trim();;
+		versionUrlPart = wms.getProperty("VersionUrlPart", "").trim();;
+		coordinateReferenceSystem = Convert.toInt(wms.getProperty("CoordinateReferenceSystemCacheWolf", "0").trim());
 		if (!TransformCoordinates.isSupported(coordinateReferenceSystem)) throw new IllegalArgumentException("Coordinate reference system not supported by CacheWolf:\n" + coordinateReferenceSystem);
-		coordinateReferenceSystemUrlPart = wms.getProperty("CoordinateReferenceSystemUrlPart", null);
-		if (coordinateReferenceSystemUrlPart == null) throw new IllegalArgumentException("CoordinateReferenceSystemUrlPart: property >MainUrl:< missing in file:\n" + filename);
-		requestUrlPart = wms.getProperty("RequestUrlPart", "");
-		imageFormatUrlPart = wms.getProperty("ImageFormatUrlPart", "REQUEST=GetMap");
-		stylesUrlPart = wms.getProperty("StylesUrlPart", "");
-		String topleftS = wms.getProperty("BoundingBoxTopLeftWGS84", "");
-		String buttomrightS = wms.getProperty("BoundingBoxButtomRightWGS84", "");
+		coordinateReferenceSystemUrlPart = wms.getProperty("CoordinateReferenceSystemUrlPart", "").trim();
+		if (coordinateReferenceSystemUrlPart == "") throw new IllegalArgumentException("CoordinateReferenceSystemUrlPart: property >MainUrl:< missing in file:\n" + filename);
+		requestUrlPart = wms.getProperty("RequestUrlPart", "REQUEST=GetMap").trim();
+		imageFormatUrlPart = wms.getProperty("ImageFormatUrlPart", "").trim();
+		stylesUrlPart = wms.getProperty("StylesUrlPart", "").trim();
+		String topleftS = wms.getProperty("BoundingBoxTopLeftWGS84", "").trim();
+		String buttomrightS = wms.getProperty("BoundingBoxButtomRightWGS84", "").trim();
 		CWPoint topleft = new CWPoint(topleftS);
 		CWPoint buttomright = new CWPoint(buttomrightS);
 		if (!topleft.isValid()) topleft.set(90, -180);
 		if (!buttomright.isValid()) buttomright.set(-90, 180);
 		boundingBox = new Area (topleft, buttomright);
-		minscale = Convert.toDouble(wms.getProperty("MinScale", "0"));
-		maxscale = Convert.toDouble(wms.getProperty("MaxScale", Convert.toString(java.lang.Double.MAX_VALUE)));
+		minscale = Convert.toDouble(wms.getProperty("MinScale", "0").trim());
+		maxscale = Convert.toDouble(wms.getProperty("MaxScale", Convert.toString(java.lang.Double.MAX_VALUE)).trim());
+		imageFileExt = wms.getProperty("ImageFileExtension", "").trim();
+		if (imageFileExt == "") throw new IllegalArgumentException("WebMapService: property >ImageFileExtension:< missing in file:\n" + filename);
 	}
 
 	public String getUrlForBoundingBox(Area maparea, Point pixelsize) {
-		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + "not covered by service: " + name + "service area: " + boundingBox.toString());
+		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + " not covered by service: " + name + ", service area: " + boundingBox.toString());
 		double scale = maparea.buttomright.getDistance(maparea.topleft) * 1000 / Math.sqrt(pixelsize.x * pixelsize.x + pixelsize.y * pixelsize.y); // meters per pixel measured diagonal
-		if ( scale < minscale || scale > maxscale) throw new IllegalArgumentException("scale not support by online map service: " + scale + "\n supported scale range: " + minscale + "-" + maxscale);
+		if ( scale < minscale || scale > maxscale) throw new IllegalArgumentException("scale not support by online map service: " + scale + ", supported scale range: " + minscale + " - " + maxscale);
 		// http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetMap&SRS=EPSG:31466&BBOX=2577567.0149,5607721.7566,2578567.0077,5608721.7602&WIDTH=500&HEIGHT=500&LAYERS=Raster:TK25_KMF:Farbkombination&STYLES=&FORMAT=image/png
 		CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
 		CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
@@ -315,40 +450,94 @@
 		else if (coordinateReferenceSystem == TransformCoordinates.EPSG_WGS84) 
 			bbox += buttomleft.toString(CWPoint.LON_LAT)  + "," + topright.toString(CWPoint.LON_LAT);
 		else throw new IllegalArgumentException("Coordinate system not supported by cachewolf: " + coordinateReferenceSystem);
-		String ret = MainUrl + "&"+ versionUrlPart + "&" + requestUrlPart + "&" + 
+		String ret = MainUrl + "SERVICE=WMS" + "&"+ versionUrlPart + "&" + requestUrlPart + "&" + 
 		coordinateReferenceSystemUrlPart + "&" + bbox + 
 		"&WIDTH=" + pixelsize.x + "&HEIGHT=" + pixelsize.y + "&" + 
 		layersUrlPart + "&" + stylesUrlPart + "&" + imageFormatUrlPart; 
 		return ret;
 	}
 
+
 	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
 		Vector georef = new Vector(4);
 
 		// calculate a rectangle in the according coordinate reference system
 		CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
 		CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
-		CWPoint topleft;
-		CWPoint buttomright;
-		if (coordinateReferenceSystem == 31466 || coordinateReferenceSystem == 31467) {
+		CWPoint topleft = new CWPoint(maparea.topleft);
+		CWPoint buttomright = new CWPoint(maparea.buttomright);
+		double metersperpixalhorizontal = ( buttomright.getDistance(buttomleft) + topleft.getDistance(topright))/2 * 1000 / pixelsize.x; 
+		double metersperpixalvertical = ( buttomright.getDistance(topright) + topleft.getDistance(buttomright))/2 * 1000 / pixelsize.y;
+		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem)) {
 			GkPoint buttomleftgk = TransformCoordinates.wgs84ToGkGermany(buttomleft);
 			GkPoint toprightgk = TransformCoordinates.wgs84ToGkGermany(topright);
+			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
+			buttomleftgk.shift(metersperpixalhorizontal / 2, 1);
+			buttomleftgk.shift(metersperpixalvertical / 2, 0);
+			toprightgk.shift(-metersperpixalhorizontal / 2, 1);
+			toprightgk.shift(-metersperpixalvertical / 2, 0);
 			GkPoint topleftgk = new GkPoint(buttomleftgk.easting, toprightgk.northing);
 			GkPoint buttomrightgk = new GkPoint(toprightgk.easting, buttomleftgk.northing);
+
 			topleft = TransformCoordinates.gkGermanyToWgs84(topleftgk);
 			buttomright = TransformCoordinates.gkGermanyToWgs84(buttomrightgk);
-		} else if (coordinateReferenceSystem == 4326) {
-			topleft = maparea.topleft;
-			buttomright = maparea.buttomright;
+			buttomleft = TransformCoordinates.gkGermanyToWgs84(buttomleftgk);
+			topright = TransformCoordinates.gkGermanyToWgs84(toprightgk);
+		} else if (coordinateReferenceSystem == TransformCoordinates.EPSG_WGS84) {
+			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
+			topleft.shift(metersperpixalhorizontal / 2, 1);
+			topleft.shift(-metersperpixalvertical / 2, 0);
+			buttomright.shift(-metersperpixalhorizontal, 1);
+			buttomright.shift(metersperpixalhorizontal, 0);
+			buttomleft = new CWPoint (buttomright.latDec, topleft.lonDec);
+			topright = new CWPoint (topleft.latDec, buttomright.lonDec);
 		} else throw new IllegalArgumentException("getMapInfoObject: Coordinate system not supported by cachewolf: " + coordinateReferenceSystem);
-
 		georef.add(new GCPoint(topleft, new Point(0, 0)));
 		georef.add(new GCPoint(buttomright, new Point(pixelsize.x, pixelsize.y)));
 		georef.add(new GCPoint(buttomleft, new Point(0, pixelsize.y)));
 		georef.add(new GCPoint(topright, new Point(pixelsize.x, 0)));
-		
+
 		MapInfoObject ret = new MapInfoObject();
 		ret.evalGCP(georef, pixelsize.x, pixelsize.y);
 		return ret;
 	}
+}
+
+class ExpediaMapService extends OnlineMapService {
+	/*
+	 * information from: DownloadMouseMode.properties in project GPSylon ( in directory gpsylon_src-0.5.2\plugins\downloadmousemode\auxiliary\org\dinopolis\gpstool\plugin\downloadmousemode and DownloadMapCalculator.java in Dir gpsylon_src-0.5.2\plugins\downloadmousemode\src\org\dinopolis\gpstool\plugin\downloadmousemode 
+	 * download.map.url.expedia_east=http\://www.expedia.com/pub/agent.dll?qscr=mrdt&ID=3XNsF.&CenP={0,number,#.########},{1,number,#.########}&Lang=EUR0809&Alti={2,number,#}&Size={3,number,#},{4,number,#}&Offs=0.000000,0.000000\&BCheck=1
+	 * download.map.url.expedia_east.title=Url of Expedia Europe
+	 * download.map.scale_factor.expedia_east=3950
+	 */
+	final static float downloadMapScaleFactorExpedia_east = 3950;
+	final static float MAPBLAST_METERS_PER_PIXEL = 1.0f/2817.947378f;
+	final static float EXPEDIA_METERS_PER_PIXEL = downloadMapScaleFactorExpedia_east * MAPBLAST_METERS_PER_PIXEL; 
+	
+	public ExpediaMapService() {
+		name = "Expedia";
+		MainUrl = "Rhttp://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz."; //"Rhttp://" forces doenloadUrl to retry the URL until it gets an http-redirect and then downloads from there 
+		imageFileExt = ".gif";
+	}
+	
+	public float getMetersPerPixel(float scale) {
+		return (float) Math.ceil(scale) * EXPEDIA_METERS_PER_PIXEL;
+	}
+
+	public String getUrlForCenterScale(CWPoint center, float scale, Point pixelsize) {
+		int zoomlevel = (int)(Math.ceil(scale / EXPEDIA_METERS_PER_PIXEL));
+		String zone;
+		if (center.lonDec <= -10) zone = "USA0409";
+		else zone = "EUR0809";
+		String quelle = MainUrl + "&CenP=" + center.toString(CWPoint.LAT_LON);
+		quelle = quelle + "&Alti="+Convert.toString(zoomlevel)+"&Lang="+zone+"&Size="+Convert.toString(pixelsize.x)+","+Convert.toString(pixelsize.y)+"&Offs=0,0&MapS=0"; //&Pins=|" + latD.toString().replace(',', '.') + "," + lonD.toString().replace(',', '.') + "|5|";
+		return quelle;
+	}
+
+	public MapInfoObject getMapInfoObject(CWPoint center, float scale, Point pixelsize) {
+		float metersPerPixel = (float) getMetersPerPixel(scale);
+		MapInfoObject cal = new MapInfoObject(metersPerPixel, center,  pixelsize.x, pixelsize.y, name);
+		return cal;
+	}
+
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapLoaderGui.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -26,7 +26,8 @@
 	CellPanel pnlTiles = new CellPanel();
 	CellPanel pnlPerCache = new CellPanel();
 
-	final String descString = "Download georeferenced maps from expedia.com";
+	final String descString = "Download georeferenced maps\n Select online service:";
+	mChoice mapServiceChoice;
 	mCheckBox forCachesChkBox = new mCheckBox("for");
 	mChoice forSelectedChkBox = new mChoice(new String[] {"all", "selected"}, 0);
 	mChoice forSelectedChkBoxPerCache = new mChoice(new String[] {"all", "selected"}, 1);
@@ -44,6 +45,7 @@
 	mCheckBox overviewChkBox = new mCheckBox("download an overview map");
 	mCheckBox overviewChkBoxPerCache = new mCheckBox("download an overview map");
 
+	MapLoader mapLoader;
 	CWPoint center;
 	Vector cacheDB;
 	boolean perCache;
@@ -60,11 +62,15 @@
 		pref = Global.getPref(); // myPreferences sollte sp?ter auch diese Einstellungen speichern
 		center = new CWPoint(pref.curCentrePt);
 		cacheDB = cacheDBi;
-		// tiles panel
-		MessageArea desc = new MessageArea(descString);
+		mapLoader = new MapLoader(Global.getPref().myproxy, Global.getPref().myproxyport);
+		
+		mapServiceChoice = new mChoice(mapLoader.getAvailableOnlineMapServices(), 0);
+		MessageArea desc = new MessageArea(descString); 
 		desc.modifyAll(mTextPad.NotEditable | mTextPad.DisplayOnly | mTextPad.NoFocus, mTextPad.TakesKeyFocus);
 		desc.borderStyle = mTextPad.BDR_NOBORDER;
-		pnlTiles.addLast(desc);
+		this.addLast(desc);
+		this.addLast(mapServiceChoice);
+		// tiles panel
 		pnlTiles.addNext(forCachesChkBox);
 		pnlTiles.addNext(forSelectedChkBox);
 		pnlTiles.addLast(cachesLbl);
@@ -96,7 +102,6 @@
 		mTab.addCard(pnlTiles, MyLocale.getMsg(1804, "Tiles"), MyLocale.getMsg(1804, "Tiles"));
 
 		// per cache panel
-		pnlPerCache.addLast(new MessageArea(descString));
 		pnlPerCache.addNext(new mLabel("Download one map for"), CellConstants.DONTSTRETCH, (CellConstants.DONTFILL));
 		pnlPerCache.addNext(forSelectedChkBoxPerCache, CellConstants.DONTSTRETCH, (CellConstants.DONTFILL));
 		pnlPerCache.addLast(new mLabel("caches"), CellConstants.DONTSTRETCH, (CellConstants.DONTFILL));
@@ -115,17 +120,21 @@
 		this.addLast(mTab);
 	}
 	public String getMapsDir() {
-		return Global.getPref().getMapExpediaSavePath();
+		String ret = Global.getPref().getMapDownloadSavePath(mapLoader.currentOnlineMapService.getName());
+		Global.getPref().saveCustomMapsPath(ret);
+		return ret;
 	}
 	public void downloadTiles() {
 		String mapsDir = getMapsDir();
 		if (mapsDir == null) return;
-		InfoBox progressBox = new InfoBox("Downloading georeferenced maps", "Downloading georeferenced maps\n from www.expedia.com");
-		progressBox.setPreferredSize(230, 150);
+		InfoBox progressBox = new InfoBox("Downloading georeferenced maps", "Downloading georeferenced maps\n \n \n \n \n", InfoBox.PROGRESS_WITH_WARNINGS);
+		progressBox.setPreferredSize(220, 300);
+		progressBox.setInfoHeight(180);
+		progressBox.relayout(false);
 		progressBox.exec();
+		mapLoader.setProgressInfoBox(progressBox);
 		Vm.showWait(true);
 		ewe.fx.Point size = new ewe.fx.Point(1000,1000); // Size of the downloaded maps
-		MapLoader ml = new MapLoader(Global.getPref().myproxy, Global.getPref().myproxyport);
 		if (forCachesChkBox.getState() || perCache) {
 			Area surArea = Global.getProfile().getSourroundingArea(onlySelected); // calculate map boundaries from cacheDB
 			if (surArea == null) {
@@ -134,24 +143,19 @@
 				progressBox.close(0);
 				return;
 			}
-			ml.setTiles(surArea.topleft, surArea.buttomright, (int)scale, size, overlapping );
-			// calculate radius and centre for overview map
-			center = new CWPoint((surArea.topleft.latDec + surArea.buttomright.latDec)/2, (surArea.topleft.lonDec + surArea.buttomright.lonDec)/2);
-			double radiuslat = (new CWPoint(center.latDec, surArea.buttomright.lonDec)).getDistance(surArea.buttomright);
-			double radiuslon = (new CWPoint(surArea.buttomright.latDec, center.lonDec)).getDistance(surArea.buttomright);
-			radius = (float) (radiuslat < radiuslon ? radiuslon : radiuslat);
+			mapLoader.setTiles(surArea.topleft, surArea.buttomright, scale, size, overlapping );
 		} else 
 		{ // calculate from centre point an radius
-			ml.setTiles(center, radius * 1000, (int)scale, size, overlapping);
+			mapLoader.setTiles(center, radius * 1000, scale, size, overlapping);
 		}
 		if (overviewmap) {
 			progressBox.setInfo("downloading overview map"); 
-			int expediaAlti = MapLoader.getExpediaAlti(center, radius * 1000, size);
-			ml.downloadMap(center.latDec, center.lonDec, expediaAlti, size.x, size.y, mapsDir);
+			float scale = MapLoader.getScale(center, radius * 1000, size);
+			mapLoader.downloadMap(center, scale, size, mapsDir);
 		}
 		if (!perCache){  // download tiles
-			ml.setProgressInfoBox(progressBox);
-			ml.downlaodTiles(mapsDir);
+			mapLoader.setProgressInfoBox(progressBox);
+			mapLoader.downlaodTiles(mapsDir);
 		} else { // per cache
 			CacheHolder ch; 
 			CWPoint tmpca = new CWPoint();
@@ -167,17 +171,20 @@
 					}
 					if (ch.pos.isValid() && ch.pos.latDec != 0 && ch.pos.lonDec != 0) { // TODO != 0 sollte verschwinden, sobald das handling von nicht gesetzten Koos ?berall korrekt ist
 						numdownloaded++;
-						progressBox.setInfo("Downloading map from expedia.de\n"+numdownloaded+" / "+numCaches+"\n for cache:\n"+ch.CacheName);
-						ml.downloadMap(ch.pos.latDec, ch.pos.lonDec, (int)scale, size.x, size.y, mapsDir);
+						progressBox.setInfo("Downloading map '"+mapLoader.currentOnlineMapService.getName()+"'\n"+numdownloaded+" / "+numCaches+"\n for cache:\n"+ch.CacheName);
+						mapLoader.downloadMap(ch.pos, scale, size, mapsDir);
 					}
 				}
 			}
 		}
 		Vm.showWait(false);
-		ml.setProgressInfoBox(null);
-		progressBox.close(0);
+		progressBox.addWarning("Finished downloading and calibration of maps");
+		progressBox.addOkButton();
+		progressBox.waitUntilClosed();
+		mapLoader.setProgressInfoBox(null);
+		//progressBox.close(0);
 		if(Global.mainTab.mm != null) Global.mainTab.mm.mapsloaded = false; 
-		(new MessageBox("Expedia maps", "Downloaded and calibrated the maps successfully", MessageBox.OKB)).execute();
+	//	(new MessageBox("Download maps", "Downloaded and calibrated the maps successfully", MessageBox.OKB)).execute();
 	}
 
 
@@ -209,6 +216,7 @@
 				this.close(Form.IDCANCEL);
 			}
 			if (ev.target == okBtiles || ev.target == okBPerCache){
+				mapLoader.setCurrentMapService(mapServiceChoice.selectedIndex);
 				if (ev.target == okBtiles) { // get tiles
 					perCache = false;
 					if (forSelectedChkBox.getSelectedItem().toString().equalsIgnoreCase("all")) onlySelected = false;
@@ -238,10 +246,10 @@
 					overviewmap = overviewChkBoxPerCache.getState();
 					scale = Convert.toFloat(scaleInputPerCache.getText());
 				}
-				if (scale < 1 || scale != java.lang.Math.floor(scale)) {
+		/*		if (scale < 1 || scale != java.lang.Math.floor(scale)) {
 					(new MessageBox("Error", "'Approx. meter pro pixel' must be greater than 0 and must not contain a point", MessageBox.OKB)).execute();
 					return;
-				}
+				} */
 				this.close(Form.IDOK); 
 				this.downloadTiles();
 			}

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -38,7 +38,7 @@
 	CWPoint TrackOverlaySetCenterTopLeft;
 	Vector tracks;
 	MapInfoObject currentMap = null;
-	String mapPath;
+	//String mapPath;
 	Navigate myNavigation;
 	boolean running = false;
 
@@ -88,7 +88,7 @@
 		this.setPreferredSize(pref.myAppWidth, pref.myAppHeight);
 		this.title = "Moving Map";
 		this.backGround = new Color(254,254,254); // background must not be black because black is interpreted as transparent and transparent images above (eg trackoverlay) want be drawn in windows-VM, so be care, don|t use white either
-		this.mapPath = Global.getPref().getMapLoadPath();
+		//this.mapPath = Global.getPref().getMapLoadPath();
 
 		mmp = new MovingMapPanel(this);
 		this.addLast(mmp);
@@ -176,7 +176,7 @@
 	public void loadMaps(String mapsPath, double lat){
 		if (loadingMapList) return;
 		loadingMapList = true;
-		this.mapPath = mapsPath;
+		//this.mapPath = mapsPath;
 		Vm.showWait(this, true);
 		resetCenterOfMap();
 		InfoBox inf = new InfoBox("Info", "Loading list of maps...");
@@ -840,7 +840,7 @@
 		if (dontUpdatePos || loadingMapList) return; // avoid multi-threading problems
 		Vm.debug("updatepos, lat: "+lat+" lon: "+lon);
 		if (!mapsloaded) {
-			loadMaps(mapPath, lat);
+			loadMaps(Global.getPref().getMapLoadPath(), lat);
 			lastCompareX = Integer.MAX_VALUE;
 			lastCompareY = Integer.MAX_VALUE;
 			autoSelectMap = true;
@@ -1634,7 +1634,8 @@
 							fc.addMask("*.wfl");
 							fc.setTitle((String)MyLocale.getMsg(4200,"Select map directory:"));
 							if(fc.execute() != FileChooser.IDCANCEL){
-								mm.loadMaps(fc.getChosen().toString(), mm.posCircleLat);
+								Global.getPref().saveCustomMapsPath(fc.getChosen().toString());
+								mm.loadMaps(Global.getPref().getMapLoadPath(), mm.posCircleLat);
 								mm.forceMapLoad();
 							}
 						}

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -29,7 +29,7 @@
 	public static final int EPSG_GK5 = 31469; 
 
 	private static final Ellipsoid BESSEL = new Ellipsoid(6377397.155, 6356078.962);
-	private static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
+	public static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
 
 
 	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 4 = Deutschland Nord"
@@ -296,7 +296,7 @@
 }
 
 class Ellipsoid {
-	double a, b;
+	public double a, b;
 	public Ellipsoid(double ai, double bi) {
 		a = ai;
 		b = bi;



From pfeffer at mail.berlios.de  Tue Nov  6 18:46:15 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 6 Nov 2007 18:46:15 +0100
Subject: [Cachewolf-svn] r1046 - in trunk/src/CacheWolf: . navi
Message-ID: <200711061746.lA6HkF2l002803@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-06 18:45:57 +0100 (Tue, 06 Nov 2007)
New Revision: 1046

Modified:
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
TransformCoordinates: precision raised from around 1m to around 30cm for former west Germany
Preferences: nullpointerException removed, which arose from last commit

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-06 17:18:11 UTC (rev 1045)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-06 17:45:57 UTC (rev 1046)
@@ -379,7 +379,7 @@
 	}
 	
 	public void saveCustomMapsPath(String mapspath_) {
-		if (!customMapsPath.equals(mapspath_)) {
+		if (customMapsPath == null || !customMapsPath.equals(mapspath_)) {
 			customMapsPath=new String(mapspath_);
 			savePreferences();
 		}

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-06 17:18:11 UTC (rev 1045)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-06 17:45:57 UTC (rev 1046)
@@ -13,6 +13,9 @@
  * The only difference to the excel-model is that shifting is done before rotation
  * this makes calculations easier, without changing the output.
  * 
+ * For verification data see: 
+ *  * http://crs.bkg.bund.de/crseu/crs/descrtrans/BeTA/BETA2007testdaten.csv
+ *  * http://www.lverma.nrw.de/produkte/raumbezug/koordinatentransformation/Koordinatentransformation.htm
  * Now, that this is completed: there is a much more precise method right now published
  * by the Bundesamt f?r Kartographie und Geod?sie for whole Germany: see:
  *  * http://crs.bkg.bund.de/crseu/crs/descrtrans/BeTA/BETA2007dokumentation.pdf
@@ -31,22 +34,26 @@
 	private static final Ellipsoid BESSEL = new Ellipsoid(6377397.155, 6356078.962);
 	public static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
 
+	//	 taken from http://crs.bkg.bund.de/crs-eu/ click on "national CRS" -> germany -> DE_DHDN / GK_3 -> DE_DHDN (North) to ETRS89
 
 	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 4 = Deutschland Nord"
+
 	private static final TransformParameters GK_NORD_GERMANY_TO_WGS84 = new TransformParameters(590.5, 69.5, 411.6, 0.796, 0.052, 3.601, 8.300, false);
-	/** use this for nord Germany, maximum deviation unknown */
+	/** use this for nord Germany, maximum sub meter, valid in the former BRD (west germany) in 52?20' N ... 55?00' N */
 	public static final TransformParameters GK_NORD_GERMANY =  GK_NORD_GERMANY_TO_WGS84; 
 
-	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 3 = Mitte Deutschland"
+	//	 taken from http://crs.bkg.bund.de/crs-eu/ click on "national CRS" -> germany -> DE_DHDN / GK_3 -> DE_DHDN (Middle) to ETRS89
 	private static final TransformParameters GK_MID_GERMANY_TO_WGS84 = new TransformParameters(584.8, 67.0, 400.3, -0.105, -0.013, 2.378, 10.290, false);
-	/** use this for mid Germany, maximum deviation unknown */
+	/** use this for mid-Germany, maximum sub meter, valid in the former BRD (west germany) in 50?20' N ... 52?20' N */
 	public static final TransformParameters GK_MID_GERMANY =  GK_MID_GERMANY_TO_WGS84; 
 
-	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 5 = Deutschland S?d"
+	//	 taken from http://crs.bkg.bund.de/crs-eu/ click on "national CRS" -> germany -> DE_DHDN / GK_3 -> DE_DHDN (South) to ETRS89
 	private static final TransformParameters GK_SOUTH_GERMANY_TO_WGS84 = new TransformParameters(597.1, 71.4, 412.1, -0.894, -0.068, 1.563, 7.580, false);
-	/** use this for south Germany, maximum deviation unknown */
+	/** use this for south Germany, maximum sub meter, valid in the former BRD (west germany) in 47?00' N ... 50?20' N */
 	public static final TransformParameters GK_SOUTH_GERMANY =  GK_SOUTH_GERMANY_TO_WGS84; 
 
+	private static Area FORMER_GDR = new Area(new CWPoint(54.923414, 10.503013), new CWPoint(50.402578, 14.520637)); 
+	
 	// taken from http://www.lverma.nrw.de/produkte/druckschriften/verwaltungsvorschriften/images/gps/TrafopsNRW.pdf for NRW this transform has deviations lower than 34cm.
 	private static final TransformParameters GK_NRW_GERMANY_TO_WGS84 = new TransformParameters(566.1, 116.3, 390.1, -1.11, -0.24, 3.76, 12.6, false);
 	/** use this for NRW in Germany. Deviations less than 34 cm */
@@ -108,12 +115,18 @@
 	/**
 	 * This is the most abstract method: If you don't know 
 	 * when to use another one (if you are in need to do so, you will
-	 * know), use this one.
+	 * know), use this one. This routine chooses automatically the best known
+	 * transformation parameters. Currently the maximam deviation is 1m for the
+	 * former BRD and 1.13m for the former GDR 
 	 * @param gk
 	 * @return
 	 */
 	public static GkPoint wgs84ToGkGermany(CWPoint ll) {
-		return  wgs84ToGk(ll, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
+		if (FORMER_GDR.isInBound(ll)) wgs84ToGk(ll, GK_GERMANY_2001); // exlcude former GDR from the splitting germany in north/middel/south
+		if (ll.latDec <= 55 && ll.latDec >= 52.33333334 ) return  wgs84ToGk(ll, GK_NORD_GERMANY);
+		if (ll.latDec <= 52.33333334  && ll.latDec >= 50.33333334 ) return  wgs84ToGk(ll, GK_MID_GERMANY);
+		if (ll.latDec <= 50.33333334  && ll.latDec >= 47) return  wgs84ToGk(ll, GK_MID_GERMANY);
+		return  wgs84ToGk(ll, GK_GERMANY_2001); 	
 	}
 
 	/**



From pfeffer at mail.berlios.de  Tue Nov  6 18:50:39 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 6 Nov 2007 18:50:39 +0100
Subject: [Cachewolf-svn] r1047 - trunk/src/CacheWolf/navi
Message-ID: <200711061750.lA6Hod9Y007239@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-06 18:50:16 +0100 (Tue, 06 Nov 2007)
New Revision: 1047

Modified:
   trunk/src/CacheWolf/navi/Area.java
   trunk/src/CacheWolf/navi/GkPoint.java
   trunk/src/CacheWolf/navi/MapInfoObject.java
   trunk/src/CacheWolf/navi/MapLoader.java
Log:
added new lines at the end of files in order to conform to the standards

Modified: trunk/src/CacheWolf/navi/Area.java
===================================================================
--- trunk/src/CacheWolf/navi/Area.java	2007-11-06 17:45:57 UTC (rev 1046)
+++ trunk/src/CacheWolf/navi/Area.java	2007-11-06 17:50:16 UTC (rev 1047)
@@ -142,4 +142,4 @@
 	 public CWPoint getCenter() {
 		 return new CWPoint((topleft.latDec + buttomright.latDec)/2, (topleft.lonDec + buttomright.lonDec)/2);
 	 }
-}
\ No newline at end of file
+}

Modified: trunk/src/CacheWolf/navi/GkPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/GkPoint.java	2007-11-06 17:45:57 UTC (rev 1046)
+++ trunk/src/CacheWolf/navi/GkPoint.java	2007-11-06 17:50:16 UTC (rev 1047)
@@ -42,4 +42,4 @@
 			case 1: easting += meters; return;
 		}
 	}
-}
\ No newline at end of file
+}

Modified: trunk/src/CacheWolf/navi/MapInfoObject.java
===================================================================
--- trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-06 17:45:57 UTC (rev 1046)
+++ trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-06 17:50:16 UTC (rev 1047)
@@ -441,4 +441,5 @@
 			bitMapX = px.x;
 			bitMapY = px.y;
 		}
-	}
\ No newline at end of file
+	}
+	
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-06 17:45:57 UTC (rev 1046)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-06 17:50:16 UTC (rev 1047)
@@ -540,4 +540,4 @@
 		return cal;
 	}
 
-}
\ No newline at end of file
+}



From bilbowolf at mail.berlios.de  Thu Nov  8 05:39:38 2007
From: bilbowolf at mail.berlios.de (bilbowolf at mail.berlios.de)
Date: Thu, 8 Nov 2007 05:39:38 +0100
Subject: [Cachewolf-svn] r1048 - trunk/src/CacheWolf
Message-ID: <200711080439.lA84dctL021152@sheep.berlios.de>

Author: bilbowolf
Date: 2007-11-08 05:39:34 +0100 (Thu, 08 Nov 2007)
New Revision: 1048

Modified:
   trunk/src/CacheWolf/Version.java
Log:
Neue BE Version

Modified: trunk/src/CacheWolf/Version.java
===================================================================
--- trunk/src/CacheWolf/Version.java	2007-11-06 17:50:16 UTC (rev 1047)
+++ trunk/src/CacheWolf/Version.java	2007-11-08 04:39:34 UTC (rev 1048)
@@ -10,7 +10,7 @@
 	static final String VER_MAJOR = "BE";
 	static final String VER_MINOR = "";
 	static final String VER_BUILD = " ";
-	static final String VER_SVN ="$LastChangedRevision$"; //  the number is automatically replaced by subversion to the latest versionnumer of this file (svn:keywords LastChangedRevision)
+	static final String VER_SVN ="$LastChangedRevision$"; // the number is automatically replaced by subversion to the latest versionnumer of this file (svn:keywords LastChangedRevision)
 	
 	/**
 	 * @return



From pfeffer at mail.berlios.de  Fri Nov  9 03:44:50 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 9 Nov 2007 03:44:50 +0100
Subject: [Cachewolf-svn] r1049 - in trunk: res_noewe src/CacheWolf
	src/CacheWolf/navi
Message-ID: <200711090244.lA92io3D026654@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-09 03:44:28 +0100 (Fri, 09 Nov 2007)
New Revision: 1049

Modified:
   trunk/res_noewe/luftbild-nrw.wms
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/navi/GkPoint.java
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
WMS: fixed: problem with coordinates exceeding the normal Gau??-Kr??ger stripe width ( see http://www.geoclub.de/ftopic20115.html )
WMS: fixed: scale now correct calculated for comparision with minscale / maxscale
WMS: added feature: automatically select correct stripe and corresponding EPSG code in german Gau??-Kr??ger coordinates
some internal changes for this purposes

Modified: trunk/res_noewe/luftbild-nrw.wms
===================================================================
--- trunk/res_noewe/luftbild-nrw.wms	2007-11-08 04:39:34 UTC (rev 1048)
+++ trunk/res_noewe/luftbild-nrw.wms	2007-11-09 02:44:28 UTC (rev 1049)
@@ -6,23 +6,41 @@
 # This example is made up from there "Digitales Orthophoto" under section "Nordrhein-Westfalen"
 # download the getCapabilieties URL, save and open it in a text editor. 
 # used here: http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-# 
-#friendly name, choose yourself
+#
+# You can delete and add comments if you like. A comment starts with "#" in the first coloumn of the line.
+#
+# friendly name, choose yourself
 Name:	Luftbild NRW 
 # taken from getCapabilieties answer: <HTTP><GET><OnlineResource xlink:href=
 MainUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild? 
 #friendly name of the layer combination, choose yourself
 LayersName: 
-# this is fix
+# this is fix, dont change it
 ServiceTypeUrlPart:	SERVICE=WMS 
 # taken from the getCapabilities request: <WMT_MS_Capabilities version=
 VersionUrlPart:	VERSION=1.1.0 
-# The EPSG-Code, supported by cachewolf: german gau?-kr?ger (31466, 31467, 31468, 31469) and WGS84 (4326)
-# You get a list of supported coordinate systems in the getCapabilieties answer under <Layer><SRS>
-# plases feel free to ask for another coordinate system to be supported by cachewolf if you need it
-CoordinateReferenceSystemCacheWolf:	31466 
+# The EPSG-Code, supported by cachewolf: german gau?-kr?ger (31466, 31467, 31468, 
+# 31469) and WGS84 (4326)
+# You get a list of supported coordinate systems from the WMS in the getCapabilieties 
+# answer under <Layer><SRS> or <CRS>
+# Plases feel free to ask for another coordinate system to be supported by cachewolf 
+# if you need it
+# In case the wms server accepts coordinates in more than one Gau?-Kr?ger stripe
+# you can list the epsg codes here, seperated by a space. CacheWolf will
+# automatically make use of the correct stripe. 
+# The Strings in the UrlPart must match the corresponding number here
+# Sometimes the wms-Server provides only one stripe, in spite of the fact, that
+# the map it provides is not completely within this stripe. In this case
+# just list only this epsg code. CacheWolf will automatically calculate the
+# Gau?-Kr?ger coordinates for that stripe.
+# The automatic for the stripe selection only works if a german EPSG code
+# is the first one in the space seperated list
+# remark: some WMS offer WGS84 (EPSG 4326), but they are sometimes working not
+# correctly (for example the WMS of the Landesvermessungsamt NRW as of nov. 2007)
+# In this case don't list it.
+CoordinateReferenceSystemCacheWolf:	31466 31467
 # this usually will match the number above
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
 # Post not supported by Cachewolf --> dont change this
 RequestUrlPart:	REQUEST=GetMap
 # comma seperated (without spaces) list of layers to combine
@@ -34,16 +52,19 @@
 StylesUrlPart:	STYLES=
 # format, dont forget to set ImageFileExtension accordingly
 # you get a list of supported image formats from getCapabilieties answer: <GetMap><Format>
-ImageFormatUrlPart:	FORMAT=image/jpeg
+ImageFormatUrlPart:	FORMAT=image/png
 # Limits of the service in WGS84 coordinates. 
 # You can use any format here, which is accepted by the input coordinates dialog in cachewolf
 # taken from getCapabilieties answer: <BoundingBox SRS="EPSG:4326", dont forget to add "N"/"S" and "E"/"W"
 BoundingBoxTopLeftWGS84:	N 52.7691 E 5.673
 BoundingBoxButtomRightWGS84:	N 49.9944 E 10.142
 # scale range that the service supports in meters per pixel (measured diagonal)
+# Please don't wonder that they do mot match the scale given in
+# the map download dialog as that scale is measured vertically 
+# (multiply it ba sqrt(2) and you get the scale used here
 # taken from the getCapabilities request "<Layer><ScaleHint min="
 MinScale:	0.1795783591567183
 MaxScale:	5.611823723647454
-# set this according to ImageFormatUrlPart
-ImageFileExtension: .jpg
+# set this according to ImageFormatUrlPart (must start with "."
+ImageFileExtension: .png
 

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-08 04:39:34 UTC (rev 1048)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-09 02:44:28 UTC (rev 1049)
@@ -465,11 +465,11 @@
 	}
 	
 	public String getGermanGkCoordinates() {
-		return TransformCoordinates.wgs84ToGkGermany(this).toString(0, "R:", " H:");
+		return TransformCoordinates.wgs84ToGermanGK(this).toString(0, "R:", " H:");
 	}
 
 	public String getGermanGkCoordinates(int decimalplaces, String pref, String seperator) {
-		return TransformCoordinates.wgs84ToGkGermany(this).toString(decimalplaces, pref, seperator);
+		return TransformCoordinates.wgs84ToGermanGK(this).toString(decimalplaces, pref, seperator);
 	}
 	
 	/**

Modified: trunk/src/CacheWolf/navi/GkPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/GkPoint.java	2007-11-08 04:39:34 UTC (rev 1048)
+++ trunk/src/CacheWolf/navi/GkPoint.java	2007-11-09 02:44:28 UTC (rev 1049)
@@ -6,16 +6,85 @@
  *
  */
 public class GkPoint {
-	double northing;
-	double easting;
+	double northing; // TODO make these private
+	private double easting; // because it is not clear for routines from outside if the stripe number is included, make this available only through methods
+	int stripe;
+	int stripewidth;
 
 	public GkPoint() { super(); }
 	
+	/**
+	 * e containing the number of the stripe
+	 * @param e
+	 * @param n
+	 */
+	public GkPoint(double e, double n, int stripewidthi) {
+		set(e - 1000000 * stripe - 500000, n, (int) Math.floor(e / 1000000), stripewidthi);
+	}
+	
+	/**
+	 * use this to set normal german Gau?-Kr?ger coordinates
+	 * (they contain the stripe numer in the easting value and
+	 * have a stripe with of 3 degrees)
+	 * @param e
+	 * @param n
+	 */
 	public GkPoint(double e, double n) {
+		set(e, n, 3);
+	}
+	
+	public GkPoint(double e, double n, int stripei, int stripewidthi) {
+		set(e, n, stripei, stripewidthi);
+	}
+		
+	/**
+	 * 
+	 * @param e containing the stripe number
+	 * @param n
+	 * @param stripewidthi
+	 */
+	public void set(double e, double n, int stripewidthi) {
+		double stripei = Math.floor(e / 1000000);
+		set(e - 1000000 * stripei - 500000, n, (int) stripei, stripewidthi);
+	}
+	
+	/**
+	 * @param e in meters from center of stripe, it may not contain the stripenumber
+	 */
+	public void set(double e, double n, int stripei, int stripewidthi) {
+		stripe = stripei;
+		stripewidth = stripewidthi;
 		easting = e;
 		northing = n;
 	}
 	
+	public double getStripeLon() {
+		return stripe * stripewidth;
+	}
+	
+	public int getStripe() {
+		return stripe;
+	}
+	
+	/**
+	 * This will give you the normal Gau?-Kr?ger easting value
+	 * (that means including the stripe number)
+	 * @return
+	 */
+	public double getGkEasting() {
+		double e = easting + 500000 + stripe * 1000000;
+		return e;
+	}
+	
+	/**
+	 * easting measured in meters from stripe middle
+	 * @return
+	 */
+	public double getRawEasting() {
+		return easting;
+	}
+	
+	
 	public String toString() {
 		return toString(0, "R: ", " H: ");
 	}
@@ -25,7 +94,7 @@
 		ewe.sys.Double n = new ewe.sys.Double();
 		ewe.sys.Double e = new ewe.sys.Double();
 		n.set(northing);
-		e.set(easting);
+		e.set(getGkEasting());
 		n.decimalPlaces = decimalplaces;
 		e.decimalPlaces = decimalplaces;
 		return prefix + e.toString().replace(',', '.') + seperator + n.toString().replace(',', '.');

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-08 04:39:34 UTC (rev 1048)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-09 02:44:28 UTC (rev 1049)
@@ -9,6 +9,7 @@
 import ewe.io.*;
 import ewe.fx.*;
 import ewe.util.*;
+import ewe.reflect.Array;
 import ewe.sys.*;
 import ewe.sys.Double;
 import ewe.net.*;
@@ -64,9 +65,9 @@
 				if (f == null) (f=new MessageBox("Warning", "Ignoring error while \n reading web map service definition file \n"+ex.toString(), MessageBox.OKB)).exec();
 			}
 		}
-		
+
 	}
-	
+
 	public String[] getAvailableOnlineMapServices(){
 		int s = onlineMapServices.size();
 		String[] services = new String[s];
@@ -75,7 +76,7 @@
 		}
 		return services;
 	}
-	
+
 	public void setCurrentMapService(int index) {
 		currentOnlineMapService = (OnlineMapService) onlineMapServices.get(index);
 	}
@@ -221,10 +222,10 @@
 			this.progressInfobox.addWarning("Ignoring error during map download, saving or calibration:\n" + e.getMessage()+"\n");
 		}
 	}
-	
+
 	public String createFilename(CWPoint center, float scale) {
 		String filename = Common.ClearForFileName(currentOnlineMapService.getName()+"_s"+Common.DoubleToString(scale, 1)
-		+ "_c" + center.toString(CWPoint.LAT_LON).replace(',', '-'));
+				+ "_c" + center.toString(CWPoint.LAT_LON).replace(',', '-'));
 		return filename;
 	}
 
@@ -373,7 +374,7 @@
 		return getMapInfoObject(CenterScaleToArea(center, scale, pixelsize), pixelsize);
 		//throw new IllegalArgumentException("OnlineMapService: (CWPoint center, double zoomlevel, Point pixelsize):\n This method must be overloaded in order to be able to use it");
 	}
-	
+
 	public String toString() {
 		return getName();
 	}
@@ -384,8 +385,8 @@
 	String layersUrlPart; //
 	String versionUrlPart; // VERSION=1.1.0
 	String serviceTypeUrlPart; //"SERVICE=WMS" 
-	int coordinateReferenceSystem; // WGS84: 4326, German GK: 31466 / 
-	String coordinateReferenceSystemUrlPart; //&SRS=EPSG:31466
+	int coordinateReferenceSystem[]; // WGS84: 4326, German GK: 31466 / 
+	String coordinateReferenceSystemUrlPart[]; //&SRS=EPSG:31466
 	String requestUrlPart;
 	String imageFormatUrlPart; // FORMAT=image/png
 	String stylesUrlPart; // STYLES=
@@ -417,10 +418,23 @@
 		serviceTypeUrlPart = wms.getProperty("ServiceTypeUrlPart", "SERVICE=WMS").trim();
 		layersUrlPart = wms.getProperty("LayersUrlPart", "").trim();;
 		versionUrlPart = wms.getProperty("VersionUrlPart", "").trim();;
-		coordinateReferenceSystem = Convert.toInt(wms.getProperty("CoordinateReferenceSystemCacheWolf", "0").trim());
-		if (!TransformCoordinates.isSupported(coordinateReferenceSystem)) throw new IllegalArgumentException("Coordinate reference system not supported by CacheWolf:\n" + coordinateReferenceSystem);
-		coordinateReferenceSystemUrlPart = wms.getProperty("CoordinateReferenceSystemUrlPart", "").trim();
-		if (coordinateReferenceSystemUrlPart == "") throw new IllegalArgumentException("CoordinateReferenceSystemUrlPart: property >MainUrl:< missing in file:\n" + filename);
+		String tmp = wms.getProperty("CoordinateReferenceSystemCacheWolf", "").trim();
+		if (tmp.equals("")) throw new IllegalArgumentException("WebMapService: no CoordinateReferenceSystemCacheWolf given");
+		String[] tmp2 = mString.split(tmp, ' ');
+		coordinateReferenceSystem = new int[tmp2.length];
+		for (int i = 0; i < tmp2.length; i++) {
+			coordinateReferenceSystem[i] = Convert.toInt(tmp2[i].trim());
+			if (!TransformCoordinates.isSupported(coordinateReferenceSystem[i])) throw new IllegalArgumentException("Coordinate reference system not supported by CacheWolf:\n" + coordinateReferenceSystem[i]);
+		}
+		tmp = wms.getProperty("CoordinateReferenceSystemUrlPart", "").trim();
+		if (tmp == "") throw new IllegalArgumentException("CoordinateReferenceSystemUrlPart: property >MainUrl:< missing in file:\n" + filename);
+		tmp2 = mString.split(tmp, ' ');
+		if (tmp2.length != coordinateReferenceSystem.length) throw new IllegalArgumentException("number of String in CoordinateReferenceSystemUrlPart ("+tmp2.length+") must match the number of codes in CoordinateReferenceSystemCacheWolf ("+coordinateReferenceSystem.length+") use normal space as separator");
+		coordinateReferenceSystemUrlPart = new String[tmp2.length];
+		for (int i = 0; i < tmp2.length; i++) {
+			coordinateReferenceSystemUrlPart[i] = tmp2[i].trim();
+			if (coordinateReferenceSystemUrlPart[i] == "") throw new IllegalArgumentException("CoordinateReferenceSystemUrlPart: property >MainUrl:< missing in file:\n" + filename);
+		}
 		requestUrlPart = wms.getProperty("RequestUrlPart", "REQUEST=GetMap").trim();
 		imageFormatUrlPart = wms.getProperty("ImageFormatUrlPart", "").trim();
 		stylesUrlPart = wms.getProperty("StylesUrlPart", "").trim();
@@ -439,26 +453,49 @@
 
 	public String getUrlForBoundingBox(Area maparea, Point pixelsize) {
 		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + " not covered by service: " + name + ", service area: " + boundingBox.toString());
-		double scale = maparea.buttomright.getDistance(maparea.topleft) * 1000 / Math.sqrt(pixelsize.x * pixelsize.x + pixelsize.y * pixelsize.y); // meters per pixel measured diagonal
-		if ( scale < minscale || scale > maxscale) throw new IllegalArgumentException("scale not support by online map service: " + scale + ", supported scale range: " + minscale + " - " + maxscale);
 		// http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetMap&SRS=EPSG:31466&BBOX=2577567.0149,5607721.7566,2578567.0077,5608721.7602&WIDTH=500&HEIGHT=500&LAYERS=Raster:TK25_KMF:Farbkombination&STYLES=&FORMAT=image/png
 		CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
 		CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
+		double scaleh = maparea.buttomright.getDistance(buttomleft) * 1000 / pixelsize.x; 
+		double scalev = maparea.topleft.getDistance(topright) * 1000 / pixelsize.y; 
+		double scale = Math.sqrt(scaleh * scaleh + scalev * scalev); // meters per pixel measured diagonal
+		if ( scale < minscale || scale > maxscale) throw new IllegalArgumentException("scale not support by online map service: " + scale + ", supported scale range: " + minscale + " - " + maxscale);
+		int crs = 0;
 		String bbox = "BBOX=";
-		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem)) 
-			bbox += buttomleft.getGermanGkCoordinates(3, "",",") + "," + topright.getGermanGkCoordinates(3, "", ",");
-		else if (coordinateReferenceSystem == TransformCoordinates.EPSG_WGS84) 
+		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem[0])) {
+			crs = getCrs(buttomleft);
+			bbox += TransformCoordinates.wgs84ToGermanGk(buttomleft, coordinateReferenceSystem[crs]).toString(3, "", ",");
+			bbox += "," + TransformCoordinates.wgs84ToGermanGk(topright, coordinateReferenceSystem[crs]).toString(3, "", ",");
+		} else if (coordinateReferenceSystem[0] == TransformCoordinates.EPSG_WGS84) 
 			bbox += buttomleft.toString(CWPoint.LON_LAT)  + "," + topright.toString(CWPoint.LON_LAT);
-		else throw new IllegalArgumentException("Coordinate system not supported by cachewolf: " + coordinateReferenceSystem);
+		else throw new IllegalArgumentException("Coordinate system not supported by cachewolf: " + coordinateReferenceSystem.toString());
 		String ret = MainUrl + "SERVICE=WMS" + "&"+ versionUrlPart + "&" + requestUrlPart + "&" + 
-		coordinateReferenceSystemUrlPart + "&" + bbox + 
+		coordinateReferenceSystemUrlPart[crs] + "&" + bbox + 
 		"&WIDTH=" + pixelsize.x + "&HEIGHT=" + pixelsize.y + "&" + 
 		layersUrlPart + "&" + stylesUrlPart + "&" + imageFormatUrlPart; 
 		return ret;
 	}
 
+	/**
+	 * This method gives the number in the arrays of coordinateReferenceSystems, which should be used
+	 * a) if only one is in the array 0 is returned
+	 * b) if there are more, find out which one matches the correct Gau?-K?ger stripe
+	 * Call this routine witch buttom left 
+	 * @param p Point for which the epsg code is searched for
+	 * @return
+	 */
+	private int getCrs(CWPoint p) {
+		int crs = 0;
+		if (coordinateReferenceSystem.length > 1) {
+			GkPoint gkbl = TransformCoordinates.wgs84ToGermanGK(p); // TODO: think / read about what to do if buttom left and top right ae not in the same Gau?-Kr?ger stripe?
+			crs = TransformCoordinates.whichEpsg(coordinateReferenceSystem, gkbl);
+			if (crs < 0) throw new IllegalArgumentException("getUrlForBoundingBox: Point: " + gkbl.toString() + "no matching Gau?-Kr?ger-Stripe in the EPSG-code list in the .wms");
+		}
+		return crs;
+	}
 
 	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
+		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + " not covered by service: " + name + ", service area: " + boundingBox.toString());
 		Vector georef = new Vector(4);
 
 		// calculate a rectangle in the according coordinate reference system
@@ -468,22 +505,23 @@
 		CWPoint buttomright = new CWPoint(maparea.buttomright);
 		double metersperpixalhorizontal = ( buttomright.getDistance(buttomleft) + topleft.getDistance(topright))/2 * 1000 / pixelsize.x; 
 		double metersperpixalvertical = ( buttomright.getDistance(topright) + topleft.getDistance(buttomright))/2 * 1000 / pixelsize.y;
-		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem)) {
-			GkPoint buttomleftgk = TransformCoordinates.wgs84ToGkGermany(buttomleft);
-			GkPoint toprightgk = TransformCoordinates.wgs84ToGkGermany(topright);
+		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem[0])) {
+			int crs = getCrs(buttomleft); 
+			GkPoint buttomleftgk = TransformCoordinates.wgs84ToGermanGk(buttomleft, coordinateReferenceSystem[crs]);
+			GkPoint toprightgk = TransformCoordinates.wgs84ToGermanGk(topright, coordinateReferenceSystem[crs]);
 			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
 			buttomleftgk.shift(metersperpixalhorizontal / 2, 1);
 			buttomleftgk.shift(metersperpixalvertical / 2, 0);
 			toprightgk.shift(-metersperpixalhorizontal / 2, 1);
 			toprightgk.shift(-metersperpixalvertical / 2, 0);
-			GkPoint topleftgk = new GkPoint(buttomleftgk.easting, toprightgk.northing);
-			GkPoint buttomrightgk = new GkPoint(toprightgk.easting, buttomleftgk.northing);
+			GkPoint topleftgk = new GkPoint(buttomleftgk.getGkEasting(), toprightgk.northing);
+			GkPoint buttomrightgk = new GkPoint(toprightgk.getGkEasting(), buttomleftgk.northing);
 
-			topleft = TransformCoordinates.gkGermanyToWgs84(topleftgk);
-			buttomright = TransformCoordinates.gkGermanyToWgs84(buttomrightgk);
-			buttomleft = TransformCoordinates.gkGermanyToWgs84(buttomleftgk);
-			topright = TransformCoordinates.gkGermanyToWgs84(toprightgk);
-		} else if (coordinateReferenceSystem == TransformCoordinates.EPSG_WGS84) {
+			topleft = TransformCoordinates.germanGkToWgs84(topleftgk);
+			buttomright = TransformCoordinates.germanGkToWgs84(buttomrightgk);
+			buttomleft = TransformCoordinates.germanGkToWgs84(buttomleftgk);
+			topright = TransformCoordinates.germanGkToWgs84(toprightgk);
+		} else if (coordinateReferenceSystem[0] == TransformCoordinates.EPSG_WGS84) {
 			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
 			topleft.shift(metersperpixalhorizontal / 2, 1);
 			topleft.shift(-metersperpixalvertical / 2, 0);
@@ -513,13 +551,13 @@
 	final static float downloadMapScaleFactorExpedia_east = 3950;
 	final static float MAPBLAST_METERS_PER_PIXEL = 1.0f/2817.947378f;
 	final static float EXPEDIA_METERS_PER_PIXEL = downloadMapScaleFactorExpedia_east * MAPBLAST_METERS_PER_PIXEL; 
-	
+
 	public ExpediaMapService() {
 		name = "Expedia";
 		MainUrl = "Rhttp://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz."; //"Rhttp://" forces doenloadUrl to retry the URL until it gets an http-redirect and then downloads from there 
 		imageFileExt = ".gif";
 	}
-	
+
 	public float getMetersPerPixel(float scale) {
 		return (float) Math.ceil(scale) * EXPEDIA_METERS_PER_PIXEL;
 	}

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-08 04:39:34 UTC (rev 1048)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-09 02:44:28 UTC (rev 1049)
@@ -5,6 +5,8 @@
 
 import java.lang.Math;
 
+import ewe.database.GetSearchCriteria;
+
 /**
  * Class to transform coordinates and shift datums
  * it uses the 7 parameter Helmert Transformation
@@ -26,30 +28,29 @@
 public class TransformCoordinates {
 
 	public static final int EPSG_WGS84 = 4326; 
+	public static final int EPSG_ETRS89 = 25832; // TODO support it anyhow 
 	public static final int EPSG_GK2 = 31466; 
 	public static final int EPSG_GK3 = 31467; 
 	public static final int EPSG_GK4 = 31468; 
 	public static final int EPSG_GK5 = 31469; 
-
+	
 	private static final Ellipsoid BESSEL = new Ellipsoid(6377397.155, 6356078.962);
 	public static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
 
 	//	 taken from http://crs.bkg.bund.de/crs-eu/ click on "national CRS" -> germany -> DE_DHDN / GK_3 -> DE_DHDN (North) to ETRS89
-
-	//	 taken from http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 4 = Deutschland Nord"
-
+	//	 they are the same as http://www.geoclub.de/files/GK_nach_GPS.xls "Parametersatz 4 = Deutschland Nord"
 	private static final TransformParameters GK_NORD_GERMANY_TO_WGS84 = new TransformParameters(590.5, 69.5, 411.6, 0.796, 0.052, 3.601, 8.300, false);
-	/** use this for nord Germany, maximum sub meter, valid in the former BRD (west germany) in 52?20' N ... 55?00' N */
+	/** use this for nord Germany, maximum deviation sub meter, valid in the former BRD (west germany) in 52?20' N ... 55?00' N */
 	public static final TransformParameters GK_NORD_GERMANY =  GK_NORD_GERMANY_TO_WGS84; 
 
 	//	 taken from http://crs.bkg.bund.de/crs-eu/ click on "national CRS" -> germany -> DE_DHDN / GK_3 -> DE_DHDN (Middle) to ETRS89
 	private static final TransformParameters GK_MID_GERMANY_TO_WGS84 = new TransformParameters(584.8, 67.0, 400.3, -0.105, -0.013, 2.378, 10.290, false);
-	/** use this for mid-Germany, maximum sub meter, valid in the former BRD (west germany) in 50?20' N ... 52?20' N */
+	/** use this for mid-Germany, maximum deviation sub meter, valid in the former BRD (west germany) in 50?20' N ... 52?20' N */
 	public static final TransformParameters GK_MID_GERMANY =  GK_MID_GERMANY_TO_WGS84; 
 
 	//	 taken from http://crs.bkg.bund.de/crs-eu/ click on "national CRS" -> germany -> DE_DHDN / GK_3 -> DE_DHDN (South) to ETRS89
 	private static final TransformParameters GK_SOUTH_GERMANY_TO_WGS84 = new TransformParameters(597.1, 71.4, 412.1, -0.894, -0.068, 1.563, 7.580, false);
-	/** use this for south Germany, maximum sub meter, valid in the former BRD (west germany) in 47?00' N ... 50?20' N */
+	/** use this for south Germany, maximum deviation sub meter, valid in the former BRD (west germany) in 47?00' N ... 50?20' N */
 	public static final TransformParameters GK_SOUTH_GERMANY =  GK_SOUTH_GERMANY_TO_WGS84; 
 
 	private static Area FORMER_GDR = new Area(new CWPoint(54.923414, 10.503013), new CWPoint(50.402578, 14.520637)); 
@@ -100,7 +101,7 @@
 		}
 		return ret;
 	}
-	
+		
 	/**
 	 * This is the most abstract method: If you don't know 
 	 * when to use another one (if you are in need to do so, you will
@@ -108,7 +109,7 @@
 	 * @param gk
 	 * @return
 	 */
-	public static CWPoint gkGermanyToWgs84(GkPoint gk) {
+	public static CWPoint germanGkToWgs84(GkPoint gk) {
 		return  gkToWgs84(gk, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
 	}
 
@@ -118,30 +119,67 @@
 	 * know), use this one. This routine chooses automatically the best known
 	 * transformation parameters. Currently the maximam deviation is 1m for the
 	 * former BRD and 1.13m for the former GDR 
+	 * It also chooses automatically the correct stripe
 	 * @param gk
 	 * @return
 	 */
-	public static GkPoint wgs84ToGkGermany(CWPoint ll) {
-		if (FORMER_GDR.isInBound(ll)) wgs84ToGk(ll, GK_GERMANY_2001); // exlcude former GDR from the splitting germany in north/middel/south
-		if (ll.latDec <= 55 && ll.latDec >= 52.33333334 ) return  wgs84ToGk(ll, GK_NORD_GERMANY);
-		if (ll.latDec <= 52.33333334  && ll.latDec >= 50.33333334 ) return  wgs84ToGk(ll, GK_MID_GERMANY);
-		if (ll.latDec <= 50.33333334  && ll.latDec >= 47) return  wgs84ToGk(ll, GK_MID_GERMANY);
-		return  wgs84ToGk(ll, GK_GERMANY_2001); 	
+	public static GkPoint wgs84ToGermanGK(CWPoint ll) {
+		return  wgs84ToGk(ll, getGermanGkTransformParameters(ll)); 	
 	}
-
+	
+	public static TransformParameters getGermanGkTransformParameters(CWPoint ll) {
+		if (FORMER_GDR.isInBound(ll)) return GK_GERMANY_2001; // exlcude former GDR from the splitting germany in north/middel/south
+		if (ll.latDec <= 55 && ll.latDec >= 52.33333334 ) return  GK_NORD_GERMANY;
+		if (ll.latDec <= 52.33333334  && ll.latDec >= 50.33333334 ) return  GK_MID_GERMANY;
+		if (ll.latDec <= 50.33333334  && ll.latDec >= 47) return  GK_MID_GERMANY;
+		return GK_GERMANY_2001;
+	}
+	
 	/**
+	 * Standard Gau?-Kr?ger: stripewidth = 3, stripe automatically chosen
+	 * @param ll
+	 * @param gk2wgs84
+	 * @return
+	 */
+	public static GkPoint wgs84ToGk(CWPoint ll, TransformParameters gk2wgs84) {
+		return wgs84ToGk(ll, gk2wgs84, -1, 3);
+	}
+	
+	
+	/**
+	 * This function returns the position in the list of the given epsg code list
+	 * which corresondes to the stripe used in Gau?-Kr?ger Point gk
+	 * @param epsgcodes list of epsgcodes
+	 * @param gk
+	 * @return postion in array of epsgcodes, -1 if not found
+	 */
+	public static int whichEpsg(int[] epsgcodes, GkPoint gk) {
+		int stripe = gk.getStripe();
+		int i;
+		for (i = 0; i < epsgcodes.length; i++) {
+			if (getGermanGkStripeEpsg(epsgcodes[i]) == stripe) break;
+		}
+		if (i >= epsgcodes.length) return -1;
+		return i;
+	}
+	
+	/**
 	 * Call this routine to convert from wgs84 into German Gau?-Kr?ger-Coordinates 
 	 * using the Gau?-Kr?ger Projection and the Bessel ellipsoid
-	 * 	 *  
+	 * If you want the Gau?-Kr?ger-Coordinates in a certain stripe, provide the
+	 * stripe and stripe width, otherwise set stripe to -1, then the stripe 
+	 * will be automatically determined
 	 * @param ll
 	 * @param Gau?-Kr?ger-to-WGS84 transformation parameters, they will be automatically inverted
+	 * @param stripe stripe to force to, otherwise -1 will determine the stripe automatically
 	 * @return
-	 */
-	public static GkPoint wgs84ToGk(CWPoint ll, TransformParameters gk2wgs84) {
+	 */ // TODO find out what about the Krassowski in former GDR?
+	public static GkPoint wgs84ToGk(CWPoint ll, TransformParameters gk2wgs84, int stripe, int stripewidth) {
 		XyzCoordinates wgsxyz = latLon2xyz(ll, 0, WGS84);
 		XyzCoordinates gkxyz = transform(wgsxyz, new TransformParameters(gk2wgs84, true));
-		CWPoint gkll = Xyz2Latlon(gkxyz, BESSEL);
-		return projectLatlon2GK(gkll, BESSEL, 3);
+		CWPoint gkll = xyz2Latlon(gkxyz, BESSEL);
+		if (stripe == -1)	return projectLatlon2GkStripeauto(gkll, BESSEL, stripewidth);
+		else return projectLatlon2GK(gkll, BESSEL, stripewidth, stripe); 
 	}
 	/**
 	 * Call this method to convert any Gau?-Kr?ger coordinates into
@@ -151,13 +189,37 @@
 	 * @return
 	 */
 	public static CWPoint gkToWgs84(GkPoint gk, TransformParameters gk2wgs84) {
-		CWPoint gkll = GK2LatLon(gk, BESSEL, 3);
+		CWPoint gkll = gk2LatLon(gk, BESSEL, 3);
 		XyzCoordinates wgsxyz = latLon2xyz(gkll, 0, BESSEL);
 		XyzCoordinates wgs84xyz = transform(wgsxyz, gk2wgs84);
-		CWPoint wgsll = Xyz2Latlon(wgs84xyz, WGS84);
+		CWPoint wgsll = xyz2Latlon(wgs84xyz, WGS84);
 		return wgsll;
 	}
-
+	
+	/**
+	 * this routine gives the correct german Gau?-Kr?ger coordinates
+	 * in the stripe specified by EPSG-Code
+	 * @param wgs84
+	 * @param epsgcode
+	 * @return
+	 * @throws IllegalArgumentException if EPSG code is not german GK or unsupported
+	 */
+	public static GkPoint wgs84ToGermanGk(CWPoint wgs84, int epsgcode) throws IllegalArgumentException {
+		return wgs84ToGk(wgs84, getGermanGkTransformParameters(wgs84), getGermanGkStripeEpsg(epsgcode), 3);
+	}
+	
+	private static int getGermanGkStripeEpsg(int epsgcode) {
+		int stripe;
+		switch (epsgcode) {
+		case EPSG_GK2: stripe = 2; break;
+		case EPSG_GK3: stripe = 3; break;
+		case EPSG_GK4: stripe = 4; break;
+		case EPSG_GK5: stripe = 5; break;
+		default: throw new IllegalArgumentException("wgs84ToGermanGk: epsgcode: " + epsgcode + "is not a german Gau?-Kr?ger coordinate");
+		}
+		return stripe; 
+	}
+	
 	private static XyzCoordinates latLon2xyz(CWPoint ll, double alt, Ellipsoid ellipsoid) {
 		if (!ll.isValid()) throw new IllegalArgumentException("latLon2xyz: invalid lat-lon");
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
@@ -200,7 +262,7 @@
 		return new XyzCoordinates(coos.matrix[0][0], coos.matrix[1][0], coos.matrix[2][0]);
 	}
 
-	private static CWPoint Xyz2Latlon(XyzCoordinates from, Ellipsoid ellipsoid) {
+	private static CWPoint xyz2Latlon(XyzCoordinates from, Ellipsoid ellipsoid) {
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
 		double s = Math.sqrt( Math.pow(from.x,2) + Math.pow(from.y,2));
 		double T = Math.atan( from.z * ellipsoid.a / (s * ellipsoid.b));
@@ -215,13 +277,7 @@
 		return ret;
 	}
 
-	/**
-	 * Project latlon to Gau?-Kr?ger-Coordinates on ellipsoid
-	 * @param latlon
-	 * @param ellipsoid
-	 * @return
-	 */
-	private static GkPoint projectLatlon2GK(CWPoint latlon, Ellipsoid ellipsoid, int stripewidth) {
+	private static GkPoint projectLatlon2GkStripeauto(CWPoint latlon, Ellipsoid ellipsoid, int stripewidth) {
 		if (!latlon.isValid()) throw new IllegalArgumentException("projectLatlon2GK: lat-lon not valid");
 		CWPoint ll = new CWPoint(latlon); // copy the point, in order to avoid modifying the parameter latlon
 		if (ll.lonDec < 0) ll.lonDec += 360;
@@ -229,9 +285,19 @@
 		for (stripe = 0; stripe <= 360; stripe += stripewidth) {
 			if (Math.abs(ll.lonDec - stripe) <= ((float)stripewidth) / 2) break;
 		}
+		return projectLatlon2GK(latlon, ellipsoid, stripewidth, stripe / stripewidth);
+	}
+
+	/**
+	 * Project latlon to Gau?-Kr?ger-Coordinates on ellipsoid
+	 * @param latlon
+	 * @param ellipsoid
+	 * @return
+	 */
+	private static GkPoint projectLatlon2GK(CWPoint latlon, Ellipsoid ellipsoid, int stripewidth, int stripe) {
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
-		double l = (ll.lonDec - stripe) /180*Math.PI; // TODO see is int to double works
-		double B = ll.latDec /180*Math.PI;
+		double l = (latlon.lonDec - stripe * stripewidth) /180*Math.PI; // TODO see is int to double works
+		double B = latlon.latDec /180*Math.PI;
 		double N = ellipsoid.a/ Math.sqrt(1- e2 * Math.pow(Math.sin(B),2));
 		double nue = Math.sqrt(Math.pow(ellipsoid.a, 2) / Math.pow(ellipsoid.b, 2)* e2 * Math.pow(Math.cos(B), 2));
 		double t = Math.tan(B);
@@ -250,10 +316,9 @@
 
 		double r1 = N * Math.cos(B) * l;
 		double r2 = N/6 * Math.pow(Math.cos(B), 3) * (1-t*t+nue*nue)*l*l*l;
-		double easting = r1 + r2 + stripe / stripewidth * 1000000 + 500000;
+		double easting = r1 + r2;		//+ stripe / stripewidth * 1000000 + 500000;
 		GkPoint ret = new GkPoint();
-		ret.easting = easting;
-		ret.northing = northing;
+		ret.set(easting, northing, stripe, stripewidth);
 		return ret;
 	}
 
@@ -264,10 +329,9 @@
 	 * @param stripewidth width in degree of the stripe of the Gau?-Kr?ger-System (3 degreee usually used in Gau?-Kr?ger, 6 degree usually in UTM)
 	 * @return
 	 */
-	private static CWPoint GK2LatLon (GkPoint gkp, Ellipsoid ellipsoid, int stripewidth) {
-		double Y0 = Math.floor(gkp.easting / 1000000);
-		double L0 = Y0 * stripewidth; // decimal degree of the center of the stripe
-		double y = gkp.easting - 1000000 * Y0 - 500000;
+	private static CWPoint gk2LatLon (GkPoint gkp, Ellipsoid ellipsoid, int stripewidth) {
+		double L0 = gkp.getStripeLon(); // decimal degree of the center of the stripe
+		double y = gkp.getRawEasting();
 
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
 		// note: n1-n6 are similiar to the n1-n6 in projectLatlon2GK, but some term have different factors
@@ -287,8 +351,8 @@
 
 		double la1 = tf / 2 / Nf/Nf * (-1-nuef*nuef) * y*y;
 		double la2 = tf /24 / Math.pow(Nf, 4) * (5 + 3*tf*tf + 6*nuef*nuef - 6*tf*tf * nuef*nuef - 4*Math.pow(nuef, 4) - 9*tf*tf*Math.pow(nuef, 4)) * Math.pow(y, 4);
-		// these deal this less than the overall calculation precision double la3 = tf /720 / Math.pow(Nf, 6) * (-61 - 90*tf*tf - 45*Math.pow(tf,4) - 107*nuef*nuef + 162*tf*tf * Math.pow(nuef, 2) + 45*Math.pow(tf,4)*tf*Math.pow(nuef, 2)) * Math.pow(y, 6);
-		// these deal this less than the overall calculation precision double la4 = tf /40320 / Math.pow(Nf, 8) * (1385+3663*tf*tf - 4095*Math.pow(tf,4) + 1575*Math.pow(nuef, 6)) * Math.pow(y, 8);
+		// these deal with less than the overall calculation precision: double la3 = tf /720 / Math.pow(Nf, 6) * (-61 - 90*tf*tf - 45*Math.pow(tf,4) - 107*nuef*nuef + 162*tf*tf * Math.pow(nuef, 2) + 45*Math.pow(tf,4)*tf*Math.pow(nuef, 2)) * Math.pow(y, 6);
+		// these deal with less than the overall calculation precision: double la4 = tf /40320 / Math.pow(Nf, 8) * (1385+3663*tf*tf - 4095*Math.pow(tf,4) + 1575*Math.pow(nuef, 6)) * Math.pow(y, 8);
 		double lat = (Bf + la1 + la2) * 180 / Math.PI;
 
 		double lo1 = 1 / Nf / Math.cos(Bf) * y;



From pfeffer at mail.berlios.de  Sat Nov 10 13:07:08 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sat, 10 Nov 2007 13:07:08 +0100
Subject: [Cachewolf-svn] r1050 - in trunk: res_noewe src/CacheWolf/navi
Message-ID: <200711101207.lAAC78U2019040@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-10 13:06:58 +0100 (Sat, 10 Nov 2007)
New Revision: 1050

Modified:
   trunk/res_noewe/luftbild-nrw.wms
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/MapLoaderGui.java
Log:
WMS: doesn't start download if scale is out of supported range
WMS: Map Services, which cover the center point around which maps are to be downloaded appear first in the list
WMS: recommendedScale in .wms is now used as default in the download maps dialog

Modified: trunk/res_noewe/luftbild-nrw.wms
===================================================================
--- trunk/res_noewe/luftbild-nrw.wms	2007-11-09 02:44:28 UTC (rev 1049)
+++ trunk/res_noewe/luftbild-nrw.wms	2007-11-10 12:06:58 UTC (rev 1050)
@@ -65,6 +65,11 @@
 # taken from the getCapabilities request "<Layer><ScaleHint min="
 MinScale:	0.1795783591567183
 MaxScale:	5.611823723647454
-# set this according to ImageFormatUrlPart (must start with "."
+# Plaes recommend a scale for this WMS. This scale will appear in the
+# map download dialog as default. Scale is measured in meters per pixel
+# vertical, so, multiply it by 1.41 (=sqrt(2)) to get the scale as measured
+# above in MinScale and MaxScale
+RecommendedScale:	0.5
+# set this according to ImageFormatUrlPart (must start with ".")
 ImageFileExtension: .png
 

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-09 02:44:28 UTC (rev 1049)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-10 12:06:58 UTC (rev 1050)
@@ -52,8 +52,6 @@
 		FileBugfix files = new FileBugfix(".");
 		String FileName;
 		OnlineMapService tempOMS;
-		tempOMS = new ExpediaMapService();
-		onlineMapServices.add(tempOMS);
 		MessageBox f = null; 
 		dateien = files.list("*.wms", File.LIST_FILES_ONLY); //"*.xyz" doesn't work on some systems -> use FileBugFix
 		for(int i = 0; i < dateien.length;i++){
@@ -65,7 +63,8 @@
 				if (f == null) (f=new MessageBox("Warning", "Ignoring error while \n reading web map service definition file \n"+ex.toString(), MessageBox.OKB)).exec();
 			}
 		}
-
+		tempOMS = new ExpediaMapService();
+		onlineMapServices.add(tempOMS);
 	}
 
 	public String[] getAvailableOnlineMapServices(){
@@ -171,7 +170,11 @@
 				if (progressInfobox != null)
 					progressInfobox.setInfo("Downloading calibrated (georeferenced) \n map image \n '" + currentOnlineMapService.getName()+"' \n Downloading tile \n row "+row+" / "+numMapsY+" column "+ col + " / "+numMapsX);
 				center.set(lat, lon);
-				downloadMap(center, tileScale, tilesSize, tilesPath);
+				try {
+					downloadMap(center, tileScale, tilesSize, tilesPath);
+				} catch (Exception e) {
+					this.progressInfobox.addWarning("Tile " + row + "/" + col + ": Ignoring error: " + e.getMessage()+"\n");
+				}
 				if (progressInfobox.isClosed) return;
 				lon += loninc;
 			}
@@ -210,17 +213,13 @@
 		}
 	}
 
-	public void downloadMap(CWPoint center, float scale, Point pixelsize, String path){
-		try {
-			MapInfoObject mio = currentOnlineMapService.getMapInfoObject(center, scale, pixelsize);
-			String filename = createFilename(mio.getCenter(), mio.scale);
-			String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
-			String url = currentOnlineMapService.getUrlForCenterScale(center, scale, pixelsize);
-			downloadUrl(url, path+"/"+imagename);
-			mio.saveWFL();
-		} catch (Exception e) {
-			this.progressInfobox.addWarning("Ignoring error during map download, saving or calibration:\n" + e.getMessage()+"\n");
-		}
+	public void downloadMap(CWPoint center, float scale, Point pixelsize, String path) throws Exception {
+		MapInfoObject mio = currentOnlineMapService.getMapInfoObject(center, scale, pixelsize);
+		String filename = createFilename(mio.getCenter(), mio.scale);
+		String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
+		String url = currentOnlineMapService.getUrlForCenterScale(center, scale, pixelsize);
+		downloadUrl(url, path+"/"+imagename);
+		mio.saveWFL();
 	}
 
 	public String createFilename(CWPoint center, float scale) {
@@ -236,7 +235,7 @@
 	 * and sometimes doesn't send a redirect on the first try 
 	 * @param datei path and name of file to save to
 	 */
-	public void downloadUrl(String url, String datei){
+	public void downloadUrl(String url, String datei) throws IOException {
 		HttpConnection connImg; // TODO move proxy-handling in a global http-class
 		Socket sockImg;
 		FileOutputStream fos;
@@ -287,7 +286,7 @@
 			}
 			//Vm.debug("done");
 		}catch(IOException e){
-			(new MessageBox("Error", "Error while downloading or saving map:\n"+e.getMessage(), MessageBox.OKB)).exec();
+			throw new IOException("Error while downloading or saving map:\n" + e.getMessage());
 		}
 //		(new MessageBox("Error", "Error saving calibration file:\n"+e.getMessage(), MessageBox.OKB)).exec();
 
@@ -299,6 +298,10 @@
 	String MainUrl; //http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS
 	/** including "." */
 	String imageFileExt; // ".gif", ".jpg"...
+	float recommendedScale;
+	double minscale;
+	double maxscale;
+	Area boundingBox;
 
 	/** 
 	 * This method is used in case the online map service provides only certain steps of 
@@ -390,9 +393,8 @@
 	String requestUrlPart;
 	String imageFormatUrlPart; // FORMAT=image/png
 	String stylesUrlPart; // STYLES=
-	Area boundingBox;
-	double minscale;
-	double maxscale;
+	double minscaleWMS;
+	double maxscaleWMS;
 
 	public String getName() {
 		if (layersName == null || layersName.length() == 0)	return name;
@@ -445,10 +447,13 @@
 		if (!topleft.isValid()) topleft.set(90, -180);
 		if (!buttomright.isValid()) buttomright.set(-90, 180);
 		boundingBox = new Area (topleft, buttomright);
-		minscale = Convert.toDouble(wms.getProperty("MinScale", "0").trim());
-		maxscale = Convert.toDouble(wms.getProperty("MaxScale", Convert.toString(java.lang.Double.MAX_VALUE)).trim());
+		minscaleWMS = Convert.toDouble(wms.getProperty("MinScale", "0").trim());
+		maxscaleWMS = Convert.toDouble(wms.getProperty("MaxScale", Convert.toString(java.lang.Double.MAX_VALUE)).trim());
+		minscale = minscaleWMS / Math.sqrt(2); // in WMS scale is measured diagonal while in CacheWolf it is measured vertical
+		maxscale = maxscaleWMS / Math.sqrt(2);
 		imageFileExt = wms.getProperty("ImageFileExtension", "").trim();
 		if (imageFileExt == "") throw new IllegalArgumentException("WebMapService: property >ImageFileExtension:< missing in file:\n" + filename);
+		recommendedScale = Convert.toFloat(wms.getProperty("RecommendedScale", "5").trim());
 	}
 
 	public String getUrlForBoundingBox(Area maparea, Point pixelsize) {
@@ -459,7 +464,7 @@
 		double scaleh = maparea.buttomright.getDistance(buttomleft) * 1000 / pixelsize.x; 
 		double scalev = maparea.topleft.getDistance(topright) * 1000 / pixelsize.y; 
 		double scale = Math.sqrt(scaleh * scaleh + scalev * scalev); // meters per pixel measured diagonal
-		if ( scale < minscale || scale > maxscale) throw new IllegalArgumentException("scale not support by online map service: " + scale + ", supported scale range: " + minscale + " - " + maxscale);
+		if ( scale < minscaleWMS || scale > maxscaleWMS) throw new IllegalArgumentException("scale " + scale / Math.sqrt(2)+ " not supported by online map service, supported scale range: " + minscale + " - " + maxscale + " (measured in meters per pixel vertically)");
 		int crs = 0;
 		String bbox = "BBOX=";
 		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem[0])) {
@@ -556,6 +561,10 @@
 		name = "Expedia";
 		MainUrl = "Rhttp://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz."; //"Rhttp://" forces doenloadUrl to retry the URL until it gets an http-redirect and then downloads from there 
 		imageFileExt = ".gif";
+		recommendedScale = 5;
+		minscale = getMetersPerPixel(0.00000000000000000000001f);
+		maxscale = getMetersPerPixel((float)new CWPoint(0,0).getDistance(new CWPoint(0,180)) * 2 * 1000 / 1000); // whole world * 1000 because of km -> m. /1000 because we have 1000x1000 Pixel usually
+		boundingBox = new Area(new CWPoint(90,-180), new CWPoint(-90,180));
 	}
 
 	public float getMetersPerPixel(float scale) {

Modified: trunk/src/CacheWolf/navi/MapLoaderGui.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-09 02:44:28 UTC (rev 1049)
+++ trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-10 12:06:58 UTC (rev 1050)
@@ -46,6 +46,10 @@
 	mCheckBox overviewChkBoxPerCache = new mCheckBox("download an overview map");
 
 	MapLoader mapLoader;
+	String[] unsortedMapServices;
+	String[] sortedmapServices;
+	int[] sortingMapServices;
+	boolean[] inbound;
 	CWPoint center;
 	Vector cacheDB;
 	boolean perCache;
@@ -63,8 +67,11 @@
 		center = new CWPoint(pref.curCentrePt);
 		cacheDB = cacheDBi;
 		mapLoader = new MapLoader(Global.getPref().myproxy, Global.getPref().myproxyport);
-		
-		mapServiceChoice = new mChoice(mapLoader.getAvailableOnlineMapServices(), 0);
+
+		// sort the items in the list of services in a way that services which cover the current center point.
+		unsortedMapServices = mapLoader.getAvailableOnlineMapServices();
+		sortMapServices();
+		mapServiceChoice = new mChoice(sortedmapServices, 0);
 		MessageArea desc = new MessageArea(descString); 
 		desc.modifyAll(mTextPad.NotEditable | mTextPad.DisplayOnly | mTextPad.NoFocus, mTextPad.TakesKeyFocus);
 		desc.borderStyle = mTextPad.BDR_NOBORDER;
@@ -83,7 +90,9 @@
 		pnlTiles.addNext(coosLbl = new mLabel(MyLocale.getMsg(1803, "around the centre: ")));
 		pnlTiles.addLast(coosBtn = new mButton(center.toString()));
 		pnlTiles.addNext(scaleLbl);
-		scaleInput.setText("5");
+		mapLoader.setCurrentMapService(sortingMapServices[mapServiceChoice.selectedIndex]);
+		scaleInput.setText(Convert.toString(mapLoader.currentOnlineMapService.recommendedScale));
+		scaleInputPerCache.setText(Convert.toString(mapLoader.currentOnlineMapService.recommendedScale));
 		this.focusFirst();
 		pnlTiles.addLast(scaleInput);
 		//	pnlTiles.addLast(resolutionLbl);
@@ -119,17 +128,53 @@
 		mTab.addCard(pnlPerCache, MyLocale.getMsg(1805, "Per cache"), MyLocale.getMsg(1805, "Per Cache"));
 		this.addLast(mTab);
 	}
+
+	/**
+	 * sort the map services in order to have the services, which cover
+	 * the current center first in the list 
+	 * this sets inbound[], sortedMapServices[] and sortingmapServices[]
+	 *
+	 */	
+	private void sortMapServices() {
+		sortingMapServices = new int[unsortedMapServices.length];
+		inbound = new boolean[unsortedMapServices.length];
+		int j=0;
+		for (int i=0; i < sortingMapServices.length; i++) {
+			if( ((OnlineMapService)mapLoader.onlineMapServices.get(i)).boundingBox.isInBound(center)) {
+				sortingMapServices[j] = i;
+				j++;
+				inbound[i] = true;
+			} else inbound[i] = false;
+		}
+		sortedmapServices = new String[unsortedMapServices.length];
+		for (int i=0; i < sortedmapServices.length; i++) {
+			if (!inbound[i]) { 
+				sortingMapServices[j] = i;
+				j++;
+			}
+			sortedmapServices[i] = ((OnlineMapService)mapLoader.onlineMapServices.get(sortingMapServices[i])).getName();
+		}
+	}
+	
+	private int getSortedMapServiceIndex(int originalindex) {
+		for (int i = 0; i < sortingMapServices.length; i++) {
+			if (sortingMapServices[i] == originalindex) return i;
+		}
+		throw new IllegalStateException("getSortedMapServiceIndex: index " + originalindex + "not found");
+	}
+
 	public String getMapsDir() {
 		String ret = Global.getPref().getMapDownloadSavePath(mapLoader.currentOnlineMapService.getName());
 		Global.getPref().saveCustomMapsPath(ret);
 		return ret;
 	}
+
 	public void downloadTiles() {
 		String mapsDir = getMapsDir();
 		if (mapsDir == null) return;
 		InfoBox progressBox = new InfoBox("Downloading georeferenced maps", "Downloading georeferenced maps\n \n \n \n \n", InfoBox.PROGRESS_WITH_WARNINGS);
 		progressBox.setPreferredSize(220, 300);
-		progressBox.setInfoHeight(180);
+		progressBox.setInfoHeight(160);
 		progressBox.relayout(false);
 		progressBox.exec();
 		mapLoader.setProgressInfoBox(progressBox);
@@ -151,7 +196,11 @@
 		if (overviewmap) {
 			progressBox.setInfo("downloading overview map"); 
 			float scale = MapLoader.getScale(center, radius * 1000, size);
-			mapLoader.downloadMap(center, scale, size, mapsDir);
+			try {
+				mapLoader.downloadMap(center, scale, size, mapsDir);
+			} catch (Exception e) {
+				progressBox.addWarning("Overview map: Ignoring error: " + e.getMessage()+"\n");
+			}
 		}
 		if (!perCache){  // download tiles
 			mapLoader.setProgressInfoBox(progressBox);
@@ -172,7 +221,11 @@
 					if (ch.pos.isValid() && ch.pos.latDec != 0 && ch.pos.lonDec != 0) { // TODO != 0 sollte verschwinden, sobald das handling von nicht gesetzten Koos ?berall korrekt ist
 						numdownloaded++;
 						progressBox.setInfo("Downloading map '"+mapLoader.currentOnlineMapService.getName()+"'\n"+numdownloaded+" / "+numCaches+"\n for cache:\n"+ch.CacheName);
-						mapLoader.downloadMap(ch.pos, scale, size, mapsDir);
+						try {
+							mapLoader.downloadMap(ch.pos, scale, size, mapsDir);
+						} catch (Exception e) {
+							progressBox.addWarning("Cache: " + ch.CacheName + "(" + ch.wayPoint + ") Ignoring error: " + e.getMessage()+"\n");
+						}
 					}
 				}
 			}
@@ -184,7 +237,7 @@
 		mapLoader.setProgressInfoBox(null);
 		//progressBox.close(0);
 		if(Global.mainTab.mm != null) Global.mainTab.mm.mapsloaded = false; 
-	//	(new MessageBox("Download maps", "Downloaded and calibrated the maps successfully", MessageBox.OKB)).execute();
+		//	(new MessageBox("Download maps", "Downloaded and calibrated the maps successfully", MessageBox.OKB)).execute();
 	}
 
 
@@ -216,7 +269,7 @@
 				this.close(Form.IDCANCEL);
 			}
 			if (ev.target == okBtiles || ev.target == okBPerCache){
-				mapLoader.setCurrentMapService(mapServiceChoice.selectedIndex);
+				mapLoader.setCurrentMapService(sortingMapServices[mapServiceChoice.selectedIndex]);
 				if (ev.target == okBtiles) { // get tiles
 					perCache = false;
 					if (forSelectedChkBox.getSelectedItem().toString().equalsIgnoreCase("all")) onlySelected = false;
@@ -246,10 +299,10 @@
 					overviewmap = overviewChkBoxPerCache.getState();
 					scale = Convert.toFloat(scaleInputPerCache.getText());
 				}
-		/*		if (scale < 1 || scale != java.lang.Math.floor(scale)) {
-					(new MessageBox("Error", "'Approx. meter pro pixel' must be greater than 0 and must not contain a point", MessageBox.OKB)).execute();
+				if (scale < mapLoader.currentOnlineMapService.minscale || scale > mapLoader.currentOnlineMapService.maxscale) {
+					(new MessageBox("Error", "The selected online map service provides map in the scale from " + mapLoader.currentOnlineMapService.minscale + " to "+ mapLoader.currentOnlineMapService.maxscale +"\n please adjust 'Approx. meter pro pixel' accordingly", MessageBox.OKB)).execute();
 					return;
-				} */
+				}
 				this.close(Form.IDOK); 
 				this.downloadTiles();
 			}
@@ -259,12 +312,20 @@
 				if (cs.execute() != CoordsScreen.IDCANCEL) {
 					center = cs.getCoords();
 					coosBtn.setText(center.toString());
+					int tmp = sortingMapServices[mapServiceChoice.selectedIndex];
+					sortMapServices();
+					mapServiceChoice.set(sortedmapServices, (!inbound[tmp] ? 0 : getSortedMapServiceIndex((tmp))));
 				}
 			}
 			if (ev.target == forCachesChkBox) {
 				updateForCachesState();
 			}
-		} // if controllEvent...
+		} // end of "if controllEvent..."
+		if (ev instanceof DataChangeEvent && ev.target == mapServiceChoice) {
+			mapLoader.setCurrentMapService(sortingMapServices[mapServiceChoice.selectedIndex]);
+			scaleInput.setText(Convert.toString(mapLoader.currentOnlineMapService.recommendedScale));
+			scaleInputPerCache.setText(Convert.toString(mapLoader.currentOnlineMapService.recommendedScale));
+		}
 		super.onEvent(ev);
 	}
 }



From salzkammergut at mail.berlios.de  Sat Nov 10 18:24:13 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sat, 10 Nov 2007 18:24:13 +0100
Subject: [Cachewolf-svn] r1051 - trunk/src/CacheWolf
Message-ID: <200711101724.lAAHOD5N013954@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-10 18:24:09 +0100 (Sat, 10 Nov 2007)
New Revision: 1051

Modified:
   trunk/src/CacheWolf/SpiderGC.java
Log:
SpiderGC: Fix for login problem with special characters (like ae, ue, oe, & etc.). Also added a loop to the main spider function to try up to three times if the coordinates cannot be parsed (during a recent update I had several caches where the page was invalid).

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-11-10 12:06:58 UTC (rev 1050)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-11-10 17:24:09 UTC (rev 1051)
@@ -134,13 +134,19 @@
 				//Ok now login!
 				try{
 					pref.log("Logging in as "+pref.myAlias);
-					doc = URL.encodeURL("__VIEWSTATE",false) +"="+ URL.encodeURL(viewstate,false)
-					+ "&" + URL.encodeURL("myUsername",false) +"="+ encodeUTF8(new String(Utils.encodeJavaUtf8String(pref.myAlias)))
-					+ "&" + URL.encodeURL("myPassword",false) +"="+ encodeUTF8(new String(Utils.encodeJavaUtf8String(passwort)))
-					+ "&" + URL.encodeURL("cookie",false) +"="+ URL.encodeURL("on",false)
-					+ "&" + URL.encodeURL("Button1",false) +"="+ URL.encodeURL("Login",false)
-					+ "&" + URL.encodeURL("__EVENTVALIDATION",false) +"="+ URL.encodeURL(eventvalidation,false);
-					start = fetch_post(loginPage, doc, nextPage);  // /login/default.aspx
+					StringBuffer sb=new StringBuffer(1000);
+					sb.append(URL.encodeURL("__VIEWSTATE",false));	sb.append("="); sb.append(URL.encodeURL(viewstate,false));
+					sb.append("&"); sb.append(URL.encodeURL("myUsername",false));
+					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(pref.myAlias)));
+					sb.append("&"); sb.append(URL.encodeURL("myPassword",false));
+					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(passwort)));
+					sb.append("&"); sb.append(URL.encodeURL("cookie",false));
+					sb.append("="); sb.append(URL.encodeURL("on",false));
+					sb.append("&"); sb.append(URL.encodeURL("Button1",false));
+					sb.append("="); sb.append(URL.encodeURL("Login",false));
+					sb.append("&"); sb.append(URL.encodeURL("__EVENTVALIDATION",false));
+					sb.append("="); sb.append(URL.encodeURL(eventvalidation,false));
+					start = fetch_post(loginPage, sb.toString(), nextPage);  // /login/default.aspx
 					if(start.indexOf(loginSuccess) > 0)
 						pref.log("Login successful");
 					else {
@@ -441,131 +447,140 @@
 	 */
 	private boolean getCacheByWaypointName(CacheHolderDetail chD, boolean isUpdate, boolean fetchImages, boolean doNotGetFound, boolean fetchAllLogs) {
 		String completeWebPage;
-		try{
-			String doc = p.getProp("getPageByName") + chD.wayPoint +(fetchAllLogs?p.getProp("fetchAllLogs"):"");
-			pref.log("Fetching: " + chD.wayPoint);
-			completeWebPage = fetch(doc);
-		}catch(Exception ex){
-			pref.log("Could not fetch " + chD.wayPoint,ex);
-			chD.is_incomplete = true;
-			return !infB.isClosed; // Only return false (which terminates the loop over all caches) if infB is closed
-		}
-		// Only analyse the cache data and fetch pictures if user has not closed the progress window
-		if (!infB.isClosed) {
+		int spiderTrys=0;
+		int MAX_SPIDER_TRYS=3;
+		while (spiderTrys++<MAX_SPIDER_TRYS) {
 			try{
-				chD.is_new = !isUpdate;
-				chD.is_update = false;
-				chD.is_log_update=false;
-				chD.is_HTML = true;
-				chD.is_available = true;
-				chD.is_archived = false;
-				chD.is_incomplete = false;
-				// Save size of logs to be able to check whether any new logs were added
-				//int logsz = chD.CacheLogs.size();
-				//chD.CacheLogs.clear();
-				chD.addiWpts.clear();
-				chD.Images.clear();
-				chD.ImagesText.clear();
-
-				if(completeWebPage.indexOf(p.getProp("cacheUnavailable")) >= 0) chD.is_available = false;
-				if(completeWebPage.indexOf(p.getProp("cacheArchived")) >= 0) chD.is_archived = true;
-				//==========
-				// General Cache Data
-				//==========
-				chD.setLatLon(getLatLon(completeWebPage));
-				if (pref.debug) pref.log("LatLon: " + chD.LatLon);
-
-				pref.log("Trying description");
-				chD.setLongDescription(getLongDesc(completeWebPage));
-				pref.log("Got description");
-
-				pref.log("Getting cache name");
-				chD.CacheName = SafeXML.cleanback(getName(completeWebPage));
-				pref.log("Got cache name");
-				if (pref.debug) pref.log("Name: " + chD.CacheName);
-
-				pref.log("Trying owner");
-				chD.CacheOwner = SafeXML.cleanback(getOwner(completeWebPage)).trim();
-				if(chD.CacheOwner.equals(pref.myAlias) || (pref.myAlias2.length()>0 && chD.CacheOwner.equals(pref.myAlias2))) chD.is_owned = true;
-				pref.log("Got owner");
-				if (pref.debug) pref.log("Owner: " + chD.CacheOwner +"; is_owned = "+chD.is_owned+";  alias1,2 = ["+pref.myAlias+"|"+pref.myAlias2+"]");
-
-				pref.log("Trying date hidden");
-				chD.DateHidden = DateFormat.MDY2YMD(getDateHidden(completeWebPage));
-				pref.log("Got date hidden");
-				if (pref.debug) pref.log("Hidden: " + chD.DateHidden);
-
-				pref.log("Trying hints");
-				chD.setHints(getHints(completeWebPage));
-				pref.log("Got hints");
-				if (pref.debug) pref.log("Hints: " + chD.Hints);
-
-				pref.log("Trying size");
-				chD.CacheSize = getSize(completeWebPage);
-				pref.log("Got size");
-				if (pref.debug) pref.log("Size: " + chD.CacheSize);
-
-				pref.log("Trying difficulty");
-				chD.hard = getDiff(completeWebPage);
-				pref.log("Got difficulty");
-				if (pref.debug) pref.log("Hard: " + chD.hard);
-
-				pref.log("Trying terrain");
-				chD.terrain = getTerr(completeWebPage);
-				pref.log("Got terrain");
-				if (pref.debug) pref.log("Terr: " + chD.terrain);
-
-				pref.log("Trying cache type");
-				chD.type = getType(completeWebPage);
-				pref.log("Got cache type");
-				if (pref.debug) pref.log("Type: " + chD.type);
-
-				//==========
-				// Logs
-				//==========
-				pref.log("Trying logs");
-				chD.setCacheLogs(getLogs(completeWebPage, chD));
-				pref.log("Found logs");
-
-				// If the switch is set to not store found caches and we found the cache => return
-				if (chD.is_found && doNotGetFound) return !infB.isClosed;
-
-				//==========
-				// Bugs
-				//==========
-				// As there may be several bugs, we check whether the user has aborted
-				if (!infB.isClosed) getBugs(chD,completeWebPage);
-				chD.has_bug = chD.Travelbugs.size()>0;
-
-				//==========
-				// Images
-				//==========
-				if(fetchImages){
-					pref.log("Trying images");
-					getImages(completeWebPage, chD);
-					pref.log("Got images");
-				}
-				//==========
-				// Addi waypoints
-				//==========
-
-				pref.log("Getting additional waypoints");
-				getAddWaypoints(completeWebPage, chD.wayPoint, chD.is_found);
-				pref.log("Got additional waypoints");
-
-				//==========
-				// Attributes
-				//==========
-				pref.log("Getting attributes");
-				getAttributes(completeWebPage, chD);
-				pref.log("Got attributes");
-				if (chD.is_new) chD.is_update=false;
+				String doc = p.getProp("getPageByName") + chD.wayPoint +(fetchAllLogs?p.getProp("fetchAllLogs"):"");
+				pref.log("Fetching: " + chD.wayPoint);
+				completeWebPage = fetch(doc);
 			}catch(Exception ex){
-				pref.log("Error reading cache: "+chD.wayPoint);
-				pref.log("Exception in getCacheByWaypointName: ",ex);
+				pref.log("Could not fetch " + chD.wayPoint,ex);
+				chD.is_incomplete = true;
+				return !infB.isClosed; // Only return false (which terminates the loop over all caches) if infB is closed
 			}
-			finally{}
-		}
+			// Only analyse the cache data and fetch pictures if user has not closed the progress window
+			if (!infB.isClosed) {
+				try{
+					chD.is_new = !isUpdate;
+					chD.is_update = false;
+					chD.is_log_update=false;
+					chD.is_HTML = true;
+					chD.is_available = true;
+					chD.is_archived = false;
+					chD.is_incomplete = false;
+					// Save size of logs to be able to check whether any new logs were added
+					//int logsz = chD.CacheLogs.size();
+					//chD.CacheLogs.clear();
+					chD.addiWpts.clear();
+					chD.Images.clear();
+					chD.ImagesText.clear();
+	
+					if(completeWebPage.indexOf(p.getProp("cacheUnavailable")) >= 0) chD.is_available = false;
+					if(completeWebPage.indexOf(p.getProp("cacheArchived")) >= 0) chD.is_archived = true;
+					//==========
+					// General Cache Data
+					//==========
+					chD.setLatLon(getLatLon(completeWebPage));
+					if (pref.debug) pref.log("LatLon: " + chD.LatLon);
+					if (chD.LatLon.equals("???")) {
+						pref.log(">>>> Failed to spider Cache. Retry.");
+						continue; // Restart the spider
+					}
+					pref.log("Trying description");
+					chD.setLongDescription(getLongDesc(completeWebPage));
+					pref.log("Got description");
+	
+					pref.log("Getting cache name");
+					chD.CacheName = SafeXML.cleanback(getName(completeWebPage));
+					pref.log("Got cache name");
+					if (pref.debug) pref.log("Name: " + chD.CacheName);
+	
+					pref.log("Trying owner");
+					chD.CacheOwner = SafeXML.cleanback(getOwner(completeWebPage)).trim();
+					if(chD.CacheOwner.equals(pref.myAlias) || (pref.myAlias2.length()>0 && chD.CacheOwner.equals(pref.myAlias2))) chD.is_owned = true;
+					pref.log("Got owner");
+					if (pref.debug) pref.log("Owner: " + chD.CacheOwner +"; is_owned = "+chD.is_owned+";  alias1,2 = ["+pref.myAlias+"|"+pref.myAlias2+"]");
+	
+					pref.log("Trying date hidden");
+					chD.DateHidden = DateFormat.MDY2YMD(getDateHidden(completeWebPage));
+					pref.log("Got date hidden");
+					if (pref.debug) pref.log("Hidden: " + chD.DateHidden);
+	
+					pref.log("Trying hints");
+					chD.setHints(getHints(completeWebPage));
+					pref.log("Got hints");
+					if (pref.debug) pref.log("Hints: " + chD.Hints);
+	
+					pref.log("Trying size");
+					chD.CacheSize = getSize(completeWebPage);
+					pref.log("Got size");
+					if (pref.debug) pref.log("Size: " + chD.CacheSize);
+	
+					pref.log("Trying difficulty");
+					chD.hard = getDiff(completeWebPage);
+					pref.log("Got difficulty");
+					if (pref.debug) pref.log("Hard: " + chD.hard);
+	
+					pref.log("Trying terrain");
+					chD.terrain = getTerr(completeWebPage);
+					pref.log("Got terrain");
+					if (pref.debug) pref.log("Terr: " + chD.terrain);
+	
+					pref.log("Trying cache type");
+					chD.type = getType(completeWebPage);
+					pref.log("Got cache type");
+					if (pref.debug) pref.log("Type: " + chD.type);
+	
+					//==========
+					// Logs
+					//==========
+					pref.log("Trying logs");
+					chD.setCacheLogs(getLogs(completeWebPage, chD));
+					pref.log("Found logs");
+	
+					// If the switch is set to not store found caches and we found the cache => return
+					if (chD.is_found && doNotGetFound) return !infB.isClosed;
+	
+					//==========
+					// Bugs
+					//==========
+					// As there may be several bugs, we check whether the user has aborted
+					if (!infB.isClosed) getBugs(chD,completeWebPage);
+					chD.has_bug = chD.Travelbugs.size()>0;
+	
+					//==========
+					// Images
+					//==========
+					if(fetchImages){
+						pref.log("Trying images");
+						getImages(completeWebPage, chD);
+						pref.log("Got images");
+					}
+					//==========
+					// Addi waypoints
+					//==========
+	
+					pref.log("Getting additional waypoints");
+					getAddWaypoints(completeWebPage, chD.wayPoint, chD.is_found);
+					pref.log("Got additional waypoints");
+	
+					//==========
+					// Attributes
+					//==========
+					pref.log("Getting attributes");
+					getAttributes(completeWebPage, chD);
+					pref.log("Got attributes");
+					if (chD.is_new) chD.is_update=false;
+					break;
+				}catch(Exception ex){
+					pref.log("Error reading cache: "+chD.wayPoint);
+					pref.log("Exception in getCacheByWaypointName: ",ex);
+				}
+				finally{}
+			}
+		} // spiderTrys
+		if (spiderTrys==MAX_SPIDER_TRYS) pref.log(">>> Failed to spider cache. Number of retrys exhausted.");
 		boolean ret=!infB.isClosed; // If the infoBox was closed before getting here, we return false
 		return ret;
 	} // getCacheByWaypointName
@@ -1288,36 +1303,22 @@
 
 	final static String hex = ewe.util.TextEncoder.hex;
 
-	public String encodeUTF8(String username) {
-		char [] what = ewe.sys.Vm.getStringChars(username);
+	public String encodeUTF8URL(byte[] what) {
 		int max = what.length;
 		char [] dest = new char[6*max]; // Assume each char is a UTF char and encoded into 6 chars
 		char d = 0;
 		for (int i = 0; i<max; i++){
-			char c = what[i];
+			char c = (char) what[i];
 			if (c == ' ') c = '+';
-			else if (c<='\u00FF') {
-				if(c <= ' ' || c == '+' || c == '&' || c == '%' || c == '=' ||
-				   c == '|' || c == '{' || c == '}' || c>'\u007F'){
+			else if (c <= ' ' || c == '+' || c == '&' || c == '%' || c == '=' ||
+				   c == '|' || c == '{' || c == '}' || c>0x7f ){
 					dest[d++] = '%';
 					dest[d++] = hex.charAt((c >> 4) & 0xf);
 					dest[d++] = hex.charAt(c & 0xf);
-					continue;
-				}
-
-			} else {
-				dest[d++] = '%';
-				dest[d++] = hex.charAt((c >> 12) & 0xf);
-				dest[d++] = hex.charAt((c >> 8) & 0xf);
-				dest[d++] = '%';
-				dest[d++] = hex.charAt((c >> 4) & 0xf);
-				dest[d++] = hex.charAt(c & 0xf);
-				continue;
-			}
-			dest[d++] = c;
+			} else dest[d++] = c;
 		}
 		return new String(dest,0,d);
-	}
+	}	
 
 	/**
 	 * Load the bug id for a given name. This method is not ideal, as there are



From salzkammergut at mail.berlios.de  Sat Nov 10 22:19:24 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sat, 10 Nov 2007 22:19:24 +0100
Subject: [Cachewolf-svn] r1052 - in trunk: resources src/CacheWolf
Message-ID: <200711102119.lAALJOZj011555@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-10 22:19:09 +0100 (Sat, 10 Nov 2007)
New Revision: 1052

Added:
   trunk/resources/sizeLarge.png
   trunk/resources/sizeMicro.png
   trunk/resources/sizeReg.png
   trunk/resources/sizeSmall.png
   trunk/resources/sizeVLarge.png
Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/TableColumnChooser.java
   trunk/src/CacheWolf/TravelbugJourneyScreen.java
   trunk/src/CacheWolf/myTableModel.java
Log:
New feature: Size of cache can be displayed in list view (needs to be configured in preferences screen)

Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-11-10 17:24:09 UTC (rev 1051)
+++ trunk/resources/cachewolf.Languages.cfg	2007-11-10 21:19:09 UTC (rev 1052)
@@ -182,6 +182,7 @@
 		632=Mehr
 		633=Max. logs spidern
 		634=Proxy verwenden
+		635=Gr%f6%dfe
 		700=Filter setzen
 		701=Entfernung
 		702=Schwierigkeit
@@ -257,6 +258,7 @@
 		1014=Markierte aktualisieren
 		1015=Alle w%e4hlen
 		1016=Alle abw%e4hlen
+		1017=G
 		1018=Im Browser offline %f6ffnen
 		1019=Diesen als Zentrum setzen
 		1020=Im Browser online %f6ffnen
@@ -733,6 +735,7 @@
 		632=More
 		633=Max. logs to spider
 		634=use Proxy
+		635=Size
 		700=Set filter
 		701=Distance
 		702=Difficulty
@@ -808,6 +811,7 @@
 		1014=Update cache data
 		1015=Select all
 		1016=Deselect all
+		1017=S
 		1018=Open offline in Browser
 		1019=Set this as centre
 		1020=Open online in Browser

Added: trunk/resources/sizeLarge.png
===================================================================
(Binary files differ)


Property changes on: trunk/resources/sizeLarge.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/resources/sizeMicro.png
===================================================================
(Binary files differ)


Property changes on: trunk/resources/sizeMicro.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/resources/sizeReg.png
===================================================================
(Binary files differ)


Property changes on: trunk/resources/sizeReg.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/resources/sizeSmall.png
===================================================================
(Binary files differ)


Property changes on: trunk/resources/sizeSmall.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/resources/sizeVLarge.png
===================================================================
(Binary files differ)


Property changes on: trunk/resources/sizeVLarge.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-11-10 17:24:09 UTC (rev 1051)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-11-10 21:19:09 UTC (rev 1052)
@@ -187,7 +187,8 @@
 				MyLocale.getMsg(610,"Hidden"),
 				MyLocale.getMsg(611,"Status"),
 				MyLocale.getMsg(612,"Distance"),
-				MyLocale.getMsg(613,"Bearing")},pref.listColMap),MyLocale.getMsg(595,"List"),null);
+				MyLocale.getMsg(613,"Bearing"),
+				MyLocale.getMsg(635,"Size")},pref.listColMap),MyLocale.getMsg(595,"List"),null);
 
 		Card c=mTab.addCard(tccBugs=new TableColumnChooser(new String[] {
 				MyLocale.getMsg(6000,"Guid"),

Modified: trunk/src/CacheWolf/TableColumnChooser.java
===================================================================
--- trunk/src/CacheWolf/TableColumnChooser.java	2007-11-10 17:24:09 UTC (rev 1051)
+++ trunk/src/CacheWolf/TableColumnChooser.java	2007-11-10 21:19:09 UTC (rev 1052)
@@ -11,8 +11,8 @@
 public class TableColumnChooser extends CellPanel {
 
 	String [] colNames;
-	Vector shownCols=new Vector(13);
-	Vector hiddenCols=new Vector(13);
+	Vector shownCols=new Vector(14);
+	Vector hiddenCols=new Vector(14);
 	private mButton btnDown,btnUp,btnLeft,btnRight;
 	private myList lstShown,lstHidden;
 	
@@ -187,17 +187,19 @@
 	 * Converts a comma delimited string into an integer array.
 	 * Each value is checked and has to be between min and max, If not it is
 	 * replaced with default
+	 * @param minSize TODO
 	 */ 
-	public static int[] str2Array(String configString, int min, int max, int def) {
+	public static int[] str2Array(String configString, int min, int max, int def, int minSize) {
 		Vector strConfigVector=new Vector(14);
 		SubString.split(configString,',',strConfigVector);
 		int i;
 		int nElem=strConfigVector.size();
-		int []res=new int[nElem];
+		int []res=new int[nElem>minSize?nElem:minSize];
 		for (i=0; i<nElem; i++) {
 			res[i]=Common.parseInt((String)strConfigVector.elementAt(i));
 			if (res[i]<min || res[i]>max) res[i]=def;
 		}
+		for (i=nElem+1; i<minSize; i++) res[i]=def;
 		return res;
 	}
 	

Modified: trunk/src/CacheWolf/TravelbugJourneyScreen.java
===================================================================
--- trunk/src/CacheWolf/TravelbugJourneyScreen.java	2007-11-10 17:24:09 UTC (rev 1051)
+++ trunk/src/CacheWolf/TravelbugJourneyScreen.java	2007-11-10 21:19:09 UTC (rev 1052)
@@ -159,9 +159,9 @@
 		modTbJourneyList.numRows=tblMyTravelbugJourneys.size();
 		// Get the columns to display and their widths from preferences
 		modTbJourneyList.columnMap=
-			TableColumnChooser.str2Array(Global.getPref().travelbugColMap,0,11,0);
+			TableColumnChooser.str2Array(Global.getPref().travelbugColMap,0,11,0, -1);
 		modTbJourneyList.colWidth=
-			TableColumnChooser.str2Array(Global.getPref().travelbugColWidth,10,1024,50);
+			TableColumnChooser.str2Array(Global.getPref().travelbugColWidth,10,1024,50, -1);
 		modTbJourneyList.numCols=modTbJourneyList.columnMap.length;
 		
 		modTbJourneyList.select(0,12,true);

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2007-11-10 17:24:09 UTC (rev 1051)
+++ trunk/src/CacheWolf/myTableModel.java	2007-11-10 21:19:09 UTC (rev 1052)
@@ -30,12 +30,12 @@
 	/** How the columns are mapped onto the list view. If colMap[i]=j, it means that
 	 * the element j (as per the list below) is visible in column i. 
 	 * [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates, 
-	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing
+	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing, [12] Size
 	 */
 	private int[] colMap;
 	/** The column widths corresponding to the list of columns above */
 	private int[] colWidth;
-	private String [] colName = {" ","?",MyLocale.getMsg(1000,"D"),MyLocale.getMsg(1001,"T"),MyLocale.getMsg(1002,"Waypoint"),"Name",MyLocale.getMsg(1004,"Location"),MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear")};
+	private String [] colName = {" ","?",MyLocale.getMsg(1000,"D"),MyLocale.getMsg(1001,"T"),MyLocale.getMsg(1002,"Waypoint"),"Name",MyLocale.getMsg(1004,"Location"),MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear"),MyLocale.getMsg(1017,"S")};//TODO
 	
 	public static Image cacheImages[] = new Image[454]; // Images are used by TableControl
 	private static Image noFindLogs[] = new Image[4];
@@ -45,6 +45,7 @@
 	private boolean sortAsc = false;
 	private int sortedBy = -1;
 	private FontMetrics fm;
+	private mImage picSizeMicro,picSizeSmall,picSizeReg,picSizeLarge,picSizeVLarge;
 	/** This is the modifier (Shift & Control key status) for Pen Events
 	 * it is set in myTableControl.onEvent */
 	public int penEventModifiers; 
@@ -99,6 +100,11 @@
 		bug = new mImage("bug.png");bug.transparentColor=Color.DarkBlue;
 		checkboxTicked = new Image("checkboxTicked.png");
 		checkboxUnticked= new Image("checkboxUnticked.png");
+		picSizeMicro=new mImage("sizeMicro.png"); picSizeMicro.transparentColor=Color.White;
+		picSizeSmall=new mImage("sizeSmall.png"); picSizeSmall.transparentColor=Color.White;
+		picSizeReg=new mImage("sizeReg.png"); picSizeReg.transparentColor=Color.White;
+		picSizeLarge=new mImage("sizeLarge.png"); picSizeLarge.transparentColor=Color.White;
+		picSizeVLarge=new mImage("sizeVLarge.png"); picSizeVLarge.transparentColor=Color.White;
 		updateRows();
 	}
 	
@@ -107,8 +113,8 @@
 	 *
 	 */
 	public void setColumnNamesAndWidths() {
-		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,11,0);
-		colWidth=TableColumnChooser.str2Array(Global.getPref().listColWidth,10,1024,50);
+		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,12,0, -1);
+		colWidth=TableColumnChooser.str2Array(Global.getPref().listColWidth,10,1024,50, colMap.length);
 		numCols=colMap.length;
 		clearCellAdjustments();
 		// If the displayed columns include the checkbox, we use the full menu
@@ -277,6 +283,15 @@
 							return (String)ch.distance;
 						case 11: // Bearing
 							return (String)ch.bearing;
+						case 12: // Size
+							switch (ch.CacheSize.charAt(0)) {
+								case 'M': return picSizeMicro;
+								case 'S': return picSizeSmall;
+								case 'R': return picSizeReg;
+								case 'L': return picSizeLarge;
+								case 'V': return picSizeVLarge;
+								default: return "?";
+							}
 					} // Switch
 				} // if
 			} catch (Exception e) { return null; }



From salzkammergut at mail.berlios.de  Sat Nov 10 23:30:10 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sat, 10 Nov 2007 23:30:10 +0100
Subject: [Cachewolf-svn] r1053 - trunk/src/CacheWolf
Message-ID: <200711102230.lAAMUAXN016474@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-10 23:30:09 +0100 (Sat, 10 Nov 2007)
New Revision: 1053

Modified:
   trunk/src/CacheWolf/myTableControl.java
Log:
myTableControl: Fix. The context menu spider which updates caches spidered invisible caches that had been ticked. Now only ticked and visible caches are re-spidered.

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2007-11-10 21:19:09 UTC (rev 1052)
+++ trunk/src/CacheWolf/myTableControl.java	2007-11-10 22:30:09 UTC (rev 1053)
@@ -172,7 +172,7 @@
 			Vector cachesToUpdate = new Vector();
 			for(int i = 0; i <	cacheDB.size(); i++){
 				ch = (CacheHolder)cacheDB.get(i);
-				if(ch.is_Checked == true) {
+				if(ch.is_Checked == true && !ch.is_filtered) {
 					if ( ch.wayPoint.length()>1 && (ch.wayPoint.substring(0,2).equalsIgnoreCase("GC") 
 							|| ch.wayPoint.substring(0,2).equalsIgnoreCase("OC")))
 //						if ( (ch.wayPoint.length() > 1 && ch.wayPoint.substring(0,2).equalsIgnoreCase("GC")))



From salzkammergut at mail.berlios.de  Sun Nov 11 11:49:43 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 11 Nov 2007 11:49:43 +0100
Subject: [Cachewolf-svn] r1054 - trunk/src/CacheWolf
Message-ID: <200711111049.lABAnhQG025613@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-11 11:49:40 +0100 (Sun, 11 Nov 2007)
New Revision: 1054

Modified:
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/Profile.java
Log:
Moved the parsing of a <CACHE.../> line (in the index.xml) from Profile.java to CacheHolder.java. Should also be  slightly faster.

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-10 22:30:09 UTC (rev 1053)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-11 10:49:40 UTC (rev 1054)
@@ -103,6 +103,105 @@
 	update(ch);
 }
 
+static char decSep,notDecSep;
+static {
+	decSep=MyLocale.getDigSeparator().charAt(0);
+	notDecSep=decSep=='.'?',':'.';
+}
+
+public CacheHolder(String xmlString) {
+	int start,end;
+	try {
+		start=xmlString.indexOf('"'); end=xmlString.indexOf('"',start+1);
+		CacheName = SafeXML.cleanback(xmlString.substring(start+1,end));
+		
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		CacheOwner = SafeXML.cleanback(xmlString.substring(start+1,end));
+
+		// Assume coordinates are in decimal format
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		double lat=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
+
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		double lon=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
+		pos=new CWPoint(lat,lon);
+		LatLon=pos.toString();
+
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		DateHidden = xmlString.substring(start+1,end); 
+		// Convert the US format to YYYY-MM-DD if necessary
+		if (DateHidden.indexOf('/')>-1) DateHidden=DateFormat.MDY2YMD(DateHidden);
+		
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		wayPoint = SafeXML.cleanback(xmlString.substring(start+1,end));
+
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		CacheStatus = xmlString.substring(start+1,end);
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		type = xmlString.substring(start+1,end);
+		
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		hard = xmlString.substring(start+1,end);
+
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		terrain = xmlString.substring(start+1,end);
+		
+		// The next item was 'dirty' but this is no longer used.
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_filtered = xmlString.substring(start+1,end).equals("true"); 
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		CacheSize = xmlString.substring(start+1,end);
+
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_available = xmlString.substring(start+1,end).equals("true");
+
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_archived = xmlString.substring(start+1,end).equals("true");
+		
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		has_bug = xmlString.substring(start+1,end).equals("true");
+		
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_black = xmlString.substring(start+1,end).equals("true");
+		if(is_black) is_filtered = true;
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_owned = xmlString.substring(start+1,end).equals("true");
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_found = xmlString.substring(start+1,end).equals("true");
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_new = xmlString.substring(start+1,end).equals("true");
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_log_update = xmlString.substring(start+1,end).equals("true");
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_update = xmlString.substring(start+1,end).equals("true");
+	
+		// for backwards compatibility set value to true, if it is not in the file
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_HTML = xmlString.substring(start+1,end).equals("false");
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		noFindLogs = Convert.toInt(xmlString.substring(start+1,end));
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		ocCacheID = xmlString.substring(start+1,end);
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		is_incomplete = xmlString.substring(start+1,end).equals("true");
+	
+		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+		lastSyncOC = xmlString.substring(start+1,end);
+	} catch (Exception ex) {
+		
+	}
+}
+
 public void update(CacheHolder ch) {
 	/* Here we have to distinguish several cases:
 	   this.is_found       this                ch               Update 'this'

Modified: trunk/src/CacheWolf/Profile.java
===================================================================
--- trunk/src/CacheWolf/Profile.java	2007-11-10 22:30:09 UTC (rev 1053)
+++ trunk/src/CacheWolf/Profile.java	2007-11-11 10:49:40 UTC (rev 1054)
@@ -197,56 +197,11 @@
 			if (text!=null && text.indexOf("decimal")>0) fmtDec=true;
 			Extractor ex = new Extractor(null, " = \"", "\" ", 0, true);
 			
-			//OperationTimer optt = new OperationTimer();
-			//optt.start("Reading...");
-			
+			//ewe.sys.Time startT=new ewe.sys.Time();
 			while ((text = in.readLine()) != null){
 				// Check for Line with cache data
 				if (text.indexOf("<CACHE ")>=0){
-					ex.setSource(text);
-					CacheHolder ch = new CacheHolder();
-					ch.CacheName = SafeXML.cleanback(ex.findNext());
-					ch.CacheOwner = SafeXML.cleanback(ex.findNext());
-					if (fmtDec) {
-						double lat=Convert.parseDouble(ex.findNext().replace(notDecSep,decSep));
-						double lon=Convert.parseDouble(ex.findNext().replace(notDecSep,decSep));
-						ch.pos=new CWPoint(lat,lon);
-						ch.LatLon=ch.pos.toString();
-					} else {
-						ch.LatLon = SafeXML.cleanback(ex.findNext());
-						ch.pos.set(ch.LatLon,CWPoint.CW);
-					}
-					ch.DateHidden = ex.findNext(); 
-					// Convert the US format to YYYY-MM-DD if necessary
-					if (ch.DateHidden.indexOf('/')>-1) ch.DateHidden=DateFormat.MDY2YMD(ch.DateHidden);
-					ch.wayPoint = SafeXML.cleanback(ex.findNext());
-					ch.CacheStatus = ex.findNext();
-					ch.type = ex.findNext();
-					ch.hard = ex.findNext();
-					ch.terrain = ex.findNext();
-					// The next item was 'dirty' but this is no longer used.
-					ch.is_filtered = ex.findNext().equals("true") ? true : false; 
-					ch.CacheSize = ex.findNext();
-					ch.is_available = ex.findNext().equals("true") ? true : false;
-					ch.is_archived = ex.findNext().equals("true") ? true : false;
-					ch.has_bug = ex.findNext().equals("true") ? true : false;
-					ch.is_black = ex.findNext().equals("true") ? true : false;
-					if(ch.is_black) ch.is_filtered = true;
-					ch.is_owned = ex.findNext().equals("true") ? true : false;
-					ch.is_found = ex.findNext().equals("true") ? true : false;
-					ch.is_new = ex.findNext().equals("true") ? true : false;
-					ch.is_log_update = ex.findNext().equals("true") ? true : false;
-					ch.is_update = ex.findNext().equals("true") ? true : false;
-					// for backwards compatibility set value to true, if it is not in the file
-					ch.is_HTML = ex.findNext().equals("false") ? false : true;
-					ch.noFindLogs = Convert.toInt(ex.findNext());
-					ch.ocCacheID = ex.findNext();
-					ch.is_incomplete = ex.findNext().equals("true") ? true : false;
-					ch.lastSyncOC = ex.findNext();
-					// remove "/>
-					ch.ocCacheID = STRreplace.replace(ch.ocCacheID,"\"/>", null);
-					// remove additional " if present
-					ch.ocCacheID = STRreplace.replace(ch.ocCacheID,"\"", null);
+					CacheHolder ch=new CacheHolder(text);
 					cacheDB.add(ch);
 				} else if (text.indexOf("<CENTRE")>=0) { // lat=  lon=
 					if (fmtDec) {
@@ -293,13 +248,10 @@
 				}
 			}
 			in.close();
-			
-			//optt.end();
-			//long times[];
-			//times = optt.getTimes();
-			//Vm.debug("Reading ended: " + times[0]);
-			
-			
+			//ewe.sys.Time endT=new ewe.sys.Time();
+			//Vm.debug("Time="+((((endT.hour*60+endT.minute)*60+endT.second)*1000+endT.millis)-(((startT.hour*60+startT.minute)*60+startT.second)*1000+startT.millis)));
+			//Vm.debug("Start:"+startT.format("H:mm:ss.SSS"));
+			//Vm.debug("End  :"+endT.format("H:mm:ss.SSS"));	
 			// Build references between caches and addi wpts
 			buildReferences();
 		} catch (FileNotFoundException e) {



From salzkammergut at mail.berlios.de  Sun Nov 11 14:04:46 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 11 Nov 2007 14:04:46 +0100
Subject: [Cachewolf-svn] r1055 - in trunk: resources src/CacheWolf
Message-ID: <200711111304.lABD4kfZ022046@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-11 14:04:31 +0100 (Sun, 11 Nov 2007)
New Revision: 1055

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/MainMenu.java
Log:
New feature: Rebuild index.xml.  
Rebuilds the index from the cache.xml files. Each cache.xml file contains a copy of the <CACHE ... /> line from the index.xml. For each cache.xml, the rebuilder checks whether the cache is already contained in the index.xml. If not it is added. Caches which have no <CACHE ... /> entry in their details file can optionally be deleted, as they are of no use and just waste disk space.

Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-11-11 10:49:40 UTC (rev 1054)
+++ trunk/resources/cachewolf.Languages.cfg	2007-11-11 13:04:31 UTC (rev 1055)
@@ -94,6 +94,12 @@
 		205=Radar
 		206=Liste
 		207=Immer neu einloggen
+		208=Index neu erstellen
+		209=Wiederaufbau Index
+		210=Caches nicht in index.xml:+
+		211=%0aDavon hinzugef%fcgt:+  
+		212=Alle .xml Dateien (und Bilder) l%f6schen, die nicht in index.xml sind
+		213=Verwaiste .xml Dateien l%f6schen
 		300=Type:
 		301=Gr%f6%dfe:
 		302=Wegpunkt:
@@ -646,6 +652,12 @@
 		205=Radar
 		206=List
 		207=Always login to GC
+		208=Rebuild index
+		209=Rebuilding index
+		210=Caches not in index.xml:+
+		211=%0aThereof added:+  
+		212=Delete all .xml files not in index.xml and associated pictures
+		213=Deleting orphans
 		300=Type:
 		301=Size:
 		302=Waypoint:

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2007-11-11 10:49:40 UTC (rev 1054)
+++ trunk/src/CacheWolf/MainMenu.java	2007-11-11 13:04:31 UTC (rev 1055)
@@ -31,7 +31,7 @@
 	private MenuItem exportOZI, exportKML, exportTPL;
 	private MenuItem filtCreate, filtClear, filtInvert, filtSelected, filtBlack, filtApply;
 	private MenuItem exportGPS, exportCacheMate,mnuSeparator;
-	private MenuItem orgCopy, orgMove, orgDelete;
+	private MenuItem orgCopy, orgMove, orgDelete,orgRebuild;
 	public MenuItem filtCacheTour,orgTravelbugs, mnuForceLogin;
 	private MenuItem mnuNewProfile, mnuOpenProfile, mnuEditCenter;
 	private Form father;
@@ -161,12 +161,13 @@
 		///////////////////////////////////////////////////////////////////////
 		// Create the "Organise" pulldown menu
 		///////////////////////////////////////////////////////////////////////
-		MenuItem[] organiseMenuItems=new MenuItem[5];
+		MenuItem[] organiseMenuItems=new MenuItem[6];
 		organiseMenuItems[0] = orgCopy  = new MenuItem(MyLocale.getMsg(141,"Copy")); 
 		organiseMenuItems[1] = orgMove  = new MenuItem(MyLocale.getMsg(142,"Move")); 
 		organiseMenuItems[2] = orgDelete   = new MenuItem(MyLocale.getMsg(143,"Delete"));
-		organiseMenuItems[3] = mnuSeparator;
-		organiseMenuItems[4] = orgTravelbugs = new MenuItem(MyLocale.getMsg(139,"Manage travelbugs"));
+		organiseMenuItems[3] = orgRebuild   = new MenuItem(MyLocale.getMsg(208,"Rebuild Index"));
+		organiseMenuItems[4] = mnuSeparator;
+		organiseMenuItems[5] = orgTravelbugs = new MenuItem(MyLocale.getMsg(139,"Manage travelbugs"));
 		this.addMenu(new PullDownMenu(MyLocale.getMsg(140,"Organise"),new Menu(organiseMenuItems,null)));
 
 		///////////////////////////////////////////////////////////////////////
@@ -535,6 +536,11 @@
 				dm.deleteCaches();
 				tbp.refreshTable();
 			}
+			if(mev.selectedItem == orgRebuild){
+				Rebuild rb=new Rebuild();
+				rb.rebuild();
+				tbp.refreshTable();
+			}
 			if(mev.selectedItem == orgTravelbugs){
 				TravelbugJourneyScreen tbs=new TravelbugJourneyScreen();
 				tbs.setPreferredSize(800,600);



From mik77 at mail.berlios.de  Sun Nov 11 18:17:26 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 11 Nov 2007 18:17:26 +0100
Subject: [Cachewolf-svn] r1056 - trunk/res_noewe
Message-ID: <200711111717.lABHHQWb006061@sheep.berlios.de>

Author: mik77
Date: 2007-11-11 18:17:21 +0100 (Sun, 11 Nov 2007)
New Revision: 1056

Added:
   trunk/res_noewe/Bayern TK50.wms
   trunk/res_noewe/Hessen TK25.wms
   trunk/res_noewe/Hessen TK50.wms
Log:
WMSs for Topo in Bavaria and Hesse

Added: trunk/res_noewe/Bayern TK50.wms
===================================================================
--- trunk/res_noewe/Bayern TK50.wms	2007-11-11 13:04:31 UTC (rev 1055)
+++ trunk/res_noewe/Bayern TK50.wms	2007-11-11 17:17:21 UTC (rev 1056)
@@ -0,0 +1,17 @@
+Name:	Bayern TK50
+MainUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?
+LayersName: 
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:	31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=TK50
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 50.6100606 E 9.1024741
+BoundingBoxButtomRightWGS84:	N 47.0828299 E 13.9781535
+MinScale:	0.01
+MaxScale:	40
+RecommendedScale:	5.0
+ImageFileExtension: .png

Added: trunk/res_noewe/Hessen TK25.wms
===================================================================
--- trunk/res_noewe/Hessen TK25.wms	2007-11-11 13:04:31 UTC (rev 1055)
+++ trunk/res_noewe/Hessen TK25.wms	2007-11-11 17:17:21 UTC (rev 1056)
@@ -0,0 +1,18 @@
+Name:	Hessen TK25
+MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?
+LayersName: 
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.0 
+CoordinateReferenceSystemCacheWolf:	31467
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=ATKPG25-N1
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 51.6697 E 7.69911
+BoundingBoxButtomRightWGS84:	N 49.3455 E 11.3986
+MinScale:	1.49671
+MaxScale:	49.8903
+RecommendedScale:	2.5
+ImageFileExtension: .png
+

Added: trunk/res_noewe/Hessen TK50.wms
===================================================================
--- trunk/res_noewe/Hessen TK50.wms	2007-11-11 13:04:31 UTC (rev 1055)
+++ trunk/res_noewe/Hessen TK50.wms	2007-11-11 17:17:21 UTC (rev 1056)
@@ -0,0 +1,18 @@
+Name:	Hessen TK50
+MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?
+LayersName: 
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.0 
+CoordinateReferenceSystemCacheWolf:	31467
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=ATKPG50-N1
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 51.6697 E 7.69911
+BoundingBoxButtomRightWGS84:	N 49.3455 E 11.3986
+MinScale:	1.49671
+MaxScale:	99.7806
+RecommendedScale:	5.0
+ImageFileExtension: .png
+



From salzkammergut at mail.berlios.de  Sun Nov 11 22:04:08 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 11 Nov 2007 22:04:08 +0100
Subject: [Cachewolf-svn] r1057 - trunk/src/CacheWolf
Message-ID: <200711112104.lABL484M014370@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-11 22:04:02 +0100 (Sun, 11 Nov 2007)
New Revision: 1057

Modified:
   trunk/src/CacheWolf/CacheHolder.java
Log:
CacheHolder: Fix for is_HTML was parsed wrongly.

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-11 17:17:21 UTC (rev 1056)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-11 21:04:02 UTC (rev 1057)
@@ -184,7 +184,7 @@
 	
 		// for backwards compatibility set value to true, if it is not in the file
 		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_HTML = xmlString.substring(start+1,end).equals("false");
+		is_HTML = !xmlString.substring(start+1,end).equals("false");
 	
 		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
 		noFindLogs = Convert.toInt(xmlString.substring(start+1,end));



From pfeffer at mail.berlios.de  Mon Nov 12 01:05:33 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 12 Nov 2007 01:05:33 +0100
Subject: [Cachewolf-svn] r1058 - in trunk: res_noewe src/CacheWolf
	src/CacheWolf/navi
Message-ID: <200711120005.lAC05X4D009864@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-12 01:05:24 +0100 (Mon, 12 Nov 2007)
New Revision: 1058

Added:
   trunk/res_noewe/de-nrw_topo_10.wms
   trunk/res_noewe/de-nrw_topo_25.wms
   trunk/res_noewe/readme_wms.txt
Modified:
   trunk/res_noewe/luftbild-nrw.wms
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/Common.java
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/MapLoaderGui.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
WMS: Implemented new field "MapType"
WMS: Bug fix: decimal seperator problem when reading .wms file
WMS: Bug fix: File(".") doesn't give the program directory on PDA --> substituted by File.getProgramDirectory()
WMS: temporarly disabled the use of reginal transform parameters in order to be able to compare the coordinationtransformations with the online coo-trans tool on www.geodatenzentrum.de

Added: trunk/res_noewe/de-nrw_topo_10.wms
===================================================================
--- trunk/res_noewe/de-nrw_topo_10.wms	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/res_noewe/de-nrw_topo_10.wms	2007-11-12 00:05:24 UTC (rev 1058)
@@ -0,0 +1,28 @@
+# For an example and explantion please see readme_wms.txt, which
+# you can find in the program directory of CacheWolf. There
+# you always get the newest information about .wms format.
+#
+# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
+# and fill in accordingly in any .wms file you make. They
+# are (still) not used by CacheWolf but they are usefull
+# for someone who wants to make his own changes to your file.
+# 
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/DTK10?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.1.0
+Name:   de.nrw Topo 10
+MapType:	topo
+MainUrl:   http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/DTK10?
+ServiceTypeUrlPart:	SERVICE=WMS
+VersionUrlPart:	VERSION=1.1.0
+CoordinateReferenceSystemCacheWolf:	31466 31467
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=Raster%3ADTK10%3ADtk10G
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 52.7729742 E 5.672412
+BoundingBoxButtomRightWGS84:	N 49.998341 E 10.1417782
+MinScale:   0.0
+MaxScale:   14.001
+RecommendedScale:	1
+ImageFileExtension:	.png

Added: trunk/res_noewe/de-nrw_topo_25.wms
===================================================================
--- trunk/res_noewe/de-nrw_topo_25.wms	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/res_noewe/de-nrw_topo_25.wms	2007-11-12 00:05:24 UTC (rev 1058)
@@ -0,0 +1,30 @@
+# For an example and explantion please see readme_wms.txt, which
+# you can find in the program directory of CacheWolf. There
+# you always get the newest information about .wms format.
+#
+# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
+# and fill in accordingly in any .wms file you make. They
+# are (still) not used by CacheWolf but they are usefull
+# for someone who wants to make his own changes to your file.
+# 
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS	
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:   de.nrw Topo 25
+MapType:	topo
+MainUrl:   http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/TK25?
+ServiceTypeUrlPart:	SERVICE=WMS
+VersionUrlPart:	VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:	31466 31467
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=Raster%3ATK25%5FKMF%3AFarbkombination
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 52.7691 E 05.673
+BoundingBoxButtomRightWGS84:	N 49.9944 E 010.142
+MinScale:   0.0
+MaxScale:   11.667
+RecommendedScale:	3
+ImageFileExtension:	.png

Modified: trunk/res_noewe/luftbild-nrw.wms
===================================================================
--- trunk/res_noewe/luftbild-nrw.wms	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/res_noewe/luftbild-nrw.wms	2007-11-12 00:05:24 UTC (rev 1058)
@@ -1,75 +1,30 @@
-# This is an example and explantion of an wms definition file.
-# You can add your own .wms file to the program directory of
-# cachwolf and the new service will be available in the download maps dialog
+# For an example and explantion please see readme_wms.txt, which
+# you can find in the program directory of CacheWolf. There
+# you always get the newest information about .wms format.
 #
-# For a list of WMS Services available in Germany see: http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-# This example is made up from there "Digitales Orthophoto" under section "Nordrhein-Westfalen"
-# download the getCapabilieties URL, save and open it in a text editor. 
-# used here: http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
+# and fill in accordingly in any .wms file you make. They
+# are (still) not used by CacheWolf but they are usefull
+# for someone who wants to make his own changes to your file.
+# 
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS	
 #
-# You can delete and add comments if you like. A comment starts with "#" in the first coloumn of the line.
-#
-# friendly name, choose yourself
-Name:	Luftbild NRW 
-# taken from getCapabilieties answer: <HTTP><GET><OnlineResource xlink:href=
+Name:	de.nrw Luftbild
 MainUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild? 
-#friendly name of the layer combination, choose yourself
-LayersName: 
-# this is fix, dont change it
+MapType: photo
 ServiceTypeUrlPart:	SERVICE=WMS 
-# taken from the getCapabilities request: <WMT_MS_Capabilities version=
 VersionUrlPart:	VERSION=1.1.0 
-# The EPSG-Code, supported by cachewolf: german gau?-kr?ger (31466, 31467, 31468, 
-# 31469) and WGS84 (4326)
-# You get a list of supported coordinate systems from the WMS in the getCapabilieties 
-# answer under <Layer><SRS> or <CRS>
-# Plases feel free to ask for another coordinate system to be supported by cachewolf 
-# if you need it
-# In case the wms server accepts coordinates in more than one Gau?-Kr?ger stripe
-# you can list the epsg codes here, seperated by a space. CacheWolf will
-# automatically make use of the correct stripe. 
-# The Strings in the UrlPart must match the corresponding number here
-# Sometimes the wms-Server provides only one stripe, in spite of the fact, that
-# the map it provides is not completely within this stripe. In this case
-# just list only this epsg code. CacheWolf will automatically calculate the
-# Gau?-Kr?ger coordinates for that stripe.
-# The automatic for the stripe selection only works if a german EPSG code
-# is the first one in the space seperated list
-# remark: some WMS offer WGS84 (EPSG 4326), but they are sometimes working not
-# correctly (for example the WMS of the Landesvermessungsamt NRW as of nov. 2007)
-# In this case don't list it.
 CoordinateReferenceSystemCacheWolf:	31466 31467
-# this usually will match the number above
 CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
-# Post not supported by Cachewolf --> dont change this
 RequestUrlPart:	REQUEST=GetMap
-# comma seperated (without spaces) list of layers to combine
-# all of supported layers you get from the getCapabilities request <Layer><Name>
-# these names are to be used. Special characters must be URL-encode
 LayersUrlPart:	LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
-# if the WMS supports different rendering styles, select the one you need here
-# comma seperated (without spaces) list of style commands for map rendering (do not delete this item even if it is empty
 StylesUrlPart:	STYLES=
-# format, dont forget to set ImageFileExtension accordingly
-# you get a list of supported image formats from getCapabilieties answer: <GetMap><Format>
 ImageFormatUrlPart:	FORMAT=image/png
-# Limits of the service in WGS84 coordinates. 
-# You can use any format here, which is accepted by the input coordinates dialog in cachewolf
-# taken from getCapabilieties answer: <BoundingBox SRS="EPSG:4326", dont forget to add "N"/"S" and "E"/"W"
 BoundingBoxTopLeftWGS84:	N 52.7691 E 5.673
 BoundingBoxButtomRightWGS84:	N 49.9944 E 10.142
-# scale range that the service supports in meters per pixel (measured diagonal)
-# Please don't wonder that they do mot match the scale given in
-# the map download dialog as that scale is measured vertically 
-# (multiply it ba sqrt(2) and you get the scale used here
-# taken from the getCapabilities request "<Layer><ScaleHint min="
 MinScale:	0.1795783591567183
 MaxScale:	5.611823723647454
-# Plaes recommend a scale for this WMS. This scale will appear in the
-# map download dialog as default. Scale is measured in meters per pixel
-# vertical, so, multiply it by 1.41 (=sqrt(2)) to get the scale as measured
-# above in MinScale and MaxScale
 RecommendedScale:	0.5
-# set this according to ImageFormatUrlPart (must start with ".")
 ImageFileExtension: .png
 

Added: trunk/res_noewe/readme_wms.txt
===================================================================
--- trunk/res_noewe/readme_wms.txt	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/res_noewe/readme_wms.txt	2007-11-12 00:05:24 UTC (rev 1058)
@@ -0,0 +1,98 @@
+# This is an example and explantion of an wms definition file.
+# copy and rename this file to the extension .wms
+# You can add your own .wms file to the program directory of
+# cachwolf and the new service will be available in the download maps dialog
+# name the file this way: <internet domain of the covered region, replace "." by "-" and inverse the order>_<type of map>_<original scale>.wms
+# e.g. "de-ni_topo_25", meaning germany (de), Niedersachen (ni), topographical map, original scale 1:50000.
+# Please don't use capital letter or special characters (only "a-z0-9" and "-_" are allowed) 
+# in the filename in order to avoid problems on different platforms
+#
+# For a list of WMS Services available in Germany see: http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+# This example is made up from there "Digitales Orthophoto" under section "Nordrhein-Westfalen"
+# download the getCapabilieties URL, save and open it in a text editor. 
+# used here: http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+#
+# You can delete and add comments if you like. A comment starts with "#" in the first coloumn of the line.
+#
+# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
+# and fill in accordingly in any .wms file you make. They
+# are (still) not used by CacheWolf but they are usefull
+# for someone who wants to make his own changes to your file.
+# 
+# Url where the GetCapabilitiesUrl is taken from, in order to be able
+# to gather some information about the map
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS	
+#
+# friendly name, choose yourself. By convention start with the internet domanin
+# of the covered region and add the type of map and the scale of the original map 
+# multiplied by 1000, e.g. "de.nrw Luftbild" or
+# "en Airial photo" or "de.th Topo 1:50"
+Name:	de.nrw Luftbild
+# taken from getCapabilieties answer: <HTTP><GET><OnlineResource xlink:href=
+MainUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild? 
+# if this service delivers topografical maps, fill in here "topo"
+# if it delivers aerial photographs fill in "photo".
+# Please use only lower case letters and no special characters
+# in order to avoid problems using this file on different platforms
+# CacheWolf will store all maps of the same Type in the same 
+# directory.
+MapType: photo
+# this is fix, dont change it
+ServiceTypeUrlPart:	SERVICE=WMS 
+# taken from the getCapabilities request: <WMT_MS_Capabilities version=
+VersionUrlPart:	VERSION=1.1.0 
+# The EPSG-Code, supported by cachewolf: german gau?-kr?ger (31466, 31467, 31468, 
+# 31469) and WGS84 (4326)
+# You get a list of supported coordinate systems from the WMS in the getCapabilieties 
+# answer under <Layer><SRS> or <CRS>
+# Plases feel free to ask for another coordinate system to be supported by cachewolf 
+# if you need it
+# In case the wms server accepts coordinates in more than one Gau?-Kr?ger stripe
+# you can list the epsg codes here, seperated by a space. CacheWolf will
+# automatically make use of the correct stripe. 
+# The Strings in the UrlPart must match the corresponding number here
+# Sometimes the wms-Server provides only one stripe, in spite of the fact, that
+# the map it provides is not completely within this stripe. In this case
+# just list only this epsg code. CacheWolf will automatically calculate the
+# Gau?-Kr?ger coordinates for that stripe.
+# The automatic for the stripe selection only works if a german EPSG code
+# is the first one in the space seperated list
+# remark: some WMS offer WGS84 (EPSG 4326), but they are sometimes working not
+# correctly (for example the WMS of the Landesvermessungsamt NRW as of nov. 2007)
+# In this case don't list it.
+CoordinateReferenceSystemCacheWolf:	31466 31467
+# this usually will match the number above
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
+# Post not supported by Cachewolf --> dont change this
+RequestUrlPart:	REQUEST=GetMap
+# comma seperated (without spaces) list of layers to combine
+# all of supported layers you get from the getCapabilities request <Layer><Name>
+# these names are to be used. Special characters must be URL-encode
+LayersUrlPart:	LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
+# if the WMS supports different rendering styles, select the one you need here
+# comma seperated (without spaces) list of style commands for map rendering (do not delete this item even if it is empty
+StylesUrlPart:	STYLES=
+# format, dont forget to set ImageFileExtension accordingly
+# you get a list of supported image formats from getCapabilieties answer: <GetMap><Format>
+ImageFormatUrlPart:	FORMAT=image/png
+# Limits of the service in WGS84 coordinates. 
+# You can use any format here, which is accepted by the input coordinates dialog in cachewolf
+# taken from getCapabilieties answer: <BoundingBox SRS="EPSG:4326", dont forget to add "N"/"S" and "E"/"W"
+BoundingBoxTopLeftWGS84:	N 52.7691 E 5.673
+BoundingBoxButtomRightWGS84:	N 49.9944 E 10.142
+# scale range that the service supports in meters per pixel (measured diagonal)
+# Please don't wonder that they do mot match the scale given in
+# the map download dialog as that scale is measured vertically 
+# (multiply it ba sqrt(2) and you get the scale used here
+# taken from the getCapabilities request "<Layer><ScaleHint min="
+MinScale:	0.1795783591567183
+MaxScale:	5.611823723647454
+# Plaes recommend a scale for this WMS. This scale will appear in the
+# map download dialog as default. Scale is measured in meters per pixel
+# vertical, so, multiply it by 1.41 (=sqrt(2)) to get the scale as measured
+# above in MinScale and MaxScale
+RecommendedScale:	0.5
+# set this according to ImageFormatUrlPart (must start with ".")
+ImageFileExtension: .png
+

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-12 00:05:24 UTC (rev 1058)
@@ -465,11 +465,11 @@
 	}
 	
 	public String getGermanGkCoordinates() {
-		return TransformCoordinates.wgs84ToGermanGK(this).toString(0, "R:", " H:");
+		return TransformCoordinates.wgs84ToGermanGk(this).toString(0, "R:", " H:");
 	}
 
 	public String getGermanGkCoordinates(int decimalplaces, String pref, String seperator) {
-		return TransformCoordinates.wgs84ToGermanGK(this).toString(decimalplaces, pref, seperator);
+		return TransformCoordinates.wgs84ToGermanGk(this).toString(decimalplaces, pref, seperator);
 	}
 	
 	/**

Modified: trunk/src/CacheWolf/Common.java
===================================================================
--- trunk/src/CacheWolf/Common.java	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/src/CacheWolf/Common.java	2007-11-12 00:05:24 UTC (rev 1058)
@@ -109,7 +109,8 @@
 	
 	public static String ClearForFileName(String str) {
 		String ret = str.replace('?', '_');
-		ret = str.replace(' ', '-');
+		ret = ret.replace(' ', '-');
+		ret = ret.replace(':', '-');
 		return ret;
 	}
 	

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-12 00:05:24 UTC (rev 1058)
@@ -2,6 +2,7 @@
 
 import CacheWolf.CWPoint;
 import CacheWolf.Common;
+import CacheWolf.Global;
 import CacheWolf.HttpConnection;
 import CacheWolf.InfoBox;
 import CacheWolf.Preferences;
@@ -43,13 +44,19 @@
 	Point tilesSize;
 	float tileScale;
 
-	public MapLoader(String prxy, String prt){
+	/**
+	 * 
+	 * @param prxy
+	 * @param prt
+	 * @param wmspath without trailing "/"
+	 */
+	public MapLoader(String prxy, String prt, String wmspath){
 		port = prt;
 		proxy = prxy;
 		progressInfobox = null;
 		onlineMapServices = new Vector();
 		String dateien[];
-		FileBugfix files = new FileBugfix(".");
+		FileBugfix files = new FileBugfix(wmspath);
 		String FileName;
 		OnlineMapService tempOMS;
 		MessageBox f = null; 
@@ -57,7 +64,7 @@
 		for(int i = 0; i < dateien.length;i++){
 			FileName = dateien[i];
 			try {
-				tempOMS = new WebMapService(FileName);
+				tempOMS = new WebMapService(wmspath + "/" + FileName);
 				onlineMapServices.add(tempOMS);
 			}catch(Exception ex){ 
 				if (f == null) (f=new MessageBox("Warning", "Ignoring error while \n reading web map service definition file \n"+ex.toString(), MessageBox.OKB)).exec();
@@ -295,6 +302,7 @@
 
 class OnlineMapService {
 	String name;
+	String mapType;
 	String MainUrl; //http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS
 	/** including "." */
 	String imageFileExt; // ".gif", ".jpg"...
@@ -326,6 +334,9 @@
 	public String getName() {
 		return name;
 	}
+	public String getMapType() {
+		return mapType;
+	}
 	/**
 	 * Overload this and return the URL to the map image, don't call super
 	 * Alternatively overload getUrlForBoundingBox
@@ -384,7 +395,6 @@
 }
 
 class WebMapService extends OnlineMapService {
-	String layersName;
 	String layersUrlPart; //
 	String versionUrlPart; // VERSION=1.1.0
 	String serviceTypeUrlPart; //"SERVICE=WMS" 
@@ -396,11 +406,6 @@
 	double minscaleWMS;
 	double maxscaleWMS;
 
-	public String getName() {
-		if (layersName == null || layersName.length() == 0)	return name;
-		return name + "_" + layersName;
-	}
-
 	/**
 	 * 
 	 * @param filename without file extension
@@ -416,7 +421,7 @@
 		if (name == "") throw new IllegalArgumentException("WebMapService: property >Name:< missing in file:\n" + filename);
 		MainUrl = wms.getProperty("MainUrl", "").trim();;
 		if (MainUrl == "") throw new IllegalArgumentException("WebMapService: property >MainUrl:< missing in file:\n" + filename);
-		layersName = wms.getProperty("LayersName", "missing layersname").trim();
+		mapType = wms.getProperty("MapType", "maptype_unknown").trim();
 		serviceTypeUrlPart = wms.getProperty("ServiceTypeUrlPart", "SERVICE=WMS").trim();
 		layersUrlPart = wms.getProperty("LayersUrlPart", "").trim();;
 		versionUrlPart = wms.getProperty("VersionUrlPart", "").trim();;
@@ -447,15 +452,37 @@
 		if (!topleft.isValid()) topleft.set(90, -180);
 		if (!buttomright.isValid()) buttomright.set(-90, 180);
 		boundingBox = new Area (topleft, buttomright);
-		minscaleWMS = Convert.toDouble(wms.getProperty("MinScale", "0").trim());
-		maxscaleWMS = Convert.toDouble(wms.getProperty("MaxScale", Convert.toString(java.lang.Double.MAX_VALUE)).trim());
+		minscaleWMS = Common.parseDouble(wms.getProperty("MinScale", "0").trim());
+		maxscaleWMS = Common.parseDouble(wms.getProperty("MaxScale", Convert.toString(java.lang.Double.MAX_VALUE)).trim());
 		minscale = minscaleWMS / Math.sqrt(2); // in WMS scale is measured diagonal while in CacheWolf it is measured vertical
 		maxscale = maxscaleWMS / Math.sqrt(2);
 		imageFileExt = wms.getProperty("ImageFileExtension", "").trim();
 		if (imageFileExt == "") throw new IllegalArgumentException("WebMapService: property >ImageFileExtension:< missing in file:\n" + filename);
-		recommendedScale = Convert.toFloat(wms.getProperty("RecommendedScale", "5").trim());
+		recommendedScale = (float) Common.parseDouble(wms.getProperty("RecommendedScale", "5").trim());
 	}
 
+	private static final int TOPLEFT_INDEX = 0;
+	private static final int BUTTOMRIGHT_INDEX = 1;
+	private static final int TOPRIGHT_INDEX = 2;
+	private static final int BUTTOMLEFT_INDEX = 3;
+	/**
+	 * 
+	 * @param maparea
+	 * @return [0] = topleft, [1] = buttomright, [2] = topright, [3] = buttomleft
+	 */
+	private GkPoint[] getGkArea(Area maparea) {
+		GkPoint[] ret = new GkPoint[4];
+	//	CWPoint topright = new CWPoint(maparea.topleft.latDec, maparea.buttomright.lonDec);
+	//	CWPoint buttomleft = new CWPoint(maparea.buttomright.latDec, maparea.topleft.lonDec);
+		int crs = getCrs(maparea.topleft);
+		ret[TOPLEFT_INDEX] = TransformCoordinates.wgs84ToGermanGk(maparea.topleft, coordinateReferenceSystem[crs]);
+		ret[BUTTOMRIGHT_INDEX] = TransformCoordinates.wgs84ToGermanGk(maparea.buttomright, coordinateReferenceSystem[crs]);
+		ret[TOPRIGHT_INDEX] = new GkPoint(ret[BUTTOMRIGHT_INDEX].getGkEasting(), ret[TOPLEFT_INDEX].northing);
+		ret[BUTTOMLEFT_INDEX] = new GkPoint(ret[TOPLEFT_INDEX].getGkEasting(), ret[BUTTOMRIGHT_INDEX].northing);
+		//ret[2] = TransformCoordinates.wgs84ToGermanGk(topright, coordinateReferenceSystem[crs]);
+		//ret[3] = TransformCoordinates.wgs84ToGermanGk(buttomleft, coordinateReferenceSystem[crs]);
+		return ret;	
+	}
 	public String getUrlForBoundingBox(Area maparea, Point pixelsize) {
 		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + " not covered by service: " + name + ", service area: " + boundingBox.toString());
 		// http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetMap&SRS=EPSG:31466&BBOX=2577567.0149,5607721.7566,2578567.0077,5608721.7602&WIDTH=500&HEIGHT=500&LAYERS=Raster:TK25_KMF:Farbkombination&STYLES=&FORMAT=image/png
@@ -469,6 +496,9 @@
 		String bbox = "BBOX=";
 		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem[0])) {
 			crs = getCrs(buttomleft);
+			GkPoint[] gk = getGkArea(maparea);
+			buttomleft = TransformCoordinates.germanGkToWgs84(gk[BUTTOMLEFT_INDEX]);
+			topright = TransformCoordinates.germanGkToWgs84(gk[TOPRIGHT_INDEX]);
 			bbox += TransformCoordinates.wgs84ToGermanGk(buttomleft, coordinateReferenceSystem[crs]).toString(3, "", ",");
 			bbox += "," + TransformCoordinates.wgs84ToGermanGk(topright, coordinateReferenceSystem[crs]).toString(3, "", ",");
 		} else if (coordinateReferenceSystem[0] == TransformCoordinates.EPSG_WGS84) 
@@ -477,7 +507,8 @@
 		String ret = MainUrl + "SERVICE=WMS" + "&"+ versionUrlPart + "&" + requestUrlPart + "&" + 
 		coordinateReferenceSystemUrlPart[crs] + "&" + bbox + 
 		"&WIDTH=" + pixelsize.x + "&HEIGHT=" + pixelsize.y + "&" + 
-		layersUrlPart + "&" + stylesUrlPart + "&" + imageFormatUrlPart; 
+		layersUrlPart + "&" + stylesUrlPart + "&" + imageFormatUrlPart;
+		Vm.debug(ret);
 		return ret;
 	}
 
@@ -492,7 +523,7 @@
 	private int getCrs(CWPoint p) {
 		int crs = 0;
 		if (coordinateReferenceSystem.length > 1) {
-			GkPoint gkbl = TransformCoordinates.wgs84ToGermanGK(p); // TODO: think / read about what to do if buttom left and top right ae not in the same Gau?-Kr?ger stripe?
+			GkPoint gkbl = TransformCoordinates.wgs84ToGermanGk(p); // TODO: think / read about what to do if buttom left and top right ae not in the same Gau?-Kr?ger stripe?
 			crs = TransformCoordinates.whichEpsg(coordinateReferenceSystem, gkbl);
 			if (crs < 0) throw new IllegalArgumentException("getUrlForBoundingBox: Point: " + gkbl.toString() + "no matching Gau?-Kr?ger-Stripe in the EPSG-code list in the .wms");
 		}
@@ -509,23 +540,29 @@
 		CWPoint topleft = new CWPoint(maparea.topleft);
 		CWPoint buttomright = new CWPoint(maparea.buttomright);
 		double metersperpixalhorizontal = ( buttomright.getDistance(buttomleft) + topleft.getDistance(topright))/2 * 1000 / pixelsize.x; 
-		double metersperpixalvertical = ( buttomright.getDistance(topright) + topleft.getDistance(buttomright))/2 * 1000 / pixelsize.y;
+		double metersperpixalvertical = ( buttomright.getDistance(topright) + topleft.getDistance(buttomleft))/2 * 1000 / pixelsize.y;
 		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem[0])) {
-			int crs = getCrs(buttomleft); 
-			GkPoint buttomleftgk = TransformCoordinates.wgs84ToGermanGk(buttomleft, coordinateReferenceSystem[crs]);
-			GkPoint toprightgk = TransformCoordinates.wgs84ToGermanGk(topright, coordinateReferenceSystem[crs]);
-			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
-			buttomleftgk.shift(metersperpixalhorizontal / 2, 1);
-			buttomleftgk.shift(metersperpixalvertical / 2, 0);
-			toprightgk.shift(-metersperpixalhorizontal / 2, 1);
-			toprightgk.shift(-metersperpixalvertical / 2, 0);
-			GkPoint topleftgk = new GkPoint(buttomleftgk.getGkEasting(), toprightgk.northing);
-			GkPoint buttomrightgk = new GkPoint(toprightgk.getGkEasting(), buttomleftgk.northing);
-
+			GkPoint[] gk = getGkArea(maparea);
+			GkPoint topleftgk = gk[TOPLEFT_INDEX]; //TransformCoordinates.wgs84ToGermanGk(topleft, coordinateReferenceSystem[crs]);
+			GkPoint buttomrightgk = gk[BUTTOMRIGHT_INDEX]; //TransformCoordinates.wgs84ToGermanGk(buttomright, coordinateReferenceSystem[crs]);
+/*			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
+			topleftgk.shift(metersperpixalhorizontal / 2, 1);
+			topleftgk.shift(-metersperpixalvertical / 2, 0);
+			buttomrightgk.shift(-metersperpixalhorizontal / 2, 1);
+			buttomrightgk.shift(metersperpixalvertical / 2, 0);
+*/
+			GkPoint buttomleftgk = gk[BUTTOMLEFT_INDEX]; // new GkPoint(topleftgk.getGkEasting(), buttomrightgk.northing);
+			GkPoint toprightgk = gk[TOPRIGHT_INDEX]; //new GkPoint(buttomrightgk.getGkEasting(), topleftgk.northing);
+			Vm.debug("\n" + maparea.topleft.toString(CWPoint.LAT_LON));
+			//Vm.debug(TransformCoordinates.germanGkToWgs84(TransformCoordinates.wgs84ToGermanGk(maparea.topleft)).toString(CWPoint.LAT_LON));
 			topleft = TransformCoordinates.germanGkToWgs84(topleftgk);
 			buttomright = TransformCoordinates.germanGkToWgs84(buttomrightgk);
 			buttomleft = TransformCoordinates.germanGkToWgs84(buttomleftgk);
 			topright = TransformCoordinates.germanGkToWgs84(toprightgk);
+			Vm.debug(topleft.toString(CWPoint.LAT_LON));
+			Vm.debug(buttomright.toString(CWPoint.LAT_LON));
+			Vm.debug(topright.toString(CWPoint.LAT_LON));
+			Vm.debug(buttomleft.toString(CWPoint.LAT_LON));
 		} else if (coordinateReferenceSystem[0] == TransformCoordinates.EPSG_WGS84) {
 			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
 			topleft.shift(metersperpixalhorizontal / 2, 1);
@@ -542,6 +579,10 @@
 
 		MapInfoObject ret = new MapInfoObject();
 		ret.evalGCP(georef, pixelsize.x, pixelsize.y);
+		Vm.debug("\n nach kal\n" + ret.calcLatLon(0, 0).toString(CWPoint.LAT_LON));
+		Vm.debug(ret.calcLatLon(pixelsize.x, pixelsize.y).toString(CWPoint.LAT_LON));
+		Vm.debug(ret.calcLatLon(pixelsize.x, 0).toString(CWPoint.LAT_LON));
+		Vm.debug(ret.calcLatLon(0, pixelsize.y).toString(CWPoint.LAT_LON));
 		return ret;
 	}
 }
@@ -561,6 +602,7 @@
 		name = "Expedia";
 		MainUrl = "Rhttp://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz."; //"Rhttp://" forces doenloadUrl to retry the URL until it gets an http-redirect and then downloads from there 
 		imageFileExt = ".gif";
+		mapType = "expedia";
 		recommendedScale = 5;
 		minscale = getMetersPerPixel(0.00000000000000000000001f);
 		maxscale = getMetersPerPixel((float)new CWPoint(0,0).getDistance(new CWPoint(0,180)) * 2 * 1000 / 1000); // whole world * 1000 because of km -> m. /1000 because we have 1000x1000 Pixel usually

Modified: trunk/src/CacheWolf/navi/MapLoaderGui.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-12 00:05:24 UTC (rev 1058)
@@ -66,7 +66,7 @@
 		pref = Global.getPref(); // myPreferences sollte sp?ter auch diese Einstellungen speichern
 		center = new CWPoint(pref.curCentrePt);
 		cacheDB = cacheDBi;
-		mapLoader = new MapLoader(Global.getPref().myproxy, Global.getPref().myproxyport);
+		mapLoader = new MapLoader(Global.getPref().myproxy, Global.getPref().myproxyport, File.getProgramDirectory());
 
 		// sort the items in the list of services in a way that services which cover the current center point.
 		unsortedMapServices = mapLoader.getAvailableOnlineMapServices();
@@ -164,7 +164,7 @@
 	}
 
 	public String getMapsDir() {
-		String ret = Global.getPref().getMapDownloadSavePath(mapLoader.currentOnlineMapService.getName());
+		String ret = Global.getPref().getMapDownloadSavePath(mapLoader.currentOnlineMapService.getMapType());
 		Global.getPref().saveCustomMapsPath(ret);
 		return ret;
 	}

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-11 21:04:02 UTC (rev 1057)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-12 00:05:24 UTC (rev 1058)
@@ -53,7 +53,7 @@
 	/** use this for south Germany, maximum deviation sub meter, valid in the former BRD (west germany) in 47?00' N ... 50?20' N */
 	public static final TransformParameters GK_SOUTH_GERMANY =  GK_SOUTH_GERMANY_TO_WGS84; 
 
-	private static Area FORMER_GDR = new Area(new CWPoint(54.923414, 10.503013), new CWPoint(50.402578, 14.520637)); 
+	public static Area FORMER_GDR = new Area(new CWPoint(54.923414, 10.503013), new CWPoint(50.402578, 14.520637)); 
 	
 	// taken from http://www.lverma.nrw.de/produkte/druckschriften/verwaltungsvorschriften/images/gps/TrafopsNRW.pdf for NRW this transform has deviations lower than 34cm.
 	private static final TransformParameters GK_NRW_GERMANY_TO_WGS84 = new TransformParameters(566.1, 116.3, 390.1, -1.11, -0.24, 3.76, 12.6, false);
@@ -110,7 +110,14 @@
 	 * @return
 	 */
 	public static CWPoint germanGkToWgs84(GkPoint gk) {
-		return  gkToWgs84(gk, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
+/*		if (gk.northing <= 6089288.064 && gk.northing >= 5585291.767 && // these coordinates are transformed ones from the invers routine
+				( gk.getStripe() == 4 && gk.getGkEasting() >= 4404124.247 && gk.getGkEasting() <= 4679300.398) ||
+				( gk.getStripe() == 5 && gk.getGkEasting() >= 5211904.597 && gk.getGkEasting() <= 5466056.603)
+			) return gkToWgs84(gk, GK_GERMANY_2001);
+		if (gk.northing <= 6097247.910 && gk.northing >= 5800464.725 )return gkToWgs84(gk, GK_NORD_GERMANY);
+		if (gk.northing <= 5800464.725 && gk.northing >= 5577963.555 )return gkToWgs84(gk, GK_NORD_GERMANY);
+		if (gk.northing <= 5577963.555 && gk.northing >= 5207294.028 )return gkToWgs84(gk, GK_NORD_GERMANY);
+	*/	return  gkToWgs84(gk, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
 	}
 
 	/**
@@ -123,16 +130,16 @@
 	 * @param gk
 	 * @return
 	 */
-	public static GkPoint wgs84ToGermanGK(CWPoint ll) {
+	public static GkPoint wgs84ToGermanGk(CWPoint ll) {
 		return  wgs84ToGk(ll, getGermanGkTransformParameters(ll)); 	
 	}
 	
 	public static TransformParameters getGermanGkTransformParameters(CWPoint ll) {
-		if (FORMER_GDR.isInBound(ll)) return GK_GERMANY_2001; // exlcude former GDR from the splitting germany in north/middel/south
+	/*	if (FORMER_GDR.isInBound(ll)) return GK_GERMANY_2001; // exlcude former GDR from the splitting germany in north/middel/south
 		if (ll.latDec <= 55 && ll.latDec >= 52.33333334 ) return  GK_NORD_GERMANY;
 		if (ll.latDec <= 52.33333334  && ll.latDec >= 50.33333334 ) return  GK_MID_GERMANY;
 		if (ll.latDec <= 50.33333334  && ll.latDec >= 47) return  GK_MID_GERMANY;
-		return GK_GERMANY_2001;
+	*/	return GK_GERMANY_2001;
 	}
 	
 	/**



From pfeffer at mail.berlios.de  Mon Nov 12 01:26:48 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 12 Nov 2007 01:26:48 +0100
Subject: [Cachewolf-svn] r1059 - trunk/src/CacheWolf/navi
Message-ID: <200711120026.lAC0QmV5017823@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-12 01:26:38 +0100 (Mon, 12 Nov 2007)
New Revision: 1059

Modified:
   trunk/src/CacheWolf/navi/MapLoaderGui.java
Log:
WMS: temporar Warning when downloading maps from WMS because of not sufficient calibration precision when scale > 0.5

Modified: trunk/src/CacheWolf/navi/MapLoaderGui.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-12 00:05:24 UTC (rev 1058)
+++ trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-12 00:26:38 UTC (rev 1059)
@@ -303,6 +303,11 @@
 					(new MessageBox("Error", "The selected online map service provides map in the scale from " + mapLoader.currentOnlineMapService.minscale + " to "+ mapLoader.currentOnlineMapService.maxscale +"\n please adjust 'Approx. meter pro pixel' accordingly", MessageBox.OKB)).execute();
 					return;
 				}
+				if (!mapLoader.currentOnlineMapService.getName().equalsIgnoreCase("expedia") &&
+						scale > 0.5) {
+					int a = (new MessageBox("Error", "Momentanously the calibration of downloaded maps from a WMS has a maximam deviation of about 1 percent of the map size in meters. That's why I strongly recommend to use it only up to a scale of 0.5. In this case the deviation will be lower than 5m. Do you whish to continue anyway?", MessageBox.YESB | MessageBox.NOB)).execute();
+					if (a == MessageBox.NOB) return;
+				}
 				this.close(Form.IDOK); 
 				this.downloadTiles();
 			}



From pfeffer at mail.berlios.de  Mon Nov 12 01:54:26 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 12 Nov 2007 01:54:26 +0100
Subject: [Cachewolf-svn] r1060 - trunk/src/CacheWolf/navi
Message-ID: <200711120054.lAC0sQKm023297@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-12 01:54:24 +0100 (Mon, 12 Nov 2007)
New Revision: 1060

Modified:
   trunk/src/CacheWolf/navi/MapsList.java
   trunk/src/CacheWolf/navi/MovingMap.java
Log:
MovingMap: do not force the user to select an (empty) map, if no map is available, see http://www.geoclub.de/viewtopic.php?p=320315#320315

Modified: trunk/src/CacheWolf/navi/MapsList.java
===================================================================
--- trunk/src/CacheWolf/navi/MapsList.java	2007-11-12 00:26:38 UTC (rev 1059)
+++ trunk/src/CacheWolf/navi/MapsList.java	2007-11-12 00:54:24 UTC (rev 1060)
@@ -73,7 +73,7 @@
 		MapListEntry tempMIO; 
 		tempMIO = new MapListEntry(1.0, lat);
 		add(tempMIO);
-		tempMIO = new MapListEntry(5.0, lat);
+		tempMIO = new MapListEntry(5.0, lat); // this one ( the 4th last) is automatically used when no real map is available, see MovingMap.setBestMap 
 		add(tempMIO);
 		tempMIO = new MapListEntry(50.0, lat);
 		add(tempMIO);

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2007-11-12 00:26:38 UTC (rev 1059)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2007-11-12 00:54:24 UTC (rev 1060)
@@ -187,6 +187,7 @@
 		maps = new MapsList(mapsPath); // this actually loads the maps
 		if (maps.isEmpty()) {
 			(new MessageBox(MyLocale.getMsg(327, "Information"), MyLocale.getMsg(326, "Es steht keine kalibrierte Karte zur Verf?gung \n Bitte w?hlen Sie einen Ma?stab,\n in dem der Track und die markierten Caches angezeigt werden sollen"), MessageBox.OKB)).execute();
+			(new MessageBox(MyLocale.getMsg(327, "Information"), MyLocale.getMsg(326, "Es steht keine kalibrierte Karte zur Verf?gung \n Sie k?nnen eine herunter laden im Hauptmen?: Anwendung/Karten/kalibrierte herunterladen"), MessageBox.OKB)).execute();
 			noMapsAvailable = true;
 		} else noMapsAvailable = false;
 		maps.addEmptyMaps(lat);
@@ -944,9 +945,12 @@
 			return;
 		}
 		if (currentMap == null && newmap == null) {
-			(new MessageBox("Information", "F?r die aktuelle Position steht keine Karte zur Verf?ng, bitte w?hlen Sie eine manuell", MessageBox.OKB)).execute();
+			// (new MessageBox("Information", "F?r die aktuelle Position steht keine Karte zur Verf?ng, bitte w?hlen Sie eine manuell", MessageBox.OKB)).execute();
 			posCircleLat = cll.latDec;
 			posCircleLon = cll.lonDec; // choosemap calls setmap with posCircle-coos
+			try {
+				setMap( ((MapListEntry)maps.elementAt(maps.getCount() - 4)).getMap(), lat, lon); // beware: "-4" only works if the empty maps were added last see MapsList.addEmptyMaps
+			} catch (IOException e) { (new MessageBox("Error", "setBestMap: problem in: setMap( ((MapListEntry)maps.elementAt(maps.getCount() - 4)).getMap(), lat, lon) lat/lon:" + lat+"/"+lon, MessageBox.OKB)).exec(); }
 			while (currentMap == null) {
 				mmp.chooseMap(); // force the user to select a scale // TODO empty maps on top?
 				if (currentMap == null) (new MessageBox("Error", "Moving map cannot run without a map - please select one. \n You can select an empty map", MessageBox.OKB)).execute();



From pfeffer at mail.berlios.de  Mon Nov 12 02:48:12 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 12 Nov 2007 02:48:12 +0100
Subject: [Cachewolf-svn] r1061 - trunk/src/CacheWolf/navi
Message-ID: <200711120148.lAC1mCSC031064@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-12 02:48:10 +0100 (Mon, 12 Nov 2007)
New Revision: 1061

Modified:
   trunk/src/CacheWolf/navi/MapLoader.java
Log:
WMS: error handling improved: If the server doesn't deliver an image, the begin of the content will be shown in the list of warnings: what happened today, that the NRW-Server had too much load, will be visable to the user now. 

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-12 00:54:24 UTC (rev 1060)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-12 01:48:10 UTC (rev 1061)
@@ -213,7 +213,7 @@
 			String filename = createFilename(mio.getCenter(), mio.scale);
 			String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
 			String url = currentOnlineMapService.getUrlForBoundingBox(surArea, pixelsize);
-			downloadUrl(url, path+"/"+imagename);
+			downloadImage(url, path+"/"+imagename);
 			mio.saveWFL();
 		} catch (Exception e) {
 			this.progressInfobox.addWarning("Ignoring error during map download, saving or calibration:\n" + e.getMessage()+"\n");
@@ -225,7 +225,7 @@
 		String filename = createFilename(mio.getCenter(), mio.scale);
 		String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
 		String url = currentOnlineMapService.getUrlForCenterScale(center, scale, pixelsize);
-		downloadUrl(url, path+"/"+imagename);
+		downloadImage(url, path+"/"+imagename);
 		mio.saveWFL();
 	}
 
@@ -242,7 +242,7 @@
 	 * and sometimes doesn't send a redirect on the first try 
 	 * @param datei path and name of file to save to
 	 */
-	public void downloadUrl(String url, String datei) throws IOException {
+	public void downloadImage(String url, String datei) throws IOException {
 		HttpConnection connImg; // TODO move proxy-handling in a global http-class
 		Socket sockImg;
 		FileOutputStream fos;
@@ -285,6 +285,13 @@
 					i++;
 				}
 				if (i > 4) throw new IOException("loadTo: failed to download map: didn't get http-redirect");
+				String ct = (String)connImg.documentProperties.getValue("content-type", "");
+				if (!ct.substring(0, 5).equalsIgnoreCase("image") )  {
+					String tmp = connImg.readText(sockImg, null).toString(); // TODO if the content is binary will will get an Exception in InfoBox, trying to display the content
+					tmp = tmp.substring(0, (tmp.length() < 1000 ? tmp.length() : 1000));
+					sockImg.close();
+					throw new IOException("downloadImage: content-type: " + ct + " is not an image, begin of content: " + tmp); 
+				}
 				daten = connImg.readData(sockImg);
 				fos = new FileOutputStream(dateiF);
 				fos.write(daten.toBytes());



From salzkammergut at mail.berlios.de  Mon Nov 12 19:20:27 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Mon, 12 Nov 2007 19:20:27 +0100
Subject: [Cachewolf-svn] r1062 - trunk/src/CacheWolf
Message-ID: <200711121820.lACIKRI9007182@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-12 19:20:07 +0100 (Mon, 12 Nov 2007)
New Revision: 1062

Added:
   trunk/src/CacheWolf/Rebuild.java
Log:
Finally the Rebuild file. Missed this previously as Eclipse had unticked the file (for reasons unknown to me). Sorry about the delay.


Added: trunk/src/CacheWolf/Rebuild.java
===================================================================
--- trunk/src/CacheWolf/Rebuild.java	2007-11-12 01:48:10 UTC (rev 1061)
+++ trunk/src/CacheWolf/Rebuild.java	2007-11-12 18:20:07 UTC (rev 1062)
@@ -0,0 +1,104 @@
+package CacheWolf;
+
+import ewe.io.FileReader;
+import ewe.sys.Handle;
+import ewe.ui.MessageBox;
+import ewe.ui.ProgressBarForm;
+import utils.FileBugfix;
+
+public class Rebuild {
+	String [] xmlFiles;
+	
+	public Rebuild() {}
+	
+	public void rebuild() {	
+		int i;
+		Profile prof=Global.getProfile();
+		
+		myProgressBarForm pbf = new myProgressBarForm();
+		Handle h = new Handle();
+		pbf.setTask(h,MyLocale.getMsg(209,"Rebuilding index"));
+		pbf.exec();
+
+		FileBugfix file=new FileBugfix(Global.getProfile().dataDir);
+		xmlFiles=file.list("*.xml",0);
+		int orphans=0; // xml Files without entry in database
+		int nAdded=0;  // caches added to database
+		for (i=0; i<xmlFiles.length; i++) {
+			String wayPoint=xmlFiles[i].substring(0,xmlFiles[i].indexOf('.'));
+			if (wayPoint.charAt(0)=='i' || 			// Check for index.xml and index.bak
+				prof.getCacheIndex(wayPoint)>=0)		// Check for waypoints already in database 
+				xmlFiles[i]=null;   				// Remove existing caches or index.xml
+			else {
+				//ewe.sys.Vm.debug("Orphan: "+wayPoint);
+				orphans++;
+			}
+		}
+		if (orphans>0) { // At least one cache not in database
+			int nProcessed=0;
+			// Now do the actual work
+			for(i = 0; i<xmlFiles.length; i++){
+				if (xmlFiles[i]!=null) {
+					h.progress = ((float)nProcessed++)/(float)(orphans);
+					h.changed();
+					String details=getCacheDetails(prof.dataDir+xmlFiles[i]);
+					if (details!=null) { // In older Versions of CW the <CACHE... /> line was not stored in the cache.xml
+						CacheHolder ch=new CacheHolder(details);
+						prof.cacheDB.add(ch);
+						nAdded++;
+						xmlFiles[i]=null;
+					} else Global.getPref().log("File "+xmlFiles[i]+" not in index.xml");
+				}
+				if (pbf.isClosed) break;
+			}
+			(new MessageBox(MyLocale.getMsg(327, "Information"), 
+					  MyLocale.getMsg(210,"Caches nicht in index.xml: ")+orphans+
+					  MyLocale.getMsg(211,"\nDavon hinzugef?gt: ")+nAdded
+					, MessageBox.OKB)).execute();
+			prof.buildReferences();
+			prof.saveIndex(Global.getPref(),true);
+		}
+		if (orphans!=nAdded && (new MessageBox(MyLocale.getMsg(327, "Information"),
+					MyLocale.getMsg(212,"Delete all .xml files not in index.xml and associated pictures"), 
+					MessageBox.YESB | MessageBox.NOB)).execute()==MessageBox.YESB) {
+			h = new Handle();
+			pbf.setTask(h,MyLocale.getMsg(213,"Deleting orphans"));
+			DataMover dm=new DataMover();
+			int nDeleted=0;
+			for (i=0; i<xmlFiles.length; i++) {
+				if (xmlFiles[i]!=null){	
+					h.progress = ((float)nDeleted++)/(float)(orphans-nAdded);
+					h.changed();
+					String wayPoint=xmlFiles[i].substring(0,xmlFiles[i].indexOf('.'));
+					dm.deleteCacheFiles(wayPoint,prof.dataDir);
+				}
+			}
+		}
+		pbf.exit(0);
+	}
+
+	private String getCacheDetails(String xmlFile) {
+		try {
+			FileReader in = new FileReader(xmlFile);
+			String text= in.readAll();
+			in.close();
+			int start,end;
+			// Check that we have not accidentally listed another xml file in the directory
+			if (text.indexOf("<CACHEDETAILS>")<0 || (start=text.indexOf("<CACHE "))<0) return null;
+			end=text.indexOf("/>",start);
+			return text.substring(start,end+2);
+		} catch (Exception ex) {
+			return null;
+		}
+	}
+
+	class myProgressBarForm extends ProgressBarForm {
+		 boolean isClosed=false;
+		 protected boolean canExit(int exitCode) {
+			isClosed=true;
+			return true;
+		 }
+	 }
+	 
+	
+}


Property changes on: trunk/src/CacheWolf/Rebuild.java
___________________________________________________________________
Name: svn:keywords
   + LastChangedRevision



From salzkammergut at mail.berlios.de  Mon Nov 12 21:37:36 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Mon, 12 Nov 2007 21:37:36 +0100
Subject: [Cachewolf-svn] r1063 - trunk/src/CacheWolf/navi
Message-ID: <200711122037.lACKbadG026879@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-12 21:37:32 +0100 (Mon, 12 Nov 2007)
New Revision: 1063

Modified:
   trunk/src/CacheWolf/navi/MovingMap.java
Log:
MovingMap: Fix for display 'Open GCxxxx' in context menu. Sometimes the wrong cachename was displayed.
 

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2007-11-12 18:20:07 UTC (rev 1062)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2007-11-12 20:37:32 UTC (rev 1063)
@@ -1598,11 +1598,13 @@
 				AniImage clickedOnImage = images.findHotImage(p);
 				if (clickedOnImage != null && clickedOnImage instanceof MapSymbol) {
 					clickedCache = ((CacheHolder)((MapSymbol)clickedOnImage).mapObject);
-					if (clickedCache != null) openCacheDescMenuItem = new MenuItem("Open '"+(clickedCache.CacheName.length()>0?clickedCache.CacheName:clickedCache.wayPoint)+"'$o"); // clickedCache == null can happen if clicked on the goto-symbol
-					kontextMenu.addItem(openCacheDescMenuItem);
-					if (clickedCache !=null && Global.mainForm.cacheListVisible) { 
-						addCachetoListMenuItem = new MenuItem(MyLocale.getMsg(199,"Add to cachetour"));
-						kontextMenu.addItem(addCachetoListMenuItem);
+					if (clickedCache != null) {
+						openCacheDescMenuItem = new MenuItem("Open '"+(clickedCache.CacheName.length()>0?clickedCache.CacheName:clickedCache.wayPoint)+"'$o"); // clickedCache == null can happen if clicked on the goto-symbol
+						kontextMenu.addItem(openCacheDescMenuItem);
+						if (Global.mainForm.cacheListVisible) { 
+							addCachetoListMenuItem = new MenuItem(MyLocale.getMsg(199,"Add to cachetour"));
+							kontextMenu.addItem(addCachetoListMenuItem);
+						}
 					}
 				}
 			}



From pfeffer at mail.berlios.de  Tue Nov 13 10:41:55 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 13 Nov 2007 10:41:55 +0100
Subject: [Cachewolf-svn] r1064 - in trunk/src/CacheWolf: . navi
Message-ID: <200711130941.lAD9ftAE031716@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-13 10:41:40 +0100 (Tue, 13 Nov 2007)
New Revision: 1064

Modified:
   trunk/src/CacheWolf/HttpConnection.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/navi/MapLoader.java
Log:
Http-Connection: proxy configuration incooperated, so that the class who wants to download something doesn't need to care about proxy config any more. Hopefully this works as I cannot test it.

Modified: trunk/src/CacheWolf/HttpConnection.java
===================================================================
--- trunk/src/CacheWolf/HttpConnection.java	2007-11-12 20:37:32 UTC (rev 1063)
+++ trunk/src/CacheWolf/HttpConnection.java	2007-11-13 09:41:40 UTC (rev 1064)
@@ -110,6 +110,21 @@
 Object originalPostData;
 
 /**
+ * Set these when the class is instantiated the first time.
+ * afterwards you don't need to set proxy parameters anymore
+ */
+
+private static String proxy = Global.getPref().myproxy;
+private static int proxyPort = Common.parseInt(Global.getPref().myproxyport);
+private static boolean useProxy = Global.getPref().proxyActive;
+
+public static void setProxy(String proxyi, int proxyporti, boolean useproxyi) {
+	proxy = proxyi;
+	proxyPort = proxyporti;
+	useProxy = useproxyi;
+}
+
+/**
  * This returns true if post data has been set for this connection.
  */
 public boolean hasPostData()
@@ -268,24 +283,30 @@
 public HttpConnection(String url)
 //===================================================================
 {
-	url = ewe.io.File.fixupPath(url);
-	//ewe.sys.Vm.debug("url: "+url);
-	port = 80;
-	String uu = url.toLowerCase();
-	if (uu.startsWith("http://")){
-		uu = url.replace('\\','/');
-		host = uu.substring(7);
-		int first = host.indexOf('/');
-		if (first == -1) document = "/";
-		else {
-			document = host.substring(first);
-			host = host.substring(0,first);
+	if (useProxy) { 
+		host = proxy;
+		port = proxyPort;
+		document = url;
+	} else {
+		url = ewe.io.File.fixupPath(url);
+		//ewe.sys.Vm.debug("url: "+url);
+		port = 80;
+		String uu = url.toLowerCase();
+		if (uu.startsWith("http://")){
+			uu = url.replace('\\','/');
+			host = uu.substring(7);
+			int first = host.indexOf('/');
+			if (first == -1) document = "/";
+			else {
+				document = host.substring(first);
+				host = host.substring(0,first);
+			}
+			int colon = host.indexOf(':');
+			if (colon != -1){
+				port = ewe.sys.Convert.toInt(host.substring(colon+1));
+				host = host.substring(0,colon);
+			}
 		}
-		int colon = host.indexOf(':');
-		if (colon != -1){
-			port = ewe.sys.Convert.toInt(host.substring(colon+1));
-			host = host.substring(0,colon);
-		}
 	}
 }
 

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-11-12 20:37:32 UTC (rev 1063)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-11-13 09:41:40 UTC (rev 1064)
@@ -243,6 +243,7 @@
 				pref.myproxy = Proxy.getText();
 				pref.myproxyport = ProxyPort.getText();
 				pref.proxyActive=chkProxyActive.getState();
+				HttpConnection.setProxy(pref.myproxy, Common.parseInt(pref.myproxyport), pref.proxyActive); // TODO generate an error message if proxy port is not a number
 				//myPreferences.nLogs = Convert.parseInt(nLogs.getText());
 				pref.autoReloadLastProfile=chkAutoLoad.getState();
 				pref.showDeletedImages=chkShowDeletedImg.getState();

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-12 20:37:32 UTC (rev 1063)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-13 09:41:40 UTC (rev 1064)
@@ -256,12 +256,7 @@
 			forceredirect = false;
 			realurl = url;
 		}
-		if(proxy.length()>0){
-			connImg = new HttpConnection(proxy, Convert.parseInt(port), realurl);
-			//Vm.debug("Loading quelle: " + quelle);
-		}else{
-			connImg = new HttpConnection(realurl);
-		}
+		connImg = new HttpConnection(realurl);
 		connImg.setRequestorProperty("USER_AGENT", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
 		connImg.setRequestorProperty("Connection", "close");
 		connImg.setRequestorProperty("Cookie", "jscript=1; path=/;");



From mik77 at mail.berlios.de  Thu Nov 15 20:15:25 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Thu, 15 Nov 2007 20:15:25 +0100
Subject: [Cachewolf-svn] r1065 - trunk/res_noewe
Message-ID: <200711151915.lAFJFPtr002762@sheep.berlios.de>

Author: mik77
Date: 2007-11-15 20:15:22 +0100 (Thu, 15 Nov 2007)
New Revision: 1065

Modified:
   trunk/res_noewe/Bayern TK50.wms
   trunk/res_noewe/Hessen TK25.wms
   trunk/res_noewe/Hessen TK50.wms
Log:
new tags added to WMS files

Modified: trunk/res_noewe/Bayern TK50.wms
===================================================================
--- trunk/res_noewe/Bayern TK50.wms	2007-11-13 09:41:40 UTC (rev 1064)
+++ trunk/res_noewe/Bayern TK50.wms	2007-11-15 19:15:22 UTC (rev 1065)
@@ -1,6 +1,8 @@
-Name:	Bayern TK50
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.by Topo 50
+MapType:	topo
 MainUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?
-LayersName: 
 ServiceTypeUrlPart:	SERVICE=WMS 
 VersionUrlPart:	VERSION=1.1.1 
 CoordinateReferenceSystemCacheWolf:	31468 

Modified: trunk/res_noewe/Hessen TK25.wms
===================================================================
--- trunk/res_noewe/Hessen TK25.wms	2007-11-13 09:41:40 UTC (rev 1064)
+++ trunk/res_noewe/Hessen TK25.wms	2007-11-15 19:15:22 UTC (rev 1065)
@@ -1,8 +1,10 @@
-Name:	Hessen TK25
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.he Topo 25
+MapType:	topo
 MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?
-LayersName: 
 ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.0 
+VersionUrlPart:	VERSION=1.1.1
 CoordinateReferenceSystemCacheWolf:	31467
 CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
 RequestUrlPart:	REQUEST=GetMap

Modified: trunk/res_noewe/Hessen TK50.wms
===================================================================
--- trunk/res_noewe/Hessen TK50.wms	2007-11-13 09:41:40 UTC (rev 1064)
+++ trunk/res_noewe/Hessen TK50.wms	2007-11-15 19:15:22 UTC (rev 1065)
@@ -1,8 +1,11 @@
-Name:	Hessen TK50
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.he Topo 50
+MapType:	topo
 MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?
 LayersName: 
 ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.0 
+VersionUrlPart:	VERSION=1.1.1
 CoordinateReferenceSystemCacheWolf:	31467
 CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
 RequestUrlPart:	REQUEST=GetMap



From mik77 at mail.berlios.de  Thu Nov 15 20:23:07 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Thu, 15 Nov 2007 20:23:07 +0100
Subject: [Cachewolf-svn] r1066 - trunk/res_noewe
Message-ID: <200711151923.lAFJN7jL004490@sheep.berlios.de>

Author: mik77
Date: 2007-11-15 20:22:56 +0100 (Thu, 15 Nov 2007)
New Revision: 1066

Added:
   trunk/res_noewe/de-by_topo_50.wms
   trunk/res_noewe/de-he_topo_25.wms
   trunk/res_noewe/de-he_topo_50.wms
   trunk/res_noewe/de-nrw_photo.wms
Removed:
   trunk/res_noewe/Bayern TK50.wms
   trunk/res_noewe/Hessen TK25.wms
   trunk/res_noewe/Hessen TK50.wms
   trunk/res_noewe/luftbild-nrw.wms
Log:
wms names changed to new convention

Deleted: trunk/res_noewe/Bayern TK50.wms
===================================================================
--- trunk/res_noewe/Bayern TK50.wms	2007-11-15 19:15:22 UTC (rev 1065)
+++ trunk/res_noewe/Bayern TK50.wms	2007-11-15 19:22:56 UTC (rev 1066)
@@ -1,19 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.by Topo 50
-MapType:	topo
-MainUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:	31468 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=TK50
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 50.6100606 E 9.1024741
-BoundingBoxButtomRightWGS84:	N 47.0828299 E 13.9781535
-MinScale:	0.01
-MaxScale:	40
-RecommendedScale:	5.0
-ImageFileExtension: .png

Deleted: trunk/res_noewe/Hessen TK25.wms
===================================================================
--- trunk/res_noewe/Hessen TK25.wms	2007-11-15 19:15:22 UTC (rev 1065)
+++ trunk/res_noewe/Hessen TK25.wms	2007-11-15 19:22:56 UTC (rev 1066)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.he Topo 25
-MapType:	topo
-MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=ATKPG25-N1
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 51.6697 E 7.69911
-BoundingBoxButtomRightWGS84:	N 49.3455 E 11.3986
-MinScale:	1.49671
-MaxScale:	49.8903
-RecommendedScale:	2.5
-ImageFileExtension: .png
-

Deleted: trunk/res_noewe/Hessen TK50.wms
===================================================================
--- trunk/res_noewe/Hessen TK50.wms	2007-11-15 19:15:22 UTC (rev 1065)
+++ trunk/res_noewe/Hessen TK50.wms	2007-11-15 19:22:56 UTC (rev 1066)
@@ -1,21 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.he Topo 50
-MapType:	topo
-MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?
-LayersName: 
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=ATKPG50-N1
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 51.6697 E 7.69911
-BoundingBoxButtomRightWGS84:	N 49.3455 E 11.3986
-MinScale:	1.49671
-MaxScale:	99.7806
-RecommendedScale:	5.0
-ImageFileExtension: .png
-

Copied: trunk/res_noewe/de-by_topo_50.wms (from rev 1065, trunk/res_noewe/Bayern TK50.wms)

Copied: trunk/res_noewe/de-he_topo_25.wms (from rev 1065, trunk/res_noewe/Hessen TK25.wms)

Copied: trunk/res_noewe/de-he_topo_50.wms (from rev 1065, trunk/res_noewe/Hessen TK50.wms)

Copied: trunk/res_noewe/de-nrw_photo.wms (from rev 1064, trunk/res_noewe/luftbild-nrw.wms)

Deleted: trunk/res_noewe/luftbild-nrw.wms
===================================================================
--- trunk/res_noewe/luftbild-nrw.wms	2007-11-15 19:15:22 UTC (rev 1065)
+++ trunk/res_noewe/luftbild-nrw.wms	2007-11-15 19:22:56 UTC (rev 1066)
@@ -1,30 +0,0 @@
-# For an example and explantion please see readme_wms.txt, which
-# you can find in the program directory of CacheWolf. There
-# you always get the newest information about .wms format.
-#
-# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
-# and fill in accordingly in any .wms file you make. They
-# are (still) not used by CacheWolf but they are usefull
-# for someone who wants to make his own changes to your file.
-# 
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS	
-#
-Name:	de.nrw Luftbild
-MainUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild? 
-MapType: photo
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.0 
-CoordinateReferenceSystemCacheWolf:	31466 31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 52.7691 E 5.673
-BoundingBoxButtomRightWGS84:	N 49.9944 E 10.142
-MinScale:	0.1795783591567183
-MaxScale:	5.611823723647454
-RecommendedScale:	0.5
-ImageFileExtension: .png
-



From pfeffer at mail.berlios.de  Fri Nov 16 19:32:34 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 16 Nov 2007 19:32:34 +0100
Subject: [Cachewolf-svn] r1067 - in trunk/src/CacheWolf: . navi
Message-ID: <200711161832.lAGIWYQ9011294@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-16 19:32:23 +0100 (Fri, 16 Nov 2007)
New Revision: 1067

Added:
   trunk/src/CacheWolf/navi/Ellipsoid.java
   trunk/src/CacheWolf/navi/TransformCoordinatesProperties.java
Modified:
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/Common.java
   trunk/src/CacheWolf/MainTab.java
   trunk/src/CacheWolf/navi/Area.java
   trunk/src/CacheWolf/navi/GkPoint.java
   trunk/src/CacheWolf/navi/MapImage.java
   trunk/src/CacheWolf/navi/MapInfoObject.java
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/MapLoaderGui.java
   trunk/src/CacheWolf/navi/MapSymbol.java
   trunk/src/CacheWolf/navi/MapsList.java
   trunk/src/CacheWolf/navi/MovingMap.java
   trunk/src/CacheWolf/navi/TrackOverlay.java
   trunk/src/CacheWolf/navi/TrackPoint.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
MovingMap: some internal change without effect -> a lot of changes were necessary
WMS: download from BKG works now
WMS: calibration is now really correct:
 * WMS: added a line in .wfl file which can contain the EPSG code indication the projection used. If present the WGS coordinates will first transformed to the indicated epsg reference system and afterwords the affine transformation is applied
 * WMS: download only exact quadratic areas (measured in the respective coordinate reference system) because a lot of services produce not correct calibrated images otherwise

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -272,13 +272,6 @@
 		this.utmValid = false;
 	}
 
-	/*
-	 * Returns true if the coordinates are valid
-	 */
-	public boolean isValid() {
-		return 	latDec <= 90.0 && latDec >= -90.0 &&
-				lonDec <= 360 && lonDec >= -360;
-	}
 	
 	/**
 	 * shift the point
@@ -485,7 +478,7 @@
 		c = (float)(distance/1.852);
 		c = (float)(java.lang.Math.PI/(180*60))*c;
 		az = (float)((degrees/180)*java.lang.Math.PI);
-
+		// c = (float) (distance * 1000 / ((TransformCoordinates.WGS84.a + TransformCoordinates.WGS84.b) / 2)); 
 		LatLonPoint lldst = llsrc.getPoint(c,az);
 		
 		return new CWPoint(lldst);
@@ -558,6 +551,10 @@
 		LatLonPoint src = new LatLonPoint(this.latDec, this.lonDec);
 		return src.distance(new LatLonPoint(latDecD, lonDecD));
 	}
+	
+	public double getDistanceRad (CWPoint ll) {
+		return getDistance(ll.latDec, ll.lonDec);
+	}
 
 	
 

Modified: trunk/src/CacheWolf/Common.java
===================================================================
--- trunk/src/CacheWolf/Common.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/Common.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -17,11 +17,20 @@
 	public static double parseDouble(String value){
 		// returns 0 for invalid arguments
 		try {
-			return java.lang.Double.parseDouble(value.replace(notDigSep,digSep));
+			return parseDoubleException (value);
 		} catch (Exception e) {
 			return 0.0;
 		}
 	}
+
+	/**
+	 * throws some exception if the string could not be converted to double
+	 * @param value
+	 * @return
+	 */
+	public static double parseDoubleException (String value) {
+			return java.lang.Double.parseDouble(value.replace(notDigSep,digSep));
+	}
 	
 	public static int parseInt(String value){
 		try {

Modified: trunk/src/CacheWolf/MainTab.java
===================================================================
--- trunk/src/CacheWolf/MainTab.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/MainTab.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -326,7 +326,7 @@
 				nav.setMovingMap(mm);
 			} 
 			if (forceCenter) mm.setGpsStatus(MovingMap.noGPS); // disconnect movingMap from GPS TODO only if GPS-pos is not on the screen
-			mm.updatePosition(centerTo.latDec, centerTo.lonDec);
+			mm.updatePosition(centerTo);
 			mm.myExec();
 			if (forceCenter) {
 				try {
@@ -334,7 +334,7 @@
 					while (MapImage.screenDim.width == 0 && i < 10*60) { i++; ewe.sys.mThread.sleep(100);} // wait until the window size of the moving map is known note: ewe.sys.sleep() will pause the whole vm - no other thread will run
 					if (i >= 10*60) {(new MessageBox("Error", "MovingMap cannot be displayed - this is most likely a bug - plaese report it on www.geoclub.de", MessageBox.OKB)).execute(); return;}
 					mm.setCenterOfScreen(centerTo, false); // this can only be executed if mm knows its window size that's why myExec must be executed before
-					mm.updatePosition(centerTo.latDec, centerTo.lonDec);
+					mm.updatePosition(centerTo);
 					/*			if(!mm.posCircle.isOnScreen()) { // TODO this doesn't work because lat lon is set to the wished pos and not to gps anymore
 				mm.setGpsStatus(MovingMap.noGPS); // disconnect movingMap from GPS if GPS-pos is not on the screen
 				mm.setResModus(MovingMap.HIGHEST_RESOLUTION);

Modified: trunk/src/CacheWolf/navi/Area.java
===================================================================
--- trunk/src/CacheWolf/navi/Area.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/Area.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -24,7 +24,7 @@
 		 buttomright = new CWPoint(br);
 	 }
 
-	 public boolean isInBound(CWPoint p) {
+	 public boolean isInBound(TrackPoint p) {
 		 if (topleft.latDec >= p.latDec && topleft.lonDec <= p.lonDec 
 				 && buttomright.latDec <= p.latDec && buttomright.lonDec >= p.lonDec) return true;
 		 else return false;

Added: trunk/src/CacheWolf/navi/Ellipsoid.java
===================================================================
--- trunk/src/CacheWolf/navi/Ellipsoid.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/Ellipsoid.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -0,0 +1,9 @@
+package CacheWolf.navi;
+
+public class Ellipsoid {
+	public double a, b;
+	public Ellipsoid(double ai, double bi) {
+		a = ai;
+		b = bi;
+	}
+}

Modified: trunk/src/CacheWolf/navi/GkPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/GkPoint.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/GkPoint.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -13,6 +13,10 @@
 
 	public GkPoint() { super(); }
 	
+	public GkPoint(GkPoint p) {
+		set(p.easting, p.northing, p.stripe, p.stripewidth);
+	}
+	
 	/**
 	 * e containing the number of the stripe
 	 * @param e

Modified: trunk/src/CacheWolf/navi/MapImage.java
===================================================================
--- trunk/src/CacheWolf/navi/MapImage.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/MapImage.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -28,6 +28,12 @@
 		if (screenDim == null) screenDim = new Dimension(0,0);
 	}
 
+	/**
+	 * Best you call this routine before you make any instance of MapImage
+	 * If the windows size changes after instantiation call  screenDimChanged()
+	 * for every symbol.
+	 * 
+	 */
 	public static void setScreenSize(int w, int h) {
 		screenDim = new Dimension(w, h);
 	}
@@ -67,6 +73,13 @@
 		else return false;
 	}
 
+	public void screenDimChanged() {
+		move(locAlways.x, locAlways.y);
+		//if (!hidden && isOnScreen()) properties &= ~AniImage.IsInvisible;
+		//else properties |= AniImage.IsInvisible;
+	}
+
+
 	public void hide() {
 		hidden = true;
 		properties |= AniImage.IsInvisible;

Modified: trunk/src/CacheWolf/navi/MapInfoObject.java
===================================================================
--- trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -4,15 +4,24 @@
 import CacheWolf.Common;
 import CacheWolf.Matrix;
 import CacheWolf.MyLocale;
+import CacheWolf.Profile;
+import ewe.data.PropertyList;
+import ewe.fx.PixelBuffer;
 import ewe.fx.Point;
+import ewe.io.Base64Encoder;
 import ewe.io.BufferedWriter;
+import ewe.io.FileInputStream;
 import ewe.io.FileReader;
 import ewe.io.FileWriter;
 import ewe.io.FilenameFilter;
 import ewe.io.File;
 import ewe.io.IOException;
+import ewe.io.InputStream;
+import ewe.io.InputStreamReader;
 import ewe.io.PrintWriter;
 import ewe.sys.*;
+import ewe.util.Properties;
+import java.lang.Math;
 
 
 /**
@@ -31,14 +40,15 @@
 	// lon of lower right corner of image
 	// lat of lower right corner of image
 
-	public double[] affine = {0,0,0,0};
+	private double[] affine = {0,0,0,0};
+	private CWPoint affineTopleft = new CWPoint();;
 	public double transLatX, transLatY, transLonX, transLonY; // this are needed for the inervers calculation from lat/lon to x/y
 	public CWPoint center = new CWPoint();
 	public float sizeKm = 0; // diagonale
 	public float scale; // in meters per pixel, note: it is assumed that this scale identifying the scale of the map, automatically adjusted when zooming
 	public float zoomFactor = 1; // if the image is zoomed, direct after laoding always 1
 	public Point shift = new Point (0,0);
-	public CWPoint OrigUpperLeft; // this is only valid after zooming 
+	public CWPoint origAffineUpperLeft; // this is only valid after zooming 
 	public float rotationRad; // contains the rotation of the map == north direction in rad
 	/** full path to the respective worldfile, including ".wfl"*/
 	public String fileNameWFL = new String();
@@ -48,6 +58,7 @@
 	public String mapName = new String();
 	//private Character digSep = new Character(' ');
 	static private String digSep = MyLocale.getDigSeparator();
+	private int coordTrans = 0; 
 
 	public MapInfoObject() { // TODO remove this
 		//double testA = Convert.toDouble("1,50") + Convert.toDouble("3,00");
@@ -61,9 +72,11 @@
 		affine[1] = map.affine[1];
 		affine[2] = map.affine[2];
 		affine[3] = map.affine[3];
-		OrigUpperLeft = new CWPoint (map.OrigUpperLeft);
+		origAffineUpperLeft = new CWPoint (map.origAffineUpperLeft);
+		affineTopleft = new CWPoint(map.affineTopleft);
 		zoomFactor = map.zoomFactor;
 		shift.set(map.shift);
+		coordTrans = map.coordTrans;
 		//	fileName = new String(map.fileName);
 		fileNameWFL = new String(map.fileNameWFL);
 		mapName = new String(mapName);
@@ -83,12 +96,13 @@
 		affine[1]=pixel2deg / java.lang.Math.cos(lat); //x2lon
 		affine[2]=-pixel2deg; //y2lat
 		affine[3]=0; //y2lon
-		/*topleft.latDec=1; //top
+		topleft.latDec=1; //top
 		topleft.lonDec=0; //left
 		buttomright.latDec = 0; //buttom
 		buttomright.lonDec = 1; //right
-		 */OrigUpperLeft = new CWPoint(topleft);
-		 doCalculations();
+		affineTopleft.set(topleft);
+		doCalculations();
+		origAffineUpperLeft = new CWPoint(affineTopleft);
 	}
 
 	/**
@@ -108,10 +122,11 @@
 		affine[3]=0; //y2lon
 		topleft.latDec=center.latDec + hight / 2 *pixel2deg; //top
 		topleft.lonDec=center.lonDec - width / 2 *pixel2deghorizontal; //left
+		affineTopleft.set(topleft);
 		buttomright.latDec = center.latDec - hight / 2 *pixel2deg; //buttom
 		buttomright.lonDec = center.lonDec + width / 2 *pixel2deghorizontal; //right
 		fileNameWFL = name;
-		OrigUpperLeft = new CWPoint(topleft);
+		origAffineUpperLeft = new CWPoint(affineTopleft);
 		doCalculations();
 	}
 
@@ -152,55 +167,55 @@
 	 * @throws ArithmeticException when affine data is not correct, e.g. it is not possible to inverse affine-transformation
 	 */
 	public void loadwfl(String mapsPath, String thisMap) throws IOException, ArithmeticException {
-		FileReader in = new FileReader(mapsPath + thisMap + ".wfl");
+		FileInputStream instream = new FileInputStream (mapsPath + thisMap + ".wfl");
+		InputStreamReader in = new InputStreamReader(instream);
+		
 		String line = new String();
 		try {
 			for(int i = 0; i<4;i++){
 				line = in.readLine();
-				if (digSep.equals(",")) {line = line.replace('.',','); } // digSep == ',' musss genau so lauten. digsep.equals(',') wirft eine Exception auf PocketPC, digsep.equals(",") wirft keine Exception, funktioniert aber nicht! 
-				else line = line.replace(',','.');
-				affine[i] = Convert.toDouble(line);
+				affine[i] = Common.parseDoubleException(line);
 			}
 			line = in.readLine();
-			if (digSep.equals(",")) {line = line.replace('.',','); }
-			else line = line.replace(',','.');
-			topleft.latDec = Convert.toDouble(line);
+			affineTopleft.latDec = Common.parseDoubleException(line);
 			line = in.readLine();
-			if (digSep.equals(",")) {line = line.replace('.',','); }
-			else line = line.replace(',','.');
-			topleft.lonDec = Convert.toDouble(line);
+			affineTopleft.lonDec = Common.parseDoubleException(line);
 			line = in.readLine();
-			if (digSep.equals(",")) {line = line.replace('.',','); }
-			else line = line.replace(',','.');
-			buttomright.latDec = Convert.toDouble(line);
+			buttomright.latDec = Common.parseDoubleException(line);
 			line = in.readLine();
-			if (digSep.equals(",")) {line = line.replace('.',','); }
-			else line = line.replace(',','.');
-			buttomright.lonDec = Convert.toDouble(line);
-
+			buttomright.lonDec = Common.parseDoubleException(line);
+//			if (in.ready()) {// if there is more data... TODO this doesn't give the answer if there is more data :-(
+				line = in.readLine();
+				coordTrans = Common.parseInt(line);
+				//coordTrans = new TransformCoordinatesProperties(instream);
+			//}
+		//	else coordTrans = 0;
 			fileNameWFL = mapsPath + thisMap + ".wfl";
 //			fileName = ""; //mapsPath + thisMap + ".png";
 			mapName = thisMap;
 			in.close();
-			if( !topleft.isValid() ) {
+			if( !buttomright.isValid() ) {
 				affine[0] = 0; affine[1] = 0; affine[2] = 0; affine[3] = 0; 
-				buttomright.makeInvalid();
+				topleft.makeInvalid();
 				throw (new IOException("Lat/Lon out of range while reading "+mapsPath + thisMap + ".wfl"));
 			}
 		} catch (NullPointerException e) { // in.readline liefert null zur?ck, wenn keine Daten mehr vorhanden sind
 			throw (new IOException("not enough lines in file "+mapsPath + thisMap + ".wfl"));
 		}
-		OrigUpperLeft = new CWPoint(topleft);
 		doCalculations();
+		origAffineUpperLeft = new CWPoint(affineTopleft);
 	}
 
-	/**
+	public void evalGCP(ewe.util.Vector GCPs, int imageWidth, int imageHeight) throws IllegalArgumentException {
+		evalGCP(GCPs, imageWidth, imageHeight, 0);
+	}
+		/**
 	 *	Method to evaluate ground control points (georeferenced points) and identify the parameters
 	 *	for the affine transformation
 	 *  @throws IllegalArgumentException when less than 3 georeferenced points were given in GCPs
 	 */
 
-	public void evalGCP(ewe.util.Vector GCPs, int imageWidth, int imageHeight) throws IllegalArgumentException {
+	public void evalGCP(ewe.util.Vector GCPs, int imageWidth, int imageHeight, int epsg_code) throws IllegalArgumentException {
 		//N 48 16.000 E 11 32.000
 		//N 48 16.000 E 11 50.000
 		//N 48 9.000 E 11 32.000
@@ -225,7 +240,7 @@
 		beta.Multiply(trg);
 		affine[0] = beta.matrix[1][0];
 		affine[2] = beta.matrix[2][0];
-		topleft.latDec = beta.matrix[0][0];
+		affineTopleft.latDec = beta.matrix[0][0];
 
 		//Calculate parameters for longitude affine transformation (affine 1,3,5)
 		X = new Matrix(GCPs.size(),3);
@@ -248,8 +263,8 @@
 		beta.Multiply(trg);
 		affine[1] = beta.matrix[1][0];
 		affine[3] = beta.matrix[2][0];
-		topleft.lonDec = beta.matrix[0][0];
-
+		affineTopleft.lonDec = beta.matrix[0][0];
+		coordTrans = epsg_code;
 		buttomright = calcLatLon(imageWidth, imageHeight);
 		doCalculations();
 		//Vm.debug("A B C" + affine[0] + " " + affine[2] + " " + affine[4]);
@@ -263,6 +278,7 @@
 
 	private void doCalculations() throws ArithmeticException {
 		try {
+			topleft.set(calcLatLon(0, 0));
 			center.set((buttomright.latDec + topleft.latDec)/2,(buttomright.lonDec + topleft.lonDec)/2);
 			sizeKm = java.lang.Math.abs((float)center.getDistance(buttomright.latDec, buttomright.lonDec)) *2;
 
@@ -274,17 +290,32 @@
 			transLonY = affine[0]/nenner;
 
 			// calculate north direction
-			float scaleXpixels = 1/(float)java.lang.Math.sqrt(java.lang.Math.pow(transLonX,2)+java.lang.Math.pow(transLonY,2));
+			// float scaleXpixels = 1/(float)java.lang.Math.sqrt(java.lang.Math.pow(transLonX,2)+java.lang.Math.pow(transLonY,2));
 			//	float scaleY = 1/(float)java.lang.Math.sqrt(java.lang.Math.pow(transLatX,2)+java.lang.Math.pow(transLatY,2));
-			float rotationX2x=(float)transLonX*scaleXpixels;
-			float rotationX2y=(float)transLonY*scaleXpixels;
+			// float rotationX2x=(float)transLonX*scaleXpixels;
+			// float rotationX2y=(float)transLonY*scaleXpixels;
 			//rotationY2y=-(float)transLatY*scaleY; // lat -> y = -, y -> y = +
 			//rotationY2x=-(float)transLatX*scaleY; // uncomment an make it a field of MapInfoObject if you need translation from x to x rotated
-			rotationRad = (float)java.lang.Math.atan(rotationX2y);
-			if (rotationX2x < 0) rotationRad = (float)java.lang.Math.PI - rotationRad;
+			Point c = calcMapXY(center);
+			int heightpixel = c.y * 2;
+			c.y -= 1000;
+			rotationRad = (float) (center.getBearing(calcLatLon(c)) / 180 * Math.PI);  // note: the direction of nord can vary across the image. In Gau?-Kr?ger Projection it does change about 1 degree per 10km! //(float)java.lang.Math.atan(rotationX2y);
+			if (rotationRad > Math.PI) rotationRad -= 2* Math.PI;
+			//if (rotationX2x < 0) rotationRad = (float)java.lang.Math.PI - rotationRad;
 			// calculate scale in meters per pixel
-			double metersPerLat = 1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0));
-			scale = (float) java.lang.Math.abs((affine[2] * metersPerLat)); 
+			CWPoint bl = new CWPoint(buttomright.latDec, topleft.lonDec);
+			double diagonal = topleft.getDistance(buttomright);
+			double beta = java.lang.Math.atan(bl.getDistance(buttomright) / bl.getDistance(topleft));
+			double gamma = beta - rotationRad;
+			double heightkm = diagonal * Math.cos(gamma);
+			// double metersPerLat = 1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0));
+			CWPoint buttomleftimage = topleft.project(rotationRad * 180 / Math.PI + 180, heightkm);
+			CWPoint buttomleftimage2 = calcLatLon(0, heightpixel);
+			double kw = buttomleftimage.getDistance(buttomleftimage2);
+			double kw2 = buttomleftimage.getBearing(buttomleftimage2);
+			Vm.debug("project test: " + buttomleftimage.getDistance(topleft));
+			// double heightpixel = calcMapXY(buttomleftimage).y / Math.cos(rotationRad); 
+			scale = (float) (heightkm * 1000 / heightpixel); 
 		} catch (ArithmeticException ex) { throw new ArithmeticException("Not allowed values in affine\n (matrix cannot be inverted)\n in file \n" + fileNameWFL); }
 	}
 
@@ -309,10 +340,11 @@
 		Convert.toString(affine[1])+"\n" +
 		Convert.toString(affine[2])+"\n" + 
 		Convert.toString(affine[3])+"\n" + 
-		Convert.toString(topleft.latDec)+"\n" +
-		Convert.toString(topleft.lonDec)+"\n" +
+		Convert.toString(affineTopleft.latDec)+"\n" +
+		Convert.toString(affineTopleft.lonDec)+"\n" +
 		Convert.toString(buttomright.latDec)+"\n" +
-		Convert.toString(buttomright.lonDec)+"\n";
+		Convert.toString(buttomright.lonDec)+"\n" + 
+		((coordTrans == 0 || coordTrans == TransformCoordinates.EPSG_WGS84) ? "" : Convert.toString(coordTrans)+"\n");
 		if (digSep.equals(",")) towrite=towrite.replace(',', '.');
 		outp.print(towrite);
 		outp.close();
@@ -321,20 +353,6 @@
 		this.mapName = mapFileName;
 	}
 
-//	public boolean inBound(CWPoint pos){
-	//	boolean isInBound = false;
-	/*
-		Vm.debug(mapName);
-		Vm.debug("Top: " + affine[4]);
-		Vm.debug("Bottom: " + lowlat);
-		Vm.debug("Test: " + pos.latDec);
-		Vm.debug("Left: " + affine[5]);
-		Vm.debug("Right: " + lowlon);
-		Vm.debug("Test: " + pos.lonDec);
-	 */
-//	if(topleft.latDec >= pos.latDec && pos.latDec >= buttomright.latDec && topleft.lonDec <= pos.lonDec && pos.lonDec <= buttomright.lonDec) isInBound = true;
-	//	return isInBound;
-	//}
 
 	/**
 	 * zoom in / out
@@ -344,15 +362,16 @@
 	 */
 	public void zoom(float zf, int diffX, int diffY) {
 		// restore original values to calculate corret shift (upperleft)
-		topleft.latDec = OrigUpperLeft.latDec;
-		topleft.lonDec = OrigUpperLeft.lonDec;
+		affineTopleft.latDec = origAffineUpperLeft.latDec;
+		affineTopleft.lonDec = origAffineUpperLeft.lonDec;
 		affine[0] = affine[0] * zoomFactor; 
 		affine[1] = affine[1] * zoomFactor; 
 		affine[2] = affine[2] * zoomFactor;
 		affine[3] = affine[3] * zoomFactor;
-		CWPoint upperleft = calcLatLon(diffX, diffY);
-		topleft.latDec = upperleft.latDec;
-		topleft.lonDec = upperleft.lonDec;
+		TrackPoint upperleft = calcLatLon(diffX, diffY);
+		if (coordTrans != 0) upperleft = TransformCoordinatesProperties.fromWgs84(upperleft, coordTrans);
+		affineTopleft.latDec = upperleft.latDec; // TODO nachdenken affineTopleft
+		affineTopleft.lonDec = upperleft.lonDec;
 		affine[0] = affine[0] / zf ; 
 		affine[1] = affine[1] / zf ; 
 		affine[2] = affine[2] / zf ; 
@@ -363,12 +382,6 @@
 		doCalculations(); // TODO lowlat neu berechnen?
 	}
 
-	/*	public boolean inBound(double lati, double loni){
-		boolean isInBound = false;
-		if(topleft.latDec >= lati && lati >= buttomright.latDec && topleft.lonDec <= loni && loni <= buttomright.lonDec) isInBound = true;
-		return isInBound;
-	}
-	 */
 	/**
 	 * Method to calculate bitmap x,y of the current map using
 	 * lat and lon target coordinates. There ist no garanty that
@@ -376,15 +389,18 @@
 	 * @param lat
 	 * @param lon
 	 */
-	public Point calcMapXY(double lat, double lon){
+	public Point calcMapXY(TrackPoint ll){
+		TrackPoint t;
+		if (coordTrans != 0) t = TransformCoordinatesProperties.fromWgs84(ll, coordTrans);
+		else t = ll;
 		Point coords = new Point();
 		double b[] = new double[2];
-		b[0] = lat - topleft.latDec;
-		b[1] = lon - topleft.lonDec;
-		double mapx=transLatX* b[0] + transLonX*b[1];
-		double mapy=transLatY* b[0] + transLonY*b[1];
-		coords.x = (int)mapx;
-		coords.y = (int)mapy;
+		b[0] = t.latDec - affineTopleft.latDec;
+		b[1] = t.lonDec - affineTopleft.lonDec;
+		double mapx = transLatX* b[0] + transLonX*b[1];
+		double mapy = transLatY* b[0] + transLonY*b[1];
+		coords.x = (int)Math.round(mapx);
+		coords.y = (int)Math.round(mapy);
 		//Vm.debug("mapX=mapx2: "+mapx+"="+mapx2+"; mapy=mapy2: "+mapy+"="+mapy2);
 		return coords;
 	}
@@ -397,10 +413,13 @@
 	 */
 	public CWPoint calcLatLon(int x, int y) {
 		CWPoint ll = new CWPoint();
-		ll.latDec = (double)x * affine[0] + (double)y * affine[2] + topleft.latDec;
-		ll.lonDec = (double)x * affine[1] + (double)y * affine[3] + topleft.lonDec;
+		ll.latDec = (double)x * affine[0] + (double)y * affine[2] + affineTopleft.latDec;
+		ll.lonDec = (double)x * affine[1] + (double)y * affine[3] + affineTopleft.lonDec;
+		if (coordTrans != 0)
+			ll = TransformCoordinatesProperties.toWgs84(ll, coordTrans);
 		return ll;
 	}
+	
 	public CWPoint calcLatLon(Point p) {
 		return calcLatLon(p.x, p.y);
 	}
@@ -431,6 +450,11 @@
 			super(p);
 		}
 
+		/**
+		 * If you are using Gau?-Kr?ger, put lat = northing, lon = easting 
+		 * @param lat
+		 * @param lon
+		 */
 		public GCPoint(double lat, double lon){
 			this.latDec = lat;
 			this.lonDec = lon;

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -259,7 +259,7 @@
 		connImg = new HttpConnection(realurl);
 		connImg.setRequestorProperty("USER_AGENT", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
 		connImg.setRequestorProperty("Connection", "close");
-		connImg.setRequestorProperty("Cookie", "jscript=1; path=/;");
+	//	this prevents gdz1.leipzig.ifag.de (dtk100) from answering and ist not necessary for expedia connImg.setRequestorProperty("Cookie", "jscript=1; path=/;");
 		connImg.documentIsEncoded = true;
 		try{
 			File dateiF = new File(datei);
@@ -374,12 +374,9 @@
 
 	public Area CenterScaleToArea(CWPoint center, float scale, Point pixelsize) {
 		Area bbox = new Area();
-		bbox.topleft = new CWPoint (center);
-		bbox.topleft.shift(-pixelsize.x * scale / 2, 1);
-		bbox.topleft.shift(pixelsize.y * scale /2, 0);
-		bbox.buttomright = new CWPoint (center);
-		bbox.buttomright.shift(pixelsize.x * scale / 2, 1);
-		bbox.buttomright.shift(-pixelsize.y * scale /2, 0);
+		double halfdiagonal = Math.sqrt(pixelsize.x * pixelsize.x + pixelsize.y * pixelsize.y)/2 * scale / 1000;
+		bbox.topleft = center.project(-45, halfdiagonal);
+		bbox.buttomright = center.project(135, halfdiagonal);
 		return bbox;
 	}
 	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
@@ -481,10 +478,26 @@
 		ret[BUTTOMRIGHT_INDEX] = TransformCoordinates.wgs84ToGermanGk(maparea.buttomright, coordinateReferenceSystem[crs]);
 		ret[TOPRIGHT_INDEX] = new GkPoint(ret[BUTTOMRIGHT_INDEX].getGkEasting(), ret[TOPLEFT_INDEX].northing);
 		ret[BUTTOMLEFT_INDEX] = new GkPoint(ret[TOPLEFT_INDEX].getGkEasting(), ret[BUTTOMRIGHT_INDEX].northing);
+		Vm.debug("rot left direkt: " + TransformCoordinates.germanGkToWgs84(ret[TOPLEFT_INDEX]).getBearing(TransformCoordinates.germanGkToWgs84(ret[BUTTOMLEFT_INDEX])));
+		Vm.debug("rot right direkt: " + TransformCoordinates.germanGkToWgs84(ret[TOPRIGHT_INDEX]).getBearing(TransformCoordinates.germanGkToWgs84(ret[BUTTOMRIGHT_INDEX])));
 		//ret[2] = TransformCoordinates.wgs84ToGermanGk(topright, coordinateReferenceSystem[crs]);
 		//ret[3] = TransformCoordinates.wgs84ToGermanGk(buttomleft, coordinateReferenceSystem[crs]);
 		return ret;	
 	}
+	public Area CenterScaleToArea(CWPoint center, float scale, Point pixelsize) {
+		Area bbox = new Area(); // TODO if coordinatesystem == germenGK
+		GkPoint cgk = TransformCoordinates.wgs84ToGermanGk(center, coordinateReferenceSystem[getCrs(center)]);
+		GkPoint tlgk = new GkPoint(cgk);
+		tlgk.shift(- pixelsize.x * scale / 2, 1);
+		tlgk.shift(pixelsize.y * scale / 2, 0);
+		GkPoint brgk = new GkPoint(cgk);
+		brgk.shift(pixelsize.x * scale / 2, 1);
+		brgk.shift(-pixelsize.y * scale / 2, 0);
+		bbox.topleft = TransformCoordinates.germanGkToWgs84(tlgk);
+		bbox.buttomright = TransformCoordinates.germanGkToWgs84(brgk);
+		return bbox;
+	}
+
 	public String getUrlForBoundingBox(Area maparea, Point pixelsize) {
 		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + " not covered by service: " + name + ", service area: " + boundingBox.toString());
 		// http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetMap&SRS=EPSG:31466&BBOX=2577567.0149,5607721.7566,2578567.0077,5608721.7602&WIDTH=500&HEIGHT=500&LAYERS=Raster:TK25_KMF:Farbkombination&STYLES=&FORMAT=image/png
@@ -493,7 +506,7 @@
 		double scaleh = maparea.buttomright.getDistance(buttomleft) * 1000 / pixelsize.x; 
 		double scalev = maparea.topleft.getDistance(topright) * 1000 / pixelsize.y; 
 		double scale = Math.sqrt(scaleh * scaleh + scalev * scalev); // meters per pixel measured diagonal
-		if ( scale < minscaleWMS || scale > maxscaleWMS) throw new IllegalArgumentException("scale " + scale / Math.sqrt(2)+ " not supported by online map service, supported scale range: " + minscale + " - " + maxscale + " (measured in meters per pixel vertically)");
+		if ( scale < minscaleWMS || scale > maxscaleWMS ) throw new IllegalArgumentException("scale " + scale / Math.sqrt(2)+ " not supported by online map service, supported scale range: " + minscale + " - " + maxscale + " (measured in meters per pixel vertically)");
 		int crs = 0;
 		String bbox = "BBOX=";
 		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem[0])) {
@@ -501,8 +514,8 @@
 			GkPoint[] gk = getGkArea(maparea);
 			buttomleft = TransformCoordinates.germanGkToWgs84(gk[BUTTOMLEFT_INDEX]);
 			topright = TransformCoordinates.germanGkToWgs84(gk[TOPRIGHT_INDEX]);
-			bbox += TransformCoordinates.wgs84ToGermanGk(buttomleft, coordinateReferenceSystem[crs]).toString(3, "", ",");
-			bbox += "," + TransformCoordinates.wgs84ToGermanGk(topright, coordinateReferenceSystem[crs]).toString(3, "", ",");
+			bbox += TransformCoordinates.wgs84ToGermanGk(buttomleft, coordinateReferenceSystem[crs]).toString(2, "", ",");
+			bbox += "," + TransformCoordinates.wgs84ToGermanGk(topright, coordinateReferenceSystem[crs]).toString(2, "", ",");
 		} else if (coordinateReferenceSystem[0] == TransformCoordinates.EPSG_WGS84) 
 			bbox += buttomleft.toString(CWPoint.LON_LAT)  + "," + topright.toString(CWPoint.LON_LAT);
 		else throw new IllegalArgumentException("Coordinate system not supported by cachewolf: " + coordinateReferenceSystem.toString());
@@ -545,43 +558,43 @@
 		double metersperpixalvertical = ( buttomright.getDistance(topright) + topleft.getDistance(buttomleft))/2 * 1000 / pixelsize.y;
 		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem[0])) {
 			GkPoint[] gk = getGkArea(maparea);
-			GkPoint topleftgk = gk[TOPLEFT_INDEX]; //TransformCoordinates.wgs84ToGermanGk(topleft, coordinateReferenceSystem[crs]);
-			GkPoint buttomrightgk = gk[BUTTOMRIGHT_INDEX]; //TransformCoordinates.wgs84ToGermanGk(buttomright, coordinateReferenceSystem[crs]);
-/*			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
-			topleftgk.shift(metersperpixalhorizontal / 2, 1);
-			topleftgk.shift(-metersperpixalvertical / 2, 0);
-			buttomrightgk.shift(-metersperpixalhorizontal / 2, 1);
-			buttomrightgk.shift(metersperpixalvertical / 2, 0);
-*/
-			GkPoint buttomleftgk = gk[BUTTOMLEFT_INDEX]; // new GkPoint(topleftgk.getGkEasting(), buttomrightgk.northing);
-			GkPoint toprightgk = gk[TOPRIGHT_INDEX]; //new GkPoint(buttomrightgk.getGkEasting(), topleftgk.northing);
+			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
+			gk[TOPLEFT_INDEX].shift(metersperpixalhorizontal / 2, 1);
+			gk[TOPLEFT_INDEX].shift(-metersperpixalvertical / 2, 0);
+			gk[BUTTOMRIGHT_INDEX].shift(-metersperpixalhorizontal / 2, 1);
+			gk[BUTTOMRIGHT_INDEX].shift(metersperpixalvertical / 2, 0);
+			gk[TOPRIGHT_INDEX].shift(-metersperpixalhorizontal / 2, 1);
+			gk[TOPRIGHT_INDEX].shift(-metersperpixalvertical / 2, 0);
+			gk[BUTTOMLEFT_INDEX].shift(metersperpixalhorizontal / 2, 1);
+			gk[BUTTOMLEFT_INDEX].shift(metersperpixalvertical / 2, 0);
+
 			Vm.debug("\n" + maparea.topleft.toString(CWPoint.LAT_LON));
 			//Vm.debug(TransformCoordinates.germanGkToWgs84(TransformCoordinates.wgs84ToGermanGk(maparea.topleft)).toString(CWPoint.LAT_LON));
-			topleft = TransformCoordinates.germanGkToWgs84(topleftgk);
-			buttomright = TransformCoordinates.germanGkToWgs84(buttomrightgk);
-			buttomleft = TransformCoordinates.germanGkToWgs84(buttomleftgk);
-			topright = TransformCoordinates.germanGkToWgs84(toprightgk);
-			Vm.debug(topleft.toString(CWPoint.LAT_LON));
-			Vm.debug(buttomright.toString(CWPoint.LAT_LON));
-			Vm.debug(topright.toString(CWPoint.LAT_LON));
-			Vm.debug(buttomleft.toString(CWPoint.LAT_LON));
+			topleft.set(gk[TOPLEFT_INDEX].northing, gk[TOPLEFT_INDEX].getGkEasting());
+			buttomright.set(gk[BUTTOMRIGHT_INDEX].northing, gk[BUTTOMRIGHT_INDEX].getGkEasting());
+			topright.set(gk[TOPRIGHT_INDEX].northing, gk[TOPRIGHT_INDEX].getGkEasting());
+			buttomleft.set(gk[BUTTOMLEFT_INDEX].northing, gk[BUTTOMLEFT_INDEX].getGkEasting());
 		} else if (coordinateReferenceSystem[0] == TransformCoordinates.EPSG_WGS84) {
 			// bounding box in WMS is defined around the pixels, not exactly on the pixels --> the bounding box must be reduced on all edges by half a pixel
 			topleft.shift(metersperpixalhorizontal / 2, 1);
 			topleft.shift(-metersperpixalvertical / 2, 0);
 			buttomright.shift(-metersperpixalhorizontal, 1);
 			buttomright.shift(metersperpixalhorizontal, 0);
+			topright = new CWPoint (topleft.latDec, buttomright.lonDec);
 			buttomleft = new CWPoint (buttomright.latDec, topleft.lonDec);
-			topright = new CWPoint (topleft.latDec, buttomright.lonDec);
 		} else throw new IllegalArgumentException("getMapInfoObject: Coordinate system not supported by cachewolf: " + coordinateReferenceSystem);
 		georef.add(new GCPoint(topleft, new Point(0, 0)));
 		georef.add(new GCPoint(buttomright, new Point(pixelsize.x, pixelsize.y)));
+		georef.add(new GCPoint(topright, new Point(pixelsize.x, 0)));
 		georef.add(new GCPoint(buttomleft, new Point(0, pixelsize.y)));
-		georef.add(new GCPoint(topright, new Point(pixelsize.x, 0)));
 
 		MapInfoObject ret = new MapInfoObject();
-		ret.evalGCP(georef, pixelsize.x, pixelsize.y);
-		Vm.debug("\n nach kal\n" + ret.calcLatLon(0, 0).toString(CWPoint.LAT_LON));
+		ret.evalGCP(georef, pixelsize.x, pixelsize.y, coordinateReferenceSystem[getCrs(maparea.topleft)]);
+		Vm.debug("\n nach kal");
+		Vm.debug("fehler tl: " + ret.calcLatLon(0, 0).getDistance(maparea.topleft)*1000);
+		Vm.debug("fehler tl: " + ret.calcLatLon(0, 0).getBearing(maparea.topleft));
+		Vm.debug("fehler br: " + ret.calcLatLon(pixelsize.x, pixelsize.y).getDistance(maparea.buttomright)*1000);
+		Vm.debug("fehler br: " + ret.calcLatLon(pixelsize.x, pixelsize.y).getBearing(maparea.buttomright));
 		Vm.debug(ret.calcLatLon(pixelsize.x, pixelsize.y).toString(CWPoint.LAT_LON));
 		Vm.debug(ret.calcLatLon(pixelsize.x, 0).toString(CWPoint.LAT_LON));
 		Vm.debug(ret.calcLatLon(0, pixelsize.y).toString(CWPoint.LAT_LON));
@@ -612,11 +625,15 @@
 	}
 
 	public float getMetersPerPixel(float scale) {
-		return (float) Math.ceil(scale) * EXPEDIA_METERS_PER_PIXEL;
+		return (float)  EXPEDIA_METERS_PER_PIXEL * getZoomlevel(scale);
 	}
+	
+	private int getZoomlevel(float scale) {
+		return (int)(Math.ceil(scale / EXPEDIA_METERS_PER_PIXEL));
+	}
 
 	public String getUrlForCenterScale(CWPoint center, float scale, Point pixelsize) {
-		int zoomlevel = (int)(Math.ceil(scale / EXPEDIA_METERS_PER_PIXEL));
+		int zoomlevel = getZoomlevel(scale);
 		String zone;
 		if (center.lonDec <= -10) zone = "USA0409";
 		else zone = "EUR0809";

Modified: trunk/src/CacheWolf/navi/MapLoaderGui.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -303,11 +303,6 @@
 					(new MessageBox("Error", "The selected online map service provides map in the scale from " + mapLoader.currentOnlineMapService.minscale + " to "+ mapLoader.currentOnlineMapService.maxscale +"\n please adjust 'Approx. meter pro pixel' accordingly", MessageBox.OKB)).execute();
 					return;
 				}
-				if (!mapLoader.currentOnlineMapService.getName().equalsIgnoreCase("expedia") &&
-						scale > 0.5) {
-					int a = (new MessageBox("Error", "Momentanously the calibration of downloaded maps from a WMS has a maximam deviation of about 1 percent of the map size in meters. That's why I strongly recommend to use it only up to a scale of 0.5. In this case the deviation will be lower than 5m. Do you whish to continue anyway?", MessageBox.YESB | MessageBox.NOB)).execute();
-					if (a == MessageBox.NOB) return;
-				}
 				this.close(Form.IDOK); 
 				this.downloadTiles();
 			}

Modified: trunk/src/CacheWolf/navi/MapSymbol.java
===================================================================
--- trunk/src/CacheWolf/navi/MapSymbol.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/MapSymbol.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -1,23 +1,23 @@
 package CacheWolf.navi;
 
+import CacheWolf.CWPoint;
 import ewe.fx.*;
 import ewe.graphics.*;
 
-public class MapSymbol extends AniImage { // TODO make this implement MapImage, so that it will be invisible automatically if not on screen. When doing so, test if setgoto-pos -> open map from gotopanel shows the map symbols (directly after starting CW)
+public class MapSymbol extends MapImage { // TODO make this implement MapImage, so that it will be invisible automatically if not on screen. When doing so, test if setgoto-pos -> open map from gotopanel shows the map symbols (directly after starting CW)
 	Object mapObject;
 	String name;
 	String filename;
-	double lat, lon;
-	public MapSymbol(String namei, String filenamei, double lati, double loni) {
+	CWPoint where;
+	
+	public MapSymbol(String namei, String filenamei, CWPoint where_) {
 		name = namei;
 		filename = filenamei;
-		lat = lati;
-		lon = loni;
+		where = where_;
 	}
-	public MapSymbol(String namei, Object mapObjecti, Image fromIm, double lati, double loni) {
+	public MapSymbol(String namei, Object mapObjecti, Image fromIm, CWPoint where_) {
 		name = namei;
-		lat = lati;
-		lon = loni;
+		where = where_;
 		mapObject = mapObjecti;
 		setImage(fromIm);
 	}

Modified: trunk/src/CacheWolf/navi/MapsList.java
===================================================================
--- trunk/src/CacheWolf/navi/MapsList.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/MapsList.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -99,12 +99,12 @@
 	 * it always returns a map (if the list is not empty) as long as it overlaps the screen
 	 * @param forceScale: when true, return null if no map with specified scale could be found
 	 */
-	public MapInfoObject getBestMap(double lat, double lon, Rect screen, float scale, boolean forceScale) {
+	public MapInfoObject getBestMap(CWPoint ll, Rect screen, float scale, boolean forceScale) {
 		if (size() == 0) return null;
 		long start = new Time().getTime();
 		InfoBox progressBox = null;
 		boolean showprogress = false;
-		String cmp = "FF1"+Area.getEasyFindString(new CWPoint(lat, lon), 30);
+		String cmp = "FF1"+Area.getEasyFindString(ll, 30);
 		MapListEntry ml;
 		MapInfoObject mi;
 		MapInfoObject bestMap = null; // = (MapInfoObject)get(0);
@@ -131,28 +131,28 @@
 			better = false;
 //			mi = (MapInfoObject)get(i);
 			if (screenArea == null || !scaleEquals(lastscale, mi) ) {
-				screenArea = getAreaForScreen(screen, lat, lon, mi.scale, mi);
+				screenArea = getAreaForScreen(screen, ll, mi.scale, mi);
 				lastscale = mi.scale;
 			}
 			if (screenArea.isOverlapping(mi) ) { // is on screen
 				if (!forceScale || (forceScale && !scaleEquals(scale, mi))) { // different scale?
-					if (!forceScale && (mi.isInBound(lat, lon) && (bestMap == null || scaleNearer(mi.scale, bestMap.scale, scale) || !bestMap.isInBound(lat, lon)))) 
+					if (!forceScale && (mi.isInBound(ll) && (bestMap == null || scaleNearer(mi.scale, bestMap.scale, scale) || !bestMap.isInBound(ll)))) 
 						better = true; // inbound and resolution nearer at wanted resolution or old one is on screen but lat/long not inbound-> better
 					else {
 						if ( bestMap == null || scaleNearerOrEuqal(mi.scale, bestMap.scale, scale)) {
-							latNearer = java.lang.Math.abs(lat - mi.center.latDec)/mi.sizeKm < minDistLat ;
-							lonNearer = java.lang.Math.abs(lon - mi.center.lonDec)/mi.sizeKm < minDistLon;
+							latNearer = java.lang.Math.abs(ll.latDec - mi.center.latDec)/mi.sizeKm < minDistLat ;
+							lonNearer = java.lang.Math.abs(ll.lonDec - mi.center.lonDec)/mi.sizeKm < minDistLon;
 							if ( latNearer && lonNearer) better = true; // for faster processing: if lat and lon are nearer then the distancance doesn't need to be calculated
 							else {
 								if ( (latNearer || lonNearer )) { 
-									if (bestMap == null || mi.center.getDistanceRad(lat, lon) < bestMap.center.getDistanceRad(lat, lon) ) better = true;
+									if (bestMap == null || mi.center.getDistanceRad(ll) < bestMap.center.getDistanceRad(ll) ) better = true;
 								}
 							}
 						}
 					}
 					if (better) {
-						minDistLat = java.lang.Math.abs(lat - mi.center.latDec)/mi.sizeKm;
-						minDistLon = java.lang.Math.abs(lon - mi.center.lonDec)/mi.sizeKm;
+						minDistLat = java.lang.Math.abs(ll.latDec - mi.center.latDec)/mi.sizeKm;
+						minDistLon = java.lang.Math.abs(ll.lonDec - mi.center.lonDec)/mi.sizeKm;
 						bestMap = mi;
 						// Vm.debug("better"+ i);
 					}
@@ -218,7 +218,7 @@
 						if ( latNearer && lonNearer) better = true; // for faster processing: if lat and lon are nearer then the distancance doesn't need to be calculated
 						else {
 							if ( (latNearer || lonNearer )) { 
-								if (mi.center.getDistanceRad(topleft.latDec, topleft.lonDec) < fittingmap.center.getDistanceRad(topleft.latDec, topleft.lonDec) ) better = true;
+								if (mi.center.getDistanceRad(topleft) < fittingmap.center.getDistanceRad(topleft) ) better = true;
 							}
 						}
 
@@ -248,7 +248,7 @@
 	 * @param moreDetails true: find map with more details == higher resolustion = lower scale / false find map with less details = better overview
 	 * @return
 	 */
-	public MapInfoObject getMapChangeResolution(double lat, double lon, Rect screen, float curScale, boolean moreDetails){
+	public MapInfoObject getMapChangeResolution(CWPoint ll, Rect screen, float curScale, boolean moreDetails){
 		if (size() == 0) return null;
 		long start = new Time().getTime();
 		InfoBox progressBox = null;
@@ -262,7 +262,7 @@
 		boolean better = false;
 		Area screenArea = null; // getAreaForScreen(screen, lat, lon, bestMap.scale, bestMap);
 		float lastscale = -1;
-		String cmp = "FF1"+Area.getEasyFindString(new CWPoint(lat, lon), 30);
+		String cmp = "FF1"+Area.getEasyFindString(ll, 30);
 		for (int i=size()-1; i >= 0 ;i--) { 
 			if (!showprogress && ((i & 31) == 0) && (new Time().getTime()-start  > 100) ) { // reason for (i & 7 == 0): test time only after i is incremented 15 times
 				showprogress = true;      
@@ -279,28 +279,28 @@
 			} catch (IOException ex) {continue; } // could not read .wfl-file
 			if (mi.fileNameWFL == "") continue; // exclude "maps" without image // TODO make this a boolean in MapInfoObject
 			if (screenArea == null || !scaleEquals(lastscale, mi)) {
-				screenArea = getAreaForScreen(screen, lat, lon, mi.scale, mi);
+				screenArea = getAreaForScreen(screen, ll, mi.scale, mi);
 				lastscale = mi.scale;
 			}
 			if (screenArea.isOverlapping(mi)) { // is on screen
 				if (bestMap == null || !scaleEquals(mi, bestMap)) { // different scale than known bestMap?
-					if (mi.isInBound(lat, lon) && (      // more details wanted and this map has more details?                                // less details than bestmap
+					if (mi.isInBound(ll) && (      // more details wanted and this map has more details?                                // less details than bestmap
 							(moreDetails && (curScale > mi.scale * scaleTolerance) && (bestMap == null || mi.scale > bestMap.scale * scaleTolerance ) ) // higher resolution wanted and mi has higher res and a lower res than bestmap, because we dont want to overjump one resolution step
 							|| (!moreDetails && (curScale *  scaleTolerance < mi.scale) && (bestMap == null || mi.scale * scaleTolerance < bestMap.scale) ) // lower resolution wanted and mi has lower res and a higher res than bestmap, because we dont want to overjump one resolution step
 					) )	better = true;	// inbound and higher resolution if higher res wanted -> better
 				} else { // same scale as bestmap -> look if naerer 
-					latNearer = java.lang.Math.abs(lat - mi.center.latDec)/mi.sizeKm < minDistLat ;
-					lonNearer = java.lang.Math.abs(lon - mi.center.lonDec)/mi.sizeKm < minDistLon;
+					latNearer = java.lang.Math.abs(ll.latDec - mi.center.latDec)/mi.sizeKm < minDistLat ;
+					lonNearer = java.lang.Math.abs(ll.lonDec - mi.center.lonDec)/mi.sizeKm < minDistLon;
 					if ( latNearer && lonNearer) better = true; // for faster processing: if lat and lon are nearer then the distancance doesn't need to be calculated
 					else {
 						if ( (latNearer || lonNearer )) { 
-							if (bestMap == null || mi.center.getDistanceRad(lat, lon) < bestMap.center.getDistanceRad(lat, lon) ) better = true;
+							if (bestMap == null || mi.center.getDistanceRad(ll) < bestMap.center.getDistanceRad(ll) ) better = true;
 						}
 					}
 				} // same scale
 				if (better) {
-					minDistLat = java.lang.Math.abs(lat - mi.center.latDec)/mi.sizeKm;
-					minDistLon = java.lang.Math.abs(lon - mi.center.lonDec)/mi.sizeKm;
+					minDistLat = java.lang.Math.abs(ll.latDec - mi.center.latDec)/mi.sizeKm;
+					minDistLon = java.lang.Math.abs(ll.lonDec - mi.center.lonDec)/mi.sizeKm;
 					bestMap = mi;
 					// Vm.debug("better"+ i);
 				}
@@ -322,9 +322,9 @@
 	 * @param map map for which the screen edges are wanted
 	 * @return
 	 */
-	private Area getAreaForScreen(Rect a, double lat, double lon, float scale, MapInfoObject map) {
+	private Area getAreaForScreen(Rect a, CWPoint ll, float scale, MapInfoObject map) {
 		Area ret = null;
-		Point xy = map.calcMapXY(lat, lon);
+		Point xy = map.calcMapXY(ll);
 		Point topleft = new Point(xy.x - a.x, xy.y - a.y);
 		ret = new Area(map.calcLatLon(topleft), map.calcLatLon(topleft.x+a.width, topleft.y+a.height));
 		return ret; 

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -59,10 +59,10 @@
 	Graphics DistanceImageGraphics;
 	AniImage ScaleImage;
 	Graphics ScaleImageGraphics;
-	MapImage posCircle = new MapImage("position_green.png");
+	MapSymbol posCircle = new MapSymbol("position_green.png", "gps-position", new CWPoint());
 	public static final String MARK_CACHE_IMAGE = "mark_cache.png";
 	int posCircleX = 0, posCircleY = 0, lastCompareX = Integer.MAX_VALUE, lastCompareY = Integer.MAX_VALUE;
-	double posCircleLat, posCircleLon;
+	//double posCircleLat, posCircleLon;
 	FontMetrics fm;
 
 	boolean dontUpdatePos = false; // this is only internaly used to avoid multi-threading problems
@@ -135,8 +135,6 @@
 		mmp.addImage(posCircle);
 		mmp.startDragResolution = 5;
 		mapsloaded = false;
-		posCircleLat = -361;
-		posCircleLon = -361; // make them invalid
 		//updateDistance(); // fill Rect with transparent color
 		scaleWanted = 1;
 		mapChangeModus = HIGHEST_RESOLUTION_GPS_DEST;
@@ -162,9 +160,12 @@
 		buttonImageLensActivatedZoomOut.setLocation(w - buttonImageLensActivatedZoomOut.getWidth()-10, h/2 - buttonImageLensActivatedZoomOut.getHeight()/2 );
 		DistanceImage.setLocation(0, h - DistanceImage.getHeight());
 		ScaleImage.setLocation(w - ScaleImage.getWidth(), h - ScaleImage.getHeight());
-		if (mmp.mapImage != null) mmp.mapImage.move(mmp.mapImage.locAlways.x, mmp.mapImage.locAlways.y); // this is necessary to make a new decision if it is still on the screen (and actually mor important because MapImage only now gets to know the screen size) 
-		if (posCircle != null) posCircle.move(posCircle.locAlways.x, posCircle.locAlways.y); // this is necessary to make a new decision if it is still on the screen (and actually mor important because MapImage only now gets to know the screen size) 
+		if (mmp.mapImage != null) mmp.mapImage.screenDimChanged(); 
+		if (posCircle != null) posCircle.screenDimChanged(); 
 		if (tracks != null) addOverlaySet();
+		for (int i = symbols.size() -1; i >= 0; i-- ) {
+			((MapSymbol)symbols.get(i)).screenDimChanged();
+		}
 	}
 
 	boolean loadingMapList = false;
@@ -237,9 +238,9 @@
 	public void updateDistance(boolean repaint) {
 		DistanceImageGraphics.setColor(DistanceImage.transparentColor);
 		DistanceImageGraphics.fillRect(0, 0, DistanceImage.location.width,DistanceImage.location.height);
-		if (gotoPos != null && posCircleLat >= -360)
+		if (gotoPos != null && posCircle.where.isValid())
 		{
-			double currentDistance = (new CWPoint(gotoPos.lat, gotoPos.lon).getDistance(posCircleLat, posCircleLon));
+			double currentDistance = gotoPos.where.getDistance(posCircle.where);
 			if (currentDistance != lastDistance)
 			{
 				lastDistance = currentDistance;
@@ -285,7 +286,7 @@
 
 	public void forceMapLoad() {
 		forceMapLoad = true;
-		updatePosition(posCircleLat, posCircleLon); // this sets forceMapLoad to false after loading a map
+		updatePosition(posCircle.where); // this sets forceMapLoad to false after loading a map
 	}
 
 	public final FormFrame myExec() {
@@ -300,7 +301,7 @@
 				ch = (CacheHolder) cacheDB.get(i);
 				if (ch.is_Checked && !ch.is_filtered && ch != mainT.ch) {
 					int ct = Convert.parseInt(ch.type);
-					addSymbol(ch.CacheName, ch, myTableModel.cacheImages[ct], ch.pos.latDec, ch.pos.lonDec);
+					if (ch.pos.isValid()) addSymbol(ch.CacheName, ch, myTableModel.cacheImages[ct], ch.pos);
 				}
 			}
 		}
@@ -321,9 +322,9 @@
 			if (!markedCache.is_Checked) removeMapSymbol(markedCache);
 		}
 		if (ch != null) {
-			addSymbol("selectedCache", MARK_CACHE_IMAGE, ch.pos.latDec, ch.pos.lonDec);
+			addSymbol("selectedCache", MARK_CACHE_IMAGE, ch.pos);
 			int ct = Convert.parseInt(ch.type);
-			addSymbolIfNecessary(ch.CacheName, ch, myTableModel.cacheImages[ct], ch.pos.latDec, ch.pos.lonDec);
+			addSymbolIfNecessary(ch.CacheName, ch, myTableModel.cacheImages[ct], ch.pos);
 		}
 		markedCache = ch;
 	}
@@ -370,14 +371,14 @@
 
 
 	public void addMissingOverlays() {
-		if (currentMap == null || posCircleLat < -360 || width == 0 || height == 0) return; // height == 0 happens if this is called before the form ist displayed on the screen
+		if (currentMap == null || (!posCircle.where.isValid()) || width == 0 || height == 0) return; // height == 0 happens if this is called before the form ist displayed on the screen
 		if (TrackOverlays == null) {
 			TrackOverlays = new TrackOverlay[9];
 			TrackOverlaySetCenterTopLeft = ScreenXY2LatLon(100, 100);
 		}
 		boolean saveGPSIgnoreStatus = dontUpdatePos; // avoid multi-threading problems
 		dontUpdatePos = true;
-		Point upperleftOf4 = getXYonScreen(TrackOverlaySetCenterTopLeft.latDec, TrackOverlaySetCenterTopLeft.lonDec); // TrackOverlay[4] == center of Trackoverlays 
+		Point upperleftOf4 = getXYonScreen(TrackOverlaySetCenterTopLeft); // TrackOverlay[4] == center of Trackoverlays 
 		//upperleftOf4.x = (upperleftOf4.x + 1* width) % (width * 2) - 1 * width;
 		//upperleftOf4.y = (upperleftOf4.y + 1* height) % (height * 2) - 1 * height;
 		int i;
@@ -405,7 +406,7 @@
 		TrackOverlays[ov]=null;
 	}
 	public void rearangeOverlays() {
-		Point oldp = getXYonScreen(TrackOverlaySetCenterTopLeft.latDec, TrackOverlaySetCenterTopLeft.lonDec);
+		Point oldp = getXYonScreen(TrackOverlaySetCenterTopLeft);
 		if (TrackOverlays[1].isOnScreen()) { // oben raus
 			TrackOverlaySetCenterTopLeft.set(ScreenXY2LatLon(oldp.x, oldp.y - 2* height));
 			destroyOverlay(6);
@@ -570,7 +571,7 @@
 		if (TrackOverlays == null || TrackOverlays[4] == null) return;
 		//	Point upperleft = getMapXYPosition();
 		Point posOnScreen;
-		posOnScreen = getXYonScreen(TrackOverlays[4].topLeft.latDec, TrackOverlays[4].topLeft.lonDec);
+		posOnScreen = getXYonScreen(TrackOverlays[4].topLeft);
 		Dimension ws = mmp.getSize(null);
 		int ww = ws.width;
 		int wh = ws.height;
@@ -626,7 +627,7 @@
 
 	public void moveScreenXYtoLatLon(Point s, CWPoint c, boolean repaint) {
 		Point mappos = getMapPositionOnScreen();
-		Point onscreenpos = getXYonScreen(c.latDec, c.lonDec);
+		Point onscreenpos = getXYonScreen(c);
 		if (mmp != null && mmp.mapImage != null) mmp.mapImage.move(mappos.x - onscreenpos.x + s.x, mappos.y - onscreenpos.y + s.y);
 		mapMoved(s.x - onscreenpos.x, s.y - onscreenpos.y);
 		if (repaint) mmp.repaintNow();
@@ -658,11 +659,11 @@
 	 * @return
 	 */
 	public Point getMapPositionOnScreen() {
-		if (currentMap == null || posCircleLon < -360) return new Point(pref.myAppWidth +1, pref.myAppHeight +1); // in case no calculation is possible return somthing outside of the screen
+		if (currentMap == null || !posCircle.where.isValid()) return new Point(pref.myAppWidth +1, pref.myAppHeight +1); // in case no calculation is possible return somthing outside of the screen
 		Point mapPos = new Point(); 
 		//if (mmp.mapImage != null) mmp.mapImage.getLocation(mapPos);
 		//else {
-		Point mapposint = currentMap.calcMapXY(posCircleLat, posCircleLon);
+		Point mapposint = currentMap.calcMapXY(posCircle.where);
 		mapPos.x = posCircleX - mapposint.x;
 		mapPos.y = posCircleY - mapposint.y;
 		//}
@@ -675,9 +676,9 @@
 	 * @param lon
 	 * @return
 	 */
-	public Point getXYonScreen(double lat, double lon){
+	public Point getXYonScreen(TrackPoint ll){
 		if (currentMap == null) return null;
-		Point coords = currentMap.calcMapXY(lat, lon);
+		Point coords = currentMap.calcMapXY(ll);
 		Point mapPos = getMapPositionOnScreen();
 		//		Vm.debug("getXYinMap, posCiLat: "+posCircleLat+"poscLOn: "+ posCircleLon+"gotoLat: "+ lat + "gotoLon: "+ lon+" mapPosX: "+mapPos.x+"mapposY"+mapPos.y);
 		return new Point(coords.x + mapPos.x, coords.y + mapPos.y);
@@ -693,50 +694,39 @@
 		if (symbols == null) return;
 		Point pOnScreen;
 		MapSymbol symb;
-		int ww = this.width;
-		int wh = this.height;
 		int w, h;
 		for (int i=symbols.size()-1; i>=0; i--) {
 			symb = (MapSymbol)symbols.get(i);
-			pOnScreen = getXYonScreen(symb.lat, symb.lon);
+			pOnScreen = getXYonScreen(symb.where);
 			w=symb.getWidth();
 			h=symb.getHeight();
-			if (pOnScreen.x+w >= 0 && pOnScreen.x <= ww && pOnScreen.y+h >= 0 &&  pOnScreen.y <= wh) 
-			{
-				symb.properties &= ~mImage.IsInvisible;
-				symb.move(pOnScreen.x-w/2, pOnScreen.y-h/2);
-			}
-			else 
-			{symb.properties |= mImage.IsInvisible;
-			symb.move(30, 30);
-			}
-			//symb.pic.move(ww+1, wh+1);
+			symb.move(pOnScreen.x-w/2, pOnScreen.y-h/2);
 		}
 	}
 
-	public MapSymbol addSymbol(String name, String filename, double lat, double lon) {
+	public MapSymbol addSymbol(String name, String filename, CWPoint where) {
 		if (symbols==null) symbols=new Vector();
-		MapSymbol ms = new MapSymbol(name, filename, lat, lon);
+		MapSymbol ms = new MapSymbol(name, filename, where);
 		ms.loadImage();
 		ms.properties |= AniImage.AlwaysOnTop;
-		Point pOnScreen = getXYonScreen(lat, lon);
+		Point pOnScreen = getXYonScreen(where);
 		ms.setLocation(pOnScreen.x-ms.getWidth()/2, pOnScreen.y-ms.getHeight()/2);
 		symbols.add(ms);
 		mmp.addImage(ms);
 		return ms;
 	}
 	
-	public void addSymbolIfNecessary(String name, Object mapObject, Image imSymb, double lat, double lon) {
+	public void addSymbolIfNecessary(String name, Object mapObject, Image imSymb, CWPoint where) {
 		if (findMapSymbol(name) >= 0) return;
-		else addSymbol(name, mapObject, imSymb, lat, lon);
+		else addSymbol(name, mapObject, imSymb, where);
 		
 	}
 		
-	public void addSymbol(String name, Object mapObject, Image imSymb, double lat, double lon) {
+	public void addSymbol(String name, Object mapObject, Image imSymb, CWPoint ll) {
 		if (symbols==null) symbols=new Vector();
-		MapSymbol ms = new MapSymbol(name, mapObject, imSymb, lat, lon);
+		MapSymbol ms = new MapSymbol(name, mapObject, imSymb, ll);
 		ms.properties = AniImage.AlwaysOnTop;
-		Point pOnScreen=getXYonScreen(lat, lon);
+		Point pOnScreen = getXYonScreen(ll);
 		if (pOnScreen != null) ms.setLocation(pOnScreen.x-ms.getWidth()/2, pOnScreen.y-ms.getHeight()/2);
 		symbols.add(ms);
 		mmp.addImage(ms);
@@ -744,13 +734,13 @@
 
 	public void destChanged(CWPoint d) {
 		if(!running || (d == null && gotoPos == null) || 
-				(d != null && gotoPos != null && d.latDec == gotoPos.lat && d.lonDec == gotoPos.lon)) return;
+				(d != null && gotoPos != null && gotoPos.where.equals(d))) return;
 		removeGotoPosition();
 		if (d == null || !d.isValid() ) return;
-		gotoPos = addSymbol("goto", "goto_map.png", d.latDec, d.lonDec);
+		gotoPos = addSymbol("goto", "goto_map.png", d);
 		//updateDistance(); - this is called from updatePosition
 		forceMapLoad = true;
-		if (this.width != 0) updatePosition(posCircleLat, posCircleLon); // dirty hack: if this.width == 0, then the symbols are not on the screen and get hidden by updateSymbolPositions
+		if (this.width != 0) updatePosition(posCircle.where); // dirty hack: if this.width == 0, then the symbols are not on the screen and get hidden by updateSymbolPositions
 	}
 
 	public void removeGotoPosition() {
@@ -759,7 +749,7 @@
 
 	public CWPoint getGotoPos(){
 		if (gotoPos == null) return null;
-		return new CWPoint(gotoPos.lat, gotoPos.lon);
+		return new CWPoint(gotoPos.where);
 	}
 
 	public void removeAllMapSymbolsButGoto(){
@@ -812,10 +802,9 @@
 	 * 
 	 * @param  
 	 */
-	public void updateOnlyPosition(double lat, double lon, boolean updateOverlay){
+	public void updateOnlyPosition(CWPoint where, boolean updateOverlay){
 		//Point oldMapPos = getMapPositionOnScreen();
-		posCircleLat = lat;
-		posCircleLon = lon;
+		posCircle.where.set(where);
 		Point mapPos = getMapPositionOnScreen();
 		//Vm.debug("mapx = " + mapx);
 		//Vm.debug("mapy = " + mapy);
@@ -837,19 +826,19 @@
 	/**
 	 * Method to laod the best map for lat/lon and move the map so that the posCircle is at lat/lon
 	 */
-	public void updatePosition(double lat, double lon){
+	public void updatePosition(CWPoint where){
 		if (dontUpdatePos || loadingMapList) return; // avoid multi-threading problems
-		Vm.debug("updatepos, lat: "+lat+" lon: "+lon);
+		Vm.debug("updatepos, lat: "+where.latDec+" lon: "+where.lonDec);
 		if (!mapsloaded) {
-			loadMaps(Global.getPref().getMapLoadPath(), lat);
+			loadMaps(Global.getPref().getMapLoadPath(), where.latDec);
 			lastCompareX = Integer.MAX_VALUE;
 			lastCompareY = Integer.MAX_VALUE;
 			autoSelectMap = true;
-			setBestMap(lat, lon, true);
+			setBestMap(where, true);
 			forceMapLoad = false;
 			return;
 		}
-		updateOnlyPosition(lat, lon, true);
+		updateOnlyPosition(where, true);
 		if (!autoSelectMap) return;
 		Point mapPos = getMapPositionOnScreen();
 		boolean screenNotCompletlyCovered =  mmp.mapImage == null || (mmp.mapImage != null && ( mapPos.y > 0 || mapPos.x > 0 || mapPos.y+mmp.mapImage.getHeight()<this.height	|| mapPos.x+mmp.mapImage.getWidth()<this.width));
@@ -859,7 +848,7 @@
 				// more then 1/10 of screen moved since last time we tried to find a better map
 				lastCompareX = mapPos.x;
 				lastCompareY = mapPos.y;
-				setBestMap(lat, lon, screenNotCompletlyCovered);
+				setBestMap(where, screenNotCompletlyCovered);
 				forceMapLoad = false;
 			}
 		}
@@ -872,7 +861,7 @@
 			directionArrows.setDirections((float)myNavigation.gpsPos.getBearing(myNavigation.destination),
 					(float)myNavigation.skyOrientationDir.lonDec, (float)myNavigation.gpsPos.getBear());
 			setGpsStatus(MovingMap.gotFix);
-			updatePosition(myNavigation.gpsPos.latDec, myNavigation.gpsPos.lonDec);
+			updatePosition(myNavigation.gpsPos);
 			ShowLastAddedPoint(myNavigation.curTrack);
 		}
 		if (fix == 0 && myNavigation.gpsPos.getSats()== 0) 	setGpsStatus(MovingMap.lostFix);
@@ -909,10 +898,10 @@
 	 * @param loadIfSameScale false: will not change the map if the better map has the same scale as the current - this is used not to change the map if it covers already the screen completely
 	 * true: willchange the map, regardless of change in scale
 	 */
-	public void setBestMap(double lat, double lon, boolean loadIfSameScale) {
+	public void setBestMap(CWPoint where, boolean loadIfSameScale) {
 		if (inBestMap) return;
 		inBestMap = true;
-		Object [] s = getRectForMapChange(lat, lon);
+		Object [] s = getRectForMapChange(where);
 		CWPoint cll = (CWPoint) s[0]; 
 		Rect screen = (Rect) s[1]; 
 		MapInfoObject newmap = null;
@@ -920,25 +909,25 @@
 		wantMapTest = true;
 		switch (mapChangeModus) {
 		case NORMAL_KEEP_RESOLUTION: 
-			newmap = maps.getBestMap(cll.latDec, cll.lonDec, screen, scaleWanted, false);
+			newmap = maps.getBestMap(cll, screen, scaleWanted, false);
 			if (newmap == null) newmap = currentMap;
 			if (MapsList.scaleEquals(scaleWanted, newmap)) wantMapTest = false;
 			break;
-		case HIGHEST_RESOLUTION: newmap = maps.getBestMap(cll.latDec, cll.lonDec, screen, 0.000001f, false); break;
+		case HIGHEST_RESOLUTION: newmap = maps.getBestMap(cll, screen, 0.000001f, false); break;
 		case HIGHEST_RESOLUTION_GPS_DEST: 
-			if (gotoPos!= null && GpsStatus != noGPS && posCircleLat>= -90 && posCircleLat <= 90 && posCircleLon >= -360 && posCircleLon <= 360) {
-				newmap = maps.getMapForArea(new CWPoint(posCircleLat, posCircleLon), new CWPoint(gotoPos.lat, gotoPos.lon)); // TODO use home-coos if no gps? - consider start from details panel and from gotopanel
-				if (newmap == null) newmap = maps.getBestMap(cll.latDec, cll.lonDec, screen, 10000000000000000000000000000000000f, false); // use map with most available overview if no map containing PosCircle and GotoPos is available
+			if (gotoPos!= null && GpsStatus != noGPS && posCircle.where.isValid()) {
+				newmap = maps.getMapForArea(posCircle.where, gotoPos.where); // TODO use home-coos if no gps? - consider start from details panel and from gotopanel
+				if (newmap == null) newmap = maps.getBestMap(cll, screen, 10000000000000000000000000000000000f, false); // use map with most available overview if no map containing PosCircle and GotoPos is available
 			}
 			//	either Goto-Pos or GPS-Pos not set
-			else newmap = maps.getBestMap(cll.latDec, cll.lonDec, screen, 0.000001f, false); 
+			else newmap = maps.getBestMap(cll, screen, 0.000001f, false); 
 			break;
 		default: (new MessageBox("Error", "Programmfehler: \nillegal mapChangeModus: " + mapChangeModus, MessageBox.OKB)).execute(); break;
 		}
 		if ( newmap != null && (currentMap == null || !currentMap.mapName.equals(newmap.mapName)) ) {
 			if (loadIfSameScale || !MapsList.scaleEquals(currentMap.scale / currentMap.zoomFactor, newmap) ) {
 				Vm.debug("better map found");
-				setMap(newmap, lat, lon);
+				setMap(newmap, where);
 				moveScreenXYtoLatLon(new Point(screen.x, screen.y), cll, true);
 			}
 			inBestMap = false;
@@ -946,11 +935,10 @@
 		}
 		if (currentMap == null && newmap == null) {
 			// (new MessageBox("Information", "F?r die aktuelle Position steht keine Karte zur Verf?ng, bitte w?hlen Sie eine manuell", MessageBox.OKB)).execute();
-			posCircleLat = cll.latDec;
-			posCircleLon = cll.lonDec; // choosemap calls setmap with posCircle-coos
+			posCircle.where.set(cll); // choosemap calls setmap with posCircle-coos
 			try {
-				setMap( ((MapListEntry)maps.elementAt(maps.getCount() - 4)).getMap(), lat, lon); // beware: "-4" only works if the empty maps were added last see MapsList.addEmptyMaps
-			} catch (IOException e) { (new MessageBox("Error", "setBestMap: problem in: setMap( ((MapListEntry)maps.elementAt(maps.getCount() - 4)).getMap(), lat, lon) lat/lon:" + lat+"/"+lon, MessageBox.OKB)).exec(); }
+				setMap( ((MapListEntry)maps.elementAt(maps.getCount() - 4)).getMap(), where); // beware: "-4" only works if the empty maps were added last see MapsList.addEmptyMaps
+			} catch (IOException e) { (new MessageBox("Error", "setBestMap: problem in: setMap( ((MapListEntry)maps.elementAt(maps.getCount() - 4)).getMap(), lat, lon) lat/lon:" + where.toString(), MessageBox.OKB)).exec(); }
 			while (currentMap == null) {
 				mmp.chooseMap(); // force the user to select a scale // TODO empty maps on top?
 				if (currentMap == null) (new MessageBox("Error", "Moving map cannot run without a map - please select one. \n You can select an empty map", MessageBox.OKB)).execute();
@@ -963,7 +951,7 @@
 		scaleWanted = currentMap.scale;
 		if (mapChangeModus == modus) return;
 		mapChangeModus = modus;
-		if (modus != NORMAL_KEEP_RESOLUTION) setBestMap(posCircleLat, posCircleLon, true);
+		if (modus != NORMAL_KEEP_RESOLUTION) setBestMap(posCircle.where, true);
 	}
 	/**
 	 * method to get a point on the screen which must be included in the map
@@ -975,7 +963,7 @@
 	 * @param lon
 	 * @return
 	 */
-	public Object[] getRectForMapChange(double lat, double lon) {
+	public Object[] getRectForMapChange(CWPoint ll) {
 		int w = (width != 0 ? width : pref.myAppWidth); // width == 0 happens if this routine is run before the windows is on the screen
 		int h = (height != 0 ? height : pref.myAppHeight);
 		int x, y;
@@ -983,7 +971,7 @@
 		if (posCircleX >= 0 && posCircleX <= w && posCircleY >= 0 && posCircleY <= h) {
 			x = posCircleX; // posCircle is inside the screen
 			y = posCircleY; // TODO eigentlich interessiert, ob nach dem evtl. Kartenwechsel PosCircle on Screen ist. So wie es jetzt ist, kann 2mal der gleiche Aufruf zum laden unterschiedlicher Karten f?hren, wenn vorher PosCircle nicht auf dem SChirm war, nach dem ersten Laden aber schon.
-			cll = new CWPoint(lat, lon);
+			cll = new CWPoint(ll);
 		} else { // when posCircle out of screen - use centre of screen as point which as to be included in the map
 			cll = ScreenXY2LatLon(w/2, h/2);
 			x = w/2;
@@ -1001,15 +989,15 @@
 	 * @return
 	 */
 	public void loadMoreDetailedMap(boolean betterOverview){
-		Object [] s = getRectForMapChange(posCircleLat, posCircleLon);
+		Object [] s = getRectForMapChange(posCircle.where);
 		CWPoint cll = (CWPoint) s[0]; 
 		Rect screen = (Rect) s[1]; 
 		//Rect screen = new Rect(posCircleX, posCircleY, (width != 0 ? width : pref.myAppWidth), (height != 0 ? height : pref.myAppHeight));
-		MapInfoObject m = maps.getMapChangeResolution(cll.latDec, cll.lonDec, screen, currentMap.scale / currentMap.zoomFactor, !betterOverview);
+		MapInfoObject m = maps.getMapChangeResolution(cll, screen, currentMap.scale / currentMap.zoomFactor, !betterOverview);
 		if (m != null) {
 			boolean saveGpsIgnStatus = dontUpdatePos;
 			dontUpdatePos = true;
-			setMap(m, posCircleLat, posCircleLon);
+			setMap(m, posCircle.where);
 			setResModus(MovingMap.NORMAL_KEEP_RESOLUTION);
 			dontUpdatePos = saveGpsIgnStatus;
 		}
@@ -1024,14 +1012,14 @@
 		}
 		MapInfoObject newmap = maps.getMapForArea(sur.topleft, sur.buttomright);
 		if (newmap == null ) { // no map that includs all caches is available -> load map with lowest resolution
-			Object [] s = getRectForMapChange(posCircleLat, posCircleLon);
+			Object [] s = getRectForMapChange(posCircle.where);
 			CWPoint cll = (CWPoint) s[0]; 
 			Rect screen = (Rect) s[1]; 
-			newmap = maps.getBestMap(cll.latDec, cll.lonDec, screen, Float.MAX_VALUE -1, false);
+			newmap = maps.getBestMap(cll, screen, Float.MAX_VALUE -1, false);
 		}
 		boolean saveGpsIgnStatus = dontUpdatePos;
 		dontUpdatePos = true;
-		setMap(newmap, posCircleLat, posCircleLon);
+		setMap(newmap, posCircle.where);
 		setResModus(MovingMap.NORMAL_KEEP_RESOLUTION);
 		dontUpdatePos = saveGpsIgnStatus;
 	}
@@ -1059,7 +1047,7 @@
 		autoSelectMap = true;
 		forceMapLoad = true;
 		showMap();
-		if (myNavigation.gpsPos.Fix <=0) updatePosition(posCircleLat, posCircleLon);
+		if (myNavigation.gpsPos.Fix <=0) updatePosition(posCircle.where);
 		else updateGps(myNavigation.gpsPos.getFix());
 	}
 
@@ -1069,9 +1057,9 @@
 	 * @param lat move map so that lat/lon is in the centre / -361: don't adust to lat/lon
 	 * @param lon -361: don't adust to lat/lon
 	 */
-	public void setMap(MapInfoObject newmap, double lat, double lon) {
+	public void setMap(MapInfoObject newmap, CWPoint where) {
 		if (currentMap != null && newmap.mapName.equals(currentMap.mapName) && !forceMapLoad) { // note: newmap.mapName == currentMap.mapName won't work because they are different String containing the same text 
-			updateOnlyPosition(lat, lon, true); 
+			updateOnlyPosition(where, true); 
 			return;
 		}
 		Vm.showWait(true);
@@ -1112,7 +1100,7 @@
 			mmp.images.moveToBack(mmp.mapImage);
 			addOverlaySet();
 			forceMapLoad = true; // forces updateOnlyPosition to redraw
-			updateOnlyPosition(lat, lon, false);
+			updateOnlyPosition(where, false);
 			forceMapLoad = false;
 			directionArrows.setMap(currentMap);
 			updateScale();
@@ -1126,7 +1114,7 @@
 				mmp.mapImage = null; mapImage1to1 = mmp.mapImage;
 			}
 			addOverlaySet();
-			updateOnlyPosition(lat, lon, false);
+			updateOnlyPosition(where, false);
 			inf.close(0);
 			Vm.showWait(false);
 			(new MessageBox("Error", "Could not load map: "+ newmap.getImageFilename(), MessageBox.OKB)).execute();
@@ -1138,7 +1126,7 @@
 				mmp.mapImage = null; mapImage1to1 = mmp.mapImage;
 			}
 			addOverlaySet();
-			updateOnlyPosition(lat, lon, false);
+			updateOnlyPosition(where, false);
 			inf.close(0);
 			Vm.showWait(false);
 			(new MessageBox("Error", "Not enough memory to load map: "+ newmap.getImageFilename()+"\nYou can try to close\n all prgrams and \nrestart CacheWolf", MessageBox.OKB)).execute();
@@ -1150,7 +1138,7 @@
 				mmp.mapImage = null; mapImage1to1 = mmp.mapImage;
 			}
 			addOverlaySet();
-			updateOnlyPosition(lat, lon, false); // TODO this doesn't work correctly if the resolution changed, I guess because the pixels of PosCircle will be interpreted from the new resolution, but should be interpreted using the old resolution to test: select a map with a much greater value of m per pixel manually 
+			updateOnlyPosition(where, false); // TODO this doesn't work correctly if the resolution changed, I guess because the pixels of PosCircle will be interpreted from the new resolution, but should be interpreted using the old resolution to test: select a map with a much greater value of m per pixel manually 
 			inf.close(0);
 			Vm.showWait(false);
 			(new MessageBox("Error", "Not enough ressources to load map: "+ newmap.getImageFilename()+"\nYou can try to close\n all prgrams and \nrestart CacheWolf", MessageBox.OKB)).execute();
@@ -1484,7 +1472,7 @@
 	public void doPaint(Graphics g,Rect area) {
 		super.doPaint(g, area);
 		if (mm.gotoPos != null) {
-			Point dest = mm.getXYonScreen(mm.gotoPos.lat, mm.gotoPos.lon);
+			Point dest = mm.getXYonScreen(mm.gotoPos.where);
 			g.setPen(new Pen(Color.DarkBlue, Pen.SOLID, 3));
 			g.drawLine(mm.posCircleX, mm.posCircleY, dest.x, dest.y);
 		}
@@ -1498,14 +1486,14 @@
 		if(l.execute() == FormBase.IDOK){
 //			Vm.debug("Trying map: " + l.selectedMap.fileName);
 			mm.autoSelectMap = false;
-			if (l.selectedMap.isInBound(mm.posCircleLat, mm.posCircleLon) || l.selectedMap.getImageFilename().length()==0) {
-				mm.setMap(l.selectedMap, mm.posCircleLat, mm.posCircleLon);
+			if (l.selectedMap.isInBound(mm.posCircle.where) || l.selectedMap.getImageFilename().length()==0) {
+				mm.setMap(l.selectedMap, mm.posCircle.where);
 				mm.setResModus(MovingMap.NORMAL_KEEP_RESOLUTION);
 				mm.ignoreGps = false;
 			} else {
 				mm.setGpsStatus(MovingMap.noGPS);
 				mm.ignoreGps = true;
-				mm.setMap(l.selectedMap, mm.posCircleLat, mm.posCircleLon); 
+				mm.setMap(l.selectedMap, mm.posCircle.where); 
 				if (mm.currentMap.fileNameWFL.length() > 0)
 					mm.setCenterOfScreen(l.selectedMap.center, true); // if map has an image
 				mm.setResModus(MovingMap.NORMAL_KEEP_RESOLUTION);
@@ -1641,7 +1629,7 @@
 							fc.setTitle((String)MyLocale.getMsg(4200,"Select map directory:"));
 							if(fc.execute() != FileChooser.IDCANCEL){
 								Global.getPref().saveCustomMapsPath(fc.getChosen().toString());
-								mm.loadMaps(Global.getPref().getMapLoadPath(), mm.posCircleLat);
+								mm.loadMaps(Global.getPref().getMapLoadPath(), mm.posCircle.where.latDec);
 								mm.forceMapLoad();
 							}
 						}
@@ -1688,7 +1676,7 @@
 						}
 						if (action == moveToDestMI) {
 							mapsMenu.close();
-							mm.setCenterOfScreen(new CWPoint(mm.gotoPos.lat, mm.gotoPos.lon), true);
+							mm.setCenterOfScreen(mm.gotoPos.where, true);
 						}
 						if (action == moveToGpsMI) {
 							mapsMenu.close();

Modified: trunk/src/CacheWolf/navi/TrackOverlay.java
===================================================================
--- trunk/src/CacheWolf/navi/TrackOverlay.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/TrackOverlay.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -165,9 +165,7 @@
 
 	public TrackPoint calcLatLonInImage (double x, double y) {
 		// see trans.calcLatLon(p);
-		TrackPoint ll = new TrackPoint(); 
-		ll.latDec = (double)x * trans.affine[0] + (double)y * trans.affine[2] + topLeft.latDec;
-		ll.lonDec = (double)x * trans.affine[1] + (double)y * trans.affine[3] + topLeft.lonDec;
+		TrackPoint ll = new TrackPoint(trans.calcLatLon((int)x, (int)y)); 
 		return ll;
 	}
 

Modified: trunk/src/CacheWolf/navi/TrackPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/TrackPoint.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/TrackPoint.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -33,6 +33,15 @@
 	public boolean equals(TrackPoint tp) {
 		return latDec == tp.latDec && lonDec == tp.lonDec;
 	}
+	
+	/**
+	 * Returns true if the coordinates are valid
+	 */
+	public boolean isValid() {
+		return 	latDec <= 90.0 && latDec >= -90.0 &&
+				lonDec <= 360 && lonDec >= -360;
+	}
 
+
 }
 

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -110,14 +110,14 @@
 	 * @return
 	 */
 	public static CWPoint germanGkToWgs84(GkPoint gk) {
-/*		if (gk.northing <= 6089288.064 && gk.northing >= 5585291.767 && // these coordinates are transformed ones from the invers routine
+		if (gk.northing <= 6089288.064 && gk.northing >= 5585291.767 && // these coordinates are transformed ones from the invers routine
 				( gk.getStripe() == 4 && gk.getGkEasting() >= 4404124.247 && gk.getGkEasting() <= 4679300.398) ||
 				( gk.getStripe() == 5 && gk.getGkEasting() >= 5211904.597 && gk.getGkEasting() <= 5466056.603)
 			) return gkToWgs84(gk, GK_GERMANY_2001);
 		if (gk.northing <= 6097247.910 && gk.northing >= 5800464.725 )return gkToWgs84(gk, GK_NORD_GERMANY);
 		if (gk.northing <= 5800464.725 && gk.northing >= 5577963.555 )return gkToWgs84(gk, GK_NORD_GERMANY);
 		if (gk.northing <= 5577963.555 && gk.northing >= 5207294.028 )return gkToWgs84(gk, GK_NORD_GERMANY);
-	*/	return  gkToWgs84(gk, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
+		return  gkToWgs84(gk, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
 	}
 
 	/**
@@ -134,12 +134,12 @@
 		return  wgs84ToGk(ll, getGermanGkTransformParameters(ll)); 	
 	}
 	
-	public static TransformParameters getGermanGkTransformParameters(CWPoint ll) {
-	/*	if (FORMER_GDR.isInBound(ll)) return GK_GERMANY_2001; // exlcude former GDR from the splitting germany in north/middel/south
+	public static TransformParameters getGermanGkTransformParameters(TrackPoint ll) {
+		if (FORMER_GDR.isInBound(ll)) return GK_GERMANY_2001; // exlcude former GDR from the splitting germany in north/middel/south
 		if (ll.latDec <= 55 && ll.latDec >= 52.33333334 ) return  GK_NORD_GERMANY;
 		if (ll.latDec <= 52.33333334  && ll.latDec >= 50.33333334 ) return  GK_MID_GERMANY;
 		if (ll.latDec <= 50.33333334  && ll.latDec >= 47) return  GK_MID_GERMANY;
-	*/	return GK_GERMANY_2001;
+		return GK_GERMANY_2001;
 	}
 	
 	/**
@@ -181,7 +181,7 @@
 	 * @param stripe stripe to force to, otherwise -1 will determine the stripe automatically
 	 * @return
 	 */ // TODO find out what about the Krassowski in former GDR?
-	public static GkPoint wgs84ToGk(CWPoint ll, TransformParameters gk2wgs84, int stripe, int stripewidth) {
+	public static GkPoint wgs84ToGk(TrackPoint ll, TransformParameters gk2wgs84, int stripe, int stripewidth) {
 		XyzCoordinates wgsxyz = latLon2xyz(ll, 0, WGS84);
 		XyzCoordinates gkxyz = transform(wgsxyz, new TransformParameters(gk2wgs84, true));
 		CWPoint gkll = xyz2Latlon(gkxyz, BESSEL);
@@ -211,7 +211,7 @@
 	 * @return
 	 * @throws IllegalArgumentException if EPSG code is not german GK or unsupported
 	 */
-	public static GkPoint wgs84ToGermanGk(CWPoint wgs84, int epsgcode) throws IllegalArgumentException {
+	public static GkPoint wgs84ToGermanGk(TrackPoint wgs84, int epsgcode) throws IllegalArgumentException {
 		return wgs84ToGk(wgs84, getGermanGkTransformParameters(wgs84), getGermanGkStripeEpsg(epsgcode), 3);
 	}
 	
@@ -227,7 +227,7 @@
 		return stripe; 
 	}
 	
-	private static XyzCoordinates latLon2xyz(CWPoint ll, double alt, Ellipsoid ellipsoid) {
+	private static XyzCoordinates latLon2xyz(TrackPoint ll, double alt, Ellipsoid ellipsoid) {
 		if (!ll.isValid()) throw new IllegalArgumentException("latLon2xyz: invalid lat-lon");
 		double e2 = (ellipsoid.a * ellipsoid.a - ellipsoid.b * ellipsoid.b)/(ellipsoid.a * ellipsoid.a);
 		double N = ellipsoid.a/ Math.sqrt(1 - e2 * Math.pow(Math.sin(ll.latDec / 180*Math.PI), 2));
@@ -379,13 +379,6 @@
 	}
 }
 
-class Ellipsoid {
-	public double a, b;
-	public Ellipsoid(double ai, double bi) {
-		a = ai;
-		b = bi;
-	}
-}
 
 class TransformParameters {
 	// shift parameter in meter

Added: trunk/src/CacheWolf/navi/TransformCoordinatesProperties.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinatesProperties.java	2007-11-15 19:22:56 UTC (rev 1066)
+++ trunk/src/CacheWolf/navi/TransformCoordinatesProperties.java	2007-11-16 18:32:23 UTC (rev 1067)
@@ -0,0 +1,74 @@
+package CacheWolf.navi;
+
+import ewe.io.IOException;
+import ewe.io.InputStream;
+import ewe.sys.Convert;
+import ewe.util.Properties;
+import CacheWolf.CWPoint;
+
+public class TransformCoordinatesProperties extends Properties {
+	public int epsgCode;
+	
+	public TransformCoordinatesProperties(InputStream is) throws IOException {
+		super();
+		load(is);
+		epsgCode = Convert.toInt(getProperty("EpsgCode", "-1"));
+		if (epsgCode == -1) throw new IllegalArgumentException("EPSG code missing in: " + is.getName());
+	}
+	
+	public TransformCoordinatesProperties(int epsgcodei) {
+		if (!TransformCoordinates.isSupported(epsgcodei)) throw new IllegalArgumentException("EPSG code " + epsgcodei + "not supported");
+		epsgCode = epsgcodei;
+	}
+
+	/**
+	 * return ll transformed into the desired coordinate reference system
+	 * if the prjection is Gau?-Kr?ger, easting will be put in lonDec and
+	 * northing in latDec
+	 * @param ll
+	 * @return
+	 */
+	public static TrackPoint fromWgs84(TrackPoint ll, int epsgCode) {
+		TrackPoint ret;
+		switch (epsgCode) {
+		case TransformCoordinates.EPSG_WGS84:
+		case TransformCoordinates.EPSG_ETRS89:
+			ret = ll;
+			break;
+		case TransformCoordinates.EPSG_GK2:
+		case TransformCoordinates.EPSG_GK3:
+		case TransformCoordinates.EPSG_GK4:
+		case TransformCoordinates.EPSG_GK5:
+			GkPoint xy = TransformCoordinates.wgs84ToGermanGk(ll, epsgCode);
+			ret = new CWPoint(xy.northing, xy.getGkEasting());
+			break;
+		default: throw new IllegalArgumentException("fromWgs84: EPSG code " + epsgCode + "not supported");
+		}
+		return ret;
+	}
+
+	/**
+	 * convert any supported coordinate reference system WGS84
+	 * if p is a Gau?-Kr?ger point, put latdec = northing, londec = easting 
+	 * @param p
+	 * @return
+	 */
+	public static CWPoint toWgs84(CWPoint p, int epsgCode) {
+		CWPoint ret;
+		switch (epsgCode) {
+		case TransformCoordinates.EPSG_WGS84:
+		case TransformCoordinates.EPSG_ETRS89:
+			ret = p;
+			break;
+		case TransformCoordinates.EPSG_GK2:
+		case TransformCoordinates.EPSG_GK3:
+		case TransformCoordinates.EPSG_GK4:
+		case TransformCoordinates.EPSG_GK5:
+			GkPoint xy = new GkPoint(p.lonDec, p.latDec);
+			ret = TransformCoordinates.germanGkToWgs84(xy);
+			break;
+		default: throw new IllegalArgumentException("ToWgs84: EPSG code " + epsgCode + "not supported");
+		}
+		return ret;
+	}
+}
\ No newline at end of file



From pfeffer at mail.berlios.de  Fri Nov 16 19:36:59 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 16 Nov 2007 19:36:59 +0100
Subject: [Cachewolf-svn] r1068 - trunk/res_noewe
Message-ID: <200711161836.lAGIaxOL011461@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-16 19:36:57 +0100 (Fri, 16 Nov 2007)
New Revision: 1068

Modified:
   trunk/res_noewe/de-nrw_topo_25.wms
   trunk/res_noewe/readme_wms.txt
Log:
WMS: small changes in the explantion

Modified: trunk/res_noewe/de-nrw_topo_25.wms
===================================================================
--- trunk/res_noewe/de-nrw_topo_25.wms	2007-11-16 18:32:23 UTC (rev 1067)
+++ trunk/res_noewe/de-nrw_topo_25.wms	2007-11-16 18:36:57 UTC (rev 1068)
@@ -1,6 +1,7 @@
 # For an example and explantion please see readme_wms.txt, which
 # you can find in the program directory of CacheWolf. There
 # you always get the newest information about .wms format.
+# plaese include this hint in any .wms you create
 #
 # Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
 # and fill in accordingly in any .wms file you make. They
@@ -8,10 +9,8 @@
 # for someone who wants to make his own changes to your file.
 # 
 TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS	
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 GetCapabilitiesUrl:	http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:   de.nrw Topo 25
+Name:   de.nrw topo 25
 MapType:	topo
 MainUrl:   http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/TK25?
 ServiceTypeUrlPart:	SERVICE=WMS
@@ -25,6 +24,8 @@
 BoundingBoxTopLeftWGS84:	N 52.7691 E 05.673
 BoundingBoxButtomRightWGS84:	N 49.9944 E 010.142
 MinScale:   0.0
-MaxScale:   11.667
+# the hintscale delivered from the getCapilibitiesUrl is a little bit higher (11.667) but this leads sometimes to empty maps
+# I tested that 11.0485 is probably the real MaxScale
+MaxScale:   11.0485
 RecommendedScale:	3
 ImageFileExtension:	.png

Modified: trunk/res_noewe/readme_wms.txt
===================================================================
--- trunk/res_noewe/readme_wms.txt	2007-11-16 18:32:23 UTC (rev 1067)
+++ trunk/res_noewe/readme_wms.txt	2007-11-16 18:36:57 UTC (rev 1068)
@@ -6,6 +6,7 @@
 # e.g. "de-ni_topo_25", meaning germany (de), Niedersachen (ni), topographical map, original scale 1:50000.
 # Please don't use capital letter or special characters (only "a-z0-9" and "-_" are allowed) 
 # in the filename in order to avoid problems on different platforms
+# Please include in every .wms you create a reference to this explanation file
 #
 # For a list of WMS Services available in Germany see: http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 # This example is made up from there "Digitales Orthophoto" under section "Nordrhein-Westfalen"



From pfeffer at mail.berlios.de  Fri Nov 16 20:43:38 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 16 Nov 2007 20:43:38 +0100
Subject: [Cachewolf-svn] r1069 - trunk/src/CacheWolf/navi
Message-ID: <200711161943.lAGJhcmV015454@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-16 20:43:28 +0100 (Fri, 16 Nov 2007)
New Revision: 1069

Modified:
   trunk/src/CacheWolf/navi/MapLoader.java
Log:
WMS: removed unused code

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-16 18:36:57 UTC (rev 1068)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-16 19:43:28 UTC (rev 1069)
@@ -193,33 +193,6 @@
 		progressInfobox = progrssInfoboxi;
 	}
 
-	/*
-	public static String createExpediaFilename(double lat, double lon, int alti) {
-		Double latD = new Double(), lonD = new Double();
-		latD.decimalPlaces = 4;
-		lonD.decimalPlaces = 4;
-		latD.set(lat);
-		lonD.set(lon);
-		return "expedia_alti"+alti+"_lat"+latD.toString().replace(',', '.')+"_lon"+lonD.toString().replace(',', '.')+".gif";
-	}
-	public void downloadMap(double lat, double lon, int alti, int PixelWidth, int PixelHeight, String path){
-		loadTo(lat, lon, alti, PixelWidth, PixelHeight, path+"/"+createExpediaFilename(lat, lon, alti));
-	}
-	 */
-
-	public void downloadMap(Area surArea, Point pixelsize, String path){
-		try {
-			MapInfoObject mio = currentOnlineMapService.getMapInfoObject(surArea, pixelsize);
-			String filename = createFilename(mio.getCenter(), mio.scale);
-			String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
-			String url = currentOnlineMapService.getUrlForBoundingBox(surArea, pixelsize);
-			downloadImage(url, path+"/"+imagename);
-			mio.saveWFL();
-		} catch (Exception e) {
-			this.progressInfobox.addWarning("Ignoring error during map download, saving or calibration:\n" + e.getMessage()+"\n");
-		}
-	}
-
 	public void downloadMap(CWPoint center, float scale, Point pixelsize, String path) throws Exception {
 		MapInfoObject mio = currentOnlineMapService.getMapInfoObject(center, scale, pixelsize);
 		String filename = createFilename(mio.getCenter(), mio.scale);
@@ -341,7 +314,7 @@
 	}
 	/**
 	 * Overload this and return the URL to the map image, don't call super
-	 * Alternatively overload getUrlForBoundingBox
+	 * Alternatively overload getUrlForBoundingBoxInternal
 	 * You must overload either this method or getUrlForBoundingBox
 	 * @param center
 	 * @param scale
@@ -350,28 +323,30 @@
 	 */
 	public String getUrlForCenterScale(CWPoint center, float scale, Point pixelsize) {
 		Area bbox = CenterScaleToArea(center, scale, pixelsize);
-		String url = getUrlForBoundingBox(bbox, pixelsize);
+		String url = getUrlForBoundingBoxInternal(bbox, pixelsize);
 		return url;
 	}
 
-	public String getUrlForBoundingBox(Area surArea, Point pixelsize) {
-		CWPoint center = new CWPoint((surArea.topleft.latDec + surArea.buttomright.latDec)/2, (surArea.topleft.lonDec + surArea.buttomright.lonDec)/2);
-		double radiuslat = (new CWPoint(center.latDec, surArea.buttomright.lonDec)).getDistance(surArea.buttomright);
-		double radiuslon = (new CWPoint(surArea.buttomright.latDec, center.lonDec)).getDistance(surArea.buttomright);
-		float radius, scale;
-		if (radiuslat <= radiuslon) {
-			radius = (float) radiuslon;
-			scale = (float) (radiuslon / (double) pixelsize.x);
-		} else {
-			radius = (float) radiuslat;
-			scale = (float) (radiuslat / (double) pixelsize.y);
-		}
-		String ret = getUrlForCenterScale(center, scale, pixelsize);
-		//int expediaAlti = ((ExpediaMapService)currentOnlineMapService).getZoomlevel(center, radius * 1000, pixelsize);
-		return ret;
-		//throw new IllegalArgumentException("OnlineMapService: getUrlForBoundingBox:\n This method must be overloaded in order to be able to use it");
+	/**
+	 * This is made protected and named "...Internal" because a lot of services
+	 * don't work correctly when a map is requested, that is not exactly quadratic
+	 * --> alway use getUrlForCenter...
+	 * @param surArea
+	 * @param pixelsize
+	 * @return
+	 */
+	protected String getUrlForBoundingBoxInternal(Area surArea, Point pixelsize) {
+		return null;
 	}
 
+	/**
+	 * overload this if your map service uses a special projection
+	 * an return an Area that is quadratic in that projection
+	 * @param center
+	 * @param scale
+	 * @param pixelsize
+	 * @return
+	 */
 	public Area CenterScaleToArea(CWPoint center, float scale, Point pixelsize) {
 		Area bbox = new Area();
 		double halfdiagonal = Math.sqrt(pixelsize.x * pixelsize.x + pixelsize.y * pixelsize.y)/2 * scale / 1000;
@@ -379,13 +354,21 @@
 		bbox.buttomright = center.project(135, halfdiagonal);
 		return bbox;
 	}
-	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
-		throw new IllegalArgumentException("OnlineMapService: getMapInfoObject(Area maparea, Point pixelsize):\n This method must be overloaded in order to be able to use it");
-	}
 
+	
+	protected MapInfoObject getMapInfoObjectInternal(Area maparea, Point pixelsize) {
+		throw new IllegalArgumentException("OnlineMapService: getMapInfoObjectInternal(Area maparea, Point pixelsize):\n This method must be overloaded in order to be able to use it");
+	}
+	
+	/**
+	 * Overload this (don't call super()) or alternatively overload getMapInfoObjectInternal
+	 * @param center
+	 * @param scale
+	 * @param pixelsize
+	 * @return
+	 */
 	public MapInfoObject getMapInfoObject(CWPoint center, float scale, Point pixelsize) {
-		return getMapInfoObject(CenterScaleToArea(center, scale, pixelsize), pixelsize);
-		//throw new IllegalArgumentException("OnlineMapService: (CWPoint center, double zoomlevel, Point pixelsize):\n This method must be overloaded in order to be able to use it");
+		return getMapInfoObjectInternal(CenterScaleToArea(center, scale, pixelsize), pixelsize);
 	}
 
 	public String toString() {
@@ -498,7 +481,7 @@
 		return bbox;
 	}
 
-	public String getUrlForBoundingBox(Area maparea, Point pixelsize) {
+	protected String getUrlForBoundingBoxInternal(Area maparea, Point pixelsize) {
 		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + " not covered by service: " + name + ", service area: " + boundingBox.toString());
 		// http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS&VERSION=1.1.0&REQUEST=GetMap&SRS=EPSG:31466&BBOX=2577567.0149,5607721.7566,2578567.0077,5608721.7602&WIDTH=500&HEIGHT=500&LAYERS=Raster:TK25_KMF:Farbkombination&STYLES=&FORMAT=image/png
 		CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
@@ -545,7 +528,7 @@
 		return crs;
 	}
 
-	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
+	protected MapInfoObject getMapInfoObjectInternal(Area maparea, Point pixelsize) {
 		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException("area: " + maparea.toString() + " not covered by service: " + name + ", service area: " + boundingBox.toString());
 		Vector georef = new Vector(4);
 



From pfeffer at mail.berlios.de  Fri Nov 16 21:17:45 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 16 Nov 2007 21:17:45 +0100
Subject: [Cachewolf-svn] r1070 - trunk/res_noewe
Message-ID: <200711162017.lAGKHjkq018061@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-16 21:17:42 +0100 (Fri, 16 Nov 2007)
New Revision: 1070

Added:
   trunk/res_noewe/de_topo_200.wms
Modified:
   trunk/res_noewe/de-by_topo_50.wms
   trunk/res_noewe/de-nrw_topo_25.wms
Log:
WMS: new .wms: TK 200 germany
WMS: small changes in some .wms

Modified: trunk/res_noewe/de-by_topo_50.wms
===================================================================
--- trunk/res_noewe/de-by_topo_50.wms	2007-11-16 19:43:28 UTC (rev 1069)
+++ trunk/res_noewe/de-by_topo_50.wms	2007-11-16 20:17:42 UTC (rev 1070)
@@ -1,19 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
 TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 GetCapabilitiesUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.by Topo 50
+Name:	de.by topo 50
 MapType:	topo
 MainUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?
 ServiceTypeUrlPart:	SERVICE=WMS 
 VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:	31468 
+CoordinateReferenceSystemCacheWolf: 31468 
 CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
 RequestUrlPart:	REQUEST=GetMap
 LayersUrlPart:	LAYERS=TK50
 StylesUrlPart:	STYLES=
 ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 50.6100606 E 9.1024741
-BoundingBoxButtomRightWGS84:	N 47.0828299 E 13.9781535
-MinScale:	0.01
-MaxScale:	40
+BoundingBoxTopLeftWGS84:	N 50.6269 E 8.89292
+BoundingBoxButtomRightWGS84:	N 47.0828 E 13.9782
+MinScale:	0.997806
+MaxScale:	24.9451
 RecommendedScale:	5.0
 ImageFileExtension: .png

Modified: trunk/res_noewe/de-nrw_topo_25.wms
===================================================================
--- trunk/res_noewe/de-nrw_topo_25.wms	2007-11-16 19:43:28 UTC (rev 1069)
+++ trunk/res_noewe/de-nrw_topo_25.wms	2007-11-16 20:17:42 UTC (rev 1070)
@@ -12,7 +12,7 @@
 GetCapabilitiesUrl:	http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
 Name:   de.nrw topo 25
 MapType:	topo
-MainUrl:   http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/TK25?
+MainUrl:	http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/TK25?
 ServiceTypeUrlPart:	SERVICE=WMS
 VersionUrlPart:	VERSION=1.1.1
 CoordinateReferenceSystemCacheWolf:	31466 31467

Added: trunk/res_noewe/de_topo_200.wms
===================================================================
--- trunk/res_noewe/de_topo_200.wms	2007-11-16 19:43:28 UTC (rev 1069)
+++ trunk/res_noewe/de_topo_200.wms	2007-11-16 20:17:42 UTC (rev 1070)
@@ -0,0 +1,30 @@
+# For an example and explantion please see readme_wms.txt, which
+# you can find in the program directory of CacheWolf. There
+# you always get the newest information about .wms format.
+# plaese include this hint in any .wms you create
+#
+# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
+# and fill in accordingly in any .wms file you make. They
+# are (still) not used by CacheWolf but they are usefull
+# for someone who wants to make his own changes to your file.
+# 
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&service=WMS&version=1.1.1&request=GetCapabilities
+Name:	de topo 200
+MainUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&
+MapType: 
+ServiceTypeUrlPart:	SERVICE=WMS
+VersionUrlPart:	VERSION=1.1.0
+CoordinateReferenceSystemCacheWolf:	31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DTK200-V
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 55.0960681 E 6.07358734
+BoundingBoxButtomRightWGS84:	N 47.161701 E 16.05521058
+# there is no scale hint in the getCapabilities answer :-( --> allow all
+#MinScale:	0.01
+#MaxScale:	40
+RecommendedScale:	15
+ImageFileExtension: .png
\ No newline at end of file



From mik77 at mail.berlios.de  Fri Nov 16 23:13:27 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Fri, 16 Nov 2007 23:13:27 +0100
Subject: [Cachewolf-svn] r1071 - trunk/res_noewe
Message-ID: <200711162213.lAGMDR9e026866@sheep.berlios.de>

Author: mik77
Date: 2007-11-16 23:13:18 +0100 (Fri, 16 Nov 2007)
New Revision: 1071

Added:
   trunk/res_noewe/de-rlp_topo_50.wms
Log:
WMS for TK50 RLP added

Added: trunk/res_noewe/de-rlp_topo_50.wms
===================================================================
--- trunk/res_noewe/de-rlp_topo_50.wms	2007-11-16 20:17:42 UTC (rev 1070)
+++ trunk/res_noewe/de-rlp_topo_50.wms	2007-11-16 22:13:18 UTC (rev 1071)
@@ -0,0 +1,20 @@
+# please refer to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.rlp topo 50
+MapType:	topo
+MainUrl:	http://geodaten.service24.rlp.de/cgi/wms.cgi?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:   31466 31467
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:   REQUEST=GetMap
+LayersUrlPart:   LAYERS=rlp%3Atk50
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
+BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
+MinScale:   7.001
+MaxScale:   15.0
+RecommendedScale:	5.0
+ImageFileExtension: .png 
\ No newline at end of file



From salzkammergut at mail.berlios.de  Sat Nov 17 19:56:13 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sat, 17 Nov 2007 19:56:13 +0100
Subject: [Cachewolf-svn] r1072 - trunk/src/CacheWolf
Message-ID: <200711171856.lAHIuD7h021274@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-17 19:56:08 +0100 (Sat, 17 Nov 2007)
New Revision: 1072

Modified:
   trunk/src/CacheWolf/SpiderGC.java
Log:
SpiderGX: Fix for bug with space in username or password (intruduced in Rev 1051)

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-11-16 22:13:18 UTC (rev 1071)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-11-17 18:56:08 UTC (rev 1072)
@@ -1309,8 +1309,7 @@
 		char d = 0;
 		for (int i = 0; i<max; i++){
 			char c = (char) what[i];
-			if (c == ' ') c = '+';
-			else if (c <= ' ' || c == '+' || c == '&' || c == '%' || c == '=' ||
+			if (c <= ' ' || c == '+' || c == '&' || c == '%' || c == '=' ||
 				   c == '|' || c == '{' || c == '}' || c>0x7f ){
 					dest[d++] = '%';
 					dest[d++] = hex.charAt((c >> 4) & 0xf);



From salzkammergut at mail.berlios.de  Sat Nov 17 22:09:16 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sat, 17 Nov 2007 22:09:16 +0100
Subject: [Cachewolf-svn] r1073 - trunk/src/CacheWolf
Message-ID: <200711172109.lAHL9GgI027222@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-17 22:09:13 +0100 (Sat, 17 Nov 2007)
New Revision: 1073

Modified:
   trunk/src/CacheWolf/Preferences.java
Log:
Preferences: Added initialisation of listColMap and listColWidth (should have been in Rev 1052).

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-17 18:56:08 UTC (rev 1072)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-17 21:09:13 UTC (rev 1073)
@@ -99,9 +99,9 @@
 	/** True if the SIP is always visible */
 	public boolean fixSIP = false;
 	/** The list of visible columns in the list view */
-	public String listColMap="0,1,2,3,4,5,6,7,8,9,10,11";
+	public String listColMap="0,1,2,3,4,5,6,7,8,9,10,11,12";
 	/** The widths for each column in list view */
-	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104";
+	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104,22";
 	/** The columns which are to be displayed in TravelbugsJourneyScreen. See also TravelbugJourney */
 	public String travelbugColMap="1,4,5,6,8,9,10,7";
 	/** The column widths for the travelbug journeys. */



From mik77 at mail.berlios.de  Sun Nov 18 01:42:47 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 18 Nov 2007 01:42:47 +0100
Subject: [Cachewolf-svn] r1074 - trunk/res_noewe
Message-ID: <200711180042.lAI0gluI024894@sheep.berlios.de>

Author: mik77
Date: 2007-11-18 01:42:37 +0100 (Sun, 18 Nov 2007)
New Revision: 1074

Added:
   trunk/res_noewe/de-bw_photo.wms
   trunk/res_noewe/de-bw_topo_50.wms
   trunk/res_noewe/de-by_photo.wms
Log:
new WMS: TK50 + DOP of BW; DOP of BY

Added: trunk/res_noewe/de-bw_photo.wms
===================================================================
--- trunk/res_noewe/de-bw_photo.wms	2007-11-17 21:09:13 UTC (rev 1073)
+++ trunk/res_noewe/de-bw_photo.wms	2007-11-18 00:42:37 UTC (rev 1074)
@@ -0,0 +1,19 @@
+TakenFromUrl:   http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:   http://www.lv-bw.de/dv/capabilities.xml?login=dv&pw=anonymous&REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:   de.bw Luftbild
+MapType:   photo
+MainUrl:   http://www.lv-bw.de/dv/service/getrds2.asp?login=dv&pw=anonymous&
+ServiceTypeUrlPart:   SERVICE=WMS
+VersionUrlPart:   VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:   31467
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31467
+RequestUrlPart:   REQUEST=GetMap
+LayersUrlPart:   LAYERS=DVDOP2
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 50.00 E 7.60
+BoundingBoxButtomRightWGS84:   N 47.40 E 10.00
+MinScale:   0.01
+MaxScale:   43
+RecommendedScale:   2.5
+ImageFileExtension: .png 
\ No newline at end of file

Added: trunk/res_noewe/de-bw_topo_50.wms
===================================================================
--- trunk/res_noewe/de-bw_topo_50.wms	2007-11-17 21:09:13 UTC (rev 1073)
+++ trunk/res_noewe/de-bw_topo_50.wms	2007-11-18 00:42:37 UTC (rev 1074)
@@ -0,0 +1,19 @@
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.lv-bw.de/dv/capabilities.xml?login=dv&pw=anonymous&REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.bw topo 50
+MapType:	topo
+MainUrl:	http://www.lv-bw.de/dv/service/getrds2.asp?login=dv&pw=anonymous&
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:	31467 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DVTK50K
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 50.00 E 7.60
+BoundingBoxButtomRightWGS84:	N 47.40 E 10.00
+MinScale:	0.01
+MaxScale:	40
+RecommendedScale:	5.0
+ImageFileExtension: .png

Added: trunk/res_noewe/de-by_photo.wms
===================================================================
--- trunk/res_noewe/de-by_photo.wms	2007-11-17 21:09:13 UTC (rev 1073)
+++ trunk/res_noewe/de-by_photo.wms	2007-11-18 00:42:37 UTC (rev 1074)
@@ -0,0 +1,20 @@
+# please refer to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.by Luftbild
+MapType:	photo
+MainUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DOP
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 50.6269 E 8.89292
+BoundingBoxButtomRightWGS84:	N 47.0828 E 13.9782
+MinScale:	2.82
+MaxScale:	200
+RecommendedScale:	2.0
+ImageFileExtension: .png



From pfeffer at mail.berlios.de  Sun Nov 18 13:59:15 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 18 Nov 2007 13:59:15 +0100
Subject: [Cachewolf-svn] r1075 - in trunk: res_noewe src/CacheWolf/navi
Message-ID: <200711181259.lAICxFNk030836@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-18 13:59:11 +0100 (Sun, 18 Nov 2007)
New Revision: 1075

Added:
   trunk/res_noewe/webmapservices/
Modified:
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/MapLoaderGui.java
Log:
WMS: moved the directory of .wms files to webmapservices

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-18 00:42:37 UTC (rev 1074)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-18 12:59:11 UTC (rev 1075)
@@ -29,8 +29,6 @@
 
 
 public class MapLoader {
-	String proxy = new String();
-	String port = new String();
 	InfoBox progressInfobox;
 
 	Vector onlineMapServices = new Vector();
@@ -50,9 +48,7 @@
 	 * @param prt
 	 * @param wmspath without trailing "/"
 	 */
-	public MapLoader(String prxy, String prt, String wmspath){
-		port = prt;
-		proxy = prxy;
+	public MapLoader(String wmspath){
 		progressInfobox = null;
 		onlineMapServices = new Vector();
 		String dateien[];

Modified: trunk/src/CacheWolf/navi/MapLoaderGui.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-18 00:42:37 UTC (rev 1074)
+++ trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-18 12:59:11 UTC (rev 1075)
@@ -66,7 +66,7 @@
 		pref = Global.getPref(); // myPreferences sollte sp?ter auch diese Einstellungen speichern
 		center = new CWPoint(pref.curCentrePt);
 		cacheDB = cacheDBi;
-		mapLoader = new MapLoader(Global.getPref().myproxy, Global.getPref().myproxyport, File.getProgramDirectory());
+		mapLoader = new MapLoader(File.getProgramDirectory()+"/"+"webmapservices");
 
 		// sort the items in the list of services in a way that services which cover the current center point.
 		unsortedMapServices = mapLoader.getAvailableOnlineMapServices();



From mik77 at mail.berlios.de  Sun Nov 18 14:29:04 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 18 Nov 2007 14:29:04 +0100
Subject: [Cachewolf-svn] r1076 - in trunk: . res_noewe
	res_noewe/webmapservices
Message-ID: <200711181329.lAIDT4FD000582@sheep.berlios.de>

Author: mik77
Date: 2007-11-18 14:28:42 +0100 (Sun, 18 Nov 2007)
New Revision: 1076

Added:
   trunk/res_noewe/webmapservices/de-bw_photo.wms
   trunk/res_noewe/webmapservices/de-bw_topo_50.wms
   trunk/res_noewe/webmapservices/de-by_photo.wms
   trunk/res_noewe/webmapservices/de-by_topo_50.wms
   trunk/res_noewe/webmapservices/de-he_topo_25.wms
   trunk/res_noewe/webmapservices/de-he_topo_50.wms
   trunk/res_noewe/webmapservices/de-nrw_photo.wms
   trunk/res_noewe/webmapservices/de-nrw_topo_10.wms
   trunk/res_noewe/webmapservices/de-nrw_topo_25.wms
   trunk/res_noewe/webmapservices/de-rlp_topo_50.wms
   trunk/res_noewe/webmapservices/de_topo_200.wms
Removed:
   trunk/res_noewe/de-bw_photo.wms
   trunk/res_noewe/de-bw_topo_50.wms
   trunk/res_noewe/de-by_photo.wms
   trunk/res_noewe/de-by_topo_50.wms
   trunk/res_noewe/de-he_topo_25.wms
   trunk/res_noewe/de-he_topo_50.wms
   trunk/res_noewe/de-nrw_photo.wms
   trunk/res_noewe/de-nrw_topo_10.wms
   trunk/res_noewe/de-nrw_topo_25.wms
   trunk/res_noewe/de-rlp_topo_50.wms
   trunk/res_noewe/de_topo_200.wms
Modified:
   trunk/getRes.bat
   trunk/getRes.sh
Log:
move wms files in subdirectory

Modified: trunk/getRes.bat
===================================================================
--- trunk/getRes.bat	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/getRes.bat	2007-11-18 13:28:42 UTC (rev 1076)
@@ -7,6 +7,9 @@
 REM get ressources
 copy .\resources\*.* .\work\*.*
 copy .\res_noewe\*.* .\work\*.*
+mkdir .\work\attributes
 copy .\resources\attributes\*.* .\work\attributes\*.*
+mkdir .\work\webmapservices
+copy .\res_noewe\webmapservices\*.* .\work\webmapservices\*.*
 copy .\lib\*.dll .\work\
 move .\work\cachewolf.Languages.cfg .\work\_config\

Modified: trunk/getRes.sh
===================================================================
--- trunk/getRes.sh	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/getRes.sh	2007-11-18 13:28:42 UTC (rev 1076)
@@ -9,4 +9,5 @@
 cp resources/*.* work
 cp res_noewe/*.* work
 cp resources/attributes/*.* work/attributes
+cp res_noewe/webmapservices/*.* work/webmapservices/*.*
 mv work/cachewolf.Languages.cfg work/_config/cachewolf.Languages.cfg

Deleted: trunk/res_noewe/de-bw_photo.wms
===================================================================
--- trunk/res_noewe/de-bw_photo.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-bw_photo.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,19 +0,0 @@
-TakenFromUrl:   http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:   http://www.lv-bw.de/dv/capabilities.xml?login=dv&pw=anonymous&REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:   de.bw Luftbild
-MapType:   photo
-MainUrl:   http://www.lv-bw.de/dv/service/getrds2.asp?login=dv&pw=anonymous&
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31467
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=DVDOP2
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.00 E 7.60
-BoundingBoxButtomRightWGS84:   N 47.40 E 10.00
-MinScale:   0.01
-MaxScale:   43
-RecommendedScale:   2.5
-ImageFileExtension: .png 
\ No newline at end of file

Deleted: trunk/res_noewe/de-bw_topo_50.wms
===================================================================
--- trunk/res_noewe/de-bw_topo_50.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-bw_topo_50.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,19 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.lv-bw.de/dv/capabilities.xml?login=dv&pw=anonymous&REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.bw topo 50
-MapType:	topo
-MainUrl:	http://www.lv-bw.de/dv/service/getrds2.asp?login=dv&pw=anonymous&
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:	31467 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=DVTK50K
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 50.00 E 7.60
-BoundingBoxButtomRightWGS84:	N 47.40 E 10.00
-MinScale:	0.01
-MaxScale:	40
-RecommendedScale:	5.0
-ImageFileExtension: .png

Deleted: trunk/res_noewe/de-by_photo.wms
===================================================================
--- trunk/res_noewe/de-by_photo.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-by_photo.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,20 +0,0 @@
-# please refer to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.by Luftbild
-MapType:	photo
-MainUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31468 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=DOP
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 50.6269 E 8.89292
-BoundingBoxButtomRightWGS84:	N 47.0828 E 13.9782
-MinScale:	2.82
-MaxScale:	200
-RecommendedScale:	2.0
-ImageFileExtension: .png

Deleted: trunk/res_noewe/de-by_topo_50.wms
===================================================================
--- trunk/res_noewe/de-by_topo_50.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-by_topo_50.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,20 +0,0 @@
-# please refere to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.by topo 50
-MapType:	topo
-MainUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31468 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=TK50
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 50.6269 E 8.89292
-BoundingBoxButtomRightWGS84:	N 47.0828 E 13.9782
-MinScale:	0.997806
-MaxScale:	24.9451
-RecommendedScale:	5.0
-ImageFileExtension: .png

Deleted: trunk/res_noewe/de-he_topo_25.wms
===================================================================
--- trunk/res_noewe/de-he_topo_25.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-he_topo_25.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.he Topo 25
-MapType:	topo
-MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=ATKPG25-N1
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 51.6697 E 7.69911
-BoundingBoxButtomRightWGS84:	N 49.3455 E 11.3986
-MinScale:	1.49671
-MaxScale:	49.8903
-RecommendedScale:	2.5
-ImageFileExtension: .png
-

Deleted: trunk/res_noewe/de-he_topo_50.wms
===================================================================
--- trunk/res_noewe/de-he_topo_50.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-he_topo_50.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,21 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.he Topo 50
-MapType:	topo
-MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-maps.plx?
-LayersName: 
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=ATKPG50-N1
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 51.6697 E 7.69911
-BoundingBoxButtomRightWGS84:	N 49.3455 E 11.3986
-MinScale:	1.49671
-MaxScale:	99.7806
-RecommendedScale:	5.0
-ImageFileExtension: .png
-

Deleted: trunk/res_noewe/de-nrw_photo.wms
===================================================================
--- trunk/res_noewe/de-nrw_photo.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-nrw_photo.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,30 +0,0 @@
-# For an example and explantion please see readme_wms.txt, which
-# you can find in the program directory of CacheWolf. There
-# you always get the newest information about .wms format.
-#
-# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
-# and fill in accordingly in any .wms file you make. They
-# are (still) not used by CacheWolf but they are usefull
-# for someone who wants to make his own changes to your file.
-# 
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS	
-#
-Name:	de.nrw Luftbild
-MainUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild? 
-MapType: photo
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.0 
-CoordinateReferenceSystemCacheWolf:	31466 31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 52.7691 E 5.673
-BoundingBoxButtomRightWGS84:	N 49.9944 E 10.142
-MinScale:	0.1795783591567183
-MaxScale:	5.611823723647454
-RecommendedScale:	0.5
-ImageFileExtension: .png
-

Deleted: trunk/res_noewe/de-nrw_topo_10.wms
===================================================================
--- trunk/res_noewe/de-nrw_topo_10.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-nrw_topo_10.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,28 +0,0 @@
-# For an example and explantion please see readme_wms.txt, which
-# you can find in the program directory of CacheWolf. There
-# you always get the newest information about .wms format.
-#
-# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
-# and fill in accordingly in any .wms file you make. They
-# are (still) not used by CacheWolf but they are usefull
-# for someone who wants to make his own changes to your file.
-# 
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/DTK10?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.1.0
-Name:   de.nrw Topo 10
-MapType:	topo
-MainUrl:   http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/DTK10?
-ServiceTypeUrlPart:	SERVICE=WMS
-VersionUrlPart:	VERSION=1.1.0
-CoordinateReferenceSystemCacheWolf:	31466 31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Raster%3ADTK10%3ADtk10G
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 52.7729742 E 5.672412
-BoundingBoxButtomRightWGS84:	N 49.998341 E 10.1417782
-MinScale:   0.0
-MaxScale:   14.001
-RecommendedScale:	1
-ImageFileExtension:	.png

Deleted: trunk/res_noewe/de-nrw_topo_25.wms
===================================================================
--- trunk/res_noewe/de-nrw_topo_25.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-nrw_topo_25.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,31 +0,0 @@
-# For an example and explantion please see readme_wms.txt, which
-# you can find in the program directory of CacheWolf. There
-# you always get the newest information about .wms format.
-# plaese include this hint in any .wms you create
-#
-# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
-# and fill in accordingly in any .wms file you make. They
-# are (still) not used by CacheWolf but they are usefull
-# for someone who wants to make his own changes to your file.
-# 
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:   de.nrw topo 25
-MapType:	topo
-MainUrl:	http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/TK25?
-ServiceTypeUrlPart:	SERVICE=WMS
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31466 31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Raster%3ATK25%5FKMF%3AFarbkombination
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 52.7691 E 05.673
-BoundingBoxButtomRightWGS84:	N 49.9944 E 010.142
-MinScale:   0.0
-# the hintscale delivered from the getCapilibitiesUrl is a little bit higher (11.667) but this leads sometimes to empty maps
-# I tested that 11.0485 is probably the real MaxScale
-MaxScale:   11.0485
-RecommendedScale:	3
-ImageFileExtension:	.png

Deleted: trunk/res_noewe/de-rlp_topo_50.wms
===================================================================
--- trunk/res_noewe/de-rlp_topo_50.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de-rlp_topo_50.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,20 +0,0 @@
-# please refer to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.rlp topo 50
-MapType:	topo
-MainUrl:	http://geodaten.service24.rlp.de/cgi/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=rlp%3Atk50
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   7.001
-MaxScale:   15.0
-RecommendedScale:	5.0
-ImageFileExtension: .png 
\ No newline at end of file

Deleted: trunk/res_noewe/de_topo_200.wms
===================================================================
--- trunk/res_noewe/de_topo_200.wms	2007-11-18 12:59:11 UTC (rev 1075)
+++ trunk/res_noewe/de_topo_200.wms	2007-11-18 13:28:42 UTC (rev 1076)
@@ -1,30 +0,0 @@
-# For an example and explantion please see readme_wms.txt, which
-# you can find in the program directory of CacheWolf. There
-# you always get the newest information about .wms format.
-# plaese include this hint in any .wms you create
-#
-# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
-# and fill in accordingly in any .wms file you make. They
-# are (still) not used by CacheWolf but they are usefull
-# for someone who wants to make his own changes to your file.
-# 
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de topo 200
-MainUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&
-MapType: 
-ServiceTypeUrlPart:	SERVICE=WMS
-VersionUrlPart:	VERSION=1.1.0
-CoordinateReferenceSystemCacheWolf:	31468 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=DTK200-V
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 55.0960681 E 6.07358734
-BoundingBoxButtomRightWGS84:	N 47.161701 E 16.05521058
-# there is no scale hint in the getCapabilities answer :-( --> allow all
-#MinScale:	0.01
-#MaxScale:	40
-RecommendedScale:	15
-ImageFileExtension: .png
\ No newline at end of file

Copied: trunk/res_noewe/webmapservices/de-bw_photo.wms (from rev 1075, trunk/res_noewe/de-bw_photo.wms)

Copied: trunk/res_noewe/webmapservices/de-bw_topo_50.wms (from rev 1075, trunk/res_noewe/de-bw_topo_50.wms)

Copied: trunk/res_noewe/webmapservices/de-by_photo.wms (from rev 1075, trunk/res_noewe/de-by_photo.wms)

Copied: trunk/res_noewe/webmapservices/de-by_topo_50.wms (from rev 1075, trunk/res_noewe/de-by_topo_50.wms)

Copied: trunk/res_noewe/webmapservices/de-he_topo_25.wms (from rev 1075, trunk/res_noewe/de-he_topo_25.wms)

Copied: trunk/res_noewe/webmapservices/de-he_topo_50.wms (from rev 1075, trunk/res_noewe/de-he_topo_50.wms)

Copied: trunk/res_noewe/webmapservices/de-nrw_photo.wms (from rev 1075, trunk/res_noewe/de-nrw_photo.wms)

Copied: trunk/res_noewe/webmapservices/de-nrw_topo_10.wms (from rev 1075, trunk/res_noewe/de-nrw_topo_10.wms)

Copied: trunk/res_noewe/webmapservices/de-nrw_topo_25.wms (from rev 1075, trunk/res_noewe/de-nrw_topo_25.wms)

Copied: trunk/res_noewe/webmapservices/de-rlp_topo_50.wms (from rev 1075, trunk/res_noewe/de-rlp_topo_50.wms)

Copied: trunk/res_noewe/webmapservices/de_topo_200.wms (from rev 1075, trunk/res_noewe/de_topo_200.wms)



From mik77 at mail.berlios.de  Sun Nov 18 14:34:44 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 18 Nov 2007 14:34:44 +0100
Subject: [Cachewolf-svn] r1077 - trunk
Message-ID: <200711181334.lAIDYiYm000955@sheep.berlios.de>

Author: mik77
Date: 2007-11-18 14:34:37 +0100 (Sun, 18 Nov 2007)
New Revision: 1077

Modified:
   trunk/fwrtsnapshot.sh
Log:
NB-script modified for WMS subfolder

Modified: trunk/fwrtsnapshot.sh
===================================================================
--- trunk/fwrtsnapshot.sh	2007-11-18 13:28:42 UTC (rev 1076)
+++ trunk/fwrtsnapshot.sh	2007-11-18 13:34:37 UTC (rev 1077)
@@ -15,14 +15,17 @@
 	exit 1
 fi
 mkdir -p published/dat/attributes
+mkdir -p published/dat/webmapservices
 mv programs/CacheWolf/* published/
 chmod 755 published/*
 chmod 644 published/*/*
 chmod 755 published/dat/attributes
+chmod 755 published/dat/webmapservices
 printf '1,$g/ 12M/s///\nwq\n' | ed -s published/Jar/CacheWolf.bat
 install -c -m 644 work/CacheWolf.ewe published/
 install -c -m 644 res_noewe/* published/dat/
 install -c -m 644 resources/attributes-big/*.gif published/dat/attributes/
+install -c -m 644 res_noewe/webmapservices/* published/dat/webmapservices/
 (cd published/dat && find * -type f | sort | \
     /usr/local/bin/cpio -oC512 -Hustar -Mdist >../datfiles.tar)
 rm -rf published/dat



From pfeffer at mail.berlios.de  Sun Nov 18 15:20:30 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 18 Nov 2007 15:20:30 +0100
Subject: [Cachewolf-svn] r1078 - in trunk: res_noewe/webmapservices
	src/CacheWolf/navi
Message-ID: <200711181420.lAIEKUn1004347@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-18 15:20:19 +0100 (Sun, 18 Nov 2007)
New Revision: 1078

Modified:
   trunk/res_noewe/webmapservices/de-bw_topo_50.wms
   trunk/res_noewe/webmapservices/de-nrw_topo_25.wms
   trunk/res_noewe/webmapservices/de-rlp_topo_50.wms
   trunk/res_noewe/webmapservices/de_topo_200.wms
   trunk/src/CacheWolf/navi/MapLoader.java
Log:
WMS: now uses the filename of the .wms file in order to create an image filename instead of the friendly name of the service
WMS: friendly name now uniform

Modified: trunk/res_noewe/webmapservices/de-bw_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-bw_topo_50.wms	2007-11-18 13:34:37 UTC (rev 1077)
+++ trunk/res_noewe/webmapservices/de-bw_topo_50.wms	2007-11-18 14:20:19 UTC (rev 1078)
@@ -1,6 +1,6 @@
 TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 GetCapabilitiesUrl:	http://www.lv-bw.de/dv/capabilities.xml?login=dv&pw=anonymous&REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.bw topo 50
+Name:	de.bw Topo 50
 MapType:	topo
 MainUrl:	http://www.lv-bw.de/dv/service/getrds2.asp?login=dv&pw=anonymous&
 ServiceTypeUrlPart:	SERVICE=WMS 

Modified: trunk/res_noewe/webmapservices/de-nrw_topo_25.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-nrw_topo_25.wms	2007-11-18 13:34:37 UTC (rev 1077)
+++ trunk/res_noewe/webmapservices/de-nrw_topo_25.wms	2007-11-18 14:20:19 UTC (rev 1078)
@@ -10,7 +10,7 @@
 # 
 TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 GetCapabilitiesUrl:	http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:   de.nrw topo 25
+Name:   de.nrw Topo 25
 MapType:	topo
 MainUrl:	http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/TK25?
 ServiceTypeUrlPart:	SERVICE=WMS

Modified: trunk/res_noewe/webmapservices/de-rlp_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-rlp_topo_50.wms	2007-11-18 13:34:37 UTC (rev 1077)
+++ trunk/res_noewe/webmapservices/de-rlp_topo_50.wms	2007-11-18 14:20:19 UTC (rev 1078)
@@ -1,7 +1,7 @@
 # please refer to readme_wms.txt for an explantion of this file format
 TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.rlp topo 50
+Name:	de.rlp Topo 50
 MapType:	topo
 MainUrl:	http://geodaten.service24.rlp.de/cgi/wms.cgi?
 ServiceTypeUrlPart:	SERVICE=WMS 

Modified: trunk/res_noewe/webmapservices/de_topo_200.wms
===================================================================
--- trunk/res_noewe/webmapservices/de_topo_200.wms	2007-11-18 13:34:37 UTC (rev 1077)
+++ trunk/res_noewe/webmapservices/de_topo_200.wms	2007-11-18 14:20:19 UTC (rev 1078)
@@ -10,9 +10,9 @@
 # 
 TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 GetCapabilitiesUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de topo 200
+Name:	de Topo 200
 MainUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&
-MapType: 
+MapType:	topo
 ServiceTypeUrlPart:	SERVICE=WMS
 VersionUrlPart:	VERSION=1.1.0
 CoordinateReferenceSystemCacheWolf:	31468 

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-18 13:34:37 UTC (rev 1077)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-18 14:20:19 UTC (rev 1078)
@@ -188,18 +188,25 @@
 	public void setProgressInfoBox (InfoBox progrssInfoboxi) {
 		progressInfobox = progrssInfoboxi;
 	}
-
+	/**
+	 * 
+	 * @param center
+	 * @param scale
+	 * @param pixelsize
+	 * @param path must include trailing "/"
+	 * @throws Exception
+	 */
 	public void downloadMap(CWPoint center, float scale, Point pixelsize, String path) throws Exception {
 		MapInfoObject mio = currentOnlineMapService.getMapInfoObject(center, scale, pixelsize);
 		String filename = createFilename(mio.getCenter(), mio.scale);
 		String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
 		String url = currentOnlineMapService.getUrlForCenterScale(center, scale, pixelsize);
-		downloadImage(url, path+"/"+imagename);
+		downloadImage(url, path+imagename);
 		mio.saveWFL();
 	}
 
 	public String createFilename(CWPoint center, float scale) {
-		String filename = Common.ClearForFileName(currentOnlineMapService.getName()+"_s"+Common.DoubleToString(scale, 1)
+		String filename = Common.ClearForFileName(currentOnlineMapService.getNameForFileSystem()+"_s"+Common.DoubleToString(scale, 1)
 				+ "_c" + center.toString(CWPoint.LAT_LON).replace(',', '-'));
 		return filename;
 	}
@@ -272,8 +279,12 @@
 }
 
 class OnlineMapService {
+	/** Friendly name of the service */
 	String name;
+	/** Type of map (used as directory name when downloading maps. We currently have "topo" and "photo" defined as map types */
 	String mapType;
+	/** Esentially the same as name, but used for the file system. It will be part of the names of the downloaded images */ 
+	String filename;
 	String MainUrl; //http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS
 	/** including "." */
 	String imageFileExt; // ".gif", ".jpg"...
@@ -305,6 +316,17 @@
 	public String getName() {
 		return name;
 	}
+
+	/** 
+	 * This method is called to get a name of the 
+	 * online map service which will be part of the filename
+	 * used for the downloaded image
+	 * @return friendly service name
+	 */
+	public String getNameForFileSystem() {
+		return filename;
+	}
+
 	public String getMapType() {
 		return mapType;
 	}
@@ -390,11 +412,13 @@
 	 * @throws IOException
 	 * @throws IllegalArgumentException
 	 */
-	public WebMapService (String filename) throws IOException, IllegalArgumentException{
-		FileInputStream in = new FileInputStream(filename);
+	public WebMapService (String filename_) throws IOException, IllegalArgumentException{
+		FileInputStream in = new FileInputStream(filename_);
 		Properties wms = new Properties();
 		wms.load(in);
 		in.close();
+		String tmp = File.getFileExt(filename_);
+		this.filename = File.getFileExt(tmp).substring(0, tmp.lastIndexOf('.'));
 		name = wms.getProperty("Name", "").trim();
 		if (name == "") throw new IllegalArgumentException("WebMapService: property >Name:< missing in file:\n" + filename);
 		MainUrl = wms.getProperty("MainUrl", "").trim();;
@@ -403,7 +427,7 @@
 		serviceTypeUrlPart = wms.getProperty("ServiceTypeUrlPart", "SERVICE=WMS").trim();
 		layersUrlPart = wms.getProperty("LayersUrlPart", "").trim();;
 		versionUrlPart = wms.getProperty("VersionUrlPart", "").trim();;
-		String tmp = wms.getProperty("CoordinateReferenceSystemCacheWolf", "").trim();
+		tmp = wms.getProperty("CoordinateReferenceSystemCacheWolf", "").trim();
 		if (tmp.equals("")) throw new IllegalArgumentException("WebMapService: no CoordinateReferenceSystemCacheWolf given");
 		String[] tmp2 = mString.split(tmp, ' ');
 		coordinateReferenceSystem = new int[tmp2.length];
@@ -594,6 +618,7 @@
 
 	public ExpediaMapService() {
 		name = "Expedia";
+		filename = "expedia";
 		MainUrl = "Rhttp://www.expedia.de/pub/agent.dll?qscr=mrdt&ID=3kQaz."; //"Rhttp://" forces doenloadUrl to retry the URL until it gets an http-redirect and then downloads from there 
 		imageFileExt = ".gif";
 		mapType = "expedia";



From pfeffer at mail.berlios.de  Sun Nov 18 15:24:57 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 18 Nov 2007 15:24:57 +0100
Subject: [Cachewolf-svn] r1079 - in trunk/res_noewe: . webmapservices
Message-ID: <200711181424.lAIEOvxc004720@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-18 15:24:53 +0100 (Sun, 18 Nov 2007)
New Revision: 1079

Added:
   trunk/res_noewe/webmapservices/readme_wms.txt
Removed:
   trunk/res_noewe/readme_wms.txt
Log:
WMS: moved the readme

Deleted: trunk/res_noewe/readme_wms.txt
===================================================================
--- trunk/res_noewe/readme_wms.txt	2007-11-18 14:20:19 UTC (rev 1078)
+++ trunk/res_noewe/readme_wms.txt	2007-11-18 14:24:53 UTC (rev 1079)
@@ -1,99 +0,0 @@
-# This is an example and explantion of an wms definition file.
-# copy and rename this file to the extension .wms
-# You can add your own .wms file to the program directory of
-# cachwolf and the new service will be available in the download maps dialog
-# name the file this way: <internet domain of the covered region, replace "." by "-" and inverse the order>_<type of map>_<original scale>.wms
-# e.g. "de-ni_topo_25", meaning germany (de), Niedersachen (ni), topographical map, original scale 1:50000.
-# Please don't use capital letter or special characters (only "a-z0-9" and "-_" are allowed) 
-# in the filename in order to avoid problems on different platforms
-# Please include in every .wms you create a reference to this explanation file
-#
-# For a list of WMS Services available in Germany see: http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-# This example is made up from there "Digitales Orthophoto" under section "Nordrhein-Westfalen"
-# download the getCapabilieties URL, save and open it in a text editor. 
-# used here: http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-#
-# You can delete and add comments if you like. A comment starts with "#" in the first coloumn of the line.
-#
-# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
-# and fill in accordingly in any .wms file you make. They
-# are (still) not used by CacheWolf but they are usefull
-# for someone who wants to make his own changes to your file.
-# 
-# Url where the GetCapabilitiesUrl is taken from, in order to be able
-# to gather some information about the map
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS	
-#
-# friendly name, choose yourself. By convention start with the internet domanin
-# of the covered region and add the type of map and the scale of the original map 
-# multiplied by 1000, e.g. "de.nrw Luftbild" or
-# "en Airial photo" or "de.th Topo 1:50"
-Name:	de.nrw Luftbild
-# taken from getCapabilieties answer: <HTTP><GET><OnlineResource xlink:href=
-MainUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild? 
-# if this service delivers topografical maps, fill in here "topo"
-# if it delivers aerial photographs fill in "photo".
-# Please use only lower case letters and no special characters
-# in order to avoid problems using this file on different platforms
-# CacheWolf will store all maps of the same Type in the same 
-# directory.
-MapType: photo
-# this is fix, dont change it
-ServiceTypeUrlPart:	SERVICE=WMS 
-# taken from the getCapabilities request: <WMT_MS_Capabilities version=
-VersionUrlPart:	VERSION=1.1.0 
-# The EPSG-Code, supported by cachewolf: german gau?-kr?ger (31466, 31467, 31468, 
-# 31469) and WGS84 (4326)
-# You get a list of supported coordinate systems from the WMS in the getCapabilieties 
-# answer under <Layer><SRS> or <CRS>
-# Plases feel free to ask for another coordinate system to be supported by cachewolf 
-# if you need it
-# In case the wms server accepts coordinates in more than one Gau?-Kr?ger stripe
-# you can list the epsg codes here, seperated by a space. CacheWolf will
-# automatically make use of the correct stripe. 
-# The Strings in the UrlPart must match the corresponding number here
-# Sometimes the wms-Server provides only one stripe, in spite of the fact, that
-# the map it provides is not completely within this stripe. In this case
-# just list only this epsg code. CacheWolf will automatically calculate the
-# Gau?-Kr?ger coordinates for that stripe.
-# The automatic for the stripe selection only works if a german EPSG code
-# is the first one in the space seperated list
-# remark: some WMS offer WGS84 (EPSG 4326), but they are sometimes working not
-# correctly (for example the WMS of the Landesvermessungsamt NRW as of nov. 2007)
-# In this case don't list it.
-CoordinateReferenceSystemCacheWolf:	31466 31467
-# this usually will match the number above
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467
-# Post not supported by Cachewolf --> dont change this
-RequestUrlPart:	REQUEST=GetMap
-# comma seperated (without spaces) list of layers to combine
-# all of supported layers you get from the getCapabilities request <Layer><Name>
-# these names are to be used. Special characters must be URL-encode
-LayersUrlPart:	LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
-# if the WMS supports different rendering styles, select the one you need here
-# comma seperated (without spaces) list of style commands for map rendering (do not delete this item even if it is empty
-StylesUrlPart:	STYLES=
-# format, dont forget to set ImageFileExtension accordingly
-# you get a list of supported image formats from getCapabilieties answer: <GetMap><Format>
-ImageFormatUrlPart:	FORMAT=image/png
-# Limits of the service in WGS84 coordinates. 
-# You can use any format here, which is accepted by the input coordinates dialog in cachewolf
-# taken from getCapabilieties answer: <BoundingBox SRS="EPSG:4326", dont forget to add "N"/"S" and "E"/"W"
-BoundingBoxTopLeftWGS84:	N 52.7691 E 5.673
-BoundingBoxButtomRightWGS84:	N 49.9944 E 10.142
-# scale range that the service supports in meters per pixel (measured diagonal)
-# Please don't wonder that they do mot match the scale given in
-# the map download dialog as that scale is measured vertically 
-# (multiply it ba sqrt(2) and you get the scale used here
-# taken from the getCapabilities request "<Layer><ScaleHint min="
-MinScale:	0.1795783591567183
-MaxScale:	5.611823723647454
-# Plaes recommend a scale for this WMS. This scale will appear in the
-# map download dialog as default. Scale is measured in meters per pixel
-# vertical, so, multiply it by 1.41 (=sqrt(2)) to get the scale as measured
-# above in MinScale and MaxScale
-RecommendedScale:	0.5
-# set this according to ImageFormatUrlPart (must start with ".")
-ImageFileExtension: .png
-

Copied: trunk/res_noewe/webmapservices/readme_wms.txt (from rev 1077, trunk/res_noewe/readme_wms.txt)



From pfeffer at mail.berlios.de  Sun Nov 18 15:36:49 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 18 Nov 2007 15:36:49 +0100
Subject: [Cachewolf-svn] r1080 - trunk/res_noewe/webmapservices
Message-ID: <200711181436.lAIEanNH006951@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-18 15:36:48 +0100 (Sun, 18 Nov 2007)
New Revision: 1080

Modified:
   trunk/res_noewe/webmapservices/readme_wms.txt
Log:
WMS: better explanation of the .wms file

Modified: trunk/res_noewe/webmapservices/readme_wms.txt
===================================================================
--- trunk/res_noewe/webmapservices/readme_wms.txt	2007-11-18 14:24:53 UTC (rev 1079)
+++ trunk/res_noewe/webmapservices/readme_wms.txt	2007-11-18 14:36:48 UTC (rev 1080)
@@ -1,9 +1,9 @@
 # This is an example and explantion of an wms definition file.
 # copy and rename this file to the extension .wms
-# You can add your own .wms file to the program directory of
-# cachwolf and the new service will be available in the download maps dialog
+# You can add your own .wms file to this directory 
+# and the new service will be available in the download maps dialog
 # name the file this way: <internet domain of the covered region, replace "." by "-" and inverse the order>_<type of map>_<original scale>.wms
-# e.g. "de-ni_topo_25", meaning germany (de), Niedersachen (ni), topographical map, original scale 1:50000.
+# e.g. "de-ni_topo_50", meaning germany (de), Niedersachen (ni), topographical map, original scale 1:50000.
 # Please don't use capital letter or special characters (only "a-z0-9" and "-_" are allowed) 
 # in the filename in order to avoid problems on different platforms
 # Please include in every .wms you create a reference to this explanation file
@@ -31,6 +31,7 @@
 # "en Airial photo" or "de.th Topo 1:50"
 Name:	de.nrw Luftbild
 # taken from getCapabilieties answer: <HTTP><GET><OnlineResource xlink:href=
+# note: if it doesn't work, please try adding an "?" to the URL got from there
 MainUrl:	http://www.gis2.nrw.de/wmsconnector/wms/luftbild? 
 # if this service delivers topografical maps, fill in here "topo"
 # if it delivers aerial photographs fill in "photo".
@@ -52,7 +53,7 @@
 # In case the wms server accepts coordinates in more than one Gau?-Kr?ger stripe
 # you can list the epsg codes here, seperated by a space. CacheWolf will
 # automatically make use of the correct stripe. 
-# The Strings in the UrlPart must match the corresponding number here
+# The sequens of strings in the UrlPart must match sequence of the corresponding numbers here.
 # Sometimes the wms-Server provides only one stripe, in spite of the fact, that
 # the map it provides is not completely within this stripe. In this case
 # just list only this epsg code. CacheWolf will automatically calculate the



From pfeffer at mail.berlios.de  Sun Nov 18 15:37:37 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 18 Nov 2007 15:37:37 +0100
Subject: [Cachewolf-svn] r1081 - trunk/src/CacheWolf/navi
Message-ID: <200711181437.lAIEbbrG007025@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-18 15:37:35 +0100 (Sun, 18 Nov 2007)
New Revision: 1081

Modified:
   trunk/src/CacheWolf/navi/MapInfoObject.java
Log:
added a comment

Modified: trunk/src/CacheWolf/navi/MapInfoObject.java
===================================================================
--- trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-18 14:36:48 UTC (rev 1080)
+++ trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-18 14:37:35 UTC (rev 1081)
@@ -137,7 +137,7 @@
 
 	/**
 	 * 
-	 * @param path
+	 * @param path including trailing "/"
 	 * @param n without ".wfl"
 	 * @return name of the map including fast-find-prefix
 	 */



From mik77 at mail.berlios.de  Sun Nov 18 16:58:02 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 18 Nov 2007 16:58:02 +0100
Subject: [Cachewolf-svn] r1082 - trunk
Message-ID: <200711181558.lAIFw2Ck012489@sheep.berlios.de>

Author: mik77
Date: 2007-11-18 16:57:56 +0100 (Sun, 18 Nov 2007)
New Revision: 1082

Added:
   trunk/cw-pda.jnf
Log:
Copied because PDA needs special options which cause problems on PC

Copied: trunk/cw-pda.jnf (from rev 1081, trunk/cwberlios.jnf)



From mik77 at mail.berlios.de  Sun Nov 18 17:16:19 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 18 Nov 2007 17:16:19 +0100
Subject: [Cachewolf-svn] r1083 - trunk
Message-ID: <200711181616.lAIGGJuo013720@sheep.berlios.de>

Author: mik77
Date: 2007-11-18 17:16:09 +0100 (Sun, 18 Nov 2007)
New Revision: 1083

Added:
   trunk/cw-pc.jnf
Removed:
   trunk/cwberlios.jnf
Modified:
   trunk/buildexe.bat
   trunk/buildexe.sh
   trunk/cw-pda.jnf
   trunk/fwrtsnapshot.sh
Log:
We have now two versions of the jnf-file one for PDAs (with /Xmx 12M switch) and one for PCs (without this option).
All scripts call the PDA version first and then the PC version. So the .ewe will be without /Xmx 12M.

Modified: trunk/buildexe.bat
===================================================================
--- trunk/buildexe.bat	2007-11-18 15:57:56 UTC (rev 1082)
+++ trunk/buildexe.bat	2007-11-18 16:16:09 UTC (rev 1083)
@@ -1,3 +1,5 @@
 call getres.bat
-java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cwberlios.jnf
+java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cw-pda.jnf
+java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cw-pc.jnf
+REM Dont change the order above because the PC version has to overwrite the PDA version of the EWE-file
 pause

Modified: trunk/buildexe.sh
===================================================================
--- trunk/buildexe.sh	2007-11-18 15:57:56 UTC (rev 1082)
+++ trunk/buildexe.sh	2007-11-18 16:16:09 UTC (rev 1083)
@@ -1,2 +1,4 @@
 #!/bin/sh
-java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cwberlios.jnf
+java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cw-pda.jnf
+java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cw-pc.jnf
+# Dont change the order above because the PC version has to overwrite the PDA version of the EWE-file

Copied: trunk/cw-pc.jnf (from rev 1082, trunk/cwberlios.jnf)
===================================================================
--- trunk/cwberlios.jnf	2007-11-18 15:57:56 UTC (rev 1082)
+++ trunk/cw-pc.jnf	2007-11-18 16:16:09 UTC (rev 1083)
@@ -0,0 +1 @@
+command=programName%3DCacheWolf%26width%3D0%26height%3D0%26startingClass%3DCacheWolf.CacheWolf%26windowTitle%3DWindow%2BTitle%26ewes%3D%26extra%3D%26pathToEwe%3D%26nativeStack%3D0%26vmStack%3D0%26appletWidth%3D0%26appletHeight%3D0%26appletInFrame%3Dfalse%26locale%3D%26useResources%3Dtrue%26noPopupWindows%3Dfalse%26vmOptions%3D&eweFiles=&targets=%253DTarget%3Dewe/data/MultiListSelect$SelectedItems%253D%25253DJar%25252B-%25252BJava%25252B1.2%252526%25253Dx86%25252B-%25252BWin32%25252B-%25252BStatic%25252BLinked&createWithPnf=true&eweInfo=outputFile%3Dwork/CacheWolf.ewe%26entries%3Dewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/CacheWolf/%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253DCacheWolf/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/exp%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dexp/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dresources%252526mask%25253D*.gif;*.png;*.ico!
 ;%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dresources/%252526mask%25253Dcachewolf.Languages.cfg%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D_config/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dlib%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/utils%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dutils/%26addCommandLine%3Dtrue%26commandLine%3DprogramName%253DCacheWolf%2526width%253D0%2526height%253D0%2526startingClass%253DCacheWolf.CacheWolf%2526windowTitle%253DWindow%252BTitle%2526ewes%253D%2526extra%253D%2526pathToEwe%253D%2526nativeStack%253D0%2526vmStack%253D0%2526appletWidth%253D0%2526appletHeight%253D0%2526appletInFrame%253Dfalse%2526locale%253D%2526useResources%253Dtrue%2526noPopupWindows%253Dfalse%2526vmOptions%253D%26install%3Dtitle%253D%252!
 6category%253DApplications%2526location%253D%2526icon%253D%252!
 6args%25
3D%2526vmArgs%253D%26addInstallFile%3Dfalse%26usePool%3Dfalse%26useClassPool%3Dfalse&icon=resources/CacheWolf.ico

Modified: trunk/cw-pda.jnf
===================================================================
--- trunk/cw-pda.jnf	2007-11-18 15:57:56 UTC (rev 1082)
+++ trunk/cw-pda.jnf	2007-11-18 16:16:09 UTC (rev 1083)
@@ -1 +1 @@
-command=programName%3DCacheWolf%26width%3D0%26height%3D0%26startingClass%3DCacheWolf.CacheWolf%26windowTitle%3DWindow%2BTitle%26ewes%3D%26extra%3D%26pathToEwe%3D%26nativeStack%3D0%26vmStack%3D0%26appletWidth%3D0%26appletHeight%3D0%26appletInFrame%3Dfalse%26locale%3D%26useResources%3Dtrue%26noPopupWindows%3Dfalse%26vmOptions%3D/Xmx%2B12M&eweFiles=&targets=%253DTarget%3Dewe/data/MultiListSelect$SelectedItems%253D%25253DJar%25252B-%25252BJava%25252B1.2%252526%25253DPocketPC%25252B2003%252526%25253DPocketPC%25252B-%25252BARM/XScale%252526%25253DPocketPC%25252B-%25252BMIPS%252526%25253DPocketPC%25252B-%25252BSH3%252526%25253Dx86%25252B-%25252BWin32%25252B-%25252BStatic%25252BLinked&createWithPnf=true&eweInfo=outputFile%3Dwork/CacheWolf.ewe%26entries%3Dewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/CacheWolf/%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253DCacheWolf/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/exp%252526mask%2525!
 3D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dexp/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dresources%252526mask%25253D*.gif;*.png;*.ico;%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dresources/%252526mask%25253Dcachewolf.Languages.cfg%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D_config/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dlib%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/utils%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dutils/%26addCommandLine%3Dtrue%26commandLine%3DprogramName%253DCacheWolf%2526width%253D0%2526height%253D0%2526startingClass%253DCacheWolf.CacheWolf%2526windowTitle%253DWindow%252BTitle%2526ewes%253D%2526extra%253D%2526pathToEwe%253D%2526nativeStack%253D0%2526vmStack%253D0%2526appletWidth%25!
 3D0%2526appletHeight%253D0%2526appletInFrame%253Dfalse%2526loc!
 ale%253D
%2526useResources%253Dtrue%2526noPopupWindows%253Dfalse%2526vmOptions%253D/Xmx%252B12M%26install%3Dtitle%253D%2526category%253DApplications%2526location%253D%2526icon%253D%2526args%253D%2526vmArgs%253D%26addInstallFile%3Dfalse%26usePool%3Dfalse%26useClassPool%3Dfalse&icon=resources/CacheWolf.ico
+command=programName%3DCacheWolf%26width%3D0%26height%3D0%26startingClass%3DCacheWolf.CacheWolf%26windowTitle%3DWindow%2BTitle%26ewes%3D%26extra%3D%26pathToEwe%3D%26nativeStack%3D0%26vmStack%3D0%26appletWidth%3D0%26appletHeight%3D0%26appletInFrame%3Dfalse%26locale%3D%26useResources%3Dtrue%26noPopupWindows%3Dfalse%26vmOptions%3D/Xmx%2B12M&eweFiles=&targets=%253DTarget%3Dewe/data/MultiListSelect$SelectedItems%253D%25253DPocketPC%25252B2003%252526%25253DPocketPC%25252B-%25252BARM/XScale%252526%25253DPocketPC%25252B-%25252BMIPS%252526%25253DPocketPC%25252B-%25252BSH3&createWithPnf=true&eweInfo=outputFile%3Dwork/CacheWolf.ewe%26entries%3Dewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/CacheWolf/%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253DCacheWolf/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/exp%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dexp/%2526ewesoft/apps/jewel/EweDirEntry%253Dp!
 ath%25253Dresources%252526mask%25253D*.gif;*.png;*.ico;%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dresources/%252526mask%25253Dcachewolf.Languages.cfg%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D_config/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dlib%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/utils%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dutils/%26addCommandLine%3Dtrue%26commandLine%3DprogramName%253DCacheWolf%2526width%253D0%2526height%253D0%2526startingClass%253DCacheWolf.CacheWolf%2526windowTitle%253DWindow%252BTitle%2526ewes%253D%2526extra%253D%2526pathToEwe%253D%2526nativeStack%253D0%2526vmStack%253D0%2526appletWidth%253D0%2526appletHeight%253D0%2526appletInFrame%253Dfalse%2526locale%253D%2526useResources%253Dtrue%2526noPopupWindows%2!
 53Dfalse%2526vmOptions%253D/Xmx%252B12M%26install%3Dtitle%253D!
 %2526cat
egory%253DApplications%2526location%253D%2526icon%253D%2526args%253D%2526vmArgs%253D%26addInstallFile%3Dfalse%26usePool%3Dfalse%26useClassPool%3Dfalse&icon=resources/CacheWolf.ico

Deleted: trunk/cwberlios.jnf
===================================================================
--- trunk/cwberlios.jnf	2007-11-18 15:57:56 UTC (rev 1082)
+++ trunk/cwberlios.jnf	2007-11-18 16:16:09 UTC (rev 1083)
@@ -1 +0,0 @@
-command=programName%3DCacheWolf%26width%3D0%26height%3D0%26startingClass%3DCacheWolf.CacheWolf%26windowTitle%3DWindow%2BTitle%26ewes%3D%26extra%3D%26pathToEwe%3D%26nativeStack%3D0%26vmStack%3D0%26appletWidth%3D0%26appletHeight%3D0%26appletInFrame%3Dfalse%26locale%3D%26useResources%3Dtrue%26noPopupWindows%3Dfalse%26vmOptions%3D/Xmx%2B12M&eweFiles=&targets=%253DTarget%3Dewe/data/MultiListSelect$SelectedItems%253D%25253DJar%25252B-%25252BJava%25252B1.2%252526%25253DPocketPC%25252B2003%252526%25253DPocketPC%25252B-%25252BARM/XScale%252526%25253DPocketPC%25252B-%25252BMIPS%252526%25253DPocketPC%25252B-%25252BSH3%252526%25253Dx86%25252B-%25252BWin32%25252B-%25252BStatic%25252BLinked&createWithPnf=true&eweInfo=outputFile%3Dwork/CacheWolf.ewe%26entries%3Dewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/CacheWolf/%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253DCacheWolf/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/exp%252526mask%2525!
 3D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dexp/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dresources%252526mask%25253D*.gif;*.png;*.ico;%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dresources/%252526mask%25253Dcachewolf.Languages.cfg%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D_config/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dlib%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253Dbin/utils%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dutils/%26addCommandLine%3Dtrue%26commandLine%3DprogramName%253DCacheWolf%2526width%253D0%2526height%253D0%2526startingClass%253DCacheWolf.CacheWolf%2526windowTitle%253DWindow%252BTitle%2526ewes%253D%2526extra%253D%2526pathToEwe%253D%2526nativeStack%253D0%2526vmStack%253D0%2526appletWidth%25!
 3D0%2526appletHeight%253D0%2526appletInFrame%253Dfalse%2526loc!
 ale%253D
%2526useResources%253Dtrue%2526noPopupWindows%253Dfalse%2526vmOptions%253D/Xmx%252B12M%26install%3Dtitle%253D%2526category%253DApplications%2526location%253D%2526icon%253D%2526args%253D%2526vmArgs%253D%26addInstallFile%3Dfalse%26usePool%3Dfalse%26useClassPool%3Dfalse&icon=resources/CacheWolf.ico

Modified: trunk/fwrtsnapshot.sh
===================================================================
--- trunk/fwrtsnapshot.sh	2007-11-18 15:57:56 UTC (rev 1082)
+++ trunk/fwrtsnapshot.sh	2007-11-18 16:16:09 UTC (rev 1083)
@@ -8,7 +8,9 @@
 rm -rf bin
 mkdir -p bin/CacheWolf
 javac -source 1.3 -target 1.1 -encoding windows-1252 -cp ./lib/CompileEwe.zip:./lib/  -d ./bin/ -deprecation -nowarn ./src/CacheWolf/*.java ./src/CacheWolf/*/*.java ./src/exp/*.java ./src/utils/*.java
-/usr/local/bin/ewecl programs/Jewel.ewe -c cwberlios.jnf
+/usr/local/bin/ewecl programs/Jewel.ewe -c cw-pda.jnf
+/usr/local/bin/ewecl programs/Jewel.ewe -c cw-pc.jnf
+# Dont change the order above because the PC version has to overwrite the PDA version of the EWE-file
 rm -rf published
 if test '!' -e programs/CacheWolf/Jar/CacheWolf.bat; then
 	rm -rf bin



From mik77 at mail.berlios.de  Sun Nov 18 19:57:52 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 18 Nov 2007 19:57:52 +0100
Subject: [Cachewolf-svn] r1084 - trunk/res_noewe/webmapservices
Message-ID: <200711181857.lAIIvq7v010471@sheep.berlios.de>

Author: mik77
Date: 2007-11-18 19:57:36 +0100 (Sun, 18 Nov 2007)
New Revision: 1084

Added:
   trunk/res_noewe/webmapservices/de-he_photo.wms
   trunk/res_noewe/webmapservices/de-rlp_photo.wms
   trunk/res_noewe/webmapservices/de-sa_photo.wms
   trunk/res_noewe/webmapservices/de-sa_topo_10.wms
   trunk/res_noewe/webmapservices/de-sa_topo_50.wms
Modified:
   trunk/res_noewe/webmapservices/de-by_topo_50.wms
Log:
DOP for HE and RLP. DOP, TK10, TK50 for SA

Modified: trunk/res_noewe/webmapservices/de-by_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-by_topo_50.wms	2007-11-18 16:16:09 UTC (rev 1083)
+++ trunk/res_noewe/webmapservices/de-by_topo_50.wms	2007-11-18 18:57:36 UTC (rev 1084)
@@ -1,7 +1,7 @@
 # please refere to readme_wms.txt for an explantion of this file format
 TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 GetCapabilitiesUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.by topo 50
+Name:	de.by Topo 50
 MapType:	topo
 MainUrl:	http://www.geodaten.bayern.de/ogc/getogc.cgi?
 ServiceTypeUrlPart:	SERVICE=WMS 

Added: trunk/res_noewe/webmapservices/de-he_photo.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-he_photo.wms	2007-11-18 16:16:09 UTC (rev 1083)
+++ trunk/res_noewe/webmapservices/de-he_photo.wms	2007-11-18 18:57:36 UTC (rev 1084)
@@ -0,0 +1,20 @@
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-images.plx?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS                    http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-images.plx?
+Name:	de.he Luftbild
+MapType:	photo
+MainUrl:	http://lika.hessen.de/cgi-bin/lika-services/de-viewer/access/ogc-free-images.plx?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:	31467
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DOP04F1
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84:	N 51.6697 E 7.69911
+BoundingBoxButtomRightWGS84:	N 49.3455 E 11.3986
+MinScale:   0.399122
+MaxScale:   9.97806
+RecommendedScale:   0.4
+ImageFileExtension: .jpg
+

Added: trunk/res_noewe/webmapservices/de-rlp_photo.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-rlp_photo.wms	2007-11-18 16:16:09 UTC (rev 1083)
+++ trunk/res_noewe/webmapservices/de-rlp_photo.wms	2007-11-18 18:57:36 UTC (rev 1084)
@@ -0,0 +1,20 @@
+# please refer to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.rlp Luftbild
+MapType:	photo
+MainUrl:	http://geodaten.service24.rlp.de/cgi/wms.cgi?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:   31466 31467
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:   REQUEST=GetMap
+LayersUrlPart:   LAYERS=freedop%3Adop
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
+BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
+MinScale:   0.5
+MaxScale:   24.95
+RecommendedScale:	0.4
+ImageFileExtension: .png 

Added: trunk/res_noewe/webmapservices/de-sa_photo.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sa_photo.wms	2007-11-18 16:16:09 UTC (rev 1083)
+++ trunk/res_noewe/webmapservices/de-sa_photo.wms	2007-11-18 18:57:36 UTC (rev 1084)
@@ -0,0 +1,18 @@
+# please refer to readme_wms.txt for an explantion of this file format
+Name:	de.sa Luftbild
+MapType:	photo
+MainUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:   31468
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31468
+RequestUrlPart:   REQUEST=GetMap
+LayersUrlPart:   LAYERS=layer_601
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 53.222636951 E 10.501218361
+BoundingBoxButtomRightWGS84:   N 50.527211799 E 13.495718636
+MinScale:   0.00001
+MaxScale:   24.95
+RecommendedScale:	1.0
+ImageFileExtension: .png 

Added: trunk/res_noewe/webmapservices/de-sa_topo_10.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sa_topo_10.wms	2007-11-18 16:16:09 UTC (rev 1083)
+++ trunk/res_noewe/webmapservices/de-sa_topo_10.wms	2007-11-18 18:57:36 UTC (rev 1084)
@@ -0,0 +1,18 @@
+# please refer to readme_wms.txt for an explantion of this file format
+Name:	de.sa Topo 10
+MapType:	topo
+MainUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:   31468
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31468
+RequestUrlPart:   REQUEST=GetMap
+LayersUrlPart:   LAYERS=layer_603
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 53.222636951 E 10.501218361
+BoundingBoxButtomRightWGS84:   N 50.527211799 E 13.495718636
+MinScale:   0.000499
+MaxScale:   249.451559
+RecommendedScale:	1.0
+ImageFileExtension: .png 

Added: trunk/res_noewe/webmapservices/de-sa_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sa_topo_50.wms	2007-11-18 16:16:09 UTC (rev 1083)
+++ trunk/res_noewe/webmapservices/de-sa_topo_50.wms	2007-11-18 18:57:36 UTC (rev 1084)
@@ -0,0 +1,18 @@
+# please refer to readme_wms.txt for an explantion of this file format
+Name:	de.sa Topo 50
+MapType:	topo
+MainUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:   31468
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31468
+RequestUrlPart:   REQUEST=GetMap
+LayersUrlPart:   LAYERS=layer_607
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 53.222636951 E 10.501218361
+BoundingBoxButtomRightWGS84:   N 50.527211799 E 13.495718636
+MinScale:   4.989031
+MaxScale:   124.725779
+RecommendedScale:	5.0
+ImageFileExtension: .png 



From mik77 at mail.berlios.de  Sun Nov 18 23:24:44 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 18 Nov 2007 23:24:44 +0100
Subject: [Cachewolf-svn] r1085 - trunk/res_noewe/webmapservices
Message-ID: <200711182224.lAIMOi38023725@sheep.berlios.de>

Author: mik77
Date: 2007-11-18 23:24:39 +0100 (Sun, 18 Nov 2007)
New Revision: 1085

Modified:
   trunk/res_noewe/webmapservices/de-sa_photo.wms
   trunk/res_noewe/webmapservices/de-sa_topo_10.wms
   trunk/res_noewe/webmapservices/de-sa_topo_50.wms
Log:
some additions to the SA WMS

Modified: trunk/res_noewe/webmapservices/de-sa_photo.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sa_photo.wms	2007-11-18 18:57:36 UTC (rev 1084)
+++ trunk/res_noewe/webmapservices/de-sa_photo.wms	2007-11-18 22:24:39 UTC (rev 1085)
@@ -1,4 +1,6 @@
 # please refer to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://www.lvermgeo.sachsen-anhalt.de/de/geoservice/viewer/main.htm
+GetCapabilitiesUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
 Name:	de.sa Luftbild
 MapType:	photo
 MainUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?

Modified: trunk/res_noewe/webmapservices/de-sa_topo_10.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sa_topo_10.wms	2007-11-18 18:57:36 UTC (rev 1084)
+++ trunk/res_noewe/webmapservices/de-sa_topo_10.wms	2007-11-18 22:24:39 UTC (rev 1085)
@@ -1,4 +1,6 @@
 # please refer to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://www.lvermgeo.sachsen-anhalt.de/de/geoservice/viewer/main.htm
+GetCapabilitiesUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
 Name:	de.sa Topo 10
 MapType:	topo
 MainUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?

Modified: trunk/res_noewe/webmapservices/de-sa_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sa_topo_50.wms	2007-11-18 18:57:36 UTC (rev 1084)
+++ trunk/res_noewe/webmapservices/de-sa_topo_50.wms	2007-11-18 22:24:39 UTC (rev 1085)
@@ -1,4 +1,6 @@
 # please refer to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://www.lvermgeo.sachsen-anhalt.de/de/geoservice/viewer/main.htm
+GetCapabilitiesUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
 Name:	de.sa Topo 50
 MapType:	topo
 MainUrl:	http://lsa-st317.sachsen-anhalt.de/geodatenportal/servlet/gtEntryPoint?



From mik77 at mail.berlios.de  Mon Nov 19 22:28:27 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Mon, 19 Nov 2007 22:28:27 +0100
Subject: [Cachewolf-svn] r1086 - trunk/res_noewe/webmapservices
Message-ID: <200711192128.lAJLSRb1013310@sheep.berlios.de>

Author: mik77
Date: 2007-11-19 22:28:09 +0100 (Mon, 19 Nov 2007)
New Revision: 1086

Added:
   trunk/res_noewe/webmapservices/de-nrw_topo_50.wms
   trunk/res_noewe/webmapservices/de-sn_photo.wms
   trunk/res_noewe/webmapservices/de-sn_topo_10.wms
   trunk/res_noewe/webmapservices/de-sn_topo_25.wms
   trunk/res_noewe/webmapservices/de-sn_topo_50.wms
   trunk/res_noewe/webmapservices/de_topo_1000.wms
   trunk/res_noewe/webmapservices/de_topo_500.wms
Modified:
   trunk/res_noewe/webmapservices/de-nrw_topo_25.wms
   trunk/res_noewe/webmapservices/de_topo_200.wms
Log:
new WMS: TK10/25/50 + DOP for SN, TK50 for NRW, TK500/1000 for DE

Modified: trunk/res_noewe/webmapservices/de-nrw_topo_25.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-nrw_topo_25.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de-nrw_topo_25.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -27,5 +27,5 @@
 # the hintscale delivered from the getCapilibitiesUrl is a little bit higher (11.667) but this leads sometimes to empty maps
 # I tested that 11.0485 is probably the real MaxScale
 MaxScale:   11.0485
-RecommendedScale:	3
+RecommendedScale:	2.5
 ImageFileExtension:	.png

Added: trunk/res_noewe/webmapservices/de-nrw_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-nrw_topo_50.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de-nrw_topo_50.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -0,0 +1,19 @@
+TakenFromUrl:   http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Dialogbox
+GetCapabilitiesUrl:   http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK50?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.1.0
+Name: de.nrw Topo 50
+MapType:   topo
+MainUrl:   http://www.geoserver.nrw.de:80/GeoOgcWms1.3/servlet/TK50?
+ServiceTypeUrlPart:   SERVICE=WMS
+VersionUrlPart:   VERSION=1.1.0
+CoordinateReferenceSystemCacheWolf:   31466 31467
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:   REQUEST=GetMap
+LayersUrlPart:   LAYERS=Raster%3ATK50%5FKMF%3AFarbkombination
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 52.7691 E 5.673
+BoundingBoxButtomRightWGS84:   N 49.9944 E 10.142
+MinScale:   0.0
+MaxScale:   23.335
+RecommendedScale:   5
+ImageFileExtension: .png
\ No newline at end of file

Added: trunk/res_noewe/webmapservices/de-sn_photo.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sn_photo.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de-sn_photo.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVDOPFREE/WMSFREE_TK/WMSFREE_TK/wmsservice?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.sn Luftbild
+MapType:	photo
+MainUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVDOPFREE/WMSFREE_TK/WMSFREE_TK/wmsservice?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=c
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 51.8592 E 11.7651
+BoundingBoxButtomRightWGS84:	N 50.0294 E 15.1358
+MinScale:	0.65
+MaxScale:	4.98853
+RecommendedScale:	0.5
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/de-sn_topo_10.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sn_topo_10.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de-sn_topo_10.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.sn Topo 10
+MapType:	topo
+MainUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=TK10
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 51.8592 E 11.7651
+BoundingBoxButtomRightWGS84:	N 50.0294 E 15.1358
+MinScale:	0.0503892
+MaxScale:	2.49451
+RecommendedScale:	1.0
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/de-sn_topo_25.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sn_topo_25.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de-sn_topo_25.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.sn Topo 25
+MapType:	topo
+MainUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=TK25
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 51.8592 E 11.7651
+BoundingBoxButtomRightWGS84:	N 50.0294 E 15.1358
+MinScale:	2.49451
+MaxScale:	4.98903
+RecommendedScale:	2.5
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/de-sn_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-sn_topo_50.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de-sn_topo_50.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.sn Topo 50
+MapType:	topo
+MainUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=TK50
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 51.8592 E 11.7651
+BoundingBoxButtomRightWGS84:	N 50.0294 E 15.1358
+MinScale:	4.98903
+MaxScale:	12.4726
+RecommendedScale:	5.0
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/de_topo_1000.wms
===================================================================
--- trunk/res_noewe/webmapservices/de_topo_1000.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de_topo_1000.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -0,0 +1,30 @@
+# For an example and explantion please see readme_wms.txt, which
+# you can find in the program directory of CacheWolf. There
+# you always get the newest information about .wms format.
+# plaese include this hint in any .wms you create
+#
+# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
+# and fill in accordingly in any .wms file you make. They
+# are (still) not used by CacheWolf but they are usefull
+# for someone who wants to make his own changes to your file.
+# 
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&service=WMS&version=1.1.1&request=GetCapabilities
+Name:	de Topo 1000
+MainUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&
+MapType:	topo
+ServiceTypeUrlPart:	SERVICE=WMS
+VersionUrlPart:	VERSION=1.1.0
+CoordinateReferenceSystemCacheWolf:	31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DTK1000
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 54.937 E 6.00242837
+BoundingBoxButtomRightWGS84:	N 46.95 E 16.12332498
+# there is no scale hint in the getCapabilities answer :-( --> allow all
+#MinScale:	0.01
+#MaxScale:	40
+RecommendedScale:	100
+ImageFileExtension: .png

Modified: trunk/res_noewe/webmapservices/de_topo_200.wms
===================================================================
--- trunk/res_noewe/webmapservices/de_topo_200.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de_topo_200.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -26,5 +26,5 @@
 # there is no scale hint in the getCapabilities answer :-( --> allow all
 #MinScale:	0.01
 #MaxScale:	40
-RecommendedScale:	15
+RecommendedScale:	20
 ImageFileExtension: .png
\ No newline at end of file

Added: trunk/res_noewe/webmapservices/de_topo_500.wms
===================================================================
--- trunk/res_noewe/webmapservices/de_topo_500.wms	2007-11-18 22:24:39 UTC (rev 1085)
+++ trunk/res_noewe/webmapservices/de_topo_500.wms	2007-11-19 21:28:09 UTC (rev 1086)
@@ -0,0 +1,30 @@
+# For an example and explantion please see readme_wms.txt, which
+# you can find in the program directory of CacheWolf. There
+# you always get the newest information about .wms format.
+# plaese include this hint in any .wms you create
+#
+# Please include the two lines (TakenFromUrl: and GetCapabilitiesUrl:)
+# and fill in accordingly in any .wms file you make. They
+# are (still) not used by CacheWolf but they are usefull
+# for someone who wants to make his own changes to your file.
+# 
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&service=WMS&version=1.1.1&request=GetCapabilities
+Name:	de Topo 500
+MainUrl:	http://gdz1.leipzig.ifag.de/servlet/com.esri.wms.Esrimap?servicename=dtk200_500_1000_a10_gk4_wms&
+MapType:	topo
+ServiceTypeUrlPart:	SERVICE=WMS
+VersionUrlPart:	VERSION=1.1.0
+CoordinateReferenceSystemCacheWolf:	31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DTK500-V
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 54.9369973 E 6.00184962
+BoundingBoxButtomRightWGS84:	N 46.959702 E 16.12339886
+# there is no scale hint in the getCapabilities answer :-( --> allow all
+#MinScale:	0.01
+#MaxScale:	40
+RecommendedScale:	50
+ImageFileExtension: .png



From mik77 at mail.berlios.de  Mon Nov 19 23:08:42 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Mon, 19 Nov 2007 23:08:42 +0100
Subject: [Cachewolf-svn] r1087 - trunk/res_noewe/webmapservices
Message-ID: <200711192208.lAJM8gf6015687@sheep.berlios.de>

Author: mik77
Date: 2007-11-19 23:08:38 +0100 (Mon, 19 Nov 2007)
New Revision: 1087

Added:
   trunk/res_noewe/webmapservices/de-ni_topo_100.wms
Log:
WMS TK100 for NI

Added: trunk/res_noewe/webmapservices/de-ni_topo_100.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-ni_topo_100.wms	2007-11-19 21:28:09 UTC (rev 1086)
+++ trunk/res_noewe/webmapservices/de-ni_topo_100.wms	2007-11-19 22:08:38 UTC (rev 1087)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.mapserver.niedersachsen.de/freezoneogc/mapserverogc?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
+Name:	de.ni Topo 100
+MapType:	topo
+MainUrl:	http://www.mapserver.niedersachsen.de/freezoneogc/mapserverogc?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31467
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=TK100
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 54.94030655149304 E 6.180364501677226
+BoundingBoxButtomRightWGS84:	N 50.50279594367625 E 13.683332705481225
+MinScale:	6.76160460880501
+MaxScale:	52.82503600628914
+RecommendedScale:	15.0
+ImageFileExtension: .png



From mik77 at mail.berlios.de  Tue Nov 20 20:41:55 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Tue, 20 Nov 2007 20:41:55 +0100
Subject: [Cachewolf-svn] r1088 - trunk/res_noewe/webmapservices
Message-ID: <200711201941.lAKJftb5014039@sheep.berlios.de>

Author: mik77
Date: 2007-11-20 20:41:45 +0100 (Tue, 20 Nov 2007)
New Revision: 1088

Added:
   trunk/res_noewe/webmapservices/de-mv_photo.wms
   trunk/res_noewe/webmapservices/de-mv_topo_10.wms
   trunk/res_noewe/webmapservices/de-mv_topo_25.wms
   trunk/res_noewe/webmapservices/de-mv_topo_50.wms
Log:
WMS vor MV: TK10/25/50 + DOP

Added: trunk/res_noewe/webmapservices/de-mv_photo.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-mv_photo.wms	2007-11-19 22:08:38 UTC (rev 1087)
+++ trunk/res_noewe/webmapservices/de-mv_photo.wms	2007-11-20 19:41:45 UTC (rev 1088)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.gaia-mv.de/dienste/DOP?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
+Name:	de.mv Luftbild
+MapType:	photo
+MainUrl:	http://www.gaia-mv.de/dienste/DOP?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DOP
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84:	N 54.8209 E 10.3394
+BoundingBoxButtomRightWGS84:	N 53.0392 E 14.477
+MinScale:	0.000374177136322228
+MaxScale:	37.4180878093591
+RecommendedScale:	0.4
+ImageFileExtension: .jpg

Added: trunk/res_noewe/webmapservices/de-mv_topo_10.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-mv_topo_10.wms	2007-11-19 22:08:38 UTC (rev 1087)
+++ trunk/res_noewe/webmapservices/de-mv_topo_10.wms	2007-11-20 19:41:45 UTC (rev 1088)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.gaia-mv.de/dienste/DTK10f?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
+Name:	de.mv Topo 10
+MapType:	topo
+MainUrl:	http://www.gaia-mv.de/dienste/DTK10f?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DTK10f
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 54.8209 E 10.3394
+BoundingBoxButtomRightWGS84:	N 53.0392 E 14.477
+MinScale:	0.186714391024792
+MaxScale:	11.2256882668032
+RecommendedScale:	1.0
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/de-mv_topo_25.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-mv_topo_25.wms	2007-11-19 22:08:38 UTC (rev 1087)
+++ trunk/res_noewe/webmapservices/de-mv_topo_25.wms	2007-11-20 19:41:45 UTC (rev 1088)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.gaia-mv.de/dienste/DTK25Vf?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
+Name:	de.mv Topo 25
+MapType:	topo
+MainUrl:	http://www.gaia-mv.de/dienste/DTK25Vf?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DTK25Vf
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 54.8209 E 10.3394
+BoundingBoxButtomRightWGS84:	N 53.0392 E 14.477
+MinScale:	1.87051150447482
+MaxScale:	18.7092309932477
+RecommendedScale:	2.5
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/de-mv_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-mv_topo_50.wms	2007-11-19 22:08:38 UTC (rev 1087)
+++ trunk/res_noewe/webmapservices/de-mv_topo_50.wms	2007-11-20 19:41:45 UTC (rev 1088)
@@ -0,0 +1,20 @@
+# please refere to readme_wms.txt for an explantion of this file format
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://www.gaia-mv.de/dienste/DTK50Vf?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
+Name:	de.mv Topo 50
+MapType:	topo
+MainUrl:	http://www.gaia-mv.de/dienste/DTK50Vf?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf: 31468 
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
+RequestUrlPart:	REQUEST=GetMap
+LayersUrlPart:	LAYERS=DTK50Vf
+StylesUrlPart:	STYLES=
+ImageFormatUrlPart:	FORMAT=image/png
+BoundingBoxTopLeftWGS84:	N 54.8209 E 10.3394
+BoundingBoxButtomRightWGS84:	N 53.0392 E 14.477
+MinScale:	5.6122828676971
+MaxScale:	28.0636594013034
+RecommendedScale:	5.0
+ImageFileExtension: .png



From salzkammergut at mail.berlios.de  Tue Nov 20 20:53:34 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Tue, 20 Nov 2007 20:53:34 +0100
Subject: [Cachewolf-svn] r1089 - in trunk/src: CacheWolf exp
Message-ID: <200711201953.lAKJrYfI015015@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-20 20:53:24 +0100 (Tue, 20 Nov 2007)
New Revision: 1089

Modified:
   trunk/src/CacheWolf/DataMover.java
   trunk/src/exp/HTMLExporter.java
Log:
HTMLExporter: Removed the link to GC in images embedded in logs.
DataMover.copy: Added more detail to the error message "Filecopy Failed"

Modified: trunk/src/CacheWolf/DataMover.java
===================================================================
--- trunk/src/CacheWolf/DataMover.java	2007-11-20 19:41:45 UTC (rev 1088)
+++ trunk/src/CacheWolf/DataMover.java	2007-11-20 19:53:24 UTC (rev 1089)
@@ -176,7 +176,7 @@
 		    fis.close();
 	    }
 	    catch (Exception ex){
-	    	Vm.debug("Filecopy failed");
+	    	Vm.debug("Filecopy failed: "+sFileSrc+"=>"+sFileDst);
 	    }
 	}
 

Modified: trunk/src/exp/HTMLExporter.java
===================================================================
--- trunk/src/exp/HTMLExporter.java	2007-11-20 19:41:45 UTC (rev 1088)
+++ trunk/src/exp/HTMLExporter.java	2007-11-20 19:53:24 UTC (rev 1089)
@@ -127,7 +127,7 @@
 						page_tpl.setParam("DECRYPTEDHINTS", Common.rot13(holder.Hints));
 						dummy = new String();
 						for(int j = 0; j<holder.CacheLogs.size(); j++){
-							dummy = dummy + holder.CacheLogs.getLog(j).toHtml()+"<br>";
+							dummy = dummy + STRreplace.replace(holder.CacheLogs.getLog(j).toHtml(),"http://www.geocaching.com/images/icons/",null)+"<br>";
 						}
 						page_tpl.setParam("LOGS", dummy);
 						page_tpl.setParam("NOTES", STRreplace.replace(holder.CacheNotes, "\n","<br>"));



From pfeffer at mail.berlios.de  Sat Nov 24 15:43:41 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sat, 24 Nov 2007 15:43:41 +0100
Subject: [Cachewolf-svn] r1090 - trunk/src/CacheWolf/navi
Message-ID: <200711241443.lAOEhfwg009569@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-24 15:43:36 +0100 (Sat, 24 Nov 2007)
New Revision: 1090

Modified:
   trunk/src/CacheWolf/navi/MapInfoObject.java
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/MovingMap.java
   trunk/src/CacheWolf/navi/TrackOverlay.java
Log:
MovingMap: fix: Track not showing in map, note: still something wrong

Modified: trunk/src/CacheWolf/navi/MapInfoObject.java
===================================================================
--- trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-20 19:53:24 UTC (rev 1089)
+++ trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-24 14:43:36 UTC (rev 1090)
@@ -42,7 +42,7 @@
 
 	private double[] affine = {0,0,0,0};
 	private CWPoint affineTopleft = new CWPoint();;
-	public double transLatX, transLatY, transLonX, transLonY; // this are needed for the inervers calculation from lat/lon to x/y
+	private double transLatX, transLatY, transLonX, transLonY; // this are needed for the inervers calculation from lat/lon to x/y
 	public CWPoint center = new CWPoint();
 	public float sizeKm = 0; // diagonale
 	public float scale; // in meters per pixel, note: it is assumed that this scale identifying the scale of the map, automatically adjusted when zooming

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-20 19:53:24 UTC (rev 1089)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-24 14:43:36 UTC (rev 1090)
@@ -418,7 +418,7 @@
 		wms.load(in);
 		in.close();
 		String tmp = File.getFileExt(filename_);
-		this.filename = File.getFileExt(tmp).substring(0, tmp.lastIndexOf('.'));
+		this.filename = tmp.substring(0, tmp.lastIndexOf('.'));
 		name = wms.getProperty("Name", "").trim();
 		if (name == "") throw new IllegalArgumentException("WebMapService: property >Name:< missing in file:\n" + filename);
 		MainUrl = wms.getProperty("MainUrl", "").trim();;

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2007-11-20 19:53:24 UTC (rev 1089)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2007-11-24 14:43:36 UTC (rev 1090)
@@ -161,7 +161,7 @@
 		DistanceImage.setLocation(0, h - DistanceImage.getHeight());
 		ScaleImage.setLocation(w - ScaleImage.getWidth(), h - ScaleImage.getHeight());
 		if (mmp.mapImage != null) mmp.mapImage.screenDimChanged(); 
-		if (posCircle != null) posCircle.screenDimChanged(); 
+		if (posCircle != null) posCircle.screenDimChanged();
 		if (tracks != null) addOverlaySet();
 		for (int i = symbols.size() -1; i >= 0; i-- ) {
 			((MapSymbol)symbols.get(i)).screenDimChanged();

Modified: trunk/src/CacheWolf/navi/TrackOverlay.java
===================================================================
--- trunk/src/CacheWolf/navi/TrackOverlay.java	2007-11-20 19:53:24 UTC (rev 1089)
+++ trunk/src/CacheWolf/navi/TrackOverlay.java	2007-11-24 14:43:36 UTC (rev 1090)
@@ -33,8 +33,10 @@
 	public TrackOverlay (TrackPoint topLefti, int widthi, int highti, MapInfoObject transi) {
 		super();
 		topLeft = new TrackPoint(topLefti);
-		trans = transi;
-		bottomRight = calcLatLonInImage(widthi, highti);
+		trans = new MapInfoObject(transi);
+		Point pixelShift = trans.calcMapXY(topLeft);
+		trans.zoom(1, pixelShift.x, pixelShift.y);
+		bottomRight = trans.calcLatLon(widthi, highti);
 		if (ewe.sys.Vm.getPlatform().equalsIgnoreCase("java")) {
 			useTransparentColor = true; 
 			setImage(new Image(widthi, highti), transparentColorForOverlay); // java-vm: transparency with a mask is very memory consuming, but transparency with a mask is much faster in ewe-vm and doesn't consume more memory than a transparency color (ewe 1.49)
@@ -92,7 +94,7 @@
 			draw.setColor(tr.trackColor);
 			if (tr.num > 0) {
 				for (i=0; i < tr.num; i++) {
-					paintPoint(tr.trackColor, tr.TrackPoints[i].latDec, tr.TrackPoints[i].lonDec);
+					paintPoint(tr.trackColor, tr.TrackPoints[i]);
 				}
 			}
 		}
@@ -106,15 +108,12 @@
 	 * @param lon
 	 * @return true if point was on this overlay
 	 */
-	public boolean paintPoint(Color f, double lat, double lon){
-		if (lat<bottomRight.latDec || lat > topLeft.latDec || lon<topLeft.lonDec || lon>bottomRight.lonDec) return false;
+	public boolean paintPoint(Color f, TrackPoint where){
+		if (where.latDec < bottomRight.latDec || where.latDec > topLeft.latDec || where.lonDec < topLeft.lonDec || where.lonDec > bottomRight.lonDec) return false;
 		//ewe.sys.Vm.debug("showlastaddedpoint, lat: "+lat+"   lon: "+lon);
-		double b[] = new double[2];
-		int x, y;
-		b[0] = lat - topLeft.latDec; // see calcXYinImage (TrackPoint p) 
-		b[1] = lon - topLeft.lonDec; 
-		x=(int) (trans.transLatX* b[0] + trans.transLonX*b[1]);
-		y=(int) (trans.transLatY* b[0] + trans.transLonY*b[1]);
+		Point p = trans.calcMapXY(where);
+		int x = p.x;
+		int y = p.y;
 		//draw.drawLine(x, y, x, y);
 		//ewe.sys.Vm.debug("showlastaddedpoint, x: "+x+"   y: "+y+"loc.x: "+location.x+"  loc.y:"+location.y);
 		draw.fillRect(x-1, y-1, 3, 3);
@@ -153,22 +152,7 @@
 		trackPixelsColor = null;
 	}
 
-	public Point calcXYinImage (TrackPoint p) {
-		double b[] = new double[2]; // see method paintPoint it should actually call this method but it doesn't because of speed raesons
-		int x, y;
-		b[0] = p.latDec - topLeft.latDec;
-		b[1] = p.lonDec - topLeft.lonDec;
-		x=(int) (trans.transLatX* b[0] + trans.transLonX*b[1]);
-		y=(int) (trans.transLatY* b[0] + trans.transLonY*b[1]);
-		return new Point(x,y);
-	}
-
-	public TrackPoint calcLatLonInImage (double x, double y) {
-		// see trans.calcLatLon(p);
-		TrackPoint ll = new TrackPoint(trans.calcLatLon((int)x, (int)y)); 
-		return ll;
-	}
-
+	
 	public void addPixel(int x, int y, Color f) throws IndexOutOfBoundsException {
 		if (trackPixels==null) { trackPixels = new Point[maxPixelsInCache]; trackPixelsColor = new Color[maxPixelsInCache]; } 
 		trackPixels[numPixels] = new Point(x, y); // IndexOutOfBoundsException is handled in PaintPoint
@@ -193,7 +177,7 @@
 	public void paintLastAddedPoint(Track tr) { 
 		//draw.setPen(new Pen((Color) tr.trackColor,Pen.SOLID,3));
 		draw.setColor(tr.trackColor);
-		if (paintPoint(tr.trackColor, tr.TrackPoints[tr.num-1].latDec, tr.TrackPoints[tr.num-1].lonDec)) notOnThisOverlaySince = 0;
+		if (paintPoint(tr.trackColor, tr.TrackPoints[tr.num-1])) notOnThisOverlaySince = 0;
 		else notOnThisOverlaySince++;
 		if (notOnThisOverlaySince > FIXATE_IF_NO_PIXELS_NUM) { // zur Performanceverbesserung: wenn in den letzten 60 Updates keines mehr f?r dieses Overlay dabei war, Overlay Pixels fest schreiben, damit doDraw entlastet wird.
 			fixate();



From pfeffer at mail.berlios.de  Sat Nov 24 17:08:42 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sat, 24 Nov 2007 17:08:42 +0100
Subject: [Cachewolf-svn] r1091 - trunk/src/CacheWolf/navi
Message-ID: <200711241608.lAOG8giw016070@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-24 17:08:34 +0100 (Sat, 24 Nov 2007)
New Revision: 1091

Modified:
   trunk/src/CacheWolf/navi/MovingMap.java
Log:
MovingMap: fix the initial position of GPS-Pos ("something still wrong" in the last commit solved)

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2007-11-24 14:43:36 UTC (rev 1090)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2007-11-24 16:08:34 UTC (rev 1091)
@@ -1035,6 +1035,7 @@
 		case lostFix:   { posCircle.change(statusImageNoSignal); break; }
 		case noGPSData: { posCircle.change(statusImageNoGps); break; }
 		}
+		mapMoved(0, 0); // positions the posCircle correctly accourding to its size (which can change when the image changes, e.g. from null to something else 
 		posCircle.refreshNow();
 	}
 



From pfeffer at mail.berlios.de  Sat Nov 24 17:49:38 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sat, 24 Nov 2007 17:49:38 +0100
Subject: [Cachewolf-svn] r1092 - trunk/src/CacheWolf/navi
Message-ID: <200711241649.lAOGncbK019189@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-24 17:49:34 +0100 (Sat, 24 Nov 2007)
New Revision: 1092

Modified:
   trunk/src/CacheWolf/navi/MapLoader.java
Log:
WMS: when the loading of the .wms files takes longer than 100ms show an infobox

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-24 16:08:34 UTC (rev 1091)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-24 16:49:34 UTC (rev 1092)
@@ -49,7 +49,10 @@
 	 * @param wmspath without trailing "/"
 	 */
 	public MapLoader(String wmspath){
-		progressInfobox = null;
+		long start = new Time().getTime();
+		InfoBox progressBox = null;
+		boolean showprogress = false;
+
 		onlineMapServices = new Vector();
 		String dateien[];
 		FileBugfix files = new FileBugfix(wmspath);
@@ -60,6 +63,13 @@
 		for(int i = 0; i < dateien.length;i++){
 			FileName = dateien[i];
 			try {
+				if (!showprogress && ((i & 0) == 0) && (new Time().getTime()-start  > 100) ) { // reason for (i & 7 == 0): test time only after i is incremented 15 times
+					showprogress = true;      
+					progressBox = new InfoBox("Info", "Loading online map services");
+					progressBox.exec(); 
+					progressBox.waitUntilPainted(500);
+					ewe.sys.Vm.showWait(true);
+				}
 				tempOMS = new WebMapService(wmspath + "/" + FileName);
 				onlineMapServices.add(tempOMS);
 			}catch(Exception ex){ 
@@ -68,6 +78,10 @@
 		}
 		tempOMS = new ExpediaMapService();
 		onlineMapServices.add(tempOMS);
+		if (progressBox != null) {
+			progressBox.close(0);
+			ewe.sys.Vm.showWait(false);
+		}
 	}
 
 	public String[] getAvailableOnlineMapServices(){



From pfeffer at mail.berlios.de  Sat Nov 24 18:33:36 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sat, 24 Nov 2007 18:33:36 +0100
Subject: [Cachewolf-svn] r1093 - trunk/src/CacheWolf/navi
Message-ID: <200711241733.lAOHXatN030490@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-24 18:33:25 +0100 (Sat, 24 Nov 2007)
New Revision: 1093

Modified:
   trunk/src/CacheWolf/navi/TrackOverlay.java
Log:
MovingMap: fixed: Track was misplaced after zooming

Modified: trunk/src/CacheWolf/navi/TrackOverlay.java
===================================================================
--- trunk/src/CacheWolf/navi/TrackOverlay.java	2007-11-24 16:49:34 UTC (rev 1092)
+++ trunk/src/CacheWolf/navi/TrackOverlay.java	2007-11-24 17:33:25 UTC (rev 1093)
@@ -22,6 +22,7 @@
 	Graphics drawMask;
 	int test;
 	MapInfoObject trans; 
+	Point pixelShift;
 	public Vector tracks;
 	boolean imageChangesDontShow = false;
 	public Point trackPixels[] = null;
@@ -34,8 +35,7 @@
 		super();
 		topLeft = new TrackPoint(topLefti);
 		trans = new MapInfoObject(transi);
-		Point pixelShift = trans.calcMapXY(topLeft);
-		trans.zoom(1, pixelShift.x, pixelShift.y);
+		pixelShift = trans.calcMapXY(topLeft);
 		bottomRight = trans.calcLatLon(widthi, highti);
 		if (ewe.sys.Vm.getPlatform().equalsIgnoreCase("java")) {
 			useTransparentColor = true; 
@@ -112,8 +112,8 @@
 		if (where.latDec < bottomRight.latDec || where.latDec > topLeft.latDec || where.lonDec < topLeft.lonDec || where.lonDec > bottomRight.lonDec) return false;
 		//ewe.sys.Vm.debug("showlastaddedpoint, lat: "+lat+"   lon: "+lon);
 		Point p = trans.calcMapXY(where);
-		int x = p.x;
-		int y = p.y;
+		int x = p.x - pixelShift.x;
+		int y = p.y - pixelShift.y;
 		//draw.drawLine(x, y, x, y);
 		//ewe.sys.Vm.debug("showlastaddedpoint, x: "+x+"   y: "+y+"loc.x: "+location.x+"  loc.y:"+location.y);
 		draw.fillRect(x-1, y-1, 3, 3);



From pfeffer at mail.berlios.de  Sun Nov 25 00:09:20 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 25 Nov 2007 00:09:20 +0100
Subject: [Cachewolf-svn] r1094 - trunk/src/CacheWolf/navi
Message-ID: <200711242309.lAON9KNt026901@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-25 00:09:17 +0100 (Sun, 25 Nov 2007)
New Revision: 1094

Modified:
   trunk/src/CacheWolf/navi/TrackOverlay.java
Log:
MovingMap: Track didn't show up on small screens

Modified: trunk/src/CacheWolf/navi/TrackOverlay.java
===================================================================
--- trunk/src/CacheWolf/navi/TrackOverlay.java	2007-11-24 17:33:25 UTC (rev 1093)
+++ trunk/src/CacheWolf/navi/TrackOverlay.java	2007-11-24 23:09:17 UTC (rev 1094)
@@ -34,9 +34,9 @@
 	public TrackOverlay (TrackPoint topLefti, int widthi, int highti, MapInfoObject transi) {
 		super();
 		topLeft = new TrackPoint(topLefti);
-		trans = new MapInfoObject(transi);
+		trans = transi;
 		pixelShift = trans.calcMapXY(topLeft);
-		bottomRight = trans.calcLatLon(widthi, highti);
+		bottomRight = trans.calcLatLon(widthi + pixelShift.x, highti + pixelShift.y);
 		if (ewe.sys.Vm.getPlatform().equalsIgnoreCase("java")) {
 			useTransparentColor = true; 
 			setImage(new Image(widthi, highti), transparentColorForOverlay); // java-vm: transparency with a mask is very memory consuming, but transparency with a mask is much faster in ewe-vm and doesn't consume more memory than a transparency color (ewe 1.49)



From pfeffer at mail.berlios.de  Sun Nov 25 04:07:22 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 25 Nov 2007 04:07:22 +0100
Subject: [Cachewolf-svn] r1095 - trunk/src/CacheWolf
Message-ID: <200711250307.lAP37MCm000160@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-25 04:07:18 +0100 (Sun, 25 Nov 2007)
New Revision: 1095

Modified:
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/CacheHolderDetail.java
   trunk/src/CacheWolf/OCXMLImporter.java
Log:
Opencaching-Download: import speeded up by saving the cacheDetails only after every change in the details

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-24 23:09:17 UTC (rev 1094)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-25 03:07:18 UTC (rev 1095)
@@ -364,10 +364,9 @@
    
    public CacheHolderDetail getCacheDetails(boolean maybenew) {
 	   if (details != null) {
-		   details.update(this);
+		   details.update(this); // TODO is this logic? what happens if the details were changed and getDetails() is called afterwards all changes will be lost?!
 		   return details;
 	   }
-	   if (cachesWithLoadedDetails.size() >= Global.getPref().maxDetails) removeOldestDetails();
 	   details = new CacheHolderDetail(this);
 	   try {
 		   details.readCache(Global.getProfile().dataDir);
@@ -378,19 +377,37 @@
 			   return null;
 		   } 
 	   }
-	   cachesWithLoadedDetails.add(this);
+	   detailsAdded();
 	   return details;
    }
    
+   /**
+    * Call this after you added the cache with details to the 
+    * cacheDB <br> It is assumed that that details is set
+    * for an example see OCXMLImporter.endCache()
+    *
+    */
+   public void detailsAdded() {
+	   if (cachesWithLoadedDetails.size() >= Global.getPref().maxDetails) removeOldestDetails();
+	   cachesWithLoadedDetails.add(this);
+	   
+   }
+   
    public void releaseCacheDetails() {
+	   if (details != null && details.saveChanges) 
+		   details.saveCacheDetails(Global.getProfile().dataDir);
 	   details = null;
 	   cachesWithLoadedDetails.remove(this);
    }
    
+   public void cacheAdded(CacheHolderDetail chd) {
+	   
+   }
+   
    //final static int maxDetails = 50; 
    static Vector cachesWithLoadedDetails = new Vector(Global.getPref().maxDetails);
    
-   public static void removeOldestDetails() { // TODO save changes if requested?
+   public static void removeOldestDetails() {
 	   for (int i=0; i<Global.getPref().deleteDetails; i++)
 		   ((CacheHolder)(cachesWithLoadedDetails.get(0))).releaseCacheDetails();
    }
@@ -399,7 +416,23 @@
 	   for (int i=cachesWithLoadedDetails.size()-1; i>=0; i--)
 		   ((CacheHolder)(cachesWithLoadedDetails.get(0))).releaseCacheDetails();
    }
-/*
+   
+   /**
+    * when importing caches you can set details.saveChanges = true
+    * when the import ist finished call this method to save the pending changes
+    *
+    */
+   public static void saveAllModifiedDetails() {
+	   CacheHolderDetail chD;
+	   for (int i=cachesWithLoadedDetails.size()-1; i>=0; i--) {
+		   chD = ((CacheHolder)(cachesWithLoadedDetails.get(i))).getCacheDetails(false);
+		   if (chD.saveChanges) 
+			   chD.saveCacheDetails(Global.getProfile().dataDir);
+		   	
+	   }
+   }
+
+   /*
 public void finalize() {nObjects--;
    Vm.debug("Destroying CacheHolder "+wayPoint);
    Vm.debug("CacheHolder: "+nObjects+" objects left");

Modified: trunk/src/CacheWolf/CacheHolderDetail.java
===================================================================
--- trunk/src/CacheWolf/CacheHolderDetail.java	2007-11-24 23:09:17 UTC (rev 1094)
+++ trunk/src/CacheWolf/CacheHolderDetail.java	2007-11-25 03:07:18 UTC (rev 1095)
@@ -29,6 +29,9 @@
 	  //public String Bugs = EMPTY; Superceded by Travelbugs
 	  public String URL = EMPTY;
 	  public String Solver = EMPTY;
+	  /** For faster cache import (from opencaching) changes are only written when the details are freed from memory 
+	   * If you want to save the changes automatically when the details are unloaded, set this to true */ 
+	  public boolean saveChanges = false;
 	  
 	 public CacheHolderDetail() {
 	 }
@@ -234,7 +237,6 @@
 		*/
 		public void saveCacheDetails(String dir){
 			PrintWriter detfile;
-			String dummy = new String();
 			//File exists?
 			boolean exists = (new File(dir + wayPoint + ".xml")).exists();
 			//yes: then delete
@@ -316,6 +318,7 @@
 			} catch (Exception e){
 			  //Vm.debug("Problem closing details file");
 			}
+			saveChanges = false;
 		}
 		
 		/**

Modified: trunk/src/CacheWolf/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2007-11-24 23:09:17 UTC (rev 1094)
+++ trunk/src/CacheWolf/OCXMLImporter.java	2007-11-25 03:07:18 UTC (rev 1095)
@@ -185,6 +185,7 @@
 			finalMessage = MyLocale.getMsg(1607,"Update from opencaching successful");
 			inf.setInfo(finalMessage);
 		}
+		CacheHolder.saveAllModifiedDetails();
 		profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR);
 		inf.addOkButton();
 	}
@@ -388,10 +389,6 @@
 		}
 
 	}
-	private boolean fileExits(String filename) {
-		File myfile = new File(filename);
-		return myfile.exists();
-	}
 
 	private void endCache(String name){
 		if (name.equals("cache")){
@@ -400,7 +397,10 @@
 			index = searchWpt(chD.wayPoint);
 			if (index == -1){
 				chD.is_new = true;
-				cacheDB.add(new CacheHolder(chD));
+				CacheHolder ch = new CacheHolder(chD);
+				ch.details = chD;
+				cacheDB.add(ch);
+				ch.detailsAdded();
 				DBindexWpt.put((String)chD.wayPoint, new Integer(cacheDB.size()-1));
 				DBindexID.put((String)chD.ocCacheID, new Integer(cacheDB.size()-1));
 			}
@@ -419,7 +419,8 @@
 			}
 
 			// save all
-			chD.saveCacheDetails(profile.dataDir); 
+			chD.saveChanges = true; // this makes CachHolder save the details in case that they are unloaded from memory
+			// chD.saveCacheDetails(profile.dataDir); 
 			// profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR); // this is done after .xml is completly processed
 			return;
 		}
@@ -497,7 +498,7 @@
 						getPic(fetchUrl, imgAltText);
 					}
 				}
-				chD.saveCacheDetails(profile.dataDir);
+				chD.saveChanges = true; //saveCacheDetails(profile.dataDir);
 				return;
 			}
 
@@ -580,7 +581,7 @@
 		if(name.equals("picture")){ 
 			//String fileName = holder.wayPoint + "_" + picUrl.substring(picUrl.lastIndexOf("/")+1);
 			getPic(picUrl,picTitle);
-			chD.saveCacheDetails(profile.dataDir);
+			chD.saveChanges = true; //saveCacheDetails(profile.dataDir);
 			return;
 		}
 	}
@@ -589,7 +590,7 @@
 		if (name.equals("cachelog")){ // </cachelog>
 			chD.CacheLogs.merge(new Log(logIcon,logDate,logFinder,logData));
 			//TODO Optimize this. Currently the cache needs to be saved after every log as we don't know whether the next log is for the same cache.
-			chD.saveCacheDetails(profile.dataDir);
+			chD.saveChanges = true; //chD.saveCacheDetails(profile.dataDir);
 			return;
 		}
 
@@ -712,17 +713,16 @@
 		int index;
 		
 		index = searchWpt(wpt);
-		if (index==-1) index = searchID(wpt);
-		if (index == -1){
+		if (index ==-1) index = searchID(wpt);
+		if (index == -1) {
 			chD = new CacheHolderDetail();
-			//chD.wayPoint = wpt;
 			return chD;
 		}
-		chD = new CacheHolderDetail((CacheHolder) cacheDB.get(index));
-		try {
+		chD = ((CacheHolder) cacheDB.get(index)).getCacheDetails(true);
+/*		try {
 			chD.readCache(profile.dataDir);
 		} catch (Exception e) {Vm.debug("Could not open file: " + e.toString());};
-		return chD;
+	*/	return chD;
 	}
 
 



From kalli at mail.berlios.de  Sun Nov 25 11:48:44 2007
From: kalli at mail.berlios.de (kalli at mail.berlios.de)
Date: Sun, 25 Nov 2007 11:48:44 +0100
Subject: [Cachewolf-svn] r1096 - in trunk/src/CacheWolf: . navi
Message-ID: <200711251048.lAPAmio7002595@sheep.berlios.de>

Author: kalli
Date: 2007-11-25 11:48:37 +0100 (Sun, 25 Nov 2007)
New Revision: 1096

Modified:
   trunk/src/CacheWolf/GPSPortOptions.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/navi/CWGPSPoint.java
   trunk/src/CacheWolf/navi/GotoPanel.java
Log:
Logging of GPS data: Enable/disable and timer in GPS preference screen, only logging of valid NMEA sentences.

Modified: trunk/src/CacheWolf/GPSPortOptions.java
===================================================================
--- trunk/src/CacheWolf/GPSPortOptions.java	2007-11-25 03:07:18 UTC (rev 1095)
+++ trunk/src/CacheWolf/GPSPortOptions.java	2007-11-25 10:48:37 UTC (rev 1096)
@@ -81,6 +81,9 @@
 	public mInput inputBoxForwardHost;
 	mLabel  labelForwardHost;
 	public mCheckBox forwardGpsChkB;
+	public mInput inputBoxLogTimer;
+	mLabel  labelLogTimer;
+	public mCheckBox logGpsChkB;
 	mySerialThread serThread;
 	boolean gpsRunning = false;
 
@@ -104,6 +107,15 @@
 		inputBoxForwardHost.setText("192.168.178.23");
 		inputBoxForwardHost.setToolTip("All data from GPS will be sent to TCP-port 23\n and can be redirected there to a serial port\n by HW Virtual Serial Port");
 		ed.addField(ed.addLast(inputBoxForwardHost,0 , (Editor.WEST | Editor.HFILL)), "tcpForwardHost");
+		logGpsChkB = new mCheckBox("z");
+		ed.addField(ed.addNext(logGpsChkB, Editor.DONTSTRETCH, (Editor.WEST | Editor.DONTFILL)), "logGpsChkB");
+		labelLogTimer = new mLabel("Interval in sec for logging");
+		ed.addField(ed.addNext(labelLogTimer, Editor.DONTSTRETCH, (Editor.WEST | Editor.DONTFILL)), "labelLogTimer");
+		inputBoxLogTimer = new mInput("GPSLogTimer");
+		inputBoxLogTimer.setPromptControl(labelLogTimer);
+		inputBoxLogTimer.setText("10");
+		ed.addField(ed.addLast(inputBoxLogTimer,0 , (Editor.WEST | Editor.HFILL)), "GPSLogTimer");
+
 		
 		gpsRunning = false;
 		return ed;

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-25 03:07:18 UTC (rev 1095)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-25 10:48:37 UTC (rev 1096)
@@ -83,6 +83,10 @@
 	public boolean forwardGPS = false;
 	/** IP address for forwarding GPS data */
 	public String forwardGpsHost = "";
+	/** True if the GPS data should be logged to a file */
+	public boolean logGPS = false;
+	/** Timer for logging GPS data */
+	public String logGPSTimer = "";
 	/** The default font size */
 	public int fontSize = 12;
 	// These settings govern where the menu and the tabs are displayed and whether the statusbas is shown
@@ -219,6 +223,10 @@
 			forwardGPS = Convert.toBoolean(atts.getValue("active"));
 			forwardGpsHost = atts.getValue("destinationHost");
 		}
+		if(name.equals("portlog")) {
+			logGPS = Convert.toBoolean(atts.getValue("active"));
+			logGPSTimer = atts.getValue("logTimer");
+		}
 		if (name.equals("lastprofile")) {
 			collectElement=new StringBuffer(50);
 			if (atts.getValue("autoreload").equals("true")) autoReloadLastProfile=true;
@@ -334,6 +342,7 @@
 			outp.print("	<proxy prx = \""+ myproxy+"\" prt = \""+ myproxyport + "\" active = \""+ proxyActive +"\" />\n");
 			outp.print("	<port portname = \""+ mySPO.portName +"\" baud = \""+ mySPO.baudRate+"\"/>\n");
 			outp.print("	<portforward active= \""+ Convert.toString(forwardGPS)+"\" destinationHost = \""+ forwardGpsHost+"\"/>\n");
+			outp.print("	<portlog active= \""+ Convert.toString(logGPS)+"\" logTimer = \""+ logGPSTimer +"\"/>\n");
 			outp.print("    <font size =\""+fontSize+"\"/>\n");
 			outp.print("    <screen menuattop=\""+menuAtTop+"\" tabsattop=\""+tabsAtTop+"\" showstatus=\""+showStatus+"\" hasclosebutton=\""+hasCloseButton+"\"/>\n");
 			outp.print("    <fixedsip state = \""+fixSIP+"\"/>\n");

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-11-25 03:07:18 UTC (rev 1095)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-11-25 10:48:37 UTC (rev 1096)
@@ -272,14 +272,17 @@
 				Editor s = spo.getEditor(SerialPortOptions.ADVANCED_EDITOR);
 				spo.forwardGpsChkB.setState(pref.forwardGPS);
 				spo.inputBoxForwardHost.setText(pref.forwardGpsHost);
+				spo.logGpsChkB.setState(pref.logGPS);
+				spo.inputBoxLogTimer.setText(pref.logGPSTimer);
 				Gui.setOKCancel(s);
 				if (s.execute()== Editor.IDOK) {
 					pref.mySPO.portName = spo.portName; 
 					pref.mySPO.baudRate = spo.baudRate;
 					pref.forwardGPS = spo.forwardGpsChkB.getState();
 					pref.forwardGpsHost = spo.inputBoxForwardHost.getText();
+					pref.logGPS = spo.logGpsChkB.getState();
+					pref.logGPSTimer = spo.inputBoxLogTimer.getText();
 					inpGPS.setText(pref.mySPO.portName+"/"+pref.mySPO.baudRate);
-
 				}
 			}
 			// change destination waypoint

Modified: trunk/src/CacheWolf/navi/CWGPSPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/CWGPSPoint.java	2007-11-25 03:07:18 UTC (rev 1095)
+++ trunk/src/CacheWolf/navi/CWGPSPoint.java	2007-11-25 10:48:37 UTC (rev 1096)
@@ -182,13 +182,13 @@
 			end = 0;
 			lastStrExamined = NMEA;
 			//Vm.debug(NMEA);
-			if (writeLog && (logFlag & LOGRAW) > 0){ 
+/*			if (writeLog && (logFlag & LOGRAW) > 0){ 
 				try {
 					logFile.write(NMEA);
 					writeLog = false;
 				} catch (IOException e) {}
 			}
-			while(true){
+*/			while(true){
 				start = NMEA.indexOf("$GP", end);  
 				if (start == -1) return interpreted;  
 				end = NMEA.indexOf("*", start);  
@@ -200,6 +200,14 @@
 					//Vm.debug("checksum wrong");
 					continue;
 				}
+				// Write log after finding valid NMEA sequence 
+				if (writeLog && (logFlag & LOGRAW) > 0){ 
+					try {
+						logFile.write(NMEA.substring(start,end+3)+"\n");
+						writeLog = false;
+					} catch (IOException e) {}
+				}
+
 				Extractor ex = new Extractor ("," + NMEA.substring(start,end), ",",",",0,true);
 				currToken = ex.findNext();
 				if (currToken.equals("$GPGGA")){

Modified: trunk/src/CacheWolf/navi/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/navi/GotoPanel.java	2007-11-25 03:07:18 UTC (rev 1095)
+++ trunk/src/CacheWolf/navi/GotoPanel.java	2007-11-25 10:48:37 UTC (rev 1096)
@@ -275,7 +275,7 @@
 	}
 	
 	public void startGps() {
-		myNavigation.setRawLogging(chkLog.getState(), Convert.toInt(inpLogSeconds.getText()));
+		myNavigation.setRawLogging(pref.logGPS, Convert.toInt(pref.logGPSTimer));
 		myNavigation.startGps();
 	}
 



From salzkammergut at mail.berlios.de  Sun Nov 25 15:12:34 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 25 Nov 2007 15:12:34 +0100
Subject: [Cachewolf-svn] r1097 - trunk/src/CacheWolf
Message-ID: <200711251412.lAPECY5H026770@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-25 15:12:16 +0100 (Sun, 25 Nov 2007)
New Revision: 1097

Modified:
   trunk/src/CacheWolf/MyComparer.java
   trunk/src/CacheWolf/myTableModel.java
Log:
ListView: Added sorter for cache size and tidied up the sorter.

Modified: trunk/src/CacheWolf/MyComparer.java
===================================================================
--- trunk/src/CacheWolf/MyComparer.java	2007-11-25 10:48:37 UTC (rev 1096)
+++ trunk/src/CacheWolf/MyComparer.java	2007-11-25 14:12:16 UTC (rev 1097)
@@ -9,76 +9,61 @@
 *	@see DistComparer
 */
 public class MyComparer implements Comparer{
-	String compareWhat;
-	String nmQuest, nmD,nmT,nmWay,nmName,nmLoc,nmOwn,nmHid,nmStat,nmDist,nmBear = new String();
-	int visibleSize;
 	Vector cacheDB;
 	
-	public MyComparer(Vector cacheDB, String what, int visibleSize){
-		compareWhat = what;
-		nmQuest = "?";
-		nmD = MyLocale.getMsg(1000,"D");
-		nmT = MyLocale.getMsg(1001,"T");
-		nmWay = MyLocale.getMsg(1002,"Waypoint");
-		nmName = MyLocale.getMsg(1003,"Name");
-		nmLoc = MyLocale.getMsg(1004,"Location");
-		nmOwn = MyLocale.getMsg(1005,"Owner");
-		nmHid = MyLocale.getMsg(1006,"Hidden");
-		nmStat = MyLocale.getMsg(1007,"Status");
-		nmDist = MyLocale.getMsg(1008,"Dist");
-		nmBear = MyLocale.getMsg(1009,"Bear");
+	public MyComparer(Vector cacheDB, int colToCompare, int visibleSize){
 		//visibleSize=Global.mainTab.tbP.myMod.numRows;
 		if (visibleSize<2) return;
 		for (int i=visibleSize; i<cacheDB.size(); i++) {
 			CacheHolder ch=(CacheHolder) cacheDB.get(i);
 			ch.sort="\uFFFF";
 		}
-		if (what.equals(nmQuest)) {
+		if (colToCompare==1) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.type;
 			}
-		} else if (what.equals(nmD)) {
+		} else if (colToCompare==2) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.hard;
 			}
-		} else if (what.equals(nmT)) {
+		} else if (colToCompare==3) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.terrain;
 			}
-		} else if (what.equals(nmWay)) {
+		} else if (colToCompare==4) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.wayPoint.toUpperCase();
 			}
-		} else if (what.equals(nmName)) {
+		} else if (colToCompare==5) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.CacheName.toLowerCase();
 			}
-		} else if (what.equals(nmLoc)) {
+		} else if (colToCompare==6) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.LatLon;
 			}
-		} else if (what.equals(nmOwn)) {
+		} else if (colToCompare==7) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.CacheOwner.toLowerCase();
 			}
-		} else if (what.equals(nmHid)) {
+		} else if (colToCompare==8) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.DateHidden;
 			}
-		} else if (what.equals(nmStat)) {
+		} else if (colToCompare==9) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.CacheStatus;
 			}
-		} else if (what.equals(nmDist)) {
+		} else if (colToCompare==10) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				int p=ch.distance.indexOf(",");
@@ -88,12 +73,26 @@
 				else
 					ch.sort=ch.distance;
 			}
-		} else if (what.equals(nmBear)) {
+		} else if (colToCompare==11) {
 			for (int i=0; i<visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
 				ch.sort=ch.bearing;
 			}
 			
+		} else if (colToCompare==12) {
+			for (int i=0; i<visibleSize; i++) {
+				CacheHolder ch=(CacheHolder) cacheDB.get(i);
+				if (ch.CacheSize.length()==0) ch.sort="?";
+				else switch (ch.CacheSize.charAt(0)) {
+					case 'M': ch.sort="1"; break;
+					case 'S': ch.sort="2"; break;
+					case 'R': ch.sort="3"; break;
+					case 'L': ch.sort="4"; break; 
+					case 'V': ch.sort="5"; break;
+					default: ch.sort="?";
+				}
+			}
+			
 		}
 	}
 	

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2007-11-25 10:48:37 UTC (rev 1096)
+++ trunk/src/CacheWolf/myTableModel.java	2007-11-25 14:12:16 UTC (rev 1097)
@@ -52,6 +52,7 @@
 	/** The row of the last click where the shift key was pressed */
 //	private int lastRow=-1;
 	private myTableControl tcControl;
+	public boolean showExtraWptInfo=true;
 	
 	public myTableModel(myTableControl tc, FontMetrics fm){
 		super();
@@ -231,71 +232,71 @@
 	}
 
 	public Object getCellData(int row, int col){
-		if(row == -1) {
-			return (String)colName[colMap[col]];
-		} else {
-			try { // Access to row can fail if many caches are deleted
-				CacheHolder ch = (CacheHolder)cacheDB.get(row);
-				if(ch.is_filtered == false){
-					switch(colMap[col]) { // Faster than using column names
-						case 0: // Checkbox
-							if (ch.is_Checked) 
-								return checkboxTicked; 
-							else 
-								return checkboxUnticked;
-						case 1: // Type
-							try {
-								return (IImage) cacheImages[Convert.parseInt(ch.type)]; // TODO save in cacheholder as int
-							} catch (NumberFormatException e) { return "?";}
-						case 2: // Difficulty;
-							return (String)ch.hard;
-						case 3: // Terrain
-							return (String)ch.terrain;
-						case 4: // Waypoint
+		if(row == -1) return colName[colMap[col]];
+		try { // Access to row can fail if many caches are deleted
+			CacheHolder ch = (CacheHolder)cacheDB.get(row);
+			if(ch.is_filtered == false){
+				switch(colMap[col]) { // Faster than using column names
+					case 0: // Checkbox
+						if (ch.is_Checked) 
+							return checkboxTicked; 
+						else 
+							return checkboxUnticked;
+					case 1: // Type
+						try {
+							return (IImage) cacheImages[Convert.parseInt(ch.type)]; // TODO save in cacheholder as int
+						} catch (NumberFormatException e) { return "?";}
+					case 2: // Difficulty;
+						return ch.hard;
+					case 3: // Terrain
+						return ch.terrain;
+					case 4: // Waypoint
+						if (showExtraWptInfo) {
 							if(ch.is_incomplete) return new IconAndText(skull, ch.wayPoint, fm);
 							if(ch.is_new       ) return new IconAndText(yellow, ch.wayPoint, fm);
 							if(ch.is_update    ) return new IconAndText(red, ch.wayPoint, fm); // TODO this is for sure quite inefficient, better store it, don't create always new when the table is refreshed or only scrolled
 							if(ch.is_log_update) return new IconAndText(blue, ch.wayPoint, fm);
-							return (String)ch.wayPoint;
-						case 5: // Cachename
-							// Fast return for majority of case
-							if (ch.has_bug == false && ch.noFindLogs==0) return (String)ch.CacheName; 
-							// Now need more checks
-							IconAndText wpVal = new IconAndText();
-							if(ch.has_bug == true) wpVal.addColumn(bug);
-							if(ch.noFindLogs > 0){
-								if (ch.noFindLogs > noFindLogs.length) 
-									wpVal.addColumn((IImage)noFindLogs[noFindLogs.length-1]);
-								else 
-									wpVal.addColumn((IImage)noFindLogs[ch.noFindLogs-1]);
-							}
-							wpVal.addColumn((String)ch.CacheName);
-							return wpVal;
-						case 6: // Location
-							return (String)ch.LatLon;
-						case 7: // Owner
-							return (String)ch.CacheOwner;
-						case 8: // Date hidden
-							return (String)ch.DateHidden;
-						case 9: // Status
-							return (String)ch.CacheStatus;
-						case 10: // Distance
-							return (String)ch.distance;
-						case 11: // Bearing
-							return (String)ch.bearing;
-						case 12: // Size
-							switch (ch.CacheSize.charAt(0)) {
-								case 'M': return picSizeMicro;
-								case 'S': return picSizeSmall;
-								case 'R': return picSizeReg;
-								case 'L': return picSizeLarge;
-								case 'V': return picSizeVLarge;
-								default: return "?";
-							}
-					} // Switch
-				} // if
-			} catch (Exception e) { return null; }
-		}
+						}
+						return ch.wayPoint;
+					case 5: // Cachename
+						// Fast return for majority of case
+						if (ch.has_bug == false && ch.noFindLogs==0) return ch.CacheName; 
+						// Now need more checks
+						IconAndText wpVal = new IconAndText();
+						if(ch.has_bug == true) wpVal.addColumn(bug);
+						if(ch.noFindLogs > 0){
+							if (ch.noFindLogs > noFindLogs.length) 
+								wpVal.addColumn(noFindLogs[noFindLogs.length-1]);
+							else 
+								wpVal.addColumn(noFindLogs[ch.noFindLogs-1]);
+						}
+						wpVal.addColumn(ch.CacheName);
+						return wpVal;
+					case 6: // Location
+						return ch.LatLon;
+					case 7: // Owner
+						return ch.CacheOwner;
+					case 8: // Date hidden
+						return ch.DateHidden;
+					case 9: // Status
+						return ch.CacheStatus;
+					case 10: // Distance
+						return ch.distance;
+					case 11: // Bearing
+						return ch.bearing;
+					case 12: // Size
+						if (ch.CacheSize.length()==0) return "?";
+						switch (ch.CacheSize.charAt(0)) {
+							case 'M': return picSizeMicro;
+							case 'S': return picSizeSmall;
+							case 'R': return picSizeReg;
+							case 'L': return picSizeLarge;
+							case 'V': return picSizeVLarge;
+							default: return "?";
+						}
+				} // Switch
+			} // if
+		} catch (Exception e) { return null; }
 		return null;
 	}
 	
@@ -329,7 +330,7 @@
 				if (mappedCol == sortedBy) sortAsc=!sortAsc;
 				else sortAsc = false;
 				sortedBy = mappedCol;
-				cacheDB.sort(new MyComparer(cacheDB, colName[mappedCol],numRows), sortAsc);
+				cacheDB.sort(new MyComparer(cacheDB, mappedCol,numRows), sortAsc);
 				updateRows();
 				if(a != null){
 					int rownum = Global.getProfile().getCacheIndex(ch.wayPoint);



From pfeffer at mail.berlios.de  Sun Nov 25 15:39:44 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 25 Nov 2007 15:39:44 +0100
Subject: [Cachewolf-svn] r1098 - trunk/src/CacheWolf
Message-ID: <200711251439.lAPEdiAD002603@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-25 15:39:40 +0100 (Sun, 25 Nov 2007)
New Revision: 1098

Modified:
   trunk/src/CacheWolf/CacheHolder.java
Log:
OpenCaching download: preperation for showing the recommendation in the logs @Salzkammergut: please use recommendationScore and numRecommended for 2 new coloumns

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-25 14:12:16 UTC (rev 1097)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-25 14:39:40 UTC (rev 1098)
@@ -76,6 +76,12 @@
 public String ocCacheID = EMPTY;
 /** The number of times this cache has not been found (max. 5) */
 public int noFindLogs = 0;
+/** Number of recommendations (from the opencaching logs) */
+public int numRecommended = 0;
+/** Number of logs since start of recommendations system */
+public int numLogsSinceRecommendation = 0;
+/** Recommendation score: calculated as rations  numRecommended / numLogsSinceRecommendation  */
+public float recommendationScore = 0;
 /** True if this cache has travelbugs */
 public boolean has_bug = false;
 /** True if the cache description is stored in HTML format */



From pfeffer at mail.berlios.de  Sun Nov 25 16:02:20 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 25 Nov 2007 16:02:20 +0100
Subject: [Cachewolf-svn] r1099 - trunk/src/CacheWolf
Message-ID: <200711251502.lAPF2Kf3010514@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-25 16:02:11 +0100 (Sun, 25 Nov 2007)
New Revision: 1099

Modified:
   trunk/src/CacheWolf/CacheHolderDetail.java
   trunk/src/CacheWolf/Log.java
   trunk/src/CacheWolf/OCXMLImporter.java
   trunk/src/CacheWolf/OCXMLImporterScreen.java
   trunk/src/CacheWolf/Profile.java
   trunk/src/CacheWolf/myTableControl.java
Log:
Download from opencaching: import recommendation and show according star in the logs, pending: transfer the information into cacheholder

Modified: trunk/src/CacheWolf/CacheHolderDetail.java
===================================================================
--- trunk/src/CacheWolf/CacheHolderDetail.java	2007-11-25 14:39:40 UTC (rev 1098)
+++ trunk/src/CacheWolf/CacheHolderDetail.java	2007-11-25 15:02:11 UTC (rev 1099)
@@ -154,7 +154,7 @@
 			ex = new Extractor(text, "<LOGS>","</LOGS>", 0, true);
 			dummy = ex.findNext();
 			CacheLogs.clear();
-			ex = new Extractor(dummy, "<LOG><![CDATA[","]]></LOG>", 0, true);
+			ex = new Extractor(dummy, "<LOG>","</LOG>", 0, true);
 			
 			dummy = ex.findNext();
 			while(ex.endOfSearch()==false){

Modified: trunk/src/CacheWolf/Log.java
===================================================================
--- trunk/src/CacheWolf/Log.java	2007-11-25 14:39:40 UTC (rev 1098)
+++ trunk/src/CacheWolf/Log.java	2007-11-25 15:02:11 UTC (rev 1099)
@@ -11,16 +11,21 @@
 	private String logger;
 	/** The logged message */
 	private String message;
+	/** true, if the logger recommended the cache */
+	private boolean recommended = false;
 	
 	/** Create a log from a single line in format<br>
-	 * <pre><img src='ICON'>&nbsp;DATE LOGGER<br>MESSAGE
+	 * <pre>RECOMMENDED="1"<img src='ICON'>&nbsp;DATE LOGGER<br>MESSAGE
 	 * or <img src='ICON'>&nbsp;DATE by LOGGER<br>MESSAGE</pre>
 	 * @param logLine
 	 */
 	Log(String logLine) {
-//		<img src='icon_smile.gif'>&nbsp;2007-01-14 xyz<br>a wonderful log
+//		RECOMMENDED="1"<img src='icon_smile.gif'>&nbsp;2007-01-14 xyz<br>a wonderful log
 		try {
-			int ic1=logLine.indexOf("<img src='");
+			int ic1=logLine.indexOf("RECOMMENDED=\"1\"");
+			if (ic1 >= 0) 
+				recommended = true; else recommended = false;
+			ic1=logLine.indexOf("<img src='");
 			int ic2=logLine.indexOf("'",ic1+10);
 			icon=logLine.substring(ic1+10,ic2);
 			int d1=logLine.indexOf(";");
@@ -29,7 +34,7 @@
 			if (logLine.substring(l1,l1+3).equals("by ")) l1+=3;
 			int l2=logLine.indexOf("<br>",l1);
 			logger=logLine.substring(l1,l2);
-			message=logLine.substring(l2+4);
+			message=logLine.substring(l2+4, logLine.indexOf("]]>", l1));
 		} catch (Exception ex) {
 			if (logLine.indexOf("<img")<0) { // Have we reached the line that states max logs reached 
 				icon=MAXLOGICON; 
@@ -43,10 +48,15 @@
 	}
 	
 	Log(String icon, String date, String logger, String message) {
+		this(icon, date, logger, message, false);
+	}
+	
+	Log(String icon, String date, String logger, String message, boolean recommended_) {
 		this.icon=icon;
 		this.date=date;
 		this.logger=logger;
 		this.message=message.trim();
+		this.recommended = recommended_;
 	}
 	
 	public static Log maxLog() {
@@ -77,13 +87,20 @@
 	public void setMessage(String message) {
 		this.message = message.trim();
 	}
+	public void setRecommandation (boolean recommended_) {
+		recommended = recommended_;
+	}
 
 	/** Return XML representation of log for storing in cache.xml */
 	public String toXML(){
 		StringBuffer s=new StringBuffer(400);
-		s.append("<LOG><![CDATA[");
+		s.append("<LOG>");
+		if (recommended)
+			s.append("RECOMMENDED=\"1\"");
+		s.append("<![CDATA[");
 		s.append(toHtml());
-		s.append("]]></LOG>\r\n");
+		s.append("]]>)");
+		s.append("</LOG>\r\n");
 		return s.toString();
 	}
 	
@@ -92,9 +109,9 @@
 //		<img src='icon_smile.gif'>&nbsp;2007-01-14 xyz<br>a wonderful log
 		if (icon.equals(MAXLOGICON)) return "<hr>"+MyLocale.getMsg(736,"Too many logs")+"<hr>";
 		StringBuffer s=new StringBuffer(300);
-		s.append("<img src='");
-		s.append(icon);
-		s.append("'>&nbsp;");
+		s.append("<img src='"+icon+"'>");
+		if (recommended) s.append("<img src='recommendedlog.gif'>");
+		s.append("&nbsp;");
 		s.append(date);
 		s.append(" by ");
 		s.append(logger);

Modified: trunk/src/CacheWolf/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2007-11-25 14:39:40 UTC (rev 1098)
+++ trunk/src/CacheWolf/OCXMLImporter.java	2007-11-25 15:02:11 UTC (rev 1099)
@@ -52,6 +52,7 @@
 	String cacheID = new String();
 
 	String logData, logIcon, logDate, logFinder;
+	boolean loggerRecommended;
 	int logtype;
 	String user;
 	double longitude;
@@ -76,18 +77,30 @@
 		}//for
 
 	}
-	
+	/**
+	 * 
+	 * @param number
+	 * @param infB
+	 * @return true, if some change was made to the cacheDB
+	 */
+	/** true, if not the last syncdate shall be used, but the caches shall be reloaded
+	 * only used in syncSingle */
+	boolean reload;
 	public boolean syncSingle(int number, InfoBox infB) {
 		boolean success=true;
 
 		ch = (CacheHolder)cacheDB.get(number);
-		chD= new CacheHolderDetail(ch);
+		chD= new CacheHolderDetail(ch); //TODO is this still correct? use getDetails ?
 
-		if (infB.isClosed) return false; 
+		if (infB.isClosed) {
+			if (askForOptions) return false; 
+			else return true;
+		}
 		if (askForOptions) {
-			OCXMLImporterScreen importOpt = new OCXMLImporterScreen( MyLocale.getMsg(1600, "Opencaching.de Download"),OCXMLImporterScreen.IMAGES);
+			OCXMLImporterScreen importOpt = new OCXMLImporterScreen( MyLocale.getMsg(1600, "Opencaching.de Download"),OCXMLImporterScreen.IMAGES | OCXMLImporterScreen.ALL);
 			if (importOpt.execute() == OCXMLImporterScreen.IDCANCEL) {	return false; }
 			askForOptions = false;
+			reload = importOpt.missingCheckBox.getState();
 		}
 
 		// this is only a dummy-InfoBox for capturing the output
@@ -96,10 +109,12 @@
 //		inf.relayout(false);
 //		inf.exec();
 
-		
-		String lastS = ch.lastSyncOC;
-		if (lastS.length() < 14) lastS = "20050801000000";
-
+		String lastS; 
+		if (reload)  lastS = "20050801000000";
+		else {
+			if (ch.lastSyncOC.length() < 14) lastS = "20050801000000";
+			else lastS = ch.lastSyncOC;
+		}
 		dateOfthisSync = new Time();
 		dateOfthisSync.parse(lastS, "yyyyMMddHHmmss");
 	
@@ -385,6 +400,7 @@
 			break;
 			case 3: logIcon = GPXImporter.typeText2Image("Note");
 			}
+			loggerRecommended = atts.getValue("recommended").equals("1");
 			return;
 		}
 
@@ -588,8 +604,7 @@
 
 	private void endCacheLog(String name){
 		if (name.equals("cachelog")){ // </cachelog>
-			chD.CacheLogs.merge(new Log(logIcon,logDate,logFinder,logData));
-			//TODO Optimize this. Currently the cache needs to be saved after every log as we don't know whether the next log is for the same cache.
+			chD.CacheLogs.merge(new Log(logIcon, logDate, logFinder, logData, loggerRecommended));
 			chD.saveChanges = true; //chD.saveCacheDetails(profile.dataDir);
 			return;
 		}

Modified: trunk/src/CacheWolf/OCXMLImporterScreen.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporterScreen.java	2007-11-25 14:39:40 UTC (rev 1098)
+++ trunk/src/CacheWolf/OCXMLImporterScreen.java	2007-11-25 15:02:11 UTC (rev 1099)
@@ -29,10 +29,6 @@
 		super();
 		pref = Global.getPref(); // myPreferences sollte sp?ter auch diese Einstellungen speichern
 		
-		switch (options){
-		
-		}
-
 		this.title = title;
 		if ((options & DIST) > 0) {
 			this.addNext(distLbl = new mLabel(MyLocale.getMsg(1601,"Distance:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));

Modified: trunk/src/CacheWolf/Profile.java
===================================================================
--- trunk/src/CacheWolf/Profile.java	2007-11-25 14:39:40 UTC (rev 1098)
+++ trunk/src/CacheWolf/Profile.java	2007-11-25 15:02:11 UTC (rev 1099)
@@ -170,6 +170,7 @@
 			detfile.print("</CACHELIST>\n");
 			detfile.close();
 			buildReferences(); //TODO Why is this needed here?
+			CacheHolder.saveAllModifiedDetails();
 			if(showprogress) pbf.exit(0);
 		}catch(Exception e){
 			Vm.debug("Problem writing to index file "+e.toString());

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2007-11-25 14:39:40 UTC (rev 1098)
+++ trunk/src/CacheWolf/myTableControl.java	2007-11-25 15:02:11 UTC (rev 1099)
@@ -216,7 +216,7 @@
 			}
 			infB.close(0);
 //			profile.hasUnsavedChanges=true;	
-			profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR);
+			profile.saveIndex(pref,Profile.SHOW_PROGRESS_BAR);
 			profile.restoreFilter();
 			profile.updateBearingDistance();
 			tbp.refreshTable();



From pfeffer at mail.berlios.de  Sun Nov 25 17:32:42 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sun, 25 Nov 2007 17:32:42 +0100
Subject: [Cachewolf-svn] r1100 - trunk/src/CacheWolf
Message-ID: <200711251632.lAPGWgRj018265@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-25 17:32:38 +0100 (Sun, 25 Nov 2007)
New Revision: 1100

Modified:
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/CacheHolderDetail.java
   trunk/src/CacheWolf/OCXMLImporter.java
Log:
CacheHolder: rename a variable member to hasUnsavedChanges

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-25 15:02:11 UTC (rev 1099)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-25 16:32:38 UTC (rev 1100)
@@ -400,7 +400,7 @@
    }
    
    public void releaseCacheDetails() {
-	   if (details != null && details.saveChanges) 
+	   if (details != null && details.hasUnsavedChanges) 
 		   details.saveCacheDetails(Global.getProfile().dataDir);
 	   details = null;
 	   cachesWithLoadedDetails.remove(this);
@@ -432,7 +432,7 @@
 	   CacheHolderDetail chD;
 	   for (int i=cachesWithLoadedDetails.size()-1; i>=0; i--) {
 		   chD = ((CacheHolder)(cachesWithLoadedDetails.get(i))).getCacheDetails(false);
-		   if (chD.saveChanges) 
+		   if (chD.hasUnsavedChanges) 
 			   chD.saveCacheDetails(Global.getProfile().dataDir);
 		   	
 	   }

Modified: trunk/src/CacheWolf/CacheHolderDetail.java
===================================================================
--- trunk/src/CacheWolf/CacheHolderDetail.java	2007-11-25 15:02:11 UTC (rev 1099)
+++ trunk/src/CacheWolf/CacheHolderDetail.java	2007-11-25 16:32:38 UTC (rev 1100)
@@ -31,7 +31,7 @@
 	  public String Solver = EMPTY;
 	  /** For faster cache import (from opencaching) changes are only written when the details are freed from memory 
 	   * If you want to save the changes automatically when the details are unloaded, set this to true */ 
-	  public boolean saveChanges = false;
+	  public boolean hasUnsavedChanges = false;
 	  
 	 public CacheHolderDetail() {
 	 }
@@ -318,7 +318,7 @@
 			} catch (Exception e){
 			  //Vm.debug("Problem closing details file");
 			}
-			saveChanges = false;
+			hasUnsavedChanges = false;
 		}
 		
 		/**

Modified: trunk/src/CacheWolf/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2007-11-25 15:02:11 UTC (rev 1099)
+++ trunk/src/CacheWolf/OCXMLImporter.java	2007-11-25 16:32:38 UTC (rev 1100)
@@ -435,7 +435,7 @@
 			}
 
 			// save all
-			chD.saveChanges = true; // this makes CachHolder save the details in case that they are unloaded from memory
+			chD.hasUnsavedChanges = true; // this makes CachHolder save the details in case that they are unloaded from memory
 			// chD.saveCacheDetails(profile.dataDir); 
 			// profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR); // this is done after .xml is completly processed
 			return;
@@ -514,7 +514,7 @@
 						getPic(fetchUrl, imgAltText);
 					}
 				}
-				chD.saveChanges = true; //saveCacheDetails(profile.dataDir);
+				chD.hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
 				return;
 			}
 
@@ -597,7 +597,7 @@
 		if(name.equals("picture")){ 
 			//String fileName = holder.wayPoint + "_" + picUrl.substring(picUrl.lastIndexOf("/")+1);
 			getPic(picUrl,picTitle);
-			chD.saveChanges = true; //saveCacheDetails(profile.dataDir);
+			chD.hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
 			return;
 		}
 	}
@@ -605,7 +605,7 @@
 	private void endCacheLog(String name){
 		if (name.equals("cachelog")){ // </cachelog>
 			chD.CacheLogs.merge(new Log(logIcon, logDate, logFinder, logData, loggerRecommended));
-			chD.saveChanges = true; //chD.saveCacheDetails(profile.dataDir);
+			chD.hasUnsavedChanges = true; //chD.saveCacheDetails(profile.dataDir);
 			return;
 		}
 



From mik77 at mail.berlios.de  Sun Nov 25 18:48:18 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 25 Nov 2007 18:48:18 +0100
Subject: [Cachewolf-svn] r1101 - in trunk/src/CacheWolf: . navi
Message-ID: <200711251748.lAPHmIfA027754@sheep.berlios.de>

Author: mik77
Date: 2007-11-25 18:48:08 +0100 (Sun, 25 Nov 2007)
New Revision: 1101

Modified:
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/CoordsScreen.java
   trunk/src/CacheWolf/navi/GkPoint.java
   trunk/src/CacheWolf/navi/GotoPanel.java
Log:
GK coordinates added to IO especially CoordsScreen

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-25 16:32:38 UTC (rev 1100)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-25 17:48:08 UTC (rev 1101)
@@ -6,6 +6,7 @@
 import ewe.sys.Locale;
 import ewe.sys.Convert;
 import CacheWolf.navi.TrackPoint;
+import CacheWolf.navi.GkPoint;
 import CacheWolf.navi.TransformCoordinates;
 
 import com.bbn.openmap.proj.coords.*;
@@ -32,10 +33,11 @@
 	public static final int DMM = 1;
 	public static final int DMS = 2;
 	public static final int UTM = 3;
-	public static final int CW = 4;
-	public static final int REGEX = 5;
-	public static final int LAT_LON = 6;
-	public static final int LON_LAT = 7;
+	public static final int GK = 4;
+	public static final int CW = 5;
+	public static final int REGEX = 6;
+	public static final int LAT_LON = 7;
+	public static final int LON_LAT = 8;
 	
 	
 	/**
@@ -316,6 +318,19 @@
 			this.lonDec = ll.getLongitude();
 		} else {this.latDec = 91; this.lonDec = 361; }
 	}
+	
+	/**
+	 * set lat and lon by using GK coordinates  
+	 * @param strEasting  Easting component
+	 * @param strNorthing Northing component
+	 */
+	public void set ( String strEasting, String strNorthing ){
+		GkPoint gk = new GkPoint(Common.parseDouble(strEasting), Common.parseDouble(strNorthing));
+		
+		this. latDec = TransformCoordinates.germanGkToWgs84(gk).latDec;
+		this. lonDec = TransformCoordinates.germanGkToWgs84(gk).lonDec;
+		this.utmValid = false;
+	}
 
 	/**
 	 * Get degrees of latitude in different formats
@@ -397,11 +412,11 @@
 			case DMM: 	
 			    // Need to check if minutes would round up to 60
 				if (java.lang.Math.round(tmpMin*1000.0) == 60000) { tmpMin =0;  iDeg++; }
-				if (what==0)
-					return MyLocale.formatLong(iDeg, "00");
-				else
-					return MyLocale.formatDouble(tmpMin, "00.000").replace(',','.');
-				
+				switch (what) {
+					case 0: return MyLocale.formatLong(iDeg, "00");
+					case 1: return MyLocale.formatDouble(tmpMin, "00.000").replace(',','.');
+					case 2: return "";
+				}
 			case DMS:
 				tmpSec= (tmpMin - (int)tmpMin) * 60.0;
 				tmpMin=(int) tmpMin;
@@ -414,7 +429,6 @@
 					case 1: return MyLocale.formatDouble(tmpMin, "00");
 					case 2: return MyLocale.formatDouble(tmpSec, "00.0").replace(',','.');
 				}
-		
 		}
 		return ""; // Dummy to keep compiler happy
 	}
@@ -457,6 +471,22 @@
 		return Convert.toString((long)utm.easting).replace(',','.');
 	}
 	
+	/**
+	 * Get GK northing
+	 */
+	public String getGKNorthing(){
+		double gkNorthing = TransformCoordinates.wgs84ToGermanGk(this).getNorthing();
+		return Convert.toString((long)gkNorthing).replace(',','.');		
+	}
+
+	/**
+	 * Get GK easting
+	 */
+	public String getGKEasting() {
+		double gkEasting = TransformCoordinates.wgs84ToGermanGk(this).getGkEasting();
+		return Convert.toString((long)gkEasting).replace(',','.');		
+	}
+	
 	public String getGermanGkCoordinates() {
 		return TransformCoordinates.wgs84ToGermanGk(this).toString(0, "R:", " H:");
 	}
@@ -590,6 +620,8 @@
 			return Common.DoubleToString(lonDec, 8) +  "," + Common.DoubleToString(latDec, 8);
 		case LAT_LON:
 			return Common.DoubleToString(latDec, 8) +  "," + Common.DoubleToString(lonDec, 8);
+		case GK:
+			return getGermanGkCoordinates();
 		default: return "Unknown Format: " + format;
 
 		}

Modified: trunk/src/CacheWolf/CoordsScreen.java
===================================================================
--- trunk/src/CacheWolf/CoordsScreen.java	2007-11-25 16:32:38 UTC (rev 1100)
+++ trunk/src/CacheWolf/CoordsScreen.java	2007-11-25 17:48:08 UTC (rev 1101)
@@ -13,7 +13,7 @@
 
 public class CoordsScreen extends Form {
 
-	mCheckBox chkDMM, chkDMS, chkDD, chkUTM;
+	mCheckBox chkDMM, chkDMS, chkDD, chkUTM, chkGK;
 	CheckBoxGroup chkFormat = new CheckBoxGroup();
 	mChoice chcNS, chcEW;
 	mInput inpNSDeg, inpNSm, inpNSs, inpEWDeg, inpEWm, inpEWs;
@@ -21,8 +21,8 @@
 	mInput inpText;
 	mButton btnCancel, btnApply, btnCopy, btnPaste, btnParse, btnGps;
 	CWPoint coordInp = new CWPoint();
-	CellPanel TopP = new CellPanel();
-	CellPanel BottomP = new CellPanel();
+	CellPanel topLinePanel = new CellPanel();
+	CellPanel mainPanel = new CellPanel();
 	int exitKeys[]={75009};
 	int currFormat;
 	
@@ -30,59 +30,62 @@
 	{
 		this.setTitle("");
 		//Radiobuttons for format
-		TopP.addNext(chkDD =new mCheckBox("d.d?"),CellConstants.DONTSTRETCH, CellConstants.WEST);
-		TopP.addNext(chkDMM =new mCheckBox("d?m.m\'"),CellConstants.DONTSTRETCH, CellConstants.WEST);
-		TopP.addNext(chkDMS =new mCheckBox("d?m\'s\""),CellConstants.DONTSTRETCH,CellConstants.WEST);
-		TopP.addLast(chkUTM =new mCheckBox("UTM"),CellConstants.DONTSTRETCH, CellConstants.WEST);
+		topLinePanel.addNext(chkDD =new mCheckBox("d.d?"),CellConstants.DONTSTRETCH, CellConstants.WEST);
+		topLinePanel.addNext(chkDMM =new mCheckBox("d?m.m\'"),CellConstants.DONTSTRETCH, CellConstants.WEST);
+		topLinePanel.addNext(chkDMS =new mCheckBox("d?m\'s\""),CellConstants.DONTSTRETCH,CellConstants.WEST);
+		topLinePanel.addNext(chkUTM =new mCheckBox("UTM"),CellConstants.DONTSTRETCH, CellConstants.WEST);
+		topLinePanel.addLast(chkGK =new mCheckBox("GK"),CellConstants.DONTSTRETCH, CellConstants.WEST);
 
 		chkDD.setGroup(chkFormat); chkDD.exitKeys=exitKeys;
 		chkDMM.setGroup(chkFormat);chkDMM.exitKeys=exitKeys;
 		chkDMS.setGroup(chkFormat);chkDMS.exitKeys=exitKeys;
 		chkUTM.setGroup(chkFormat);chkUTM.exitKeys=exitKeys;
+		chkGK.setGroup(chkFormat);chkGK.exitKeys=exitKeys;
+		
+		this.addLast(topLinePanel,CellConstants.DONTSTRETCH, CellConstants.WEST);
 
 		// Input for degrees
-		TopP.addNext(chcNS = new mChoice(new String[]{"N", "S"},0),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(chcNS = new mChoice(new String[]{"N", "S"},0),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		chcNS.setInt(0);
-		TopP.addNext(inpNSDeg = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addNext(inpNSm = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addLast(inpNSs = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(inpNSDeg = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(inpNSm = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addLast(inpNSs = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		
-		TopP.addNext(chcEW = new mChoice(new String[]{"E", "W"},0),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(chcEW = new mChoice(new String[]{"E", "W"},0),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		chcEW.setInt(0);
-		TopP.addNext(inpEWDeg = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addNext(inpEWm = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addLast(inpEWs = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(inpEWDeg = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(inpEWm = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addLast(inpEWs = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 
 		// Input for UTM
-		TopP.addNext(new mLabel(MyLocale.getMsg(1400,"Zone")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addNext(new mLabel(MyLocale.getMsg(1402,"Easting")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addLast(new mLabel(MyLocale.getMsg(1401,"Northing")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(new mLabel(MyLocale.getMsg(1400,"Zone")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(new mLabel(MyLocale.getMsg(1402,"Easting")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addLast(new mLabel(MyLocale.getMsg(1401,"Northing")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 
-		TopP.addNext(inpUTMZone = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addNext(inpUTMEasting = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addNext(inpUTMNorthing = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		TopP.addLast(btnGps = new mButton("GPS"),CellConstants.HSTRETCH, (CellConstants.HFILL));
+		mainPanel.addNext(inpUTMZone = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(inpUTMEasting = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addNext(inpUTMNorthing = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		mainPanel.addLast(btnGps = new mButton("GPS"),CellConstants.HSTRETCH, (CellConstants.HFILL));
 		
-		TopP.addLast(new mLabel(MyLocale.getMsg(1405,"To load coordinates from GC, enter GCxxxxx below")),CellConstants.HSTRETCH, (CellConstants.HFILL)).setTag(SPAN,new Dimension(4,1));
+		mainPanel.addLast(new mLabel(MyLocale.getMsg(1405,"To load coordinates from GC, enter GCxxxxx below")),CellConstants.HSTRETCH, (CellConstants.HFILL)).setTag(SPAN,new Dimension(4,1));
 			// Input for free Text
-		TopP.addNext(inpText = new mInput(),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
+		mainPanel.addNext(inpText = new mInput(),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
 		inpText.toolTip=MyLocale.getMsg(1406,"Enter coordinates in any format or GCxxxxx");
 		inpText.setTag(SPAN,new Dimension(3,1));
-		TopP.addLast(btnParse = new mButton(MyLocale.getMsg(619,"Parse")),CellConstants.HSTRETCH, (CellConstants.HFILL));
+		mainPanel.addLast(btnParse = new mButton(MyLocale.getMsg(619,"Parse")),CellConstants.HSTRETCH, (CellConstants.HFILL));
 		
 		// Buttons for cancel and apply, copy and paste
-		TopP.addNext(btnCancel = new mButton(MyLocale.getMsg(614,"Cancel")),CellConstants.HSTRETCH, (CellConstants.HFILL));
+		mainPanel.addNext(btnCancel = new mButton(MyLocale.getMsg(614,"Cancel")),CellConstants.HSTRETCH, (CellConstants.HFILL));
 		//btnCancel.setTag(SPAN,new Dimension(4,1));
-		TopP.addNext(btnApply = new mButton(MyLocale.getMsg(615,"Apply")),CellConstants.HSTRETCH, (CellConstants.HFILL));
+		mainPanel.addNext(btnApply = new mButton(MyLocale.getMsg(615,"Apply")),CellConstants.HSTRETCH, (CellConstants.HFILL));
 		//btnApply.setTag(SPAN,new Dimension(4,1));
-		TopP.addNext(btnPaste = new mButton(MyLocale.getMsg(617,"Paste")),CellConstants.HSTRETCH, (CellConstants.HFILL));
+		mainPanel.addNext(btnPaste = new mButton(MyLocale.getMsg(617,"Paste")),CellConstants.HSTRETCH, (CellConstants.HFILL));
 		//btnParse.setTag(SPAN,new Dimension(4,1));
-		TopP.addLast(btnCopy = new mButton(MyLocale.getMsg(618,"Copy")),CellConstants.HSTRETCH, (CellConstants.HFILL));
+		mainPanel.addLast(btnCopy = new mButton(MyLocale.getMsg(618,"Copy")),CellConstants.HSTRETCH, (CellConstants.HFILL));
 		//btnCopy.setTag(SPAN,new Dimension(4,1));
 		chcNS.exitKeys=exitKeys; chcEW.exitKeys=exitKeys;
 		//add Panels
-		this.addLast(TopP,CellConstants.DONTSTRETCH, CellConstants.WEST).setTag(SPAN,new Dimension(4,1));
-//		this.addLast(BottomP,CellConstants.VSTRETCH, CellConstants.VFILL|CellConstants.WEST).setTag(SPAN,new Dimension(4,1));
+		this.addLast(mainPanel,CellConstants.DONTSTRETCH, CellConstants.WEST);
 		chcNS.takeFocus(Control.ByKeyboard);
 	}
 	
@@ -114,6 +117,12 @@
 				enable(inpUTMZone); enable(inpUTMNorthing); enable(inpUTMEasting);
 				inpUTMNorthing.wantReturn=true;
 	 			break;
+			case CWPoint.GK: 	
+				disable(chcNS); disable(inpNSDeg); disable(inpNSm); disable(inpNSs);
+				disable(chcEW); disable(inpEWDeg); disable(inpEWm); disable(inpEWs);
+				disable(inpUTMZone); enable(inpUTMNorthing); enable(inpUTMEasting);
+				inpUTMNorthing.wantReturn=true;
+	 			break;
 		}
 		
 		this.stretchLastColumn = true;
@@ -129,6 +138,9 @@
 		if (format == CWPoint.UTM)
 			coords.set(inpUTMZone.getText(), 
 					   inpUTMNorthing.getText(), inpUTMEasting.getText());
+		else if (format == CWPoint.GK) {
+			coords.set(inpUTMEasting.getText(), inpUTMNorthing.getText());			
+		}
 		else {
 			NS = chcNS.getInt()== 0?"N":"S";
 			EW = chcEW.getInt()== 0?"E":"W";
@@ -146,6 +158,11 @@
 			inpUTMNorthing.setText(coords.getUTMNorthing());
 			inpUTMEasting.setText((coords.getUTMEasting()));
 		}
+		else if (format == CWPoint.GK){
+			inpUTMZone.setText("");
+			inpUTMNorthing.setText(coords.getGKNorthing());
+			inpUTMEasting.setText((coords.getGKEasting()));
+		}
 		else {
 			chcNS.setInt(coords.getNSLetter().equals("N")?0:1);
 			chcEW.setInt(coords.getEWLetter().equals("E")?0:1);
@@ -179,6 +196,7 @@
 			if (((ControlEvent)ev).target==chkDD || ((ControlEvent)ev).target==chkDMM ||
 			    ((ControlEvent)ev).target==chkDMS) Gui.takeFocus(chcNS,Control.ByKeyboard);	
 			if (((ControlEvent)ev).target==chkUTM) Gui.takeFocus(inpUTMZone,Control.ByKeyboard);
+			if (((ControlEvent)ev).target==chkGK) Gui.takeFocus(inpUTMEasting,Control.ByKeyboard);
 			if (((ControlEvent)ev).target==chcNS) Gui.takeFocus(inpNSDeg,Control.ByKeyboard);
 			if (((ControlEvent)ev).target==chcEW) Gui.takeFocus(inpEWDeg,Control.ByKeyboard);
 		}

Modified: trunk/src/CacheWolf/navi/GkPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/GkPoint.java	2007-11-25 16:32:38 UTC (rev 1100)
+++ trunk/src/CacheWolf/navi/GkPoint.java	2007-11-25 17:48:08 UTC (rev 1101)
@@ -88,7 +88,15 @@
 		return easting;
 	}
 	
+	/**
+	 * easting measured in meters from stripe middle
+	 * @return
+	 */
+	public double getNorthing() {
+		return northing;
+	}
 	
+	
 	public String toString() {
 		return toString(0, "R: ", " H: ");
 	}

Modified: trunk/src/CacheWolf/navi/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/navi/GotoPanel.java	2007-11-25 16:32:38 UTC (rev 1100)
+++ trunk/src/CacheWolf/navi/GotoPanel.java	2007-11-25 17:48:08 UTC (rev 1101)
@@ -70,7 +70,7 @@
 	int ticker = 0;
 	
 	Menu mnuContextFormt;
-	MenuItem miDMM, miDMS, miDD, miUTM;
+	MenuItem miDMM, miDMS, miDD, miUTM, miGK;
 	
 	Menu mnuContextRose;
 	MenuItem miLuminary[] = new MenuItem[SkyOrientation.LUMINARY_NAMES.length];
@@ -108,6 +108,8 @@
 		miDMS.modifiers &= ~MenuItem.Checked;
 		mnuContextFormt.addItem(miUTM = new MenuItem("UTM"));
 		miUTM.modifiers &= ~MenuItem.Checked;
+		mnuContextFormt.addItem(miGK = new MenuItem("GK"));
+		miGK.modifiers &= ~MenuItem.Checked;
 		currFormat = CWPoint.DMM;
 
 		// Create context menu for compass rose: select luminary for orientation
@@ -329,15 +331,21 @@
 						mnuContextFormt.close();
 						currFormat = CWPoint.UTM;
 					}
+					if (action == miGK) {
+						mnuContextFormt.close();
+						currFormat = CWPoint.GK;
+					}
 					miDD.modifiers &= ~MenuItem.Checked;
 					miDMM.modifiers &= ~MenuItem.Checked;
 					miDMS.modifiers &= ~MenuItem.Checked;
 					miUTM.modifiers &= ~MenuItem.Checked;
+					miGK.modifiers &= ~MenuItem.Checked;
 					switch (currFormat) {
 					case CWPoint.DD: miDD.modifiers |= MenuItem.Checked; break;   
 					case CWPoint.DMM: miDMM.modifiers |= MenuItem.Checked; break;   
 					case CWPoint.DMS: miDMS.modifiers |= MenuItem.Checked; break;   
 					case CWPoint.UTM: miUTM.modifiers |= MenuItem.Checked; break;
+					case CWPoint.GK: miGK.modifiers |= MenuItem.Checked; break;
 					}
 
 					lblPosition.setText(myNavigation.gpsPos.toString(currFormat));



From mik77 at mail.berlios.de  Sun Nov 25 19:03:50 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 25 Nov 2007 19:03:50 +0100
Subject: [Cachewolf-svn] r1102 - trunk/src/CacheWolf
Message-ID: <200711251803.lAPI3oA2009886@sheep.berlios.de>

Author: mik77
Date: 2007-11-25 19:03:39 +0100 (Sun, 25 Nov 2007)
New Revision: 1102

Modified:
   trunk/src/CacheWolf/CWPoint.java
Log:
RegEx for parsing GK coordinates added

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-25 17:48:08 UTC (rev 1101)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-25 18:03:39 UTC (rev 1102)
@@ -215,6 +215,8 @@
 								  	"(?:([EeWwOo])\\s*(?![+-]))?"    +     "([+-]?[0-9]{1,3})[,.]([0-9]{1,8})\\s*[?\uC2B0]?" +
 									")|(?:" +
 									"([0-9]{1,2}[C-HJ-PQ-X])\\s*[EeOo]?\\s*([0-9]{1,7})\\s+[Nn]?\\s*([0-9]{1,7})" +
+									")|(?:" +
+									"[Rr]:?\\s*([0-9]{1,7})\\s+[Hh]:?\\s*([0-9]{1,7})" +
 									")"); 
 				this.latDec = -91; // return unset / unvalid values if parsing was not successfull
 				this.lonDec = -361;
@@ -237,6 +239,8 @@
 						rex.stringMatched(14)==null?"E":rex.stringMatched(14).toUpperCase(), rex.stringMatched(15)+ "." + rex.stringMatched(16), null, null, DD);
 				} else if (rex.stringMatched(17) != null){ // UTM
 					set(rex.stringMatched(17),rex.stringMatched(19),rex.stringMatched(18)); //parse sequence is E N, but set needs N E
+				} else if (rex.stringMatched(20) != null){ // GK
+					set(rex.stringMatched(20),rex.stringMatched(21));
 				}
 				//else Vm.debug("CWPoint: "+coord+" could not be parsed");
 			}	/**



From mik77 at mail.berlios.de  Sun Nov 25 20:20:10 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 25 Nov 2007 20:20:10 +0100
Subject: [Cachewolf-svn] r1103 - trunk/src/CacheWolf
Message-ID: <200711251920.lAPJKAIq021689@sheep.berlios.de>

Author: mik77
Date: 2007-11-25 20:20:05 +0100 (Sun, 25 Nov 2007)
New Revision: 1103

Modified:
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/CoordsScreen.java
Log:
correct rounding of GK coordinates

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-25 18:03:39 UTC (rev 1102)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-25 19:20:05 UTC (rev 1103)
@@ -478,17 +478,25 @@
 	/**
 	 * Get GK northing
 	 */
-	public String getGKNorthing(){
+	public String getGKNorthing(int decimalplaces){
 		double gkNorthing = TransformCoordinates.wgs84ToGermanGk(this).getNorthing();
-		return Convert.toString((long)gkNorthing).replace(',','.');		
+		
+		ewe.sys.Double n = new ewe.sys.Double();
+		n.set(gkNorthing);
+		n.decimalPlaces = decimalplaces;
+		return n.toString().replace(',', '.');
 	}
 
 	/**
 	 * Get GK easting
 	 */
-	public String getGKEasting() {
+	public String getGKEasting(int decimalplaces) {
 		double gkEasting = TransformCoordinates.wgs84ToGermanGk(this).getGkEasting();
-		return Convert.toString((long)gkEasting).replace(',','.');		
+		
+		ewe.sys.Double e = new ewe.sys.Double();
+		e.set(gkEasting);
+		e.decimalPlaces = decimalplaces;
+		return e.toString().replace(',', '.');
 	}
 	
 	public String getGermanGkCoordinates() {

Modified: trunk/src/CacheWolf/CoordsScreen.java
===================================================================
--- trunk/src/CacheWolf/CoordsScreen.java	2007-11-25 18:03:39 UTC (rev 1102)
+++ trunk/src/CacheWolf/CoordsScreen.java	2007-11-25 19:20:05 UTC (rev 1103)
@@ -160,8 +160,8 @@
 		}
 		else if (format == CWPoint.GK){
 			inpUTMZone.setText("");
-			inpUTMNorthing.setText(coords.getGKNorthing());
-			inpUTMEasting.setText((coords.getGKEasting()));
+			inpUTMNorthing.setText(coords.getGKNorthing(0));
+			inpUTMEasting.setText((coords.getGKEasting(0)));
 		}
 		else {
 			chcNS.setInt(coords.getNSLetter().equals("N")?0:1);



From mik77 at mail.berlios.de  Sun Nov 25 22:26:32 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sun, 25 Nov 2007 22:26:32 +0100
Subject: [Cachewolf-svn] r1104 - in trunk/src/CacheWolf: . navi
Message-ID: <200711252126.lAPLQV8T001664@sheep.berlios.de>

Author: mik77
Date: 2007-11-25 22:26:30 +0100 (Sun, 25 Nov 2007)
New Revision: 1104

Modified:
   trunk/src/CacheWolf/CoordsScreen.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
 - Use correct transformation parameters in middle and south Germany.
 - correct recognition if coordinates could not be parsed.

Modified: trunk/src/CacheWolf/CoordsScreen.java
===================================================================
--- trunk/src/CacheWolf/CoordsScreen.java	2007-11-25 19:20:05 UTC (rev 1103)
+++ trunk/src/CacheWolf/CoordsScreen.java	2007-11-25 21:26:30 UTC (rev 1104)
@@ -242,7 +242,7 @@
 				} else {	
 					coord = new CWPoint(inp);
 				}
-				if (coord.latDec == 0 && coord.lonDec == 0){
+				if (coord.latDec == -91 && coord.lonDec == -361){
 					MessageBox tmpMB = new MessageBox(MyLocale.getMsg(312,"Error"), MyLocale.getMsg(4111,"Coordinates must be entered in the format N DD MM.MMM E DDD MM.MMM"), MessageBox.OKB);
 					tmpMB.exec();
 				}else {

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-25 19:20:05 UTC (rev 1103)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-25 21:26:30 UTC (rev 1104)
@@ -115,8 +115,8 @@
 				( gk.getStripe() == 5 && gk.getGkEasting() >= 5211904.597 && gk.getGkEasting() <= 5466056.603)
 			) return gkToWgs84(gk, GK_GERMANY_2001);
 		if (gk.northing <= 6097247.910 && gk.northing >= 5800464.725 )return gkToWgs84(gk, GK_NORD_GERMANY);
-		if (gk.northing <= 5800464.725 && gk.northing >= 5577963.555 )return gkToWgs84(gk, GK_NORD_GERMANY);
-		if (gk.northing <= 5577963.555 && gk.northing >= 5207294.028 )return gkToWgs84(gk, GK_NORD_GERMANY);
+		if (gk.northing <= 5800464.725 && gk.northing >= 5577963.555 )return gkToWgs84(gk, GK_MID_GERMANY);
+		if (gk.northing <= 5577963.555 && gk.northing >= 5207294.028 )return gkToWgs84(gk, GK_SOUTH_GERMANY);
 		return  gkToWgs84(gk, GK_GERMANY_2001); 	//TODO use more lokalized transformparameters, which can be obtained from the Landesvermessungs?mter
 	}
 
@@ -138,7 +138,7 @@
 		if (FORMER_GDR.isInBound(ll)) return GK_GERMANY_2001; // exlcude former GDR from the splitting germany in north/middel/south
 		if (ll.latDec <= 55 && ll.latDec >= 52.33333334 ) return  GK_NORD_GERMANY;
 		if (ll.latDec <= 52.33333334  && ll.latDec >= 50.33333334 ) return  GK_MID_GERMANY;
-		if (ll.latDec <= 50.33333334  && ll.latDec >= 47) return  GK_MID_GERMANY;
+		if (ll.latDec <= 50.33333334  && ll.latDec >= 47) return  GK_SOUTH_GERMANY;
 		return GK_GERMANY_2001;
 	}
 	



From salzkammergut at mail.berlios.de  Sun Nov 25 23:21:26 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 25 Nov 2007 23:21:26 +0100
Subject: [Cachewolf-svn] r1105 - in trunk: resources src/CacheWolf
Message-ID: <200711252221.lAPMLQWA004716@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-25 23:21:12 +0100 (Sun, 25 Nov 2007)
New Revision: 1105

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/MyComparer.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/TableColumnChooser.java
   trunk/src/CacheWolf/myTableModel.java
Log:
Added two columns to the list view for OC Recommendations: number of recommendations and OC Cache index, a calculated value indicating how often the cache was recommended in relation to the number of logs.
Modified the index in CacheHolder from Float to int - this is not really a restriction but we don't really want decimals in the calculated OC cache index.


Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-11-25 21:26:30 UTC (rev 1104)
+++ trunk/resources/cachewolf.Languages.cfg	2007-11-25 22:21:12 UTC (rev 1105)
@@ -189,6 +189,8 @@
 		633=Max. logs spidern
 		634=Proxy verwenden
 		635=Gr%f6%dfe
+		636=OC Empfehlungen
+		637=OC Index		
 		700=Filter setzen
 		701=Entfernung
 		702=Schwierigkeit
@@ -273,6 +275,8 @@
 		1023=Diese Funktion steht gegenw%e4rtig nur f%fcr Geocaching.com zur Verf%fcgung
 		1024=Entfernungen in der Listenansicht~vom aktuellen Standpunkt aus~neu berechnet
 		1025=Kann Zentrum nicht setzen (GPS-Position unzul%e4ssig)
+		1026=#Rec
+		1027=OC-Idx
 		1100=Profile
 		1105=Suchen
 		1106=Profil w%e4hlen oder Neu
@@ -748,6 +752,8 @@
 		633=Max. logs to spider
 		634=use Proxy
 		635=Size
+		636=OC Recs
+		637=OC Index		
 		700=Set filter
 		701=Distance
 		702=Difficulty
@@ -832,6 +838,8 @@
 		1023=This function is currently only available for geocaching.com
 		1024=Distances in list view recalculated~from current position
 		1025=Cannot set centre (Invalid GPS position)
+		1026=#Rec
+		1027=OC-Idx
 		1100=Profiles
 		1105=Browse
 		1106=Choose profile or New

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-25 21:26:30 UTC (rev 1104)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-25 22:21:12 UTC (rev 1105)
@@ -80,8 +80,8 @@
 public int numRecommended = 0;
 /** Number of logs since start of recommendations system */
 public int numLogsSinceRecommendation = 0;
-/** Recommendation score: calculated as rations  numRecommended / numLogsSinceRecommendation  */
-public float recommendationScore = 0;
+/** Recommendation score: calculated as ratio  numRecommended / numLogsSinceRecommendation * 100 */
+public int recommendationScore = 0;
 /** True if this cache has travelbugs */
 public boolean has_bug = false;
 /** True if the cache description is stored in HTML format */

Modified: trunk/src/CacheWolf/MyComparer.java
===================================================================
--- trunk/src/CacheWolf/MyComparer.java	2007-11-25 21:26:30 UTC (rev 1104)
+++ trunk/src/CacheWolf/MyComparer.java	2007-11-25 22:21:12 UTC (rev 1105)
@@ -92,7 +92,22 @@
 					default: ch.sort="?";
 				}
 			}
-			
+		} else if (colToCompare==13) {
+			for (int i=0; i<visibleSize; i++) {
+				CacheHolder ch=(CacheHolder) cacheDB.get(i);
+				if (ch.wayPoint.startsWith("OC"))
+					ch.sort=MyLocale.formatLong((long)ch.numRecommended,"00000");
+				else
+					ch.sort="\uFFFF";
+			}			
+		} else if (colToCompare==14) {
+			for (int i=0; i<visibleSize; i++) {
+				CacheHolder ch=(CacheHolder) cacheDB.get(i);
+				if (ch.wayPoint.startsWith("OC"))
+					ch.sort=MyLocale.formatLong((long)ch.recommendationScore,"00000");
+				else
+					ch.sort="\uFFFF";
+			}			
 		}
 	}
 	

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-25 21:26:30 UTC (rev 1104)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-25 22:21:12 UTC (rev 1105)
@@ -105,7 +105,7 @@
 	/** The list of visible columns in the list view */
 	public String listColMap="0,1,2,3,4,5,6,7,8,9,10,11,12";
 	/** The widths for each column in list view */
-	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104,22";
+	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104,22,30,30";
 	/** The columns which are to be displayed in TravelbugsJourneyScreen. See also TravelbugJourney */
 	public String travelbugColMap="1,4,5,6,8,9,10,7";
 	/** The column widths for the travelbug journeys. */

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-11-25 21:26:30 UTC (rev 1104)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-11-25 22:21:12 UTC (rev 1105)
@@ -188,7 +188,9 @@
 				MyLocale.getMsg(611,"Status"),
 				MyLocale.getMsg(612,"Distance"),
 				MyLocale.getMsg(613,"Bearing"),
-				MyLocale.getMsg(635,"Size")},pref.listColMap),MyLocale.getMsg(595,"List"),null);
+				MyLocale.getMsg(635,"Size"),
+				MyLocale.getMsg(636,"OC Empfehlungen"),
+				MyLocale.getMsg(637,"OC Index")},pref.listColMap),MyLocale.getMsg(595,"List"),null);
 
 		Card c=mTab.addCard(tccBugs=new TableColumnChooser(new String[] {
 				MyLocale.getMsg(6000,"Guid"),

Modified: trunk/src/CacheWolf/TableColumnChooser.java
===================================================================
--- trunk/src/CacheWolf/TableColumnChooser.java	2007-11-25 21:26:30 UTC (rev 1104)
+++ trunk/src/CacheWolf/TableColumnChooser.java	2007-11-25 22:21:12 UTC (rev 1105)
@@ -190,7 +190,7 @@
 	 * @param minSize TODO
 	 */ 
 	public static int[] str2Array(String configString, int min, int max, int def, int minSize) {
-		Vector strConfigVector=new Vector(14);
+		Vector strConfigVector=new Vector(18);
 		SubString.split(configString,',',strConfigVector);
 		int i;
 		int nElem=strConfigVector.size();

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2007-11-25 21:26:30 UTC (rev 1104)
+++ trunk/src/CacheWolf/myTableModel.java	2007-11-25 22:21:12 UTC (rev 1105)
@@ -16,7 +16,7 @@
 */
 public class myTableModel extends TableModel{
 	
-	public static final int MAXCOLUMNS=12;
+	public static final int MAXCOLUMNS=14;
 	// Colors for Cache status (BG unless otherwise stated)
 	private static final Color COLOR_FLAGED		= new Color(255,255,0);
 	private static final Color COLOR_FOUND		= new Color(152,251,152);
@@ -30,12 +30,17 @@
 	/** How the columns are mapped onto the list view. If colMap[i]=j, it means that
 	 * the element j (as per the list below) is visible in column i. 
 	 * [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates, 
-	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing, [12] Size
+	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing, [12] Size, [13] # of OC recommend.
+	 * [14] OC index
 	 */
 	private int[] colMap;
 	/** The column widths corresponding to the list of columns above */
 	private int[] colWidth;
-	private String [] colName = {" ","?",MyLocale.getMsg(1000,"D"),MyLocale.getMsg(1001,"T"),MyLocale.getMsg(1002,"Waypoint"),"Name",MyLocale.getMsg(1004,"Location"),MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear"),MyLocale.getMsg(1017,"S")};//TODO
+	private String [] colName = {" ","?",MyLocale.getMsg(1000,"D"),MyLocale.getMsg(1001,"T"),
+			MyLocale.getMsg(1002,"Waypoint"),"Name",MyLocale.getMsg(1004,"Location"),
+			MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),
+			MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear"),MyLocale.getMsg(1017,"S"),
+			MyLocale.getMsg(1026,"#Rec"),MyLocale.getMsg(1027,"OC-IDX")};
 	
 	public static Image cacheImages[] = new Image[454]; // Images are used by TableControl
 	private static Image noFindLogs[] = new Image[4];
@@ -114,7 +119,7 @@
 	 *
 	 */
 	public void setColumnNamesAndWidths() {
-		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,12,0, -1);
+		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,14,0, -1);
 		colWidth=TableColumnChooser.str2Array(Global.getPref().listColWidth,10,1024,50, colMap.length);
 		numCols=colMap.length;
 		clearCellAdjustments();
@@ -294,6 +299,14 @@
 							case 'V': return picSizeVLarge;
 							default: return "?";
 						}
+					case 13: // OC number of recommendations
+						if (ch.wayPoint.startsWith("OC"))
+							return (new Integer(ch.numRecommended)).toString();
+						return null;
+					case 14: // OC rating	
+						if (ch.wayPoint.startsWith("OC"))
+							return (new Integer(ch.recommendationScore)).toString();
+						return null;
 				} // Switch
 			} // if
 		} catch (Exception e) { return null; }



From salzkammergut at mail.berlios.de  Sun Nov 25 23:33:28 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 25 Nov 2007 23:33:28 +0100
Subject: [Cachewolf-svn] r1106 - trunk/src/CacheWolf
Message-ID: <200711252233.lAPMXSrO005294@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-25 23:33:25 +0100 (Sun, 25 Nov 2007)
New Revision: 1106

Modified:
   trunk/src/CacheWolf/Log.java
   trunk/src/CacheWolf/LogList.java
Log:
Logs: Added counting of number of OC recommendations for a list of logs

Modified: trunk/src/CacheWolf/Log.java
===================================================================
--- trunk/src/CacheWolf/Log.java	2007-11-25 22:21:12 UTC (rev 1105)
+++ trunk/src/CacheWolf/Log.java	2007-11-25 22:33:25 UTC (rev 1106)
@@ -1,6 +1,6 @@
 package CacheWolf;
 
-public class Log {
+public class Log {//static int nObj=0;
 	private static String MAXLOGICON="MAXLOG";
 	private static String INVALIDLOGICON=null;
 	/** The icon which describes the log e.g. icon_sad */
@@ -19,7 +19,7 @@
 	 * or <img src='ICON'>&nbsp;DATE by LOGGER<br>MESSAGE</pre>
 	 * @param logLine
 	 */
-	Log(String logLine) {
+	Log(String logLine) {//nObj++;ewe.sys.Vm.debug("Log: "+nObj+" objects");
 //		RECOMMENDED="1"<img src='icon_smile.gif'>&nbsp;2007-01-14 xyz<br>a wonderful log
 		try {
 			int ic1=logLine.indexOf("RECOMMENDED=\"1\"");
@@ -47,7 +47,7 @@
 		}
 	}
 	
-	Log(String icon, String date, String logger, String message) {
+	Log(String icon, String date, String logger, String message) {//nObj++;ewe.sys.Vm.debug("Log: "+nObj+" objects");
 		this(icon, date, logger, message, false);
 	}
 	
@@ -59,7 +59,7 @@
 		this.recommended = recommended_;
 	}
 	
-	public static Log maxLog() {
+	public static Log maxLog() {//nObj++;ewe.sys.Vm.debug("Log: "+nObj+" objects");
 		return new Log(MAXLOGICON,"1900-00-00","","");
 	}
 	
@@ -87,9 +87,12 @@
 	public void setMessage(String message) {
 		this.message = message.trim();
 	}
-	public void setRecommandation (boolean recommended_) {
+	public void setRecommendation (boolean recommended_) {
 		recommended = recommended_;
 	}
+	public boolean getRecommendation () {
+		return recommended;
+	}
 
 	/** Return XML representation of log for storing in cache.xml */
 	public String toXML(){
@@ -119,4 +122,8 @@
 		s.append(message.trim());
 		return s.toString();
 	}
+/*	public void finalize() {nObj--;
+	   ewe.sys.Vm.debug("Log: "+nObj+" objects left");
+	}
+*/	
 }

Modified: trunk/src/CacheWolf/LogList.java
===================================================================
--- trunk/src/CacheWolf/LogList.java	2007-11-25 22:21:12 UTC (rev 1105)
+++ trunk/src/CacheWolf/LogList.java	2007-11-25 22:33:25 UTC (rev 1106)
@@ -102,5 +102,14 @@
 		return countNoFoundLogs;
 	 }
 	
-
+	 /**
+	  * Count the number of OC Recommendations
+	  * @return Number of OC recommendations
+	  */
+	 public int countRecommendations() {
+		 int nRec=0;
+		 for (int i=size()-1; i>=0; i--)
+			 if (getLog(i).getRecommendation()) nRec++;
+		 return nRec;
+	 }
 }



From pfeffer at mail.berlios.de  Mon Nov 26 18:03:39 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 26 Nov 2007 18:03:39 +0100
Subject: [Cachewolf-svn] r1107 - trunk/src/CacheWolf
Message-ID: <200711261703.lAQH3dg6025639@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-26 18:03:23 +0100 (Mon, 26 Nov 2007)
New Revision: 1107

Modified:
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/Log.java
   trunk/src/CacheWolf/LogList.java
   trunk/src/CacheWolf/OCXMLImporter.java
   trunk/src/CacheWolf/Profile.java
   trunk/src/CacheWolf/myTableModel.java
Log:
Download from OC: merged the changes from SKG and me // still some problems -> I am working on it

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-25 22:33:25 UTC (rev 1106)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-26 17:03:23 UTC (rev 1107)
@@ -1,4 +1,5 @@
 package CacheWolf;
+
 import ewe.io.IOException;
 import ewe.sys.Convert;
 import ewe.sys.Vm;
@@ -6,442 +7,484 @@
 import ewe.util.Vector;
 
 /**
-*	A class to hold information on a cache.<br>
-*	Not all attributes are filled at once. You will have to look at other
-*	classes and methods to get more information.
-*	
-*/
+ *	A class to hold information on a cache.<br>
+ *	Not all attributes are filled at once. You will have to look at other
+ *	classes and methods to get more information.
+ *	
+ */
 public class CacheHolder {
-protected static final String NODISTANCE = "? km";
-protected static final String NOBEARING = "?";
-protected static final String EMPTY = "";
+	protected static final String NODISTANCE = "? km";
+	protected static final String NOBEARING = "?";
+	protected static final String EMPTY = "";
 
-/** Cachestatus is Found, Not found or a date in format yyyy-mm-dd hh:mm for found date */
-public String CacheStatus = EMPTY;
-/** The name of the waypoint typicall GC.... or OC.... or CW...... (can be any characters) */
-public String wayPoint = EMPTY;
-/** The name of the cache (short description) */
-public String CacheName = EMPTY;
-/** The alias of the owner */
-public String CacheOwner = EMPTY;
-/** The coordinates of the cache */
-public CWPoint pos = new CWPoint();
-/** The coordinates of the cache */
-public String LatLon = pos.toString();
-/** The date when the cache was hidden in format yyyy-mm-dd */
-public String DateHidden = EMPTY;
-/** The size of the cache (as per GC cache sizes Micro, Small, ....) */
-public String CacheSize = "None";
-/** The distance from the centre in km */
-public double kilom = 0;
-/** The formatted distance such as "x.xx km" */
-public String distance = NODISTANCE;
-/** The bearing N, NNE, NE, ENE ... from the current centre to this point */
-public String bearing = NOBEARING;
-/** The angle (0=North, 180=South) from the current centre to this point */
-public double degrees = 0;
-/** The difficulty of the cache from 1 to 5 in .5 incements */ 
-public String hard = EMPTY;
-/** The terrain rating of the cache from 1 to 5 in .5 incements */
-public String terrain = EMPTY;
-/** The cache type (@see CacheType for translation table)  */
-public String type = "0"; //TODO Should be an int
-/** True if the cache has been archived */
-public boolean is_archived = false;
-/** True if the cache is available for searching */
-public boolean is_available = true;
-/** True if we own this cache */
-public boolean is_owned = false;
-/** True if we have found this cache */
-public boolean is_found = false;
-/** If this is true, the cache has been filtered (is currently invisible) */
-public boolean is_filtered = false;
-/** True if the number of logs for this cache has changed */
-public boolean is_log_update = false;
-/** True if cache details have changed: longDescription, Hints,  */
-public boolean is_update = false;
-/** True if the cache data is incomplete (e.g. an error occurred during spidering */
-public boolean is_incomplete = false;
-/** True if the cache is blacklisted */
-public boolean is_black = false;
-/** True if the cache is new */
-public boolean is_new = false;
-/** True if the cache is part of the results of a search */
-public boolean is_flaged = false;
-/** True if the cache has been selected using the tick box in the list view */
-public boolean is_Checked = false;
-/** Not used: This attribute is saved with the cache and read back but never set */
-//public String dirty = EMPTY;
-/** The unique OC cache ID */
-public String ocCacheID = EMPTY;
-/** The number of times this cache has not been found (max. 5) */
-public int noFindLogs = 0;
-/** Number of recommendations (from the opencaching logs) */
-public int numRecommended = 0;
-/** Number of logs since start of recommendations system */
-public int numLogsSinceRecommendation = 0;
-/** Recommendation score: calculated as ratio  numRecommended / numLogsSinceRecommendation * 100 */
-public int recommendationScore = 0;
-/** True if this cache has travelbugs */
-public boolean has_bug = false;
-/** True if the cache description is stored in HTML format */
-public boolean is_HTML = true;
-/** List of additional waypoints associated with this waypoint */
-public Vector addiWpts = new Vector();
-/** in range is used by the route filter to identify caches in range of a segment*/
-public boolean in_range = false;
-/** If this is an additional waypoint, this links back to the main waypoint */
-public CacheHolder mainCache;
-/** The date this cache was last synced with OC in format yyyyMMddHHmmss */
-public String lastSyncOC = EMPTY;
-public CacheHolderDetail details = null;
-/** When sorting the cacheDB this field is used. The relevant field is copied here and
- *  the sort is always done on this field to speed up the sorting process 
- */
-public String sort;
-private static StringBuffer sb=new StringBuffer(530); // Used in toXML()
+	/** Cachestatus is Found, Not found or a date in format yyyy-mm-dd hh:mm for found date */
+	public String CacheStatus = EMPTY;
+	/** The name of the waypoint typicall GC.... or OC.... or CW...... (can be any characters) */
+	public String wayPoint = EMPTY;
+	/** The name of the cache (short description) */
+	public String CacheName = EMPTY;
+	/** The alias of the owner */
+	public String CacheOwner = EMPTY;
+	/** The coordinates of the cache */
+	public CWPoint pos = new CWPoint();
+	/** The coordinates of the cache */
+	public String LatLon = pos.toString();
+	/** The date when the cache was hidden in format yyyy-mm-dd */
+	public String DateHidden = EMPTY;
+	/** The size of the cache (as per GC cache sizes Micro, Small, ....) */
+	public String CacheSize = "None";
+	/** The distance from the centre in km */
+	public double kilom = 0;
+	/** The formatted distance such as "x.xx km" */
+	public String distance = NODISTANCE;
+	/** The bearing N, NNE, NE, ENE ... from the current centre to this point */
+	public String bearing = NOBEARING;
+	/** The angle (0=North, 180=South) from the current centre to this point */
+	public double degrees = 0;
+	/** The difficulty of the cache from 1 to 5 in .5 incements */ 
+	public String hard = EMPTY;
+	/** The terrain rating of the cache from 1 to 5 in .5 incements */
+	public String terrain = EMPTY;
+	/** The cache type (@see CacheType for translation table)  */
+	public String type = "0"; //TODO Should be an int
+	/** True if the cache has been archived */
+	public boolean is_archived = false;
+	/** True if the cache is available for searching */
+	public boolean is_available = true;
+	/** True if we own this cache */
+	public boolean is_owned = false;
+	/** True if we have found this cache */
+	public boolean is_found = false;
+	/** If this is true, the cache has been filtered (is currently invisible) */
+	public boolean is_filtered = false;
+	/** True if the number of logs for this cache has changed */
+	public boolean is_log_update = false;
+	/** True if cache details have changed: longDescription, Hints,  */
+	public boolean is_update = false;
+	/** True if the cache data is incomplete (e.g. an error occurred during spidering */
+	public boolean is_incomplete = false;
+	/** True if the cache is blacklisted */
+	public boolean is_black = false;
+	/** True if the cache is new */
+	public boolean is_new = false;
+	/** True if the cache is part of the results of a search */
+	public boolean is_flaged = false;
+	/** True if the cache has been selected using the tick box in the list view */
+	public boolean is_Checked = false;
+	/** Not used: This attribute is saved with the cache and read back but never set */
+//	public String dirty = EMPTY;
+	/** The unique OC cache ID */
+	public String ocCacheID = EMPTY;
+	/** The number of times this cache has not been found (max. 5) */
+	public int noFindLogs = 0;
+	/** Number of recommendations (from the opencaching logs) */
+	public int numRecommended = 0;
+	/** Number of logs since start of recommendations system */
+	public int numLogsSinceRecommendation = 0;
+	/** Recommendation score: calculated as rations  numRecommended / numLogsSinceRecommendation * 100 */
+	public int recommendationScore = 0;
+	/** True if this cache has travelbugs */
+	public boolean has_bug = false;
+	/** True if the cache description is stored in HTML format */
+	public boolean is_HTML = true;
+	/** List of additional waypoints associated with this waypoint */
+	public Vector addiWpts = new Vector();
+	/** in range is used by the route filter to identify caches in range of a segment*/
+	public boolean in_range = false;
+	/** If this is an additional waypoint, this links back to the main waypoint */
+	public CacheHolder mainCache;
+	/** The date this cache was last synced with OC in format yyyyMMddHHmmss */
+	public String lastSyncOC = EMPTY;
+	public CacheHolderDetail details = null;
+	/** When sorting the cacheDB this field is used. The relevant field is copied here and
+	 *  the sort is always done on this field to speed up the sorting process 
+	 */
+	public String sort;
+	private static StringBuffer sb=new StringBuffer(530); // Used in toXML()
 
-//static int nObjects=0;
-public CacheHolder() {//nObjects++;Vm.debug("CacheHolder() nO="+nObjects);
-}
+//	static int nObjects=0;
+	public CacheHolder() {//nObjects++;Vm.debug("CacheHolder() nO="+nObjects);
+	}
 
-public CacheHolder(CacheHolder ch) {//nObjects++;Vm.debug("CacheHolder(ch) nO="+nObjects);
-	update(ch);
-}
+	public CacheHolder(CacheHolder ch) {//nObjects++;Vm.debug("CacheHolder(ch) nO="+nObjects);
+		update(ch);
+	}
 
-static char decSep,notDecSep;
-static {
-	decSep=MyLocale.getDigSeparator().charAt(0);
-	notDecSep=decSep=='.'?',':'.';
-}
+	static char decSep,notDecSep;
+	static {
+		decSep=MyLocale.getDigSeparator().charAt(0);
+		notDecSep=decSep=='.'?',':'.';
+	}
 
-public CacheHolder(String xmlString) {
-	int start,end;
-	try {
-		start=xmlString.indexOf('"'); end=xmlString.indexOf('"',start+1);
-		CacheName = SafeXML.cleanback(xmlString.substring(start+1,end));
-		
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		CacheOwner = SafeXML.cleanback(xmlString.substring(start+1,end));
+	public CacheHolder(String xmlString) {
+		int start,end;
+		try {
+			start=xmlString.indexOf('"'); end=xmlString.indexOf('"',start+1);
+			CacheName = SafeXML.cleanback(xmlString.substring(start+1,end));
 
-		// Assume coordinates are in decimal format
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		double lat=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
+			// Assume coordinates are in decimal format
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			double lat=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
 
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		double lon=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
-		pos=new CWPoint(lat,lon);
-		LatLon=pos.toString();
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			double lon=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
+			pos=new CWPoint(lat,lon);
+			LatLon=pos.toString();
 
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		DateHidden = xmlString.substring(start+1,end); 
-		// Convert the US format to YYYY-MM-DD if necessary
-		if (DateHidden.indexOf('/')>-1) DateHidden=DateFormat.MDY2YMD(DateHidden);
-		
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		wayPoint = SafeXML.cleanback(xmlString.substring(start+1,end));
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			DateHidden = xmlString.substring(start+1,end); 
+			// Convert the US format to YYYY-MM-DD if necessary
+			if (DateHidden.indexOf('/')>-1) DateHidden=DateFormat.MDY2YMD(DateHidden);
 
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		CacheStatus = xmlString.substring(start+1,end);
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		type = xmlString.substring(start+1,end);
-		
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		hard = xmlString.substring(start+1,end);
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			wayPoint = SafeXML.cleanback(xmlString.substring(start+1,end));
 
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		terrain = xmlString.substring(start+1,end);
-		
-		// The next item was 'dirty' but this is no longer used.
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_filtered = xmlString.substring(start+1,end).equals("true"); 
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		CacheSize = xmlString.substring(start+1,end);
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			CacheStatus = xmlString.substring(start+1,end);
 
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_available = xmlString.substring(start+1,end).equals("true");
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			type = xmlString.substring(start+1,end);
 
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_archived = xmlString.substring(start+1,end).equals("true");
-		
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		has_bug = xmlString.substring(start+1,end).equals("true");
-		
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_black = xmlString.substring(start+1,end).equals("true");
-		if(is_black) is_filtered = true;
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_owned = xmlString.substring(start+1,end).equals("true");
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_found = xmlString.substring(start+1,end).equals("true");
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_new = xmlString.substring(start+1,end).equals("true");
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_log_update = xmlString.substring(start+1,end).equals("true");
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_update = xmlString.substring(start+1,end).equals("true");
-	
-		// for backwards compatibility set value to true, if it is not in the file
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_HTML = !xmlString.substring(start+1,end).equals("false");
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		noFindLogs = Convert.toInt(xmlString.substring(start+1,end));
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		ocCacheID = xmlString.substring(start+1,end);
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		is_incomplete = xmlString.substring(start+1,end).equals("true");
-	
-		start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-		lastSyncOC = xmlString.substring(start+1,end);
-	} catch (Exception ex) {
-		
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			hard = xmlString.substring(start+1,end);
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			terrain = xmlString.substring(start+1,end);
+
+			// The next item was 'dirty' but this is no longer used.
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_filtered = xmlString.substring(start+1,end).equals("true"); 
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			CacheSize = xmlString.substring(start+1,end);
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_available = xmlString.substring(start+1,end).equals("true");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_archived = xmlString.substring(start+1,end).equals("true");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			has_bug = xmlString.substring(start+1,end).equals("true");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_black = xmlString.substring(start+1,end).equals("true");
+			if(is_black) is_filtered = true;
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_owned = xmlString.substring(start+1,end).equals("true");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_found = xmlString.substring(start+1,end).equals("true");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_new = xmlString.substring(start+1,end).equals("true");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_log_update = xmlString.substring(start+1,end).equals("true");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_update = xmlString.substring(start+1,end).equals("true");
+
+			// for backwards compatibility set value to true, if it is not in the file
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_HTML = !xmlString.substring(start+1,end).equals("false");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			noFindLogs = Convert.toInt(xmlString.substring(start+1,end));
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			ocCacheID = xmlString.substring(start+1,end);
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			is_incomplete = xmlString.substring(start+1,end).equals("true");
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			lastSyncOC = xmlString.substring(start+1,end);
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			numLogsSinceRecommendation = Convert.toInt(xmlString.substring(start+1,end));
+
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+			numRecommended = Convert.toInt(xmlString.substring(start+1,end));
+			recommendationScore = LogList.getScore(numRecommended, numLogsSinceRecommendation);
+		} catch (Exception ex) {
+
+		}
 	}
-}
 
-public void update(CacheHolder ch) {
-	/* Here we have to distinguish several cases:
+	public void update(CacheHolder ch) {
+		this.recommendationScore = ch.recommendationScore;
+		this.numLogsSinceRecommendation = ch.numLogsSinceRecommendation;
+		this.numRecommended = ch.numRecommended;
+		/* Here we have to distinguish several cases:
 	   this.is_found       this                ch               Update 'this'
 	   --------------------------------------------------------------------
 	   false               empty               yyyy-mm-dd       yes
 	   true                "Found"             yyyy-mm-dd       yes
 	   true                yyyy-mm-dd          yyyy-mm-dd       no (or yes)
 	   true                yyyy-mm-dd hh:mm    yyyy-mm-dd       no
-	*/
-	if (!this.is_found || this.CacheStatus.indexOf(":")<0) {
-		this.CacheStatus=ch.CacheStatus;
-		this.is_found = ch.is_found;
-	}this.wayPoint = ch.wayPoint;
-	this.CacheName = ch.CacheName;
-	this.CacheOwner = ch.CacheOwner;
-	// Don't overwrite valid coordinates with invalid ones
-	if (ch.pos.isValid() || !this.pos.isValid()) {
-		this.pos = ch.pos;
-		this.LatLon = ch.LatLon;
+		 */
+		if (!this.is_found || this.CacheStatus.indexOf(":")<0) {
+			this.CacheStatus=ch.CacheStatus;
+			this.is_found = ch.is_found;
+		}this.wayPoint = ch.wayPoint;
+		this.CacheName = ch.CacheName;
+		this.CacheOwner = ch.CacheOwner;
+		// Don't overwrite valid coordinates with invalid ones
+		if (ch.pos.isValid() || !this.pos.isValid()) {
+			this.pos = ch.pos;
+			this.LatLon = ch.LatLon;
+		}
+		this.DateHidden = ch.DateHidden;
+		this.CacheSize = ch.CacheSize;
+		this.kilom = ch.kilom;
+		this.distance = ch.distance;
+		this.bearing = ch.bearing;
+		this.degrees = ch.degrees;
+		this.hard = ch.hard;
+		this.terrain = ch.terrain;
+		this.type = ch.type;
+		this.is_archived = ch.is_archived;
+		this.is_available = ch.is_available;
+		this.is_owned = ch.is_owned;
+		this.is_filtered = ch.is_filtered;
+		this.is_log_update = ch.is_log_update;
+		this.is_update = ch.is_update;
+		this.is_incomplete = ch.is_incomplete;
+		this.is_black=ch.is_black;
+		this.addiWpts = ch.addiWpts;
+		this.mainCache=ch.mainCache;
+		this.is_new=ch.is_new;
+		this.is_flaged = ch.is_flaged;
+		this.is_Checked = ch.is_Checked;
+		//this.dirty = ch.dirty;
+		this.ocCacheID = ch.ocCacheID;
+		this.noFindLogs = ch.noFindLogs;
+		this.has_bug = ch.has_bug;
+		this.is_HTML = ch.is_HTML;
+		this.sort=ch.sort;
+		this.lastSyncOC = ch.lastSyncOC;
 	}
-	this.DateHidden = ch.DateHidden;
-	this.CacheSize = ch.CacheSize;
-	this.kilom = ch.kilom;
-	this.distance = ch.distance;
-	this.bearing = ch.bearing;
-	this.degrees = ch.degrees;
-	this.hard = ch.hard;
-	this.terrain = ch.terrain;
-	this.type = ch.type;
-	this.is_archived = ch.is_archived;
-	this.is_available = ch.is_available;
-	this.is_owned = ch.is_owned;
-	this.is_filtered = ch.is_filtered;
-	this.is_log_update = ch.is_log_update;
-	this.is_update = ch.is_update;
-	this.is_incomplete = ch.is_incomplete;
-	this.is_black=ch.is_black;
-	this.addiWpts = ch.addiWpts;
-	this.mainCache=ch.mainCache;
-	this.is_new=ch.is_new;
-	this.is_flaged = ch.is_flaged;
-	this.is_Checked = ch.is_Checked;
-    //this.dirty = ch.dirty;
-	this.ocCacheID = ch.ocCacheID;
-	this.noFindLogs = ch.noFindLogs;
-	this.has_bug = ch.has_bug;
-	this.is_HTML = ch.is_HTML;
-	this.sort=ch.sort;
-	this.lastSyncOC = ch.lastSyncOC;
-}
+	/**
+	 * Call it only when necessary, it takes time, because all logs must be parsed
+	 *
+	 */
+	public void calcRecommendationScore() {
+		if (wayPoint.toLowerCase().startsWith("oc") ) {
+			if (getCacheDetails(false) != null) {
+				CacheHolderDetail chD;
+				if (this instanceof CacheHolderDetail)	chD = (CacheHolderDetail)this;
+				else chD = details;
+				chD.CacheLogs.calcRecommendations();
+				recommendationScore = chD.CacheLogs.recommendationRating;
+				numLogsSinceRecommendation = chD.CacheLogs.foundsSinceRecommendation;
+				numRecommended = chD.CacheLogs.numRecommended;
+			} else { // cache doesn't have details
+				recommendationScore = -1;
+				numLogsSinceRecommendation = -1;
+				numRecommended = -1;
+			}
+		} else {
+			recommendationScore = -1;
+			numLogsSinceRecommendation = -1;
+			numRecommended = -1;
+		}
+		if (details != null) {
+		details.recommendationScore = recommendationScore;
+		details.numLogsSinceRecommendation = numLogsSinceRecommendation;
+		details.numRecommended = numRecommended;
+		}
+	}
+	
+	/** Return a XML string containing all the cache data for storing in index.xml */
+	public String toXML() {
+		if (this instanceof CacheHolderDetail || (details != null && details.hasUnsavedChanges)) calcRecommendationScore(); 
+		sb.delete(0,sb.length());
+		sb.append("    <CACHE name = \"");
+		sb.append(SafeXML.clean(CacheName));
+		sb.append("\" owner = \"");		sb.append(SafeXML.clean(CacheOwner));
+		sb.append("\" lat = \""); 		sb.append(pos.latDec ); 
+		sb.append("\" lon = \"");		sb.append(pos.lonDec);
+		sb.append("\" hidden = \"");	sb.append(DateHidden);
+		sb.append("\" wayp = \"");		sb.append(SafeXML.clean(wayPoint));
+		sb.append("\" status = \"");	sb.append(CacheStatus);
+		sb.append("\" type = \"");		sb.append(type);
+		sb.append("\" dif = \"");		sb.append(hard);
+		sb.append("\" terrain = \"" );	sb.append(terrain ); 
+		sb.append("\" filtered = \"" ); sb.append(is_filtered); // This was 'dirty', but dirty is not used
+		sb.append("\" size = \"");		sb.append(CacheSize);
+		sb.append("\" online = \"" );	sb.append(is_available); 
+		sb.append("\" archived = \"" );	sb.append(is_archived); 
+		sb.append("\" has_bug = \"" ); 	sb.append(has_bug); 
+		sb.append("\" black = \"" ); 	sb.append(is_black); 
+		sb.append("\" owned = \"" ); 	sb.append(is_owned); 
+		sb.append("\" found = \"" ); 	sb.append(is_found); 
+		sb.append("\" is_new = \"" );	sb.append(is_new);
+		sb.append("\" is_log_update = \"" );sb.append(is_log_update); 
+		sb.append("\" is_update = \"" );sb.append(is_update); 
+		sb.append("\" is_HTML = \"" ); 	sb.append(is_HTML); 
+		sb.append("\" DNFLOGS = \"" ); 	sb.append(noFindLogs ); 
+		sb.append("\" ocCacheID = \"" );sb.append(ocCacheID ); 
+		sb.append("\" is_INCOMPLETE = \"");sb.append(is_incomplete); 
+		sb.append("\" lastSyncOC = \"" );sb.append(lastSyncOC ); 
+		sb.append("\" num_recommended = \"");sb.append(Convert.formatInt(numRecommended)); 
+		sb.append("\" num_found = \"" );sb.append(Convert.formatInt(numLogsSinceRecommendation));
+		sb.append("\" />\n");
+		return sb.toString();
+	}
 
-/** Return a XML string containing all the cache data for storing in index.xml */
-public String toXML() {
-	sb.delete(0,sb.length());
-	sb.append("    <CACHE name = \"");
-	sb.append(SafeXML.clean(CacheName));
-	sb.append("\" owner = \"");		sb.append(SafeXML.clean(CacheOwner));
-	sb.append("\" lat = \""); 		sb.append(pos.latDec ); 
-	sb.append("\" lon = \"");		sb.append(pos.lonDec);
-	sb.append("\" hidden = \"");	sb.append(DateHidden);
-	sb.append("\" wayp = \"");		sb.append(SafeXML.clean(wayPoint));
-	sb.append("\" status = \"");	sb.append(CacheStatus);
-	sb.append("\" type = \"");		sb.append(type);
-	sb.append("\" dif = \"");		sb.append(hard);
-	sb.append("\" terrain = \"" );	sb.append(terrain ); 
-	sb.append("\" filtered = \"" ); sb.append(is_filtered); // This was 'dirty', but dirty is not used
-	sb.append("\" size = \"");		sb.append(CacheSize);
-	sb.append("\" online = \"" );	sb.append(is_available); 
-	sb.append("\" archived = \"" );	sb.append(is_archived); 
-	sb.append("\" has_bug = \"" ); 	sb.append(has_bug); 
-	sb.append("\" black = \"" ); 	sb.append(is_black); 
-	sb.append("\" owned = \"" ); 	sb.append(is_owned); 
-	sb.append("\" found = \"" ); 	sb.append(is_found); 
-	sb.append("\" is_new = \"" );	sb.append(is_new);
-	sb.append("\" is_log_update = \"" );sb.append(is_log_update); 
-	sb.append("\" is_update = \"" );sb.append(is_update); 
-	sb.append("\" is_HTML = \"" ); 	sb.append(is_HTML); 
-	sb.append("\" DNFLOGS = \"" ); 	sb.append(noFindLogs ); 
-	sb.append("\" ocCacheID = \"" );sb.append(ocCacheID ); 
-	sb.append("\" is_INCOMPLETE = \"");sb.append(is_incomplete); 
-	sb.append("\" lastSyncOC = \"" );sb.append(lastSyncOC ); 
-	sb.append("\" />\n");
-	return sb.toString();
-}
+	public void setLatLon(String latLon) {
+		latLon=latLon.trim();
+		if (!latLon.equals(LatLon.trim())) is_update=true;
+		LatLon = latLon;
+		pos.set(latLon);
+	}
 
-public void setLatLon(String latLon) {
-	latLon=latLon.trim();
-	if (!latLon.equals(LatLon.trim())) is_update=true;
-	LatLon = latLon;
-	pos.set(latLon);
-}
+	public boolean isAddiWpt() {
+		return CacheType.isAddiWpt(this.type);
+	}
 
-public boolean isAddiWpt() {
-	   return CacheType.isAddiWpt(this.type);
-   }
+	public boolean hasAddiWpt() {
+		if (this.addiWpts.getCount()>0) return true;
+		else return false;
+	}
 
-   public boolean hasAddiWpt() {
-	   if (this.addiWpts.getCount()>0) return true;
-	   else return false;
-   }
 
-   
-   public void calcDistance(CWPoint toPoint) {	
-	   if(pos.isValid()){
+	public void calcDistance(CWPoint toPoint) {	
+		if(pos.isValid()){
 			kilom = pos.getDistance(toPoint);
 			degrees = toPoint.getBearing(pos);
 			bearing = CWPoint.getDirection(degrees);
 			distance = MyLocale.formatDouble(kilom,"0.00")+" km";
-	   } else {
-		   distance = NODISTANCE;
-		   bearing = NOBEARING;
-	   }
-   }
-   public void setAttributesFromMainCache(CacheHolder mainCh){
-	   this.CacheOwner = mainCh.CacheOwner;
-	   this.CacheStatus = mainCh.CacheStatus;
-	   this.is_archived = mainCh.is_archived;
-	   this.is_available = mainCh.is_available;
-	   this.is_black = mainCh.is_black;
-	   this.is_owned = mainCh.is_owned;
-	   this.is_new = mainCh.is_new;
-	   this.is_found = mainCh.is_found;
-   }
-   
-   public void setAttributesToAddiWpts(){
-	   if (this.hasAddiWpt()){
-		   CacheHolder addiWpt;
-		   for (int i= this.addiWpts.getCount() - 1;  i>=0; i--){
-			    addiWpt = (CacheHolder) this.addiWpts.get(i);
-			    addiWpt.setAttributesFromMainCache(this);
-		   }
-	   }
-   }
-   
-   /**
-    * True if ch and this belong to the same main cache. 
-    * @param ch
-    * @return
-    */
-   public boolean hasSameMainCache(CacheHolder ch) {
-	   if (this == ch) return true;
-	   if (ch == null) return false;
-	   if ((!this.isAddiWpt()) && (!ch.isAddiWpt())) return false;
-	   CacheHolder main1, main2;
-	   if (this.isAddiWpt()) main1 = this.mainCache;  else main1 = this;
-	   if (ch.isAddiWpt()) main2 = ch.mainCache; else main2 = ch; 
-	   return main1 == main2;
-   }
-   
-   /** 
-    * Call this method to get the long-description and so on.
-    * If the according .xml-file is already read, it will return
-    * that one, otherwise it will be loaded.
-    * To avoid memory problems this routine loads not for more caches than maxDetails
-    * the details. If maxdetails is reached, it will remove from RAM the details 
-    * of the 5 caches that were loaded most long ago.
-    * 
-    * @return the respective CacheHolderDetail, null if according xml-file could not be read
-    */
-   
-   public CacheHolderDetail getCacheDetails(boolean maybenew) {
-	   if (details != null) {
-		   details.update(this); // TODO is this logic? what happens if the details were changed and getDetails() is called afterwards all changes will be lost?!
-		   return details;
-	   }
-	   details = new CacheHolderDetail(this);
-	   try {
-		   details.readCache(Global.getProfile().dataDir);
-	   } catch (IOException e) {
-		   if (maybenew) details.update(this);
-		   else {
-			   (new MessageBox("Error", "Could not read cache details for cache: "+this.wayPoint, MessageBox.OKB)).execute();
-			   return null;
-		   } 
-	   }
-	   detailsAdded();
-	   return details;
-   }
-   
-   /**
-    * Call this after you added the cache with details to the 
-    * cacheDB <br> It is assumed that that details is set
-    * for an example see OCXMLImporter.endCache()
-    *
-    */
-   public void detailsAdded() {
-	   if (cachesWithLoadedDetails.size() >= Global.getPref().maxDetails) removeOldestDetails();
-	   cachesWithLoadedDetails.add(this);
-	   
-   }
-   
-   public void releaseCacheDetails() {
-	   if (details != null && details.hasUnsavedChanges) 
-		   details.saveCacheDetails(Global.getProfile().dataDir);
-	   details = null;
-	   cachesWithLoadedDetails.remove(this);
-   }
-   
-   public void cacheAdded(CacheHolderDetail chd) {
-	   
-   }
-   
-   //final static int maxDetails = 50; 
-   static Vector cachesWithLoadedDetails = new Vector(Global.getPref().maxDetails);
-   
-   public static void removeOldestDetails() {
-	   for (int i=0; i<Global.getPref().deleteDetails; i++)
-		   ((CacheHolder)(cachesWithLoadedDetails.get(0))).releaseCacheDetails();
-   }
- 
-   public static void removeAllDetails() {
-	   for (int i=cachesWithLoadedDetails.size()-1; i>=0; i--)
-		   ((CacheHolder)(cachesWithLoadedDetails.get(0))).releaseCacheDetails();
-   }
-   
-   /**
-    * when importing caches you can set details.saveChanges = true
-    * when the import ist finished call this method to save the pending changes
-    *
-    */
-   public static void saveAllModifiedDetails() {
-	   CacheHolderDetail chD;
-	   for (int i=cachesWithLoadedDetails.size()-1; i>=0; i--) {
-		   chD = ((CacheHolder)(cachesWithLoadedDetails.get(i))).getCacheDetails(false);
-		   if (chD.hasUnsavedChanges) 
-			   chD.saveCacheDetails(Global.getProfile().dataDir);
-		   	
-	   }
-   }
+		} else {
+			distance = NODISTANCE;
+			bearing = NOBEARING;
+		}
+	}
+	public void setAttributesFromMainCache(CacheHolder mainCh){
+		this.CacheOwner = mainCh.CacheOwner;
+		this.CacheStatus = mainCh.CacheStatus;
+		this.is_archived = mainCh.is_archived;
+		this.is_available = mainCh.is_available;
+		this.is_black = mainCh.is_black;
+		this.is_owned = mainCh.is_owned;
+		this.is_new = mainCh.is_new;
+		this.is_found = mainCh.is_found;
+	}
 
-   /*
+	public void setAttributesToAddiWpts(){
+		if (this.hasAddiWpt()){
+			CacheHolder addiWpt;
+			for (int i= this.addiWpts.getCount() - 1;  i>=0; i--){
+				addiWpt = (CacheHolder) this.addiWpts.get(i);
+				addiWpt.setAttributesFromMainCache(this);
+			}
+		}
+	}
+
+	/**
+	 * True if ch and this belong to the same main cache. 
+	 * @param ch
+	 * @return
+	 */
+	public boolean hasSameMainCache(CacheHolder ch) {
+		if (this == ch) return true;
+		if (ch == null) return false;
+		if ((!this.isAddiWpt()) && (!ch.isAddiWpt())) return false;
+		CacheHolder main1, main2;
+		if (this.isAddiWpt()) main1 = this.mainCache;  else main1 = this;
+		if (ch.isAddiWpt()) main2 = ch.mainCache; else main2 = ch; 
+		return main1 == main2;
+	}
+
+	/** 
+	 * Call this method to get the long-description and so on.
+	 * If the according .xml-file is already read, it will return
+	 * that one, otherwise it will be loaded.
+	 * To avoid memory problems this routine loads not for more caches than maxDetails
+	 * the details. If maxdetails is reached, it will remove from RAM the details 
+	 * of the 5 caches that were loaded most long ago.
+	 * 
+	 * @return the respective CacheHolderDetail, null if according xml-file could not be read
+	 */
+
+	public CacheHolderDetail getCacheDetails(boolean maybenew) {
+		if (details != null) {
+			details.update(this); // TODO is this logic? what happens if the details were changed and getDetails() is called afterwards all changes will be lost?!
+			return details;
+		}
+		details = new CacheHolderDetail(this);
+		try {
+			details.readCache(Global.getProfile().dataDir);
+		} catch (IOException e) {
+			if (maybenew) details.update(this);
+			else {
+				(new MessageBox("Error", "Could not read cache details for cache: "+this.wayPoint, MessageBox.OKB)).execute();
+				return null;
+			} 
+		}
+		detailsAdded();
+		return details;
+	}
+
+	/**
+	 * Call this after you added the cache with details to the 
+	 * cacheDB <br> It is assumed that that details is set
+	 * for an example see OCXMLImporter.endCache()
+	 *
+	 */
+	public void detailsAdded() {
+		cachesWithLoadedDetails.add(this);
+		if (cachesWithLoadedDetails.size() >= Global.getPref().maxDetails) removeOldestDetails();
+	}
+
+	public void releaseCacheDetails() {
+		if (details != null && details.hasUnsavedChanges){
+			//calcRecommendationScore();
+			details.saveCacheDetails(Global.getProfile().dataDir);
+			this.update(details);
+		}
+		details = null;
+		cachesWithLoadedDetails.remove(this);
+	}
+
+	//final static int maxDetails = 50; 
+	static Vector cachesWithLoadedDetails = new Vector(Global.getPref().maxDetails);
+
+	public static void removeOldestDetails() {
+		for (int i=0; i<Global.getPref().deleteDetails; i++)
+			((CacheHolder)(cachesWithLoadedDetails.get(0))).releaseCacheDetails();
+	}
+
+	public static void removeAllDetails() {
+		for (int i=cachesWithLoadedDetails.size()-1; i>=0; i--)
+			((CacheHolder)(cachesWithLoadedDetails.get(0))).releaseCacheDetails();
+	}
+
+	/**
+	 * when importing caches you can set details.saveChanges = true
+	 * when the import ist finished call this method to save the pending changes
+	 *
+	 */
+	public static void saveAllModifiedDetails() {
+		CacheHolder ch;
+		CacheHolderDetail chD;
+		for (int i=cachesWithLoadedDetails.size()-1; i>=0; i--) {
+			ch = (CacheHolder)(cachesWithLoadedDetails.get(i));
+			chD = ch.getCacheDetails(false);
+			if (chD.hasUnsavedChanges) {
+				//ch.calcRecommendationScore();
+				chD.saveCacheDetails(Global.getProfile().dataDir);
+				ch.update(chD);
+			}
+		}
+	}
+
+	/*
 public void finalize() {nObjects--;
    Vm.debug("Destroying CacheHolder "+wayPoint);
    Vm.debug("CacheHolder: "+nObjects+" objects left");
 }
-*/
+	 */
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/Log.java
===================================================================
--- trunk/src/CacheWolf/Log.java	2007-11-25 22:33:25 UTC (rev 1106)
+++ trunk/src/CacheWolf/Log.java	2007-11-26 17:03:23 UTC (rev 1107)
@@ -1,6 +1,6 @@
 package CacheWolf;
 
-public class Log {//static int nObj=0;
+public class Log {
 	private static String MAXLOGICON="MAXLOG";
 	private static String INVALIDLOGICON=null;
 	/** The icon which describes the log e.g. icon_sad */
@@ -19,7 +19,7 @@
 	 * or <img src='ICON'>&nbsp;DATE by LOGGER<br>MESSAGE</pre>
 	 * @param logLine
 	 */
-	Log(String logLine) {//nObj++;ewe.sys.Vm.debug("Log: "+nObj+" objects");
+	Log(String logLine) {
 //		RECOMMENDED="1"<img src='icon_smile.gif'>&nbsp;2007-01-14 xyz<br>a wonderful log
 		try {
 			int ic1=logLine.indexOf("RECOMMENDED=\"1\"");
@@ -47,7 +47,7 @@
 		}
 	}
 	
-	Log(String icon, String date, String logger, String message) {//nObj++;ewe.sys.Vm.debug("Log: "+nObj+" objects");
+	Log(String icon, String date, String logger, String message) {
 		this(icon, date, logger, message, false);
 	}
 	
@@ -59,7 +59,7 @@
 		this.recommended = recommended_;
 	}
 	
-	public static Log maxLog() {//nObj++;ewe.sys.Vm.debug("Log: "+nObj+" objects");
+	public static Log maxLog() {
 		return new Log(MAXLOGICON,"1900-00-00","","");
 	}
 	
@@ -87,13 +87,17 @@
 	public void setMessage(String message) {
 		this.message = message.trim();
 	}
-	public void setRecommendation (boolean recommended_) {
+	public void setRecommandation (boolean recommended_) {
 		recommended = recommended_;
 	}
-	public boolean getRecommendation () {
+	public boolean isRecomended() {
 		return recommended;
 	}
-
+	
+	public boolean isFoundLog() {
+		return icon.equals(GPXImporter.typeText2Image("Found"));
+	}
+	
 	/** Return XML representation of log for storing in cache.xml */
 	public String toXML(){
 		StringBuffer s=new StringBuffer(400);
@@ -122,8 +126,4 @@
 		s.append(message.trim());
 		return s.toString();
 	}
-/*	public void finalize() {nObj--;
-	   ewe.sys.Vm.debug("Log: "+nObj+" objects left");
-	}
-*/	
 }

Modified: trunk/src/CacheWolf/LogList.java
===================================================================
--- trunk/src/CacheWolf/LogList.java	2007-11-25 22:33:25 UTC (rev 1106)
+++ trunk/src/CacheWolf/LogList.java	2007-11-26 17:03:23 UTC (rev 1107)
@@ -101,15 +101,34 @@
 		}
 		return countNoFoundLogs;
 	 }
-	
+
+	 /** only valid after calling calcRecommendations() */
+	 int numRecommended = 0;
+	 /** only valid after calling calcRecommendations() */
+	 int foundsSinceRecommendation = 0;
+	 /** only valid after calling calcRecommendations() */
+	 int recommendationRating = 0;
+	 
 	 /**
-	  * Count the number of OC Recommendations
-	  * @return Number of OC recommendations
+	  * call this to 
+	  *
 	  */
-	 public int countRecommendations() {
-		 int nRec=0;
-		 for (int i=size()-1; i>=0; i--)
-			 if (getLog(i).getRecommendation()) nRec++;
-		 return nRec;
+	 public void calcRecommendations() {
+		 numRecommended = 0;
+		 foundsSinceRecommendation = 0;
+		 Log l;
+		 int s = size();
+		 int i;
+		 for (i= 0 ; i < s; i++){
+			 l = getLog(i);
+			 if (l.getDate().compareTo("2007-01-14") < 0) break; // this is the date when the recommendation system was introdueced in opencaching.de see: http://www.geoclub.de/viewtopic.php?t=14901&highlight=formel
+			 if (l.isRecomended()) numRecommended++;
+			 if (l.isFoundLog()) foundsSinceRecommendation++; 
+		 }
+		 recommendationRating = getScore(numRecommended, foundsSinceRecommendation);
 	 }
+	 
+	 public static int getScore(int numrecommends, int numfoudlogs) {
+		 return Math.round(((numrecommends * numrecommends +1 ) / (numfoudlogs / 10 +1))*100);
+	 }
 }

Modified: trunk/src/CacheWolf/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2007-11-25 22:33:25 UTC (rev 1106)
+++ trunk/src/CacheWolf/OCXMLImporter.java	2007-11-26 17:03:23 UTC (rev 1107)
@@ -77,20 +77,21 @@
 		}//for
 
 	}
+
+	/** true, if not the last syncdate shall be used, but the caches shall be reloaded
+	 * only used in syncSingle */
+	boolean reload;
 	/**
 	 * 
 	 * @param number
 	 * @param infB
 	 * @return true, if some change was made to the cacheDB
 	 */
-	/** true, if not the last syncdate shall be used, but the caches shall be reloaded
-	 * only used in syncSingle */
-	boolean reload;
 	public boolean syncSingle(int number, InfoBox infB) {
 		boolean success=true;
 
 		ch = (CacheHolder)cacheDB.get(number);
-		chD= new CacheHolderDetail(ch); //TODO is this still correct? use getDetails ?
+		chD= null; //new CacheHolderDetail(ch); //TODO is this still correct? use getDetails ?
 
 		if (infB.isClosed) {
 			if (askForOptions) return false; 
@@ -200,8 +201,6 @@
 			finalMessage = MyLocale.getMsg(1607,"Update from opencaching successful");
 			inf.setInfo(finalMessage);
 		}
-		CacheHolder.saveAllModifiedDetails();
-		profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR);
 		inf.addOkButton();
 	}
 	
@@ -265,6 +264,14 @@
 		} finally {
 			if (tmpFile != null) tmpFile.delete();
 		}
+		/*
+		for (int i=cacheDB.size()-1; i >=0; i--) {
+			ch = (CacheHolder)cacheDB.get(i);
+			if (ch.wayPoint.toUpperCase().startsWith("OC")) { //TODO only handle changed caches
+				ch.calcRecommendationScore();
+			}
+		} */
+		profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR);
 		inf.setInfo(finalMessage);
 
 		return success;

Modified: trunk/src/CacheWolf/Profile.java
===================================================================
--- trunk/src/CacheWolf/Profile.java	2007-11-25 22:33:25 UTC (rev 1106)
+++ trunk/src/CacheWolf/Profile.java	2007-11-26 17:03:23 UTC (rev 1107)
@@ -112,6 +112,7 @@
 			pbf.setTask(h,"Saving Index");
 			pbf.exec();
 		}
+		CacheHolder.saveAllModifiedDetails(); // this must be called first as it makes some calculations
 		PrintWriter detfile;
 		CacheHolder ch;
 		try {
@@ -170,7 +171,6 @@
 			detfile.print("</CACHELIST>\n");
 			detfile.close();
 			buildReferences(); //TODO Why is this needed here?
-			CacheHolder.saveAllModifiedDetails();
 			if(showprogress) pbf.exit(0);
 		}catch(Exception e){
 			Vm.debug("Problem writing to index file "+e.toString());

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2007-11-25 22:33:25 UTC (rev 1106)
+++ trunk/src/CacheWolf/myTableModel.java	2007-11-26 17:03:23 UTC (rev 1107)
@@ -301,11 +301,11 @@
 						}
 					case 13: // OC number of recommendations
 						if (ch.wayPoint.startsWith("OC"))
-							return (new Integer(ch.numRecommended)).toString();
+							return Convert.formatInt(ch.numRecommended);
 						return null;
 					case 14: // OC rating	
 						if (ch.wayPoint.startsWith("OC"))
-							return (new Integer(ch.recommendationScore)).toString();
+							return Convert.formatInt(ch.recommendationScore);
 						return null;
 				} // Switch
 			} // if



From pfeffer at mail.berlios.de  Mon Nov 26 18:42:33 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 26 Nov 2007 18:42:33 +0100
Subject: [Cachewolf-svn] r1108 - trunk/src/CacheWolf
Message-ID: <200711261742.lAQHgX9F021252@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-26 18:42:17 +0100 (Mon, 26 Nov 2007)
New Revision: 1108

Modified:
   trunk/src/CacheWolf/CacheHolder.java
Log:
fixed: I made a mistake while combining my and Salzkammergut's changes...

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-26 17:03:23 UTC (rev 1107)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-26 17:42:17 UTC (rev 1108)
@@ -121,7 +121,9 @@
 		try {
 			start=xmlString.indexOf('"'); end=xmlString.indexOf('"',start+1);
 			CacheName = SafeXML.cleanback(xmlString.substring(start+1,end));
-
+			
+			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
+            CacheOwner = SafeXML.cleanback(xmlString.substring(start+1,end));
 			// Assume coordinates are in decimal format
 			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
 			double lat=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
@@ -272,10 +274,10 @@
 	 */
 	public void calcRecommendationScore() {
 		if (wayPoint.toLowerCase().startsWith("oc") ) {
-			if (getCacheDetails(false) != null) {
-				CacheHolderDetail chD;
-				if (this instanceof CacheHolderDetail)	chD = (CacheHolderDetail)this;
-				else chD = details;
+			CacheHolderDetail chD;
+			if (this instanceof CacheHolderDetail)	chD = (CacheHolderDetail)this;
+			else chD = getCacheDetails(true, false);
+			if (chD != null) {
 				chD.CacheLogs.calcRecommendations();
 				recommendationScore = chD.CacheLogs.recommendationRating;
 				numLogsSinceRecommendation = chD.CacheLogs.foundsSinceRecommendation;
@@ -405,11 +407,24 @@
 	 * To avoid memory problems this routine loads not for more caches than maxDetails
 	 * the details. If maxdetails is reached, it will remove from RAM the details 
 	 * of the 5 caches that were loaded most long ago.
+	 */
+	public CacheHolderDetail getCacheDetails(boolean maybenew) {
+		return getCacheDetails(maybenew, true);
+	}
+	
+	/** 
+	 * Call this method to get the long-description and so on.
+	 * If the according .xml-file is already read, it will return
+	 * that one, otherwise it will be loaded.
+	 * To avoid memory problems this routine loads not for more caches than maxDetails
+	 * the details. If maxdetails is reached, it will remove from RAM the details 
+	 * of the 5 caches that were loaded most long ago.
 	 * 
+	 * @param alarmuser if true an error message will be displayed to the user, if the details could not be read
 	 * @return the respective CacheHolderDetail, null if according xml-file could not be read
 	 */
-
-	public CacheHolderDetail getCacheDetails(boolean maybenew) {
+		
+	public CacheHolderDetail getCacheDetails(boolean maybenew, boolean alarmuser) {
 		if (details != null) {
 			details.update(this); // TODO is this logic? what happens if the details were changed and getDetails() is called afterwards all changes will be lost?!
 			return details;
@@ -420,7 +435,7 @@
 		} catch (IOException e) {
 			if (maybenew) details.update(this);
 			else {
-				(new MessageBox("Error", "Could not read cache details for cache: "+this.wayPoint, MessageBox.OKB)).execute();
+				if (alarmuser) (new MessageBox("Error", "Could not read cache details for cache: "+this.wayPoint, MessageBox.OKB)).execute();
 				return null;
 			} 
 		}



From pfeffer at mail.berlios.de  Mon Nov 26 19:17:46 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 26 Nov 2007 19:17:46 +0100
Subject: [Cachewolf-svn] r1109 - trunk/src/CacheWolf
Message-ID: <200711261817.lAQIHkj0030677@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-26 19:17:33 +0100 (Mon, 26 Nov 2007)
New Revision: 1109

Modified:
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/Log.java
   trunk/src/CacheWolf/LogList.java
Log:
OC-Download: everything is working now. But: Salzkammergut: you need to delete your pref.xml in order to be able to use the new coloumns.  And: could you make the new coloumns to be displayed by default?

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-26 17:42:17 UTC (rev 1108)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-26 18:17:33 UTC (rev 1109)
@@ -205,10 +205,10 @@
 			lastSyncOC = xmlString.substring(start+1,end);
 
 			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-			numLogsSinceRecommendation = Convert.toInt(xmlString.substring(start+1,end));
+			numRecommended = Convert.toInt(xmlString.substring(start+1,end));
 
 			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-			numRecommended = Convert.toInt(xmlString.substring(start+1,end));
+			numLogsSinceRecommendation = Convert.toInt(xmlString.substring(start+1,end));
 			recommendationScore = LogList.getScore(numRecommended, numLogsSinceRecommendation);
 		} catch (Exception ex) {
 

Modified: trunk/src/CacheWolf/Log.java
===================================================================
--- trunk/src/CacheWolf/Log.java	2007-11-26 17:42:17 UTC (rev 1108)
+++ trunk/src/CacheWolf/Log.java	2007-11-26 18:17:33 UTC (rev 1109)
@@ -87,9 +87,7 @@
 	public void setMessage(String message) {
 		this.message = message.trim();
 	}
-	public void setRecommandation (boolean recommended_) {
-		recommended = recommended_;
-	}
+
 	public boolean isRecomended() {
 		return recommended;
 	}

Modified: trunk/src/CacheWolf/LogList.java
===================================================================
--- trunk/src/CacheWolf/LogList.java	2007-11-26 17:42:17 UTC (rev 1108)
+++ trunk/src/CacheWolf/LogList.java	2007-11-26 18:17:33 UTC (rev 1109)
@@ -128,7 +128,7 @@
 		 recommendationRating = getScore(numRecommended, foundsSinceRecommendation);
 	 }
 	 
-	 public static int getScore(int numrecommends, int numfoudlogs) {
-		 return Math.round(((numrecommends * numrecommends +1 ) / (numfoudlogs / 10 +1))*100);
+	 public static int getScore(int numrecommends, int numfoundlogs) {
+		 return Math.round((((float)numrecommends * (float)numrecommends +1f ) / ((float)numfoundlogs / 10f +1f))*100f);
 	 }
 }



From pfeffer at mail.berlios.de  Mon Nov 26 20:12:08 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 26 Nov 2007 20:12:08 +0100
Subject: [Cachewolf-svn] r1110 - trunk/src/CacheWolf
Message-ID: <200711261912.lAQJC8jS019487@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-26 20:12:03 +0100 (Mon, 26 Nov 2007)
New Revision: 1110

Modified:
   trunk/src/CacheWolf/CacheHolder.java
Log:
CacheHolder: rename a newly introduced variable

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-11-26 18:17:33 UTC (rev 1109)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-11-26 19:12:03 UTC (rev 1110)
@@ -79,8 +79,8 @@
 	public int noFindLogs = 0;
 	/** Number of recommendations (from the opencaching logs) */
 	public int numRecommended = 0;
-	/** Number of logs since start of recommendations system */
-	public int numLogsSinceRecommendation = 0;
+	/** Number of Founds since start of recommendations system */
+	public int numFoundsSinceRecommendation = 0;
 	/** Recommendation score: calculated as rations  numRecommended / numLogsSinceRecommendation * 100 */
 	public int recommendationScore = 0;
 	/** True if this cache has travelbugs */
@@ -208,8 +208,8 @@
 			numRecommended = Convert.toInt(xmlString.substring(start+1,end));
 
 			start=xmlString.indexOf('"',end+1); end=xmlString.indexOf('"',start+1);
-			numLogsSinceRecommendation = Convert.toInt(xmlString.substring(start+1,end));
-			recommendationScore = LogList.getScore(numRecommended, numLogsSinceRecommendation);
+			numFoundsSinceRecommendation = Convert.toInt(xmlString.substring(start+1,end));
+			recommendationScore = LogList.getScore(numRecommended, numFoundsSinceRecommendation);
 		} catch (Exception ex) {
 
 		}
@@ -217,7 +217,7 @@
 
 	public void update(CacheHolder ch) {
 		this.recommendationScore = ch.recommendationScore;
-		this.numLogsSinceRecommendation = ch.numLogsSinceRecommendation;
+		this.numFoundsSinceRecommendation = ch.numFoundsSinceRecommendation;
 		this.numRecommended = ch.numRecommended;
 		/* Here we have to distinguish several cases:
 	   this.is_found       this                ch               Update 'this'
@@ -280,21 +280,21 @@
 			if (chD != null) {
 				chD.CacheLogs.calcRecommendations();
 				recommendationScore = chD.CacheLogs.recommendationRating;
-				numLogsSinceRecommendation = chD.CacheLogs.foundsSinceRecommendation;
+				numFoundsSinceRecommendation = chD.CacheLogs.foundsSinceRecommendation;
 				numRecommended = chD.CacheLogs.numRecommended;
 			} else { // cache doesn't have details
 				recommendationScore = -1;
-				numLogsSinceRecommendation = -1;
+				numFoundsSinceRecommendation = -1;
 				numRecommended = -1;
 			}
 		} else {
 			recommendationScore = -1;
-			numLogsSinceRecommendation = -1;
+			numFoundsSinceRecommendation = -1;
 			numRecommended = -1;
 		}
 		if (details != null) {
 		details.recommendationScore = recommendationScore;
-		details.numLogsSinceRecommendation = numLogsSinceRecommendation;
+		details.numFoundsSinceRecommendation = numFoundsSinceRecommendation;
 		details.numRecommended = numRecommended;
 		}
 	}
@@ -331,7 +331,7 @@
 		sb.append("\" is_INCOMPLETE = \"");sb.append(is_incomplete); 
 		sb.append("\" lastSyncOC = \"" );sb.append(lastSyncOC ); 
 		sb.append("\" num_recommended = \"");sb.append(Convert.formatInt(numRecommended)); 
-		sb.append("\" num_found = \"" );sb.append(Convert.formatInt(numLogsSinceRecommendation));
+		sb.append("\" num_found = \"" );sb.append(Convert.formatInt(numFoundsSinceRecommendation));
 		sb.append("\" />\n");
 		return sb.toString();
 	}



From salzkammergut at mail.berlios.de  Mon Nov 26 20:51:25 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Mon, 26 Nov 2007 20:51:25 +0100
Subject: [Cachewolf-svn] r1111 - trunk/src/CacheWolf
Message-ID: <200711261951.lAQJpPHD021426@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-26 20:51:19 +0100 (Mon, 26 Nov 2007)
New Revision: 1111

Modified:
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/TableColumnChooser.java
Log:
Fix for Exception problem with new columns

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-26 19:12:03 UTC (rev 1110)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-26 19:51:19 UTC (rev 1111)
@@ -96,7 +96,7 @@
 	public boolean tabsAtTop=true;
 	/** True if the status bar is to be displayed (hidden if false) */
 	public boolean showStatus=true;
-	//public boolean noTabs=false;
+	public boolean noTabs=false;
 	/** True if the application can be closed by clicking on the close button in the top line.
 	 * This can be set to avoid accidental closing of the application */
 	public boolean hasCloseButton=true;
@@ -243,7 +243,7 @@
 		}
 		if (name.equals("listview")) {
 			listColMap=atts.getValue("colmap");
-			listColWidth=atts.getValue("colwidths");	
+			listColWidth=atts.getValue("colwidths")+",30,30"; // append default values for older versions	
 		}
 		if(name.equals("proxy")) {
 			myproxy = atts.getValue("prx");

Modified: trunk/src/CacheWolf/TableColumnChooser.java
===================================================================
--- trunk/src/CacheWolf/TableColumnChooser.java	2007-11-26 19:12:03 UTC (rev 1110)
+++ trunk/src/CacheWolf/TableColumnChooser.java	2007-11-26 19:51:19 UTC (rev 1111)
@@ -11,8 +11,8 @@
 public class TableColumnChooser extends CellPanel {
 
 	String [] colNames;
-	Vector shownCols=new Vector(14);
-	Vector hiddenCols=new Vector(14);
+	Vector shownCols=new Vector(20);
+	Vector hiddenCols=new Vector(20);
 	private mButton btnDown,btnUp,btnLeft,btnRight;
 	private myList lstShown,lstHidden;
 	



From mik77 at mail.berlios.de  Mon Nov 26 21:01:25 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Mon, 26 Nov 2007 21:01:25 +0100
Subject: [Cachewolf-svn] r1112 - trunk/src/CacheWolf
Message-ID: <200711262001.lAQK1PY4022436@sheep.berlios.de>

Author: mik77
Date: 2007-11-26 21:01:21 +0100 (Mon, 26 Nov 2007)
New Revision: 1112

Modified:
   trunk/src/CacheWolf/CoordsScreen.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
Log:
Correct handling for invalid coordinates in CoordsScreen

Modified: trunk/src/CacheWolf/CoordsScreen.java
===================================================================
--- trunk/src/CacheWolf/CoordsScreen.java	2007-11-26 19:51:19 UTC (rev 1111)
+++ trunk/src/CacheWolf/CoordsScreen.java	2007-11-26 20:01:21 UTC (rev 1112)
@@ -160,8 +160,14 @@
 		}
 		else if (format == CWPoint.GK){
 			inpUTMZone.setText("");
-			inpUTMNorthing.setText(coords.getGKNorthing(0));
-			inpUTMEasting.setText((coords.getGKEasting(0)));
+			if (coords.isValid()){
+				inpUTMNorthing.setText(coords.getGKNorthing(0));
+				inpUTMEasting.setText((coords.getGKEasting(0)));				
+			}
+			else {
+				inpUTMNorthing.setText("0");
+				inpUTMEasting.setText("0");
+			}
 		}
 		else {
 			chcNS.setInt(coords.getNSLetter().equals("N")?0:1);
@@ -255,10 +261,12 @@
 			
 			if (ev.target == btnGps){
 				Navigate nav=Global.mainTab.nav;
-				CWPoint coord = nav.gpsPos;
-				currFormat = chkFormat.getSelectedIndex();
-				setFields(coord,currFormat);
-				activateFields(currFormat);
+				if (nav.gpsPos.isValid()){
+					CWPoint coord = nav.gpsPos;
+					currFormat = chkFormat.getSelectedIndex();
+					setFields(coord,currFormat);
+					activateFields(currFormat);
+				}
 			}
 		}
 		super.onEvent(ev);

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-26 19:51:19 UTC (rev 1111)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-26 20:01:21 UTC (rev 1112)
@@ -49,7 +49,7 @@
 		if ( ((ewe.fx.Rect) (Window.getGuiInfo(Window.INFO_SCREEN_RECT,null,new ewe.fx.Rect(),0))).height > 400) 
 			 fontSize = 16;
 		else 
-			 fontSize = 12;
+			 fontSize = 11;
 	}
 
     //////////////////////////////////////////////////////////////////////////////////////
@@ -88,7 +88,7 @@
 	/** Timer for logging GPS data */
 	public String logGPSTimer = "";
 	/** The default font size */
-	public int fontSize = 12;
+	public int fontSize = 11;
 	// These settings govern where the menu and the tabs are displayed and whether the statusbas is shown
 	/** True if the menu is to be displayed at the top of the screen */
 	public boolean menuAtTop=true;

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-11-26 19:51:19 UTC (rev 1111)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-11-26 20:01:21 UTC (rev 1112)
@@ -224,7 +224,7 @@
 					pref.baseDir = DataDir.getText();
 				//}
 				pref.fontSize = Convert.toInt(fontSize.getText());
-				if (pref.fontSize<6) pref.fontSize=12;
+				if (pref.fontSize<6) pref.fontSize=11;
 				pref.logsPerPage=Common.parseInt(inpLogsPerPage.getText());
 				if (pref.logsPerPage==0) pref.logsPerPage=pref.DEFAULT_LOGS_PER_PAGE;
 				pref.maxLogsToSpider=Common.parseInt(inpMaxLogsToSpider.getText());



From salzkammergut at mail.berlios.de  Mon Nov 26 21:35:10 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Mon, 26 Nov 2007 21:35:10 +0100
Subject: [Cachewolf-svn] r1113 - trunk/src/CacheWolf
Message-ID: <200711262035.lAQKZAja024679@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-26 21:35:06 +0100 (Mon, 26 Nov 2007)
New Revision: 1113

Modified:
   trunk/src/CacheWolf/Preferences.java
Log:
Display new columns by default with newly generated pref.xml

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-26 20:01:21 UTC (rev 1112)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-26 20:35:06 UTC (rev 1113)
@@ -96,7 +96,7 @@
 	public boolean tabsAtTop=true;
 	/** True if the status bar is to be displayed (hidden if false) */
 	public boolean showStatus=true;
-	public boolean noTabs=false;
+	//public boolean noTabs=false;
 	/** True if the application can be closed by clicking on the close button in the top line.
 	 * This can be set to avoid accidental closing of the application */
 	public boolean hasCloseButton=true;
@@ -244,6 +244,7 @@
 		if (name.equals("listview")) {
 			listColMap=atts.getValue("colmap");
 			listColWidth=atts.getValue("colwidths")+",30,30"; // append default values for older versions	
+			if((new StringTokenizer(listColWidth,",")).countTokens()<15) listColWidth+=",30,30"; // for older versions
 		}
 		if(name.equals("proxy")) {
 			myproxy = atts.getValue("prx");



From salzkammergut at mail.berlios.de  Mon Nov 26 22:34:36 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Mon, 26 Nov 2007 22:34:36 +0100
Subject: [Cachewolf-svn] r1114 - trunk/res_noewe
Message-ID: <200711262134.lAQLYaVg028826@sheep.berlios.de>

Author: salzkammergut
Date: 2007-11-26 22:34:33 +0100 (Mon, 26 Nov 2007)
New Revision: 1114

Added:
   trunk/res_noewe/recommendedlog.gif
Log:
The icon for OC recommendaations

Added: trunk/res_noewe/recommendedlog.gif
===================================================================
(Binary files differ)


Property changes on: trunk/res_noewe/recommendedlog.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From pfeffer at mail.berlios.de  Tue Nov 27 02:00:37 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 27 Nov 2007 02:00:37 +0100
Subject: [Cachewolf-svn] r1115 - trunk/src/CacheWolf
Message-ID: <200711270100.lAR10bBW025221@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-27 02:00:31 +0100 (Tue, 27 Nov 2007)
New Revision: 1115

Modified:
   trunk/src/CacheWolf/OCXMLImporter.java
Log:
Opencaching download: added import summary
Opencaching download: fixed: sometimes written 0 Bytes in image downloads due to the use of BufferedOutStream, replaced by FileOutputStream (this hopefully doesn't worsen the speed)
Opencaching download: proxy usage now correct, using the new way

Modified: trunk/src/CacheWolf/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2007-11-26 21:34:33 UTC (rev 1114)
+++ trunk/src/CacheWolf/OCXMLImporter.java	2007-11-27 01:00:31 UTC (rev 1115)
@@ -167,7 +167,7 @@
 		}
 		profile.distOC = dist;
 		// Clear status of caches in db
-		for(int i = 0; i<cacheDB.size();i++){
+		for(int i = cacheDB.size()-1; i>=0 ;i--){
 			ch = (CacheHolder)cacheDB.get(i);
 			ch.is_update = false;
 			ch.is_new = false;
@@ -198,7 +198,11 @@
 		if (success) {
 			profile.last_sync_opencaching = dateOfthisSync.format("yyyyMMddHHmmss");
 			//pref.savePreferences();
-			finalMessage = MyLocale.getMsg(1607,"Update from opencaching successful");
+			finalMessage = MyLocale.getMsg(1607,"Update from opencaching successful"); 
+			inf.addWarning("\nNumber of"+
+			"\n...caches new/updated: " + numCacheImported +
+			"\n...cache descriptions new/updated: " + numDescImported +
+			"\n...logs new/updated: " + numLogImported);
 			inf.setInfo(finalMessage);
 		}
 		inf.addOkButton();
@@ -424,8 +428,9 @@
 				ch.details = chD;
 				cacheDB.add(ch);
 				ch.detailsAdded();
-				DBindexWpt.put((String)chD.wayPoint, new Integer(cacheDB.size()-1));
-				DBindexID.put((String)chD.ocCacheID, new Integer(cacheDB.size()-1));
+				Integer indexInt = new Integer(cacheDB.size()-1);
+				DBindexWpt.put((String)chD.wayPoint, indexInt);
+				DBindexID.put((String)chD.ocCacheID, indexInt);
 			}
 			// update (overwrite) data
 			else {
@@ -654,12 +659,7 @@
 		String address = new String(addr);
 		while (address != null && i <= maxRedirections ) { // allow max 5 redirections (http 302 location)
 			i++;
-			if(pref.myproxy.length() > 0){
-				conn = new HttpConnection(pref.myproxy, Convert.parseInt(pref.myproxyport), address);
-				Vm.debug("Proxy here: " + address);
-			} else {
-				conn = new HttpConnection(address);
-			}
+			conn = new HttpConnection(address);
 			conn.setRequestorProperty("USER_AGENT", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
 			conn.setRequestorProperty("Connection", "close");
 			conn.documentIsEncoded = true;
@@ -677,7 +677,7 @@
 		//save file
 		//Vm.debug("Save: " + myPref.mydatadir + fileName);
 		//Vm.debug("Daten: " + daten.length);
-		BufferedOutputStream outp =  new BufferedOutputStream(new FileOutputStream(profile.dataDir + fileName));
+		FileOutputStream outp =  new FileOutputStream(profile.dataDir + fileName);
 		outp.write(daten.toBytes());
 		outp.close();
 		sock.close();



From mik77 at mail.berlios.de  Fri Nov 30 02:21:17 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Fri, 30 Nov 2007 02:21:17 +0100
Subject: [Cachewolf-svn] r1116 - trunk/src/CacheWolf/navi
Message-ID: <200711300121.lAU1LHgt024108@sheep.berlios.de>

Author: mik77
Date: 2007-11-30 02:21:13 +0100 (Fri, 30 Nov 2007)
New Revision: 1116

Modified:
   trunk/src/CacheWolf/navi/GotoPanel.java
   trunk/src/CacheWolf/navi/MovingMap.java
Log:
First draft of a free dynamically scaling compass rose in GotoPanel without using bitmap images.

Modified: trunk/src/CacheWolf/navi/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/navi/GotoPanel.java	2007-11-27 01:00:31 UTC (rev 1115)
+++ trunk/src/CacheWolf/navi/GotoPanel.java	2007-11-30 01:21:13 UTC (rev 1116)
@@ -133,9 +133,10 @@
 		lblDST.setMenu(mnuContextFormt);
 		lblDST.modifyAll(Control.WantHoldDown, 0);
 		CoordsP.addLast(btnGoto = new mButton(getGotoBtnText()),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
-
+		
 		//Rose for bearing
-		compassRose = new GotoRose("rose.png");
+//		compassRose = new GotoRose("rose.png");
+		compassRose = new GotoRose();
 		icRose = new ImageControl(compassRose);
 		icRose.setMenu(mnuContextRose);
 		icRose.modifyAll(Control.WantHoldDown, 0); // this is necessary in order to make PenHold on a PDA work as right click
@@ -191,6 +192,15 @@
 
 //		}	
 	}
+	
+	public void resizeTo(int width, int height){
+		super.resizeTo(width, height);
+		Rect btnGotoRect = btnGoto.getRect();
+		int roseHeight = height - btnGotoRect.y - btnGotoRect.height - 40;
+		roseP.resizeTo(width, roseHeight);
+		icRose.resizeTo(width, roseHeight);
+		compassRose.resize(width, roseHeight);
+	}
 
 
 	/**
@@ -431,9 +441,12 @@
 	
 	String m_Luminary = MyLocale.getMsg(6100, "Sun");
 	
+	Font mainFont;
 	FontMetrics fm;
 	int lineHeight;
 	
+	int roseRadius;
+	
 	boolean northCentered = Global.getPref().northCenteredGoto;
 	
 	final static Color RED = new Color(255,0,0);
@@ -454,6 +467,10 @@
 		super(fn);
 	}
 	
+	public GotoRose(){
+		super();
+	}
+	
 	public void setWaypointDirectionDist(float wd, float dist) {
 		gotoDir = wd;
 		distance = dist;
@@ -488,17 +505,28 @@
 	 */
 	
 	public void doDraw(Graphics g,int options) {
+		g.setColor(Color.White);
+		g.fillRect(0, 0, location.width, location.height);
+
+		int fontSize = java.lang.Math.min(location.width, location.height) / 15;
+		mainFont = new Font("Verdana", Font.BOLD, fontSize);
+		g.setFont(mainFont);
+		fm = g.getFontMetrics(mainFont);
+		lineHeight = fm.getHeight() + 1;
+		roseRadius = java.lang.Math.min((location.width * 3) / 4, location.height) / 2;
+
 		if (northCentered) {
-			super.doDraw(g, options);
+			//scale(location.width, location.height, null, 0);
+			//super.doDraw(g, options);
+			drawFullRose(g, 0, new Color(255,255,255), new Color(200,200,200), new Color(255,255,255), new Color(200,200,200), new Color(150,150,150), new Color(75,75,75), 1.0f, true, true);
 		}
 		else {
-			g.setColor(Color.White);
-			g.fillRect(0, 0, location.width, location.height);
+			int radius = (int)((float)roseRadius * 0.75f);
+
+			g.setPen(new Pen(new Color(150,150,150),Pen.SOLID,3));
+			g.drawEllipse(location.width/2 - radius, location.height/2 - radius, 2 * radius, 2 * radius );
 		}
-		Font font = new Font("Verdana", Font.BOLD, 12);
-		g.setFont(font);
-		fm = g.getFontMetrics(font);
-		lineHeight = fm.getHeight() + 1;
+		
 		drawArrows(g);
 		drawWayPointData(g);
 		drawGpsData(g);
@@ -666,15 +694,12 @@
 			}
 			else {
 				//moveDir centered
-				int radius = (int)((float)(java.lang.Math.min(location.width, location.height) / 2) * 0.75f);
-
-				g.setPen(new Pen(new Color(150,150,150),Pen.SOLID,3));
-				g.drawEllipse(location.width/2 - radius, location.height/2 - radius, 2 * radius, 2 * radius );
-
 				if (moveDir < 360 && moveDir > -360) {
 					//drawDoubleArrow(g, 360 - moveDir, BLUE, new Color(175,0,0), 1.0f);
-					drawRose(g, 360 - moveDir, new Color(100,100,100), new Color(200,200,200), 1.0f);
+					//drawRose(g, 360 - moveDir, new Color(100,100,100), new Color(200,200,200), 1.0f);
+					drawFullRose(g, 360 - moveDir, new Color(255,255,255), new Color(200,200,200), new Color(150,150,150), new Color(200,200,200), new Color(200,200,200), new Color(75,75,75), 1.0f, false, false);
 					
+					int radius = (int)((float)roseRadius * 0.75f);
 					g.setPen(new Pen(RED,Pen.SOLID,3));
 					g.drawLine(location.width/2, location.height/2 - radius, location.width/2, location.height/2 + radius);
 					
@@ -694,7 +719,7 @@
 	private void drawSimpleArrow(Graphics g, float angle, Color col, float scale) {
 		float angleRad;
 		int x, y, centerX = location.width/2, centerY = location.height/2;
-		int arrowLength = java.lang.Math.min(centerX, centerY); 
+		int arrowLength = roseRadius; 
 
 		angleRad = (angle) * (float)java.lang.Math.PI / 180;
 		x = centerX + new Float(arrowLength * java.lang.Math.sin(angleRad) * scale).intValue();
@@ -706,7 +731,7 @@
 	private void drawSunArrow(Graphics g, float angle, Color col, float scale) {
 		float angleRad = (angle) * (float)java.lang.Math.PI / 180;
 		int centerX = location.width/2, centerY = location.height/2;
-		float arrowLength = (float)java.lang.Math.min(centerX, centerY) * scale;
+		float arrowLength = (float)roseRadius * scale;
 		float halfArrowWidth = arrowLength * 0.08f;
 		float circlePos = arrowLength * 0.7f;
 		int circleRadius = (int)(arrowLength * 0.1f);
@@ -740,7 +765,7 @@
 	private void drawThinArrow(Graphics g, float angle, Color col, Color colPoint, float scale) {
 		float angleRad = (angle) * (float)java.lang.Math.PI / 180;
 		int centerX = location.width/2, centerY = location.height/2;
-		float arrowLength = (float)java.lang.Math.min(centerX, centerY) * scale;
+		float arrowLength = (float)roseRadius * scale;
 		float halfOpeningAngle = (float)(java.lang.Math.PI * 0.03);
 		float sideLineLength = arrowLength * 0.75f;
 		
@@ -768,7 +793,7 @@
 	private void drawDoubleArrow(Graphics g, float angle, Color colFront, Color colRear, float scale) {
 		float angleRad = (angle) * (float)java.lang.Math.PI / 180;
 		int centerX = location.width/2, centerY = location.height/2;
-		float arrowLength = (float)java.lang.Math.min(centerX, centerY) * scale;
+		float arrowLength = (float)roseRadius * scale;
 		float halfArrowWidth = arrowLength * 0.1f;
 		
 		int[] pointsX = new int[3];
@@ -795,7 +820,7 @@
 	private void drawRose(Graphics g, float angle, Color colFront, Color colRear, float scale) {
 		float angleRad = (angle) * (float)java.lang.Math.PI / 180;
 		int centerX = location.width/2, centerY = location.height/2;
-		float arrowLength = (float)java.lang.Math.min(centerX, centerY) * scale;
+		float arrowLength = (float)roseRadius * scale;
 		float halfArrowWidth = arrowLength * 0.12f;
 		
 		int[] pointsX = new int[8];
@@ -826,10 +851,75 @@
 		g.fillPolygon(pointsX, pointsY, 3);
 	}
 	
+	private void drawFullRose(Graphics g, float angle, Color colLeft, Color colRight, Color colNorthLeft, Color colNorthRight,
+			Color colBorder, Color colText, float scale, boolean bDrawText, boolean bDrawEightArrows) {
+		float subScale1 = 1.0f;
+		float subScale2 = 0.9f;
+		float innerScale = 0.15f;
+		if(bDrawEightArrows){
+			innerScale = 0.12f;
+			drawRosePart(g,  45 + angle, colLeft, colRight, colBorder, colText, scale * subScale2, innerScale, "NE", bDrawText);
+			drawRosePart(g, 135 + angle, colLeft, colRight, colBorder, colText, scale * subScale2, innerScale, "SE", bDrawText);
+			drawRosePart(g, 225 + angle, colLeft, colRight, colBorder, colText, scale * subScale2, innerScale, "SW", bDrawText);
+			drawRosePart(g, 315 + angle, colLeft, colRight, colBorder, colText, scale * subScale2, innerScale, "NW", bDrawText);	
+		}
+
+		drawRosePart(g,   0 + angle, colNorthLeft, colNorthRight, colBorder, colText, scale * subScale1, innerScale, "N", bDrawText);
+		drawRosePart(g,  90 + angle, colLeft, colRight, colBorder, colText, scale * subScale1, innerScale, "E", bDrawText);
+		drawRosePart(g, 180 + angle, colLeft, colRight, colBorder, colText, scale * subScale1, innerScale, "S", bDrawText);
+		drawRosePart(g, 270 + angle, colLeft, colRight, colBorder, colText, scale * subScale1, innerScale, "W", bDrawText);
+	}
+	
+	private void drawRosePart(Graphics g, float angle, Color colLeft, Color colRight, Color colBorder, Color colText, float scale, float innerScale, String strDir, boolean bDrawText) {
+		float angleRad = angle * (float)java.lang.Math.PI / 180;
+		float angleRadText = (angle + 7.5f) * (float)java.lang.Math.PI / 180;
+		int centerX = location.width/2, centerY = location.height/2;
+				
+		float arrowLength = (float)roseRadius * scale;
+		float halfArrowWidth = arrowLength * innerScale;
+		
+		int[] pointsX = new int[3];
+		int[] pointsY = new int[3];
+
+		pointsX[0] = centerX;
+		pointsY[0] = centerY;
+		pointsX[1] = centerX + new Float(arrowLength * java.lang.Math.sin(angleRad)).intValue();
+		pointsY[1] = centerY - new Float(arrowLength * java.lang.Math.cos(angleRad)).intValue();
+		pointsX[2] = centerX + new Float(halfArrowWidth * java.lang.Math.sin(angleRad - java.lang.Math.PI / 4.0)).intValue();
+		pointsY[2] = centerY - new Float(halfArrowWidth * java.lang.Math.cos(angleRad - java.lang.Math.PI / 4.0)).intValue();
+				
+		g.setPen(new Pen(colBorder,Pen.SOLID,1));
+		g.setBrush(new Brush(colLeft, Brush.SOLID));
+		g.fillPolygon(pointsX, pointsY, 3);
+
+		pointsX[2] = centerX + new Float(halfArrowWidth * java.lang.Math.sin(angleRad + java.lang.Math.PI / 4.0)).intValue();
+		pointsY[2] = centerY - new Float(halfArrowWidth * java.lang.Math.cos(angleRad + java.lang.Math.PI / 4.0)).intValue();
+		
+		g.setBrush(new Brush(colRight, Brush.SOLID));
+		g.fillPolygon(pointsX, pointsY, 3);
+					
+		if (bDrawText){
+			int tempFontSize = new Float(scale * (float)mainFont.getSize()).intValue();
+			Font tempFont = new Font(mainFont.getName(), Font.BOLD, tempFontSize);
+			g.setFont(tempFont);
+			FontMetrics tempFm = g.getFontMetrics(tempFont);
+			float stringHeight = tempFm.getHeight();
+			float stringWidth = tempFm.getTextWidth( strDir );
+			float stringGap = (float)java.lang.Math.sqrt(stringHeight*stringHeight + stringWidth*stringWidth);
+
+			float stringPosition = arrowLength - stringGap / 2.0f;
+			g.setColor(colText);
+			g.drawText(strDir, centerX + new Float(stringPosition * java.lang.Math.sin(angleRadText) - stringWidth / 2.0f).intValue(),
+					           centerY - new Float(stringPosition * java.lang.Math.cos(angleRadText) + stringHeight / 2.0f).intValue());
+			
+			g.setFont(mainFont);
+		}
+	}
+	
 	private void drawThickArrow(Graphics g, float angle, Color col, float scale) {
 		float angleRad = (angle) * (float)java.lang.Math.PI / 180;
 		int centerX = location.width/2, centerY = location.height/2;
-		float arrowLength = (float)java.lang.Math.min(centerX, centerY) * scale;
+		float arrowLength = (float)roseRadius * scale;
 		float halfArrowWidth = arrowLength * 0.1f;
 		
 		int[] pointsX = new int[4];

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2007-11-27 01:00:31 UTC (rev 1115)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2007-11-30 01:21:13 UTC (rev 1116)
@@ -1001,7 +1001,7 @@
 			setResModus(MovingMap.NORMAL_KEEP_RESOLUTION);
 			dontUpdatePos = saveGpsIgnStatus;
 		}
-		else (new MessageBox("Error", "No "+ (betterOverview ? "less" : "more") + " deteiled map available", MessageBox.OKB)).execute();
+		else (new MessageBox("Error", "No "+ (betterOverview ? "less" : "more") + " detailed map available", MessageBox.OKB)).execute();
 	}
 
 	public void loadMapForAllCaches(){



From pfeffer at mail.berlios.de  Fri Nov 30 03:02:19 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 30 Nov 2007 03:02:19 +0100
Subject: [Cachewolf-svn] r1117 - trunk/src/CacheWolf/navi
Message-ID: <200711300202.lAU22J39026332@sheep.berlios.de>

Author: pfeffer
Date: 2007-11-30 03:02:16 +0100 (Fri, 30 Nov 2007)
New Revision: 1117

Modified:
   trunk/src/CacheWolf/navi/GotoPanel.java
Log:
GotoRose: correct calculation of space for the rose (@MiK: the position of the BtnGoto was relative to the cellpanel it is in --> use the cellpanel size and position of that instead)

Modified: trunk/src/CacheWolf/navi/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/navi/GotoPanel.java	2007-11-30 01:21:13 UTC (rev 1116)
+++ trunk/src/CacheWolf/navi/GotoPanel.java	2007-11-30 02:02:16 UTC (rev 1117)
@@ -195,9 +195,9 @@
 	
 	public void resizeTo(int width, int height){
 		super.resizeTo(width, height);
-		Rect btnGotoRect = btnGoto.getRect();
-		int roseHeight = height - btnGotoRect.y - btnGotoRect.height - 40;
-		roseP.resizeTo(width, roseHeight);
+		Rect coordsRect = CoordsP.getRect();
+		int roseHeight = height - coordsRect.y - coordsRect.height;
+		roseP.resizeTo(width, roseHeight); 
 		icRose.resizeTo(width, roseHeight);
 		compassRose.resize(width, roseHeight);
 	}



