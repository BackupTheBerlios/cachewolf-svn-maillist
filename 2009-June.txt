From engywuck at mail.berlios.de  Mon Jun  1 09:44:23 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Mon, 1 Jun 2009 09:44:23 +0200
Subject: [Cachewolf-svn] r1878 - trunk/src/CacheWolf
Message-ID: <200906010744.n517iNUS002100@sheep.berlios.de>

Author: engywuck
Date: 2009-06-01 09:44:22 +0200 (Mon, 01 Jun 2009)
New Revision: 1878

Modified:
   trunk/src/CacheWolf/MainMenu.java
Log:
Hiding SIP when search results are displayed.

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2009-05-30 20:35:51 UTC (rev 1877)
+++ trunk/src/CacheWolf/MainMenu.java	2009-06-01 07:44:22 UTC (rev 1878)
@@ -250,6 +250,7 @@
 	public static void search() {
 		SearchBox inp = new SearchBox(MyLocale.getMsg(119,"Search for:"));
 		String srch = inp.input(null,"",searchInDescriptionAndNotes,searchInLogs,10);
+		MyLocale.setSIPOff();
 		if (srch != null) {
 			searchInDescriptionAndNotes = inp.useNoteDesc();
 			searchInLogs = inp.useLogs();



From engywuck at mail.berlios.de  Mon Jun  1 13:16:22 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Mon, 1 Jun 2009 13:16:22 +0200
Subject: [Cachewolf-svn] r1879 - in trunk: res_noewe/languages src/CacheWolf
Message-ID: <200906011116.n51BGMMS001252@sheep.berlios.de>

Author: engywuck
Date: 2009-06-01 13:16:17 +0200 (Mon, 01 Jun 2009)
New Revision: 1879

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/DetailsPanel.java
   trunk/src/CacheWolf/Filter.java
   trunk/src/CacheWolf/myTableControl.java
Log:
Added feature (context menu) to display additional waypoints of individual caches. (http://www.geoclub.de/viewtopic.php?f=40&t=34629)

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-06-01 07:44:22 UTC (rev 1878)
+++ trunk/res_noewe/languages/DE.cfg	2009-06-01 11:16:17 UTC (rev 1879)
@@ -325,6 +325,9 @@
 		1039=L%f6ser vorhanden
 		1040=N
 		1041=Notiz vorhanden
+		1042=Addis einblenden
+		1043=Keine zus%e4tzlichen Wegpunkte vorhanden.
+		1044=Addis
 		1100=Profile
 		1105=Suchen
 		1106=Profil w%e4hlen oder Neu

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-06-01 07:44:22 UTC (rev 1878)
+++ trunk/res_noewe/languages/EN.cfg	2009-06-01 11:16:17 UTC (rev 1879)
@@ -325,6 +325,9 @@
 		1039=Solver exists
 		1040=N
 		1041=Notes exist
+		1042=Unhide Addis
+		1043=This cache has no additional waypoints.
+		1044=Addis
 		1100=Profiles
 		1105=Browse
 		1106=Choose profile or New

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-06-01 07:44:22 UTC (rev 1878)
+++ trunk/res_noewe/languages/FR.cfg	2009-06-01 11:16:17 UTC (rev 1879)
@@ -314,6 +314,9 @@
 		1039=Resoudeur existe
 		1040=N
 		1041=Note existe
+		1042=Afficher wps additionelles
+		1043=Cette cache n'a pas de waypoints additionelles.
+		1044=Addit.
 		1100=Profils
 		1105=Chercher
 		1106=Choiser profil ou cr%e9er-un 

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-06-01 07:44:22 UTC (rev 1878)
+++ trunk/res_noewe/languages/NL.cfg	2009-06-01 11:16:17 UTC (rev 1879)
@@ -289,6 +289,9 @@
 		1039=Oplosser bestaat
 		1040=N
 		1041=Opmerkingen bestaan
+		1042=Toon additionele waypoints
+		1043=Er zijn geen additionele waypoints voor deze cache.
+		1044=Addit.
 		1100=Profielen
 		1105=Bladeren
 		1106=Kies profiel of nieuw.

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2009-06-01 07:44:22 UTC (rev 1878)
+++ trunk/src/CacheWolf/CacheHolder.java	2009-06-01 11:16:17 UTC (rev 1879)
@@ -18,10 +18,6 @@
  *	classes and methods to get more information.
  *	
  */
-/**
- * @author torsti
- *
- */
 public class CacheHolder {
 	protected static final String NOBEARING = "?";
 	protected static final String EMPTY = "";
@@ -79,6 +75,8 @@
 	private boolean newCache = false;
 	/** True if the cache is part of the results of a search */
 	public boolean is_flaged = false;
+	/** True if additional waypoints for this cache should be displayed regardless of the filter settings */
+	private boolean showAddis = false;
 	/** True if the cache has been selected using the tick box in the list view */
 	public boolean is_Checked = false;
 	/** The unique OC cache ID */
@@ -1021,7 +1019,10 @@
 			  	 (this.is_filtered())^profile.isFilterInverted())                            
 			  	||
 			   (filter==Filter.FILTER_CACHELIST) && 
-			     !Global.mainForm.cacheList.contains(this.getWayPoint()));
+			     !Global.mainForm.cacheList.contains(this.getWayPoint())
+			);
+		boolean showAddi = this.showAddis() && this.mainCache != null && this.mainCache.isVisible();
+		noShow = noShow && !showAddi;
 		return !noShow;
 	}
 
@@ -1176,6 +1177,44 @@
     }
 
 	/**
+	 * If this returns <code>true</code>, then the additional waypoints for this cache should be 
+	 * displayed regardless how the filter is set. If it is <code>false</code>, then the normal 
+	 * filter settings apply.<br>
+	 * This property is not saved in index.xml, so if you reload the data, then this information
+	 * is gone.
+	 * @return <code>True</code>: Always display additional waypoints for cache.
+	 */
+	public boolean showAddis() {
+		return this.showAddis;
+	}
+	
+	/**
+	 * Setter for <code>showAddis()</code>. 
+	 * If this returns <code>true</code>, then the additional waypoints for this cache should be 
+	 * displayed regardless how the filter is set. If it is <code>false</code>, then the normal 
+	 * filter settings apply.<br>
+	 * This property is not saved in index.xml, so if you reload the data, then this information
+	 * is gone.
+	 * @param value <code>True</code>: Always display additional waypoints for cache.
+	 */
+	public void setShowAddis(boolean value) {
+		// This value is always stored in the main cache and all addis.
+		CacheHolder mc = null;
+		if (this.mainCache == null) {
+			mc = this;
+		} else {
+			mc = this.mainCache;
+		}
+		if (mc.showAddis != value) {
+			mc.showAddis = value;
+			for (int i=0; i<mc.addiWpts.size(); i++) {
+				CacheHolder ac = (CacheHolder) mc.addiWpts.get(i);
+				ac.showAddis = value;
+			}
+		}
+	}
+	
+	/**
 	 * <b><u>Important</u></b>: This flag no longer indicates if a cache is visible
 	 * in the list. Instead, it now <u>only</u> flags if the cache is filtered out
 	 * by filter criteria. Use <code>isVisible()</code> instead.<br>

Modified: trunk/src/CacheWolf/DetailsPanel.java
===================================================================
--- trunk/src/CacheWolf/DetailsPanel.java	2009-06-01 07:44:22 UTC (rev 1878)
+++ trunk/src/CacheWolf/DetailsPanel.java	2009-06-01 11:16:17 UTC (rev 1879)
@@ -35,7 +35,7 @@
 	mImage imgBlackNo;
 	mImage imgShowBug, imgShowBugNo, imgNewWpt, imgGoto;
 	mImage imgShowMaps, imgAddImages, imgNotes;
-	mLabel lblDiff, lblTerr;
+	mLabel lblDiff, lblTerr, lblAddiCount;
 
 	CacheDB cacheDB;
 	CacheHolder thisCache;
@@ -143,8 +143,13 @@
 
 		this.addNext(new mLabel(MyLocale.getMsg(302, "Waypoint:")), CellConstants.DONTSTRETCH,
 		        (CellConstants.DONTFILL | CellConstants.WEST));
-		this.addLast(inpWaypoint.setTag(CellConstants.SPAN, new Dimension(2, 1)),
-		        CellConstants.DONTSTRETCH, (CellConstants.HFILL | CellConstants.WEST));
+		line2Panel = new CellPanel();
+		line2Panel.addNext(inpWaypoint, CellConstants.HSTRETCH,
+		        (CellConstants.HFILL | CellConstants.WEST));
+		line2Panel.addLast(lblAddiCount = new mLabel(MyLocale.getMsg(1044, "Addis")+": 888"),
+		        CellConstants.DONTSTRETCH, (CellConstants.DONTFILL | CellConstants.EAST));
+		this.addLast(line2Panel, DONTSTRETCH, HFILL)
+		        .setTag(CellConstants.SPAN, new Dimension(2, 1));
 
 		this.addNext(new mLabel(MyLocale.getMsg(303, "Name:")), CellConstants.DONTSTRETCH,
 		        (CellConstants.DONTFILL | CellConstants.WEST));
@@ -281,6 +286,13 @@
 					        .log(ch.getWayPoint() + " has wrong difficulty " + ch.getHard());
 			}
 		}
+		int addiCount = 0;
+		if (ch.mainCache==null) {
+			addiCount = ch.addiWpts.size();
+		} else {
+			addiCount = ch.mainCache.addiWpts.size();
+		}
+		lblAddiCount.setText( MyLocale.getMsg(1044, "Addis")+": "+String.valueOf(addiCount)); 
 
 		if (isBigScreen)
 			mNotes.setText(ch.getExistingDetails().getCacheNotes());

Modified: trunk/src/CacheWolf/Filter.java
===================================================================
--- trunk/src/CacheWolf/Filter.java	2009-06-01 07:44:22 UTC (rev 1878)
+++ trunk/src/CacheWolf/Filter.java	2009-06-01 11:16:17 UTC (rev 1879)
@@ -339,6 +339,7 @@
 		
 		for(int i = cacheDB.size()-1; i >=0 ; i--){
 			ch = cacheDB.get(i);
+			ch.setShowAddis(false); 
 			if (examinedCaches.containsKey(ch)) continue;
 			
 			boolean filterCache = excludedByFilter(ch);
@@ -606,7 +607,9 @@
 		Global.getProfile().selectionChanged = true;
 		CacheDB cacheDB=Global.getProfile().cacheDB;
 		for(int i = cacheDB.size()-1; i >=0 ; i--){
-			cacheDB.get(i).setFiltered(false);
+			CacheHolder ch = cacheDB.get(i);
+			ch.setFiltered(false);
+			ch.setShowAddis(false);
 		}
 		Global.getProfile().setFilterActive(FILTER_INACTIVE);
 	}

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2009-06-01 07:44:22 UTC (rev 1878)
+++ trunk/src/CacheWolf/myTableControl.java	2009-06-01 11:16:17 UTC (rev 1879)
@@ -17,7 +17,7 @@
 	public CacheDB cacheDB;
 	public TablePanel tbp;
 	
-	private MenuItem miOpen, miGoto, miCenter;
+	private MenuItem miOpen, miGoto, miCenter, miUnhideAddis;
 	private MenuItem miOpenOnline, miOpenOffline;
 	private MenuItem miDelete, miUpdate;
 	private MenuItem miTickAll, miUntickAll;
@@ -33,28 +33,30 @@
 		tbp =tablePanel;
 		allowDragSelection = false; // allow only one row to be selected at one time
 				
-		MenuItem[] mnuFull = new MenuItem[12];
+		MenuItem[] mnuFull = new MenuItem[13];
   	mnuFull[0] = miOpen = new MenuItem(MyLocale.getMsg(1021,"Open description"));
   	mnuFull[1] = miGoto = new MenuItem(MyLocale.getMsg(1010,"Goto"));
   	mnuFull[2] = miCenter = new MenuItem(MyLocale.getMsg(1019,"Center"));
-  	mnuFull[3] = miSeparator = new MenuItem("-");
-  	mnuFull[4] = miOpenOnline = new MenuItem(MyLocale.getMsg(1020,"Open in $browser online"));
-  	mnuFull[5] = miOpenOffline = new MenuItem(MyLocale.getMsg(1018,"Open in browser offline"));
-  	mnuFull[6] = miSeparator;
-  	mnuFull[7] = miDelete = new MenuItem(MyLocale.getMsg(1012,"Delete selected"));
-  	mnuFull[8] = miUpdate = new MenuItem(MyLocale.getMsg(1014,"Update"));
-  	mnuFull[9] = miSeparator;
-  	mnuFull[10] = miTickAll = new MenuItem(MyLocale.getMsg(1015,"Select all"));
-  	mnuFull[11] = miUntickAll = new MenuItem(MyLocale.getMsg(1016,"De-select all"));	
+  	mnuFull[3] = miUnhideAddis = new MenuItem(MyLocale.getMsg(1042,"Unhide Addis"));
+  	mnuFull[4] = miSeparator = new MenuItem("-");
+  	mnuFull[5] = miOpenOnline = new MenuItem(MyLocale.getMsg(1020,"Open in $browser online"));
+  	mnuFull[6] = miOpenOffline = new MenuItem(MyLocale.getMsg(1018,"Open in browser offline"));
+  	mnuFull[7] = miSeparator;
+  	mnuFull[8] = miDelete = new MenuItem(MyLocale.getMsg(1012,"Delete selected"));
+  	mnuFull[9] = miUpdate = new MenuItem(MyLocale.getMsg(1014,"Update"));
+  	mnuFull[10] = miSeparator;
+  	mnuFull[11] = miTickAll = new MenuItem(MyLocale.getMsg(1015,"Select all"));
+  	mnuFull[12] = miUntickAll = new MenuItem(MyLocale.getMsg(1016,"De-select all"));	
   	mFull = new Menu(mnuFull, MyLocale.getMsg(1013,"With selection"));
 
-  	MenuItem[] mnuSmall = new MenuItem[6];
+  	MenuItem[] mnuSmall = new MenuItem[7];
   	mnuSmall[0] = miOpen;
   	mnuSmall[1] = miGoto;
   	mnuSmall[2] = miCenter;
-  	mnuSmall[3] = miSeparator;
-  	mnuSmall[4] = miOpenOnline;
-  	mnuSmall[5] = miOpenOffline;
+  	mnuSmall[3] = miUnhideAddis;
+  	mnuSmall[4] = miSeparator;
+  	mnuSmall[5] = miOpenOnline;
+  	mnuSmall[6] = miOpenOffline;
   	mSmall = new Menu(mnuSmall, MyLocale.getMsg(1013,"With selection"));	
 	}
 
@@ -223,6 +225,17 @@
 				//tbp.refreshTable();
 			}
 		}
+		
+		if (selectedItem == miUnhideAddis) {
+			// This sets the "showAddis" Flag to true. To reset is to false, apply the filter.
+			ch = cacheDB.get(tbp.getSelectedCache());
+			ch.setShowAddis(true);
+			if (ch.addiWpts.size()>0) {
+				tbp.refreshTable();
+			} else {
+				new MessageBox(MyLocale.getMsg(4201, "Info"), MyLocale.getMsg(1043, "This cache has no additional waypoints."),FormBase.OKB).execute();
+			}
+		}
 
 		if (selectedItem == miGoto){
 			ch = cacheDB.get(tbp.getSelectedCache());



From engywuck at mail.berlios.de  Tue Jun  2 14:34:48 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Tue, 2 Jun 2009 14:34:48 +0200
Subject: [Cachewolf-svn] r1880 - trunk/src/CacheWolf
Message-ID: <200906021234.n52CYmQ9028717@sheep.berlios.de>

Author: engywuck
Date: 2009-06-02 14:34:46 +0200 (Tue, 02 Jun 2009)
New Revision: 1880

Modified:
   trunk/src/CacheWolf/myTableControl.java
Log:
Replacing subsequent if's with nested else-if's. (No functional change)

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2009-06-01 11:16:17 UTC (rev 1879)
+++ trunk/src/CacheWolf/myTableControl.java	2009-06-02 12:34:46 UTC (rev 1880)
@@ -133,11 +133,11 @@
 		CacheHolder ch;
 		if (selectedItem == miTickAll){
 			setSelectForAll(true);
-		}
+		} else
 
 		if (selectedItem == miUntickAll){
 			setSelectForAll(false);
-		}
+		} else
 
 		if (selectedItem == miDelete){
 			Vm.showWait(true);
@@ -203,11 +203,11 @@
 				}
 			}
 			Vm.showWait(false);
-		}
+		} else
 				
 		if (selectedItem == miUpdate){
 			MainMenu.updateSelectedCaches(tbp);
-		}
+		} else
 
 		if (selectedItem == miCenter){
 			if (tbp.getSelectedCache() < 0) {
@@ -224,7 +224,7 @@
 				Global.mainTab.updateBearDist(); // Update the distances with a warning message
 				//tbp.refreshTable();
 			}
-		}
+		} else
 		
 		if (selectedItem == miUnhideAddis) {
 			// This sets the "showAddis" Flag to true. To reset is to false, apply the filter.
@@ -235,12 +235,13 @@
 			} else {
 				new MessageBox(MyLocale.getMsg(4201, "Info"), MyLocale.getMsg(1043, "This cache has no additional waypoints."),FormBase.OKB).execute();
 			}
-		}
+		} else
 
 		if (selectedItem == miGoto){
 			ch = cacheDB.get(tbp.getSelectedCache());
 			Global.mainTab.gotoPoint(ch.pos);
-		}
+		} else
+		    
 		if (selectedItem == miOpenOnline){
 			if(browserPathIsValid()){
 				ch = cacheDB.get(tbp.getSelectedCache());
@@ -257,13 +258,15 @@
 							MyLocale.getMsg(1037,"patient for an update"),FormBase.OKB)).execute();
 				}
 			}
-		}
+		} else
+		    
 		if (selectedItem == miOpenOffline) {
 			if(browserPathIsValid()){
 				ShowCacheInBrowser sc=new ShowCacheInBrowser();
 				sc.showCache(cacheDB.get(tbp.getSelectedCache()));
 			}
-		}
+		} else
+		    
 		if (selectedItem == miOpen){
 			penDoubleClicked(null);
 		}



From greiol at mail.berlios.de  Tue Jun  2 18:14:57 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 2 Jun 2009 18:14:57 +0200
Subject: [Cachewolf-svn] r1881 - trunk/src/CacheWolf
Message-ID: <200906021614.n52GEv4f031027@sheep.berlios.de>

Author: greiol
Date: 2009-06-02 18:14:55 +0200 (Tue, 02 Jun 2009)
New Revision: 1881

Modified:
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/Preferences.java
Log:
GPX/LOC importer now remembers last used directory

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2009-06-02 12:34:46 UTC (rev 1880)
+++ trunk/src/CacheWolf/MainMenu.java	2009-06-02 16:14:55 UTC (rev 1881)
@@ -321,11 +321,13 @@
 				tbp.resetModel();
 			}
 			if(mev.selectedItem == loadcaches){
-				FileChooser fc = new FileChooser(FileChooserBase.OPEN|FileChooserBase.MULTI_SELECT, pref.baseDir);
+				String dir = pref.getImporterPath("LocGpxImporter");
+				FileChooser fc = new FileChooser(FileChooserBase.OPEN|FileChooserBase.MULTI_SELECT, dir);
 				fc.addMask("*.gpx,*.zip,*.loc");
 				fc.setTitle(MyLocale.getMsg(909,"Select file(s)"));
 				if(fc.execute() != FormBase.IDCANCEL){
-					String dir = fc.getChosenDirectory().toString();
+					dir = fc.getChosenDirectory().toString();
+					pref.setImporterPath("LocGpxImporter", dir);
 					String files[] = fc.getAllChosen();
 					/*
 					int how = GPXImporter.DOIT_ASK;

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-02 12:34:46 UTC (rev 1880)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-02 16:14:55 UTC (rev 1881)
@@ -377,6 +377,9 @@
 		else if (name.equals("expPath")){
 			exporterPaths.put(atts.getValue("key"),atts.getValue("value"));
 		}
+		else if (name.equals("impPath")) {
+			importerPaths.put(atts.getValue("key"), atts.getValue("value"));
+		}
 		else if (name.equals("travelbugs")) {
 			travelbugColMap=atts.getValue("colmap");
 			travelbugColWidth=atts.getValue("colwidths");
@@ -515,6 +518,12 @@
 				entry = (MapEntry) itPath.next();
 				outp.print("    <expPath key = \"" + SafeXML.strxmlencode(entry.getKey().toString()) + "\" value = \"" + SafeXML.strxmlencode(entry.getValue().toString().replace('\\', '/')) + "\"/>\n");
 			}
+			itPath = importerPaths.entries();
+			while(itPath.hasNext()){
+				entry = (MapEntry) itPath.next();
+				outp.print("    <impPath key = \"" + SafeXML.strxmlencode(entry.getKey().toString()) + "\" value = \"" + SafeXML.strxmlencode(entry.getValue().toString().replace('\\', '/')) + "\"/>\n");
+			}
+			
 			outp.print("</preferences>");
 			outp.close();
 		} catch (Exception e) {
@@ -806,6 +815,19 @@
 		}
 		return dir;
 	}
+	
+	private Hashtable importerPaths = new Hashtable();
+	
+	public void setImporterPath(String importer, String directory) {
+		importerPaths.put(importer, directory);
+		savePreferences();
+	}
+	
+	public String getImporterPath(String importer) {
+		String dir = (String) importerPaths.get(importer);
+		if (null == dir) dir = Global.getProfile().dataDir;
+		return dir;
+	}
 
 	/**
 	 * <code>True</code> or <code>false</code>, depending if a filter with the given ID is 



From engywuck at mail.berlios.de  Tue Jun  2 18:17:23 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Tue, 2 Jun 2009 18:17:23 +0200
Subject: [Cachewolf-svn] r1882 - in trunk: res_noewe/languages src/CacheWolf
Message-ID: <200906021617.n52GHNbb031650@sheep.berlios.de>

Author: engywuck
Date: 2009-06-02 18:17:20 +0200 (Tue, 02 Jun 2009)
New Revision: 1882

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/src/CacheWolf/Filter.java
   trunk/src/CacheWolf/myTableControl.java
Log:
Hiding/unhiding addis: Now the menu offers the possibility to hide unhidden Addis again. In return, applying the filter doesn't affect the unhidden addis anymore.

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-06-02 16:14:55 UTC (rev 1881)
+++ trunk/res_noewe/languages/DE.cfg	2009-06-02 16:17:20 UTC (rev 1882)
@@ -328,6 +328,7 @@
 		1042=Addis einblenden
 		1043=Keine zus%e4tzlichen Wegpunkte vorhanden.
 		1044=Addis
+		1045=Addis ausblenden
 		1100=Profile
 		1105=Suchen
 		1106=Profil w%e4hlen oder Neu

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-06-02 16:14:55 UTC (rev 1881)
+++ trunk/res_noewe/languages/EN.cfg	2009-06-02 16:17:20 UTC (rev 1882)
@@ -328,6 +328,7 @@
 		1042=Unhide Addis
 		1043=This cache has no additional waypoints.
 		1044=Addis
+		1045=Hide Addis
 		1100=Profiles
 		1105=Browse
 		1106=Choose profile or New

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-06-02 16:14:55 UTC (rev 1881)
+++ trunk/res_noewe/languages/FR.cfg	2009-06-02 16:17:20 UTC (rev 1882)
@@ -317,6 +317,7 @@
 		1042=Afficher wps additionelles
 		1043=Cette cache n'a pas de waypoints additionelles.
 		1044=Addit.
+		1045=Cacher les wps additionelles
 		1100=Profils
 		1105=Chercher
 		1106=Choiser profil ou cr%e9er-un 

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-06-02 16:14:55 UTC (rev 1881)
+++ trunk/res_noewe/languages/NL.cfg	2009-06-02 16:17:20 UTC (rev 1882)
@@ -292,6 +292,7 @@
 		1042=Toon additionele waypoints
 		1043=Er zijn geen additionele waypoints voor deze cache.
 		1044=Addit.
+		1045=Verberg additionele waypoints
 		1100=Profielen
 		1105=Bladeren
 		1106=Kies profiel of nieuw.

Modified: trunk/src/CacheWolf/Filter.java
===================================================================
--- trunk/src/CacheWolf/Filter.java	2009-06-02 16:14:55 UTC (rev 1881)
+++ trunk/src/CacheWolf/Filter.java	2009-06-02 16:17:20 UTC (rev 1882)
@@ -339,7 +339,6 @@
 		
 		for(int i = cacheDB.size()-1; i >=0 ; i--){
 			ch = cacheDB.get(i);
-			ch.setShowAddis(false); 
 			if (examinedCaches.containsKey(ch)) continue;
 			
 			boolean filterCache = excludedByFilter(ch);
@@ -609,7 +608,6 @@
 		for(int i = cacheDB.size()-1; i >=0 ; i--){
 			CacheHolder ch = cacheDB.get(i);
 			ch.setFiltered(false);
-			ch.setShowAddis(false);
 		}
 		Global.getProfile().setFilterActive(FILTER_INACTIVE);
 	}

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2009-06-02 16:14:55 UTC (rev 1881)
+++ trunk/src/CacheWolf/myTableControl.java	2009-06-02 16:17:20 UTC (rev 1882)
@@ -79,8 +79,32 @@
 	}
 	
 	public void penRightReleased(Point p){
-		if (cacheDB.size()>0) // No context menu when DB is empty
+		if (cacheDB.size()>0) { // No context menu when DB is empty
+			// Find out cell at pixel position
+			Point p2 = cellAtPoint(p.x,p.y,null);
+			if (p2 != null && p2.y >= 0) {
+				// Get the cache at the position
+				CacheHolder selCache = cacheDB.get(p2.y);
+				if (selCache != null) {
+					// Depending if it has Addis and the ShowAddis-Flag the menu item to unhide
+					// addis is properly named and activated or disabled.
+					if (selCache.addiWpts.size() > 0) {
+						miUnhideAddis.modifiers&=~MenuItem.Disabled;
+						if (!selCache.showAddis()) {
+							miUnhideAddis.setText(MyLocale.getMsg(1042,"Unhide Addis"));
+						} else {
+							miUnhideAddis.setText(MyLocale.getMsg(1045,"Hide Addis"));
+						}
+					} else {
+						miUnhideAddis.setText(MyLocale.getMsg(1042,"Unhide Addis"));
+						miUnhideAddis.modifiers|=MenuItem.Disabled;
+					}
+				}
+			}
+			
 			menuState.doShowMenu(p,true,null); // direct call (not through doMenu) is neccesary because it will exclude the whole table
+			
+		}
 	}
 	public void penHeld(Point p){
 		if (cacheDB.size()>0) // No context menu when DB is empty
@@ -227,12 +251,14 @@
 		} else
 		
 		if (selectedItem == miUnhideAddis) {
-			// This sets the "showAddis" Flag to true. To reset is to false, apply the filter.
+			// This toggles the "showAddis" Flag
 			ch = cacheDB.get(tbp.getSelectedCache());
-			ch.setShowAddis(true);
+			ch.setShowAddis(!ch.showAddis());
 			if (ch.addiWpts.size()>0) {
 				tbp.refreshTable();
 			} else {
+				// This should never occur, as we check prior to activating the menu if the
+				// cache has addis. But just in case...
 				new MessageBox(MyLocale.getMsg(4201, "Info"), MyLocale.getMsg(1043, "This cache has no additional waypoints."),FormBase.OKB).execute();
 			}
 		} else



From engywuck at mail.berlios.de  Tue Jun  2 18:46:22 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Tue, 2 Jun 2009 18:46:22 +0200
Subject: [Cachewolf-svn] r1883 - trunk/src/CacheWolf
Message-ID: <200906021646.n52GkMaC014170@sheep.berlios.de>

Author: engywuck
Date: 2009-06-02 18:46:17 +0200 (Tue, 02 Jun 2009)
New Revision: 1883

Modified:
   trunk/src/CacheWolf/myTableControl.java
Log:
The functionality of the previous revision now works on PDA, too.

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2009-06-02 16:17:20 UTC (rev 1882)
+++ trunk/src/CacheWolf/myTableControl.java	2009-06-02 16:46:17 UTC (rev 1883)
@@ -80,34 +80,15 @@
 	
 	public void penRightReleased(Point p){
 		if (cacheDB.size()>0) { // No context menu when DB is empty
-			// Find out cell at pixel position
-			Point p2 = cellAtPoint(p.x,p.y,null);
-			if (p2 != null && p2.y >= 0) {
-				// Get the cache at the position
-				CacheHolder selCache = cacheDB.get(p2.y);
-				if (selCache != null) {
-					// Depending if it has Addis and the ShowAddis-Flag the menu item to unhide
-					// addis is properly named and activated or disabled.
-					if (selCache.addiWpts.size() > 0) {
-						miUnhideAddis.modifiers&=~MenuItem.Disabled;
-						if (!selCache.showAddis()) {
-							miUnhideAddis.setText(MyLocale.getMsg(1042,"Unhide Addis"));
-						} else {
-							miUnhideAddis.setText(MyLocale.getMsg(1045,"Hide Addis"));
-						}
-					} else {
-						miUnhideAddis.setText(MyLocale.getMsg(1042,"Unhide Addis"));
-						miUnhideAddis.modifiers|=MenuItem.Disabled;
-					}
-				}
-			}
-			
+			adjustAddiHideUnhideMenu(p);
 			menuState.doShowMenu(p,true,null); // direct call (not through doMenu) is neccesary because it will exclude the whole table
 			
 		}
 	}
-	public void penHeld(Point p){
+
+    public void penHeld(Point p){
 		if (cacheDB.size()>0) // No context menu when DB is empty
+			adjustAddiHideUnhideMenu(p);
 			menuState.doShowMenu(p,true,null); 
 	}
 
@@ -319,7 +300,39 @@
 
 		super.onEvent(ev);
 	}
-    ///////////////////////////////////////////////////
+
+	/**
+	 * Adjusting the menu item for hiding or unhiding additional waypoints. If the cache has no
+	 * addis, then the menu is deactivated. If it has addis, then the menu text is adapted according
+	 * to the current value of the property <code>showAddis()</code>. 
+     * @param p Position (in Pixels) where the context menu is triggered. This defines the cache
+     * the functionality is applying for.
+     */
+    private void adjustAddiHideUnhideMenu(Point p) {
+	    // Find out cell at pixel position
+	    Point p2 = cellAtPoint(p.x,p.y,null);
+	    if (p2 != null && p2.y >= 0) {
+	    	// Get the cache at the position
+	    	CacheHolder selCache = cacheDB.get(p2.y);
+	    	if (selCache != null) {
+	    		// Depending if it has Addis and the ShowAddis-Flag the menu item to unhide
+	    		// addis is properly named and activated or disabled.
+	    		if (selCache.addiWpts.size() > 0) {
+	    			miUnhideAddis.modifiers&=~MenuItem.Disabled;
+	    			if (!selCache.showAddis()) {
+	    				miUnhideAddis.setText(MyLocale.getMsg(1042,"Unhide Addis"));
+	    			} else {
+	    				miUnhideAddis.setText(MyLocale.getMsg(1045,"Hide Addis"));
+	    			}
+	    		} else {
+	    			miUnhideAddis.setText(MyLocale.getMsg(1042,"Unhide Addis"));
+	    			miUnhideAddis.modifiers|=MenuItem.Disabled;
+	    		}
+	    	}
+	    }
+    }
+	
+	///////////////////////////////////////////////////
 	//  Allow the caches to be dragged into a cachelist
     ///////////////////////////////////////////////////
 	



From engywuck at mail.berlios.de  Tue Jun  2 22:26:31 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Tue, 2 Jun 2009 22:26:31 +0200
Subject: [Cachewolf-svn] r1884 - trunk/src/CacheWolf
Message-ID: <200906022026.n52KQVqb009099@sheep.berlios.de>

Author: engywuck
Date: 2009-06-02 22:26:29 +0200 (Tue, 02 Jun 2009)
New Revision: 1884

Modified:
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/myTableControl.java
Log:
Part III: Now the Addi-Show-Addi-Go-Feature also works in the context menu that is blended in the main menu.

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2009-06-02 16:46:17 UTC (rev 1883)
+++ trunk/src/CacheWolf/MainMenu.java	2009-06-02 20:26:29 UTC (rev 1884)
@@ -695,6 +695,11 @@
 			// In case that the triggered event was due to one of the context menu items, process
 			// the event by the context menu handler
 			tbp.tc.popupMenuEvent(mev.selectedItem);
+			
+		} else if (ev instanceof ControlEvent) {
+			if (ev.type == ControlEvent.MENU_SHOWN) {
+				Global.mainTab.tbP.tc.adjustAddiHideUnhideMenu();
+			}
 		}
 	}
 

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2009-06-02 16:46:17 UTC (rev 1883)
+++ trunk/src/CacheWolf/myTableControl.java	2009-06-02 20:26:29 UTC (rev 1884)
@@ -80,7 +80,7 @@
 	
 	public void penRightReleased(Point p){
 		if (cacheDB.size()>0) { // No context menu when DB is empty
-			adjustAddiHideUnhideMenu(p);
+			adjustAddiHideUnhideMenu();
 			menuState.doShowMenu(p,true,null); // direct call (not through doMenu) is neccesary because it will exclude the whole table
 			
 		}
@@ -88,7 +88,7 @@
 
     public void penHeld(Point p){
 		if (cacheDB.size()>0) // No context menu when DB is empty
-			adjustAddiHideUnhideMenu(p);
+			adjustAddiHideUnhideMenu();
 			menuState.doShowMenu(p,true,null); 
 	}
 
@@ -304,36 +304,33 @@
 	/**
 	 * Adjusting the menu item for hiding or unhiding additional waypoints. If the cache has no
 	 * addis, then the menu is deactivated. If it has addis, then the menu text is adapted according
-	 * to the current value of the property <code>showAddis()</code>. 
-     * @param p Position (in Pixels) where the context menu is triggered. This defines the cache
-     * the functionality is applying for.
-     */
-    private void adjustAddiHideUnhideMenu(Point p) {
-	    // Find out cell at pixel position
-	    Point p2 = cellAtPoint(p.x,p.y,null);
-	    if (p2 != null && p2.y >= 0) {
-	    	// Get the cache at the position
-	    	CacheHolder selCache = cacheDB.get(p2.y);
-	    	if (selCache != null) {
-	    		// Depending if it has Addis and the ShowAddis-Flag the menu item to unhide
-	    		// addis is properly named and activated or disabled.
-	    		if (selCache.addiWpts.size() > 0) {
-	    			miUnhideAddis.modifiers&=~MenuItem.Disabled;
-	    			if (!selCache.showAddis()) {
-	    				miUnhideAddis.setText(MyLocale.getMsg(1042,"Unhide Addis"));
-	    			} else {
-	    				miUnhideAddis.setText(MyLocale.getMsg(1045,"Hide Addis"));
-	    			}
-	    		} else {
-	    			miUnhideAddis.setText(MyLocale.getMsg(1042,"Unhide Addis"));
-	    			miUnhideAddis.modifiers|=MenuItem.Disabled;
-	    		}
-	    	}
-	    }
-    }
+	 * to the current value of the property <code>showAddis()</code>.
+	 * 
+	 */
+	public void adjustAddiHideUnhideMenu() {
+		if (tbp.getSelectedCache() < 0) {
+			return;
+		}
+		CacheHolder selCache = cacheDB.get(tbp.getSelectedCache());
+		if (selCache != null) {
+			// Depending if it has Addis and the ShowAddis-Flag the menu item to unhide
+			// addis is properly named and activated or disabled.
+			if (selCache.addiWpts.size() > 0) {
+				miUnhideAddis.modifiers &= ~MenuItem.Disabled;
+				if (!selCache.showAddis()) {
+					miUnhideAddis.setText(MyLocale.getMsg(1042, "Unhide Addis"));
+				} else {
+					miUnhideAddis.setText(MyLocale.getMsg(1045, "Hide Addis"));
+				}
+			} else {
+				miUnhideAddis.setText(MyLocale.getMsg(1042, "Unhide Addis"));
+				miUnhideAddis.modifiers |= MenuItem.Disabled;
+			}
+		}
+	}
 	
-	///////////////////////////////////////////////////
-	//  Allow the caches to be dragged into a cachelist
+	// /////////////////////////////////////////////////
+	// Allow the caches to be dragged into a cachelist
     ///////////////////////////////////////////////////
 	
 	IconAndText imgDrag;



From engywuck at mail.berlios.de  Wed Jun  3 17:39:54 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Wed, 3 Jun 2009 17:39:54 +0200
Subject: [Cachewolf-svn] r1885 - in trunk: res_noewe/languages src/CacheWolf
Message-ID: <200906031539.n53FdsMK011361@sheep.berlios.de>

Author: engywuck
Date: 2009-06-03 17:39:51 +0200 (Wed, 03 Jun 2009)
New Revision: 1885

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/myTableModel.java
Log:
Number of additional waypoints is now available as column in the Cache List.

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-06-02 20:26:29 UTC (rev 1884)
+++ trunk/res_noewe/languages/DE.cfg	2009-06-03 15:39:51 UTC (rev 1885)
@@ -329,6 +329,8 @@
 		1043=Keine zus%e4tzlichen Wegpunkte vorhanden.
 		1044=Addis
 		1045=Addis ausblenden
+		1046=# Addis
+		1047=A
 		1100=Profile
 		1105=Suchen
 		1106=Profil w%e4hlen oder Neu

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-06-02 20:26:29 UTC (rev 1884)
+++ trunk/res_noewe/languages/EN.cfg	2009-06-03 15:39:51 UTC (rev 1885)
@@ -329,6 +329,8 @@
 		1043=This cache has no additional waypoints.
 		1044=Addis
 		1045=Hide Addis
+		1046=# Addis
+		1047=A
 		1100=Profiles
 		1105=Browse
 		1106=Choose profile or New

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-06-02 20:26:29 UTC (rev 1884)
+++ trunk/res_noewe/languages/FR.cfg	2009-06-03 15:39:51 UTC (rev 1885)
@@ -318,6 +318,8 @@
 		1043=Cette cache n'a pas de waypoints additionelles.
 		1044=Addit.
 		1045=Cacher les wps additionelles
+		1046=# Addi.
+		1047=A
 		1100=Profils
 		1105=Chercher
 		1106=Choiser profil ou cr%e9er-un 

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-06-02 20:26:29 UTC (rev 1884)
+++ trunk/res_noewe/languages/NL.cfg	2009-06-03 15:39:51 UTC (rev 1885)
@@ -293,6 +293,8 @@
 		1043=Er zijn geen additionele waypoints voor deze cache.
 		1044=Addit.
 		1045=Verberg additionele waypoints
+		1046=# Addis
+		1047=A
 		1100=Profielen
 		1105=Bladeren
 		1106=Kies profiel of nieuw.

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-02 20:26:29 UTC (rev 1884)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-03 15:39:51 UTC (rev 1885)
@@ -321,7 +321,7 @@
 		else if (name.equals("listview")) {
 			listColMap=atts.getValue("colmap");
 			listColWidth=atts.getValue("colwidths")+",30,30"; // append default values for older versions
-			if((new StringTokenizer(listColWidth,",")).countTokens()<17) listColWidth+=",30,30"; // for older versions
+			if((new StringTokenizer(listColWidth,",")).countTokens()<18) listColWidth+=",30,30"; // for older versions
 		}
 		else if(name.equals("proxy")) {
 			myproxy = atts.getValue("prx");

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2009-06-02 20:26:29 UTC (rev 1884)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2009-06-03 15:39:51 UTC (rev 1885)
@@ -245,6 +245,7 @@
 				MyLocale.getMsg(637,"OC Index"),
 				MyLocale.getMsg(1039,"Solver exists"),
 				MyLocale.getMsg(1041,"Note exists"),
+				MyLocale.getMsg(1046,"# Additionals"),
 				},pref.listColMap),MyLocale.getMsg(595,"List"),null);
 
 		mTab.addCard(tccBugs=new TableColumnChooser(new String[] {

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-02 20:26:29 UTC (rev 1884)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-03 15:39:51 UTC (rev 1885)
@@ -32,7 +32,7 @@
 	 * the element j (as per the list below) is visible in column i. 
 	 * [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates, 
 	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing, [12] Size, [13] # of OC recommend.
-	 * [14] OC index, [15] Solver exists, [16] Note exists
+	 * [14] OC index, [15] Solver exists, [16] Note exists, [17] # Additionals
 	 */
 	private int[] colMap;
 	/** The column widths corresponding to the list of columns above */
@@ -42,7 +42,7 @@
 			MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),
 			MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear"),MyLocale.getMsg(1017,"S"),
 			MyLocale.getMsg(1026,"#Rec"),MyLocale.getMsg(1027,"OC-IDX"),MyLocale.getMsg(1038,"S"),
-			MyLocale.getMsg(1040,"N")};
+			MyLocale.getMsg(1040,"N"),MyLocale.getMsg(1047,"A")};
 	
 	private static Image noFindLogs[] = new Image[4];
 	public static mImage red, blue, yellow; // skull, green
@@ -106,7 +106,7 @@
 	 *
 	 */
 	public void setColumnNamesAndWidths() {
-		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,16,0, -1);
+		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,17,0, -1);
 		colWidth=TableColumnChooser.str2Array(Global.getPref().listColWidth,10,1024,50, colMap.length);
 		numCols=colMap.length;
 		clearCellAdjustments();
@@ -358,6 +358,12 @@
 					    if (ch.hasSolver()) return picHasSolver; else return null; 
 					case 16: // Does note exist?
 						if (ch.hasNote()) return picHasNotes; else return null;
+					case 17: // Number of Additional Waypoints;
+						if (ch.mainCache == null) {
+							return String.valueOf(ch.addiWpts.size());
+						} else {
+							return "";
+						}
 				} // Switch
 			} // if
 		} catch (Exception e) {



From greiol at mail.berlios.de  Wed Jun  3 20:34:44 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Wed, 3 Jun 2009 20:34:44 +0200
Subject: [Cachewolf-svn] r1886 - trunk/src/CacheWolf
Message-ID: <200906031834.n53IYi0J009785@sheep.berlios.de>

Author: greiol
Date: 2009-06-03 20:34:42 +0200 (Wed, 03 Jun 2009)
New Revision: 1886

Modified:
   trunk/src/CacheWolf/GPXImporter.java
   trunk/src/CacheWolf/SpiderGC.java
Log:
if we pick up images, we can just pick up attributes in the same go

Modified: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2009-06-03 15:39:51 UTC (rev 1885)
+++ trunk/src/CacheWolf/GPXImporter.java	2009-06-03 18:34:42 UTC (rev 1886)
@@ -532,6 +532,11 @@
 			//Vm.debug(addr + "|");
 			cacheText = SpiderGC.fetch(addr);
 			imgSpider.getImages(cacheText, holder.getFreshDetails());
+			try {
+				imgSpider.getAttributes(cacheText, holder.getFreshDetails());
+			} catch (Exception e) {
+				if (Global.getPref().debug) Global.getPref().log("unable to fetch attrivbutes for"+holder.getWayPoint(), e);
+			}
 		}
 	}
 	

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2009-06-03 15:39:51 UTC (rev 1885)
+++ trunk/src/CacheWolf/SpiderGC.java	2009-06-03 18:34:42 UTC (rev 1886)
@@ -1401,7 +1401,7 @@
 		}
 	}
 
-	private void getAttributes(String doc, CacheHolderDetail chD) throws Exception {
+	public void getAttributes(String doc, CacheHolderDetail chD) throws Exception {
 		Extractor attBlock = new Extractor(doc,p.getProp("attBlockExStart"),p.getProp("attBlockExEnd"), 0 , true);
 		String atts = attBlock.findNext();
 		Extractor attEx = new Extractor(atts,p.getProp("attExStart"),p.getProp("attExEnd"), 0 , true);



From greiol at mail.berlios.de  Wed Jun  3 22:23:51 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Wed, 3 Jun 2009 22:23:51 +0200
Subject: [Cachewolf-svn] r1887 - trunk/src/CacheWolf
Message-ID: <200906032023.n53KNpwo025365@sheep.berlios.de>

Author: greiol
Date: 2009-06-03 22:23:49 +0200 (Wed, 03 Jun 2009)
New Revision: 1887

Modified:
   trunk/src/CacheWolf/CacheSize.java
Log:
identify size of "broken" GSAK export

Modified: trunk/src/CacheWolf/CacheSize.java
===================================================================
--- trunk/src/CacheWolf/CacheSize.java	2009-06-03 18:34:42 UTC (rev 1886)
+++ trunk/src/CacheWolf/CacheSize.java	2009-06-03 20:23:49 UTC (rev 1887)
@@ -240,6 +240,9 @@
 			return CW_SIZE_OTHER;
 		} else if (gcstring.equals(GC_SIZE_VIRTUAL)) {
 			return CW_SIZE_VIRTUAL;
+		// GSAK exports wrong type information
+		} else if (gcstring.equals("Unknown")) {
+			return CW_SIZE_NOTCHOSEN;
 		} else {
 			throw (new IllegalArgumentException("unmatched argument " + gcstring + " in CacheSize gcGpxString2Cw()"));
 		}



From greiol at mail.berlios.de  Fri Jun  5 00:16:55 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 5 Jun 2009 00:16:55 +0200
Subject: [Cachewolf-svn] r1888 - trunk/src/exp
Message-ID: <200906042216.n54MGtAK026071@sheep.berlios.de>

Author: greiol
Date: 2009-06-05 00:16:54 +0200 (Fri, 05 Jun 2009)
New Revision: 1888

Added:
   trunk/src/exp/GpxExportNg.java
   trunk/src/exp/GpxExportNgForm.java
Log:
prototype for new gpx exporter

Added: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-03 20:23:49 UTC (rev 1887)
+++ trunk/src/exp/GpxExportNg.java	2009-06-04 22:16:54 UTC (rev 1888)
@@ -0,0 +1,232 @@
+package exp;
+
+import CacheWolf.CacheSize;
+import CacheWolf.CacheType;
+import CacheWolf.CacheHolder;
+import CacheWolf.Global;
+import com.stevesoft.ewe_pat.*;
+import ewe.util.Hashtable;
+
+import ewe.sys.Vm;
+
+/**
+ * experimental GPX exporter that should better handle the various tasks that can be accomplished with GPX
+ * it is not yet linked to any menu, so if you want to play around with it, first you have to create a menu item
+ *
+ */
+public class GpxExportNg {
+	
+	/** export is in compact format */
+	final static int GPX_COMPACT = 0;
+	/** export is PQ like */
+	final static int GPX_PQLIKE = 1;
+	/** export follows gc.com myfinds format */
+	final static int GPX_MYFINDSPQ = 2;
+	
+	final static String GPXHEADER = "";
+	
+	final static String GPXCOMPACT = "\t<wpt lat=\"@@WPLAT@@\" lon=\"@@WPLON@@\">\n"
+						.concat("\t\t<name>@@WPNAME@@</name>\n")
+						.concat("\t\t<cmt>@@WPCMT@@</cmt>\n")
+						.concat("\t\t<desc>@@WPDESC@@</desc>\n")
+						.concat("\t\t<url>@@WPURL@@</url>\n")
+						.concat("\t\t<urlname>@@WPURLNAME@@</urlname>\n")
+						.concat("\t\t<sym>@@WPSYMBOL@@</sym>\n")
+						.concat("\t\t<type>@@WPTYPE@@</type>\n");
+	
+	final static String GPXEXTENSION ="\t\t<groundspeak:cache id=\"@@CACHEID@@\" available=\"@@CACHEAVAILABLE@@\" archived=\"@@CACHEARCHIVED\" xmlns:groundspeak=\"http://www.geocaching.com/cache/1/0\">\n"
+						.concat("\t\t\t<groundspeak:name>@@CACHENAME@@</groundspeak:name>\n")
+						.concat("\t\t\t<groundspeak:placed_by>@@CACHEPLACEDBY@@<groundspeak:placed_by>\n")
+						.concat("\t\t\t<groundspeak:owner_id id=\"@@CACHEOWNERID@@\">@@CACHEOWNER@@</groundspeak:owner_id>\n")
+						.concat("\t\t\t<groundspeak:type>@@CACHETYPE@@</groundspeak:type>\n")
+						.concat("\t\t\t<groundspeak:container>@@CACHECONTAINER@@</groundspeak:container>\n")
+						.concat("\t\t\t<groundspeak:difficulty>@@CACHEDIFFICULTY@@</groundspeak:difficulty>\n")
+						.concat("\t\t\t<groundspeak:terrain>@@CACHETERRAIN@@</groundspeak:terrain>\n")
+						.concat("\t\t\t<groundspeak:country>@@CACHECOUNTRY@@</groundspeak:country>\n")
+						.concat("\t\t\t<groundspeak:state>@@CACHESTATE@@</groundspeak:state>\n")
+						.concat("\t\t\t<groundspeak:short_description html=\"@@CACHEHTML@@\">@@CACHESHORTDESCRIPTION@@<groundspeak:short_description>\n")
+						.concat("\t\t\t<groundspeak:long_description html=\"@@CACHEHTML@@\">@@CACHELONGDESCRIPTION@@<groundspeak:long_description>\n")
+						.concat("\t\t\t<groundspeak:encoded_hints>@@CACHEHINT@@</groundspeak:encoded_hints>\n");
+
+	final static String GPXLOG = "\t\t\t\t<groundspeak:log id=\"@@LOGID@@\">\n"
+						.concat("\t\t\t\t\t<groundspeak:date>@@LOGDATE@@</groundspeak:date>\n")
+						.concat("\t\t\t\t\t<groundspeak:type>@@LOGTYPE@@</groundspeak:type>\n")
+						.concat("\t\t\t\t\t<groundspeak:finder id=\"@@LOGFINDERID@@\">@@LOGFINDER@@</groundspeak:finder>\n")
+						.concat("\t\t\t\t\t<groundspeak:text encoded=\"@@LOGENCODE@@\">@@LOGTEXT@@</groundspeak:text>\n")
+						.concat("\t\t\t\t</groundspeak:log>\n");
+	
+	final static String GPXTB = "\t\t\t\t<groundspeak:travelbug id=\"@@TBID@@\" ref=\"@@TBREF@@\">\n"
+						.concat("\t\t\t\t\t<groundspeak:name>@@TBNAME@@</groundspeak:name>\n")
+						.concat("\t\t\t\t</groundspeak:travelbug>\n");
+	
+	static boolean smartIds;
+	static boolean customIcons;
+	static boolean separateFile;
+	static boolean sendToGarmin;
+	static int outType;
+	
+	public GpxExportNg() {
+		GpxExportNgForm exportOptions;
+		int ret;
+		final String file, dirctory;
+		final Hashtable fileHandles;
+
+		exportOptions = new GpxExportNgForm();
+		ret = exportOptions.execute();
+		
+		if (-1 == ret) {
+			return;
+		}
+		
+		outType = exportOptions.getExportType();
+		smartIds = exportOptions.getSmartIds();
+		separateFile = exportOptions.getSeparateFiles();
+		sendToGarmin = exportOptions.getSendToGarmin();
+		customIcons = exportOptions.getCustomIcons();
+		
+		if (separateFile) {
+			//TODO: get directory
+			//TODO: initialize files
+		} else {
+			//TODO: get file
+			//TODO: initialize file
+		}
+		
+		for(int i = 0; i<Global.getProfile().cacheDB.size(); i++){
+			CacheHolder ch=Global.getProfile().cacheDB.get(i);
+			Vm.debug(formatCache(ch));
+		}
+
+	}
+	
+	private String formatCache(CacheHolder ch) {
+		// no addis or custom in MyFindsPq - and of course only finds
+		if ((GPX_MYFINDSPQ == outType) && 
+				((ch.getType() == CacheType.CW_TYPE_CUSTOM) || ch.isAddiWpt() || ! ch.is_found())) 
+				return "";
+		
+		StringBuffer ret = new StringBuffer();
+
+		ret.append(formatCompact(ch));
+		
+//		if (outType != GPX_COMPACT && !(ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt())) {
+//			ret.append(formatPqExtensions(ch));
+//		}
+		ret.append("\t</wpt>\n");
+		return ret.toString();
+	}
+	
+	private String formatCompact(CacheHolder ch) {
+		Transformer trans = new Transformer(true);
+		
+		trans.add(new Regex("@@WPLAT@@", 
+				((ch.pos.latDec >= -90) && (ch.pos.latDec <= 90)?String.valueOf(ch.pos.latDec):"")
+			));
+		
+		trans.add(new Regex("@@WPLON@@",
+				((ch.pos.lonDec >= -180) && (ch.pos.lonDec <= 180)?String.valueOf(ch.pos.lonDec):"")
+			));
+		
+		if (smartIds && ch.getType() != CacheType.CW_TYPE_CUSTOM) {
+			if (ch.isAddiWpt()) {
+				trans.add(new Regex("@@WPNAME@@",ch.mainCache.getWayPoint()
+						.concat(" ")
+						.concat(ch.getWayPoint().substring(0,2))));
+			} else {
+				trans.add(new Regex("@@WPNAME@@",ch.getWayPoint()
+						.concat(" ")
+						.concat(CacheType.getExportShortId(ch.getType()))
+						.concat(String.valueOf(ch.getTerrain()))
+						.concat(String.valueOf(ch.getHard()))
+						.concat(CacheSize.getExportShortId(ch.getCacheSize()))
+					));
+			}
+		} else {
+			trans.add(new Regex("@@WPNAME@@",ch.getWayPoint()));
+		}
+		
+		if (ch.isAddiWpt()) {
+			trans.add(new Regex("@@WPCMT@@",ch.getFreshDetails().LongDescription));
+		} else {
+			trans.add(new Regex("@@WPCMT@@",""));
+		}
+		
+		trans.add(new Regex("@@WPDESC@@",""));
+		
+		if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
+			trans.add(new Regex("@@WPURL@@",""));
+		} else {
+			if (ch.isAddiWpt()) {
+				//TODO: find out URL schema for additional waypoints
+				//TODO: check for OC caches
+				trans.add(new Regex("@@WPURL@@",""));
+			} else {
+				//TODO: check for OC caches
+				trans.add(new Regex("@@WPURL@@","http://www.geocaching.com/seek/cache_details.aspx?wp=".concat(ch.getWayPoint())));
+			}
+		}
+		
+		if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
+			trans.add(new Regex("@@WPURLNAME@@",""));
+		} else {
+			trans.add(new Regex("@@WPURLNAME@@",ch.getCacheName()));
+		}
+		
+		if (customIcons) {
+			//TODO: replace with SKGs custom symbol code
+			trans.add(new Regex("@@WPSYMBOL@@","Geocache"));
+		} else {
+			if (ch.is_found()) {
+				trans.add(new Regex("@@WPSYMBOL@@","Geocache found"));
+			} else {
+				trans.add(new Regex("@@WPSYMBOL@@","Geocache"));
+			}
+		}
+		
+		trans.add(new Regex("@@WPTYPE@@",CacheType.cw2ExportString(ch.getType())));
+		
+		return trans.replaceFirst(GPXCOMPACT);
+	}
+	
+	private String formatPqExtensions(CacheHolder ch) {
+		// no details pq details for addis or custom waypoints
+		if (ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt()) return "";
+		
+		StringBuffer ret = new StringBuffer();
+		
+		ret.append(GPXEXTENSION);
+		
+		ret.append("\t\t\t<groundspeak:logs>\n");
+		ret.append(formatLogs(ch));
+		ret.append("\t\t\t</groundspeak:logs>\n");
+		
+		ret.append("\t\t\t<groundspeak:travelbugs>\n");
+		ret.append(formatTbs(ch));
+		ret.append("\t\t\t</groundspeak:travelbugs>\n");
+		
+		ret.append("\t\t</groundspeak:cache>\n");
+		return ret.toString();
+	}
+	
+	public void doit() {
+		
+	}
+	
+	public String formatTbs(CacheHolder ch) {
+		Transformer trans = new Transformer(true);
+		
+		return trans.replaceFirst(GPXTB);
+	}
+	
+	public String formatLogs(CacheHolder ch) {
+		Transformer trans = new Transformer(true);
+		
+		return trans.replaceFirst(GPXLOG);
+	}
+	
+	public String formatHeader() {
+		Transformer trans = new Transformer(true);
+		
+		return trans.replaceFirst(GPXHEADER);
+	}
+}

Added: trunk/src/exp/GpxExportNgForm.java
===================================================================
--- trunk/src/exp/GpxExportNgForm.java	2009-06-03 20:23:49 UTC (rev 1887)
+++ trunk/src/exp/GpxExportNgForm.java	2009-06-04 22:16:54 UTC (rev 1888)
@@ -0,0 +1,137 @@
+package exp;
+
+import ewe.ui.*;
+
+/**
+ * GUI for GpxExporterNg with checkboxes for the options 
+ *
+ */
+public class GpxExportNgForm extends Form {
+	private CheckBoxGroup cbgExportType;
+	private mCheckBox cbCompact, cbPqLike, cbMyFinds, cbCustomIcons, cbSeperateFiles, cbSendToGarmin, cbSmartId;
+	private mButton btnOk, btnCancel;
+	
+	/**
+	 * set up the form / dialog
+	 */
+	public GpxExportNgForm() {
+		//TODO: get defaults from profile
+		
+		this.setTitle("GPX Export");
+		
+		cbgExportType = new CheckBoxGroup();
+		
+		cbCompact = new mCheckBox("Compact");
+		cbCompact.setGroup(cbgExportType);
+		
+		cbPqLike = new mCheckBox("PQ like");
+		cbPqLike.setGroup(cbgExportType);
+		
+		cbMyFinds = new mCheckBox("MyFinds");
+		cbMyFinds.setGroup(cbgExportType);
+		
+		cbgExportType.setText("Compact");
+		
+		cbCustomIcons = new mCheckBox("custom icons");
+		
+		cbSeperateFiles = new mCheckBox("one file per type");
+				
+		cbSendToGarmin = new mCheckBox("send to Garmin GPSr");
+		cbSendToGarmin.modify(Control.Disabled, 0); // not yet
+		
+		cbSmartId = new mCheckBox("use smart IDs");
+		
+		btnOk = new mButton("OK");
+		btnCancel = new mButton("Cancel");
+		
+		addNext(cbCustomIcons);
+		addLast(cbCompact);
+		addNext(cbSeperateFiles);
+		addLast(cbPqLike);
+		addNext(cbSendToGarmin);
+		addLast(cbMyFinds);
+		addLast(cbSmartId);
+
+		addButton(btnOk);
+		addButton(btnCancel);
+	}
+	
+	/**
+	 * react to GUI events and toogle access to the checkboxes according to radio button settings
+	 * pass everything else to <code>super()</code>
+	 */
+	public void onEvent(Event ev){
+		if (ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED) {
+						
+			if (ev.target == cbgExportType) {
+				if (cbgExportType.getSelected() == cbCompact) {
+					if (cbCustomIcons.change(0,Control.Disabled)) cbCustomIcons.repaint();
+					if (cbSeperateFiles.change(0,Control.Disabled)) cbSeperateFiles.repaint();
+//					if (cbSendToGarmin.change(0,Control.Disabled)) cbSendToGarmin.repaint();
+					if (cbSmartId.change(0,Control.Disabled)) cbSmartId.repaint();
+				} else if (cbgExportType.getSelected() == cbPqLike) {
+					cbSeperateFiles.setState(false);
+					if (cbCustomIcons.change(0,Control.Disabled)) cbCustomIcons.repaint();
+					if (cbSeperateFiles.change(Control.Disabled,0)) cbSeperateFiles.repaint();
+//					if (cbSendToGarmin.change(0,Control.Disabled)) cbSendToGarmin.repaint();
+					if (cbSmartId.change(0,Control.Disabled)) cbSmartId.repaint();
+				} else if (cbgExportType.getSelected() == cbMyFinds) {
+					cbCustomIcons.setState(false);
+					cbSeperateFiles.setState(false);
+					cbSendToGarmin.setState(false);
+					cbSmartId.setState(false);
+					if (cbCustomIcons.change(Control.Disabled,0)) cbCustomIcons.repaint();
+					if (cbSeperateFiles.change(Control.Disabled,0)) cbSeperateFiles.repaint();
+//					if (cbSendToGarmin.change(Control.Disabled,0)) cbSendToGarmin.repaint();
+					if (cbSmartId.change(Control.Disabled,0)) cbSmartId.repaint();
+				}
+			} else if (ev.target == btnOk) {
+				close(1);
+			} else if (ev.target == btnCancel) {
+				close(-1);
+			}
+		}
+		super.onEvent(ev);
+	}
+	
+	/**
+	 * get the export type the user selected
+	 * @return index of selected option in checkboxgroup
+	 * @see GpxExportNg
+	 */
+	public int getExportType() {
+		return cbgExportType.getSelectedIndex();
+	}
+	
+	/**
+	 * check if the user wants smart IDs
+	 * @return true for smart IDs, false otherwise
+	 */
+	public boolean getSmartIds() {
+		return cbSmartId.state;
+	}
+	
+	/**
+	 * check if user wants to send output straight to a Garmin GPSr
+	 * @return true for GPSr transfer, false otherwise
+	 */
+	public boolean getSendToGarmin() {
+		return cbSendToGarmin.state;
+	}
+	
+	/**
+	 * check if user wants custom icons
+	 * @return true if user wants custom icons, false otherwise
+	 */
+	public boolean getCustomIcons() {
+		return cbCustomIcons.state;
+	}
+	
+	/**
+	 * check if user wants separate files (POI loader)
+	 * @return true for separate files, false for single file
+	 */
+	public boolean getSeparateFiles() {
+		return cbSeperateFiles.state;
+	}
+}



From greiol at mail.berlios.de  Fri Jun  5 01:21:38 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 5 Jun 2009 01:21:38 +0200
Subject: [Cachewolf-svn] r1889 - trunk/src/CacheWolf
Message-ID: <200906042321.n54NLcGE014066@sheep.berlios.de>

Author: greiol
Date: 2009-06-05 01:21:36 +0200 (Fri, 05 Jun 2009)
New Revision: 1889

Modified:
   trunk/src/CacheWolf/CacheType.java
Log:
Tradi -> Traditional

Modified: trunk/src/CacheWolf/CacheType.java
===================================================================
--- trunk/src/CacheWolf/CacheType.java	2009-06-04 22:16:54 UTC (rev 1888)
+++ trunk/src/CacheWolf/CacheType.java	2009-06-04 23:21:36 UTC (rev 1889)
@@ -116,7 +116,7 @@
 	/** GUI string for custom waypoit */
 	public static final String CW_GUISTR_CUSTOM = "Custom";
 	/** GUI string for custom waypoit */
-	public static final String CW_GUISTR_TRADI = "Tradi";
+	public static final String CW_GUISTR_TRADI = "Traditional";
 	/** GUI string for custom waypoit */
 	public static final String CW_GUISTR_MULTI = "Multi";
 	/** GUI string for custom waypoit */



From araber95 at mail.berlios.de  Mon Jun  8 14:51:26 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Mon, 8 Jun 2009 14:51:26 +0200
Subject: [Cachewolf-svn] r1890 - trunk/src/CacheWolf/navi
Message-ID: <200906081251.n58CpQAl005124@sheep.berlios.de>

Author: araber95
Date: 2009-06-08 14:51:25 +0200 (Mon, 08 Jun 2009)
New Revision: 1890

Modified:
   trunk/src/CacheWolf/navi/MapLoader.java
Log:
Correction for Selection of Current Mapservice in sorted Maplist If no center is set.

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2009-06-04 23:21:36 UTC (rev 1889)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2009-06-08 12:51:25 UTC (rev 1890)
@@ -93,6 +93,7 @@
 	}
 
 	public void setCurrentMapService(int index) {
+		if (index==-1) index=0; // if no center set
 		currentOnlineMapService = (OnlineMapService) onlineMapServices.get(index);
 	}
 



From greiol at mail.berlios.de  Thu Jun 11 04:33:32 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Thu, 11 Jun 2009 04:33:32 +0200
Subject: [Cachewolf-svn] r1891 - trunk/src/exp
Message-ID: <200906110233.n5B2XWHO025954@sheep.berlios.de>

Author: greiol
Date: 2009-06-11 04:33:29 +0200 (Thu, 11 Jun 2009)
New Revision: 1891

Modified:
   trunk/src/exp/GpxExportNg.java
Log:
starts to do something useful

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-08 12:51:25 UTC (rev 1890)
+++ trunk/src/exp/GpxExportNg.java	2009-06-11 02:33:29 UTC (rev 1891)
@@ -1,14 +1,27 @@
 package exp;
 
+import CacheWolf.CacheHolder;
 import CacheWolf.CacheSize;
+import CacheWolf.CacheTerrDiff;
 import CacheWolf.CacheType;
-import CacheWolf.CacheHolder;
 import CacheWolf.Global;
-import com.stevesoft.ewe_pat.*;
-import ewe.util.Hashtable;
 
+import com.stevesoft.ewe_pat.Regex;
+import com.stevesoft.ewe_pat.Transformer;
+
+import ewe.filechooser.FileChooser;
+import ewe.filechooser.FileChooserBase;
+import ewe.io.BufferedWriter;
+import ewe.io.File;
+import ewe.io.FileWriter;
+import ewe.io.PrintWriter;
+import ewe.sys.Date;
 import ewe.sys.Vm;
+import ewe.ui.FormBase;
+import ewe.util.Hashtable;
 
+//TODO: use safexml a lot more (at least start using it ;) )
+
 /**
  * experimental GPX exporter that should better handle the various tasks that can be accomplished with GPX
  * it is not yet linked to any menu, so if you want to play around with it, first you have to create a menu item
@@ -22,10 +35,27 @@
 	final static int GPX_PQLIKE = 1;
 	/** export follows gc.com myfinds format */
 	final static int GPX_MYFINDSPQ = 2;
+
+	final static String expName="GpxExportNG";
+	final static String TRUE="True";
+	final static String FALSE="False";
 	
-	final static String GPXHEADER = "";
+	final static String GPXHEADER = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
+		.concat("<gpx xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" version=\"1.0\" creator=\"CacheWolf http://www.cachewolf.de/\" xsi:schemaLocation=\"http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd http://www.groundspeak.com/cache/1/0 http://www.groundspeak.com/cache/1/0/cache.xsd\" xmlns=\"http://www.topografix.com/GPX/1/0\">\n")
+		.concat("<name>Waypoints for Cache Listings, Generated by CacheWolf</name>\n")
+		.concat("<desc>This is a list of waypoints for geocaches generated by CacheWolf</desc>\n")
+		.concat("<author>Various users from geocaching.com and/or opencaching.de</author>\n")
+		.concat("<email>contact at cachewolf.de</email>\n")
+		.concat("<url>http://www.cachewolf.de/</url>\n")
+		.concat("<urlname>CacheWolf - Paperless Geocaching</urlname>\n")
+		.concat("<time>@@CREATEDATE@@T00:00:00Z</time>\n")
+		.concat("<keywords>cache, geocache, waypoints</keywords>\n")
+// TODO: is it worth a second loop?
+//		.concat("<bounds minlat=\"50.91695\" minlon=\"6.876383\" maxlat=\"50.935183\" maxlon=\"6.918817\" />")
+		;
 	
 	final static String GPXCOMPACT = "\t<wpt lat=\"@@WPLAT@@\" lon=\"@@WPLON@@\">\n"
+						.concat("\t\t<time>@@CACHETIME@@T00:00:00</time>\n")
 						.concat("\t\t<name>@@WPNAME@@</name>\n")
 						.concat("\t\t<cmt>@@WPCMT@@</cmt>\n")
 						.concat("\t\t<desc>@@WPDESC@@</desc>\n")
@@ -44,8 +74,8 @@
 						.concat("\t\t\t<groundspeak:terrain>@@CACHETERRAIN@@</groundspeak:terrain>\n")
 						.concat("\t\t\t<groundspeak:country>@@CACHECOUNTRY@@</groundspeak:country>\n")
 						.concat("\t\t\t<groundspeak:state>@@CACHESTATE@@</groundspeak:state>\n")
-						.concat("\t\t\t<groundspeak:short_description html=\"@@CACHEHTML@@\">@@CACHESHORTDESCRIPTION@@<groundspeak:short_description>\n")
-						.concat("\t\t\t<groundspeak:long_description html=\"@@CACHEHTML@@\">@@CACHELONGDESCRIPTION@@<groundspeak:long_description>\n")
+						.concat("\t\t\t<groundspeak:short_description html=\"@@CACHEHTML@@\">@@CACHESHORTDESCRIPTION@@</groundspeak:short_description>\n")
+						.concat("\t\t\t<groundspeak:long_description html=\"@@CACHEHTML@@\">@@CACHELONGDESCRIPTION@@</groundspeak:long_description>\n")
 						.concat("\t\t\t<groundspeak:encoded_hints>@@CACHEHINT@@</groundspeak:encoded_hints>\n");
 
 	final static String GPXLOG = "\t\t\t\t<groundspeak:log id=\"@@LOGID@@\">\n"
@@ -68,13 +98,11 @@
 	public GpxExportNg() {
 		GpxExportNgForm exportOptions;
 		int ret;
-		final String file, dirctory;
-		final Hashtable fileHandles;
 
 		exportOptions = new GpxExportNgForm();
 		ret = exportOptions.execute();
 		
-		if (-1 == ret) {
+		if (FormBase.IDCANCEL == ret) {
 			return;
 		}
 		
@@ -85,18 +113,50 @@
 		customIcons = exportOptions.getCustomIcons();
 		
 		if (separateFile) {
+			final Hashtable fileHandles;
+			final String directoryName;
 			//TODO: get directory
 			//TODO: initialize files
+			//TODO: iterate through caches
+			//TODO: remove old files with prefix
+			//TODO: write new files
 		} else {
-			//TODO: get file
-			//TODO: initialize file
+			final File file;
+			final FileChooser fc = new FileChooser(FileChooserBase.SAVE, Global.getPref().getExportPath(expName));
+			fc.setTitle("Select target GPX file:");
+			fc.addMask("*.gpx");
+			if(fc.execute() == FormBase.IDCANCEL) return;
+			
+			file = fc.getChosenFile();
+			Global.getPref().setExportPath(expName, file.getPath());
+
+			StringBuffer out = new StringBuffer();
+			
+			out.append(formatHeader());
+			
+			for(int i = 0; i<Global.getProfile().cacheDB.size(); i++){
+				CacheHolder ch=Global.getProfile().cacheDB.get(i);
+				if (ch.is_incomplete()) {
+					Vm.debug("skipping incomplete waypoint "+ch.getWayPoint());
+					continue;
+				}
+				out.append(formatCache(ch));
+			}
+			
+			out.append("</gpx>\n");
+			
+			try {
+				PrintWriter outp =  new PrintWriter(new BufferedWriter(new FileWriter(file)));
+				outp.print(out.toString());
+				outp.close();
+			} catch (Exception ex) {
+				if (Global.getPref().debug) Global.getPref().log("unable to write GPX output to "+file.toString(), ex);
+				else Global.getPref().log("unable to write GPX output to "+file.toString());
+				//TODO: give a message to the user
+			}
+			//TODO: write file. do it when we have a complete waypoint to save memory?
+			Vm.debug(out.toString());
 		}
-		
-		for(int i = 0; i<Global.getProfile().cacheDB.size(); i++){
-			CacheHolder ch=Global.getProfile().cacheDB.get(i);
-			Vm.debug(formatCache(ch));
-		}
-
 	}
 	
 	private String formatCache(CacheHolder ch) {
@@ -109,9 +169,9 @@
 
 		ret.append(formatCompact(ch));
 		
-//		if (outType != GPX_COMPACT && !(ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt())) {
-//			ret.append(formatPqExtensions(ch));
-//		}
+		if (outType != GPX_COMPACT && !(ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt())) {
+			ret.append(formatPqExtensions(ch));
+		}
 		ret.append("\t</wpt>\n");
 		return ret.toString();
 	}
@@ -127,6 +187,8 @@
 				((ch.pos.lonDec >= -180) && (ch.pos.lonDec <= 180)?String.valueOf(ch.pos.lonDec):"")
 			));
 		
+		trans.add(new Regex("@@CACHETIME@@", ch.getDateHidden()));
+		
 		if (smartIds && ch.getType() != CacheType.CW_TYPE_CUSTOM) {
 			if (ch.isAddiWpt()) {
 				trans.add(new Regex("@@WPNAME@@",ch.mainCache.getWayPoint()
@@ -145,13 +207,28 @@
 			trans.add(new Regex("@@WPNAME@@",ch.getWayPoint()));
 		}
 		
-		if (ch.isAddiWpt()) {
+		if (ch.isAddiWpt() || ch.getType() == CacheType.CW_TYPE_CUSTOM) {
 			trans.add(new Regex("@@WPCMT@@",ch.getFreshDetails().LongDescription));
 		} else {
 			trans.add(new Regex("@@WPCMT@@",""));
 		}
 		
-		trans.add(new Regex("@@WPDESC@@",""));
+		if (ch.isAddiWpt()) {
+			trans.add(new Regex("@@WPDESC@@",ch.getCacheName()));
+		} else {
+			trans.add(new Regex("@@WPDESC@@",
+					ch.getCacheName()
+					.concat(" by ")
+					.concat(ch.getCacheOwner())
+					.concat(", ")
+					.concat(CacheType.cw2ExportString(ch.getType()))
+					.concat(" (")
+					.concat(CacheTerrDiff.shortDT(ch.getHard()))
+					.concat("/")
+					.concat(CacheTerrDiff.shortDT(ch.getTerrain()))
+					.concat(")")
+				));
+		}
 		
 		if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
 			trans.add(new Regex("@@WPURL@@",""));
@@ -159,7 +236,7 @@
 			if (ch.isAddiWpt()) {
 				//TODO: find out URL schema for additional waypoints
 				//TODO: check for OC caches
-				trans.add(new Regex("@@WPURL@@",""));
+				trans.add(new Regex("@@WPURL@@","http://www.geocaching.com/seek/wpt.aspx?wp=".concat(ch.getWayPoint())));
 			} else {
 				//TODO: check for OC caches
 				trans.add(new Regex("@@WPURL@@","http://www.geocaching.com/seek/cache_details.aspx?wp=".concat(ch.getWayPoint())));
@@ -176,14 +253,18 @@
 			//TODO: replace with SKGs custom symbol code
 			trans.add(new Regex("@@WPSYMBOL@@","Geocache"));
 		} else {
-			if (ch.is_found()) {
+			if (ch.isAddiWpt()) {
+				trans.add(new Regex("@@WPSYMBOL@@", CacheType.id2GpxString(ch.getType()).substring(CacheType.id2GpxString(ch.getType()).indexOf("|")+1)));
+			} else if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
+				trans.add(new Regex("@@WPSYMBOL@@", "Custom"));
+			} else if (ch.is_found()) {
 				trans.add(new Regex("@@WPSYMBOL@@","Geocache found"));
 			} else {
 				trans.add(new Regex("@@WPSYMBOL@@","Geocache"));
 			}
 		}
 		
-		trans.add(new Regex("@@WPTYPE@@",CacheType.cw2ExportString(ch.getType())));
+		trans.add(new Regex("@@WPTYPE@@",CacheType.id2GpxString(ch.getType())));
 		
 		return trans.replaceFirst(GPXCOMPACT);
 	}
@@ -193,17 +274,41 @@
 		if (ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt()) return "";
 		
 		StringBuffer ret = new StringBuffer();
+		Transformer trans = new Transformer(true);
+		ch.getFreshDetails();
+		trans.add(new Regex("@@CACHEID@@",ch.GetCacheID()));
+		trans.add(new Regex("@@CACHEAVAILABLE@@",ch.is_available()?TRUE:FALSE));
+		trans.add(new Regex("@@CACHEARCHIVED",ch.is_archived()?TRUE:FALSE));
+		trans.add(new Regex("@@CACHENAME@@",ch.getCacheName()));
+		trans.add(new Regex("@@CACHEPLACEDBY@@",ch.getCacheOwner()));
+		trans.add(new Regex("@@CACHEOWNERID@@","31415"));
+		trans.add(new Regex("@@CACHEOWNER@@",ch.getCacheOwner()));
+		trans.add(new Regex("@@CACHETYPE@@",CacheType.id2GpxString(ch.getType())));
+		trans.add(new Regex("@@CACHECONTAINER@@",CacheSize.cw2ExportString(ch.getCacheSize())));
+		trans.add(new Regex("@@CACHEDIFFICULTY@@",CacheTerrDiff.shortDT(ch.getHard())));
+		trans.add(new Regex("@@CACHETERRAIN@@",CacheTerrDiff.shortDT(ch.getTerrain())));
+		trans.add(new Regex("@@CACHECOUNTRY@@",ch.details.Country));
+		trans.add(new Regex("@@CACHESTATE@@",ch.details.State));
+		trans.add(new Regex("@@CACHEHTML@@",ch.is_HTML()?TRUE:FALSE));
+		trans.add(new Regex("@@CACHESHORTDESCRIPTION@@","CacheWolf can not provide Short description"));
+		/* 
+		 * TODO: add additional waypoints to long description, but then GPX importer must 
+		 * remove them as well. otherwise people using PQs to feed CacheWolf will have 
+		 * duplicate additionals at end of PQ like export 
+		 */
+		trans.add(new Regex("@@CACHELONGDESCRIPTION@@",ch.details.LongDescription));
+		trans.add(new Regex("@@CACHEHINT@@",ch.details.Hints));
 		
-		ret.append(GPXEXTENSION);
+		ret.append(trans.replaceAll(GPXEXTENSION));
 		
-		ret.append("\t\t\t<groundspeak:logs>\n");
-		ret.append(formatLogs(ch));
-		ret.append("\t\t\t</groundspeak:logs>\n");
+//		ret.append("\t\t\t<groundspeak:logs>\n");
+//		ret.append(formatLogs(ch));
+//		ret.append("\t\t\t</groundspeak:logs>\n");
+//		
+//		ret.append("\t\t\t<groundspeak:travelbugs>\n");
+//		ret.append(formatTbs(ch));
+//		ret.append("\t\t\t</groundspeak:travelbugs>\n");
 		
-		ret.append("\t\t\t<groundspeak:travelbugs>\n");
-		ret.append(formatTbs(ch));
-		ret.append("\t\t\t</groundspeak:travelbugs>\n");
-		
 		ret.append("\t\t</groundspeak:cache>\n");
 		return ret.toString();
 	}
@@ -214,19 +319,19 @@
 	
 	public String formatTbs(CacheHolder ch) {
 		Transformer trans = new Transformer(true);
-		
-		return trans.replaceFirst(GPXTB);
+		return "";
+//		return trans.replaceFirst(GPXTB);
 	}
 	
 	public String formatLogs(CacheHolder ch) {
 		Transformer trans = new Transformer(true);
-		
-		return trans.replaceFirst(GPXLOG);
+		return "";
+//		return trans.replaceFirst(GPXLOG);
 	}
 	
 	public String formatHeader() {
 		Transformer trans = new Transformer(true);
-		
+		trans.add(new Regex("@@CREATEDATE@@",new Date().setFormat("yyyy-MM-dd").toString()));
 		return trans.replaceFirst(GPXHEADER);
 	}
 }



From salzkammergut at mail.berlios.de  Thu Jun 11 11:22:02 2009
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Thu, 11 Jun 2009 11:22:02 +0200
Subject: [Cachewolf-svn] r1892 - trunk/src/CacheWolf
Message-ID: <200906110922.n5B9M2hh010595@sheep.berlios.de>

Author: salzkammergut
Date: 2009-06-11 11:22:00 +0200 (Thu, 11 Jun 2009)
New Revision: 1892

Modified:
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/myTableModel.java
Log:
Bugfix: Field listColWidth grew by two elements on each start of CW. (See http://www.geoclub.de/viewtopic.php?f=40&t=34967)

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-11 02:33:29 UTC (rev 1891)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-11 09:22:00 UTC (rev 1892)
@@ -154,7 +154,7 @@
 	/** The list of visible columns in the list view */
 	public String listColMap="0,1,2,3,4,5,6,7,8,9,10,11,12";
 	/** The widths for each column in list view */
-	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104,22,30,30";
+	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104,22,30,30,30,30,30";
 	/** The columns which are to be displayed in TravelbugsJourneyScreen. See also TravelbugJourney */
 	public String travelbugColMap="1,4,5,6,8,9,10,7";
 	/** The column widths for the travelbug journeys. */
@@ -320,8 +320,8 @@
 		}
 		else if (name.equals("listview")) {
 			listColMap=atts.getValue("colmap");
-			listColWidth=atts.getValue("colwidths")+",30,30"; // append default values for older versions
-			if((new StringTokenizer(listColWidth,",")).countTokens()<18) listColWidth+=",30,30"; // for older versions
+			listColWidth=atts.getValue("colwidths");
+			while ((new StringTokenizer(listColWidth,",")).countTokens()<myTableModel.N_COLUMNS) listColWidth+=",30"; // for older versions
 		}
 		else if(name.equals("proxy")) {
 			myproxy = atts.getValue("prx");
@@ -523,7 +523,7 @@
 				entry = (MapEntry) itPath.next();
 				outp.print("    <impPath key = \"" + SafeXML.strxmlencode(entry.getKey().toString()) + "\" value = \"" + SafeXML.strxmlencode(entry.getValue().toString().replace('\\', '/')) + "\"/>\n");
 			}
-			
+
 			outp.print("</preferences>");
 			outp.close();
 		} catch (Exception e) {
@@ -815,14 +815,14 @@
 		}
 		return dir;
 	}
-	
+
 	private Hashtable importerPaths = new Hashtable();
-	
+
 	public void setImporterPath(String importer, String directory) {
 		importerPaths.put(importer, directory);
 		savePreferences();
 	}
-	
+
 	public String getImporterPath(String importer) {
 		String dir = (String) importerPaths.get(importer);
 		if (null == dir) dir = Global.getProfile().dataDir;
@@ -830,7 +830,7 @@
 	}
 
 	/**
-	 * <code>True</code> or <code>false</code>, depending if a filter with the given ID is 
+	 * <code>True</code> or <code>false</code>, depending if a filter with the given ID is
 	 * saved in the preferences.
 	 * @param filterID ID of the filter to check
 	 * @return True or false
@@ -838,9 +838,9 @@
 	public boolean hasFilter(String filterID) {
 		return this.filterList.containsKey(filterID);
 	}
-	
+
 	/**
-	 * Returns the FilterData object saved with the given ID. The ID is not saved in the object, 
+	 * Returns the FilterData object saved with the given ID. The ID is not saved in the object,
 	 * so it may be resaved under another ID.
 	 * @param filterID ID of the FilterData object
 	 * @return FilterData object
@@ -848,9 +848,9 @@
 	public FilterData getFilter(String filterID) {
 		return (FilterData)this.filterList.get(filterID);
 	}
-	
+
 	/**
-	 * Adds a FilterData object to the list. If a FilterData object is already saved unter the 
+	 * Adds a FilterData object to the list. If a FilterData object is already saved unter the
 	 * given ID, the old object is removed and the new one is set at its place.
 	 * @param filterID ID to associate with the filter object
 	 * @param filter FilterData object
@@ -858,7 +858,7 @@
 	public void addFilter(String filterID, FilterData filter) {
 		this.filterList.put(filterID, filter);
 	}
-	
+
 	/**
 	 * Removed the FilterData object which is saved with the given ID. If no such FilterData object
 	 * exists, nothing happens.
@@ -867,7 +867,7 @@
 	public void removeFilter(String filterID) {
 		this.filterList.remove(filterID);
 	}
-	
+
 	/**
 	 * Returns an array of ID of saved FilterData objects.
 	 * @return Array of IDs

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-11 02:33:29 UTC (rev 1891)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-11 09:22:00 UTC (rev 1892)
@@ -13,7 +13,7 @@
 * 20061212 salzkammergut, patch to speed up scrolling, Used MyLocale
 */
 public class myTableModel extends TableModel{
-	
+
 	// Colors for Cache status (BG unless otherwise stated)
 	private static final Color COLOR_FLAGED		= new Color(255,255,0);
 	private static final Color COLOR_FOUND		= new Color(152,251,152);
@@ -28,9 +28,11 @@
 	private Color lastColorFG                   = new Color(0,0,0);
 	private int lastRow = -2;
 	private CacheDB cacheDB;
+	/** The max number of columns in the list view */
+	public static final int N_COLUMNS = 18;
 	/** How the columns are mapped onto the list view. If colMap[i]=j, it means that
-	 * the element j (as per the list below) is visible in column i. 
-	 * [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates, 
+	 * the element j (as per the list below) is visible in column i.
+	 * [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates,
 	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing, [12] Size, [13] # of OC recommend.
 	 * [14] OC index, [15] Solver exists, [16] Note exists, [17] # Additionals
 	 */
@@ -43,7 +45,7 @@
 			MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear"),MyLocale.getMsg(1017,"S"),
 			MyLocale.getMsg(1026,"#Rec"),MyLocale.getMsg(1027,"OC-IDX"),MyLocale.getMsg(1038,"S"),
 			MyLocale.getMsg(1040,"N"),MyLocale.getMsg(1047,"A")};
-	
+
 	private static Image noFindLogs[] = new Image[4];
 	public static mImage red, blue, yellow; // skull, green
 	private Image checkboxTicked,checkboxUnticked;
@@ -56,18 +58,18 @@
 	private mImage[] sizePics = new mImage[CacheSize.CW_TOTAL_SIZE_IMAGES];
 	/** This is the modifier (Shift & Control key status) for Pen Events
 	 * it is set in myTableControl.onEvent */
-	public int penEventModifiers; 
-	
+	public int penEventModifiers;
+
 //	private int lastRow=-1;
 	private myTableControl tcControl;
 	public boolean showExtraWptInfo=true;
-	
+
 	public myTableModel(myTableControl tc, FontMetrics fm){
 		super();
 		cacheDB = Global.getProfile().cacheDB;
 		fm = this.fm;
 		tcControl = tc;
-		setColumnNamesAndWidths(); 
+		setColumnNamesAndWidths();
 		this.numRows = cacheDB.size();
 		//Dimension selrow = new Dimension(-1,1);
 		//this.cursorSize = selrow;
@@ -83,30 +85,30 @@
 		bug = new mImage("bug_table.png");bug.transparentColor=Color.DarkBlue;
 		checkboxTicked = new Image("checkboxTicked.png");
 		checkboxUnticked= new Image("checkboxUnticked.png");
-		
+
 //		picSizeMicro=new mImage("sizeMicro.png"); picSizeMicro.transparentColor=Color.White;
 //		picSizeSmall=new mImage("sizeSmall.png"); picSizeSmall.transparentColor=Color.White;
 //		picSizeReg=new mImage("sizeReg.png"); picSizeReg.transparentColor=Color.White;
 //		picSizeLarge=new mImage("sizeLarge.png"); picSizeLarge.transparentColor=Color.White;
 //		picSizeVLarge=new mImage("sizeVLarge.png"); picSizeVLarge.transparentColor=Color.White;
 //		picSizeNonPhysical=new mImage("sizeNonPhysical.png"); picSizeNonPhysical.transparentColor=Color.White;
-		
+
 		for (byte i = 0; i < CacheSize.CW_TOTAL_SIZE_IMAGES; i++) {
 			sizePics[i] = new mImage(CacheSize.sizeImageForId(i));
 			sizePics[i].transparentColor=Color.White;
 		}
-				
+
 		picHasSolver=new mImage("solver_exists.png"); picHasSolver.transparentColor=Color.White;
 		picHasNotes=new mImage("notes_exist.png"); picHasNotes.transparentColor=Color.White;
 //		updateRows();
 	}
-	
+
 	/**
 	 * Sets the column names and widths from preferences
 	 *
 	 */
 	public void setColumnNamesAndWidths() {
-		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,17,0, -1);
+		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,N_COLUMNS-1,0, -1);
 		colWidth=TableColumnChooser.str2Array(Global.getPref().listColWidth,10,1024,50, colMap.length);
 		numCols=colMap.length;
 		clearCellAdjustments();
@@ -116,7 +118,7 @@
 		else
 			tcControl.setMenuSmall();
 	}
-	
+
 	/**
 	 * Return the column widths as a comma delimited string for storing in the preferences
 	 * @return
@@ -128,8 +130,8 @@
 		}
 		clearCellAdjustments();
 		// Convert to string
-		StringBuffer sb=new StringBuffer(40);
-		for (int i=0; i<colWidth.length; i++) {
+		StringBuffer sb=new StringBuffer(100);
+		for (int i=0; i<N_COLUMNS; i++) {
 			if (sb.length()!=0) sb.append(',');
 			sb.append(colWidth[i]);
 		}
@@ -151,7 +153,7 @@
 				if (ch.isAddiWpt()){ // unfiltered Addi Wpt
 					// check if main wpt is filtered
 					if(ch.mainCache != null) { // parent exists
-						if (! ch.mainCache.isVisible()) 
+						if (! ch.mainCache.isVisible())
 							sortDB.add(ch); // Unfiltered Addi Wpt with filtered Main Wpt, show it on its own
 						// else Main cache is not filtered, Addi will be added below main cache further down
 					} else { //Addi without main Cache
@@ -172,14 +174,14 @@
 		cacheDB.rebuild(sortDB, notVisibleDB);
 		this.numRows = sortDB.getCount();
 	}
-	
+
 	/**
 	 * Method to set the row color of the table displaying the cache list, depending on different
 	 * flags set to the cache.
 	 */
 	/*
 	 * (non-Javadoc)
-	 * 
+	 *
 	 * @see ewe.ui.TableModel#getCellAttributes(int, int, boolean, ewe.ui.TableCellAttributes)
 	 */
 	public TableCellAttributes getCellAttributes(int row, int col, boolean isSelected,
@@ -234,7 +236,7 @@
 				};
 			} else  {
 				// Here: We already had this row.
-				// Take color computed for last column 
+				// Take color computed for last column
 				ta.fillColor = lastColorBG;
 				ta.foreground = lastColorFG;
 			}
@@ -246,7 +248,7 @@
 	}
 
 	/**
-	 * Determines the arithmetic mean value of two colors and stores the result in the 
+	 * Determines the arithmetic mean value of two colors and stores the result in the
 	 * third color.
 	 * @param colorMerged Resulting color
 	 * @param colorA First color to merge. May be same object as <code>colorMerged</code>.
@@ -262,13 +264,13 @@
 	}
 
 	public int calculateColWidth(int col){
-		if(col == -1) 
+		if(col == -1)
         	return 0;
         else if (col<numCols)
         	return colWidth[colMap[col]];
         else return 0;
 	}
-	
+
 	/**
 	 * Need to override this method with a null return to avoid
 	 * getCellData being called twice on each access to a cell.
@@ -286,9 +288,9 @@
 			if(ch!=null /*ch.isVisible()*/){ // Check of visibility needed here??
 				switch(colMap[col]) { // Faster than using column names
 					case 0: // Checkbox
-						if (ch.is_Checked) 
-							return checkboxTicked; 
-						else 
+						if (ch.is_Checked)
+							return checkboxTicked;
+						else
 							return checkboxUnticked;
 					case 1: // Type
 						return GuiImageBroker.getTypeImage(ch.getType());
@@ -316,14 +318,14 @@
 						return ch.getWayPoint();
 					case 5: // Cachename
 						// Fast return for majority of case
-						if (!showExtraWptInfo || (ch.has_bugs() == false && ch.getNoFindLogs()==0)) return ch.getCacheName(); 
+						if (!showExtraWptInfo || (ch.has_bugs() == false && ch.getNoFindLogs()==0)) return ch.getCacheName();
 						// Now need more checks
 						IconAndText wpVal = new IconAndText();
 						if(ch.has_bugs() == true) wpVal.addColumn(bug);
 						if(ch.getNoFindLogs() > 0){
-							if (ch.getNoFindLogs() > noFindLogs.length) 
+							if (ch.getNoFindLogs() > noFindLogs.length)
 								wpVal.addColumn(noFindLogs[noFindLogs.length-1]);
-							else 
+							else
 								wpVal.addColumn(noFindLogs[ch.getNoFindLogs()-1]);
 						}
 						wpVal.addColumn(ch.getCacheName());
@@ -350,12 +352,12 @@
 						if (ch.getWayPoint().startsWith("OC"))
 							return Convert.formatInt(ch.getNumRecommended());
 						return null;
-					case 14: // OC rating	
+					case 14: // OC rating
 						if (ch.getWayPoint().startsWith("OC"))
 							return Convert.formatInt(ch.recommendationScore);
 						return null;
 					case 15: // Is solver filled?
-					    if (ch.hasSolver()) return picHasSolver; else return null; 
+					    if (ch.hasSolver()) return picHasSolver; else return null;
 					case 16: // Does note exist?
 						if (ch.hasNote()) return picHasNotes; else return null;
 					case 17: // Number of Additional Waypoints;
@@ -372,7 +374,7 @@
 	}
 		return null;
 	}
-	
+
 	public boolean penPressed(Point onTable,Point cell){
 		boolean retval = false;
 		if (cell==null) return false;
@@ -398,10 +400,10 @@
 				// column it is mapped into
 				int mappedCol=colMap[cell.x];
 				if (mappedCol==0) { // Click on Tickbox header
-					// Hide/unhide the additional information about a waypoint such as 
+					// Hide/unhide the additional information about a waypoint such as
 					// travelbugs/number of notfound logs/yellow circle/red circle etc.
 					// This helps on small PDA screens
-					showExtraWptInfo=!showExtraWptInfo; 
+					showExtraWptInfo=!showExtraWptInfo;
 					this.table.repaint();
 					return true;
 				}
@@ -420,7 +422,7 @@
 	/*					tcControl.scrollToVisible(rownum, 0);
 						tcControl.clearSelectedCells(new Vector());
 						for(int i= 0; i < MAXCOLUMNS; i++){
-							tcControl.addToSelection(rownum,i); 
+							tcControl.addToSelection(rownum,i);
 						}
 		*/			}
 				}
@@ -434,7 +436,7 @@
 			}
 		return retval;
 	}
-	
+
 	/** Toggle the select status for a group of caches
 	 * If from==to, the addi Waypoints are also toggled if the cache is a main waypoint
 	 * If from!=to, each cache is toggled irrespective of its type (main or addi)
@@ -447,7 +449,7 @@
 		boolean singleRow= from == to;
 		for (int j=from; j<=to; j++) {
 			ch=cacheDB.get(j);
-			ch.is_Checked= !ch.is_Checked; 
+			ch.is_Checked= !ch.is_Checked;
 			tcControl.repaintCell(j, x);
 			// set the ceckbox also for addi wpts
 			if (ch.hasAddiWpt() && singleRow){
@@ -460,13 +462,13 @@
 						tcControl.repaintCell(cacheDB.getIndex(addiWpt), x);
 					}
 				}
-				
+
 			}
-		}		
+		}
 	}
 	public void select(int row,int col,boolean selectOn) {
 		//super.select(row, col, selectOn);
 		tcControl.cursorTo(row, col, true);
 	}
-		
+
 }



From araber95 at mail.berlios.de  Fri Jun 12 00:52:18 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Fri, 12 Jun 2009 00:52:18 +0200
Subject: [Cachewolf-svn] r1893 - trunk/src/CacheWolf
Message-ID: <200906112252.n5BMqITS017616@sheep.berlios.de>

Author: araber95
Date: 2009-06-12 00:52:10 +0200 (Fri, 12 Jun 2009)
New Revision: 1893

Modified:
   trunk/src/CacheWolf/GuiImageBroker.java
   trunk/src/CacheWolf/MainForm.java
Log:
GuiImageBroker.customizedSymbols();
Replaces the buildt-in symbols by images stored in /symbols: If the subdirectory symbols exists in CW-directory *.png-files are read in and roughly checked for validity (names must be convertable to integers between 0 and 21). For every valid file x.png the corresponding typeImages[x] is replaced by the image in x.png.
Images are NOT checked for size etc.

new public static void customizedSymbols() called in MainForm as GuiImageBroker.customizedSymbols();

Modified: trunk/src/CacheWolf/GuiImageBroker.java
===================================================================
--- trunk/src/CacheWolf/GuiImageBroker.java	2009-06-11 09:22:00 UTC (rev 1892)
+++ trunk/src/CacheWolf/GuiImageBroker.java	2009-06-11 22:52:10 UTC (rev 1893)
@@ -1,89 +1,124 @@
-package CacheWolf;
-
-import ewe.fx.Image;
-
-/**
- * hold preloaded versions of GUI images in a single place
- * 
- * Do not instantiate this class, only use it in a static way.
- */
-
-public final class GuiImageBroker {
-	
-	// TODO: check with Image and mImage
-	
-	/** image to be displayed in case of error */
-	public static Image imageError = new Image("guiError.png");
-	
-	/**
-	 * images to be displayed for cache types in GUI
-	 * @see getTypeImage
-	 * @see CacheTypes
-	 */
-	private static final Image[] typeImages = {
-		new Image(CacheType.CW_GUIIMG_CUSTOM),		// 0
-		new Image(CacheType.CW_GUIIMG_APE),			// 1
-		new Image(CacheType.CW_GUIIMG_CITO),		// 2
-		new Image(CacheType.CW_GUIIMG_DRIVE_IN),	// 3
-		new Image(CacheType.CW_GUIIMG_EARTH),		// 4
-		new Image(CacheType.CW_GUIIMG_EVENT),		// 5
-		new Image(CacheType.CW_GUIIMG_FINAL),		// 6
-		new Image(CacheType.CW_GUIIMG_LETTERBOX),	// 7
-		new Image(CacheType.CW_GUIIMG_LOCATIONLESS),// 8
-		new Image(CacheType.CW_GUIIMG_MAZE),		// 9
-		new Image(CacheType.CW_GUIIMG_MEGA_EVENT),	// 10
-		new Image(CacheType.CW_GUIIMG_MULTI),		// 11
-		new Image(CacheType.CW_GUIIMG_PARKING),		// 12
-		new Image(CacheType.CW_GUIIMG_QUESTION),	// 13
-		new Image(CacheType.CW_GUIIMG_REFERENCE),	// 14
-		new Image(CacheType.CW_GUIIMG_STAGE),		// 15
-		new Image(CacheType.CW_GUIIMG_TRADITIONAL),	// 16
-		new Image(CacheType.CW_GUIIMG_TRAILHEAD),	// 17
-		new Image(CacheType.CW_GUIIMG_UNKNOWN),		// 18
-		new Image(CacheType.CW_GUIIMG_VIRTUAL),		// 19
-		new Image(CacheType.CW_GUIIMG_WEBCAM),		// 20
-		new Image(CacheType.CW_GUIIMG_WHEREIGO)		// 21
-	};
-	
-	// TODO: move size images here
-	private static final Image[] sizeImages = {
-		
-	};
-
-	/** constructor does nothing */
-	private GuiImageBroker() { // no instantiation needed
-	}
-	
-	/**
-	 * select image to be displayed for a given cache type
-	 * @param id internal cache type id
-	 * @return <code>Image</code> object to be displayed
-	 */
-	public static Image getTypeImage(byte id) {
-		switch (id) {
-		case CacheType.CW_TYPE_CUSTOM: return typeImages[0];
-		case CacheType.CW_TYPE_APE: return typeImages[1];
-		case CacheType.CW_TYPE_CITO: return typeImages[2];
-		case CacheType.CW_TYPE_DRIVE_IN: return typeImages[3];
-		case CacheType.CW_TYPE_EARTH: return typeImages[4];
-		case CacheType.CW_TYPE_EVENT: return typeImages[5];
-		case CacheType.CW_TYPE_FINAL: return typeImages[6];
-		case CacheType.CW_TYPE_LETTERBOX: return typeImages[7];
-		case CacheType.CW_TYPE_LOCATIONLESS: return typeImages[8];
-		case CacheType.CW_TYPE_MAZE: return typeImages[9];
-		case CacheType.CW_TYPE_MEGA_EVENT: return typeImages[10];
-		case CacheType.CW_TYPE_MULTI: return typeImages[11];
-		case CacheType.CW_TYPE_PARKING: return typeImages[12];
-		case CacheType.CW_TYPE_QUESTION: return typeImages[13];
-		case CacheType.CW_TYPE_REFERENCE: return typeImages[14];
-		case CacheType.CW_TYPE_STAGE: return typeImages[15];
-		case CacheType.CW_TYPE_TRADITIONAL: return typeImages[16];
-		case CacheType.CW_TYPE_TRAILHEAD: return typeImages[17];
-		case CacheType.CW_TYPE_UNKNOWN: return typeImages[18];
-		case CacheType.CW_TYPE_VIRTUAL: return typeImages[19];
-		case CacheType.CW_TYPE_WEBCAM: return typeImages[20];
-		case CacheType.CW_TYPE_WHEREIGO: return typeImages[21];
-		default: return imageError;
-		}	
-	}
-}
+package CacheWolf;
+
+import ewe.fx.Image;
+import ewe.io.FileBase;
+import utils.FileBugfix;
+
+/**
+ * hold preloaded versions of GUI images in a single place
+ *
+ * Do not instantiate this class, only use it in a static way.
+ */
+
+public final class GuiImageBroker {
+
+	// TODO: check with Image and mImage
+
+	/** image to be displayed in case of error */
+	public static Image imageError = new Image("guiError.png");
+
+	/**
+	 * images to be displayed for cache types in GUI
+	 * @see getTypeImage
+	 * @see CacheTypes
+	 */
+	private static final Image[] typeImages = {
+		new Image(CacheType.CW_GUIIMG_CUSTOM),		// 0
+		new Image(CacheType.CW_GUIIMG_APE),			// 1
+		new Image(CacheType.CW_GUIIMG_CITO),		// 2
+		new Image(CacheType.CW_GUIIMG_DRIVE_IN),	// 3
+		new Image(CacheType.CW_GUIIMG_EARTH),		// 4
+		new Image(CacheType.CW_GUIIMG_EVENT),		// 5
+		new Image(CacheType.CW_GUIIMG_FINAL),		// 6
+		new Image(CacheType.CW_GUIIMG_LETTERBOX),	// 7
+		new Image(CacheType.CW_GUIIMG_LOCATIONLESS),// 8
+		new Image(CacheType.CW_GUIIMG_MAZE),		// 9
+		new Image(CacheType.CW_GUIIMG_MEGA_EVENT),	// 10
+		new Image(CacheType.CW_GUIIMG_MULTI),		// 11
+		new Image(CacheType.CW_GUIIMG_PARKING),		// 12
+		new Image(CacheType.CW_GUIIMG_QUESTION),	// 13
+		new Image(CacheType.CW_GUIIMG_REFERENCE),	// 14
+		new Image(CacheType.CW_GUIIMG_STAGE),		// 15
+		new Image(CacheType.CW_GUIIMG_TRADITIONAL),	// 16
+		new Image(CacheType.CW_GUIIMG_TRAILHEAD),	// 17
+		new Image(CacheType.CW_GUIIMG_UNKNOWN),		// 18
+		new Image(CacheType.CW_GUIIMG_VIRTUAL),		// 19
+		new Image(CacheType.CW_GUIIMG_WEBCAM),		// 20
+		new Image(CacheType.CW_GUIIMG_WHEREIGO)		// 21
+	};
+
+	// TODO: move size images here
+	private static final Image[] sizeImages = {
+
+	};
+
+	/** constructor does nothing */
+	private GuiImageBroker() { // no instantiation needed
+	}
+
+	/**
+	 * select image to be displayed for a given cache type
+	 * @param id internal cache type id
+	 * @return <code>Image</code> object to be displayed
+	 */
+	public static Image getTypeImage(byte id) {
+		switch (id) {
+		case CacheType.CW_TYPE_CUSTOM: return typeImages[0];
+		case CacheType.CW_TYPE_APE: return typeImages[1];
+		case CacheType.CW_TYPE_CITO: return typeImages[2];
+		case CacheType.CW_TYPE_DRIVE_IN: return typeImages[3];
+		case CacheType.CW_TYPE_EARTH: return typeImages[4];
+		case CacheType.CW_TYPE_EVENT: return typeImages[5];
+		case CacheType.CW_TYPE_FINAL: return typeImages[6];
+		case CacheType.CW_TYPE_LETTERBOX: return typeImages[7];
+		case CacheType.CW_TYPE_LOCATIONLESS: return typeImages[8];
+		case CacheType.CW_TYPE_MAZE: return typeImages[9];
+		case CacheType.CW_TYPE_MEGA_EVENT: return typeImages[10];
+		case CacheType.CW_TYPE_MULTI: return typeImages[11];
+		case CacheType.CW_TYPE_PARKING: return typeImages[12];
+		case CacheType.CW_TYPE_QUESTION: return typeImages[13];
+		case CacheType.CW_TYPE_REFERENCE: return typeImages[14];
+		case CacheType.CW_TYPE_STAGE: return typeImages[15];
+		case CacheType.CW_TYPE_TRADITIONAL: return typeImages[16];
+		case CacheType.CW_TYPE_TRAILHEAD: return typeImages[17];
+		case CacheType.CW_TYPE_UNKNOWN: return typeImages[18];
+		case CacheType.CW_TYPE_VIRTUAL: return typeImages[19];
+		case CacheType.CW_TYPE_WEBCAM: return typeImages[20];
+		case CacheType.CW_TYPE_WHEREIGO: return typeImages[21];
+		default: return imageError;
+		}
+	}
+
+	/**
+	 * Replaces the buildt-in symbols by images stored in /symbols:
+	 * If the subdirectory symbols exists in CW-directory *.png-files
+	 * are read in and roughly checked for validity (names must be
+	 * convertable to integers between 0 and 21).
+	 * For every valid file x.png the corresponding typeImages[x] is
+	 * replaced by the image in x.png.
+	 * Images are NOT checked for size etc.
+	 */
+	public static void customizedSymbols()
+	{
+		FileBugfix dir=new FileBugfix(FileBase.getProgramDirectory()+"/symbols");
+		if (dir.isDirectory()){
+			int id;
+			String name = "";
+			String [] pngFiles;
+			pngFiles=dir.list("*.png",0);
+			for (int i=0; i<pngFiles.length; i++) {
+				name = pngFiles[i].substring(0,pngFiles[i].length()-4);
+				try {
+					id = Integer.parseInt (name);
+				}
+				catch (Exception E){
+					id = -1; //filename invalid for symbols
+				}
+				if (0<=id && id<=typeImages.length){
+					typeImages[id]= new Image(FileBase.getProgramDirectory()+"/symbols/"+pngFiles[i]);
+				}
+			}
+		}
+	}
+
+}

Modified: trunk/src/CacheWolf/MainForm.java
===================================================================
--- trunk/src/CacheWolf/MainForm.java	2009-06-11 09:22:00 UTC (rev 1892)
+++ trunk/src/CacheWolf/MainForm.java	2009-06-11 22:52:10 UTC (rev 1893)
@@ -79,6 +79,11 @@
 			if (!pref.selectProfile(profile,Preferences.PROFILE_SELECTOR_ONOROFF, true))
 				ewe.sys.Vm.exit(0); // User MUST select or create a profile
 			Vm.showWait(true);
+
+
+			// Replace buildt-in symbols with customized images
+			GuiImageBroker.customizedSymbols();
+
 			// Load CacheList
 			infB = new InfoBox("CacheWolf",MyLocale.getMsg(5000,"Loading Cache-List"));
 			infB.exec();



From greiol at mail.berlios.de  Fri Jun 12 16:16:31 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 12 Jun 2009 16:16:31 +0200
Subject: [Cachewolf-svn] r1894 - in trunk: resources src/CacheWolf
Message-ID: <200906121416.n5CEGV8K031618@sheep.berlios.de>

Author: greiol
Date: 2009-06-12 16:16:07 +0200 (Fri, 12 Jun 2009)
New Revision: 1894

Added:
   trunk/resources/typeCito.png
   trunk/resources/typeCustom.png
   trunk/resources/typeDrivein.png
   trunk/resources/typeEarth.png
   trunk/resources/typeEvent.png
   trunk/resources/typeFinal.png
   trunk/resources/typeLetterbox.png
   trunk/resources/typeLocless.png
   trunk/resources/typeMath.png
   trunk/resources/typeMegaevent.png
   trunk/resources/typeMoving.png
   trunk/resources/typeMulti.png
   trunk/resources/typeParking.png
   trunk/resources/typeQuestion.png
   trunk/resources/typeStage.png
   trunk/resources/typeTradi.png
   trunk/resources/typeTrailhead.png
   trunk/resources/typeUnknown.png
   trunk/resources/typeVirtual.png
   trunk/resources/typeWebcam.png
   trunk/resources/typeWhereigo.png
Removed:
   trunk/resources/0.png
   trunk/resources/108.png
   trunk/resources/109.png
   trunk/resources/11.png
   trunk/resources/110.png
   trunk/resources/12.png
   trunk/resources/13.png
   trunk/resources/137.png
   trunk/resources/1858.png
   trunk/resources/2.png
   trunk/resources/3.png
   trunk/resources/4.png
   trunk/resources/453.png
   trunk/resources/5.png
   trunk/resources/6.png
   trunk/resources/8.png
   trunk/resources/flag.png
   trunk/resources/pkg.png
   trunk/resources/puzzle.png
   trunk/resources/stage.png
   trunk/resources/trailhead.png
Modified:
   trunk/src/CacheWolf/CacheType.java
Log:
renamed typeimages to a consistent schema since the number based names did not reflect reality anyway

Deleted: trunk/resources/0.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/108.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/109.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/11.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/110.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/12.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/13.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/137.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/1858.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/2.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/3.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/4.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/453.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/5.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/6.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/8.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/flag.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/pkg.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/puzzle.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/stage.png
===================================================================
(Binary files differ)

Deleted: trunk/resources/trailhead.png
===================================================================
(Binary files differ)

Copied: trunk/resources/typeCito.png (from rev 1893, trunk/resources/13.png)


Property changes on: trunk/resources/typeCito.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeCustom.png (from rev 1893, trunk/resources/0.png)


Property changes on: trunk/resources/typeCustom.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeDrivein.png (from rev 1893, trunk/resources/110.png)


Property changes on: trunk/resources/typeDrivein.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeEarth.png (from rev 1893, trunk/resources/137.png)


Property changes on: trunk/resources/typeEarth.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeEvent.png (from rev 1893, trunk/resources/6.png)


Property changes on: trunk/resources/typeEvent.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeFinal.png (from rev 1893, trunk/resources/flag.png)


Property changes on: trunk/resources/typeFinal.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeLetterbox.png (from rev 1893, trunk/resources/5.png)


Property changes on: trunk/resources/typeLetterbox.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeLocless.png (from rev 1893, trunk/resources/12.png)


Property changes on: trunk/resources/typeLocless.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeMath.png (from rev 1893, trunk/resources/108.png)


Property changes on: trunk/resources/typeMath.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeMegaevent.png (from rev 1893, trunk/resources/453.png)


Property changes on: trunk/resources/typeMegaevent.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeMoving.png (from rev 1893, trunk/resources/109.png)


Property changes on: trunk/resources/typeMoving.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeMulti.png (from rev 1893, trunk/resources/3.png)


Property changes on: trunk/resources/typeMulti.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeParking.png (from rev 1893, trunk/resources/pkg.png)


Property changes on: trunk/resources/typeParking.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeQuestion.png (from rev 1893, trunk/resources/puzzle.png)


Property changes on: trunk/resources/typeQuestion.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeStage.png (from rev 1893, trunk/resources/stage.png)


Property changes on: trunk/resources/typeStage.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeTradi.png (from rev 1893, trunk/resources/2.png)


Property changes on: trunk/resources/typeTradi.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeTrailhead.png (from rev 1893, trunk/resources/trailhead.png)


Property changes on: trunk/resources/typeTrailhead.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeUnknown.png (from rev 1893, trunk/resources/8.png)


Property changes on: trunk/resources/typeUnknown.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeVirtual.png (from rev 1893, trunk/resources/4.png)


Property changes on: trunk/resources/typeVirtual.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeWebcam.png (from rev 1893, trunk/resources/11.png)


Property changes on: trunk/resources/typeWebcam.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Copied: trunk/resources/typeWhereigo.png (from rev 1893, trunk/resources/1858.png)


Property changes on: trunk/resources/typeWhereigo.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Modified: trunk/src/CacheWolf/CacheType.java
===================================================================
--- trunk/src/CacheWolf/CacheType.java	2009-06-11 22:52:10 UTC (rev 1893)
+++ trunk/src/CacheWolf/CacheType.java	2009-06-12 14:16:07 UTC (rev 1894)
@@ -63,55 +63,55 @@
 	public static final byte CW_TYPE_ERROR = -1;
 	
 	/** image for custom waypoints */
-	public static final String CW_GUIIMG_CUSTOM = "0.png";
+	public static final String CW_GUIIMG_CUSTOM = "typeCustom.png";
 	/** image for traditional cache (GC,OC) */
-	public static final String CW_GUIIMG_TRADITIONAL = "2.png";
+	public static final String CW_GUIIMG_TRADITIONAL = "typeTradi.png";
 	/** image for multi cache (GC,OC) */
-	public static final String CW_GUIIMG_MULTI = "3.png";
+	public static final String CW_GUIIMG_MULTI = "typeMulti.png";
 	/** image for virtual cache (GC) */
-	public static final String CW_GUIIMG_VIRTUAL = "4.png";
+	public static final String CW_GUIIMG_VIRTUAL = "typeVirtual.png";
 	/** image for letterbox cache (GC) */
-	public static final String CW_GUIIMG_LETTERBOX = "5.png";
+	public static final String CW_GUIIMG_LETTERBOX = "typeLetterbox.png";
 	/** image for event cache (OC,GC) */
-	public static final String CW_GUIIMG_EVENT = "6.png";
+	public static final String CW_GUIIMG_EVENT = "typeEvent.png";
 	/** image for quiz cache (OC) */
-	public static final String CW_GUIIMG_QUIZ = "8.png";
+	public static final String CW_GUIIMG_QUIZ = "typeUnknown.png";
 	/** image for unknown cache (GC) */
-	public static final String CW_GUIIMG_UNKNOWN = "8.png";
+	public static final String CW_GUIIMG_UNKNOWN = "typeUnknown.png";
 	/** image for math cache (OC) */
-	public static final String CW_GUIIMG_MATH = "108.png";
+	public static final String CW_GUIIMG_MATH = "typeMath.png";
 	/** image for moving cache (OC) */
-	public static final String CW_GUIIMG_MOVING = "109.png";
+	public static final String CW_GUIIMG_MOVING = "typeMoving.png";
 	/** image for drive in cache (OC) */
-	public static final String CW_GUIIMG_DRIVE_IN = "110.png";
+	public static final String CW_GUIIMG_DRIVE_IN = "typeDrivein.png";
 	/** image for webcam cache (GC,OC) */
-	public static final String CW_GUIIMG_WEBCAM = "11.png";
+	public static final String CW_GUIIMG_WEBCAM = "typeWebcam.png";
 	/** image for locationless cache (GC) */
-	public static final String CW_GUIIMG_LOCATIONLESS = "12.png";
+	public static final String CW_GUIIMG_LOCATIONLESS = "typeLocless.png";
 	/** image for CITO cache (GC,OC)*/
-	public static final String CW_GUIIMG_CITO = "13.png";
+	public static final String CW_GUIIMG_CITO = "typeCito.png";
 	/** image for Additional Waypoint Parking (GC) */
-	public static final String CW_GUIIMG_PARKING = "pkg.png";
+	public static final String CW_GUIIMG_PARKING = "typeParking.png";
 	/** image for Additional Waypoint Stage of a Multi (GC) */
-	public static final String CW_GUIIMG_STAGE = "stage.png";
+	public static final String CW_GUIIMG_STAGE = "typeStage.png";
 	/** image for Additional Waypoint Question to answer (GC) */
-	public static final String CW_GUIIMG_QUESTION = "puzzle.png";
+	public static final String CW_GUIIMG_QUESTION = "typeQuestion.png";
 	/** image for Additional Waypoint Final (GC) */
-	public static final String CW_GUIIMG_FINAL = "flag.png";
+	public static final String CW_GUIIMG_FINAL = "typeFinal.png";
 	/** image for Additional Waypoint Trailhead (GC) */
-	public static final String CW_GUIIMG_TRAILHEAD = "trailhead.png";
+	public static final String CW_GUIIMG_TRAILHEAD = "typeTrailhead.png";
 	/** image for Additional Waypoint Reference Point (GC) */
 	public static final String CW_GUIIMG_REFERENCE = "waypoint.png";
 	/** image for Mega Event Cache (GC) */
-	public static final String CW_GUIIMG_MEGA_EVENT = "453.png";
+	public static final String CW_GUIIMG_MEGA_EVENT = "typemegaevent.png";
 	/** image for WhereIGo Cache (GC) */
-	public static final String CW_GUIIMG_WHEREIGO = "1858.png";
+	public static final String CW_GUIIMG_WHEREIGO = "typeWhereigo.png";
 	/** image for Project Ape cache (GC)*/
 	public static final String CW_GUIIMG_APE = "typeApe.png";
 	/** image for Adenture Maze Exhibit (GC)*/
 	public static final String CW_GUIIMG_MAZE = "typeMaze.png";
 	/** image for Earth Cache (GC) */
-	public static final String CW_GUIIMG_EARTH = "137.png";
+	public static final String CW_GUIIMG_EARTH = "typeEarth.png";
 	
 	/** GUI string for custom waypoit */
 	public static final String CW_GUISTR_CUSTOM = "Custom";



From greiol at mail.berlios.de  Fri Jun 12 16:47:41 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 12 Jun 2009 16:47:41 +0200
Subject: [Cachewolf-svn] r1895 - trunk/src/exp
Message-ID: <200906121447.n5CElfms000859@sheep.berlios.de>

Author: greiol
Date: 2009-06-12 16:47:33 +0200 (Fri, 12 Jun 2009)
New Revision: 1895

Modified:
   trunk/src/exp/Exporter.java
   trunk/src/exp/HTMLExporter.java
Log:
skip incomplete caches and give info if done so

Modified: trunk/src/exp/Exporter.java
===================================================================
--- trunk/src/exp/Exporter.java	2009-06-12 14:16:07 UTC (rev 1894)
+++ trunk/src/exp/Exporter.java	2009-06-12 14:47:33 UTC (rev 1895)
@@ -10,6 +10,7 @@
 import ewe.io.PrintWriter;
 import ewe.ui.FormBase;
 import ewe.ui.ProgressBarForm;
+import ewe.ui.*;
 import ewe.util.*;
 import ewe.io.IOException;
 
@@ -93,12 +94,18 @@
 		int expCount = 0;
 
 		try{
+			int incompleteWaypoints = 0;
 			PrintWriter outp =  new PrintWriter(new BufferedWriter(new FileWriter(outFile)));
 			str = this.header();
 			if (str != null) outp.print(str);
 			for(int i = 0; i<cacheDB.size(); i++){
 				ch=cacheDB.get(i);
 				if(ch.isVisible()){
+					if (ch.is_incomplete()) {
+						Global.getPref().log("skipping export of incomplete waypoint "+ch.getWayPoint());
+						incompleteWaypoints++;
+						continue;
+					}
 					expCount++;
 					h.progress = (float)expCount/(float)counter;
 					h.changed();
@@ -138,6 +145,9 @@
 			if (str != null) outp.print(str);
 			outp.close();
 			pbf.exit(0);
+			if (incompleteWaypoints > 0) {
+				new MessageBox("Export Error", incompleteWaypoints+" incomplete waypoints have not been exported. See log for details.", FormBase.OKB).execute();
+			}
 		} catch (IOException ioE){
 			Vm.debug("Error opening " + outFile.getName());
 		}

Modified: trunk/src/exp/HTMLExporter.java
===================================================================
--- trunk/src/exp/HTMLExporter.java	2009-06-12 14:16:07 UTC (rev 1894)
+++ trunk/src/exp/HTMLExporter.java	2009-06-12 14:47:33 UTC (rev 1895)
@@ -59,6 +59,7 @@
 			Vector usrImg = new Vector();
 			Vector logIcons = new Vector(15);
 			String icon;
+			int incompleteWaypoint = 0;
 
 			Hashtable varParams;
 			Hashtable imgParams;
@@ -79,6 +80,11 @@
 
 				ch = cacheDB.get(i);
 				if(	ch.isVisible()){
+					if (ch.is_incomplete()) {
+						incompleteWaypoint++;
+						Global.getPref().log("skipping export of incomplete waypoint "+ch.getWayPoint());
+						continue;
+					}
 					det=ch.getExistingDetails();
 					varParams = new Hashtable();
 					varParams.put("TYPE", CacheType.cw2ExportString(ch.getType()));
@@ -223,6 +229,9 @@
 					}catch(Exception e){
 						Vm.debug("Problem writing waypoint html file"+e);
 					}
+					if (incompleteWaypoint > 0) {
+						new MessageBox("Export Error", incompleteWaypoint+" incomplete waypoints have not been exported. See log for details.", FormBase.OKB).execute();
+					}
 				}//if is black, filtered
 			}
 			// Copy the log-icons to the destination directory



From greiol at mail.berlios.de  Fri Jun 12 20:36:17 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 12 Jun 2009 20:36:17 +0200
Subject: [Cachewolf-svn] r1896 - trunk/src/exp
Message-ID: <200906121836.n5CIaHiq027144@sheep.berlios.de>

Author: greiol
Date: 2009-06-12 20:36:16 +0200 (Fri, 12 Jun 2009)
New Revision: 1896

Modified:
   trunk/src/exp/GPXExporter.java
Log:
if there is an error also show the waypoint

Modified: trunk/src/exp/GPXExporter.java
===================================================================
--- trunk/src/exp/GPXExporter.java	2009-06-12 14:47:33 UTC (rev 1895)
+++ trunk/src/exp/GPXExporter.java	2009-06-12 18:36:16 UTC (rev 1896)
@@ -149,6 +149,7 @@
 			}
 			strBuf.append("  </wpt>\r\n");
 		}catch(Exception e){
+			Vm.debug(ch.getWayPoint());
 			e.printStackTrace();
 			return null;
 		}//try



From greiol at mail.berlios.de  Fri Jun 12 23:48:12 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 12 Jun 2009 23:48:12 +0200
Subject: [Cachewolf-svn] r1897 - in trunk: resources src/CacheWolf
Message-ID: <200906122148.n5CLmCOR016753@sheep.berlios.de>

Author: greiol
Date: 2009-06-12 23:48:10 +0200 (Fri, 12 Jun 2009)
New Revision: 1897

Added:
   trunk/resources/typeReference.png
Removed:
   trunk/resources/waypoint.png
Modified:
   trunk/src/CacheWolf/CacheType.java
Log:
camelcase will be my death - some day

Copied: trunk/resources/typeReference.png (from rev 1893, trunk/resources/waypoint.png)


Property changes on: trunk/resources/typeReference.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Deleted: trunk/resources/waypoint.png
===================================================================
(Binary files differ)

Modified: trunk/src/CacheWolf/CacheType.java
===================================================================
--- trunk/src/CacheWolf/CacheType.java	2009-06-12 18:36:16 UTC (rev 1896)
+++ trunk/src/CacheWolf/CacheType.java	2009-06-12 21:48:10 UTC (rev 1897)
@@ -101,9 +101,9 @@
 	/** image for Additional Waypoint Trailhead (GC) */
 	public static final String CW_GUIIMG_TRAILHEAD = "typeTrailhead.png";
 	/** image for Additional Waypoint Reference Point (GC) */
-	public static final String CW_GUIIMG_REFERENCE = "waypoint.png";
+	public static final String CW_GUIIMG_REFERENCE = "typeReference.png";
 	/** image for Mega Event Cache (GC) */
-	public static final String CW_GUIIMG_MEGA_EVENT = "typemegaevent.png";
+	public static final String CW_GUIIMG_MEGA_EVENT = "typeMegaevent.png";
 	/** image for WhereIGo Cache (GC) */
 	public static final String CW_GUIIMG_WHEREIGO = "typeWhereigo.png";
 	/** image for Project Ape cache (GC)*/



From araber95 at mail.berlios.de  Sat Jun 13 12:25:20 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Sat, 13 Jun 2009 12:25:20 +0200
Subject: [Cachewolf-svn] r1898 - trunk/res_noewe/webmapservices
Message-ID: <200906131025.n5DAPKNu020776@sheep.berlios.de>

Author: araber95
Date: 2009-06-13 12:25:19 +0200 (Sat, 13 Jun 2009)
New Revision: 1898

Modified:
   trunk/res_noewe/webmapservices/de-ni_p.wms
   trunk/res_noewe/webmapservices/de-ni_t25.wms
Log:
Niedersachsen : wms server adress changed

Modified: trunk/res_noewe/webmapservices/de-ni_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-ni_p.wms	2009-06-12 21:48:10 UTC (rev 1897)
+++ trunk/res_noewe/webmapservices/de-ni_p.wms	2009-06-13 10:25:19 UTC (rev 1898)
@@ -1,8 +1,9 @@
 TakenFromUrl:       http://www.umwelt.niedersachsen.de/master/C7089178_N7088657_L20_D0_I598.html
-GetCapabilitiesUrl: http://www.umweltkarten.niedersachsen.de/arcgis/services/GR_Gebiete/MapServer/WMSServer?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+GetCapabilitiesUrl: http://www.umweltkarten.niedersachsen.de/arcgis/services/Programme/MapServer/WMSServer?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
 Name:               de.Niedersachsen photo c SF=0..1,95
 MapType:                        photo
-MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/GR_Gebiete/MapServer/WMSServer?
+#MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/GR_Gebiete/MapServer/WMSServer?
+MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/Programme/MapServer/WMSServer?
 ServiceTypeUrlPart: SERVICE=WMS
 VersionUrlPart:     VERSION=1.1.1
 CoordinateReferenceSystemCacheWolf:  31467

Modified: trunk/res_noewe/webmapservices/de-ni_t25.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-ni_t25.wms	2009-06-12 21:48:10 UTC (rev 1897)
+++ trunk/res_noewe/webmapservices/de-ni_t25.wms	2009-06-13 10:25:19 UTC (rev 1898)
@@ -1,8 +1,9 @@
 TakenFromUrl:       http://www.umwelt.niedersachsen.de/master/C7089178_N7088657_L20_D0_I598.html
-GetCapabilitiesUrl: http://www.umweltkarten.niedersachsen.de/arcgis/services/GR_Gebiete/MapServer/WMSServer?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+GetCapabilitiesUrl: http://www.umweltkarten.niedersachsen.de/arcgis/services/Programme/MapServer/WMSServer?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
 Name:               de.Niedersachsen t25 b/w ?c SF=1,95..3,5
 MapType:                        topo
-MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/GR_Gebiete/MapServer/WMSServer?
+#MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/GR_Gebiete/MapServer/WMSServer?
+MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/Programme/MapServer/WMSServer?
 ServiceTypeUrlPart: SERVICE=WMS
 VersionUrlPart:     VERSION=1.1.1
 CoordinateReferenceSystemCacheWolf:  31467



From pfeffer at mail.berlios.de  Sat Jun 13 13:59:51 2009
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Sat, 13 Jun 2009 13:59:51 +0200
Subject: [Cachewolf-svn] r1899 - trunk
Message-ID: <200906131159.n5DBxpsQ006378@sheep.berlios.de>

Author: pfeffer
Date: 2009-06-13 13:59:50 +0200 (Sat, 13 Jun 2009)
New Revision: 1899

Modified:
   trunk/getRes.bat
Log:
make getRes.bat directly callable by double clicking [using "default editor" from eclipse

Modified: trunk/getRes.bat
===================================================================
--- trunk/getRes.bat	2009-06-13 10:25:19 UTC (rev 1898)
+++ trunk/getRes.bat	2009-06-13 11:59:50 UTC (rev 1899)
@@ -1,4 +1,5 @@
 REM clean up
+cd %~d0%~p0
 del .\work\*.png
 del .\work\*.gif
 del .\work\*.html



From greiol at mail.berlios.de  Sat Jun 13 17:15:03 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Sat, 13 Jun 2009 17:15:03 +0200
Subject: [Cachewolf-svn] r1900 - trunk/src/exp
Message-ID: <200906131515.n5DFF3AE031298@sheep.berlios.de>

Author: greiol
Date: 2009-06-13 17:15:01 +0200 (Sat, 13 Jun 2009)
New Revision: 1900

Modified:
   trunk/src/exp/GpxExportNg.java
Log:
added basic support for addis in main description

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-13 11:59:50 UTC (rev 1899)
+++ trunk/src/exp/GpxExportNg.java	2009-06-13 15:15:01 UTC (rev 1900)
@@ -19,6 +19,7 @@
 import ewe.sys.Vm;
 import ewe.ui.FormBase;
 import ewe.util.Hashtable;
+import ewe.util.Iterator;
 
 //TODO: use safexml a lot more (at least start using it ;) )
 
@@ -89,12 +90,19 @@
 						.concat("\t\t\t\t\t<groundspeak:name>@@TBNAME@@</groundspeak:name>\n")
 						.concat("\t\t\t\t</groundspeak:travelbug>\n");
 	
+	//FIXME: don't use this until GPX import can strip this off as well
+	final static String GPXADDIINMAIN = "@@ADDIID@@ - @@ADDISHORT@@@@ADDIDELIM@@"
+						.concat("@@ADDILAT@@ @@ADDILON@@@@ADDIDELIM@@")
+						.concat("@@ADDILONG@@@@ADDIDELIM@@");
+	
 	static boolean smartIds;
 	static boolean customIcons;
-	static boolean separateFile;
+	static boolean separateFiles;
 	static boolean sendToGarmin;
 	static int outType;
 	
+	
+	
 	public GpxExportNg() {
 		GpxExportNgForm exportOptions;
 		int ret;
@@ -108,11 +116,11 @@
 		
 		outType = exportOptions.getExportType();
 		smartIds = exportOptions.getSmartIds();
-		separateFile = exportOptions.getSeparateFiles();
+		separateFiles = exportOptions.getSeparateFiles();
 		sendToGarmin = exportOptions.getSendToGarmin();
 		customIcons = exportOptions.getCustomIcons();
 		
-		if (separateFile) {
+		if (separateFiles) {
 			final Hashtable fileHandles;
 			final String directoryName;
 			//TODO: get directory
@@ -130,32 +138,24 @@
 			file = fc.getChosenFile();
 			Global.getPref().setExportPath(expName, file.getPath());
 
-			StringBuffer out = new StringBuffer();
-			
-			out.append(formatHeader());
-			
-			for(int i = 0; i<Global.getProfile().cacheDB.size(); i++){
-				CacheHolder ch=Global.getProfile().cacheDB.get(i);
-				if (ch.is_incomplete()) {
-					Vm.debug("skipping incomplete waypoint "+ch.getWayPoint());
-					continue;
-				}
-				out.append(formatCache(ch));
-			}
-			
-			out.append("</gpx>\n");
-			
 			try {
 				PrintWriter outp =  new PrintWriter(new BufferedWriter(new FileWriter(file)));
-				outp.print(out.toString());
+				outp.print(formatHeader());
+				for(int i = 0; i<Global.getProfile().cacheDB.size(); i++){
+					CacheHolder ch=Global.getProfile().cacheDB.get(i);
+					if (ch.is_incomplete()) {
+						Vm.debug("skipping incomplete waypoint "+ch.getWayPoint());
+						continue;
+					}
+					outp.print(formatCache(ch));
+				}
+				outp.print("</gpx>\n");
 				outp.close();
 			} catch (Exception ex) {
 				if (Global.getPref().debug) Global.getPref().log("unable to write GPX output to "+file.toString(), ex);
 				else Global.getPref().log("unable to write GPX output to "+file.toString());
 				//TODO: give a message to the user
 			}
-			//TODO: write file. do it when we have a complete waypoint to save memory?
-			Vm.debug(out.toString());
 		}
 	}
 	
@@ -291,12 +291,7 @@
 		trans.add(new Regex("@@CACHESTATE@@",ch.details.State));
 		trans.add(new Regex("@@CACHEHTML@@",ch.is_HTML()?TRUE:FALSE));
 		trans.add(new Regex("@@CACHESHORTDESCRIPTION@@","CacheWolf can not provide Short description"));
-		/* 
-		 * TODO: add additional waypoints to long description, but then GPX importer must 
-		 * remove them as well. otherwise people using PQs to feed CacheWolf will have 
-		 * duplicate additionals at end of PQ like export 
-		 */
-		trans.add(new Regex("@@CACHELONGDESCRIPTION@@",ch.details.LongDescription));
+		trans.add(new Regex("@@CACHELONGDESCRIPTION@@",formatLongDescription(ch)));
 		trans.add(new Regex("@@CACHEHINT@@",ch.details.Hints));
 		
 		ret.append(trans.replaceAll(GPXEXTENSION));
@@ -334,4 +329,39 @@
 		trans.add(new Regex("@@CREATEDATE@@",new Date().setFormat("yyyy-MM-dd").toString()));
 		return trans.replaceFirst(GPXHEADER);
 	}
+	
+	public String formatLongDescription(CacheHolder ch) {
+		if (ch.isAddiWpt() || ch.getType() == CacheType.CW_TYPE_CUSTOM) {
+			return ch.details.LongDescription;
+		} else {
+			Vm.debug("real cache");
+			StringBuffer ret = new StringBuffer();
+			String delim = "";
+			ret.append(ch.details.LongDescription);
+			if (ch.is_HTML()) {
+				delim="<br />";
+			}
+			//FIXME: format is not quite right yet
+			//FIXME: cut Addis off in GPXimporter otherwiese people who use GPX to feed CacheWolf have them doubled
+			if (ch.addiWpts.size() > 0) {
+				Vm.debug("adding waypoints");
+				ret.append(delim).append("\n").append("Additional Waypoints").append(delim).append("\n");
+				Iterator iter = ch.addiWpts.iterator();
+				while (iter.hasNext()) {
+					CacheHolder addi = (CacheHolder) iter.next();
+					Transformer trans = new Transformer(true);
+					trans.add(new Regex("@@ADDIID@@",addi.getWayPoint()));
+					trans.add(new Regex("@@ADDISHORT@@",addi.getCacheName()));
+					trans.add(new Regex("@@ADDIDELIM@@",delim));
+					trans.add(new Regex("@@ADDILAT@@",addi.LatLon));
+					trans.add(new Regex("@@ADDILON@@",""));
+					trans.add(new Regex("@@ADDILONG@@",addi.getFreshDetails().LongDescription));
+					ret.append(trans.replaceAll(GPXADDIINMAIN));
+				}
+				ret.append(delim).append("\n");
+
+			}
+			return ret.toString();
+		}
+	}
 }



From araber95 at mail.berlios.de  Sun Jun 14 13:51:38 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Sun, 14 Jun 2009 13:51:38 +0200
Subject: [Cachewolf-svn] r1901 - in trunk/src/CacheWolf: . navi
Message-ID: <200906141151.n5EBpc4n027051@sheep.berlios.de>

Author: araber95
Date: 2009-06-14 13:51:35 +0200 (Sun, 14 Jun 2009)
New Revision: 1901

Modified:
   trunk/src/CacheWolf/CalcPanel.java
   trunk/src/CacheWolf/DetailsPanel.java
   trunk/src/CacheWolf/MainTab.java
   trunk/src/CacheWolf/myTableControl.java
   trunk/src/CacheWolf/navi/GotoPanel.java
Log:
modifying function setDestionationAndSwitch to goto Cache position or Point (removed gotoPoint in MainTab.java, instead use setDestionationAndSwitch of GotoPanel.java)

Modified: trunk/src/CacheWolf/CalcPanel.java
===================================================================
--- trunk/src/CacheWolf/CalcPanel.java	2009-06-13 15:15:01 UTC (rev 1900)
+++ trunk/src/CacheWolf/CalcPanel.java	2009-06-14 11:51:35 UTC (rev 1901)
@@ -207,7 +207,7 @@
 			if (ev.target == btnGoto){
 				readFields(coordInp, bd, currFormat);
 				coordOut = coordInp.project(bd.degrees, bd.distance);
-				mainT.gotoPoint(coordOut);
+				mainT.gotoP.setDestinationAndSwitch(coordOut); 
 			}
 			if (ev.target == btnChangeLatLon){
 				CoordsScreen cs = new CoordsScreen();

Modified: trunk/src/CacheWolf/DetailsPanel.java
===================================================================
--- trunk/src/CacheWolf/DetailsPanel.java	2009-06-13 15:15:01 UTC (rev 1900)
+++ trunk/src/CacheWolf/DetailsPanel.java	2009-06-14 11:51:35 UTC (rev 1901)
@@ -412,7 +412,7 @@
 				Global.mainTab.newWaypoint(ch);
 			} else if (ev.target == btnGoto) {
 				// TODO if something changed saveWpt();
-				Global.mainTab.gotoPoint(thisCache.pos);
+				Global.mainTab.gotoP.setDestinationAndSwitch(thisCache); 
 			} else if (ev.target == btnWayLoc) {
 				CWPoint coords = new CWPoint(btnWayLoc.getText(), CWPoint.CW);
 				CoordsScreen cs = new CoordsScreen(true);

Modified: trunk/src/CacheWolf/MainTab.java
===================================================================
--- trunk/src/CacheWolf/MainTab.java	2009-06-13 15:15:01 UTC (rev 1900)
+++ trunk/src/CacheWolf/MainTab.java	2009-06-14 11:51:35 UTC (rev 1901)
@@ -257,10 +257,6 @@
 		tbP.tc.repaint();
 	}
 
-	public void gotoPoint(CWPoint where) { 
-		gotoP.setDestinationAndSwitch(where); 
-	}
-
 	public void openDescriptionPanel(CacheHolder chi) {
 		MyLocale.setSIPOff();
 		// To change cache we need to be in panel 0

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2009-06-13 15:15:01 UTC (rev 1900)
+++ trunk/src/CacheWolf/myTableControl.java	2009-06-14 11:51:35 UTC (rev 1901)
@@ -112,7 +112,7 @@
 				else if (ev.key == IKeys.RIGHT) {
 					CacheHolder ch;
 					ch = cacheDB.get(tbp.getSelectedCache());
-					Global.mainTab.gotoPoint(ch.pos);
+					Global.mainTab.gotoP.setDestinationAndSwitch(ch); 
 				}
 				else if (ev.key == 6 ) MainMenu.search(); // (char)6 == ctrl + f 
 				else super.onKeyEvent(ev);
@@ -246,7 +246,7 @@
 
 		if (selectedItem == miGoto){
 			ch = cacheDB.get(tbp.getSelectedCache());
-			Global.mainTab.gotoPoint(ch.pos);
+			Global.mainTab.gotoP.setDestinationAndSwitch(ch); 
 		} else
 		    
 		if (selectedItem == miOpenOnline){

Modified: trunk/src/CacheWolf/navi/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/navi/GotoPanel.java	2009-06-13 15:15:01 UTC (rev 1900)
+++ trunk/src/CacheWolf/navi/GotoPanel.java	2009-06-14 11:51:35 UTC (rev 1901)
@@ -221,6 +221,10 @@
 		myNavigation.setDestination(where);
 		mainT.select(this);
 	}
+	public void setDestinationAndSwitch(CacheHolder ch) {
+		myNavigation.setDestination(ch);
+		mainT.select(this);
+	}
 	
 	/**
 	 * updates distance and bearing



From araber95 at mail.berlios.de  Sun Jun 14 13:56:32 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Sun, 14 Jun 2009 13:56:32 +0200
Subject: [Cachewolf-svn] r1902 - in trunk/src/CacheWolf: . navi
Message-ID: <200906141156.n5EBuWWO027368@sheep.berlios.de>

Author: araber95
Date: 2009-06-14 13:56:29 +0200 (Sun, 14 Jun 2009)
New Revision: 1902

Modified:
   trunk/src/CacheWolf/Parser.java
   trunk/src/CacheWolf/navi/MapSymbol.java
   trunk/src/CacheWolf/navi/MovingMap.java
   trunk/src/CacheWolf/navi/Navigate.java
Log:
get full context menu on a selected target Cache , mainly to directly open Cachedescription of destionation from map

Modified: trunk/src/CacheWolf/Parser.java
===================================================================
--- trunk/src/CacheWolf/Parser.java	2009-06-14 11:51:35 UTC (rev 1901)
+++ trunk/src/CacheWolf/Parser.java	2009-06-14 11:56:29 UTC (rev 1902)
@@ -553,6 +553,7 @@
     		ch.LatLon=cwPt.toString(CWPoint.CW);
     		ch.pos.set(cwPt);
     		ch.calcDistance(Global.getPref().curCentrePt); // Update distance/bearing
+    		nav.setDestination(ch);
     	    Global.getProfile().selectionChanged=true; // Tell moving map to updated displayed waypoints
     	}
     }

Modified: trunk/src/CacheWolf/navi/MapSymbol.java
===================================================================
--- trunk/src/CacheWolf/navi/MapSymbol.java	2009-06-14 11:51:35 UTC (rev 1901)
+++ trunk/src/CacheWolf/navi/MapSymbol.java	2009-06-14 11:56:29 UTC (rev 1902)
@@ -14,6 +14,12 @@
 		filename = filenamei;
 		where = where_;
 	}
+	public MapSymbol(String namei, Object mapObjecti, String filenamei, CWPoint where_) {
+		name = namei;
+		filename = filenamei;
+		where = where_;
+		mapObject = mapObjecti;
+	}
 	public MapSymbol(String namei, Object mapObjecti, Image fromIm, CWPoint where_) {
 		name = namei;
 		where = where_;

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2009-06-14 11:51:35 UTC (rev 1901)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2009-06-14 11:56:29 UTC (rev 1902)
@@ -388,7 +388,13 @@
 		addTrack(myNavigation.curTrack);
 		if (tracks != null && tracks.size() > 0 && ((Track)tracks.get(0)).num > 0) 
 			rebuildOverlaySet(); // show points which where added when MavingMap was not running
-		destChanged(myNavigation.destination);
+		if (myNavigation.destinationIsCache) {
+			destChanged(myNavigation.destinationCache);
+		}
+		else {
+			destChanged(myNavigation.destination);
+		}
+		
 		FormFrame ret = exec();
 		return ret;
 	}
@@ -804,6 +810,18 @@
 		mmp.addImage(ms);
 		return ms;
 	}
+
+	public MapSymbol addSymbol(String pName, Object mapObject, String filename, CWPoint where) {
+		if (symbols==null) symbols=new Vector();
+		MapSymbol ms = new MapSymbol(pName, mapObject, filename, where);
+		ms.loadImage();
+		ms.properties |= mImage.AlwaysOnTop;
+		Point pOnScreen = getXYonScreen(where);
+		ms.setLocation(pOnScreen.x-ms.getWidth()/2, pOnScreen.y-ms.getHeight()/2);
+		symbols.add(ms);
+		mmp.addImage(ms);
+		return ms;
+	}
 	
 	public void addSymbolIfNecessary(String pName, Object mapObject, Image imSymb, CWPoint where) {
 		if (findMapSymbol(pName) >= 0) return;
@@ -832,6 +850,18 @@
 		if (this.width != 0) updatePosition(posCircle.where); // dirty hack: if this.width == 0, then the symbols are not on the screen and get hidden by updateSymbolPositions
 	}
 
+	public void destChanged(CacheHolder ch) {
+		CWPoint d = new CWPoint (ch.pos);
+		if(!running || (d == null && gotoPos == null) || 
+				(d != null && gotoPos != null && gotoPos.where.equals(d))) return;
+		removeGotoPosition();
+		if (d == null || !d.isValid() ) return;
+		gotoPos = addSymbol("goto", ch, "goto_map.png", d);
+		//updateDistance(); - this is called from updatePosition
+		forceMapLoad = true;
+		if (this.width != 0) updatePosition(posCircle.where); // dirty hack: if this.width == 0, then the symbols are not on the screen and get hidden by updateSymbolPositions
+	}
+
 	public void removeGotoPosition() {
 		removeMapSymbol("goto");
 	}
@@ -1878,7 +1908,7 @@
 					}
 					if (action == gotoCacheMenuItem) {
 						kontextMenu.close();
-						mm.myNavigation.setDestination(clickedCache.pos);	
+						mm.myNavigation.setDestination(clickedCache);	
 					}
 					if (action == newWayPointMenuItem) {
 						kontextMenu.close();

Modified: trunk/src/CacheWolf/navi/Navigate.java
===================================================================
--- trunk/src/CacheWolf/navi/Navigate.java	2009-06-14 11:51:35 UTC (rev 1901)
+++ trunk/src/CacheWolf/navi/Navigate.java	2009-06-14 11:56:29 UTC (rev 1902)
@@ -13,7 +13,9 @@
 import ewe.ui.FormBase;
 import ewe.ui.MessageBox;
 import ewe.util.mString;
+import CacheWolf.CacheHolder;
 
+
 /**
  * Non-Gui Class to handle all things regarding navigation
  * (GPS, Sun direction etc.)
@@ -23,6 +25,8 @@
  */
 public class Navigate {
 	public CWPoint destination = new CWPoint();
+	public CacheHolder destinationCache;
+	public boolean destinationIsCache = false;
 	public CWGPSPoint gpsPos = new CWGPSPoint();
 	public Track curTrack = null;
 	Color trackColor = new Color(255,0,0); // red
@@ -116,10 +120,20 @@
 
 
 	public void setDestination(CWPoint d) {
+		destinationIsCache = false;
 		destination = new CWPoint (d);
 		if (gotoPanel != null) gotoPanel.destChanged(destination);
 		if (movingMap != null) movingMap.destChanged(destination);
 	}
+	
+	public void setDestination(CacheHolder ch) {
+		destinationIsCache = true;
+		destinationCache=ch;
+		destination = new CWPoint (ch.pos);
+		if (gotoPanel != null) gotoPanel.destChanged(destination);
+		if (movingMap != null) movingMap.destChanged(ch);
+	}
+
 	/**
 	 * use the constants SkyOrientation.SUN, SkyOrientation.MOON etc.
 	 * @param lu



From araber95 at mail.berlios.de  Sun Jun 14 14:50:47 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Sun, 14 Jun 2009 14:50:47 +0200
Subject: [Cachewolf-svn] r1903 - trunk/res_noewe/webmapservices
Message-ID: <200906141250.n5EColwG032102@sheep.berlios.de>

Author: araber95
Date: 2009-06-14 14:50:46 +0200 (Sun, 14 Jun 2009)
New Revision: 1903

Modified:
   trunk/res_noewe/webmapservices/de-ni_t25.wms
Log:
wms - file NI TK25 : environmental layers removed

Modified: trunk/res_noewe/webmapservices/de-ni_t25.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-ni_t25.wms	2009-06-14 11:56:29 UTC (rev 1902)
+++ trunk/res_noewe/webmapservices/de-ni_t25.wms	2009-06-14 12:50:46 UTC (rev 1903)
@@ -29,9 +29,9 @@
 #LayersUrlPart:     LAYERS=17|Autobahnen||
 #LayersUrlPart:     LAYERS=18|Schrift: Gro?e Orte||
 #LayersUrlPart:     LAYERS=19|Schrift: Kleine Orte||
-LayersUrlPart:     LAYERS=13,1,3,4,5,6,17,18,19
+#LayersUrlPart:     LAYERS=13,1,3,4,5,6,17,18,19
 #LayersUrlPart:     LAYERS=13
-#LayersUrlPart:     LAYERS=13,17,18,19
+LayersUrlPart:     LAYERS=13,17,18,19
 StylesUrlPart:     STYLES=
 ImageFormatUrlPart:FORMAT=image/png
 BoundingBoxTopLeftWGS84: N 54.001848 E 6.579380



From araber95 at mail.berlios.de  Sun Jun 14 15:22:46 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Sun, 14 Jun 2009 15:22:46 +0200
Subject: [Cachewolf-svn] r1904 - trunk/docs
Message-ID: <200906141322.n5EDMkt4001215@sheep.berlios.de>

Author: araber95
Date: 2009-06-14 15:22:44 +0200 (Sun, 14 Jun 2009)
New Revision: 1904

Added:
   trunk/docs/eigene Cachesymbole.txt
Log:
description for using own Cachesymbols.

Added: trunk/docs/eigene Cachesymbole.txt
===================================================================
--- trunk/docs/eigene Cachesymbole.txt	2009-06-14 12:50:46 UTC (rev 1903)
+++ trunk/docs/eigene Cachesymbole.txt	2009-06-14 13:22:44 UTC (rev 1904)
@@ -0,0 +1,42 @@
+Seit Rev 1893 (und somit auch mit dem aktuelle Nightly Build) kann man in Cachewolf eigene Symbole f?r Caches, Wegpunkte usw. verwenden. 
+Das funktioniert wie folgt:
+1. Im Cachewolf-Programmverzeichnis ein Unterverzeichnis "symbols" anlegen (Achtung, Gro?-/Kleinschreibung beachten!!!).
+2. In diesem Verzeichnis 15x15 PNG-Dateien f?r die Symbole speichern. 
+Die Benennung der Dateien folgt dabei einem bestimmten Schema (s.u.). 
+Man kann alle Symbole ersetzen oder aber auch nur bestimmte, ganz wie man m?chte.
+3. Cachwolf starten und sich an den neuen Symbolen erfreuen.
+4. Sollten einem die buildt-in-Symbole dann doch besser gefallen, das "symbols"-Verzeichnis einfach wieder l?schen und fertig.
+
+Wer es mal schnell ausprobieren m?chte, ohne sich gleich eigene Bilder zu basteln, sollte mal hier schauen:
+http://www.geoclub.de/viewtopic.php?p=341097#p341097
+Da hat blackeye501 vor einiger Zeit schon mal alternative Symbole ver?ffentlicht, die man nun benutzen kann.
+Aber Vorsicht: Nicht die Dateinamen von blackeye501 ?bernehmen, die m?ssen gem?? der untenstehenden Liste angepasst werden!
+
+Feedback, Fragen, Probleme dazu gerne in diesem Thread:
+http://www.geoclub.de/viewtopic.php?f=40&t=35056
+Und wer einen sch?nen Satz Symbole kreiert hat und sie teilen m?chte, kann das auch gerne hier machen. 
+
+So jetzt aber noch das wichtigsten, die Namenskonventionen f?r die verschiedenen Cachetypen:
+
+0.png - Custom
+1.png - APE ("Project APE Cache")
+2.png - CITO
+3.png - Drive_In
+4.png - Earthcache
+5.png - Event
+6.png - Final
+7.png - Letterbox
+8.png - Locationless
+9.png - Maze ("Adventure Maze Exhibit")
+10.png - Megaevent
+11.png - Multi
+12.png - Parking
+13.png - Question
+14.png - Reference
+15.png - Stage
+16.png - Traditional
+17.png - Trailhead
+18.png - Unknown
+19.png - Virtual
+20.png - Webcam
+21.png - Wherigo



From araber95 at mail.berlios.de  Sun Jun 14 16:46:24 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Sun, 14 Jun 2009 16:46:24 +0200
Subject: [Cachewolf-svn] r1905 - trunk/res_noewe/webmapservices
Message-ID: <200906141446.n5EEkOCO012819@sheep.berlios.de>

Author: araber95
Date: 2009-06-14 16:46:21 +0200 (Sun, 14 Jun 2009)
New Revision: 1905

Added:
   trunk/res_noewe/webmapservices/de-ni_t100_lv.wms
Log:
official free to use map of LV (LGN) Niedersachsen

Added: trunk/res_noewe/webmapservices/de-ni_t100_lv.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-ni_t100_lv.wms	2009-06-14 13:22:44 UTC (rev 1904)
+++ trunk/res_noewe/webmapservices/de-ni_t100_lv.wms	2009-06-14 14:46:21 UTC (rev 1905)
@@ -0,0 +1,37 @@
+TakenFromUrl:       http://www.geobasisdaten.niedersachsen.de/bestand?
+GetCapabilitiesUrl: http://www.geobasisdaten.niedersachsen.de/bestand?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Niedersachsen t100 c SF=~0,7 .. 400 LV NI
+MapType:                        topo
+MainUrl:            http://www.geobasisdaten.niedersachsen.de/bestand?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+#CoordinateReferenceSystemCacheWolf:  31466 31467 31468 31469 4326
+#CoordinateReferenceSystemUrlPart: SRS=EPSG:31466 SRS=EPSG:31467 SRS=EPSG:31468 SRS=EPSG:31469 SRS=EPSG:4326 
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=geodatenbasisbestand|Bestands?bersicht||
+#LayersUrlPart:     LAYERS=navigation_f|Navigation, farbig||
+#LayersUrlPart:     LAYERS=ueb5000_nf|?bersichtskarte 1:5.000.000|407.859199979508|9899.49490168847
+#LayersUrlPart:     LAYERS=ueb1000_nf|?bersichtskarte 1:1.000.000|126.713500006|407.859199979508
+#LayersUrlPart:     LAYERS=ukn500_nf|?bersichtskarte 1:500.000|44.901280999479|126.713500006
+#LayersUrlPart:     LAYERS=dtk100_v_nf|Topographische Karte 1:100.000|0.498902848429637|44.901280999479
+#LayersUrlPart:     LAYERS=dtk100_v_b|Topographische Karte 1:100.000||
+#LayersUrlPart:     LAYERS=dtk50_v_b|Topographische Karte 1:50.000||
+#LayersUrlPart:     LAYERS=dtk50_b|Digitale Topographische Karte 1:50.000||
+#LayersUrlPart:     LAYERS=dtk25_b|Digitale Topographische Karte 1:25.000||
+#LayersUrlPart:     LAYERS=pl25_b|Preu?ische Landesaufnahme 1:25.000||
+#LayersUrlPart:     LAYERS=dsk10_b|Digitale Stra?enkarte 1:10.000||
+#LayersUrlPart:     LAYERS=ak5_b|Amtliche Karte 1:5.000||
+#LayersUrlPart:     LAYERS=dop40_b|Digitales Orthophoto||
+LayersUrlPart:     LAYERS=navigation_f
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 54.5549 E 5.8986
+BoundingBoxButtomRightWGS84: N 50.6539 E 12.6239
+#BBox_Mitte: N 52.6044 E 9.261245
+MinScale:   0.7
+MaxScale:   14000
+RecommendedScale:   5
+ImageFileExtension: .png
+#SF von 0.4989 bis 9899.4949 * sqrt(2)



From araber95 at mail.berlios.de  Mon Jun 15 11:04:17 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Mon, 15 Jun 2009 11:04:17 +0200
Subject: [Cachewolf-svn] r1906 - trunk/res_noewe/webmapservices
Message-ID: <200906150904.n5F94Ho3001473@sheep.berlios.de>

Author: araber95
Date: 2009-06-15 11:04:15 +0200 (Mon, 15 Jun 2009)
New Revision: 1906

Modified:
   trunk/res_noewe/webmapservices/de-ni_t100_lv.wms
Log:
wms for NI (LGN) changed output from png to jpg (smaller files)

Modified: trunk/res_noewe/webmapservices/de-ni_t100_lv.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-ni_t100_lv.wms	2009-06-14 14:46:21 UTC (rev 1905)
+++ trunk/res_noewe/webmapservices/de-ni_t100_lv.wms	2009-06-15 09:04:15 UTC (rev 1906)
@@ -26,12 +26,12 @@
 #LayersUrlPart:     LAYERS=dop40_b|Digitales Orthophoto||
 LayersUrlPart:     LAYERS=navigation_f
 StylesUrlPart:     STYLES=
-ImageFormatUrlPart:FORMAT=image/png
+ImageFormatUrlPart:FORMAT=image/jpeg
 BoundingBoxTopLeftWGS84: N 54.5549 E 5.8986
 BoundingBoxButtomRightWGS84: N 50.6539 E 12.6239
 #BBox_Mitte: N 52.6044 E 9.261245
 MinScale:   0.7
 MaxScale:   14000
 RecommendedScale:   5
-ImageFileExtension: .png
+ImageFileExtension: .jpg
 #SF von 0.4989 bis 9899.4949 * sqrt(2)



From araber95 at mail.berlios.de  Mon Jun 15 11:08:10 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Mon, 15 Jun 2009 11:08:10 +0200
Subject: [Cachewolf-svn] r1907 - trunk/src/CacheWolf/navi
Message-ID: <200906150908.n5F98AQF001954@sheep.berlios.de>

Author: araber95
Date: 2009-06-15 11:08:09 +0200 (Mon, 15 Jun 2009)
New Revision: 1907

Modified:
   trunk/src/CacheWolf/navi/MovingMap.java
Log:
Start map (without error - message, without marking a waypoint on map), even if marked waypoint has no coordinates. map takes center coordinates without gps.

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2009-06-15 09:04:15 UTC (rev 1906)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2009-06-15 09:08:09 UTC (rev 1907)
@@ -407,10 +407,12 @@
 			if (!markedCache.is_Checked) removeMapSymbol(markedCache);
 		}
 		if (ch != null) {
-			addSymbol("selectedCache", MARK_CACHE_IMAGE, ch.pos);
-			addSymbolIfNecessary(ch.getCacheName(), ch, GuiImageBroker.getTypeImage(ch.getType()), ch.pos);
+			if ( !ch.LatLon.equals("Nicht gesetzt")) {
+				addSymbol("selectedCache", MARK_CACHE_IMAGE, ch.pos);
+				addSymbolIfNecessary(ch.getCacheName(), ch, GuiImageBroker.getTypeImage(ch.getType()), ch.pos);
+				markedCache = ch;
+			}
 		}
-		markedCache = ch;
 	}
 	
 	public void addTrack(Track tr) {



From pfeffer at mail.berlios.de  Mon Jun 15 12:40:17 2009
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 15 Jun 2009 12:40:17 +0200
Subject: [Cachewolf-svn] r1908 - trunk/src/CacheWolf/navi
Message-ID: <200906151040.n5FAeHtI019687@sheep.berlios.de>

Author: pfeffer
Date: 2009-06-15 12:40:15 +0200 (Mon, 15 Jun 2009)
New Revision: 1908

Modified:
   trunk/src/CacheWolf/navi/MovingMap.java
Log:
MovingMap: small improvement (use boolean instead of String) to araber95 last commit

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2009-06-15 09:08:09 UTC (rev 1907)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2009-06-15 10:40:15 UTC (rev 1908)
@@ -407,7 +407,7 @@
 			if (!markedCache.is_Checked) removeMapSymbol(markedCache);
 		}
 		if (ch != null) {
-			if ( !ch.LatLon.equals("Nicht gesetzt")) {
+			if ( ch.pos.isValid()) {
 				addSymbol("selectedCache", MARK_CACHE_IMAGE, ch.pos);
 				addSymbolIfNecessary(ch.getCacheName(), ch, GuiImageBroker.getTypeImage(ch.getType()), ch.pos);
 				markedCache = ch;



From greiol at mail.berlios.de  Tue Jun 16 00:36:45 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 16 Jun 2009 00:36:45 +0200
Subject: [Cachewolf-svn] r1909 - in trunk/src: CacheWolf CacheWolf/imp utils
Message-ID: <200906152236.n5FMajLk012576@sheep.berlios.de>

Author: greiol
Date: 2009-06-16 00:36:41 +0200 (Tue, 16 Jun 2009)
New Revision: 1909

Added:
   trunk/src/CacheWolf/imp/Rating.java
Modified:
   trunk/src/CacheWolf/Preferences.java
   trunk/src/utils/CWWrapper.java
Log:
added preliminary support for external cache rating scripts

===>> bitte feedback <<===

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-15 10:40:15 UTC (rev 1908)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-15 22:36:41 UTC (rev 1909)
@@ -1,4 +1,5 @@
 package CacheWolf;
+
 import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.io.*;
@@ -219,7 +220,9 @@
 	public boolean downloadPics = true;
 	/** Download TB information when loading cache data */
 	public boolean downloadTBs = true;
-
+	/** external Cacherating software */
+	public String rater;
+	
 	//////////////////////////////////////////////
 	/** The debug switch (Can be used to activate dormant code) by adding
 	 * the line: <pre><debug value="true"></pre>
@@ -423,6 +426,9 @@
 		else if (name.equals("locale")) {
 			language = atts.getValue("language");
 		}
+		else if (name.equals("rater")) {
+			rater = atts.getValue("tool");
+		}
 		else if (name.equals("FILTERDATA")) {
 			// Creating a filter object and reading the saved data
 			String id = SafeXML.strxmldecode(atts.getValue("id"));
@@ -523,7 +529,7 @@
 				entry = (MapEntry) itPath.next();
 				outp.print("    <impPath key = \"" + SafeXML.strxmlencode(entry.getKey().toString()) + "\" value = \"" + SafeXML.strxmlencode(entry.getValue().toString().replace('\\', '/')) + "\"/>\n");
 			}
-
+			outp.print("    <rater tool=\"".concat(rater).concat("\"/>\n"));
 			outp.print("</preferences>");
 			outp.close();
 		} catch (Exception e) {

Added: trunk/src/CacheWolf/imp/Rating.java
===================================================================
--- trunk/src/CacheWolf/imp/Rating.java	2009-06-15 10:40:15 UTC (rev 1908)
+++ trunk/src/CacheWolf/imp/Rating.java	2009-06-15 22:36:41 UTC (rev 1909)
@@ -0,0 +1,58 @@
+package CacheWolf.imp;
+
+import CacheWolf.CacheType;
+import CacheWolf.Global;
+import CacheWolf.CacheHolder;
+import utils.CWWrapper;
+import ewe.sys.Handle;
+import ewe.ui.*;
+
+/*
+ * get rating for a cache from an external tool
+ */
+public class Rating {
+
+	String rater;
+
+	public Rating() {
+		rater = Global.getPref().rater;
+	}
+	
+	/**
+	 * call the tool defined by Global.getPref().rater with a visible waypoint as parameter
+	 * wait for tool to finish, catch exit code and write it to CacheHolder.numRecommended
+	 */
+	public void run() {
+		if (null == rater) return;
+		
+		ProgressBarForm pbf = new ProgressBarForm();
+		Handle h = new Handle();
+		
+		int totalWaypoints = Global.getProfile().cacheDB.countVisible();
+		int countWaypoints = 0;
+		
+		pbf.showMainTask = false;
+		pbf.setTask(h,"Rating ...");
+		pbf.exec();
+		
+		for(int i = 0; i<Global.getProfile().cacheDB.size(); i++){
+			CacheHolder ch=Global.getProfile().cacheDB.get(i);
+			if (ch.isVisible()) {
+				if (!ch.isAddiWpt() && ch.getType() != CacheType.CW_TYPE_CUSTOM) {
+					int rate;
+					try {
+						rate = CWWrapper.exec(rater, ch.getWayPoint(), true);
+						ch.setNumRecommended(rate);
+					} catch (Exception ex) {
+						ex.printStackTrace();
+					}
+				}
+				countWaypoints++;
+				h.progress = (float)countWaypoints/(float)totalWaypoints;
+				h.changed();
+			}
+		}
+		
+	}
+
+}

Modified: trunk/src/utils/CWWrapper.java
===================================================================
--- trunk/src/utils/CWWrapper.java	2009-06-15 10:40:15 UTC (rev 1908)
+++ trunk/src/utils/CWWrapper.java	2009-06-15 22:36:41 UTC (rev 1909)
@@ -20,21 +20,25 @@
 	 * @throws ewe.io.IOException
 	 */
 	public static void exec(String cmd, String arg) throws ewe.io.IOException{
+		exec(cmd, arg, false);
+	}
+	
+	public static int exec(String cmd, String arg, boolean wait) throws ewe.io.IOException {
 		if (Vm.getPlatform().equals("WinCE") ||
-		    Vm.getPlatform().equals("Win32")) {
-			/* we need extra quotes here, see vm/nmwin32_c.c */
-			if (arg.indexOf(" ") > -1)
-				arg = "\"" + arg + "\"";
-		} else if (Vm.getPlatform().equals("Java")) {
-			/* on win32 we need extra quotes here to support filenames whith spaces
-			 * (see ewe/sys/Vm.java)			 *
-			 * on linux (and os x?) we must not have extra quotes, filenames with spaces are unsupported
-			 * */
-			if (cmd.indexOf(" ") > -1)
-				cmd = "\"" + cmd + "\"";
-			if (arg.indexOf(" ") > -1)
-				arg = "\"" + arg + "\"";
-		}
-		Vm.exec(cmd, arg, 0, false);
+			    Vm.getPlatform().equals("Win32")) {
+				/* we need extra quotes here, see vm/nmwin32_c.c */
+				if (arg.indexOf(" ") > -1)
+					arg = "\"" + arg + "\"";
+			} else if (Vm.getPlatform().equals("Java")) {
+				/* on win32 we need extra quotes here to support filenames whith spaces
+				 * (see ewe/sys/Vm.java)			 *
+				 * on linux (and os x?) we must not have extra quotes, filenames with spaces are unsupported
+				 * */
+				if (cmd.indexOf(" ") > -1)
+					cmd = "\"" + cmd + "\"";
+				if (arg.indexOf(" ") > -1)
+					arg = "\"" + arg + "\"";
+			}
+		return Vm.exec(cmd, arg, 0, wait);
 	}
 }



From greiol at mail.berlios.de  Tue Jun 16 19:02:40 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 16 Jun 2009 19:02:40 +0200
Subject: [Cachewolf-svn] r1910 - trunk/src/CacheWolf
Message-ID: <200906161702.n5GH2egl010556@sheep.berlios.de>

Author: greiol
Date: 2009-06-16 19:02:29 +0200 (Tue, 16 Jun 2009)
New Revision: 1910

Modified:
   trunk/src/CacheWolf/Preferences.java
Log:
nasty NPE

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-15 22:36:41 UTC (rev 1909)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-16 17:02:29 UTC (rev 1910)
@@ -529,7 +529,7 @@
 				entry = (MapEntry) itPath.next();
 				outp.print("    <impPath key = \"" + SafeXML.strxmlencode(entry.getKey().toString()) + "\" value = \"" + SafeXML.strxmlencode(entry.getValue().toString().replace('\\', '/')) + "\"/>\n");
 			}
-			outp.print("    <rater tool=\"".concat(rater).concat("\"/>\n"));
+			if (null != rater) outp.print("    <rater tool=\"".concat(rater).concat("\"/>\n"));
 			outp.print("</preferences>");
 			outp.close();
 		} catch (Exception e) {



From greiol at mail.berlios.de  Tue Jun 16 19:03:48 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 16 Jun 2009 19:03:48 +0200
Subject: [Cachewolf-svn] r1911 - trunk/src/exp
Message-ID: <200906161703.n5GH3mRD011153@sheep.berlios.de>

Author: greiol
Date: 2009-06-16 19:03:40 +0200 (Tue, 16 Jun 2009)
New Revision: 1911

Modified:
   trunk/src/exp/GpxExportNg.java
Log:
added logs

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-16 17:02:29 UTC (rev 1910)
+++ trunk/src/exp/GpxExportNg.java	2009-06-16 17:03:40 UTC (rev 1911)
@@ -5,6 +5,9 @@
 import CacheWolf.CacheTerrDiff;
 import CacheWolf.CacheType;
 import CacheWolf.Global;
+import CacheWolf.CWPoint;
+import CacheWolf.LogList;
+import CacheWolf.Log;
 
 import com.stevesoft.ewe_pat.Regex;
 import com.stevesoft.ewe_pat.Transformer;
@@ -80,7 +83,7 @@
 						.concat("\t\t\t<groundspeak:encoded_hints>@@CACHEHINT@@</groundspeak:encoded_hints>\n");
 
 	final static String GPXLOG = "\t\t\t\t<groundspeak:log id=\"@@LOGID@@\">\n"
-						.concat("\t\t\t\t\t<groundspeak:date>@@LOGDATE@@</groundspeak:date>\n")
+						.concat("\t\t\t\t\t<groundspeak:date>@@LOGDATE@@T00:00:00</groundspeak:date>\n")
 						.concat("\t\t\t\t\t<groundspeak:type>@@LOGTYPE@@</groundspeak:type>\n")
 						.concat("\t\t\t\t\t<groundspeak:finder id=\"@@LOGFINDERID@@\">@@LOGFINDER@@</groundspeak:finder>\n")
 						.concat("\t\t\t\t\t<groundspeak:text encoded=\"@@LOGENCODE@@\">@@LOGTEXT@@</groundspeak:text>\n")
@@ -296,10 +299,10 @@
 		
 		ret.append(trans.replaceAll(GPXEXTENSION));
 		
-//		ret.append("\t\t\t<groundspeak:logs>\n");
-//		ret.append(formatLogs(ch));
-//		ret.append("\t\t\t</groundspeak:logs>\n");
-//		
+		ret.append("\t\t\t<groundspeak:logs>\n");
+		ret.append(formatLogs(ch));
+		ret.append("\t\t\t</groundspeak:logs>\n");
+		
 //		ret.append("\t\t\t<groundspeak:travelbugs>\n");
 //		ret.append(formatTbs(ch));
 //		ret.append("\t\t\t</groundspeak:travelbugs>\n");
@@ -319,9 +322,23 @@
 	}
 	
 	public String formatLogs(CacheHolder ch) {
-		Transformer trans = new Transformer(true);
-		return "";
-//		return trans.replaceFirst(GPXLOG);
+		LogList logs = ch.getFreshDetails().CacheLogs;
+		StringBuffer ret = new StringBuffer();
+		if (0 == logs.size()) return "";
+		for (int i = 0; i < logs.size(); i++) {
+			Log log = logs.getLog(i);
+			if (outType == GPX_MYFINDSPQ && !log.getLogger().equals(Global.getPref().myAlias)) continue;
+			Transformer trans = new Transformer(true);
+			trans.add(new Regex("@@LOGID@@",""));
+			trans.add(new Regex("@@LOGDATE@@",log.getDate()));
+			trans.add(new Regex("@@LOGTYPE@@",image2TypeText(log.getIcon())));
+			trans.add(new Regex("@@LOGFINDERID@@",""));
+			trans.add(new Regex("@@LOGFINDER@@",log.getLogger()));
+			trans.add(new Regex("@@LOGENCODE@@",""));
+			trans.add(new Regex("@@LOGTEXT@@",log.getMessage()));
+			ret.append(trans.replaceAll(GPXLOG));
+		}
+		return ret.toString();
 	}
 	
 	public String formatHeader() {
@@ -334,18 +351,25 @@
 		if (ch.isAddiWpt() || ch.getType() == CacheType.CW_TYPE_CUSTOM) {
 			return ch.details.LongDescription;
 		} else {
-			Vm.debug("real cache");
+
 			StringBuffer ret = new StringBuffer();
 			String delim = "";
 			ret.append(ch.details.LongDescription);
 			if (ch.is_HTML()) {
 				delim="<br />";
+			} else {
+				delim="\n";
 			}
 			//FIXME: format is not quite right yet
-			//FIXME: cut Addis off in GPXimporter otherwiese people who use GPX to feed CacheWolf have them doubled
+			//FIXME: cut Addis off in GPXimporter otherwise people who use GPX to feed CacheWolf have them doubled
 			if (ch.addiWpts.size() > 0) {
-				Vm.debug("adding waypoints");
-				ret.append(delim).append("\n").append("Additional Waypoints").append(delim).append("\n");
+
+				if (ch.is_HTML()) {
+					ret.append("<p>Additional Waypoints</p>");
+				} else {
+					ret.append("Additional Waypoints\n");
+				}
+
 				Iterator iter = ch.addiWpts.iterator();
 				while (iter.hasNext()) {
 					CacheHolder addi = (CacheHolder) iter.next();
@@ -353,15 +377,42 @@
 					trans.add(new Regex("@@ADDIID@@",addi.getWayPoint()));
 					trans.add(new Regex("@@ADDISHORT@@",addi.getCacheName()));
 					trans.add(new Regex("@@ADDIDELIM@@",delim));
-					trans.add(new Regex("@@ADDILAT@@",addi.LatLon));
+					trans.add(new Regex("@@ADDILAT@@",formatAddiLatLon(addi.pos)));
 					trans.add(new Regex("@@ADDILON@@",""));
 					trans.add(new Regex("@@ADDILONG@@",addi.getFreshDetails().LongDescription));
 					ret.append(trans.replaceAll(GPXADDIINMAIN));
 				}
 				ret.append(delim).append("\n");
-
 			}
 			return ret.toString();
 		}
 	}
+	
+	public static String image2TypeText(String image){
+		if (image.equals("icon_smile.gif")) return "Found it";
+		if (image.equals("icon_sad.gif")) return "Didn't find it";
+		if (image.equals("icon_note.gif")) return "Write note";
+		if (image.equals("icon_enabled.gif")) return "Enable Listing";
+		if (image.equals("icon_disabled.gif")) return "Temporarily Disable Listing";
+		if (image.equals("icon_camera.gif")) return "Webcam Photo Taken";
+		if (image.equals("11.png")) return "Webcam Photo Taken";
+		if (image.equals("icon_attended.gif")) return "Attended";
+		if (image.equals("green.gif")) return "Publish Listing";
+		if (image.equals("icon_rsvp.gif")) return "Will Attend";
+		if (image.equals("big_smile.gif")) return "Post Reviewer Note";
+		if (image.equals("traffic_cone.gif")) return "Archive (show)";
+		if (image.equals("icon_maint.gif")) return "Owner Maintenance";
+		if (image.equals("icon_needsmaint.gif")) return "Needs Maintenance";
+		if (image.equals("coord_update.gif")) return "Update Coordinates";
+
+		return image;
+	}
+	
+	private String formatAddiLatLon(CWPoint pos) {
+		if (pos.isValid()) {
+			return pos.toString();
+		} else {
+			return "N/S  __ ? __ . ___ W/E ___ ? __ . ___";
+		}
+	}
 }



From engywuck at mail.berlios.de  Tue Jun 16 19:32:52 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Tue, 16 Jun 2009 19:32:52 +0200
Subject: [Cachewolf-svn] r1912 - trunk/src/CacheWolf
Message-ID: <200906161732.n5GHWqJC013154@sheep.berlios.de>

Author: engywuck
Date: 2009-06-16 19:32:50 +0200 (Tue, 16 Jun 2009)
New Revision: 1912

Modified:
   trunk/src/CacheWolf/myTableModel.java
Log:
If number of addi waypoints is zero, then don't print anything in the "number of addis" column.

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-16 17:03:40 UTC (rev 1911)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-16 17:32:50 UTC (rev 1912)
@@ -361,7 +361,7 @@
 					case 16: // Does note exist?
 						if (ch.hasNote()) return picHasNotes; else return null;
 					case 17: // Number of Additional Waypoints;
-						if (ch.mainCache == null) {
+						if (ch.mainCache == null && ch.addiWpts.size()>0) {
 							return String.valueOf(ch.addiWpts.size());
 						} else {
 							return "";



From greiol at mail.berlios.de  Tue Jun 16 19:53:49 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 16 Jun 2009 19:53:49 +0200
Subject: [Cachewolf-svn] r1913 - trunk/src/CacheWolf
Message-ID: <200906161753.n5GHrnmM032599@sheep.berlios.de>

Author: greiol
Date: 2009-06-16 19:53:48 +0200 (Tue, 16 Jun 2009)
New Revision: 1913

Modified:
   trunk/src/CacheWolf/CacheHolderDetail.java
Log:
avoid to have invalid xml caused by counterimages with mutiple parameters (&)

Modified: trunk/src/CacheWolf/CacheHolderDetail.java
===================================================================
--- trunk/src/CacheWolf/CacheHolderDetail.java	2009-06-16 17:32:50 UTC (rev 1912)
+++ trunk/src/CacheWolf/CacheHolderDetail.java	2009-06-16 17:53:48 UTC (rev 1913)
@@ -238,7 +238,7 @@
 			ex = new Extractor(text, "<IMG>", "</IMG>", 0, true);
 			dummy = ex.findNext();
 			while(ex.endOfSearch() == false){
-				Images.add(dummy);
+				Images.add(SafeXML.strxmldecode(dummy));
 				dummy = ex.findNext();
 			}
 			ImagesText.clear();
@@ -363,7 +363,7 @@
 				  String stbuf = new String();
 				  for(int i = 0;i<Images.size();i++){
 						stbuf = (String)Images.get(i);
-						detfile.print("    <IMG>"+stbuf+"</IMG>\n");
+						detfile.print("    <IMG>"+SafeXML.strxmlencode(stbuf)+"</IMG>\n");
 				  }
 				  int iis = ImagesInfo.size();
 				  for(int i = 0;i<ImagesText.size();i++){



From engywuck at mail.berlios.de  Tue Jun 16 19:56:54 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Tue, 16 Jun 2009 19:56:54 +0200
Subject: [Cachewolf-svn] r1914 - trunk/src/CacheWolf
Message-ID: <200906161756.n5GHusji000393@sheep.berlios.de>

Author: engywuck
Date: 2009-06-16 19:56:49 +0200 (Tue, 16 Jun 2009)
New Revision: 1914

Modified:
   trunk/src/CacheWolf/MyComparer.java
Log:
Now sorting is possible in the "number of addis" column.

Modified: trunk/src/CacheWolf/MyComparer.java
===================================================================
--- trunk/src/CacheWolf/MyComparer.java	2009-06-16 17:53:48 UTC (rev 1913)
+++ trunk/src/CacheWolf/MyComparer.java	2009-06-16 17:56:49 UTC (rev 1914)
@@ -113,6 +113,11 @@
 		            ch.sort="2";
 		        }
 		    }
+		} else if (colToCompare==17) {
+			for (int i=0; i<visibleSize; i++) {
+				CacheHolder ch =  cacheDB.get(i);
+				ch.sort=MyLocale.formatLong(ch.addiWpts.size(),"000");
+			}
 		}
 	}
 	



From greiol at mail.berlios.de  Tue Jun 16 21:16:58 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 16 Jun 2009 21:16:58 +0200
Subject: [Cachewolf-svn] r1915 - in trunk/src/CacheWolf: . imp
Message-ID: <200906161916.n5GJGww8008528@sheep.berlios.de>

Author: greiol
Date: 2009-06-16 21:16:55 +0200 (Tue, 16 Jun 2009)
New Revision: 1915

Modified:
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/imp/Rating.java
   trunk/src/CacheWolf/myTableModel.java
Log:
added experimental rating interface

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2009-06-16 17:56:49 UTC (rev 1914)
+++ trunk/src/CacheWolf/CacheHolder.java	2009-06-16 19:16:55 UTC (rev 1915)
@@ -532,7 +532,7 @@
 		} else {
 			recommendationScore = -1;
 			setNumFoundsSinceRecommendation(-1);
-			setNumRecommended(-1);
+//			setNumRecommended(-1);
 		}
 	}
 	

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2009-06-16 17:56:49 UTC (rev 1914)
+++ trunk/src/CacheWolf/MainMenu.java	2009-06-16 19:16:55 UTC (rev 1915)
@@ -3,6 +3,7 @@
 import CacheWolf.navi.MapImporter;
 import CacheWolf.navi.MapLoaderGui;
 import CacheWolf.navi.SelectMap;
+import CacheWolf.imp.Rating;
 import ewe.ui.*;
 import ewe.util.Vector;
 //import ewe.util.mString;
@@ -31,7 +32,7 @@
 	private MenuItem exportOZI, exportKML, exportTPL, exportExplorist;
 	private MenuItem filtCreate, filtClear, filtInvert, filtSelected, filtNonSelected, filtBlack, filtApply;
 	private MenuItem exportLOC, exportGPS, mnuSeparator;
-	private MenuItem orgNewWP, orgCopy, orgMove, orgDelete,orgRebuild,orgCheckNotesAndSolver;
+	private MenuItem orgNewWP, orgCopy, orgMove, orgDelete,orgRebuild,orgCheckNotesAndSolver, orgRater;
 	public MenuItem cacheTour,orgTravelbugs, mnuForceLogin;
 	private MenuItem mnuNewProfile, mnuOpenProfile, mnuEditCenter;
 	private Form father;
@@ -197,18 +198,20 @@
 		///////////////////////////////////////////////////////////////////////
 		// Create the "Organise" pulldown menu
 		///////////////////////////////////////////////////////////////////////
-		MenuItem[] organiseMenuItems=new MenuItem[10];
+		MenuItem[] organiseMenuItems=new MenuItem[11];
 		organiseMenuItems[0] = orgNewWP = new MenuItem(MyLocale.getMsg(214,"New Waypoint"));
 		organiseMenuItems[1] = mnuSeparator;
 		organiseMenuItems[2] = orgCopy  = new MenuItem(MyLocale.getMsg(141,"Copy")); 
 		organiseMenuItems[3] = orgMove  = new MenuItem(MyLocale.getMsg(142,"Move")); 
 		organiseMenuItems[4] = orgDelete   = new MenuItem(MyLocale.getMsg(143,"Delete"));
 		organiseMenuItems[5] = orgRebuild   = new MenuItem(MyLocale.getMsg(208,"Rebuild Index"));
-		organiseMenuItems[6] = orgCheckNotesAndSolver = new MenuItem(MyLocale.getMsg(220,"Rebuild Index"));
-		organiseMenuItems[7] = mnuSeparator;
-		organiseMenuItems[8] = orgTravelbugs = new MenuItem(MyLocale.getMsg(139,"Manage travelbugs"));
+		organiseMenuItems[6] = orgCheckNotesAndSolver = new MenuItem(MyLocale.getMsg(220,"Check Notes/Solver"));
+		organiseMenuItems[7] = orgRater = new MenuItem("Rater");
+		if (null == Global.getPref().rater) orgRater.modifiers = MenuItem.Disabled;
+		organiseMenuItems[8] = mnuSeparator;
+		organiseMenuItems[9] = orgTravelbugs = new MenuItem(MyLocale.getMsg(139,"Manage travelbugs"));
 		cacheTour = new MenuItem(MyLocale.getMsg(198,"Cachetour"));
-		organiseMenuItems[9] = cacheTour;
+		organiseMenuItems[10] = cacheTour;
 		this.addMenu(new PullDownMenu(MyLocale.getMsg(140,"Organise"),new Menu(organiseMenuItems,null)));
 
 		///////////////////////////////////////////////////////////////////////
@@ -385,8 +388,9 @@
 				ovl.doIt();
 			}
 			if(mev.selectedItem == exportGPX){
-				GPXExporter htm = new GPXExporter(pref, profile);
-				htm.doIt(1);
+//				GpxExportNg gpx = new GpxExportNg();
+				GPXExporter gpx = new GPXExporter(pref,profile);
+				gpx.doIt(1);
 			}
 			if(mev.selectedItem == exportASC){
 				ASCExporter asc = new ASCExporter(pref,profile);
@@ -649,6 +653,10 @@
 				cacheTour.modifiers^=MenuItem.Checked;
 				Global.mainForm.toggleCacheListVisible();			
 			}
+			if(mev.selectedItem == orgRater) {
+				Rating rater = new Rating();
+				rater.run();
+			}
 			
 			///////////////////////////////////////////////////////////////////////
 			// "About" pulldown menu

Modified: trunk/src/CacheWolf/imp/Rating.java
===================================================================
--- trunk/src/CacheWolf/imp/Rating.java	2009-06-16 17:56:49 UTC (rev 1914)
+++ trunk/src/CacheWolf/imp/Rating.java	2009-06-16 19:16:55 UTC (rev 1915)
@@ -1,11 +1,11 @@
 package CacheWolf.imp;
 
+import utils.CWWrapper;
+import CacheWolf.CacheHolder;
 import CacheWolf.CacheType;
 import CacheWolf.Global;
-import CacheWolf.CacheHolder;
-import utils.CWWrapper;
 import ewe.sys.Handle;
-import ewe.ui.*;
+import ewe.ui.ProgressBarForm;
 
 /*
  * get rating for a cache from an external tool
@@ -17,26 +17,28 @@
 	public Rating() {
 		rater = Global.getPref().rater;
 	}
-	
+
 	/**
-	 * call the tool defined by Global.getPref().rater with a visible waypoint as parameter
-	 * wait for tool to finish, catch exit code and write it to CacheHolder.numRecommended
+	 * call the tool defined by Global.getPref().rater with a visible waypoint
+	 * as parameter wait for tool to finish, catch exit code and write it to
+	 * CacheHolder.numRecommended
 	 */
 	public void run() {
-		if (null == rater) return;
-		
+		if (null == rater)
+			return;
+
 		ProgressBarForm pbf = new ProgressBarForm();
 		Handle h = new Handle();
-		
+
 		int totalWaypoints = Global.getProfile().cacheDB.countVisible();
 		int countWaypoints = 0;
-		
+
 		pbf.showMainTask = false;
-		pbf.setTask(h,"Rating ...");
+		pbf.setTask(h, "Rating ...");
 		pbf.exec();
-		
-		for(int i = 0; i<Global.getProfile().cacheDB.size(); i++){
-			CacheHolder ch=Global.getProfile().cacheDB.get(i);
+
+		for (int i = 0; i < Global.getProfile().cacheDB.size(); i++) {
+			CacheHolder ch = Global.getProfile().cacheDB.get(i);
 			if (ch.isVisible()) {
 				if (!ch.isAddiWpt() && ch.getType() != CacheType.CW_TYPE_CUSTOM) {
 					int rate;
@@ -48,11 +50,12 @@
 					}
 				}
 				countWaypoints++;
-				h.progress = (float)countWaypoints/(float)totalWaypoints;
+				h.progress = (float) countWaypoints / (float) totalWaypoints;
 				h.changed();
 			}
 		}
-		
+		pbf.exit(0);
+		Global.mainForm.repaintNow();
 	}
 
 }

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-16 17:56:49 UTC (rev 1914)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-16 19:16:55 UTC (rev 1915)
@@ -349,9 +349,8 @@
 							return sizePics[CacheSize.guiSizeImageId(ch.getCacheSize())];
 						}
 					case 13: // OC number of recommendations
-						if (ch.getWayPoint().startsWith("OC"))
-							return Convert.formatInt(ch.getNumRecommended());
-						return null;
+						if (ch.isAddiWpt() || CacheType.CW_TYPE_CUSTOM == ch.getType()) return null;
+						return Convert.formatInt(ch.getNumRecommended());
 					case 14: // OC rating
 						if (ch.getWayPoint().startsWith("OC"))
 							return Convert.formatInt(ch.recommendationScore);
@@ -370,10 +369,10 @@
 			} // if
 		} catch (Exception e) {
 			if (Global.getPref().debug) Global.getPref().log("Ignored Exception in myTableModel.getCellData()",e, true);
+			return null;
+		}
 		return null;
 	}
-		return null;
-	}
 
 	public boolean penPressed(Point onTable,Point cell){
 		boolean retval = false;



From greiol at mail.berlios.de  Tue Jun 16 21:56:21 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 16 Jun 2009 21:56:21 +0200
Subject: [Cachewolf-svn] r1916 - trunk/src/exp
Message-ID: <200906161956.n5GJuLrC013241@sheep.berlios.de>

Author: greiol
Date: 2009-06-16 21:56:19 +0200 (Tue, 16 Jun 2009)
New Revision: 1916

Modified:
   trunk/src/exp/TPLExporter.java
Log:
get the . back into terrain and difficulty

Modified: trunk/src/exp/TPLExporter.java
===================================================================
--- trunk/src/exp/TPLExporter.java	2009-06-16 19:16:55 UTC (rev 1915)
+++ trunk/src/exp/TPLExporter.java	2009-06-16 19:56:19 UTC (rev 1916)
@@ -30,6 +30,7 @@
 import CacheWolf.CacheHolder;
 import CacheWolf.CacheHolderDetail;
 import CacheWolf.CacheSize;
+import CacheWolf.CacheTerrDiff;
 import CacheWolf.CacheType;
 import CacheWolf.Global;
 import CacheWolf.Preferences;
@@ -196,8 +197,8 @@
 						varParams.put("SHORTSIZE", CacheSize.getExportShortId(ch.getCacheSize()));
 						varParams.put("WAYPOINT", ch.getWayPoint());
 						varParams.put("OWNER", ch.getCacheOwner());
-						varParams.put("DIFFICULTY", String.valueOf(ch.getHard()));
-						varParams.put("TERRAIN", String.valueOf(ch.getTerrain()));
+						varParams.put("DIFFICULTY", (ch.isAddiWpt() || CacheType.CW_TYPE_CUSTOM == ch.getType())?"":CacheTerrDiff.longDT(ch.getHard()));
+						varParams.put("TERRAIN", (ch.isAddiWpt() || CacheType.CW_TYPE_CUSTOM == ch.getType())?"":CacheTerrDiff.longDT(ch.getTerrain()));
 						varParams.put("DISTANCE", dec.replaceAll(ch.getDistance()));
 						varParams.put("BEARING", ch.bearing);
 						varParams.put("LATLON", ch.LatLon);



From engywuck at mail.berlios.de  Wed Jun 17 18:11:20 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Wed, 17 Jun 2009 18:11:20 +0200
Subject: [Cachewolf-svn] r1917 - trunk/src/CacheWolf
Message-ID: <200906171611.n5HGBKR3031749@sheep.berlios.de>

Author: engywuck
Date: 2009-06-17 18:11:19 +0200 (Wed, 17 Jun 2009)
New Revision: 1917

Modified:
   trunk/src/CacheWolf/MainTab.java
Log:
The message box on recalculating distances and bearings after setting a new center is now fully painted, so that you might be able to read it.

Modified: trunk/src/CacheWolf/MainTab.java
===================================================================
--- trunk/src/CacheWolf/MainTab.java	2009-06-16 19:56:19 UTC (rev 1916)
+++ trunk/src/CacheWolf/MainTab.java	2009-06-17 16:11:19 UTC (rev 1917)
@@ -250,6 +250,7 @@
 	public void updateBearDist(){// Called from DetailsPanel, GotoPanel and myTableControl
 		MessageBox info = new MessageBox(MyLocale.getMsg(327,"Information"), MyLocale.getMsg(1024,"Entfernungen in der Listenansicht \n werden neu berechnet...").replace('~','\n'), 0);
 		info.exec();
+		info.waitUntilPainted(200);
 		tbP.pref = pref;
 		profile.updateBearingDistance();
 		//tbP.refreshTable();



From engywuck at mail.berlios.de  Wed Jun 17 18:22:54 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Wed, 17 Jun 2009 18:22:54 +0200
Subject: [Cachewolf-svn] r1918 - trunk/src/CacheWolf
Message-ID: <200906171622.n5HGMsod032756@sheep.berlios.de>

Author: engywuck
Date: 2009-06-17 18:22:53 +0200 (Wed, 17 Jun 2009)
New Revision: 1918

Modified:
   trunk/src/CacheWolf/FilterScreen.java
Log:
When leaving the filter screen the Choice Box for selecting a filter is emptied when the filter screen is closed. A new selection of the same filter after reopening the filter screen then activate this same filter (which hadn't been the case before).

Modified: trunk/src/CacheWolf/FilterScreen.java
===================================================================
--- trunk/src/CacheWolf/FilterScreen.java	2009-06-17 16:11:19 UTC (rev 1917)
+++ trunk/src/CacheWolf/FilterScreen.java	2009-06-17 16:22:53 UTC (rev 1918)
@@ -595,6 +595,8 @@
 					Global.getPref().savePreferences();
 					savedFiltersChanged = false;
 				}
+				fltList.select(-1);
+				currentFilterID = "";
 				this.close(0);
 			}
 			else if (ev.target == btnRoute){
@@ -611,6 +613,8 @@
 					flt.doFilterRoute(datei, Convert.toDouble(inf.feedback.getText()));
 				}
 				Vm.showWait(false);
+				fltList.select(-1);
+				currentFilterID = "";
 				this.close(0);
 				
 			}
@@ -629,6 +633,8 @@
 				}
 				Global.mainTab.tbP.tc.scrollToVisible(0,0);
 				Vm.showWait(false);
+				fltList.select(-1);
+				currentFilterID = "";
 				this.close(0);
 			} else if (ev.target == btnSaveFlt) {
 				String ID = fltList.getText();



From apreisser at mail.berlios.de  Wed Jun 17 19:29:49 2009
From: apreisser at mail.berlios.de (apreisser at mail.berlios.de)
Date: Wed, 17 Jun 2009 19:29:49 +0200
Subject: [Cachewolf-svn] r1919 - trunk/src/CacheWolf
Message-ID: <200906171729.n5HHTnPH024309@sheep.berlios.de>

Author: apreisser
Date: 2009-06-17 19:28:43 +0200 (Wed, 17 Jun 2009)
New Revision: 1919

Added:
   trunk/src/CacheWolf/DataMoverForm.java
Log:
Dialog selecting between visible and/or marked caches for performing move and copy operation in the DataMover

Added: trunk/src/CacheWolf/DataMoverForm.java
===================================================================
--- trunk/src/CacheWolf/DataMoverForm.java	2009-06-17 16:22:53 UTC (rev 1918)
+++ trunk/src/CacheWolf/DataMoverForm.java	2009-06-17 17:28:43 UTC (rev 1919)
@@ -0,0 +1,93 @@
+package CacheWolf;
+
+import ewe.ui.CheckBoxGroup;
+import ewe.ui.Event;
+import ewe.ui.Form;
+import ewe.ui.mButton;
+import ewe.ui.mCheckBox;
+import ewe.ui.mLabel;
+
+public class DataMoverForm extends Form {
+	mCheckBox ticked, visible, tickedVisible;
+	CheckBoxGroup chkFormat = new CheckBoxGroup();
+	mButton yesButton;
+	mButton noButton;
+	mLabel firstLine;
+	
+	public DataMoverForm ()
+	{
+		title = MyLocale.getMsg(144,"Warning");
+		ticked = new mCheckBox (MyLocale.getMsg(254, "All visible"));
+		ticked.setGroup(chkFormat);
+		visible = new mCheckBox (MyLocale.getMsg(255, "All ticked"));
+		visible.setGroup(chkFormat);
+		tickedVisible = new mCheckBox (MyLocale.getMsg(256, "All visible and ticked"));
+		tickedVisible.setGroup(chkFormat);
+		firstLine = new mLabel ("");
+		firstLine.anchor = mLabel.CENTER;
+		addLast (firstLine);
+		addLast (visible);
+		addLast (ticked);
+		addLast (tickedVisible);
+		mLabel continueQuestion =new mLabel (MyLocale.getMsg(259, "Do You really want to continue?"));
+		continueQuestion.anchor = mLabel.CENTER;
+		addLast (continueQuestion);
+		doButtons(Form.YESB|Form.CANCELB);
+		setModefromPref();
+	}
+
+	/**
+	 * Gets the last mode from the preferences
+	 */
+	private void setModefromPref (){
+		Preferences prefObject = Preferences.getPrefObject();
+		switch (prefObject.processorMode){
+		case 1:
+			ticked.setState(true);
+			break;
+		case 2:
+			tickedVisible.setState(true);
+			break;
+		case 0:
+			visible.setState(true);
+			break;
+		}
+	}
+	public void onEvent(Event ev) {
+		if (ev.target == yes || ev.target == no){
+			Preferences.getPrefObject().processorMode = getMode();
+		}
+		super.onEvent(ev);
+	}
+	
+	public void setTickedText(String value) {
+		ticked.text = value;
+	}
+
+	public void setVisibleText(String value) {
+		visible.text = value;
+	}
+
+	public void setTickedVisibleText(String value) {
+		tickedVisible.text = value;
+	}
+	
+	public void setFirstLineText (String value){
+		firstLine.text = value;
+	}
+	
+	public int getMode (){
+		if (visible.getState()){
+			return 0;
+		}
+		else if (ticked.getState()){
+			return 1;
+		}
+		else if (tickedVisible.getState()){
+			return 2;
+		}
+		else{
+			throw new IllegalStateException ("No radiobutton selected");
+		}
+	}
+}


Property changes on: trunk/src/CacheWolf/DataMoverForm.java
___________________________________________________________________
Name: svn:mime-type
   + text/plain



From apreisser at mail.berlios.de  Wed Jun 17 19:31:49 2009
From: apreisser at mail.berlios.de (apreisser at mail.berlios.de)
Date: Wed, 17 Jun 2009 19:31:49 +0200
Subject: [Cachewolf-svn] r1920 - trunk/src/CacheWolf
Message-ID: <200906171731.n5HHVnKe026769@sheep.berlios.de>

Author: apreisser
Date: 2009-06-17 19:31:38 +0200 (Wed, 17 Jun 2009)
New Revision: 1920

Modified:
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/DataMover.java
   trunk/src/CacheWolf/Preferences.java
Log:
A dialog is presented to decide whether visible or marked waypoints are to be moved or copied to another profile.

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2009-06-17 17:28:43 UTC (rev 1919)
+++ trunk/src/CacheWolf/CacheHolder.java	2009-06-17 17:31:38 UTC (rev 1920)
@@ -18,7 +18,7 @@
  *	classes and methods to get more information.
  *	
  */
-public class CacheHolder {
+public class CacheHolder implements Cloneable{
 	protected static final String NOBEARING = "?";
 	protected static final String EMPTY = "";
 
@@ -1403,5 +1403,13 @@
 		this.hasNote = hasNote;
 	}
 
+	/**
+	 * Create a swallow-copy(!) no deep copy
+	 */
+	protected Object clone() throws CloneNotSupportedException {
+		return super.clone();
+	}
+
+	
 }
 

Modified: trunk/src/CacheWolf/DataMover.java
===================================================================
--- trunk/src/CacheWolf/DataMover.java	2009-06-17 17:28:43 UTC (rev 1919)
+++ trunk/src/CacheWolf/DataMover.java	2009-06-17 17:31:38 UTC (rev 1920)
@@ -1,10 +1,13 @@
 package CacheWolf;
 
+import java.util.BitSet;
+
 import utils.FileBugfix;
 import ewe.filechooser.FileChooser;
 import ewe.filechooser.FileChooserBase;
 import ewe.io.*;
 import ewe.ui.*;
+import ewe.util.Iterator;
 import ewe.sys.*;
 
 
@@ -25,11 +28,12 @@
 	}
 	public void deleteCaches(){
 		
-		MessageBox mBox = new MessageBox (MyLocale.getMsg(144,"Warning"),MyLocale.getMsg(145,"Cachedata of ALL VISIBLE caches will be deleted! Continue?"), FormBase.IDYES |FormBase.IDNO);
-		if (mBox.execute() != FormBase.IDOK){
+		int mode = showMessageBox(251,"All waypoints will be deleted");
+		if (mode == -1){
 			return;
 		}
-		processCaches(new Deleter(MyLocale.getMsg(143, "Delete")));
+		
+		processCaches(new Deleter(MyLocale.getMsg(143, "Delete")), mode);
 		// write indexfiles
 		profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR);
 	}
@@ -40,21 +44,110 @@
 		dstProfile.dataDir=selectTargetDir();
 		if (dstProfile.dataDir.equals(profile.dataDir) ||
 			dstProfile.dataDir.equals("")) return;
-		MessageBox mBox = new MessageBox (MyLocale.getMsg(144,"Warning"),MyLocale.getMsg(146,"Cachedata of ALL VISIBLE caches will be copied! Continue?"), FormBase.IDYES |FormBase.IDNO);
-		if (mBox.execute() != FormBase.IDOK){
+		
+		//Von Andi P
+		int mode = showMessageBox(253,"All waypoints will be copied");
+		if (mode == -1){
 			return;
 		}
+		//Ende
 		
 		// Read indexfile of destination, if one exists
 		File ftest = new File(dstProfile.dataDir + "index.xml");
 		if(ftest.exists()){
 			dstProfile.readIndex();
 		}
-		processCaches(new Copier(MyLocale.getMsg(141, "Copy"),dstProfile));
+		processCaches(new Copier(MyLocale.getMsg(141, "Copy"),dstProfile), mode);
 		// write indexfiles and keep the filter status
 		dstProfile.saveIndex(pref, Profile.NO_SHOW_PROGRESS_BAR);
+		//Now repair the cache-Vector:
+		for(int i =0; i < srcDB.size();i++){
+			CacheHolder holder = srcDB.get(i);
+			for(Iterator j=holder.addiWpts.iterator(); j.hasNext();){
+				CacheHolder element = (CacheHolder) j.next();
+				element.mainCache = holder;
+			}
+		}
 	}
 	
+	/**
+	 * Shows the messagebox before copying/moving/deleting waypoints.
+	 * It returns the mode selected by the user.
+	 * 0 means all visible
+	 * 1 means all ticked
+	 * 2 means all visible and ticked cache
+	 * -1 means the user has pressed `Cancel' and no action has to be taken.
+	 * @return mode selected by the user
+	 */
+	private int showMessageBox(int actionTextNr, String defaultValue) {
+		DataMoverForm cpf = new DataMoverForm ();
+		cpf.setTickedText(makeTickedText ());
+		cpf.setVisibleText(makeVisibleText ());
+		cpf.setTickedVisibleText(makeVisibleTickedText ());
+		cpf.setFirstLineText(MyLocale.getMsg(actionTextNr, defaultValue));
+		int dialogResult = cpf.execute(null, Gui.CENTER_FRAME);
+		if (dialogResult != FormBase.IDOK){
+			return -1;
+		}
+		int mode = cpf.getMode();
+		return mode;
+	}
+
+	private String makeTickedText() {
+		int size=srcDB.size();
+		int countMainWP=0;
+		int countAddiWP=0;
+		// Count the number of caches to move/delete/copy
+		for(int i = 0; i<size; i++) {
+			if(srcDB.get(i).is_Checked && !srcDB.get(i).isAddiWpt()){
+				countMainWP++;
+			}
+			else if (srcDB.get(i).is_Checked && srcDB.get(i).isAddiWpt()){
+				countAddiWP++;
+			}
+		}
+		return MyLocale.getMsg(255, "All ticked") + " ("+countMainWP+
+			' ' + MyLocale.getMsg(257, "Main") + ", "+countAddiWP +
+			MyLocale.getMsg(258, " Addi") +')';
+	}
+	
+	private String makeVisibleText() {
+		int size=srcDB.size();
+		int countMainWP=0;
+		int countAddiWP=0;
+		// Count the number of caches to move/delete/copy
+		for(int i = 0; i<size; i++) {
+			if(srcDB.get(i).isVisible() && !srcDB.get(i).isAddiWpt()){
+				countMainWP++;
+			}
+			else if (srcDB.get(i).isVisible() && srcDB.get(i).isAddiWpt()){
+				countAddiWP++;
+			}
+		}
+		return MyLocale.getMsg(254, "All visible") + " ("+countMainWP+
+			' ' + MyLocale.getMsg(257, "Main") + ", "+countAddiWP +
+			MyLocale.getMsg(258, " Addi") +')';
+	}
+
+	private String makeVisibleTickedText() {
+		int size=srcDB.size();
+		int countMainWP=0;
+		int countAddiWP=0;
+		// Count the number of caches to move/delete/copy
+		for(int i = 0; i<size; i++) {
+			if(srcDB.get(i).isVisible() && srcDB.get(i).is_Checked && !srcDB.get(i).isAddiWpt()){
+				countMainWP++;
+			}
+			else if (srcDB.get(i).isVisible() && srcDB.get(i).is_Checked && srcDB.get(i).isAddiWpt()){
+				countAddiWP++;
+			}
+		}
+		return MyLocale.getMsg(256, "All visible and ticked") + " ("+countMainWP+
+		' ' + MyLocale.getMsg(257, "Main") + ", "+countAddiWP +
+		MyLocale.getMsg(258, " Addi") +')';
+	}
+
+	
 	public void moveCaches() {
 		Profile dstProfile=new Profile();
 		// Select destination directory
@@ -62,17 +155,17 @@
 		if (dstProfile.dataDir.equals(profile.dataDir) ||
 			dstProfile.dataDir.equals("")) return;
 		
-		MessageBox mBox = new MessageBox (MyLocale.getMsg(144,"Warning"),MyLocale.getMsg(147,"Cachedata of ALL VISIBLE caches will be moved! Continue?"), FormBase.IDYES |FormBase.IDNO);
-		if (mBox.execute() != FormBase.IDOK){
+		int mode = showMessageBox(252, "All waypoints will be moved");
+		if (mode == -1){
 			return;
 		}
-		
+				
 		// Read indexfile of destination, if one exists
 		File ftest = new File(dstProfile.dataDir + "index.xml");
 		if(ftest.exists()){
 			dstProfile.readIndex();		
 		}
-		processCaches(new Mover(MyLocale.getMsg(142, "Move"),dstProfile));
+		processCaches(new Mover(MyLocale.getMsg(142, "Move"),dstProfile), mode);
 		// write indexfiles
 		dstProfile.saveIndex(pref, Profile.NO_SHOW_PROGRESS_BAR); 
 		profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR);
@@ -81,14 +174,43 @@
 	 /**
 	  * This function carries out the copy/delete/move with a progress bar. 
 	  * The Executor class defines what operation is to be carried out.
+	  * mode defines if visible/marked or visible and markes caches are be processed.
+	  * 0 means all visible
+	  * 1 means all marked
+	  * 2 means all visible and marked
 	  * @param exec
+	 * @param tickeOnly if set to <code>true</true> only caches with the checked-flag will be handled.
 	  */
-	 private void processCaches(Executor exec) {
+	 private void processCaches(Executor exec, int mode) {
 		// First empty the cache so that the correct cache details are on disk
 		CacheHolder.saveAllModifiedDetails(); 
 		int size=srcDB.size();
+		int count=0;
 		// Count the number of caches to move/delete/copy
-		int count=srcDB.countVisible();
+		// and remember the index of the files process, makes it a little bit easier
+		BitSet processSet = new BitSet();
+		for(int i = 0; i<size; i++) {
+			switch (mode){
+			case 0:
+				if (srcDB.get(i).isVisible()){
+					count++;
+					processSet.set(i);
+				}
+				break;
+			case 1:
+				if (srcDB.get(i).is_Checked){
+					count++;
+					processSet.set(i);
+				}
+				break;
+			case 2:
+				if (srcDB.get(i).isVisible() && srcDB.get(i).is_Checked){
+					count++;
+					processSet.set(i);
+				}
+				break;
+			}
+		}
 		myProgressBarForm pbf = new myProgressBarForm();
 		Handle h = new Handle();
 		pbf.setTask(h,exec.title);
@@ -98,7 +220,7 @@
 		// Now do the actual work
 		for(int i = size-1; i>=0; i--){
 			CacheHolder srcHolder=srcDB.get(i);
-			if(srcHolder.isVisible()){
+			if(processSet.get(i)){
 				h.progress = ((float)nProcessed++)/(float)count;
 				h.changed();
 				//Now do the copy/delete/move of the cache
@@ -206,6 +328,17 @@
 				copyCacheFiles(srcHolder.getWayPoint(),profile.dataDir, dstProfile.dataDir);
 				// does cache exists in destDB ?
 				// Update database
+				//*wall* when copying addis without their maincache, the maincache in the srcDB will be set to null on saving the dstProfile later.
+				//Therefore it will be shown twice in the cachelist.
+				//To prevent this, addis will be cloned and to save memory only addis will be clones.
+				//TODO clone addis only when the maincache will not be copied.
+//				if (srcHolder.isAddiWpt()){
+//					try {
+//						srcHolder = (CacheHolder) srcHolder.clone();
+//					} catch (CloneNotSupportedException e) {
+//						//ignore, CacheHolder implements Cloneable ensures this methods
+//					}
+//				}
 				int dstPos = dstProfile.getCacheIndex(srcHolder.getWayPoint());
 				if (dstPos >= 0){
 					dstProfile.cacheDB.set(dstPos,srcHolder);

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-17 17:28:43 UTC (rev 1919)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-17 17:31:38 UTC (rev 1920)
@@ -220,6 +220,9 @@
 	public boolean downloadPics = true;
 	/** Download TB information when loading cache data */
 	public boolean downloadTBs = true;
+	/** Last mode select in the DataMover for processing cache*/
+	public int processorMode = 0;
+	
 	/** external Cacherating software */
 	public String rater;
 	
@@ -448,6 +451,13 @@
 			// Filter object is remembered under the given ID
 			this.addFilter(id, data);
 		}
+		else if (name.equals ("datamover")){
+			tmp = atts.getValue("processorMode");
+			if (tmp != null){
+				processorMode=Convert.parseInt(tmp);
+			}
+			
+		}
 
 	}
 
@@ -510,6 +520,7 @@
 			outp.print("    <details cacheSize=\"" + SafeXML.strxmlencode(maxDetails) + "\" delete=\"" + SafeXML.strxmlencode(deleteDetails) + "\"/>\n");
 			outp.print("    <metric type=\"" + SafeXML.strxmlencode(metricSystem) + "\"/>\n");
 			outp.print("    <export numberOfLogsToExport=\"" + SafeXML.strxmlencode(numberOfLogsToExport) + "\" exportTravelbugs=\"" + SafeXML.strxmlencode(exportTravelbugs) + "\" exportGpxAsMyFinds=\"" + SafeXML.strxmlencode(exportGpxAsMyFinds) + "\"/>\n");
+			outp.print("    <datamover processorMode=\"" + SafeXML.strxmlencode(processorMode) + "\" />\n");
 			if (customMapsPath!=null) outp.print("    <mapspath dir = \"" + SafeXML.strxmlencode(customMapsPath.replace('\\','/')) + "\"/>\n");
 			// Saving filters
 			String[] filterIDs = this.getFilterIDs();
@@ -529,7 +540,7 @@
 				entry = (MapEntry) itPath.next();
 				outp.print("    <impPath key = \"" + SafeXML.strxmlencode(entry.getKey().toString()) + "\" value = \"" + SafeXML.strxmlencode(entry.getValue().toString().replace('\\', '/')) + "\"/>\n");
 			}
-			if (null != rater) outp.print("    <rater tool=\"".concat(rater).concat("\"/>\n"));
+			outp.print("    <rater tool=\"".concat(rater).concat("\"/>\n"));
 			outp.print("</preferences>");
 			outp.close();
 		} catch (Exception e) {



From apreisser at mail.berlios.de  Wed Jun 17 19:32:37 2009
From: apreisser at mail.berlios.de (apreisser at mail.berlios.de)
Date: Wed, 17 Jun 2009 19:32:37 +0200
Subject: [Cachewolf-svn] r1921 - trunk/res_noewe/languages
Message-ID: <200906171732.n5HHWbhq027365@sheep.berlios.de>

Author: apreisser
Date: 2009-06-17 19:32:34 +0200 (Wed, 17 Jun 2009)
New Revision: 1921

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
Log:
Dialog selecting between visible and/or marked caches for performing move and copy operation in the DataMover

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-06-17 17:31:38 UTC (rev 1920)
+++ trunk/res_noewe/languages/DE.cfg	2009-06-17 17:32:34 UTC (rev 1921)
@@ -115,6 +115,16 @@
 		223=Filter l%f6schen?
 		224=+- Den gespeicherten Filter l%f6schen? 
 		225=Auch in Logs
+		250=ColleIsarcos Texte fuer den DataMover
+		251=Alle Wegpunkte werden gel%f6scht
+		252=Alle Wegpunkte werden verschoben
+		253=Alle Wegpunkte werden kopiert
+		254=Alle sichtbaren
+		255=Alle markierten
+		256=Alle sichtbaren und markierte
+		257=Haupt
+		258=Addis
+		259=Wollen Sie fortfahren?
 		299=Regul%e4rer Ausdruck
 		300=Type:
 		301=Gr%f6%dfe:

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-06-17 17:31:38 UTC (rev 1920)
+++ trunk/res_noewe/languages/EN.cfg	2009-06-17 17:32:34 UTC (rev 1921)
@@ -115,6 +115,16 @@
 		223=Delete filter?
 		224=+- Delete the saved filter?
 		225=Also in logs
+		250=ColleIsarcos texte used in  DataMover
+		251=All waypoints will be deleted
+		252=All waypoints will be moved
+		253=All waypoints will be copied
+		254=All visible
+		255=All ticked
+		256=All visible and ticked
+		257=Main
+		258=Addis
+		259=Do you really want to continue?
 		299=Regular expression
 		300=Type:
 		301=Size:

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-06-17 17:31:38 UTC (rev 1920)
+++ trunk/res_noewe/languages/FR.cfg	2009-06-17 17:32:34 UTC (rev 1921)
@@ -112,6 +112,16 @@
 		223=Effacer filtre?
 		224=+- Effacer ce filtre enregistr%e9?
 		225=Aussi dans logs
+		250=ColleIsarcos texte used in  DataMover
+		251=[All waypoints will be deleted]
+		252=[All waypoints will be moved]
+		253=[All waypoints will be copied]
+		254=[All visible]
+		255=[All ticked]
+		256=[All visible and ticked]
+		257=[Main]
+		258=[Addis]
+		259=[Do you really want to continue?]
 		299=Expression rationnelle
 		300=Type:
 		301=Gabarit:

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-06-17 17:31:38 UTC (rev 1920)
+++ trunk/res_noewe/languages/NL.cfg	2009-06-17 17:32:34 UTC (rev 1921)
@@ -104,6 +104,16 @@
 		223=Filter verwijderen?
 		224=+- Deze filter verwijderen?
 		225=Ook in logs
+		250=ColleIsarcos texte used in DataMover
+		251=[All waypoints will be deleted]
+		252=[All waypoints will be moved]
+		253=[All waypoint]s will be copied]
+		254=[All visible]
+		255=[All ticked]
+		256=[All visible and ticked]
+		257=[Main]
+		258=[Addis]
+		259=[Do you really want to continue?]
 		299=Reguliere expressie
 		300=Type:
 		301=Grote:



From apreisser at mail.berlios.de  Wed Jun 17 19:59:43 2009
From: apreisser at mail.berlios.de (apreisser at mail.berlios.de)
Date: Wed, 17 Jun 2009 19:59:43 +0200
Subject: [Cachewolf-svn] r1922 - trunk/src/CacheWolf
Message-ID: <200906171759.n5HHxhei015496@sheep.berlios.de>

Author: apreisser
Date: 2009-06-17 19:59:42 +0200 (Wed, 17 Jun 2009)
New Revision: 1922

Modified:
   trunk/src/CacheWolf/DataMover.java
Log:
A dialog is presented to decide whether visible or marked waypoints are to be moved or copied to another profile.

Modified: trunk/src/CacheWolf/DataMover.java
===================================================================
--- trunk/src/CacheWolf/DataMover.java	2009-06-17 17:32:34 UTC (rev 1921)
+++ trunk/src/CacheWolf/DataMover.java	2009-06-17 17:59:42 UTC (rev 1922)
@@ -1,7 +1,5 @@
 package CacheWolf;
 
-import java.util.BitSet;
-
 import utils.FileBugfix;
 import ewe.filechooser.FileChooser;
 import ewe.filechooser.FileChooserBase;
@@ -188,25 +186,25 @@
 		int count=0;
 		// Count the number of caches to move/delete/copy
 		// and remember the index of the files process, makes it a little bit easier
-		BitSet processSet = new BitSet();
+		boolean processSet[] = new boolean[size];
 		for(int i = 0; i<size; i++) {
 			switch (mode){
 			case 0:
 				if (srcDB.get(i).isVisible()){
 					count++;
-					processSet.set(i);
+					processSet[i]=true;
 				}
 				break;
 			case 1:
 				if (srcDB.get(i).is_Checked){
 					count++;
-					processSet.set(i);
+					processSet[i]=true;
 				}
 				break;
 			case 2:
 				if (srcDB.get(i).isVisible() && srcDB.get(i).is_Checked){
 					count++;
-					processSet.set(i);
+					processSet[i]=true;
 				}
 				break;
 			}
@@ -220,7 +218,7 @@
 		// Now do the actual work
 		for(int i = size-1; i>=0; i--){
 			CacheHolder srcHolder=srcDB.get(i);
-			if(processSet.get(i)){
+			if(processSet[i]){
 				h.progress = ((float)nProcessed++)/(float)count;
 				h.changed();
 				//Now do the copy/delete/move of the cache



From engywuck at mail.berlios.de  Wed Jun 17 20:13:08 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Wed, 17 Jun 2009 20:13:08 +0200
Subject: [Cachewolf-svn] r1923 - trunk/src/CacheWolf
Message-ID: <200906171813.n5HID8YS016487@sheep.berlios.de>

Author: engywuck
Date: 2009-06-17 20:13:07 +0200 (Wed, 17 Jun 2009)
New Revision: 1923

Modified:
   trunk/src/CacheWolf/Preferences.java
Log:
Restoring bugfix corrupted by last commit.

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-17 17:59:42 UTC (rev 1922)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-17 18:13:07 UTC (rev 1923)
@@ -540,7 +540,7 @@
 				entry = (MapEntry) itPath.next();
 				outp.print("    <impPath key = \"" + SafeXML.strxmlencode(entry.getKey().toString()) + "\" value = \"" + SafeXML.strxmlencode(entry.getValue().toString().replace('\\', '/')) + "\"/>\n");
 			}
-			outp.print("    <rater tool=\"".concat(rater).concat("\"/>\n"));
+			if (rater != null) outp.print("    <rater tool=\"".concat(rater).concat("\"/>\n"));
 			outp.print("</preferences>");
 			outp.close();
 		} catch (Exception e) {



From greiol at mail.berlios.de  Wed Jun 17 22:21:48 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Wed, 17 Jun 2009 22:21:48 +0200
Subject: [Cachewolf-svn] r1924 - trunk/res_noewe
Message-ID: <200906172021.n5HKLmGT027550@sheep.berlios.de>

Author: greiol
Date: 2009-06-17 22:21:47 +0200 (Wed, 17 Jun 2009)
New Revision: 1924

Modified:
   trunk/res_noewe/POIIcons.zip
Log:
change googleearth exporter icon names

Modified: trunk/res_noewe/POIIcons.zip
===================================================================
(Binary files differ)



From engywuck at mail.berlios.de  Thu Jun 18 17:43:41 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Thu, 18 Jun 2009 17:43:41 +0200
Subject: [Cachewolf-svn] r1925 - in trunk: res_noewe/languages src/CacheWolf
Message-ID: <200906181543.n5IFhfQd031178@sheep.berlios.de>

Author: engywuck
Date: 2009-06-18 17:43:34 +0200 (Thu, 18 Jun 2009)
New Revision: 1925

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/src/CacheWolf/MyComparer.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/myTableModel.java
Log:
New column in list: Number of DNF logs (also sortable).

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-06-17 20:21:47 UTC (rev 1924)
+++ trunk/res_noewe/languages/DE.cfg	2009-06-18 15:43:34 UTC (rev 1925)
@@ -323,8 +323,8 @@
 		1027=OC-Idx
 		1028=) l%f6schen?
 		1029=Es gibt angew%e4hlte aber nicht sichtbare Wegpunkte.%0a(Caches:+
-        1030=, zus%e4tzliche Wegpunkte:+
-        1031=Diese auch l%f6schen?
+		1030=, zus%e4tzliche Wegpunkte:+
+		1031=Diese auch l%f6schen?
 		1032=Pfad zum Browser:
 		1033=ist falsch!
 		1034=Browser kann nicht ge%f6ffnet werden!
@@ -341,6 +341,8 @@
 		1045=Addis ausblenden
 		1046=# Addis
 		1047=A
+		1048=# DNF Logs
+		1049=DNF
 		1100=Profile
 		1105=Suchen
 		1106=Profil w%e4hlen oder Neu

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-06-17 20:21:47 UTC (rev 1924)
+++ trunk/res_noewe/languages/EN.cfg	2009-06-18 15:43:34 UTC (rev 1925)
@@ -34,8 +34,8 @@
 		130=Download from opencaching.de
 		131=Spider from geocaching.com
 		132=to Explorist
-    133=Search all
-    134=Selected Cache
+		133=Search all
+		134=Selected Cache
 		139=Manage Travelbugs
 		140=Organise
 		141=Copy
@@ -341,6 +341,8 @@
 		1045=Hide Addis
 		1046=# Addis
 		1047=A
+		1048=# DNF logs
+		1049=DNF
 		1100=Profiles
 		1105=Browse
 		1106=Choose profile or New

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-06-17 20:21:47 UTC (rev 1924)
+++ trunk/res_noewe/languages/FR.cfg	2009-06-18 15:43:34 UTC (rev 1925)
@@ -330,6 +330,8 @@
 		1045=Cacher les wps additionelles
 		1046=# Addi.
 		1047=A
+		1048=# DNF logs
+		1049=DNF
 		1100=Profils
 		1105=Chercher
 		1106=Choiser profil ou cr%e9er-un 

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-06-17 20:21:47 UTC (rev 1924)
+++ trunk/res_noewe/languages/NL.cfg	2009-06-18 15:43:34 UTC (rev 1925)
@@ -305,6 +305,8 @@
 		1045=Verberg additionele waypoints
 		1046=# Addis
 		1047=A
+		1048=# DNF logs
+		1049=DNF
 		1100=Profielen
 		1105=Bladeren
 		1106=Kies profiel of nieuw.

Modified: trunk/src/CacheWolf/MyComparer.java
===================================================================
--- trunk/src/CacheWolf/MyComparer.java	2009-06-17 20:21:47 UTC (rev 1924)
+++ trunk/src/CacheWolf/MyComparer.java	2009-06-18 15:43:34 UTC (rev 1925)
@@ -118,6 +118,11 @@
 				CacheHolder ch =  cacheDB.get(i);
 				ch.sort=MyLocale.formatLong(ch.addiWpts.size(),"000");
 			}
+		} else if (colToCompare==18) {
+			for (int i=0; i<visibleSize; i++) {
+				CacheHolder ch =  cacheDB.get(i);
+				ch.sort=MyLocale.formatLong(ch.getNoFindLogs(),"000");
+			}
 		}
 	}
 	

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2009-06-17 20:21:47 UTC (rev 1924)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2009-06-18 15:43:34 UTC (rev 1925)
@@ -246,6 +246,7 @@
 				MyLocale.getMsg(1039,"Solver exists"),
 				MyLocale.getMsg(1041,"Note exists"),
 				MyLocale.getMsg(1046,"# Additionals"),
+				MyLocale.getMsg(11111, "# DNF Logs")
 				},pref.listColMap),MyLocale.getMsg(595,"List"),null);
 
 		mTab.addCard(tccBugs=new TableColumnChooser(new String[] {

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-17 20:21:47 UTC (rev 1924)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-18 15:43:34 UTC (rev 1925)
@@ -29,12 +29,12 @@
 	private int lastRow = -2;
 	private CacheDB cacheDB;
 	/** The max number of columns in the list view */
-	public static final int N_COLUMNS = 18;
+	public static final int N_COLUMNS = 19;
 	/** How the columns are mapped onto the list view. If colMap[i]=j, it means that
 	 * the element j (as per the list below) is visible in column i.
 	 * [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates,
 	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing, [12] Size, [13] # of OC recommend.
-	 * [14] OC index, [15] Solver exists, [16] Note exists, [17] # Additionals
+	 * [14] OC index, [15] Solver exists, [16] Note exists, [17] # Additionals, [18] # DNF
 	 */
 	private int[] colMap;
 	/** The column widths corresponding to the list of columns above */
@@ -44,7 +44,7 @@
 			MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),
 			MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear"),MyLocale.getMsg(1017,"S"),
 			MyLocale.getMsg(1026,"#Rec"),MyLocale.getMsg(1027,"OC-IDX"),MyLocale.getMsg(1038,"S"),
-			MyLocale.getMsg(1040,"N"),MyLocale.getMsg(1047,"A")};
+			MyLocale.getMsg(1040,"N"),MyLocale.getMsg(1047,"A"),MyLocale.getMsg(111111,"DNF")};
 
 	private static Image noFindLogs[] = new Image[4];
 	public static mImage red, blue, yellow; // skull, green
@@ -365,6 +365,12 @@
 						} else {
 							return "";
 						}
+					case 18: // Number of DNF logs
+						if (ch.getNoFindLogs()>0) {
+							return String.valueOf(ch.getNoFindLogs());
+						} else {
+							return "";
+						}
 				} // Switch
 			} // if
 		} catch (Exception e) {



From apreisser at mail.berlios.de  Thu Jun 18 20:21:44 2009
From: apreisser at mail.berlios.de (apreisser at mail.berlios.de)
Date: Thu, 18 Jun 2009 20:21:44 +0200
Subject: [Cachewolf-svn] r1926 - trunk/src/CacheWolf
Message-ID: <200906181821.n5IILi88019242@sheep.berlios.de>

Author: apreisser
Date: 2009-06-18 20:21:43 +0200 (Thu, 18 Jun 2009)
New Revision: 1926

Modified:
   trunk/src/CacheWolf/CacheHolder.java
Log:
CacheHolder no longer needs to implement Cloneable -> removed

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2009-06-18 15:43:34 UTC (rev 1925)
+++ trunk/src/CacheWolf/CacheHolder.java	2009-06-18 18:21:43 UTC (rev 1926)
@@ -18,7 +18,7 @@
  *	classes and methods to get more information.
  *	
  */
-public class CacheHolder implements Cloneable{
+public class CacheHolder{
 	protected static final String NOBEARING = "?";
 	protected static final String EMPTY = "";
 
@@ -1402,14 +1402,5 @@
 		Global.getProfile().notifyUnsavedChanges(hasNote != this.hasNote);		
 		this.hasNote = hasNote;
 	}
-
-	/**
-	 * Create a swallow-copy(!) no deep copy
-	 */
-	protected Object clone() throws CloneNotSupportedException {
-		return super.clone();
-	}
-
-	
 }
 



From engywuck at mail.berlios.de  Thu Jun 18 20:43:06 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Thu, 18 Jun 2009 20:43:06 +0200
Subject: [Cachewolf-svn] r1927 - trunk/src/CacheWolf
Message-ID: <200906181843.n5IIh6cR022022@sheep.berlios.de>

Author: engywuck
Date: 2009-06-18 20:43:04 +0200 (Thu, 18 Jun 2009)
New Revision: 1927

Modified:
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/myTableModel.java
Log:
Forgot to save files...

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2009-06-18 18:21:43 UTC (rev 1926)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2009-06-18 18:43:04 UTC (rev 1927)
@@ -246,7 +246,7 @@
 				MyLocale.getMsg(1039,"Solver exists"),
 				MyLocale.getMsg(1041,"Note exists"),
 				MyLocale.getMsg(1046,"# Additionals"),
-				MyLocale.getMsg(11111, "# DNF Logs")
+				MyLocale.getMsg(1048, "# DNF Logs")
 				},pref.listColMap),MyLocale.getMsg(595,"List"),null);
 
 		mTab.addCard(tccBugs=new TableColumnChooser(new String[] {

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-18 18:21:43 UTC (rev 1926)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-18 18:43:04 UTC (rev 1927)
@@ -44,7 +44,7 @@
 			MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),
 			MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear"),MyLocale.getMsg(1017,"S"),
 			MyLocale.getMsg(1026,"#Rec"),MyLocale.getMsg(1027,"OC-IDX"),MyLocale.getMsg(1038,"S"),
-			MyLocale.getMsg(1040,"N"),MyLocale.getMsg(1047,"A"),MyLocale.getMsg(111111,"DNF")};
+			MyLocale.getMsg(1040,"N"),MyLocale.getMsg(1047,"A"),MyLocale.getMsg(1049,"DNF")};
 
 	private static Image noFindLogs[] = new Image[4];
 	public static mImage red, blue, yellow; // skull, green



From engywuck at mail.berlios.de  Sun Jun 21 10:01:02 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Sun, 21 Jun 2009 10:01:02 +0200
Subject: [Cachewolf-svn] r1928 - in trunk: res_noewe/languages src/CacheWolf
Message-ID: <200906210801.n5L812To014808@sheep.berlios.de>

Author: engywuck
Date: 2009-06-21 10:00:57 +0200 (Sun, 21 Jun 2009)
New Revision: 1928

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/GPXImporter.java
   trunk/src/CacheWolf/MyComparer.java
   trunk/src/CacheWolf/OCXMLImporter.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/SpiderGC.java
   trunk/src/CacheWolf/myTableModel.java
Log:
The "last synced" date is now available as a column (sortable) and also available for GC caches (both when spidering and importing GPX).

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/res_noewe/languages/DE.cfg	2009-06-21 08:00:57 UTC (rev 1928)
@@ -343,6 +343,8 @@
 		1047=A
 		1048=# DNF Logs
 		1049=DNF
+		1050=Aktualisiert
+		1051=Zuletzt aktualisiert
 		1100=Profile
 		1105=Suchen
 		1106=Profil w%e4hlen oder Neu

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/res_noewe/languages/EN.cfg	2009-06-21 08:00:57 UTC (rev 1928)
@@ -343,6 +343,8 @@
 		1047=A
 		1048=# DNF logs
 		1049=DNF
+		1050=Last synced
+		1051=Last sync date
 		1100=Profiles
 		1105=Browse
 		1106=Choose profile or New

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/res_noewe/languages/FR.cfg	2009-06-21 08:00:57 UTC (rev 1928)
@@ -332,6 +332,8 @@
 		1047=A
 		1048=# DNF logs
 		1049=DNF
+		1050=Mis %e0 jour
+		1051=Date de mettre %e0 jour
 		1100=Profils
 		1105=Chercher
 		1106=Choiser profil ou cr%e9er-un 

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/res_noewe/languages/NL.cfg	2009-06-21 08:00:57 UTC (rev 1928)
@@ -307,6 +307,8 @@
 		1047=A
 		1048=# DNF logs
 		1049=DNF
+		1050=Ten laatste sync.
+		1051=Synchroniseert am
 		1100=Profielen
 		1105=Bladeren
 		1106=Kies profiel of nieuw.

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/src/CacheWolf/CacheHolder.java	2009-06-21 08:00:57 UTC (rev 1928)
@@ -100,7 +100,7 @@
 	/** If this is an additional waypoint, this links back to the main waypoint */
 	public CacheHolder mainCache;
 	/** The date this cache was last synced with OC in format yyyyMMddHHmmss */
-	private String lastSyncOC = EMPTY;
+	private String lastSync = EMPTY;
 	/** True if cache has solver entry */
 	private boolean hasSolver = false;
 	/** True if a note is entered for the cache */
@@ -278,7 +278,7 @@
 	
 			        start = xmlString.indexOf('"', end + 1);
 			        end = xmlString.indexOf('"', start + 1);
-			        setLastSyncOC(xmlString.substring(start + 1, end));
+			        setLastSync(xmlString.substring(start + 1, end));
 	
 			        start = xmlString.indexOf('"', end + 1);
 			        end = xmlString.indexOf('"', start + 1);
@@ -343,7 +343,7 @@
 		            
 		            start = xmlString.indexOf('"', end + 1);
 		            end = xmlString.indexOf('"', start + 1);
-		            setLastSyncOC(xmlString.substring(start + 1, end));
+		            setLastSync(xmlString.substring(start + 1, end));
 		            
 		            start = xmlString.indexOf('"', end + 1);
 		            end = xmlString.indexOf('"', start + 1);
@@ -500,7 +500,7 @@
 		this.setHas_bugs(ch.has_bugs());
 		this.setHTML(ch.is_HTML());
 		this.sort=ch.sort;
-		this.setLastSyncOC(ch.getLastSyncOC());
+		this.setLastSync(ch.getLastSync());
 
 		this.setAttributesYes(ch.getAttributesYes());
 		this.setAttributesNo(ch.getAttributesNo());
@@ -549,7 +549,7 @@
 		sb.append("\" wayp = \"");		sb.append(SafeXML.clean(getWayPoint()));
 		sb.append("\" status = \"");	sb.append(getCacheStatus());
 		sb.append("\" ocCacheID = \"" );sb.append(getOcCacheID()); 
-		sb.append("\" lastSyncOC = \"" );sb.append(getLastSyncOC()); 
+		sb.append("\" lastSyncOC = \"" );sb.append(getLastSync()); 
 		sb.append("\" num_recommended = \"");sb.append(Convert.formatInt(getNumRecommended())); 
 		sb.append("\" num_found = \"" );sb.append(Convert.formatInt(getNumFoundsSinceRecommendation()));
 		sb.append("\" attributesYes = \"" ); sb.append(Convert.formatLong(getAttributesYes()));
@@ -1358,13 +1358,13 @@
     	this.html = is_HTML;
     }
 
-	public String getLastSyncOC() {
-    	return lastSyncOC;
+	public String getLastSync() {
+    	return lastSync;
     }
 
-	public void setLastSyncOC(String lastSyncOC) {
-		Global.getProfile().notifyUnsavedChanges(!lastSyncOC.equals(this.lastSyncOC));		
-    	this.lastSyncOC = lastSyncOC;
+	public void setLastSync(String lastSync) {
+		Global.getProfile().notifyUnsavedChanges(!lastSync.equals(this.lastSync));		
+    	this.lastSync = lastSync;
     }
 
 	public long getAttributesYes() {

Modified: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/src/CacheWolf/GPXImporter.java	2009-06-21 08:00:57 UTC (rev 1928)
@@ -30,6 +30,7 @@
 	boolean fromOC = false;
 	boolean fromTC = false;
 	boolean nameFound = false;
+	static final Time gpxDate = new Time();
 	int zaehlerGel = 0;
 	public static final int DOIT_ASK = 0;
 	public static final int DOIT_NOSPOILER = 1;
@@ -344,11 +345,12 @@
 			return;
 		}
 		
+		if (name.equals("time") && !inWpt) {
+			gpxDate.parse(strData.substring(0,19),"yyyy-MM-dd'T'HH:mm:ss");
+			return;
+		}
+
 		if (name.equals("time") && inWpt) {
-			//String Date = new String();
-			//Date = strData.substring(5,7); // month
-			//Date += "/" + strData.substring(8,10); // day
-			//Date += "/" + strData.substring(0,4); // year
 			holder.setDateHidden(strData.substring(0,10)); //Date;
 			return;
 		}
@@ -359,6 +361,7 @@
 		
 		if (name.equals("name") && inWpt && !inCache) {
 			holder.setWayPoint(strData);
+			holder.setLastSync(gpxDate.format("yyyyMMddHHmmss"));
 			//msgA.setText("import " + strData);
 			return;
 		}

Modified: trunk/src/CacheWolf/MyComparer.java
===================================================================
--- trunk/src/CacheWolf/MyComparer.java	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/src/CacheWolf/MyComparer.java	2009-06-21 08:00:57 UTC (rev 1928)
@@ -123,8 +123,13 @@
 				CacheHolder ch =  cacheDB.get(i);
 				ch.sort=MyLocale.formatLong(ch.getNoFindLogs(),"000");
 			}
+		} else if (colToCompare==19) {
+			for (int i=0; i<visibleSize; i++) {
+				CacheHolder ch =  cacheDB.get(i);
+				ch.sort=ch.getLastSync();
+			}
 		}
-	}
+ 	}
 	
 	public int compare(Object o1, Object o2){
 		CacheHolder oo1 = (CacheHolder)o1;

Modified: trunk/src/CacheWolf/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/src/CacheWolf/OCXMLImporter.java	2009-06-21 08:00:57 UTC (rev 1928)
@@ -113,8 +113,8 @@
 		String lastS; 
 		if (reload)  lastS = "20050801000000";
 		else {
-			if (ch.getLastSyncOC().length() < 14) lastS = "20050801000000";
-			else lastS = ch.getLastSyncOC();
+			if (ch.getLastSync().length() < 14) lastS = "20050801000000";
+			else lastS = ch.getLastSync();
 		}
 		dateOfthisSync = new Time();
 		dateOfthisSync.parse(lastS, "yyyyMMddHHmmss");
@@ -426,7 +426,7 @@
 	// TODO Do we have to release the "holder" cache details ?
 	private void endCache(String name){
 		if (name.equals("cache")){
-			holder.setLastSyncOC(dateOfthisSync.format("yyyyMMddHHmmss"));
+			holder.setLastSync(dateOfthisSync.format("yyyyMMddHHmmss"));
 			int index;
 			index = cacheDB.getIndex(holder.getWayPoint());
 			if (index == -1){

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2009-06-21 08:00:57 UTC (rev 1928)
@@ -246,7 +246,8 @@
 				MyLocale.getMsg(1039,"Solver exists"),
 				MyLocale.getMsg(1041,"Note exists"),
 				MyLocale.getMsg(1046,"# Additionals"),
-				MyLocale.getMsg(1048, "# DNF Logs")
+				MyLocale.getMsg(1048, "# DNF Logs"),
+				MyLocale.getMsg(1051, "Last sync date")
 				},pref.listColMap),MyLocale.getMsg(595,"List"),null);
 
 		mTab.addCard(tccBugs=new TableColumnChooser(new String[] {

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/src/CacheWolf/SpiderGC.java	2009-06-21 08:00:57 UTC (rev 1928)
@@ -245,6 +245,7 @@
 					// the "found" state of an existing cache.
 					ch.setFound(true);
 				}
+				ch.setLastSync((new Time()).format("yyyyMMddHHmmss"));
 				cacheInDB.update(ch);
 				cacheInDB.save();
 			}

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-18 18:43:04 UTC (rev 1927)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-21 08:00:57 UTC (rev 1928)
@@ -26,15 +26,17 @@
 	private Color lineColorBG                   = new Color(255,255,255);
 	private Color lastColorBG                   = new Color(255,255,255);
 	private Color lastColorFG                   = new Color(0,0,0);
+	private static final Time lastSyncWorker = new Time();
 	private int lastRow = -2;
 	private CacheDB cacheDB;
 	/** The max number of columns in the list view */
-	public static final int N_COLUMNS = 19;
+	public static final int N_COLUMNS = 20;
 	/** How the columns are mapped onto the list view. If colMap[i]=j, it means that
 	 * the element j (as per the list below) is visible in column i.
 	 * [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates,
 	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing, [12] Size, [13] # of OC recommend.
 	 * [14] OC index, [15] Solver exists, [16] Note exists, [17] # Additionals, [18] # DNF
+	 * [19] Last Sync Date
 	 */
 	private int[] colMap;
 	/** The column widths corresponding to the list of columns above */
@@ -44,7 +46,8 @@
 			MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),
 			MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear"),MyLocale.getMsg(1017,"S"),
 			MyLocale.getMsg(1026,"#Rec"),MyLocale.getMsg(1027,"OC-IDX"),MyLocale.getMsg(1038,"S"),
-			MyLocale.getMsg(1040,"N"),MyLocale.getMsg(1047,"A"),MyLocale.getMsg(1049,"DNF")};
+			MyLocale.getMsg(1040,"N"),MyLocale.getMsg(1047,"A"),MyLocale.getMsg(1049,"DNF"),
+			MyLocale.getMsg(1051,"Last synced")};
 
 	private static Image noFindLogs[] = new Image[4];
 	public static mImage red, blue, yellow; // skull, green
@@ -371,6 +374,13 @@
 						} else {
 							return "";
 						}
+					case 19: // Last sync date
+						if (ch.getLastSync() != "") {
+							lastSyncWorker.parse(ch.getLastSync(),"yyyyMMddHHmmss");
+							return lastSyncWorker.format("yyyy-MM-dd HH:mm");
+						} else {
+							return "";
+						}
 				} // Switch
 			} // if
 		} catch (Exception e) {



From salzkammergut at mail.berlios.de  Sun Jun 21 14:41:27 2009
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 21 Jun 2009 14:41:27 +0200
Subject: [Cachewolf-svn] r1929 - trunk/src/CacheWolf
Message-ID: <200906211241.n5LCfRS7009786@sheep.berlios.de>

Author: salzkammergut
Date: 2009-06-21 14:41:25 +0200 (Sun, 21 Jun 2009)
New Revision: 1929

Modified:
   trunk/src/CacheWolf/myTableModel.java
Log:
LastSyncDate: Bugfix. Fixed exception when parsing empty string.

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-21 08:00:57 UTC (rev 1928)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-21 12:41:25 UTC (rev 1929)
@@ -375,7 +375,7 @@
 							return "";
 						}
 					case 19: // Last sync date
-						if (ch.getLastSync() != "") {
+						if (!ch.getLastSync().equals("")) {
 							lastSyncWorker.parse(ch.getLastSync(),"yyyyMMddHHmmss");
 							return lastSyncWorker.format("yyyy-MM-dd HH:mm");
 						} else {



From salzkammergut at mail.berlios.de  Sun Jun 21 15:01:54 2009
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 21 Jun 2009 15:01:54 +0200
Subject: [Cachewolf-svn] r1930 - trunk/src/CacheWolf
Message-ID: <200906211301.n5LD1s2L011171@sheep.berlios.de>

Author: salzkammergut
Date: 2009-06-21 15:01:53 +0200 (Sun, 21 Jun 2009)
New Revision: 1930

Modified:
   trunk/src/CacheWolf/SpiderGC.java
Log:
LastSyncDate: Bugfix. LastSyncDate was not set when spidering a new cache.

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2009-06-21 12:41:25 UTC (rev 1929)
+++ trunk/src/CacheWolf/SpiderGC.java	2009-06-21 13:01:53 UTC (rev 1930)
@@ -132,7 +132,7 @@
 				//Vm.debug("ViewState: " + viewstate);
 			} else
 				pref.log("[login]:Viewstate not found before login");
-			
+
 			if(start.indexOf(loginSuccess) > 0)
 				pref.log("[login]:Already logged in");
 			else {
@@ -183,13 +183,13 @@
 				pref.log("[login]:Viewstate not found");
 			}
 			viewstate = rexViewstate.stringMatched(1);
-			
+
 			rexViewstate1.search(start);
 			if (!rexViewstate1.didMatch()) {
 				pref.log("[login]:Viewstate1 not found");
 			}
 			viewstate1 = rexViewstate1.stringMatched(1);
-			
+
 			rexCookieID.search(start);
 			if (!rexCookieID.didMatch()) {
 				pref.log("[login]:CookieID not found. Using old one.");
@@ -245,7 +245,6 @@
 					// the "found" state of an existing cache.
 					ch.setFound(true);
 				}
-				ch.setLastSync((new Time()).format("yyyyMMddHHmmss"));
 				cacheInDB.update(ch);
 				cacheInDB.save();
 			}
@@ -322,7 +321,7 @@
 		}
 
 		boolean doNotgetFound = false;
-		
+
 		OCXMLImporterScreen options;
 		if (spiderAllFinds) {
 			options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"), OCXMLImporterScreen.MAXNUMBER|OCXMLImporterScreen.IMAGES| OCXMLImporterScreen.ISGC| OCXMLImporterScreen.TRAVELBUGS| OCXMLImporterScreen.MAXLOGS| OCXMLImporterScreen.TYPE);
@@ -335,7 +334,7 @@
 			String dist = options.distanceInput.getText();
 			if (dist.length()== 0) return;
 			distance = Common.parseDouble(dist);
-			
+
 			//save last radius to profile
 			Double distDouble = new Double();
 			distDouble.value = distance;
@@ -344,7 +343,7 @@
 
 			doNotgetFound = options.foundCheckBox.getState();
 		}
-		
+
 		int maxNumber = -1;
 		String maxNumberString = options.maxNumberInput.getText();
 		if (maxNumberString.length()!= 0) {
@@ -359,7 +358,7 @@
 
 		boolean getImages = options.imagesCheckBox.getState();
 		boolean getTBs = options.travelbugsCheckBox.getState();
-		
+
 		String cacheTypeRestriction = options.getCacheTypeRestriction(p);
 
 		options.close(0);
@@ -402,7 +401,7 @@
 				ln = p.getProp("firstPageFinds") + encodeUTF8URL(Utils.encodeJavaUtf8String(pref.myAlias));
 			} else {
 				ln = p.getProp("firstPage") + origin.getLatDeg(CWPoint.DD) + p.getProp("firstPage2") + origin.getLonDeg(CWPoint.DD)
-			                              + p.getProp("maxDistance") + Integer.toString( (int)saveDistanceInMiles );			
+			                              + p.getProp("maxDistance") + Integer.toString( (int)saveDistanceInMiles );
 				if(doNotgetFound) ln = ln + p.getProp("showOnlyFound");
 			}
 			ln = ln + cacheTypeRestriction;
@@ -432,7 +431,7 @@
 			//Loop till maximum distance has been found or no more caches are in the list
 			while(distance > 0){
 				if (infB.isClosed) break;
-						
+
 				rexViewstate.search(start);
 				if(rexViewstate.didMatch()){
 					viewstate = rexViewstate.stringMatched(1);
@@ -441,7 +440,7 @@
 					viewstate = "";
 					pref.log("Viewstate not found");
 				}
-				
+
 				rexViewstate1.search(start);
 				if(rexViewstate1.didMatch()){
 					viewstate1 = rexViewstate1.stringMatched(1);
@@ -450,14 +449,14 @@
 					viewstate1 = "";
 					pref.log("Viewstate1 not found");
 				}
-				
+
 				rexEventvalidation.search(start);
 				if(rexEventvalidation.didMatch()){
 					eventvalidation = rexEventvalidation.stringMatched(1);
 					//Vm.debug("EVENTVALIDATION: " + eventvalidation);
 				} else {
 					eventvalidation = "";
-					pref.log("Eventvalidation not found");					
+					pref.log("Eventvalidation not found");
 				}
 
 				//Vm.debug("In loop");
@@ -478,10 +477,10 @@
 						if((existingCache=cacheDB.get(waypoint)) == null){
 							if ( (maxNumber > 0) && (cachesToLoad.size() >= maxNumber) ) {
 								maxNumberAbort = true;
-								
+
 								//add no more caches
 								distance = 0;
-								
+
 								//don't update existing caches, because list is not correct when aborting
 								cachesToUpdate.clear();
 							} else {
@@ -504,7 +503,7 @@
 								ch.setAvailable(is_available_GC);
 							} else if (spiderAllFinds && !ch.is_found()) { // Update the database with the cache status
 								pref.log("Updating status of "+waypoint+" to found");
-								ch.setFound(true);								
+								ch.setFound(true);
 							} else {
 								cachesToUpdate.remove( ch.getWayPoint() );
 							}
@@ -512,7 +511,7 @@
 					} else distance = 0;
 					lineRex.searchFrom(dummy, lineRex.matchedTo());
 				}
-				
+
 				page++;
 				infB.setInfo(MyLocale.getMsg(5521,"Page ") + page + "\n" + MyLocale.getMsg(5511,"Found ") + cachesToLoad.size() + MyLocale.getMsg(5512," caches"));
 
@@ -521,7 +520,7 @@
 					postStr = p.getProp("firstLine");
 				} else {
 					postStr = p.getProp("firstLine") + origin.getLatDeg(CWPoint.DD) + "&" + origin.getLonDeg(CWPoint.DD)
-							                             + p.getProp("maxDistance") + Integer.toString( (int)saveDistanceInMiles );			
+							                             + p.getProp("maxDistance") + Integer.toString( (int)saveDistanceInMiles );
 					if(doNotgetFound) postStr = postStr + p.getProp("showOnlyFound");
 				}
 				postStr = postStr + cacheTypeRestriction;
@@ -567,7 +566,7 @@
 		boolean loadAllLogs = (MAXLOGS > 5);
 
 		int spiderErrors = 0;
-		
+
 		if ( cachesToUpdate.size() > 0 ) {
 			switch (pref.spiderUpdates) {
 			case Preferences.NO:
@@ -581,7 +580,7 @@
 				break;
 			}
 		}
-		
+
 		int totalCachesToLoad = cachesToLoad.size() + cachesToUpdate.size();
 
 		for(int i = 0; i<cachesToLoad.size(); i++){
@@ -601,13 +600,13 @@
 					spiderErrors++;
 				} else {
 					if (!holder.is_found() || !doNotgetFound ) {
-						cacheDB.add(holder); 
+						cacheDB.add(holder);
 						holder.save();
 					}
 				}
 			}
 		}
-		
+
 		if (!infB.isClosed) {
 			int j = 1;
 			for (Enumeration e = cachesToUpdate.elements() ; e.hasMoreElements() ; j++) {
@@ -621,18 +620,18 @@
 				} else if (test == 0) {
 					spiderErrors++;
 				} else {
-					//profile.hasUnsavedChanges=true;	
+					//profile.hasUnsavedChanges=true;
 				}
 			}
 		}
-		
+
 		infB.close(0);
 		Vm.showWait(false);
 		if ( spiderErrors > 0) {
 			new MessageBox(MyLocale.getMsg(5500,"Error"),spiderErrors + MyLocale.getMsg(5516," cache descriptions%0acould not be loaded."),FormBase.DEFOKB).execute();
 		}
 		if ( maxNumberAbort ) {
-			new MessageBox(MyLocale.getMsg(5519,"Information"),MyLocale.getMsg(5520,"Only the given maximum of caches were loaded.%0aRepeat spidering later to load more caches.%0aNo already existing caches were updated."),FormBase.DEFOKB).execute();			
+			new MessageBox(MyLocale.getMsg(5519,"Information"),MyLocale.getMsg(5520,"Only the given maximum of caches were loaded.%0aRepeat spidering later to load more caches.%0aNo already existing caches were updated."),FormBase.DEFOKB).execute();
 		}
 		Global.getProfile().restoreFilter();
 		Global.getProfile().saveIndex(Global.getPref(),true);
@@ -725,19 +724,19 @@
 						pref.log("Getting cache name");
 						ch.setCacheName(SafeXML.cleanback(getName(completeWebPage)));
 						if (pref.debug) pref.log("Name: " + ch.getCacheName()); else pref.log("Got name");
-						
+
 						pref.log("Trying location (country/state)");
 						String location = getLocation(completeWebPage);
 						if (location.length() != 0) {
 							int countryStart = location.indexOf(",");
 							if (countryStart > -1) {
 								ch.getFreshDetails().Country = SafeXML.cleanback(location.substring(countryStart + 1).trim());
-								ch.getFreshDetails().State = SafeXML.cleanback(location.substring(0, countryStart).trim());								
+								ch.getFreshDetails().State = SafeXML.cleanback(location.substring(0, countryStart).trim());
 							} else {
 								ch.getFreshDetails().Country = location.trim();
 								ch.getFreshDetails().State = "";
 							}
-							pref.log("Got location (country/state)");							
+							pref.log("Got location (country/state)");
 						} else {
 							ch.getFreshDetails().Country = "";
 							ch.getFreshDetails().State = "";
@@ -827,6 +826,11 @@
 						getAttributes(completeWebPage, ch.getFreshDetails());
 						pref.log("Got attributes");
 						//if (ch.is_new()) ch.setUpdated(false);
+						//==========
+						// Last sync date
+						//==========
+						ch.setLastSync((new Time()).format("yyyyMMddHHmmss"));
+
 						ch.setIncomplete(false);
 						break;
 					}catch(Exception ex){
@@ -841,7 +845,7 @@
 				pref.log(">>> Failed to spider cache. Number of retrys exhausted.");
 				int decision = (new MessageBox(MyLocale.getMsg(5500,"Error"),MyLocale.getMsg(5515,"Failed to load cache.%0aPleas check your internet connection.%0aRetry?"),FormBase.DEFOKB|FormBase.NOB|FormBase.CANCELB)).execute();
 				if ( decision == FormBase.IDOK ) {
-					continue;						
+					continue;
 				} else if ( decision == FormBase.IDNO ){
 					ret = 0;
 				} else {
@@ -920,10 +924,10 @@
 		inRex = new Regex(p.getProp("cacheLocationRex"));
 		inRex.search(doc);
 		if (!inRex.didMatch()) return "";
-						
+
 		return inRex.stringMatched(1);
 	}
-		
+
 	/**
 	 * Get the cache name
 	 * @param doc A previously fetched cachepage
@@ -1214,7 +1218,7 @@
 		}
 		while(exImgSrc.endOfSearch() == false){
 			imgUrl = exImgSrc.findNext();
-			imgComment = exImgComment.findNext(); 
+			imgComment = exImgComment.findNext();
 			//Vm.debug("Img Url: " +imgUrl);
 			if(imgUrl.length()>0){
 				imgUrl = "http://" + imgUrl;
@@ -1281,7 +1285,7 @@
 		}
 	}
 
-	
+
 	/**
 	 * Read an image from the server
 	 * @param imgUrl The Url of the image
@@ -1312,7 +1316,7 @@
 					connImg=connImg.getRedirectedConnection(redirect);
 					pref.log("Redirect to "+redirect);
 				}
-			} while(redirect!=null); // TODO this can end up in an endless loop if trying to load from a malicous site 
+			} while(redirect!=null); // TODO this can end up in an endless loop if trying to load from a malicous site
 			daten = connImg.readData(sockImg);
 			fos = new FileOutputStream(new File(datei));
 			fos.write(daten.toBytes());
@@ -1356,7 +1360,7 @@
 				String adWayPoint;
 				if (prefix.length()==2)
 					adWayPoint=prefix+wayPoint.substring(2);
-				else	
+				else
 				    adWayPoint = MyLocale.formatLong(counter, "00") + wayPoint.substring(2);
 				counter++;
 				int idx=profile.getCacheIndex(adWayPoint);
@@ -1366,7 +1370,7 @@
 					hd.setWayPoint(adWayPoint);
 					hd.getExistingDetails(); // Accessing Details reads file if not yet done
 				} else {
-					hd=new CacheHolder(); 
+					hd=new CacheHolder();
 					hd.setWayPoint(adWayPoint);
 				}
 				hd.initStates(idx<0);
@@ -1428,7 +1432,7 @@
 			HttpConnection conn;
 			if(pref.myproxy.length() > 0 && pref.proxyActive){
 				pref.log("[fetch]:Using proxy: " + pref.myproxy + " / " +pref.myproxyport);
-			} 
+			}
 			conn = new HttpConnection(address);
 			conn.setRequestorProperty("User-Agent", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
 			if(cookieSession.length()>0){
@@ -1484,7 +1488,7 @@
 			CharArray c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
 			sock.close();
 			return getResponseHeaders(conn)+c_data.toString();
-		} catch (Exception e) {	
+		} catch (Exception e) {
 			Global.getPref().log("Ignored Exception", e, true);
 		}
 		return "";
@@ -1508,8 +1512,8 @@
 		}
 		return "";
 	}
-	
-	
+
+
 	final static String hex = ewe.util.TextEncoder.hex;
 
 	public String encodeUTF8URL(byte[] what) {
@@ -1526,7 +1530,7 @@
 			} else dest[d++] = c;
 		}
 		return new String(dest,0,d);
-	}	
+	}
 
 	/**
 	 * Load the bug id for a given name. This method is not ideal, as there are
@@ -1618,7 +1622,7 @@
 			return "";
 		}
 	}
-	
+
 	/**
 	 * Fetch a bug's mission and namefor a given tracking number
 	 * @param TB the travelbug



From engy at gmx.de  Sun Jun 21 15:15:14 2009
From: engy at gmx.de (Thorsten Koch)
Date: Sun, 21 Jun 2009 15:15:14 +0200
Subject: [Cachewolf-svn] r1929 - trunk/src/CacheWolf
In-Reply-To: <200906211241.n5LCfRS7009786@sheep.berlios.de>
Message-ID: <CAEPJMOJFPDFLJPPPINOIEBMDEAA.engy@gmx.de>

> -	if (ch.getLastSync() != "") {
> +	if (!ch.getLastSync().equals("")) {

*blush*

E.



From salzkammergut at mail.berlios.de  Sun Jun 21 20:45:31 2009
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 21 Jun 2009 20:45:31 +0200
Subject: [Cachewolf-svn] r1931 - trunk/src/CacheWolf
Message-ID: <200906211845.n5LIjVCY017362@sheep.berlios.de>

Author: salzkammergut
Date: 2009-06-21 20:45:28 +0200 (Sun, 21 Jun 2009)
New Revision: 1931

Modified:
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/myTableModel.java
Log:
Bugfix: Exception when opening preferences with an empty pref.xml (http://www.geoclub.de/viewtopic.php?f=40&t=35282)

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-21 13:01:53 UTC (rev 1930)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-21 18:45:28 UTC (rev 1931)
@@ -155,7 +155,7 @@
 	/** The list of visible columns in the list view */
 	public String listColMap="0,1,2,3,4,5,6,7,8,9,10,11,12";
 	/** The widths for each column in list view */
-	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104,22,30,30,30,30,30";
+	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104,22,30,30,30,30,30,30,30";
 	/** The columns which are to be displayed in TravelbugsJourneyScreen. See also TravelbugJourney */
 	public String travelbugColMap="1,4,5,6,8,9,10,7";
 	/** The column widths for the travelbug journeys. */
@@ -222,10 +222,10 @@
 	public boolean downloadTBs = true;
 	/** Last mode select in the DataMover for processing cache*/
 	public int processorMode = 0;
-	
+
 	/** external Cacherating software */
 	public String rater;
-	
+
 	//////////////////////////////////////////////
 	/** The debug switch (Can be used to activate dormant code) by adding
 	 * the line: <pre><debug value="true"></pre>
@@ -456,7 +456,7 @@
 			if (tmp != null){
 				processorMode=Convert.parseInt(tmp);
 			}
-			
+
 		}
 
 	}

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-21 13:01:53 UTC (rev 1930)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-21 18:45:28 UTC (rev 1931)
@@ -37,6 +37,8 @@
 	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing, [12] Size, [13] # of OC recommend.
 	 * [14] OC index, [15] Solver exists, [16] Note exists, [17] # Additionals, [18] # DNF
 	 * [19] Last Sync Date
+	 *
+	 * Attention: When adding columns here, also add a default with in Preferences.listColWidth
 	 */
 	private int[] colMap;
 	/** The column widths corresponding to the list of columns above */



From salzkammergut at mail.berlios.de  Sun Jun 21 20:51:03 2009
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 21 Jun 2009 20:51:03 +0200
Subject: [Cachewolf-svn] r1932 - trunk/src/CacheWolf
Message-ID: <200906211851.n5LIp3IL017875@sheep.berlios.de>

Author: salzkammergut
Date: 2009-06-21 20:51:02 +0200 (Sun, 21 Jun 2009)
New Revision: 1932

Modified:
   trunk/src/CacheWolf/myTableModel.java
Log:
Spelling correction (with => width)

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-06-21 18:45:28 UTC (rev 1931)
+++ trunk/src/CacheWolf/myTableModel.java	2009-06-21 18:51:02 UTC (rev 1932)
@@ -38,7 +38,7 @@
 	 * [14] OC index, [15] Solver exists, [16] Note exists, [17] # Additionals, [18] # DNF
 	 * [19] Last Sync Date
 	 *
-	 * Attention: When adding columns here, also add a default with in Preferences.listColWidth
+	 * Attention: When adding columns here, also add a default width in Preferences.listColWidth
 	 */
 	private int[] colMap;
 	/** The column widths corresponding to the list of columns above */



From greiol at mail.berlios.de  Mon Jun 22 18:23:40 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Mon, 22 Jun 2009 18:23:40 +0200
Subject: [Cachewolf-svn] r1933 - trunk/src/CacheWolf
Message-ID: <200906221623.n5MGNe6b011046@sheep.berlios.de>

Author: greiol
Date: 2009-06-22 18:23:39 +0200 (Mon, 22 Jun 2009)
New Revision: 1933

Modified:
   trunk/src/CacheWolf/CacheSize.java
Log:
virtual size was displayed in details panel but could not be resolved back to cachewold type

Modified: trunk/src/CacheWolf/CacheSize.java
===================================================================
--- trunk/src/CacheWolf/CacheSize.java	2009-06-21 18:51:02 UTC (rev 1932)
+++ trunk/src/CacheWolf/CacheSize.java	2009-06-22 16:23:39 UTC (rev 1933)
@@ -486,6 +486,8 @@
 			return CW_SIZE_NONE;
 		} else if (id.equals(GC_SIZE_MICRO)) {
 			return CW_SIZE_MICRO;
+		} else if (id.equals(GC_SIZE_VIRTUAL)) {
+			return CW_SIZE_VIRTUAL;
 		} else {
 			throw (new IllegalArgumentException("unmatched argument " + id + " in guiSizeStrings2CwSize()"));
 		}



From araber95 at mail.berlios.de  Mon Jun 22 19:35:14 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Mon, 22 Jun 2009 19:35:14 +0200
Subject: [Cachewolf-svn] r1934 - in trunk/res_noewe/webmapservices: .
	untested
Message-ID: <200906221735.n5MHZEZ0004570@sheep.berlios.de>

Author: araber95
Date: 2009-06-22 19:34:57 +0200 (Mon, 22 Jun 2009)
New Revision: 1934

Added:
   trunk/res_noewe/webmapservices/de-rp_p.wms
   trunk/res_noewe/webmapservices/de-rp_t25.wms
   trunk/res_noewe/webmapservices/de-rp_t50.wms
Removed:
   trunk/res_noewe/webmapservices/de-rlp_photo.wms
   trunk/res_noewe/webmapservices/de-rlp_topo_50.wms
Modified:
   trunk/res_noewe/webmapservices/untested/de-rp_p.wms
Log:
wms for Rheinland-Pfalz : corrected bounding boxes corresponding to capabilities, added TK25 , checked scaling possibilities.

Deleted: trunk/res_noewe/webmapservices/de-rlp_photo.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-rlp_photo.wms	2009-06-22 16:23:39 UTC (rev 1933)
+++ trunk/res_noewe/webmapservices/de-rlp_photo.wms	2009-06-22 17:34:57 UTC (rev 1934)
@@ -1,20 +0,0 @@
-# please refer to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.rlp Luftbild
-MapType:	photo
-MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=freedop%3Adop
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   0.5
-MaxScale:   24.95
-RecommendedScale:	0.4
-ImageFileExtension: .png 

Deleted: trunk/res_noewe/webmapservices/de-rlp_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-rlp_topo_50.wms	2009-06-22 16:23:39 UTC (rev 1933)
+++ trunk/res_noewe/webmapservices/de-rlp_topo_50.wms	2009-06-22 17:34:57 UTC (rev 1934)
@@ -1,20 +0,0 @@
-# please refer to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.rlp Topo 50
-MapType:	topo
-MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=rlp%3Atk50
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   7.001
-MaxScale:   15.0
-RecommendedScale:	5.0
-ImageFileExtension: .png 
\ No newline at end of file

Added: trunk/res_noewe/webmapservices/de-rp_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-rp_p.wms	2009-06-22 16:23:39 UTC (rev 1933)
+++ trunk/res_noewe/webmapservices/de-rp_p.wms	2009-06-22 17:34:57 UTC (rev 1934)
@@ -0,0 +1,29 @@
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.Rheinland-Pfalz photo SF=0,36..17,6
+MapType:	photo
+MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:   31466 31467
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:   REQUEST=GetMap
+#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
+#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
+#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
+#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
+#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
+#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
+#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
+#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
+#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
+LayersUrlPart:   LAYERS=freedop%3Adop
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 51.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 48.8000 E 8.7000
+MinScale:   0.5
+MaxScale:   24.95
+RecommendedScale:	0.4
+ImageFileExtension: .jpg 
+# weitergehende Skaliwerungen nicht gepr?ft
\ No newline at end of file

Added: trunk/res_noewe/webmapservices/de-rp_t25.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-rp_t25.wms	2009-06-22 16:23:39 UTC (rev 1933)
+++ trunk/res_noewe/webmapservices/de-rp_t25.wms	2009-06-22 17:34:57 UTC (rev 1934)
@@ -0,0 +1,29 @@
+TakenFromUrl:       http://www.vermkv.rlp.de
+GetCapabilitiesUrl: http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Rheinland-Pfalz t25 sf=0,5..6
+MapType:                        topo
+MainUrl:            http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31466 31467
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
+#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
+#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
+#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
+#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
+#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
+#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
+#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
+#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
+LayersUrlPart:     LAYERS=rlp%3Atk25
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 51.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 48.8000 E 8.7000
+MinScale:   1
+MaxScale:   50
+RecommendedScale:   2,5
+ImageFileExtension: .png
+#nimmt wohl alle Skalierungen

Added: trunk/res_noewe/webmapservices/de-rp_t50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-rp_t50.wms	2009-06-22 16:23:39 UTC (rev 1933)
+++ trunk/res_noewe/webmapservices/de-rp_t50.wms	2009-06-22 17:34:57 UTC (rev 1934)
@@ -0,0 +1,29 @@
+TakenFromUrl:       http://www.vermkv.rlp.de
+GetCapabilitiesUrl: http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Rheinland-Pfalz t50 sf=4..12
+MapType:                        topo
+MainUrl:            http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31466 31467
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
+#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
+#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
+#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
+#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
+#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
+#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
+#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
+#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
+LayersUrlPart:     LAYERS=rlp%3Atk50
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 51.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 48.8000 E 8.7000
+MinScale:   1
+MaxScale:   50
+RecommendedScale:   5
+ImageFileExtension: .png
+#nimmt wohl alle Skalierungen

Modified: trunk/res_noewe/webmapservices/untested/de-rp_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/de-rp_p.wms	2009-06-22 16:23:39 UTC (rev 1933)
+++ trunk/res_noewe/webmapservices/untested/de-rp_p.wms	2009-06-22 17:34:57 UTC (rev 1934)
@@ -1,6 +1,6 @@
 TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
 GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.Rheinland-Pfalz photo
+Name:	de.Rheinland-Pfalz photo SF=0,36..17,6
 MapType:	photo
 MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
 ServiceTypeUrlPart:	SERVICE=WMS 



From araber95 at mail.berlios.de  Mon Jun 22 19:36:43 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Mon, 22 Jun 2009 19:36:43 +0200
Subject: [Cachewolf-svn] r1935 - trunk/res_noewe/webmapservices/untested
Message-ID: <200906221736.n5MHahcH006568@sheep.berlios.de>

Author: araber95
Date: 2009-06-22 19:36:40 +0200 (Mon, 22 Jun 2009)
New Revision: 1935

Removed:
   trunk/res_noewe/webmapservices/untested/de-rp_p.wms
   trunk/res_noewe/webmapservices/untested/de-rp_t50.wms
Log:
wms for Rheinland-Pfalz : deleted the untested

Deleted: trunk/res_noewe/webmapservices/untested/de-rp_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/de-rp_p.wms	2009-06-22 17:34:57 UTC (rev 1934)
+++ trunk/res_noewe/webmapservices/untested/de-rp_p.wms	2009-06-22 17:36:40 UTC (rev 1935)
@@ -1,28 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.Rheinland-Pfalz photo SF=0,36..17,6
-MapType:	photo
-MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:   REQUEST=GetMap
-#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
-#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
-#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
-#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
-#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
-#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
-#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
-#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
-#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
-LayersUrlPart:   LAYERS=freedop%3Adop
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   0.5
-MaxScale:   24.95
-RecommendedScale:	0.4
-ImageFileExtension: .png 

Deleted: trunk/res_noewe/webmapservices/untested/de-rp_t50.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/de-rp_t50.wms	2009-06-22 17:34:57 UTC (rev 1934)
+++ trunk/res_noewe/webmapservices/untested/de-rp_t50.wms	2009-06-22 17:36:40 UTC (rev 1935)
@@ -1,28 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.Rheinland-Pfalz topo 50
-MapType:	topo
-MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
-#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
-#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
-#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
-#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
-#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
-#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
-#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
-#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=rlp%3Atk50
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   1
-MaxScale:   45
-RecommendedScale:	5.0
-ImageFileExtension: .png 
\ No newline at end of file



From araber95 at mail.berlios.de  Tue Jun 23 15:55:23 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Tue, 23 Jun 2009 15:55:23 +0200
Subject: [Cachewolf-svn] r1936 - in trunk/res_noewe/webmapservices: .
	untested
Message-ID: <200906231355.n5NDtNQE015807@sheep.berlios.de>

Author: araber95
Date: 2009-06-23 15:55:20 +0200 (Tue, 23 Jun 2009)
New Revision: 1936

Added:
   trunk/res_noewe/webmapservices/de-th_t25.wms
Removed:
   trunk/res_noewe/webmapservices/de-th_photo.wms
   trunk/res_noewe/webmapservices/de-th_topo_50.wms
   trunk/res_noewe/webmapservices/untested/de-th_p.wms
   trunk/res_noewe/webmapservices/untested/de-th_t50.wms
Log:
new wms-server for Th??ringen : works , but can be extended. layerslection , Scale hints. to check Boundingbox.

Deleted: trunk/res_noewe/webmapservices/de-th_photo.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-th_photo.wms	2009-06-22 17:36:40 UTC (rev 1935)
+++ trunk/res_noewe/webmapservices/de-th_photo.wms	2009-06-23 13:55:20 UTC (rev 1936)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.thueringen.de/de/tlvermgeo/onlineservice/web_map_service/content.html
-GetCapabilitiesUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de.th Luftbild
-MapType:	photo
-MainUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31468
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Orthophotos_TH-2m
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84:	N 52.0000 E 9.5000
-BoundingBoxButtomRightWGS84:	N 50.0000 E 13.0000
-MinScale:   0.399122
-MaxScale:   9.97806
-RecommendedScale:   2.0
-ImageFileExtension: .jpg
-

Added: trunk/res_noewe/webmapservices/de-th_t25.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-th_t25.wms	2009-06-22 17:36:40 UTC (rev 1935)
+++ trunk/res_noewe/webmapservices/de-th_t25.wms	2009-06-23 13:55:20 UTC (rev 1936)
@@ -0,0 +1,358 @@
+TakenFromUrl:       http://www.geoproxy.geoportal-th.de
+GetCapabilitiesUrl: http://www.geoproxy.geoportal-th.de/geoproxy/services?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Th?ringen t25 SF=~1..8
+MapType:                        topo
+MainUrl:            http://www.geoproxy.geoportal-th.de/geoproxy/services?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31467 31468
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31467 SRS=EPSG:31468 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=TZV|Zweckverbaende Trinkwasser|279.99972|6.99972
+#LayersUrlPart:     LAYERS=BNTNUTZ11|Landnutzung aus BNT 11|27.99972|1.39972
+#LayersUrlPart:     LAYERS=BNTNUTZ25|Landnutzung aus BNT 25|27.99972|1.39972
+#LayersUrlPart:     LAYERS=bodengeologie|Bodengeologische Karte|55.99972|2.79972
+#LayersUrlPart:     LAYERS=tempdiff_j|Temperaturdifferenz ganzjaehrig|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempdiff_w|Temperaturdifferenz Winter|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempmittel_f|Prognose Temperaturmittel Fruehling|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempmittel_s|Prognose Temperaturmittel Sommer|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempmittel_w|Prognose Temperaturmittel Winter|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempmittel_j|Prognose Temperaturmittel Jahr|279.99972|6.99972
+#LayersUrlPart:     LAYERS=th_eigentum_fl|Waldeigentum|6.99972|0.13972
+#LayersUrlPart:     LAYERS=zweckverband|Zweckverbaende Abwasser|279.99972|6.99972
+#LayersUrlPart:     LAYERS=dgk2007|digitale Grundkarte Landwirtschaft|25.19974|0.05571
+#LayersUrlPart:     LAYERS=gesamtkarte|Geothermiekarte|139.99972|2.79972
+#LayersUrlPart:     LAYERS=naturraum|Naturraeume|279.99972|6.99972
+#LayersUrlPart:     LAYERS=ffh_geb|Fauna-Flora-Habitat - Gebiet|279.99972|1.39972
+#LayersUrlPart:     LAYERS=nsg|Naturschutzgebiete|279.99972|1.39972
+#LayersUrlPart:     LAYERS=lsg|Landschaftsschutzgebiete|279.99972|1.39972
+#LayersUrlPart:     LAYERS=naturpark|Naturpark|279.99972|1.39972
+#LayersUrlPart:     LAYERS=nationalpark|Nationalpark|279.99972|1.39972
+#LayersUrlPart:     LAYERS=biosreserv|Biosphaerenreservat|279.99972|1.39972
+#LayersUrlPart:     LAYERS=z1fthue|Wasserschutzgebiete Zone 1|279.99972|1.39972
+#LayersUrlPart:     LAYERS=z2fthue|Wasserschutzgebiete Zone 2|279.99972|1.39972
+#LayersUrlPart:     LAYERS=z3fthue|Wasserschutzgebiete Zone 3|279.99972|1.39972
+#LayersUrlPart:     LAYERS=spa|Vogelschutzgebiete|279.99972|1.39972
+#LayersUrlPart:     LAYERS=firmen|Firmen|1.0E8|0.0
+#LayersUrlPart:     LAYERS=gewerbegebiet|Gewerbegebiet|1.0E8|0.0
+#LayersUrlPart:     LAYERS=gewerbeflaeche|Gewerbeflaeche|1.0E8|0.0
+#LayersUrlPart:     LAYERS=blattschnitt_tk10|TK10|1400.00028|6.99972
+#LayersUrlPart:     LAYERS=blattschnitt_tk25|TK25|1400.00028|6.99972
+#LayersUrlPart:     LAYERS=blattschnitt_tk50|TK50|1400.00028|6.99972
+#LayersUrlPart:     LAYERS=blattschnitt_tk100|TK100|1400.00028|6.99972
+#LayersUrlPart:     LAYERS=flurstuecksgrenzen|Flurstuecksgrenzen|1.40028|0.02772
+#LayersUrlPart:     LAYERS=politgrenzen|Polit. Grenzen|1.40028|0.02772
+#LayersUrlPart:     LAYERS=gebaeude|Gebaeude|1.40028|0.02772
+#LayersUrlPart:     LAYERS=nutzungsarten|Nutzungsarten|1.40028|0.02772
+#LayersUrlPart:     LAYERS=topografie|Topografie|1.40028|0.02772
+#LayersUrlPart:     LAYERS=strassennamen|Strassennamen|1.40028|0.02772
+#LayersUrlPart:     LAYERS=alk_gesamt|ALK Gesamt|1.40028|0.02772
+#LayersUrlPart:     LAYERS=alb_ohne|Flurstuecksinformationen|1.40028|0.02772
+#LayersUrlPart:     LAYERS=alb_bkz|Flurstuecksinformationen ThuerDSG|1.40028|0.02772
+#LayersUrlPart:     LAYERS=landesgrenzen|Landesgrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=kreisgrenzen|Kreisgrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=gemeindegrenzen|Gemeindegrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=gemarkungsgrenzen|Gemarkungsgrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=flurgrenzen|Flurgrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=rahmenkarten|Rahmenkarten|280.00028|0.55972
+#LayersUrlPart:     LAYERS=bearbeitungsstand|Bearbeitungsstand|280.00028|0.55972
+#LayersUrlPart:     LAYERS=alk_fl|Flurstuecke|1.40028|0.02772
+#LayersUrlPart:     LAYERS=alk_geb|Gebaeude|1.40028|0.02772
+#LayersUrlPart:     LAYERS=geofp_l|Lagefestpunkte|14.00028|0.13972
+#LayersUrlPart:     LAYERS=geofp_h|Hoehenfestpunkte|14.00028|0.13972
+#LayersUrlPart:     LAYERS=dtk10col|DTK10 Kombination farbig|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10acke|Ackerflaeche, Sonderkultur|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10babl|Gewaesserkontur u. -schrift|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10baum|NSG, gruene Symbole u. Schrift|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10brac|Heide, Moor, Sumpf, Klaerbecken|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10grau|Industrie- u. Gewerbeflaeche|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10grbr|Grundriss|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10haus|Gebaeude (nicht oeffentl.)|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10hrot|Bebauungsflaeche|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10park|Gruenanlage, Sport, Friedhof, Gartenland|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10rebr|Relief|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10rot|Gebaeude (oeffentl.) u. Truppenuebungplatz|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10schw|Eisenbahn, schwarze Symbole|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10sebl|Gewaesserfuellung|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10stge|Landesstrasse|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10stor|Autobahn, Bundesstrasse|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10swtx|Schrift schwarz|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10utmg|UTM-Gitter|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10viol|Verwaltungsgrenze|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10wald|Wald- u. Gehoelzflaeche|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10weis|untergeordnete Strasse u. Symbolfuellung|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10wies|Gruenland, Flugplatz|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk25acke|Ackerflaeche, Sonderkultur|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25babl|Gewaesserkontur u. -schrift|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25baum|NSG, gruene Symbole u. Schrift|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25brac|Heide, Moor, Sumpf, Klaerbecken|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25col|DTK25 Kombination farbig|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25ein|DTK25 Kombination einfarbig|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25grau|Industrie- u. Gewerbeflaeche|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25haus|Gebaeude (nicht oeffentl.)|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25hrot|Bebauungsflaeche|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25park|Gruenanlage, Sport, Friedhof, Gartenland|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25rebr|Relief|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25rot|Gebaeude (oeffentl.) u. Truppenuebungplatz|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25schw|Eisenbahn, schwarze Symbole|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25sebl|Gewaesserfuellung|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25stge|Landesstrasse|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25stor|Autobahn, Bundesstrasse|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25swtx|Schrift schwarz|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25utmg|UTM-Gitter|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25viol|Verwaltungsgrenze|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25wald|Wald- u. Gehoelzflaeche|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25weis|untergeordnete Strasse u. Symbolfuellung|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25wies|Gruenland, Flugplatz|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25grbr|Grundriss|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25babl|Gewaesser|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25col|DTK25-V Kombination farbig|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25rebrv|Relief|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25schw|Grundriss u. Schrift|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25wald|Waldflaeche|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk50acke|Gartenland, Sonderkultur|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50babl|Gewaesserkontur u. -schrift|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50baum|NSG, gruene Symbole u. Schrift|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50col|DTK50 Kombination farbig|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50ein|DTK50 Kombination einfarbig|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50grau|Industrie- u. Gewerbeflaeche|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50grbr|Grundriss u. Schrift braun|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50hrot|Bebauung offen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50mrot|Bebauung geschlossen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50rebr|Relief|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50rot|Truppenuebungplatz|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50schw|Grundriss schwarz|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50sebl|Gewaesserfuellung|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50stge|Landesstrasse|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50stor|Autobahn, Bundesstrasse|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50swtx|Schrift schwarz|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50utmg|UTM-Gitter|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50viol|Verwaltungsgrenze|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50wald|Wald- u. Gehoelzflaeche|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50weis|untergeordnete Strasse u. Symbolfuellung|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50wies|Friedhof|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50SCHW|Grundriss|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50STGE|Staats- und Landesstrassen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50BABL|Gewaesserkonturen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50REBR|Hoehenlinien|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50STOR|Autobahnen und Bundesstrassen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50COL|DTK50-V Kombination farbig|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50SEBL|Gewaesser|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50SWTX|Schrift|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50WALD|Waldflaechen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtkv100babl|Gewaesserkontur u. -schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100colv|DTK100-V Kombination farbig|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100hrot|Bebauungsflaeche|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100rebr|Relief|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100rot|Truppenuebungsplatz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100schw|Grundriss u. Schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100sebl|Gewaesserfuellung|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100stor|Autobahn u. Bundesstrasse|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100swtx|Schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100wald|Waldflaeche|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100ein|DTK100 Kombination einfarbig|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100col|DTK100 Kombination farbig|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100swtx|Schrift schwarz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100schw|Grundriss schwarz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100utmg|UTM-Gitter|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100grbr|Grundriss u. Schrift braun|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100rebr|Relief|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100babl|Gewaesserkontur u. -schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100baum|NSG, gruene Symbole u. Schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100viol|Verwaltungsgrenze|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100stor|Autobahn, Bundesstrasse|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100stge|Landesstrasse|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100haus|Gebaeude (nicht oeffentl.)|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100trup|Truppenuebungplatz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100heid|Heide|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100mrot|Bebauung geschlossen|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100hrot|Bebauung offen|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100grau|Industrie- u. Gewerbeflaeche|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100sebl|Gewaesserfuellung|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100acke|Gartenland, Sonderkultur|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100brac|Brachflaechen|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100wald|Wald- u. Gehoelzflaeche|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100wies|Gruenland, Flugplatz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100park|Gruenanlage, Sport, Friedhof, Gartenland|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100weis|untergeordnete Strasse u. Symbolfuellung|42.00028|8.39972
+#LayersUrlPart:     LAYERS=TH250|Uebersicht Thueringen|1400.00028|252.00028
+#LayersUrlPart:     LAYERS=GGK250|Gemeindegrenzenkarte Thueringen|280.00028|9.80028
+#LayersUrlPart:     LAYERS=UEK250|UEK250 Thueringen|280.00028|13.99972
+#LayersUrlPart:     LAYERS=dop20c|Digitale Orthophotos Farbe|9.80028|0.06972
+#LayersUrlPart:     LAYERS=dop20sw|Digitale Orthophotos Grau|9.80028|0.06972
+#LayersUrlPart:     LAYERS=dop2c|Digitale Orthophotos Farbe (2m)|252.00028|6.99972
+#LayersUrlPart:     LAYERS=dop2sw|Digitale Orthophotos Grau (2m)|252.00028|6.99972
+#LayersUrlPart:     LAYERS=OTF_2101|Ortslage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2111|Wohnbauflaeche|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2112|Industrie u Gewerbeflaeche|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2113|Fl gem Nutzung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2114|Fl bes fkt Praegung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2121|Bergbaubetrieb|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2122|Deponie|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2126|Kraftwerk|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2127|Umspannstation|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2128|Foerderanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2129|Klaeranlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2131|Ausstell Messegelaende|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2132|Gaertnerei|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2133|Heizwerk|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2134|Wasserwerk|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2135|Abfallbehandlungsanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2201|Sportanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2202|Freizeitanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2211|Freilichttheater|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2212|Freilichtmuseum|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2213|Friedhof|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2221|Stadion|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2222|Sportplatz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2223|Schiessstand|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2224|Schwimm Freibad|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2225|Zoo|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2226|Freizeitpark|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2227|Gruenanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2228|Campingplatz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2230|Golfplatz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2301|Tagebau Steinbruch|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2302|Halde Aufschuettung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2311|Gradierwerk Saline F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2313|Vorratsbeh Speicherbau F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2314|Absetzbecken|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2315|Gebaeude F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2324|Kran F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2325|Pumpe Pumpstelle F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2331|Archaeo Fundstaette F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2332|Denkmal F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2342|Spielfeld Spielflaeche|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2343|Zuschauertribuene|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2345|Schwimmbecken|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2318|Durchfahrt L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2324|Kran L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2331|Archaeo Fundstaette L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2344|Rennbahn|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2346|Sprungschanze|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2351|Mauer|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2352|Zaun|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2102|Wohnplatz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2313|Vorratsbeh Speicherbau P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2315|Gebaeude P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2316|Turm|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2317|Schornstein|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2318|Durchfahrt P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2319|Brunnen|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2320|Stollenmundloch|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2324|Kran P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2325|Pumpe Pumpstelle P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2327|Windrad|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2331|Archaeo Fundstaette P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2332|Denkmal P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2333|Bildstock Kreuz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2334|Meilenstein|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3103|Platz F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3301|Flughafen|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3302|Flugplatz F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3303|Rollbahn F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3304|Vorfeld|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3501|Bahnhofsanlage F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3502|Raststaette|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3513|Tunnel F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3514|Bruecke F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTDL_3101|Strasse LR|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3101|Strasse L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3102|Weg|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3105|Strassenkoerper L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTDL_3106|Fahrbahn L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3201|Schienenbahn|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3202|Seilbahn|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3205|Bahnstrecke|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3403|Schifffahrtslinie|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3513|Tunnel L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3514|Bruecke L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3515|Furt L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3531|Freileitung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3532|Rohrleitung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3533|Foerderband Bandstr|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3103|Platz P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3181|Nullpunkt|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3302|Flugplatz P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3501|Bahnhofsanlage P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3503|Verkehrsknoten P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3512|Anlegestelle P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3515|Furt P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3522|Stationierungspunkt|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3541|Mast|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4101|Ackerland|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4102|Gruenland|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4103|Gartenland|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4104|Heide|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4105|Moor Moos|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4106|Sumpf|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4107|Wald Forst|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4108|Gehoelz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4109|Sonderkultur|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4111|Nasser Boden|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4120|Vegetationslose Flaeche|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4199|Fl z Zt unbestimmbar|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_4202|Baumreihe|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_4203|Hecke Knick|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_4201|Baum|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5101|Strom Fluss Bach F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5103|Graben Kanal F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5105|Quelle F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5112|See Teich|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5302|Talsperre Wehr F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5303|Schleuse F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5321|Uferbefestigung F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTDL_5101|Strom Fluss Bach LR|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTDL_5103|Graben Kanal LR|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5103|Graben Kanal L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5301|Durchlass|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5302|Talsperre Wehr L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5303|Schleuse L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5321|Uferbefestigung L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_5105|Quelle P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_5203|Wasserfall P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_5311|Pegel|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_5312|Wasserspiegelhoehe|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_6211|Fels Felsbl Felsnadel F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_6201|Damm Wall Deich|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_6207|Stuetzmauer|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_6211|Fels Felsbl Felsnadel L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_6211|Fels Felsbl Felsnadel P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7101|Verwaltungseinheit|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7211|Insel|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7301|Nationalpark|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7302|Naturschutzgebiet|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7303|Gesch Landschaftsteil|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7304|Landsch Schutzgebiet|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7306|Biosphaerenreservat|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7308|Flora Fauna Habitat|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7311|Wasserschutzgebiet|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7403|Truppen u Standortuebpl|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_7299|Grenze|70.00028|0.27972
+#LayersUrlPart:     LAYERS=gaz_street_wms|HKO Strasse|1.40028|0.02772
+#LayersUrlPart:     LAYERS=gaz_hnr_wms|HKO Hausnummer|1.40028|0.02772
+#LayersUrlPart:     LAYERS=BORIS_BF|Bauflaechen|16.8|0.0
+#LayersUrlPart:     LAYERS=BORIS_BFLF|Landwirtschaftliche Flaechen in bebautem Gebiet|16.8|0.0
+#LayersUrlPart:     LAYERS=BORIS_LF|Land- u. Forstwirtschaftliche Flaechen|33.6|0.0
+#LayersUrlPart:     LAYERS=BORIS_MA|Massnahmen|16.8|0.0
+#LayersUrlPart:     LAYERS=BORIS_ALK_51_20081231|BORIS-TH Apolda 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_52_20081231|BORIS-TH Artern 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_53_20081231|BORIS-TH Gotha 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_54_20081231|BORIS-TH Leinefelde-Worbis 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_55_20081231|BORIS-TH Poessneck 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_56_20081231|BORIS-TH Saalfeld 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_57_20081231|BORIS-TH Schmalkalden 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_58_20081231|BORIS-TH Zeulenroda 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=boris_dtkv25col|DTK25-V Kombination farbig (BORIS)|6.99972|0.0
+#LayersUrlPart:     LAYERS=BORIS_GEMUEB_20081231|BORIS-TH GEMUEB 31.12.2008|16.8|0.0028
+LayersUrlPart:     LAYERS=dtkv25col
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 56.0000 E 5.0000
+BoundingBoxButtomRightWGS84: N 47.0000 E 15.0000
+# testen oder
+# ol=N 53.0000 E 9.0000 , ur=N 49.0000 E 13.0000
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   5
+ImageFileExtension: .png

Deleted: trunk/res_noewe/webmapservices/de-th_topo_50.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-th_topo_50.wms	2009-06-22 17:36:40 UTC (rev 1935)
+++ trunk/res_noewe/webmapservices/de-th_topo_50.wms	2009-06-23 13:55:20 UTC (rev 1936)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.thueringen.de/de/tlvermgeo/onlineservice/web_map_service/content.html
-GetCapabilitiesUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de.th Topo 50
-MapType:	topo
-MainUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31468
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Top.Karte_50_gesamt
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 52.0000 E 9.5000
-BoundingBoxButtomRightWGS84:	N 50.0000 E 13.0000
-MinScale:	1.49671
-MaxScale:	49.8903
-RecommendedScale:	5.0
-ImageFileExtension: .png
-

Deleted: trunk/res_noewe/webmapservices/untested/de-th_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/de-th_p.wms	2009-06-22 17:36:40 UTC (rev 1935)
+++ trunk/res_noewe/webmapservices/untested/de-th_p.wms	2009-06-23 13:55:20 UTC (rev 1936)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.thueringen.de/de/tlvermgeo/onlineservice/web_map_service/content.html
-GetCapabilitiesUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de.Thueringen photo
-MapType:	photo
-MainUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31468
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Orthophotos_TH-2m
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84:	N 52.0000 E 9.5000
-BoundingBoxButtomRightWGS84:	N 50.0000 E 13.0000
-MinScale:   0.399122
-MaxScale:   9.97806
-RecommendedScale:   2.0
-ImageFileExtension: .jpg
-

Deleted: trunk/res_noewe/webmapservices/untested/de-th_t50.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/de-th_t50.wms	2009-06-22 17:36:40 UTC (rev 1935)
+++ trunk/res_noewe/webmapservices/untested/de-th_t50.wms	2009-06-23 13:55:20 UTC (rev 1936)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.thueringen.de/de/tlvermgeo/onlineservice/web_map_service/content.html
-GetCapabilitiesUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de.Thueringen topo 50
-MapType:	topo
-MainUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31468
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Top.Karte_50_gesamt
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 52.0000 E 9.5000
-BoundingBoxButtomRightWGS84:	N 50.0000 E 13.0000
-MinScale:	1.49671
-MaxScale:	49.8903
-RecommendedScale:	5.0
-ImageFileExtension: .png
-



From araber95 at mail.berlios.de  Tue Jun 23 16:33:13 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Tue, 23 Jun 2009 16:33:13 +0200
Subject: [Cachewolf-svn] r1937 - in trunk/res_noewe/webmapservices: .
	untested
Message-ID: <200906231433.n5NEXDP3020613@sheep.berlios.de>

Author: araber95
Date: 2009-06-23 16:33:09 +0200 (Tue, 23 Jun 2009)
New Revision: 1937

Added:
   trunk/res_noewe/webmapservices/it-88_m.wms
   trunk/res_noewe/webmapservices/it-88_p.wms
   trunk/res_noewe/webmapservices/it-88_t10.wms
   trunk/res_noewe/webmapservices/it_p.wms
   trunk/res_noewe/webmapservices/it_t100.wms
   trunk/res_noewe/webmapservices/it_t25.wms
Removed:
   trunk/res_noewe/webmapservices/untested/it-88_m.wms
   trunk/res_noewe/webmapservices/untested/it-88_p.wms
   trunk/res_noewe/webmapservices/untested/it-88_t10.wms
   trunk/res_noewe/webmapservices/untested/it_t.wms
   trunk/res_noewe/webmapservices/untested/us_t.wms
Log:
add wms Italien und Sardinien(88)

Added: trunk/res_noewe/webmapservices/it-88_m.wms
===================================================================
--- trunk/res_noewe/webmapservices/it-88_m.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/it-88_m.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -0,0 +1,30 @@
+TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
+GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
+Name:   it.Sardinien photo+topo10
+MapType:   topo
+MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
+ServiceTypeUrlPart:   SERVICE=WMS
+VersionUrlPart:   VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:   3003
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
+RequestUrlPart:   REQUEST=GetMap
+# Topographisch schwarz/weiss
+#LayersUrlPart:   LAYERS=CTR10K%20raster
+# Luftbild farbig
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
+# Luftbild schwarz/weiss
+#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
+# farbiges Luftbild mit Raterdaten ?berlagert 
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
+# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1
+LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
+BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
+MinScale:   1
+MaxScale:   3
+#RecommendedScale:   1.000 sonst kann man die Topodaten nicht lesen bzw es werden keine Fotos geladen
+RecommendedScale:   1.000
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/it-88_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/it-88_p.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/it-88_p.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -0,0 +1,30 @@
+TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
+GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
+Name:   it.Sardinien photo
+MapType:   photo
+MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
+ServiceTypeUrlPart:   SERVICE=WMS
+VersionUrlPart:   VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:   3003
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
+RequestUrlPart:   REQUEST=GetMap
+# Topographisch schwarz/weiss
+#LayersUrlPart:   LAYERS=CTR10K%20raster
+# Luftbild farbig
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
+# Luftbild schwarz/weiss
+#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
+# farbiges Luftbild mit Raterdaten ?berlagert 
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
+# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1
+LayersUrlPart:   LAYERS=mosaico_2006IT_4
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
+BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
+MinScale:   4
+MaxScale:   6
+# RecommendedScale:   1.000
+RecommendedScale:   4
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/it-88_t10.wms
===================================================================
--- trunk/res_noewe/webmapservices/it-88_t10.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/it-88_t10.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -0,0 +1,30 @@
+TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
+GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
+Name:   it.Sardinien topo 10
+MapType:   topo
+MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
+ServiceTypeUrlPart:   SERVICE=WMS
+VersionUrlPart:   VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:   3003
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
+RequestUrlPart:   REQUEST=GetMap
+# Topographisch schwarz/weiss
+#LayersUrlPart:   LAYERS=CTR10K%20raster
+# Luftbild farbig
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
+# Luftbild schwarz/weiss
+#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
+# farbiges Luftbild mit Raterdaten ?berlagert 
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
+# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
+#LayersUrlPart:   LAYERS=mosaico_2006IT_1
+LayersUrlPart:   LAYERS=CTR10K%20raster
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/png
+BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
+BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
+MinScale:   1
+MaxScale:   3
+#RecommendedScale:   1 - 2.000 bei gr?sserer Skalierung wird es un?bersichtlich
+RecommendedScale:   1.000
+ImageFileExtension: .png

Added: trunk/res_noewe/webmapservices/it_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/it_p.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/it_p.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -0,0 +1,23 @@
+TakenFromUrl:       http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/ortofoto_colore_06.map&
+GetCapabilitiesUrl: http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/ortofoto_colore_06.map&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               Italien photo
+MapType:                        photo
+MainUrl:            http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/ortofoto_colore_06.map&
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=ortofoto_colore|ortofoto_colore_06||
+#LayersUrlPart:     LAYERS=ortofoto_colore_06|ortofoto_colore_06||
+#LayersUrlPart:     LAYERS=ortofoto_colore_06_32|ortofoto_colore_06_32|0|29.9341709057782
+#LayersUrlPart:     LAYERS=ortofoto_colore_06_33|ortofoto_colore_06_33|0|29.9341709057782
+LayersUrlPart:     LAYERS=ortofoto_colore_06_33
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 48.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 36.0000 E 19.0000
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   1
+ImageFileExtension: .jpg

Added: trunk/res_noewe/webmapservices/it_t100.wms
===================================================================
--- trunk/res_noewe/webmapservices/it_t100.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/it_t100.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -0,0 +1,23 @@
+TakenFromUrl:       http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm100.map&
+GetCapabilitiesUrl: http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm100.map&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               Italien t100
+MapType:                        topo
+MainUrl:            http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm100.map&
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=igm100|igm100||
+#LayersUrlPart:     LAYERS=igm100|igm100||
+#LayersUrlPart:     LAYERS=igm100_f32|igm100_f32||
+#LayersUrlPart:     LAYERS=igm100_f33|igm100_f33||
+LayersUrlPart:     LAYERS=igm100
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 48.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 36.0000 E 19.0000
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   10
+ImageFileExtension: .jpg

Added: trunk/res_noewe/webmapservices/it_t25.wms
===================================================================
--- trunk/res_noewe/webmapservices/it_t25.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/it_t25.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -0,0 +1,24 @@
+TakenFromUrl:       http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm25.map&
+GetCapabilitiesUrl: http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm25.map&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               Italien t25
+MapType:                        topo
+MainUrl:            http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm25.map&
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=igm25|igm25||
+#LayersUrlPart:     LAYERS=igm25|igm25||
+#LayersUrlPart:     LAYERS=igm25_f32|igm25_f32||
+#LayersUrlPart:     LAYERS=igm25_f33|igm25_f33||
+#LayersUrlPart:     LAYERS=igm25,igm25_f32,igm25_f33
+LayersUrlPart:     LAYERS=igm25
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 48.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 36.0000 E 19.0000
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   2,5
+ImageFileExtension: .jpg

Deleted: trunk/res_noewe/webmapservices/untested/it-88_m.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/it-88_m.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/untested/it-88_m.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -1,30 +0,0 @@
-TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
-GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
-Name:   it.Sardinien photo+topo10
-MapType:   topo
-MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   3003
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
-RequestUrlPart:   REQUEST=GetMap
-# Topographisch schwarz/weiss
-#LayersUrlPart:   LAYERS=CTR10K%20raster
-# Luftbild farbig
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
-# Luftbild schwarz/weiss
-#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
-# farbiges Luftbild mit Raterdaten ?berlagert 
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
-# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1
-LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
-BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
-MinScale:   1
-MaxScale:   3
-#RecommendedScale:   1.000 sonst kann man die Topodaten nicht lesen bzw es werden keine Fotos geladen
-RecommendedScale:   1.000
-ImageFileExtension: .png

Deleted: trunk/res_noewe/webmapservices/untested/it-88_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/it-88_p.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/untested/it-88_p.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -1,30 +0,0 @@
-TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
-GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
-Name:   it.Sardinien photo
-MapType:   photo
-MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   3003
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
-RequestUrlPart:   REQUEST=GetMap
-# Topographisch schwarz/weiss
-#LayersUrlPart:   LAYERS=CTR10K%20raster
-# Luftbild farbig
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
-# Luftbild schwarz/weiss
-#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
-# farbiges Luftbild mit Raterdaten ?berlagert 
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
-# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1
-LayersUrlPart:   LAYERS=mosaico_2006IT_4
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
-BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
-MinScale:   4
-MaxScale:   6
-# RecommendedScale:   1.000
-RecommendedScale:   4
-ImageFileExtension: .png

Deleted: trunk/res_noewe/webmapservices/untested/it-88_t10.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/it-88_t10.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/untested/it-88_t10.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -1,30 +0,0 @@
-TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
-GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
-Name:   it.Sardinien topo 10
-MapType:   topo
-MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   3003
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
-RequestUrlPart:   REQUEST=GetMap
-# Topographisch schwarz/weiss
-#LayersUrlPart:   LAYERS=CTR10K%20raster
-# Luftbild farbig
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
-# Luftbild schwarz/weiss
-#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
-# farbiges Luftbild mit Raterdaten ?berlagert 
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
-# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1
-LayersUrlPart:   LAYERS=CTR10K%20raster
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
-BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
-MinScale:   1
-MaxScale:   3
-#RecommendedScale:   1 - 2.000 bei gr?sserer Skalierung wird es un?bersichtlich
-RecommendedScale:   1.000
-ImageFileExtension: .png

Deleted: trunk/res_noewe/webmapservices/untested/it_t.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/it_t.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/untested/it_t.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -1,19 +0,0 @@
-TakenFromUrl: http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
-GetCapabilitiesUrl: http://151.13.182.121/geoserver/wms?service=WMS&request=GetCapabilities
-Name: it topo 25
-MapType: topo
-MainUrl: http://151.13.182.121/geoserver/wms?
-ServiceTypeUrlPart: SERVICE=WMS
-VersionUrlPart: VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf: 31466 31467 4326
-CoordinateReferenceSystemUrlPart: SRS=EPSG:31466 SRS=EPSG:31467 SRS=EPSG:4326
-RequestUrlPart: REQUEST=GetMap
-LayersUrlPart: LAYERS=cnr_imaa:igm25000
-StylesUrlPart: STYLES=raster
-ImageFormatUrlPart: FORMAT=image/png
-BoundingBoxTopLeftWGS84: N 47.165454 E 6.581957
-BoundingBoxButtomRightWGS84: N 35.485254 E 18.548357
-MinScale: 0.0
-MaxScale: 23.335
-RecommendedScale: 5
-ImageFileExtension: .png

Deleted: trunk/res_noewe/webmapservices/untested/us_t.wms
===================================================================
--- trunk/res_noewe/webmapservices/untested/us_t.wms	2009-06-23 13:55:20 UTC (rev 1936)
+++ trunk/res_noewe/webmapservices/untested/us_t.wms	2009-06-23 14:33:09 UTC (rev 1937)
@@ -1,19 +0,0 @@
-TakenFromUrl:   http://www.perrygeo.net/wordpress/?p=35
-GetCapabilitiesUrl:      -
-Name:   us topo 24
-MainUrl:   http://terraservice.net/ogcmap.ashx?
-MapType: topo
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   4326
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:4326
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=DRG
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84:   N 75.0 W 179.9
-BoundingBoxButtomRightWGS84:   N 20.0 W 60.0
-MinScale:   0
-MaxScale:   45
-RecommendedScale:   5
-ImageFileExtension: .jpg



From engywuck at mail.berlios.de  Tue Jun 23 22:32:59 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Tue, 23 Jun 2009 22:32:59 +0200
Subject: [Cachewolf-svn] r1938 - trunk/src/CacheWolf
Message-ID: <200906232032.n5NKWx4j028678@sheep.berlios.de>

Author: engywuck
Date: 2009-06-23 22:32:58 +0200 (Tue, 23 Jun 2009)
New Revision: 1938

Modified:
   trunk/src/CacheWolf/GPXImporter.java
Log:
Don't set LastSync date for additional waypoints.

Modified: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2009-06-23 14:33:09 UTC (rev 1937)
+++ trunk/src/CacheWolf/GPXImporter.java	2009-06-23 20:32:58 UTC (rev 1938)
@@ -393,6 +393,7 @@
 			holder.setCacheSize(CacheSize.CW_SIZE_NOTCHOSEN);
 			holder.setHard(CacheTerrDiff.CW_DT_UNSET);
 			holder.setTerrain(CacheTerrDiff.CW_DT_UNSET);
+			holder.setLastSync("");
 		}
 		
 		if ((name.equals("groundspeak:name")|| name.equals("terra:name")) && inCache) {



From greiol at mail.berlios.de  Tue Jun 23 23:30:27 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 23 Jun 2009 23:30:27 +0200
Subject: [Cachewolf-svn] r1939 - trunk/src/exp
Message-ID: <200906232130.n5NLURG9003088@sheep.berlios.de>

Author: greiol
Date: 2009-06-23 23:30:25 +0200 (Tue, 23 Jun 2009)
New Revision: 1939

Added:
   trunk/src/exp/GarminMap.java
Removed:
   trunk/src/exp/GpxExportNgForm.java
Modified:
   trunk/src/exp/GpxExportNg.java
Log:
added custom icons and validated output via validome.org

Added: trunk/src/exp/GarminMap.java
===================================================================
--- trunk/src/exp/GarminMap.java	2009-06-23 20:32:58 UTC (rev 1938)
+++ trunk/src/exp/GarminMap.java	2009-06-23 21:30:25 UTC (rev 1939)
@@ -0,0 +1,108 @@
+package exp;
+
+import CacheWolf.CacheHolder;
+import CacheWolf.CacheSize;
+import CacheWolf.CacheTerrDiff;
+import CacheWolf.Global;
+import ewe.io.FileBase;
+import ewe.util.Vector;
+import ewesoft.xml.MinML;
+import ewesoft.xml.sax.AttributeList;
+
+/**
+ * This class implements user defined icons which depend on the cache type and the found status.
+ * See also http://www.geoclub.de/ftopic10413.html
+ * @author salzkammergut
+ *
+ */
+class GarminMap extends MinML {
+
+	private Vector symbols=new Vector(24);
+
+	String lastName;
+	public void readGarminMap(){
+		try{
+			String datei = FileBase.getProgramDirectory() + "/garminmap.xml";
+			ewe.io.Reader r = new ewe.io.InputStreamReader(new ewe.io.FileInputStream(datei));
+			parse(r);
+			r.close();
+		}catch(Exception e){
+			if (e instanceof NullPointerException)
+				Global.getPref().log("Error reading garminmap.xml: NullPointerException in Element "+lastName +". Wrong attribute?",e,true);
+			else
+				Global.getPref().log("Error reading garminmap.xml: ", e);
+		}
+	}
+	public void startElement(String name, AttributeList atts){
+		lastName=name;
+		if (name.equals("icon")) {
+			symbols.add(new IconMap(atts.getValue("type"),atts.getValue("name"),atts.getValue("found"),
+					atts.getValue("size"),atts.getValue("terrain"),atts.getValue("difficulty"),
+					atts.getValue("status"),atts.getValue("poiid")));
+		}
+	}
+
+	public String getIcon(CacheHolder ch) {
+		int mapSize=symbols.size();
+		// Try each icon in turn
+		for (int i=0; i<mapSize; i++) {
+			IconMap icon=(IconMap) symbols.get(i);
+			boolean match=true;
+			// If a certain attribute is not null it must match the current caches values
+			match=match && ((icon.type==null) || ch.getType()==0 || icon.type.equals(String.valueOf(ch.getType())));
+			match=match && ((icon.size==null) || ch.getCacheSize()==0 || icon.size.equalsIgnoreCase(CacheSize.getExportShortId(ch.getCacheSize())));
+			match=match && ((icon.terrain==null) || ch.getTerrain()==0 || icon.terrain.equals(CacheTerrDiff.shortDT(ch.getTerrain())));
+			match=match && ((icon.difficulty==null) ||  ch.getHard()==0 || icon.difficulty.equals(CacheTerrDiff.shortDT(ch.getHard())));
+			match=match && ((icon.status==null) ||  ch.getCacheStatus().startsWith(icon.status));
+			match=match && ((icon.found==null) || ch.is_found());
+			if (match) return icon.name;
+		}
+
+		// If it is not a mapped type, just use the standard mapping
+		if (ch.is_found())
+			return "Geocache Found";
+		else
+			return "Geocache";
+	}
+	
+	public String getPoiId(CacheHolder ch) {
+		int mapSize=symbols.size();
+		// Try each icon in turn
+		for (int i=0; i<mapSize; i++) {
+			IconMap icon=(IconMap) symbols.get(i);
+			boolean match=true;
+			// If a certain attribute is not null it must match the current caches values
+			match=match && ((icon.type==null) || ch.getType()==0 || icon.type.equals(String.valueOf(ch.getType())));
+			match=match && ((icon.size==null) || ch.getCacheSize()==0 || icon.size.equalsIgnoreCase(CacheSize.getExportShortId(ch.getCacheSize())));
+			match=match && ((icon.terrain==null) || ch.getTerrain()==0 || icon.terrain.equals(CacheTerrDiff.shortDT(ch.getTerrain())));
+			match=match && ((icon.difficulty==null) ||  ch.getHard()==0 || icon.difficulty.equals(CacheTerrDiff.shortDT(ch.getHard())));
+			match=match && ((icon.status==null) ||  ch.getCacheStatus().startsWith(icon.status));
+			match=match && ((icon.found==null) || ch.is_found());
+			if (match) return icon.poiId;
+		}
+		return null;
+	}
+
+	private class IconMap {
+		public String type;
+		public String name;
+		public String size;
+		public String terrain;
+		public String difficulty;
+		public String found;
+		public String status;
+		public String poiId;
+
+		IconMap(String type, String name, String found, String size, String terrain, String difficulty, String status, String poiId) {
+			this.type=type;
+			this.name=name;
+			this.found=found;
+			this.size=size;
+			this.terrain=terrain;
+			this.difficulty=difficulty;
+			this.status=status;
+			this.poiId = poiId;
+		}
+	}
+
+}

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-23 20:32:58 UTC (rev 1938)
+++ trunk/src/exp/GpxExportNg.java	2009-06-23 21:30:25 UTC (rev 1939)
@@ -1,13 +1,15 @@
 package exp;
 
+import utils.FileBugfix;
+import CacheWolf.CWPoint;
 import CacheWolf.CacheHolder;
 import CacheWolf.CacheSize;
 import CacheWolf.CacheTerrDiff;
 import CacheWolf.CacheType;
 import CacheWolf.Global;
-import CacheWolf.CWPoint;
+import CacheWolf.Log;
 import CacheWolf.LogList;
-import CacheWolf.Log;
+import CacheWolf.SafeXML;
 
 import com.stevesoft.ewe_pat.Regex;
 import com.stevesoft.ewe_pat.Transformer;
@@ -16,23 +18,36 @@
 import ewe.filechooser.FileChooserBase;
 import ewe.io.BufferedWriter;
 import ewe.io.File;
+import ewe.io.FileBase;
 import ewe.io.FileWriter;
 import ewe.io.PrintWriter;
 import ewe.sys.Date;
+import ewe.sys.Handle;
 import ewe.sys.Vm;
+import ewe.ui.CheckBoxGroup;
+import ewe.ui.Control;
+import ewe.ui.ControlEvent;
+import ewe.ui.Event;
+import ewe.ui.Form;
 import ewe.ui.FormBase;
+import ewe.ui.ProgressBarForm;
+import ewe.ui.mButton;
+import ewe.ui.mCheckBox;
+import ewe.util.Enumeration;
 import ewe.util.Hashtable;
 import ewe.util.Iterator;
+import ewe.util.Random;
 
 //TODO: use safexml a lot more (at least start using it ;) )
 
 /**
- * experimental GPX exporter that should better handle the various tasks that can be accomplished with GPX
- * it is not yet linked to any menu, so if you want to play around with it, first you have to create a menu item
- *
+ * experimental GPX exporter that should better handle the various tasks that
+ * can be accomplished with GPX it is not yet linked to any menu, so if you want
+ * to play around with it, first you have to create a menu item
+ * 
  */
 public class GpxExportNg {
-	
+
 	/** export is in compact format */
 	final static int GPX_COMPACT = 0;
 	/** export is PQ like */
@@ -40,134 +55,283 @@
 	/** export follows gc.com myfinds format */
 	final static int GPX_MYFINDSPQ = 2;
 
-	final static String expName="GpxExportNG";
-	final static String TRUE="True";
-	final static String FALSE="False";
-	
+	final static String expName = "GpxExportNG";
+	final static String TRUE = "True";
+	final static String FALSE = "False";
+	private static GarminMap gm;
+
 	final static String GPXHEADER = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
-		.concat("<gpx xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" version=\"1.0\" creator=\"CacheWolf http://www.cachewolf.de/\" xsi:schemaLocation=\"http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd http://www.groundspeak.com/cache/1/0 http://www.groundspeak.com/cache/1/0/cache.xsd\" xmlns=\"http://www.topografix.com/GPX/1/0\">\n")
-		.concat("<name>Waypoints for Cache Listings, Generated by CacheWolf</name>\n")
-		.concat("<desc>This is a list of waypoints for geocaches generated by CacheWolf</desc>\n")
-		.concat("<author>Various users from geocaching.com and/or opencaching.de</author>\n")
-		.concat("<email>contact at cachewolf.de</email>\n")
-		.concat("<url>http://www.cachewolf.de/</url>\n")
-		.concat("<urlname>CacheWolf - Paperless Geocaching</urlname>\n")
-		.concat("<time>@@CREATEDATE@@T00:00:00Z</time>\n")
-		.concat("<keywords>cache, geocache, waypoints</keywords>\n")
-// TODO: is it worth a second loop?
-//		.concat("<bounds minlat=\"50.91695\" minlon=\"6.876383\" maxlat=\"50.935183\" maxlon=\"6.918817\" />")
-		;
-	
+			.concat("<gpx xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" version=\"1.0\" creator=\"CacheWolf\" xsi:schemaLocation=\"http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd http://www.groundspeak.com/cache/1/0 http://www.groundspeak.com/cache/1/0/cache.xsd\" xmlns=\"http://www.topografix.com/GPX/1/0\">\n")
+			.concat("<name>Waypoints for Cache Listings, Generated by CacheWolf</name>\n")
+			.concat("<desc>This is a list of waypoints for geocaches generated by CacheWolf</desc>\n")
+			.concat("<author>Various users from geocaching.com and/or opencaching.de</author>\n")
+			.concat("<email>contact at cachewolf.de</email>\n")
+			.concat("<url>http://www.cachewolf.de/</url>\n")
+			.concat("<urlname>CacheWolf - Paperless Geocaching</urlname>\n")
+			.concat("<time>@@CREATEDATE@@T00:00:00Z</time>\n")
+			.concat("<keywords>cache, geocache, waypoints</keywords>\n")
+	// TODO: is it worth a second loop?
+	// .concat("<bounds minlat=\"50.91695\" minlon=\"6.876383\" maxlat=\"50.935183\" maxlon=\"6.918817\" />")
+			;
+
 	final static String GPXCOMPACT = "\t<wpt lat=\"@@WPLAT@@\" lon=\"@@WPLON@@\">\n"
-						.concat("\t\t<time>@@CACHETIME@@T00:00:00</time>\n")
-						.concat("\t\t<name>@@WPNAME@@</name>\n")
-						.concat("\t\t<cmt>@@WPCMT@@</cmt>\n")
-						.concat("\t\t<desc>@@WPDESC@@</desc>\n")
-						.concat("\t\t<url>@@WPURL@@</url>\n")
-						.concat("\t\t<urlname>@@WPURLNAME@@</urlname>\n")
-						.concat("\t\t<sym>@@WPSYMBOL@@</sym>\n")
-						.concat("\t\t<type>@@WPTYPE@@</type>\n");
-	
-	final static String GPXEXTENSION ="\t\t<groundspeak:cache id=\"@@CACHEID@@\" available=\"@@CACHEAVAILABLE@@\" archived=\"@@CACHEARCHIVED\" xmlns:groundspeak=\"http://www.geocaching.com/cache/1/0\">\n"
-						.concat("\t\t\t<groundspeak:name>@@CACHENAME@@</groundspeak:name>\n")
-						.concat("\t\t\t<groundspeak:placed_by>@@CACHEPLACEDBY@@<groundspeak:placed_by>\n")
-						.concat("\t\t\t<groundspeak:owner_id id=\"@@CACHEOWNERID@@\">@@CACHEOWNER@@</groundspeak:owner_id>\n")
-						.concat("\t\t\t<groundspeak:type>@@CACHETYPE@@</groundspeak:type>\n")
-						.concat("\t\t\t<groundspeak:container>@@CACHECONTAINER@@</groundspeak:container>\n")
-						.concat("\t\t\t<groundspeak:difficulty>@@CACHEDIFFICULTY@@</groundspeak:difficulty>\n")
-						.concat("\t\t\t<groundspeak:terrain>@@CACHETERRAIN@@</groundspeak:terrain>\n")
-						.concat("\t\t\t<groundspeak:country>@@CACHECOUNTRY@@</groundspeak:country>\n")
-						.concat("\t\t\t<groundspeak:state>@@CACHESTATE@@</groundspeak:state>\n")
-						.concat("\t\t\t<groundspeak:short_description html=\"@@CACHEHTML@@\">@@CACHESHORTDESCRIPTION@@</groundspeak:short_description>\n")
-						.concat("\t\t\t<groundspeak:long_description html=\"@@CACHEHTML@@\">@@CACHELONGDESCRIPTION@@</groundspeak:long_description>\n")
-						.concat("\t\t\t<groundspeak:encoded_hints>@@CACHEHINT@@</groundspeak:encoded_hints>\n");
+			.concat("\t\t<time>@@CACHETIME@@T00:00:00</time>\n")
+			.concat("\t\t<name>@@WPNAME@@</name>\n")
+			.concat("\t\t<cmt>@@WPCMT@@</cmt>\n")
+			.concat("\t\t<desc>@@WPDESC@@</desc>\n")
+			.concat("\t\t<url>@@WPURL@@</url>\n")
+			.concat("\t\t<urlname>@@WPURLNAME@@</urlname>\n")
+			.concat("\t\t<sym>@@WPSYMBOL@@</sym>\n")
+			.concat("\t\t<type>@@WPTYPE@@</type>\n");
 
+	final static String GPXEXTENSION = "\t\t<groundspeak:cache id=\"@@CACHEID@@\" available=\"@@CACHEAVAILABLE@@\" archived=\"@@CACHEARCHIVED\" xmlns:groundspeak=\"http://www.groundspeak.com/cache/1/0\">\n"
+			.concat("\t\t\t<groundspeak:name>@@CACHENAME@@</groundspeak:name>\n")
+			.concat("\t\t\t<groundspeak:placed_by>@@CACHEPLACEDBY@@</groundspeak:placed_by>\n")
+			.concat("\t\t\t<groundspeak:owner id=\"@@CACHEOWNERID@@\">@@CACHEOWNER@@</groundspeak:owner>\n")
+			.concat("\t\t\t<groundspeak:type>@@CACHETYPE@@</groundspeak:type>\n")
+			.concat("\t\t\t<groundspeak:container>@@CACHECONTAINER@@</groundspeak:container>\n")
+			.concat("\t\t\t<groundspeak:difficulty>@@CACHEDIFFICULTY@@</groundspeak:difficulty>\n")
+			.concat("\t\t\t<groundspeak:terrain>@@CACHETERRAIN@@</groundspeak:terrain>\n")
+			.concat("\t\t\t<groundspeak:country>@@CACHECOUNTRY@@</groundspeak:country>\n")
+			.concat("\t\t\t<groundspeak:state>@@CACHESTATE@@</groundspeak:state>\n")
+			.concat("\t\t\t<groundspeak:short_description html=\"@@CACHEHTML@@\">@@CACHESHORTDESCRIPTION@@</groundspeak:short_description>\n")
+			.concat("\t\t\t<groundspeak:long_description html=\"@@CACHEHTML@@\">@@CACHELONGDESCRIPTION@@</groundspeak:long_description>\n")
+			.concat("\t\t\t<groundspeak:encoded_hints>@@CACHEHINT@@</groundspeak:encoded_hints>\n");
+
 	final static String GPXLOG = "\t\t\t\t<groundspeak:log id=\"@@LOGID@@\">\n"
-						.concat("\t\t\t\t\t<groundspeak:date>@@LOGDATE@@T00:00:00</groundspeak:date>\n")
-						.concat("\t\t\t\t\t<groundspeak:type>@@LOGTYPE@@</groundspeak:type>\n")
-						.concat("\t\t\t\t\t<groundspeak:finder id=\"@@LOGFINDERID@@\">@@LOGFINDER@@</groundspeak:finder>\n")
-						.concat("\t\t\t\t\t<groundspeak:text encoded=\"@@LOGENCODE@@\">@@LOGTEXT@@</groundspeak:text>\n")
-						.concat("\t\t\t\t</groundspeak:log>\n");
-	
+			.concat("\t\t\t\t\t<groundspeak:date>@@LOGDATE@@T00:00:00</groundspeak:date>\n")
+			.concat("\t\t\t\t\t<groundspeak:type>@@LOGTYPE@@</groundspeak:type>\n")
+			.concat("\t\t\t\t\t<groundspeak:finder id=\"@@LOGFINDERID@@\">@@LOGFINDER@@</groundspeak:finder>\n")
+			.concat("\t\t\t\t\t<groundspeak:text encoded=\"@@LOGENCODE@@\">@@LOGTEXT@@</groundspeak:text>\n")
+			.concat("\t\t\t\t</groundspeak:log>\n");
+
 	final static String GPXTB = "\t\t\t\t<groundspeak:travelbug id=\"@@TBID@@\" ref=\"@@TBREF@@\">\n"
-						.concat("\t\t\t\t\t<groundspeak:name>@@TBNAME@@</groundspeak:name>\n")
-						.concat("\t\t\t\t</groundspeak:travelbug>\n");
-	
-	//FIXME: don't use this until GPX import can strip this off as well
+			.concat("\t\t\t\t\t<groundspeak:name>@@TBNAME@@</groundspeak:name>\n")
+			.concat("\t\t\t\t</groundspeak:travelbug>\n");
+
+	// FIXME: don't use this until GPX import can strip this off as well
 	final static String GPXADDIINMAIN = "@@ADDIID@@ - @@ADDISHORT@@@@ADDIDELIM@@"
-						.concat("@@ADDILAT@@ @@ADDILON@@@@ADDIDELIM@@")
-						.concat("@@ADDILONG@@@@ADDIDELIM@@");
-	
+			.concat("@@ADDILAT@@ @@ADDILON@@@@ADDIDELIM@@")
+			.concat("@@ADDILONG@@@@ADDIDELIM@@");
+
 	static boolean smartIds;
 	static boolean customIcons;
 	static boolean separateFiles;
 	static boolean sendToGarmin;
 	static int outType;
-	
-	
-	
+
 	public GpxExportNg() {
 		GpxExportNgForm exportOptions;
 		int ret;
 
 		exportOptions = new GpxExportNgForm();
 		ret = exportOptions.execute();
-		
+
 		if (FormBase.IDCANCEL == ret) {
 			return;
 		}
-		
+
 		outType = exportOptions.getExportType();
 		smartIds = exportOptions.getSmartIds();
 		separateFiles = exportOptions.getSeparateFiles();
 		sendToGarmin = exportOptions.getSendToGarmin();
 		customIcons = exportOptions.getCustomIcons();
-		
+
 		if (separateFiles) {
-			final Hashtable fileHandles;
-			final String directoryName;
-			//TODO: get directory
-			//TODO: initialize files
-			//TODO: iterate through caches
-			//TODO: remove old files with prefix
-			//TODO: write new files
+			final Hashtable fileHandles = new Hashtable();
+			final String outDir;
+			final String tempDir;
+			final String baseDir = FileBase.getProgramDirectory();
+			final String prefix="GC-";
+			final FileChooser fc;
+			
+			if (sendToGarmin) { 
+				fc = new FileChooser(FileChooserBase.DIRECTORY_SELECT,Global.getPref().getExportPath(expName+"-GPI"));
+			} else {
+				fc = new FileChooser(FileChooserBase.DIRECTORY_SELECT,Global.getPref().getExportPath(expName+"-POI"));
+			}
+			
+			fc.setTitle("Select target directory:");
+			
+			if (fc.execute() == FormBase.IDCANCEL)
+				return;
+
+			outDir = fc.getChosenFile().getFullPath();
+			if (sendToGarmin) {
+				Global.getPref().setExportPath(expName+"-GPI", outDir);
+			} else {
+				Global.getPref().setExportPath(expName+"-POI", outDir);
+			}
+			
+			if ((new File(baseDir+"/garminmap.xml")).exists()) {
+				gm=new GarminMap();
+				gm.readGarminMap();
+			} else {
+				//TODO: display warning
+				Global.getPref().log("unable to load garminmap.xml");
+				return;
+			}
+			
+			if (sendToGarmin) {
+				tempDir = baseDir+File.separator+this.getClass().toString(); //FIXME: get from dialog
+				new File(tempDir).mkdir();
+			} else {
+				tempDir = outDir;
+				String tmp[] = new FileBugfix(tempDir).list(prefix + "*.gpx", ewe.io.FileBase.LIST_FILES_ONLY);
+				for (int i=0; i < tmp.length;i++){
+					FileBugfix tmpFile = new FileBugfix(tempDir + tmp[i]);
+					tmpFile.delete();
+				}
+				tmp = new FileBugfix(tempDir).list(prefix + "*.bmp", ewe.io.FileBase.LIST_FILES_ONLY);
+				for (int i=0; i < tmp.length;i++){
+					FileBugfix tmpFile = new FileBugfix(tempDir + tmp[i]);
+					tmpFile.delete();
+				}
+			}
+
+			ProgressBarForm pbf = new ProgressBarForm();
+			try {
+				Handle h = new Handle();
+
+				int expCount = 0;
+				int totalCount = Global.getProfile().cacheDB.countVisible();
+				
+				pbf.showMainTask = false;
+				pbf.setTask(h, "Exporting ...");
+				pbf.exec();
+				
+				for (int i = 0; i < Global.getProfile().cacheDB.size(); i++) {
+					CacheHolder ch = Global.getProfile().cacheDB.get(i);
+					if (!ch.isVisible()) {
+						continue;
+					} else if (ch.is_incomplete()) {
+						Global.getPref().log(
+								"skipping export of incomplete waypoint "
+										+ ch.getWayPoint());
+					} else {
+						String poiId = gm.getPoiId(ch);
+						if (null == poiId) {
+							Global.getPref().log("unmatched POI ID for "+ch.getWayPoint());
+						} else {
+							File outFile;
+							PrintWriter writer;
+							if (fileHandles.containsKey(poiId)) {
+								writer = (PrintWriter) fileHandles.get(poiId);
+							} else {
+								writer = new PrintWriter(new BufferedWriter(new FileWriter(new File(tempDir + File.separator + prefix+poiId+".gpx"))));
+								fileHandles.put(poiId, writer);
+								writer.print(formatHeader());
+							}
+							writer.print(formatCache(ch));
+						}
+						
+					}
+					expCount++;
+					h.progress = (float) expCount / (float) totalCount;
+					h.changed();
+				}
+				
+				Enumeration keys = fileHandles.keys();
+				while (keys.hasMoreElements()) {
+					String key = (String) keys.nextElement();
+					PrintWriter writer = (PrintWriter) fileHandles.get(key);
+					writer.print("</gpx>\n");
+					writer.close();
+				}
+				
+				if (sendToGarmin) {
+					String tmp[] = new FileBugfix(outDir).list(prefix + "*.gpi", ewe.io.FileBase.LIST_FILES_ONLY);
+					for (int i=0; i < tmp.length;i++){
+						FileBugfix tmpFile = new FileBugfix(tempDir + tmp[i]);
+						tmpFile.delete();
+					}				
+
+					// TODO: create GPI files
+					FileBugfix tmpdir = new FileBugfix(tempDir);
+					tmpdir.delete();
+				}
+				
+				pbf.exit(0);
+				
+				//TODO: connect with image and build garmin poi file
+			} catch (Exception e) {
+				e.printStackTrace();
+				pbf.exit(0);
+			}
 		} else {
+			if (customIcons) {
+				if ((new File(FileBase.getProgramDirectory()+"/garminmap.xml")).exists()) {
+					gm=new GarminMap();
+					gm.readGarminMap();
+				} else {
+					customIcons = false;
+					Global.getPref().log("unable to load garminmap.xml");
+				}
+			}
 			final File file;
-			final FileChooser fc = new FileChooser(FileChooserBase.SAVE, Global.getPref().getExportPath(expName));
+			final FileChooser fc = new FileChooser(FileChooserBase.SAVE, 
+					Global.getPref().getExportPath(expName+"-GPX"));
+			
 			fc.setTitle("Select target GPX file:");
 			fc.addMask("*.gpx");
-			if(fc.execute() == FormBase.IDCANCEL) return;
 			
+			if (fc.execute() == FormBase.IDCANCEL)
+				return;
+
 			file = fc.getChosenFile();
-			Global.getPref().setExportPath(expName, file.getPath());
+			Global.getPref().setExportPath(expName+"-GPX", file.getPath());
 
 			try {
-				PrintWriter outp =  new PrintWriter(new BufferedWriter(new FileWriter(file)));
+				ProgressBarForm pbf = new ProgressBarForm();
+				Handle h = new Handle();
+				PrintWriter outp = new PrintWriter(new BufferedWriter(
+						new FileWriter(file)));
+				int expCount = 0;
+				int totalCount = Global.getProfile().cacheDB.countVisible();
+
 				outp.print(formatHeader());
-				for(int i = 0; i<Global.getProfile().cacheDB.size(); i++){
-					CacheHolder ch=Global.getProfile().cacheDB.get(i);
-					if (ch.is_incomplete()) {
-						Vm.debug("skipping incomplete waypoint "+ch.getWayPoint());
+
+				pbf.showMainTask = false;
+				pbf.setTask(h, "Exporting ...");
+				pbf.exec();
+
+				for (int i = 0; i < Global.getProfile().cacheDB.size(); i++) {
+					CacheHolder ch = Global.getProfile().cacheDB.get(i);
+					if (!ch.isVisible()) {
 						continue;
+					} else if (ch.is_incomplete()) {
+						Global.getPref().log(
+								"skipping export of incomplete waypoint "
+										+ ch.getWayPoint());
+					} else {
+						outp.print(formatCache(ch));
 					}
-					outp.print(formatCache(ch));
+					expCount++;
+					h.progress = (float) expCount / (float) totalCount;
+					h.changed();
 				}
+
+				pbf.exit(0);
+
 				outp.print("</gpx>\n");
 				outp.close();
 			} catch (Exception ex) {
-				if (Global.getPref().debug) Global.getPref().log("unable to write GPX output to "+file.toString(), ex);
-				else Global.getPref().log("unable to write GPX output to "+file.toString());
-				//TODO: give a message to the user
+				if (Global.getPref().debug)
+					Global.getPref().log("unable to write GPX output to " + file.toString(),ex);
+				else
+					Global.getPref().log("unable to write GPX output to " + file.toString());
+				// TODO: give a message to the user
 			}
 		}
 	}
-	
+
 	private String formatCache(CacheHolder ch) {
 		// no addis or custom in MyFindsPq - and of course only finds
-		if ((GPX_MYFINDSPQ == outType) && 
-				((ch.getType() == CacheType.CW_TYPE_CUSTOM) || ch.isAddiWpt() || ! ch.is_found())) 
-				return "";
+		if ((GPX_MYFINDSPQ == outType) && ((ch.getType() == CacheType.CW_TYPE_CUSTOM) || ch.isAddiWpt() || !ch.is_found()))
+			return "";
 		
+		if (!ch.pos.isValid()) return ""; 
+
 		StringBuffer ret = new StringBuffer();
 
 		ret.append(formatCompact(ch));
@@ -175,211 +339,231 @@
 		if (outType != GPX_COMPACT && !(ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt())) {
 			ret.append(formatPqExtensions(ch));
 		}
+		
 		ret.append("\t</wpt>\n");
+
 		return ret.toString();
 	}
-	
+
 	private String formatCompact(CacheHolder ch) {
+		
 		Transformer trans = new Transformer(true);
-		
-		trans.add(new Regex("@@WPLAT@@", 
-				((ch.pos.latDec >= -90) && (ch.pos.latDec <= 90)?String.valueOf(ch.pos.latDec):"")
-			));
-		
-		trans.add(new Regex("@@WPLON@@",
-				((ch.pos.lonDec >= -180) && (ch.pos.lonDec <= 180)?String.valueOf(ch.pos.lonDec):"")
-			));
-		
-		trans.add(new Regex("@@CACHETIME@@", ch.getDateHidden()));
-		
+
+		trans.add(new Regex("@@WPLAT@@", String.valueOf(ch.pos.latDec)));
+
+		trans.add(new Regex("@@WPLON@@", String.valueOf(ch.pos.lonDec)));
+
+		if (ch.isAddiWpt()) {
+			try {
+				trans.add(new Regex("@@CACHETIME@@", ch.mainCache.getDateHidden()));
+			} catch (Exception e) {
+				Global.getPref().log(ch.getWayPoint()+" has no parent");
+				trans.add(new Regex("@@CACHETIME@@", "1970-01-01"));
+			}
+		} else if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
+			trans.add(new Regex("@@CACHETIME@@", "1970-01-01"));
+		} else {
+			trans.add(new Regex("@@CACHETIME@@", ch.getDateHidden()));
+		}
+
 		if (smartIds && ch.getType() != CacheType.CW_TYPE_CUSTOM) {
 			if (ch.isAddiWpt()) {
-				trans.add(new Regex("@@WPNAME@@",ch.mainCache.getWayPoint()
-						.concat(" ")
-						.concat(ch.getWayPoint().substring(0,2))));
+				trans.add(new Regex("@@WPNAME@@", ch.mainCache.getWayPoint()
+						.concat(" ").concat(ch.getWayPoint().substring(0, 2))));
 			} else {
-				trans.add(new Regex("@@WPNAME@@",ch.getWayPoint()
+				trans.add(new Regex("@@WPNAME@@", ch.getWayPoint()
 						.concat(" ")
 						.concat(CacheType.getExportShortId(ch.getType()))
 						.concat(String.valueOf(ch.getTerrain()))
 						.concat(String.valueOf(ch.getHard()))
-						.concat(CacheSize.getExportShortId(ch.getCacheSize()))
-					));
+						.concat(CacheSize.getExportShortId(ch.getCacheSize()))));
 			}
 		} else {
-			trans.add(new Regex("@@WPNAME@@",ch.getWayPoint()));
+			trans.add(new Regex("@@WPNAME@@", ch.getWayPoint()));
 		}
-		
+
 		if (ch.isAddiWpt() || ch.getType() == CacheType.CW_TYPE_CUSTOM) {
-			trans.add(new Regex("@@WPCMT@@",ch.getFreshDetails().LongDescription));
+			trans.add(new Regex("@@WPCMT@@",
+					SafeXML.cleanGPX(ch.getFreshDetails().LongDescription)));
 		} else {
-			trans.add(new Regex("@@WPCMT@@",""));
+			trans.add(new Regex("@@WPCMT@@", ""));
 		}
-		
+
 		if (ch.isAddiWpt()) {
-			trans.add(new Regex("@@WPDESC@@",ch.getCacheName()));
+			trans.add(new Regex("@@WPDESC@@", SafeXML.cleanGPX(ch.getCacheName())));
 		} else {
-			trans.add(new Regex("@@WPDESC@@",
-					ch.getCacheName()
+			trans.add(new Regex("@@WPDESC@@", SafeXML.cleanGPX(ch.getCacheName()
 					.concat(" by ")
 					.concat(ch.getCacheOwner())
 					.concat(", ")
 					.concat(CacheType.cw2ExportString(ch.getType()))
-					.concat(" (")
-					.concat(CacheTerrDiff.shortDT(ch.getHard()))
-					.concat("/")
-					.concat(CacheTerrDiff.shortDT(ch.getTerrain()))
-					.concat(")")
-				));
+					.concat(" (").concat(CacheTerrDiff.shortDT(ch.getHard()))
+					.concat("/").concat(CacheTerrDiff.shortDT(ch.getTerrain()))
+					.concat(")"))));
 		}
-		
+
 		if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
-			trans.add(new Regex("@@WPURL@@",""));
+			trans.add(new Regex("@@WPURL@@", ""));
 		} else {
 			if (ch.isAddiWpt()) {
-				//TODO: find out URL schema for additional waypoints
-				//TODO: check for OC caches
-				trans.add(new Regex("@@WPURL@@","http://www.geocaching.com/seek/wpt.aspx?wp=".concat(ch.getWayPoint())));
+				// TODO: find out URL schema for additional waypoints
+				// TODO: check for OC caches
+				trans.add(new Regex("@@WPURL@@",
+						"http://www.geocaching.com/seek/wpt.aspx?wp="
+						.concat(ch.getWayPoint())));
 			} else {
-				//TODO: check for OC caches
-				trans.add(new Regex("@@WPURL@@","http://www.geocaching.com/seek/cache_details.aspx?wp=".concat(ch.getWayPoint())));
+				// TODO: check for OC caches
+				trans.add(new Regex("@@WPURL@@",
+						"http://www.geocaching.com/seek/cache_details.aspx?wp="
+						.concat(ch.getWayPoint())));
 			}
 		}
-		
+
 		if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
-			trans.add(new Regex("@@WPURLNAME@@",""));
+			trans.add(new Regex("@@WPURLNAME@@", ""));
 		} else {
-			trans.add(new Regex("@@WPURLNAME@@",ch.getCacheName()));
+			trans.add(new Regex("@@WPURLNAME@@", SafeXML.cleanGPX(ch.getCacheName())));
 		}
-		
+
 		if (customIcons) {
-			//TODO: replace with SKGs custom symbol code
-			trans.add(new Regex("@@WPSYMBOL@@","Geocache"));
+			trans.add(new Regex("@@WPSYMBOL@@", gm.getIcon(ch)));
 		} else {
 			if (ch.isAddiWpt()) {
-				trans.add(new Regex("@@WPSYMBOL@@", CacheType.id2GpxString(ch.getType()).substring(CacheType.id2GpxString(ch.getType()).indexOf("|")+1)));
+				trans.add(new Regex("@@WPSYMBOL@@", CacheType.id2GpxString(
+					ch.getType()).substring(CacheType.id2GpxString(ch.getType()).indexOf("|") + 1)
+					));
 			} else if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
 				trans.add(new Regex("@@WPSYMBOL@@", "Custom"));
 			} else if (ch.is_found()) {
-				trans.add(new Regex("@@WPSYMBOL@@","Geocache found"));
+				trans.add(new Regex("@@WPSYMBOL@@", "Geocache found"));
 			} else {
-				trans.add(new Regex("@@WPSYMBOL@@","Geocache"));
+				trans.add(new Regex("@@WPSYMBOL@@", "Geocache"));
 			}
 		}
-		
-		trans.add(new Regex("@@WPTYPE@@",CacheType.id2GpxString(ch.getType())));
-		
+
+		trans.add(new Regex("@@WPTYPE@@", CacheType.id2GpxString(ch.getType())));
+
 		return trans.replaceFirst(GPXCOMPACT);
 	}
-	
+
 	private String formatPqExtensions(CacheHolder ch) {
 		// no details pq details for addis or custom waypoints
-		if (ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt()) return "";
-		
+		if (ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt())
+			return "";
+
 		StringBuffer ret = new StringBuffer();
 		Transformer trans = new Transformer(true);
 		ch.getFreshDetails();
-		trans.add(new Regex("@@CACHEID@@",ch.GetCacheID()));
-		trans.add(new Regex("@@CACHEAVAILABLE@@",ch.is_available()?TRUE:FALSE));
-		trans.add(new Regex("@@CACHEARCHIVED",ch.is_archived()?TRUE:FALSE));
-		trans.add(new Regex("@@CACHENAME@@",ch.getCacheName()));
-		trans.add(new Regex("@@CACHEPLACEDBY@@",ch.getCacheOwner()));
-		trans.add(new Regex("@@CACHEOWNERID@@","31415"));
-		trans.add(new Regex("@@CACHEOWNER@@",ch.getCacheOwner()));
-		trans.add(new Regex("@@CACHETYPE@@",CacheType.id2GpxString(ch.getType())));
-		trans.add(new Regex("@@CACHECONTAINER@@",CacheSize.cw2ExportString(ch.getCacheSize())));
-		trans.add(new Regex("@@CACHEDIFFICULTY@@",CacheTerrDiff.shortDT(ch.getHard())));
-		trans.add(new Regex("@@CACHETERRAIN@@",CacheTerrDiff.shortDT(ch.getTerrain())));
-		trans.add(new Regex("@@CACHECOUNTRY@@",ch.details.Country));
-		trans.add(new Regex("@@CACHESTATE@@",ch.details.State));
-		trans.add(new Regex("@@CACHEHTML@@",ch.is_HTML()?TRUE:FALSE));
-		trans.add(new Regex("@@CACHESHORTDESCRIPTION@@","CacheWolf can not provide Short description"));
-		trans.add(new Regex("@@CACHELONGDESCRIPTION@@",formatLongDescription(ch)));
-		trans.add(new Regex("@@CACHEHINT@@",ch.details.Hints));
-		
+		trans.add(new Regex("@@CACHEID@@", ch.GetCacheID()));
+		trans.add(new Regex("@@CACHEAVAILABLE@@", ch.is_available() ? TRUE : FALSE));
+		trans.add(new Regex("@@CACHEARCHIVED", ch.is_archived() ? TRUE : FALSE));
+		trans.add(new Regex("@@CACHENAME@@", SafeXML.cleanGPX(ch.getCacheName())));
+		trans.add(new Regex("@@CACHEPLACEDBY@@", SafeXML.cleanGPX(ch.getCacheOwner())));
+		trans.add(new Regex("@@CACHEOWNERID@@", "31415"));
+		trans.add(new Regex("@@CACHEOWNER@@", SafeXML.cleanGPX(ch.getCacheOwner())));
+		trans.add(new Regex("@@CACHETYPE@@", CacheType.id2GpxString(ch.getType())));
+		trans.add(new Regex("@@CACHECONTAINER@@", CacheSize.cw2ExportString(ch.getCacheSize())));
+		trans.add(new Regex("@@CACHEDIFFICULTY@@", CacheTerrDiff.shortDT(ch.getHard())));
+		trans.add(new Regex("@@CACHETERRAIN@@", CacheTerrDiff.shortDT(ch.getTerrain())));
+		trans.add(new Regex("@@CACHECOUNTRY@@", SafeXML.cleanGPX(ch.details.Country)));
+		trans.add(new Regex("@@CACHESTATE@@", SafeXML.cleanGPX((ch.details.State))));
+		trans.add(new Regex("@@CACHEHTML@@", ch.is_HTML() ? TRUE : FALSE));
+		trans.add(new Regex("@@CACHESHORTDESCRIPTION@@",
+				"CacheWolf can not provide a short description"));
+		trans.add(new Regex("@@CACHELONGDESCRIPTION@@",
+				SafeXML.cleanGPX(formatLongDescription(ch))));
+		trans.add(new Regex("@@CACHEHINT@@", SafeXML.cleanGPX(ch.details.Hints)));
+
 		ret.append(trans.replaceAll(GPXEXTENSION));
-		
+
 		ret.append("\t\t\t<groundspeak:logs>\n");
 		ret.append(formatLogs(ch));
 		ret.append("\t\t\t</groundspeak:logs>\n");
-		
-//		ret.append("\t\t\t<groundspeak:travelbugs>\n");
-//		ret.append(formatTbs(ch));
-//		ret.append("\t\t\t</groundspeak:travelbugs>\n");
-		
+
+		// ret.append("\t\t\t<groundspeak:travelbugs>\n");
+		// ret.append(formatTbs(ch));
+		// ret.append("\t\t\t</groundspeak:travelbugs>\n");
+
 		ret.append("\t\t</groundspeak:cache>\n");
 		return ret.toString();
 	}
-	
+
 	public void doit() {
-		
+
 	}
-	
+
 	public String formatTbs(CacheHolder ch) {
 		Transformer trans = new Transformer(true);
 		return "";
-//		return trans.replaceFirst(GPXTB);
+		// return trans.replaceFirst(GPXTB);
 	}
-	
+
 	public String formatLogs(CacheHolder ch) {
 		LogList logs = ch.getFreshDetails().CacheLogs;
 		StringBuffer ret = new StringBuffer();
-		if (0 == logs.size()) return "";
+		
+		if (0 == logs.size())
+			return "";
+		
 		for (int i = 0; i < logs.size(); i++) {
 			Log log = logs.getLog(i);
-			if (outType == GPX_MYFINDSPQ && !log.getLogger().equals(Global.getPref().myAlias)) continue;
+			
+			if (outType == GPX_MYFINDSPQ
+					&& !log.getLogger().equals(Global.getPref().myAlias))
+				continue;
+			
 			Transformer trans = new Transformer(true);
-			trans.add(new Regex("@@LOGID@@",""));
-			trans.add(new Regex("@@LOGDATE@@",log.getDate()));
-			trans.add(new Regex("@@LOGTYPE@@",image2TypeText(log.getIcon())));
-			trans.add(new Regex("@@LOGFINDERID@@",""));
-			trans.add(new Regex("@@LOGFINDER@@",log.getLogger()));
-			trans.add(new Regex("@@LOGENCODE@@",""));
-			trans.add(new Regex("@@LOGTEXT@@",log.getMessage()));
+			trans.add(new Regex("@@LOGID@@", ""));
+			trans.add(new Regex("@@LOGDATE@@", log.getDate()));
+			trans.add(new Regex("@@LOGTYPE@@", image2TypeText(log.getIcon())));
+			trans.add(new Regex("@@LOGFINDERID@@", ""));
+			trans.add(new Regex("@@LOGFINDER@@", SafeXML.cleanGPX(log.getLogger())));
+			trans.add(new Regex("@@LOGENCODE@@", ""));
+			trans.add(new Regex("@@LOGTEXT@@", SafeXML.cleanGPX(log.getMessage())));
 			ret.append(trans.replaceAll(GPXLOG));
 		}
+		
 		return ret.toString();
 	}
-	
+
 	public String formatHeader() {
 		Transformer trans = new Transformer(true);
-		trans.add(new Regex("@@CREATEDATE@@",new Date().setFormat("yyyy-MM-dd").toString()));
+		trans.add(new Regex("@@CREATEDATE@@", new Date()
+				.setFormat("yyyy-MM-dd").toString()));
 		return trans.replaceFirst(GPXHEADER);
 	}
-	
+
 	public String formatLongDescription(CacheHolder ch) {
 		if (ch.isAddiWpt() || ch.getType() == CacheType.CW_TYPE_CUSTOM) {
 			return ch.details.LongDescription;
 		} else {
-
 			StringBuffer ret = new StringBuffer();
 			String delim = "";
 			ret.append(ch.details.LongDescription);
 			if (ch.is_HTML()) {
-				delim="<br />";
+				delim = "<br />";
 			} else {
-				delim="\n";
+				delim = "\n";
 			}
-			//FIXME: format is not quite right yet
-			//FIXME: cut Addis off in GPXimporter otherwise people who use GPX to feed CacheWolf have them doubled
+			// FIXME: format is not quite right yet
+			// FIXME: cut Addis off in GPXimporter otherwise people who use GPX to feed CacheWolf have them doubled
 			if (ch.addiWpts.size() > 0) {
-
 				if (ch.is_HTML()) {
-					ret.append("<p>Additional Waypoints</p>");
+					ret.append("\n\n<p>Additional Waypoints</p>");
 				} else {
-					ret.append("Additional Waypoints\n");
+					ret.append("\n\nAdditional Waypoints\n");
 				}
 
 				Iterator iter = ch.addiWpts.iterator();
 				while (iter.hasNext()) {
 					CacheHolder addi = (CacheHolder) iter.next();
 					Transformer trans = new Transformer(true);
-					trans.add(new Regex("@@ADDIID@@",addi.getWayPoint()));
-					trans.add(new Regex("@@ADDISHORT@@",addi.getCacheName()));
-					trans.add(new Regex("@@ADDIDELIM@@",delim));
-					trans.add(new Regex("@@ADDILAT@@",formatAddiLatLon(addi.pos)));
-					trans.add(new Regex("@@ADDILON@@",""));
-					trans.add(new Regex("@@ADDILONG@@",addi.getFreshDetails().LongDescription));
+					trans.add(new Regex("@@ADDIID@@", addi.getWayPoint()));
+					trans.add(new Regex("@@ADDISHORT@@", addi.getCacheName()));
+					trans.add(new Regex("@@ADDIDELIM@@", delim));
+					trans.add(new Regex("@@ADDILAT@@", formatAddiLatLon(addi.pos)));
+					trans.add(new Regex("@@ADDILON@@", ""));
+					trans.add(new Regex("@@ADDILONG@@", addi.getFreshDetails().LongDescription));
 					ret.append(trans.replaceAll(GPXADDIINMAIN));
 				}
 				ret.append(delim).append("\n");
@@ -387,27 +571,42 @@
 			return ret.toString();
 		}
 	}
-	
-	public static String image2TypeText(String image){
-		if (image.equals("icon_smile.gif")) return "Found it";
-		if (image.equals("icon_sad.gif")) return "Didn't find it";
-		if (image.equals("icon_note.gif")) return "Write note";
-		if (image.equals("icon_enabled.gif")) return "Enable Listing";
-		if (image.equals("icon_disabled.gif")) return "Temporarily Disable Listing";
-		if (image.equals("icon_camera.gif")) return "Webcam Photo Taken";
-		if (image.equals("11.png")) return "Webcam Photo Taken";
-		if (image.equals("icon_attended.gif")) return "Attended";
-		if (image.equals("green.gif")) return "Publish Listing";
-		if (image.equals("icon_rsvp.gif")) return "Will Attend";
-		if (image.equals("big_smile.gif")) return "Post Reviewer Note";
-		if (image.equals("traffic_cone.gif")) return "Archive (show)";
-		if (image.equals("icon_maint.gif")) return "Owner Maintenance";
-		if (image.equals("icon_needsmaint.gif")) return "Needs Maintenance";
-		if (image.equals("coord_update.gif")) return "Update Coordinates";
 
+	public static String image2TypeText(String image) {
+		if (image.equals("icon_smile.gif"))
+			return "Found it";
+		if (image.equals("icon_sad.gif"))
+			return "Didn't find it";
+		if (image.equals("icon_note.gif"))
+			return "Write note";
+		if (image.equals("icon_enabled.gif"))
+			return "Enable Listing";
+		if (image.equals("icon_disabled.gif"))
+			return "Temporarily Disable Listing";
+		if (image.equals("icon_camera.gif"))
+			return "Webcam Photo Taken";
+		if (image.equals("11.png"))
+			return "Webcam Photo Taken";
+		if (image.equals("icon_attended.gif"))
+			return "Attended";
+		if (image.equals("green.gif"))
+			return "Publish Listing";
+		if (image.equals("icon_rsvp.gif"))
+			return "Will Attend";
+		if (image.equals("big_smile.gif"))
+			return "Post Reviewer Note";
+		if (image.equals("traffic_cone.gif"))
+			return "Archive (show)";
+		if (image.equals("icon_maint.gif"))
+			return "Owner Maintenance";
+		if (image.equals("icon_needsmaint.gif"))
+			return "Needs Maintenance";
+		if (image.equals("coord_update.gif"))
+			return "Update Coordinates";
+
 		return image;
 	}
-	
+
 	private String formatAddiLatLon(CWPoint pos) {
 		if (pos.isValid()) {
 			return pos.toString();
@@ -415,4 +614,155 @@
 			return "N/S  __ ? __ . ___ W/E ___ ? __ . ___";
 		}
 	}
+
+	/**
+	 * dialog to set the GPX exporter options
+	 */
+	private class GpxExportNgForm extends Form {
+		private CheckBoxGroup cbgExportType;
+		private mCheckBox cbCompact, cbPqLike, cbMyFinds, cbCustomIcons,
+				cbSeperateFiles, cbSendToGarmin, cbSmartId;
+		private mButton btnOk, btnCancel;
+
+		/**
+		 * set up the form / dialog
+		 */
+		public GpxExportNgForm() {
+			// TODO: get defaults from profile
+
+			this.setTitle("GPX Export");
+
+			cbgExportType = new CheckBoxGroup();
+
+			cbCompact = new mCheckBox("Compact");
+			cbCompact.setGroup(cbgExportType);
+
+			cbPqLike = new mCheckBox("PQ like");
+			cbPqLike.setGroup(cbgExportType);
+
+			cbMyFinds = new mCheckBox("MyFinds");
+			cbMyFinds.setGroup(cbgExportType);
+
+			cbgExportType.setText("Compact");
+
+			cbCustomIcons = new mCheckBox("custom icons");
+
+			cbSeperateFiles = new mCheckBox("one file per type");
+
+			cbSendToGarmin = new mCheckBox("send to Garmin GPSr");
+			cbSendToGarmin.modify(Control.Disabled, 0); // not yet
+
+			cbSmartId = new mCheckBox("use smart IDs");
+
+			btnOk = new mButton("OK");
+			btnCancel = new mButton("Cancel");
+
+			addNext(cbCustomIcons);
+			addLast(cbCompact);
+			addNext(cbSeperateFiles);
+			addLast(cbPqLike);
+			addNext(cbSendToGarmin);
+			addLast(cbMyFinds);
+			addLast(cbSmartId);
+
+			addButton(btnOk);
+			addButton(btnCancel);
+		}
+
+		/**
+		 * react to GUI events and toogle access to the checkboxes according to
+		 * radio button settings pass everything else to <code>super()</code>
+		 */
+		public void onEvent(Event ev) {
+			if (ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED) {
+
+				if (ev.target == cbgExportType) {
+					if (cbgExportType.getSelected() == cbCompact) {
+						if (cbCustomIcons.change(0, Control.Disabled))
+							cbCustomIcons.repaint();
+						if (cbSeperateFiles.change(0, Control.Disabled))
+							cbSeperateFiles.repaint();
+						// if (cbSendToGarmin.change(0,Control.Disabled))
+						// cbSendToGarmin.repaint();
+						if (cbSmartId.change(0, Control.Disabled))
+							cbSmartId.repaint();
+					} else if (cbgExportType.getSelected() == cbPqLike) {
+						cbSeperateFiles.setState(false);
+						if (cbCustomIcons.change(0, Control.Disabled))
+							cbCustomIcons.repaint();
+						if (cbSeperateFiles.change(Control.Disabled, 0))
+							cbSeperateFiles.repaint();
+						// if (cbSendToGarmin.change(0,Control.Disabled))
+						// cbSendToGarmin.repaint();
+						if (cbSmartId.change(0, Control.Disabled))
+							cbSmartId.repaint();
+					} else if (cbgExportType.getSelected() == cbMyFinds) {
+						cbCustomIcons.setState(false);
+						cbSeperateFiles.setState(false);
+						cbSendToGarmin.setState(false);
+						cbSmartId.setState(false);
+						if (cbCustomIcons.change(Control.Disabled, 0))
+							cbCustomIcons.repaint();
+						if (cbSeperateFiles.change(Control.Disabled, 0))
+							cbSeperateFiles.repaint();
+						// if (cbSendToGarmin.change(Control.Disabled,0))
+						// cbSendToGarmin.repaint();
+						if (cbSmartId.change(Control.Disabled, 0))
+							cbSmartId.repaint();
+					}
+				} else if (ev.target == btnOk) {
+					close(1);
+				} else if (ev.target == btnCancel) {
+					close(-1);
+				}
+			}
+			super.onEvent(ev);
+		}
+
+		/**
+		 * get the export type the user selected
+		 * 
+		 * @return index of selected option in checkboxgroup
+		 * @see GpxExportNg
+		 */
+		public int getExportType() {
+			return cbgExportType.getSelectedIndex();
+		}
+
+		/**
+		 * check if the user wants smart IDs
+		 * 
+		 * @return true for smart IDs, false otherwise
+		 */
+		public boolean getSmartIds() {
+			return cbSmartId.state;
+		}
+
+		/**
+		 * check if user wants to send output straight to a Garmin GPSr
+		 * 
+		 * @return true for GPSr transfer, false otherwise
+		 */
+		public boolean getSendToGarmin() {
+			return cbSendToGarmin.state;
+		}
+
+		/**
+		 * check if user wants custom icons
+		 * 
+		 * @return true if user wants custom icons, false otherwise
+		 */
+		public boolean getCustomIcons() {
+			return cbCustomIcons.state;
+		}
+
+		/**
+		 * check if user wants separate files (POI loader)
+		 * 
+		 * @return true for separate files, false for single file
+		 */
+		public boolean getSeparateFiles() {
+			return cbSeperateFiles.state;
+		}
+	}
 }

Deleted: trunk/src/exp/GpxExportNgForm.java
===================================================================
--- trunk/src/exp/GpxExportNgForm.java	2009-06-23 20:32:58 UTC (rev 1938)
+++ trunk/src/exp/GpxExportNgForm.java	2009-06-23 21:30:25 UTC (rev 1939)
@@ -1,137 +0,0 @@
-package exp;
-
-import ewe.ui.*;
-
-/**
- * GUI for GpxExporterNg with checkboxes for the options 
- *
- */
-public class GpxExportNgForm extends Form {
-	private CheckBoxGroup cbgExportType;
-	private mCheckBox cbCompact, cbPqLike, cbMyFinds, cbCustomIcons, cbSeperateFiles, cbSendToGarmin, cbSmartId;
-	private mButton btnOk, btnCancel;
-	
-	/**
-	 * set up the form / dialog
-	 */
-	public GpxExportNgForm() {
-		//TODO: get defaults from profile
-		
-		this.setTitle("GPX Export");
-		
-		cbgExportType = new CheckBoxGroup();
-		
-		cbCompact = new mCheckBox("Compact");
-		cbCompact.setGroup(cbgExportType);
-		
-		cbPqLike = new mCheckBox("PQ like");
-		cbPqLike.setGroup(cbgExportType);
-		
-		cbMyFinds = new mCheckBox("MyFinds");
-		cbMyFinds.setGroup(cbgExportType);
-		
-		cbgExportType.setText("Compact");
-		
-		cbCustomIcons = new mCheckBox("custom icons");
-		
-		cbSeperateFiles = new mCheckBox("one file per type");
-				
-		cbSendToGarmin = new mCheckBox("send to Garmin GPSr");
-		cbSendToGarmin.modify(Control.Disabled, 0); // not yet
-		
-		cbSmartId = new mCheckBox("use smart IDs");
-		
-		btnOk = new mButton("OK");
-		btnCancel = new mButton("Cancel");
-		
-		addNext(cbCustomIcons);
-		addLast(cbCompact);
-		addNext(cbSeperateFiles);
-		addLast(cbPqLike);
-		addNext(cbSendToGarmin);
-		addLast(cbMyFinds);
-		addLast(cbSmartId);
-
-		addButton(btnOk);
-		addButton(btnCancel);
-	}
-	
-	/**
-	 * react to GUI events and toogle access to the checkboxes according to radio button settings
-	 * pass everything else to <code>super()</code>
-	 */
-	public void onEvent(Event ev){
-		if (ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED) {
-						
-			if (ev.target == cbgExportType) {
-				if (cbgExportType.getSelected() == cbCompact) {
-					if (cbCustomIcons.change(0,Control.Disabled)) cbCustomIcons.repaint();
-					if (cbSeperateFiles.change(0,Control.Disabled)) cbSeperateFiles.repaint();
-//					if (cbSendToGarmin.change(0,Control.Disabled)) cbSendToGarmin.repaint();
-					if (cbSmartId.change(0,Control.Disabled)) cbSmartId.repaint();
-				} else if (cbgExportType.getSelected() == cbPqLike) {
-					cbSeperateFiles.setState(false);
-					if (cbCustomIcons.change(0,Control.Disabled)) cbCustomIcons.repaint();
-					if (cbSeperateFiles.change(Control.Disabled,0)) cbSeperateFiles.repaint();
-//					if (cbSendToGarmin.change(0,Control.Disabled)) cbSendToGarmin.repaint();
-					if (cbSmartId.change(0,Control.Disabled)) cbSmartId.repaint();
-				} else if (cbgExportType.getSelected() == cbMyFinds) {
-					cbCustomIcons.setState(false);
-					cbSeperateFiles.setState(false);
-					cbSendToGarmin.setState(false);
-					cbSmartId.setState(false);
-					if (cbCustomIcons.change(Control.Disabled,0)) cbCustomIcons.repaint();
-					if (cbSeperateFiles.change(Control.Disabled,0)) cbSeperateFiles.repaint();
-//					if (cbSendToGarmin.change(Control.Disabled,0)) cbSendToGarmin.repaint();
-					if (cbSmartId.change(Control.Disabled,0)) cbSmartId.repaint();
-				}
-			} else if (ev.target == btnOk) {
-				close(1);
-			} else if (ev.target == btnCancel) {
-				close(-1);
-			}
-		}
-		super.onEvent(ev);
-	}
-	
-	/**
-	 * get the export type the user selected
-	 * @return index of selected option in checkboxgroup
-	 * @see GpxExportNg
-	 */
-	public int getExportType() {
-		return cbgExportType.getSelectedIndex();
-	}
-	
-	/**
-	 * check if the user wants smart IDs
-	 * @return true for smart IDs, false otherwise
-	 */
-	public boolean getSmartIds() {
-		return cbSmartId.state;
-	}
-	
-	/**
-	 * check if user wants to send output straight to a Garmin GPSr
-	 * @return true for GPSr transfer, false otherwise
-	 */
-	public boolean getSendToGarmin() {
-		return cbSendToGarmin.state;
-	}
-	
-	/**
-	 * check if user wants custom icons
-	 * @return true if user wants custom icons, false otherwise
-	 */
-	public boolean getCustomIcons() {
-		return cbCustomIcons.state;
-	}
-	
-	/**
-	 * check if user wants separate files (POI loader)
-	 * @return true for separate files, false for single file
-	 */
-	public boolean getSeparateFiles() {
-		return cbSeperateFiles.state;
-	}
-}



From engywuck at mail.berlios.de  Wed Jun 24 15:46:28 2009
From: engywuck at mail.berlios.de (engywuck at mail.berlios.de)
Date: Wed, 24 Jun 2009 15:46:28 +0200
Subject: [Cachewolf-svn] r1940 - trunk/src/CacheWolf
Message-ID: <200906241346.n5ODkSAo020907@sheep.berlios.de>

Author: engywuck
Date: 2009-06-24 15:46:27 +0200 (Wed, 24 Jun 2009)
New Revision: 1940

Modified:
   trunk/src/CacheWolf/GPXImporter.java
Log:
Allowing for exceptions when parsing <time> entry in GPX files.

Modified: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2009-06-23 21:30:25 UTC (rev 1939)
+++ trunk/src/CacheWolf/GPXImporter.java	2009-06-24 13:46:27 UTC (rev 1940)
@@ -345,8 +345,13 @@
 			return;
 		}
 		
-		if (name.equals("time") && !inWpt) {
-			gpxDate.parse(strData.substring(0,19),"yyyy-MM-dd'T'HH:mm:ss");
+		if (name.equals("time") && !inWpt) {		    
+			try {
+			    gpxDate.parse(strData.substring(0,19),"yyyy-MM-dd'T'HH:mm:ss");
+			} catch (IllegalArgumentException e) {
+			    gpxDate.setTime(0);
+			    Global.getPref().log("Error parsing date: '"+strData+"'. Ignoring.");
+			}
 			return;
 		}
 
@@ -361,7 +366,11 @@
 		
 		if (name.equals("name") && inWpt && !inCache) {
 			holder.setWayPoint(strData);
-			holder.setLastSync(gpxDate.format("yyyyMMddHHmmss"));
+			if (gpxDate.getTime()!=0) {
+			    holder.setLastSync(gpxDate.format("yyyyMMddHHmmss"));
+			} else {
+			    holder.setLastSync("");
+			}    
 			//msgA.setText("import " + strData);
 			return;
 		}



From greiol at mail.berlios.de  Wed Jun 24 19:27:51 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Wed, 24 Jun 2009 19:27:51 +0200
Subject: [Cachewolf-svn] r1941 - in trunk: res_noewe/languages src/CacheWolf
	src/exp
Message-ID: <200906241727.n5OHRpXU006814@sheep.berlios.de>

Author: greiol
Date: 2009-06-24 19:27:40 +0200 (Wed, 24 Jun 2009)
New Revision: 1941

Removed:
   trunk/src/exp/PCX5Exporter.java
Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/exp/GpxExportNg.java
Log:
removed obsolete pcx5 exporter
added experimental more mapsource oriented gpx exporter for general testing

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-06-24 13:46:27 UTC (rev 1940)
+++ trunk/res_noewe/languages/DE.cfg	2009-06-24 17:27:40 UTC (rev 1941)
@@ -2,7 +2,7 @@
 	{LocalResources}
 		{de}
 		100=nach HTML
-		101=nach PCX5 Mapsource
+		101=nach GPX Mapsource
 		102=nach TOP50 ASCII
 		103=nach GPX
 		104=nach CSV

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-06-24 13:46:27 UTC (rev 1940)
+++ trunk/res_noewe/languages/EN.cfg	2009-06-24 17:27:40 UTC (rev 1941)
@@ -2,7 +2,7 @@
 	{LocalResources}
 		{en}
 		100=to HTML
-		101=to PCX5 Mapsource
+		101=to GPX Mapsource
 		102=to TOP50 ASCII
 		103=to GPX
 		104=to ASC

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-06-24 13:46:27 UTC (rev 1940)
+++ trunk/res_noewe/languages/FR.cfg	2009-06-24 17:27:40 UTC (rev 1941)
@@ -2,7 +2,7 @@
 	{LocalResources}
 		{fr}
 		100=vers HTML
-		101=vers PCX5 Mapsource
+		101=vers GPX Mapsource
 		102=vers TOP50 ASCII
 		103=vers GPX
 		104=vers CSV

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-06-24 13:46:27 UTC (rev 1940)
+++ trunk/res_noewe/languages/NL.cfg	2009-06-24 17:27:40 UTC (rev 1941)
@@ -2,7 +2,7 @@
 	{LocalResources}
 		{nl}
 		100=naar HTML
-		101=naar PCX5 MapSource
+		101=naar GPX MapSource
 		102=naar TOP50 ASCII
 		103=naar GPX
 		104=naar CSV

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2009-06-24 13:46:27 UTC (rev 1940)
+++ trunk/src/CacheWolf/MainMenu.java	2009-06-24 17:27:40 UTC (rev 1941)
@@ -28,7 +28,7 @@
 	private MenuItem downloadmap, kalibmap, importmap;
 	private MenuItem spider, spiderAllFinds, update, chkVersion;
 	private MenuItem about, wolflang, sysinfo, legend;
-	private MenuItem exportpcx5, exporthtml, exporttop50, exportGPX, exportASC, exportTomTom, exportMSARCSV;
+	private MenuItem exportGpxNg, exporthtml, exporttop50, exportGPX, exportASC, exportTomTom, exportMSARCSV;
 	private MenuItem exportOZI, exportKML, exportTPL, exportExplorist;
 	private MenuItem filtCreate, filtClear, filtInvert, filtSelected, filtNonSelected, filtBlack, filtApply;
 	private MenuItem exportLOC, exportGPS, mnuSeparator;
@@ -73,7 +73,7 @@
 		MenuItem[] exitems = new MenuItem[13];
 		//Vm.debug("Hi in MainMenu "+lr);
 		exitems[0] = exporthtml = new MenuItem(MyLocale.getMsg(100,"to HTML"));
-		exitems[1] = exportpcx5 = new MenuItem(MyLocale.getMsg(101,"to PCX5 Mapsource"));
+		exitems[1] = exportGpxNg = new MenuItem(MyLocale.getMsg(101,"to GPX Test"));
 		exitems[2] = exporttop50 = new MenuItem(MyLocale.getMsg(102,"to TOP50 ASCII"));
 		exitems[3] = exportGPX = new MenuItem(MyLocale.getMsg(103,"to GPX"));
 		exitems[4] = exportASC = new MenuItem(MyLocale.getMsg(104,"to CSV"));
@@ -379,16 +379,15 @@
 				HTMLExporter htm = new HTMLExporter(pref, profile);
 				htm.doIt();
 			}
-			if(mev.selectedItem == exportpcx5){
-				PCX5Exporter pcx = new PCX5Exporter( pref, profile);
-				pcx.doIt(PCX5Exporter.MODE_ASK);
+			if(mev.selectedItem == exportGpxNg){
+				GpxExportNg gpx = new GpxExportNg();
+				gpx.doit();
 			} 
 			if(mev.selectedItem == exporttop50){
 				OVLExporter ovl = new OVLExporter(pref, profile);
 				ovl.doIt();
 			}
 			if(mev.selectedItem == exportGPX){
-//				GpxExportNg gpx = new GpxExportNg();
 				GPXExporter gpx = new GPXExporter(pref,profile);
 				gpx.doIt(1);
 			}

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-24 13:46:27 UTC (rev 1940)
+++ trunk/src/exp/GpxExportNg.java	2009-06-24 17:27:40 UTC (rev 1941)
@@ -6,6 +6,7 @@
 import CacheWolf.CacheSize;
 import CacheWolf.CacheTerrDiff;
 import CacheWolf.CacheType;
+import CacheWolf.Common;
 import CacheWolf.Global;
 import CacheWolf.Log;
 import CacheWolf.LogList;
@@ -38,7 +39,6 @@
 import ewe.util.Iterator;
 import ewe.util.Random;
 
-//TODO: use safexml a lot more (at least start using it ;) )
 
 /**
  * experimental GPX exporter that should better handle the various tasks that
@@ -173,7 +173,7 @@
 			}
 			
 			if (sendToGarmin) {
-				tempDir = baseDir+File.separator+this.getClass().toString(); //FIXME: get from dialog
+				tempDir = baseDir+File.separator+this.getClass().toString();
 				new File(tempDir).mkdir();
 			} else {
 				tempDir = outDir;
@@ -253,7 +253,6 @@
 				
 				pbf.exit(0);
 				
-				//TODO: connect with image and build garmin poi file
 			} catch (Exception e) {
 				e.printStackTrace();
 				pbf.exit(0);
@@ -368,25 +367,39 @@
 
 		if (smartIds && ch.getType() != CacheType.CW_TYPE_CUSTOM) {
 			if (ch.isAddiWpt()) {
-				trans.add(new Regex("@@WPNAME@@", ch.mainCache.getWayPoint()
-						.concat(" ").concat(ch.getWayPoint().substring(0, 2))));
+				trans.add(new Regex("@@WPNAME@@", SafeXML.cleanGPX(ch.mainCache.getWayPoint()
+						.concat(" ")
+						.concat(ch.getWayPoint().substring(0, 2))
+						)));
 			} else {
-				trans.add(new Regex("@@WPNAME@@", ch.getWayPoint()
+				trans.add(new Regex("@@WPNAME@@", SafeXML.cleanGPX(ch.getWayPoint()
 						.concat(" ")
 						.concat(CacheType.getExportShortId(ch.getType()))
 						.concat(String.valueOf(ch.getTerrain()))
 						.concat(String.valueOf(ch.getHard()))
-						.concat(CacheSize.getExportShortId(ch.getCacheSize()))));
+						.concat(CacheSize.getExportShortId(ch.getCacheSize()))
+						)));
 			}
 		} else {
 			trans.add(new Regex("@@WPNAME@@", ch.getWayPoint()));
 		}
-
-		if (ch.isAddiWpt() || ch.getType() == CacheType.CW_TYPE_CUSTOM) {
-			trans.add(new Regex("@@WPCMT@@",
-					SafeXML.cleanGPX(ch.getFreshDetails().LongDescription)));
+		
+		if (ch.getType() == CacheType.CW_TYPE_CUSTOM) {
+			trans.add(new Regex("@@WPCMT@@", SafeXML.cleanGPX(ch.getFreshDetails().LongDescription)));
 		} else {
-			trans.add(new Regex("@@WPCMT@@", ""));
+			if (smartIds && outType == GPX_COMPACT) {
+				if (ch.isAddiWpt()) {
+					trans.add(new Regex("@@WPCMT@@", SafeXML.cleanGPX(ch.getCacheName()+" "+ch.getFreshDetails().LongDescription)));
+				} else {
+					trans.add(new Regex("@@WPCMT@@", SafeXML.cleanGPX(ch.getCacheName()+" "+Common.rot13(ch.getFreshDetails().Hints))));
+				}
+			} else {
+				if (ch.isAddiWpt()) {
+					trans.add(new Regex("@@WPCMT@@", SafeXML.cleanGPX(ch.getFreshDetails().LongDescription)));
+				} else {
+					trans.add(new Regex("@@WPCMT@@", ""));
+				}
+			}
 		}
 
 		if (ch.isAddiWpt()) {

Deleted: trunk/src/exp/PCX5Exporter.java
===================================================================
--- trunk/src/exp/PCX5Exporter.java	2009-06-24 13:46:27 UTC (rev 1940)
+++ trunk/src/exp/PCX5Exporter.java	2009-06-24 17:27:40 UTC (rev 1941)
@@ -1,65 +0,0 @@
-package exp;
-import CacheWolf.*;
-import ewe.io.FileBase;
-
-/**
-*	Class to export the cache database into an ascii file that may be imported
-*	ba Mapsource (c) by Garmin.
-*/
-public class PCX5Exporter extends Exporter{
-	public static int MODE_AUTO = TMP_FILE;
-	public static int MODE_ASK = ASK_FILE;
-	
-	public PCX5Exporter(Preferences p, Profile prof){
-		super();
-		this.setMask("*.wpt");
-		this.setTmpFileName(FileBase.getProgramDirectory() + "/temp.pcx");
-		this.setHowManyParams(NO_PARAMS);
-	}
-	
-	public String header () {
-		StringBuffer strBuf = new StringBuffer(200);
-
-		strBuf.append("H  SOFTWARE NAME & VERSION\n");
-		strBuf.append("I  PCX5 2.09\n");
-		strBuf.append("\n");
-		strBuf.append("H  R DATUM                IDX DA            DF            DX            DY            DZ\n");
-		strBuf.append("M  G WGS 84               121 +0.000000e+00 +0.000000e+00 +0.000000e+00 +0.000000e+00 +0.000000e+00\n");
-		strBuf.append("\n");
-		strBuf.append("H  COORDINATE SYSTEM\n");
-		strBuf.append("U  LAT LON DM\n");
-		strBuf.append("\n");
-		strBuf.append("H  IDNT   LATITUDE  LONGITUDE      DATE      TIME     ALT   DESCRIPTION                              PROXIMITY     SYMBOL ;waypts\r\n");
-		
-		return strBuf.toString();
-	}
-	
-	public String record(CacheHolder ch){
-		StringBuffer strBuf = new StringBuffer(200);
-		String latlonstr, dummy;
-
-		  strBuf.append("W  " + ch.getWayPoint() + " ");
-		  latlonstr = STRreplace.replace(ch.LatLon, "?", " ");
-		  latlonstr = STRreplace.replace(latlonstr, " ", "");
-		  latlonstr = STRreplace.replace(latlonstr, "E", " E");
-		  latlonstr = STRreplace.replace(latlonstr, "W", " W");
-		  strBuf.append(latlonstr + "     ");
-		  strBuf.append("01-JAN-04 01:00:00 -0000 ");
-		  // has 42 characters
-		  dummy = ch.getCacheName();
-		  if (dummy.length() < 40){
-			  strBuf.append(dummy);
-			  int i = 40 - dummy.length();
-			  for (; i > 0; i--){
-				  strBuf.append(' ');
-			  }
-		  } else {
-			  strBuf.append(dummy.substring(0,40));
-		  }
-		  strBuf.append(" 0.000000e+000 ");
-		  if(ch.is_found()) strBuf.append("  8256\r\n");
-		  else  		  strBuf.append("  8255\r\n");
-		return strBuf.toString();
-	}
-	
-}



From mik77 at mail.berlios.de  Thu Jun 25 10:40:01 2009
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Thu, 25 Jun 2009 10:40:01 +0200
Subject: [Cachewolf-svn] r1942 - trunk/src/CacheWolf
Message-ID: <200906250840.n5P8e1Wo021452@sheep.berlios.de>

Author: mik77
Date: 2009-06-25 10:39:54 +0200 (Thu, 25 Jun 2009)
New Revision: 1942

Modified:
   trunk/src/CacheWolf/SpiderGC.java
Log:
Fix for new GC-Login-String.

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2009-06-24 17:27:40 UTC (rev 1941)
+++ trunk/src/CacheWolf/SpiderGC.java	2009-06-25 08:39:54 UTC (rev 1942)
@@ -147,16 +147,16 @@
 					pref.log("[login]:Logging in as "+pref.myAlias);
 					StringBuffer sb=new StringBuffer(1000);
 					sb.append(URL.encodeURL("__VIEWSTATE",false));	sb.append("="); sb.append(URL.encodeURL(viewstate,false));
-					sb.append("&"); sb.append(URL.encodeURL("myUsername",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("myUsername",false));
 					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(pref.myAlias)));
-					sb.append("&"); sb.append(URL.encodeURL("myPassword",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("myPassword",false));
 					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(passwort)));
-					sb.append("&"); sb.append(URL.encodeURL("cookie",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("cookie",false));
 					sb.append("="); sb.append(URL.encodeURL("on",false));
-					sb.append("&"); sb.append(URL.encodeURL("Button1",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("Button1",false));
 					sb.append("="); sb.append(URL.encodeURL("Login",false));
-					sb.append("&"); sb.append(URL.encodeURL("__EVENTVALIDATION",false));
-					sb.append("="); sb.append(URL.encodeURL(eventvalidation,false));
+//					sb.append("&"); sb.append(URL.encodeURL("__EVENTVALIDATION",false));
+//					sb.append("="); sb.append(URL.encodeURL(eventvalidation,false));
 					start = fetch_post(loginPage, sb.toString(), nextPage);  // /login/default.aspx
 					if(start.indexOf(loginSuccess) > 0)
 						pref.log("[login]:Login successful");



From mik77 at mail.berlios.de  Thu Jun 25 11:06:39 2009
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Thu, 25 Jun 2009 11:06:39 +0200
Subject: [Cachewolf-svn] r1943 - branches/bugfix_1.0/src/CacheWolf
Message-ID: <200906250906.n5P96doj022947@sheep.berlios.de>

Author: mik77
Date: 2009-06-25 11:06:32 +0200 (Thu, 25 Jun 2009)
New Revision: 1943

Modified:
   branches/bugfix_1.0/src/CacheWolf/SpiderGC.java
Log:
Fix for new GC-Login-String.

Modified: branches/bugfix_1.0/src/CacheWolf/SpiderGC.java
===================================================================
--- branches/bugfix_1.0/src/CacheWolf/SpiderGC.java	2009-06-25 08:39:54 UTC (rev 1942)
+++ branches/bugfix_1.0/src/CacheWolf/SpiderGC.java	2009-06-25 09:06:32 UTC (rev 1943)
@@ -143,16 +143,16 @@
 					pref.log("[login]:Logging in as "+pref.myAlias);
 					StringBuffer sb=new StringBuffer(1000);
 					sb.append(URL.encodeURL("__VIEWSTATE",false));	sb.append("="); sb.append(URL.encodeURL(viewstate,false));
-					sb.append("&"); sb.append(URL.encodeURL("myUsername",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("myUsername",false));
 					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(pref.myAlias)));
-					sb.append("&"); sb.append(URL.encodeURL("myPassword",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("myPassword",false));
 					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(passwort)));
-					sb.append("&"); sb.append(URL.encodeURL("cookie",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("cookie",false));
 					sb.append("="); sb.append(URL.encodeURL("on",false));
-					sb.append("&"); sb.append(URL.encodeURL("Button1",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("Button1",false));
 					sb.append("="); sb.append(URL.encodeURL("Login",false));
-					sb.append("&"); sb.append(URL.encodeURL("__EVENTVALIDATION",false));
-					sb.append("="); sb.append(URL.encodeURL(eventvalidation,false));
+//					sb.append("&"); sb.append(URL.encodeURL("__EVENTVALIDATION",false));
+//					sb.append("="); sb.append(URL.encodeURL(eventvalidation,false));
 					start = fetch_post(loginPage, sb.toString(), nextPage);  // /login/default.aspx
 					if(start.indexOf(loginSuccess) > 0)
 						pref.log("[login]:Login successful");



From araber95 at mail.berlios.de  Thu Jun 25 22:20:08 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Thu, 25 Jun 2009 22:20:08 +0200
Subject: [Cachewolf-svn] r1944 - trunk/res_noewe/webmapservices
Message-ID: <200906252020.n5PKK8qw015113@sheep.berlios.de>

Author: araber95
Date: 2009-06-25 22:20:07 +0200 (Thu, 25 Jun 2009)
New Revision: 1944

Modified:
   trunk/res_noewe/webmapservices/de-ni_p.wms
Log:
changed mapformattpy from png to jpg due to smaller filesize

Modified: trunk/res_noewe/webmapservices/de-ni_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/de-ni_p.wms	2009-06-25 09:06:32 UTC (rev 1943)
+++ trunk/res_noewe/webmapservices/de-ni_p.wms	2009-06-25 20:20:07 UTC (rev 1944)
@@ -31,7 +31,7 @@
 #LayersUrlPart:     LAYERS=19|Schrift: Kleine Orte||
 LayersUrlPart:     LAYERS=12
 StylesUrlPart:     STYLES=
-ImageFormatUrlPart:FORMAT=image/png
+ImageFormatUrlPart:FORMAT=image/jpeg
 BoundingBoxTopLeftWGS84: N 53.898485 E 6.600296
 BoundingBoxButtomRightWGS84: N 51.265165 E 11.665345
 MinScale:   0
@@ -39,5 +39,5 @@
 RecommendedScale:   1
 #MinSFInput:0
 #MaxSFInput:1,9586
-ImageFileExtension: .png
+ImageFileExtension: .jpg
 #weitere Overlays hinzuf?gen geht bei Photo nicht.
\ No newline at end of file



From greiol at mail.berlios.de  Fri Jun 26 00:04:45 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 26 Jun 2009 00:04:45 +0200
Subject: [Cachewolf-svn] r1945 - trunk/src/exp
Message-ID: <200906252204.n5PM4jwp024678@sheep.berlios.de>

Author: greiol
Date: 2009-06-26 00:04:42 +0200 (Fri, 26 Jun 2009)
New Revision: 1945

Modified:
   trunk/src/exp/GpxExportNg.java
Log:
set all unknown log types to "Write note"

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-25 20:20:07 UTC (rev 1944)
+++ trunk/src/exp/GpxExportNg.java	2009-06-25 22:04:42 UTC (rev 1945)
@@ -586,38 +586,38 @@
 	}
 
 	public static String image2TypeText(String image) {
-		if (image.equals("icon_smile.gif"))
+		if (image.indexOf("icon_smile.gif") > -1)
 			return "Found it";
-		if (image.equals("icon_sad.gif"))
+		if (image.indexOf("icon_sad.gif") > -1)
 			return "Didn't find it";
-		if (image.equals("icon_note.gif"))
+		if (image.indexOf("icon_note.gif") > -1)
 			return "Write note";
-		if (image.equals("icon_enabled.gif"))
+		if (image.indexOf("icon_enabled.gif") > -1)
 			return "Enable Listing";
-		if (image.equals("icon_disabled.gif"))
+		if (image.indexOf("icon_disabled.gif") > -1)
 			return "Temporarily Disable Listing";
-		if (image.equals("icon_camera.gif"))
+		if (image.indexOf("icon_camera.gif") > -1)
 			return "Webcam Photo Taken";
-		if (image.equals("11.png"))
+		if (image.indexOf("11.png") > -1)
 			return "Webcam Photo Taken";
-		if (image.equals("icon_attended.gif"))
+		if (image.indexOf("icon_attended.gif") > -1)
 			return "Attended";
-		if (image.equals("green.gif"))
+		if (image.indexOf("green.gif") > -1)
 			return "Publish Listing";
-		if (image.equals("icon_rsvp.gif"))
+		if (image.indexOf("icon_rsvp.gif") > -1)
 			return "Will Attend";
-		if (image.equals("big_smile.gif"))
+		if (image.indexOf("big_smile.gif") > -1)
 			return "Post Reviewer Note";
-		if (image.equals("traffic_cone.gif"))
+		if (image.indexOf("traffic_cone.gif") > -1)
 			return "Archive (show)";
-		if (image.equals("icon_maint.gif"))
+		if (image.indexOf("icon_maint.gif") > -1)
 			return "Owner Maintenance";
-		if (image.equals("icon_needsmaint.gif"))
+		if (image.indexOf("icon_needsmaint.gif") > -1)
 			return "Needs Maintenance";
-		if (image.equals("coord_update.gif"))
+		if (image.indexOf("coord_update.gif") > -1)
 			return "Update Coordinates";
-
-		return image;
+		Global.getPref().log("unknown logtype "+image);
+		return "Write note";
 	}
 
 	private String formatAddiLatLon(CWPoint pos) {



From greiol at mail.berlios.de  Fri Jun 26 08:22:19 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 26 Jun 2009 08:22:19 +0200
Subject: [Cachewolf-svn] r1946 - trunk/src/exp
Message-ID: <200906260622.n5Q6MJjD007802@sheep.berlios.de>

Author: greiol
Date: 2009-06-26 08:22:17 +0200 (Fri, 26 Jun 2009)
New Revision: 1946

Modified:
   trunk/src/exp/HTMLExporter.java
Log:
improved error messages

Modified: trunk/src/exp/HTMLExporter.java
===================================================================
--- trunk/src/exp/HTMLExporter.java	2009-06-25 22:04:42 UTC (rev 1945)
+++ trunk/src/exp/HTMLExporter.java	2009-06-26 06:22:17 UTC (rev 1946)
@@ -59,7 +59,7 @@
 			Vector usrImg = new Vector();
 			Vector logIcons = new Vector(15);
 			String icon;
-			int incompleteWaypoint = 0;
+			int exportErrors = 0;
 
 			Hashtable varParams;
 			Hashtable imgParams;
@@ -81,8 +81,8 @@
 				ch = cacheDB.get(i);
 				if(	ch.isVisible()){
 					if (ch.is_incomplete()) {
-						incompleteWaypoint++;
-						Global.getPref().log("skipping export of incomplete waypoint "+ch.getWayPoint());
+						exportErrors++;
+						Global.getPref().log("HTMLExport: skipping export of incomplete waypoint "+ch.getWayPoint());
 						continue;
 					}
 					det=ch.getExistingDetails();
@@ -227,10 +227,11 @@
 						pagefile.print(page_tpl.output());
 						pagefile.close();
 					}catch(Exception e){
-						Vm.debug("Problem writing waypoint html file"+e);
+						exportErrors++;
+						Global.getPref().log("HTMLExport: error wehen exporting "+ch.getWayPoint()+" reason: ",e);
 					}
-					if (incompleteWaypoint > 0) {
-						new MessageBox("Export Error", incompleteWaypoint+" incomplete waypoints have not been exported. See log for details.", FormBase.OKB).execute();
+					if (exportErrors > 0) {
+						new MessageBox("Export Error", exportErrors+" waypoints have not been exported. See log for details.", FormBase.OKB).execute();
 					}
 				}//if is black, filtered
 			}



From mik77 at mail.berlios.de  Fri Jun 26 12:47:22 2009
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Fri, 26 Jun 2009 12:47:22 +0200
Subject: [Cachewolf-svn] r1947 - in
	branches/bugfix_1.0/res_noewe/webmapservices: . untested
Message-ID: <200906261047.n5QAlMq9027113@sheep.berlios.de>

Author: mik77
Date: 2009-06-26 12:46:32 +0200 (Fri, 26 Jun 2009)
New Revision: 1947

Added:
   branches/bugfix_1.0/res_noewe/webmapservices/de-ni_p.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t100.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t100_lv.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t25.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-rp_p.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-rp_t25.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-rp_t50.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-th_t25.wms
   branches/bugfix_1.0/res_noewe/webmapservices/it-88_m.wms
   branches/bugfix_1.0/res_noewe/webmapservices/it-88_p.wms
   branches/bugfix_1.0/res_noewe/webmapservices/it-88_t10.wms
   branches/bugfix_1.0/res_noewe/webmapservices/it_p.wms
   branches/bugfix_1.0/res_noewe/webmapservices/it_t100.wms
   branches/bugfix_1.0/res_noewe/webmapservices/it_t25.wms
Removed:
   branches/bugfix_1.0/res_noewe/webmapservices/de-ni_topo-photo_auto.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-ni_topo_100.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-rlp_photo.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-rlp_topo_50.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-sn_photo.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_10.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_25.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_50.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-th_photo.wms
   branches/bugfix_1.0/res_noewe/webmapservices/de-th_topo_50.wms
   branches/bugfix_1.0/res_noewe/webmapservices/it.tos_topo-monochrome_auto.wms
   branches/bugfix_1.0/res_noewe/webmapservices/it.tos_topo-simplistic_auto.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_pt.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_t100.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_p.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_t50.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/de-th_p.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/de-th_t50.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_m.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_p.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_t10.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/it_t.wms
   branches/bugfix_1.0/res_noewe/webmapservices/untested/us_t.wms
Log:
WMS update from trunk

Added: branches/bugfix_1.0/res_noewe/webmapservices/de-ni_p.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-ni_p.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-ni_p.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,43 @@
+TakenFromUrl:       http://www.umwelt.niedersachsen.de/master/C7089178_N7088657_L20_D0_I598.html
+GetCapabilitiesUrl: http://www.umweltkarten.niedersachsen.de/arcgis/services/Programme/MapServer/WMSServer?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Niedersachsen photo c SF=0..1,95
+MapType:                        photo
+#MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/GR_Gebiete/MapServer/WMSServer?
+MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/Programme/MapServer/WMSServer?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31467
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31467 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=0|Gebiete mit gesamtstaatlicher repr?sentativer Bedeutung|2.772396|Infinity
+#LayersUrlPart:     LAYERS=1|Flie?gew?sserschutzsystem Verbindungsgew?sser|2.772396|Infinity
+#LayersUrlPart:     LAYERS=2|Flie?gew?sserschutzsystem Hauptgew?sser und Auen|2.772396|Infinity
+#LayersUrlPart:     LAYERS=3|Moorschutzprogramm Neubewertung|2,772396|Infinity
+#LayersUrlPart:     LAYERS=4|Moorschutzprogramm Teil II|2.772396|Infinity
+#LayersUrlPart:     LAYERS=5|Abgrenzung des Hochmoorkomplexes MSP Teil I|2.772396|Infinity
+#LayersUrlPart:     LAYERS=6|Moorschutzprogramm (MSP) Teil I|2.772396|Infinity
+#LayersUrlPart:     LAYERS=7|Untere  Naturschutzbeh?rden|2.772396|Infinity
+#LayersUrlPart:     LAYERS=8|Landkreise||
+#LayersUrlPart:     LAYERS=9|Ortslagen|99.000000|237.600000
+#LayersUrlPart:     LAYERS=10|Grosse Seen|198.000000|Infinity
+#LayersUrlPart:     LAYERS=11|Gro?e Fl?sse|198.000000|Infinity
+#LayersUrlPart:     LAYERS=12|Orthophoto Farbe|0.0|2.772000
+#LayersUrlPart:     LAYERS=13|DTK 25|2.772396|4.950000
+#LayersUrlPart:     LAYERS=14|TK 50|4.950396|9.900000
+#LayersUrlPart:     LAYERS=15|TK 100|9.900396|29.700000
+#LayersUrlPart:     LAYERS=16|TK 500|29.700396|99.000000
+#LayersUrlPart:     LAYERS=17|Autobahnen||
+#LayersUrlPart:     LAYERS=18|Schrift: Gro?e Orte||
+#LayersUrlPart:     LAYERS=19|Schrift: Kleine Orte||
+LayersUrlPart:     LAYERS=12
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 53.898485 E 6.600296
+BoundingBoxButtomRightWGS84: N 51.265165 E 11.665345
+MinScale:   0
+MaxScale:   2.772396
+RecommendedScale:   1
+#MinSFInput:0
+#MaxSFInput:1,9586
+ImageFileExtension: .jpg
+#weitere Overlays hinzuf?gen geht bei Photo nicht.
\ No newline at end of file

Copied: branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t100.wms (from rev 1942, branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_t100.wms)
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_t100.wms	2009-06-25 08:39:54 UTC (rev 1942)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t100.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,23 @@
+TakenFromUrl:       http://www.lgn.de
+GetCapabilitiesUrl: http://www.mapserver.niedersachsen.de/freezoneogc/mapserverogc?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Niedersachsen t100 c SF=4.78..37.35
+MapType:                        topo
+MainUrl:            http://www.mapserver.niedersachsen.de/freezoneogc/mapserverogc?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31467
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31467 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=DUEKN5000|Uebersichtskarte 1:5000000|232.14267523852232|4887.214215547839
+#LayersUrlPart:     LAYERS=DUEKN1000|Uebersichtskarte 1:1000000|52.82503600628914|422.6002880503131
+#LayersUrlPart:     LAYERS=DUEKN500|Uebersichtskarte 1:500000|17.86128289273423|198.4586988081581
+#LayersUrlPart:     LAYERS=TK100|Topographische Karte 1:100000|6,76160460880501|52.82503600628914
+LayersUrlPart:     LAYERS=TK100
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 54.9403 E 6.1804
+BoundingBoxButtomRightWGS84: N 50.5028 E 13.6833
+MinScale:   6.76160460880501
+MaxScale:   52.82503600628914
+RecommendedScale:   5
+ImageFileExtension: .png

Added: branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t100_lv.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t100_lv.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t100_lv.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,37 @@
+TakenFromUrl:       http://www.geobasisdaten.niedersachsen.de/bestand?
+GetCapabilitiesUrl: http://www.geobasisdaten.niedersachsen.de/bestand?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Niedersachsen t100 c SF=~0,7 .. 400 LV NI
+MapType:                        topo
+MainUrl:            http://www.geobasisdaten.niedersachsen.de/bestand?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+#CoordinateReferenceSystemCacheWolf:  31466 31467 31468 31469 4326
+#CoordinateReferenceSystemUrlPart: SRS=EPSG:31466 SRS=EPSG:31467 SRS=EPSG:31468 SRS=EPSG:31469 SRS=EPSG:4326 
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=geodatenbasisbestand|Bestands?bersicht||
+#LayersUrlPart:     LAYERS=navigation_f|Navigation, farbig||
+#LayersUrlPart:     LAYERS=ueb5000_nf|?bersichtskarte 1:5.000.000|407.859199979508|9899.49490168847
+#LayersUrlPart:     LAYERS=ueb1000_nf|?bersichtskarte 1:1.000.000|126.713500006|407.859199979508
+#LayersUrlPart:     LAYERS=ukn500_nf|?bersichtskarte 1:500.000|44.901280999479|126.713500006
+#LayersUrlPart:     LAYERS=dtk100_v_nf|Topographische Karte 1:100.000|0.498902848429637|44.901280999479
+#LayersUrlPart:     LAYERS=dtk100_v_b|Topographische Karte 1:100.000||
+#LayersUrlPart:     LAYERS=dtk50_v_b|Topographische Karte 1:50.000||
+#LayersUrlPart:     LAYERS=dtk50_b|Digitale Topographische Karte 1:50.000||
+#LayersUrlPart:     LAYERS=dtk25_b|Digitale Topographische Karte 1:25.000||
+#LayersUrlPart:     LAYERS=pl25_b|Preu?ische Landesaufnahme 1:25.000||
+#LayersUrlPart:     LAYERS=dsk10_b|Digitale Stra?enkarte 1:10.000||
+#LayersUrlPart:     LAYERS=ak5_b|Amtliche Karte 1:5.000||
+#LayersUrlPart:     LAYERS=dop40_b|Digitales Orthophoto||
+LayersUrlPart:     LAYERS=navigation_f
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 54.5549 E 5.8986
+BoundingBoxButtomRightWGS84: N 50.6539 E 12.6239
+#BBox_Mitte: N 52.6044 E 9.261245
+MinScale:   0.7
+MaxScale:   14000
+RecommendedScale:   5
+ImageFileExtension: .jpg
+#SF von 0.4989 bis 9899.4949 * sqrt(2)

Added: branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t25.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t25.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-ni_t25.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,44 @@
+TakenFromUrl:       http://www.umwelt.niedersachsen.de/master/C7089178_N7088657_L20_D0_I598.html
+GetCapabilitiesUrl: http://www.umweltkarten.niedersachsen.de/arcgis/services/Programme/MapServer/WMSServer?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Niedersachsen t25 b/w ?c SF=1,95..3,5
+MapType:                        topo
+#MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/GR_Gebiete/MapServer/WMSServer?
+MainUrl:            http://www.umweltkarten.niedersachsen.de/arcgis/services/Programme/MapServer/WMSServer?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31467
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31467 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=0|Gebiete mit gesamtstaatlicher repr?sentativer Bedeutung|2.772396|Infinity
+#LayersUrlPart:     LAYERS=1|Flie?gew?sserschutzsystem Verbindungsgew?sser|2.772396|Infinity
+#LayersUrlPart:     LAYERS=2|Flie?gew?sserschutzsystem Hauptgew?sser und Auen|2.772396|Infinity
+#LayersUrlPart:     LAYERS=3|Moorschutzprogramm Neubewertung|2,772396|Infinity
+#LayersUrlPart:     LAYERS=4|Moorschutzprogramm Teil II|2.772396|Infinity
+#LayersUrlPart:     LAYERS=5|Abgrenzung des Hochmoorkomplexes MSP Teil I|2.772396|Infinity
+#LayersUrlPart:     LAYERS=6|Moorschutzprogramm (MSP) Teil I|2.772396|Infinity
+#LayersUrlPart:     LAYERS=7|Untere  Naturschutzbeh?rden|2.772396|Infinity
+#LayersUrlPart:     LAYERS=8|Landkreise||
+#LayersUrlPart:     LAYERS=9|Ortslagen|99.000000|237.600000
+#LayersUrlPart:     LAYERS=10|Grosse Seen|198.000000|Infinity
+#LayersUrlPart:     LAYERS=11|Gro?e Fl?sse|198.000000|Infinity
+#LayersUrlPart:     LAYERS=12|Orthophoto Farbe|0.0|2.772000
+#LayersUrlPart:     LAYERS=13|DTK 25|2.772396|4.950000
+#LayersUrlPart:     LAYERS=14|TK 50|4.950396|9.900000
+#LayersUrlPart:     LAYERS=15|TK 100|9.900396|29.700000
+#LayersUrlPart:     LAYERS=16|TK 500|29.700396|99.000000
+#LayersUrlPart:     LAYERS=17|Autobahnen||
+#LayersUrlPart:     LAYERS=18|Schrift: Gro?e Orte||
+#LayersUrlPart:     LAYERS=19|Schrift: Kleine Orte||
+#LayersUrlPart:     LAYERS=13,1,3,4,5,6,17,18,19
+#LayersUrlPart:     LAYERS=13
+LayersUrlPart:     LAYERS=13,17,18,19
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 54.001848 E 6.579380
+BoundingBoxButtomRightWGS84: N 51.372735 E 11.734608
+MinScale:   2.772396
+MaxScale:   4.950000
+RecommendedScale:   2,5
+#MinSFInput:1,9586
+#MaxSFInput:3,5001
+ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-ni_topo-photo_auto.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-ni_topo-photo_auto.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-ni_topo-photo_auto.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,22 +0,0 @@
-# please refer to readme_wms.txt for an explantion of this file format
-# taken from: ip-trace from niedersachenviewerPlus
-TakenFromUrl:	http://www.umwelt.niedersachsen.de/master/C7065327_N6991478_L20_D0_I598.html
-GetCapabilitiesUrl:	http://geoportal.geodaten.niedersachsen.de/geodatenportal/servlet/gtEntryPoint?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.1.1
-Name:	de.ni Topo-Photo AutoDetail
-MapType:	topo
-MainUrl:	http://geoportal.geodaten.niedersachsen.de/geodatenportal/servlet/gtEntryPoint?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31466 31467 31468 31469
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467 SRS=EPSG:31468 SRS=EPSG:31469
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=layer_1512,layer_1513,layer_1514,layer_1507,layer_1508,layer_1509,layer_1510,layer_1511,layer_1515
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-# transformed from Gau?-Kr?ger into wgs84
-BoundingBoxTopLeftWGS84:	N 53.99192 E 006.62073
-BoundingBoxButtomRightWGS84:	N 51.27316 E 011.58000
-MinScale:	0.267412
-MaxScale:	59899.495
-RecommendedScale:	5.0
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-ni_topo_100.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-ni_topo_100.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-ni_topo_100.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-# please refere to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.mapserver.niedersachsen.de/freezoneogc/mapserverogc?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
-Name:	de.ni Topo 100
-MapType:	topo
-MainUrl:	http://www.mapserver.niedersachsen.de/freezoneogc/mapserverogc?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=TK100
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 54.940306 E 6.180364
-BoundingBoxButtomRightWGS84:	N 50.502795 E 13.683332
-MinScale:	6.76160460880501
-MaxScale:	52.82503600628914
-RecommendedScale:	15.0
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-rlp_photo.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-rlp_photo.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-rlp_photo.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-# please refer to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.rlp Luftbild
-MapType:	photo
-MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=freedop%3Adop
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   0.5
-MaxScale:   24.95
-RecommendedScale:	0.4
-ImageFileExtension: .png 

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-rlp_topo_50.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-rlp_topo_50.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-rlp_topo_50.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-# please refer to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.rlp Topo 50
-MapType:	topo
-MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=rlp%3Atk50
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   7.001
-MaxScale:   15.0
-RecommendedScale:	5.0
-ImageFileExtension: .png 
\ No newline at end of file

Copied: branches/bugfix_1.0/res_noewe/webmapservices/de-rp_p.wms (from rev 1942, branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_p.wms)
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_p.wms	2009-06-25 08:39:54 UTC (rev 1942)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-rp_p.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,29 @@
+TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
+GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
+Name:	de.Rheinland-Pfalz photo SF=0,36..17,6
+MapType:	photo
+MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
+ServiceTypeUrlPart:	SERVICE=WMS 
+VersionUrlPart:	VERSION=1.1.1 
+CoordinateReferenceSystemCacheWolf:   31466 31467
+CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:   REQUEST=GetMap
+#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
+#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
+#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
+#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
+#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
+#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
+#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
+#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
+#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
+LayersUrlPart:   LAYERS=freedop%3Adop
+StylesUrlPart:   STYLES=
+ImageFormatUrlPart:   FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 51.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 48.8000 E 8.7000
+MinScale:   0.5
+MaxScale:   24.95
+RecommendedScale:	0.4
+ImageFileExtension: .jpg 
+# weitergehende Skaliwerungen nicht gepr?ft
\ No newline at end of file

Added: branches/bugfix_1.0/res_noewe/webmapservices/de-rp_t25.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-rp_t25.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-rp_t25.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,29 @@
+TakenFromUrl:       http://www.vermkv.rlp.de
+GetCapabilitiesUrl: http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Rheinland-Pfalz t25 sf=0,5..6
+MapType:                        topo
+MainUrl:            http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31466 31467
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
+#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
+#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
+#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
+#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
+#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
+#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
+#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
+#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
+LayersUrlPart:     LAYERS=rlp%3Atk25
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 51.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 48.8000 E 8.7000
+MinScale:   1
+MaxScale:   50
+RecommendedScale:   2,5
+ImageFileExtension: .png
+#nimmt wohl alle Skalierungen

Copied: branches/bugfix_1.0/res_noewe/webmapservices/de-rp_t50.wms (from rev 1942, branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_t50.wms)
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_t50.wms	2009-06-25 08:39:54 UTC (rev 1942)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-rp_t50.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,29 @@
+TakenFromUrl:       http://www.vermkv.rlp.de
+GetCapabilitiesUrl: http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Rheinland-Pfalz t50 sf=4..12
+MapType:                        topo
+MainUrl:            http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31466 31467
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31466 SRS=EPSG:31467
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
+#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
+#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
+#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
+#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
+#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
+#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
+#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
+#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
+LayersUrlPart:     LAYERS=rlp%3Atk50
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 51.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 48.8000 E 8.7000
+MinScale:   1
+MaxScale:   50
+RecommendedScale:   5
+ImageFileExtension: .png
+#nimmt wohl alle Skalierungen

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-sn_photo.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-sn_photo.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-sn_photo.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-# please refere to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVDOPFREE/WMSFREE_TK/WMSFREE_TK/wmsservice?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.sn Luftbild
-MapType:	photo
-MainUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVDOPFREE/WMSFREE_TK/WMSFREE_TK/wmsservice?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31468 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=c
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 51.8592 E 11.7651
-BoundingBoxButtomRightWGS84:	N 50.0294 E 15.1358
-MinScale:	0.65
-MaxScale:	4.98853
-RecommendedScale:	0.5
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_10.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_10.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_10.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-# please refere to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.sn Topo 10
-MapType:	topo
-MainUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31468 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=TK10
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 51.8592 E 11.7651
-BoundingBoxButtomRightWGS84:	N 50.0294 E 15.1358
-MinScale:	0.0503892
-MaxScale:	2.49451
-RecommendedScale:	1.0
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_25.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_25.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_25.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-# please refere to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.sn Topo 25
-MapType:	topo
-MainUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31468 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=TK25
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 51.8592 E 11.7651
-BoundingBoxButtomRightWGS84:	N 50.0294 E 15.1358
-MinScale:	2.49451
-MaxScale:	4.98903
-RecommendedScale:	2.5
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_50.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_50.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-sn_topo_50.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-# please refere to readme_wms.txt for an explantion of this file format
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.sn Topo 50
-MapType:	topo
-MainUrl:	http://www.landesvermessung.sachsen.de/ias/basiskarte/service/SRVTKFREE/WMSFREE_TK/wmsservice?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31468 
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=TK50
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 51.8592 E 11.7651
-BoundingBoxButtomRightWGS84:	N 50.0294 E 15.1358
-MinScale:	4.98903
-MaxScale:	12.4726
-RecommendedScale:	5.0
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-th_photo.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-th_photo.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-th_photo.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.thueringen.de/de/tlvermgeo/onlineservice/web_map_service/content.html
-GetCapabilitiesUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de.th Luftbild
-MapType:	photo
-MainUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31468
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Orthophotos_TH-2m
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84:	N 52.0000 E 9.5000
-BoundingBoxButtomRightWGS84:	N 50.0000 E 13.0000
-MinScale:   0.399122
-MaxScale:   9.97806
-RecommendedScale:   2.0
-ImageFileExtension: .jpg
-

Added: branches/bugfix_1.0/res_noewe/webmapservices/de-th_t25.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-th_t25.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-th_t25.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,358 @@
+TakenFromUrl:       http://www.geoproxy.geoportal-th.de
+GetCapabilitiesUrl: http://www.geoproxy.geoportal-th.de/geoproxy/services?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               de.Th?ringen t25 SF=~1..8
+MapType:                        topo
+MainUrl:            http://www.geoproxy.geoportal-th.de/geoproxy/services?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  31467 31468
+CoordinateReferenceSystemUrlPart: SRS=EPSG:31467 SRS=EPSG:31468 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=TZV|Zweckverbaende Trinkwasser|279.99972|6.99972
+#LayersUrlPart:     LAYERS=BNTNUTZ11|Landnutzung aus BNT 11|27.99972|1.39972
+#LayersUrlPart:     LAYERS=BNTNUTZ25|Landnutzung aus BNT 25|27.99972|1.39972
+#LayersUrlPart:     LAYERS=bodengeologie|Bodengeologische Karte|55.99972|2.79972
+#LayersUrlPart:     LAYERS=tempdiff_j|Temperaturdifferenz ganzjaehrig|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempdiff_w|Temperaturdifferenz Winter|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempmittel_f|Prognose Temperaturmittel Fruehling|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempmittel_s|Prognose Temperaturmittel Sommer|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempmittel_w|Prognose Temperaturmittel Winter|279.99972|6.99972
+#LayersUrlPart:     LAYERS=tempmittel_j|Prognose Temperaturmittel Jahr|279.99972|6.99972
+#LayersUrlPart:     LAYERS=th_eigentum_fl|Waldeigentum|6.99972|0.13972
+#LayersUrlPart:     LAYERS=zweckverband|Zweckverbaende Abwasser|279.99972|6.99972
+#LayersUrlPart:     LAYERS=dgk2007|digitale Grundkarte Landwirtschaft|25.19974|0.05571
+#LayersUrlPart:     LAYERS=gesamtkarte|Geothermiekarte|139.99972|2.79972
+#LayersUrlPart:     LAYERS=naturraum|Naturraeume|279.99972|6.99972
+#LayersUrlPart:     LAYERS=ffh_geb|Fauna-Flora-Habitat - Gebiet|279.99972|1.39972
+#LayersUrlPart:     LAYERS=nsg|Naturschutzgebiete|279.99972|1.39972
+#LayersUrlPart:     LAYERS=lsg|Landschaftsschutzgebiete|279.99972|1.39972
+#LayersUrlPart:     LAYERS=naturpark|Naturpark|279.99972|1.39972
+#LayersUrlPart:     LAYERS=nationalpark|Nationalpark|279.99972|1.39972
+#LayersUrlPart:     LAYERS=biosreserv|Biosphaerenreservat|279.99972|1.39972
+#LayersUrlPart:     LAYERS=z1fthue|Wasserschutzgebiete Zone 1|279.99972|1.39972
+#LayersUrlPart:     LAYERS=z2fthue|Wasserschutzgebiete Zone 2|279.99972|1.39972
+#LayersUrlPart:     LAYERS=z3fthue|Wasserschutzgebiete Zone 3|279.99972|1.39972
+#LayersUrlPart:     LAYERS=spa|Vogelschutzgebiete|279.99972|1.39972
+#LayersUrlPart:     LAYERS=firmen|Firmen|1.0E8|0.0
+#LayersUrlPart:     LAYERS=gewerbegebiet|Gewerbegebiet|1.0E8|0.0
+#LayersUrlPart:     LAYERS=gewerbeflaeche|Gewerbeflaeche|1.0E8|0.0
+#LayersUrlPart:     LAYERS=blattschnitt_tk10|TK10|1400.00028|6.99972
+#LayersUrlPart:     LAYERS=blattschnitt_tk25|TK25|1400.00028|6.99972
+#LayersUrlPart:     LAYERS=blattschnitt_tk50|TK50|1400.00028|6.99972
+#LayersUrlPart:     LAYERS=blattschnitt_tk100|TK100|1400.00028|6.99972
+#LayersUrlPart:     LAYERS=flurstuecksgrenzen|Flurstuecksgrenzen|1.40028|0.02772
+#LayersUrlPart:     LAYERS=politgrenzen|Polit. Grenzen|1.40028|0.02772
+#LayersUrlPart:     LAYERS=gebaeude|Gebaeude|1.40028|0.02772
+#LayersUrlPart:     LAYERS=nutzungsarten|Nutzungsarten|1.40028|0.02772
+#LayersUrlPart:     LAYERS=topografie|Topografie|1.40028|0.02772
+#LayersUrlPart:     LAYERS=strassennamen|Strassennamen|1.40028|0.02772
+#LayersUrlPart:     LAYERS=alk_gesamt|ALK Gesamt|1.40028|0.02772
+#LayersUrlPart:     LAYERS=alb_ohne|Flurstuecksinformationen|1.40028|0.02772
+#LayersUrlPart:     LAYERS=alb_bkz|Flurstuecksinformationen ThuerDSG|1.40028|0.02772
+#LayersUrlPart:     LAYERS=landesgrenzen|Landesgrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=kreisgrenzen|Kreisgrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=gemeindegrenzen|Gemeindegrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=gemarkungsgrenzen|Gemarkungsgrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=flurgrenzen|Flurgrenzen|280.00028|0.55972
+#LayersUrlPart:     LAYERS=rahmenkarten|Rahmenkarten|280.00028|0.55972
+#LayersUrlPart:     LAYERS=bearbeitungsstand|Bearbeitungsstand|280.00028|0.55972
+#LayersUrlPart:     LAYERS=alk_fl|Flurstuecke|1.40028|0.02772
+#LayersUrlPart:     LAYERS=alk_geb|Gebaeude|1.40028|0.02772
+#LayersUrlPart:     LAYERS=geofp_l|Lagefestpunkte|14.00028|0.13972
+#LayersUrlPart:     LAYERS=geofp_h|Hoehenfestpunkte|14.00028|0.13972
+#LayersUrlPart:     LAYERS=dtk10col|DTK10 Kombination farbig|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10acke|Ackerflaeche, Sonderkultur|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10babl|Gewaesserkontur u. -schrift|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10baum|NSG, gruene Symbole u. Schrift|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10brac|Heide, Moor, Sumpf, Klaerbecken|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10grau|Industrie- u. Gewerbeflaeche|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10grbr|Grundriss|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10haus|Gebaeude (nicht oeffentl.)|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10hrot|Bebauungsflaeche|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10park|Gruenanlage, Sport, Friedhof, Gartenland|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10rebr|Relief|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10rot|Gebaeude (oeffentl.) u. Truppenuebungplatz|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10schw|Eisenbahn, schwarze Symbole|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10sebl|Gewaesserfuellung|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10stge|Landesstrasse|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10stor|Autobahn, Bundesstrasse|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10swtx|Schrift schwarz|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10utmg|UTM-Gitter|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10viol|Verwaltungsgrenze|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10wald|Wald- u. Gehoelzflaeche|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10weis|untergeordnete Strasse u. Symbolfuellung|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk10wies|Gruenland, Flugplatz|4.20028|0.69972
+#LayersUrlPart:     LAYERS=dtk25acke|Ackerflaeche, Sonderkultur|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25babl|Gewaesserkontur u. -schrift|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25baum|NSG, gruene Symbole u. Schrift|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25brac|Heide, Moor, Sumpf, Klaerbecken|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25col|DTK25 Kombination farbig|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25ein|DTK25 Kombination einfarbig|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25grau|Industrie- u. Gewerbeflaeche|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25haus|Gebaeude (nicht oeffentl.)|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25hrot|Bebauungsflaeche|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25park|Gruenanlage, Sport, Friedhof, Gartenland|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25rebr|Relief|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25rot|Gebaeude (oeffentl.) u. Truppenuebungplatz|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25schw|Eisenbahn, schwarze Symbole|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25sebl|Gewaesserfuellung|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25stge|Landesstrasse|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25stor|Autobahn, Bundesstrasse|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25swtx|Schrift schwarz|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25utmg|UTM-Gitter|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25viol|Verwaltungsgrenze|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25wald|Wald- u. Gehoelzflaeche|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25weis|untergeordnete Strasse u. Symbolfuellung|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25wies|Gruenland, Flugplatz|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk25grbr|Grundriss|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25babl|Gewaesser|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25col|DTK25-V Kombination farbig|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25rebrv|Relief|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25schw|Grundriss u. Schrift|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtkv25wald|Waldflaeche|11.20028|1.39972
+#LayersUrlPart:     LAYERS=dtk50acke|Gartenland, Sonderkultur|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50babl|Gewaesserkontur u. -schrift|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50baum|NSG, gruene Symbole u. Schrift|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50col|DTK50 Kombination farbig|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50ein|DTK50 Kombination einfarbig|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50grau|Industrie- u. Gewerbeflaeche|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50grbr|Grundriss u. Schrift braun|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50hrot|Bebauung offen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50mrot|Bebauung geschlossen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50rebr|Relief|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50rot|Truppenuebungplatz|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50schw|Grundriss schwarz|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50sebl|Gewaesserfuellung|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50stge|Landesstrasse|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50stor|Autobahn, Bundesstrasse|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50swtx|Schrift schwarz|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50utmg|UTM-Gitter|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50viol|Verwaltungsgrenze|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50wald|Wald- u. Gehoelzflaeche|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50weis|untergeordnete Strasse u. Symbolfuellung|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtk50wies|Friedhof|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50SCHW|Grundriss|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50STGE|Staats- und Landesstrassen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50BABL|Gewaesserkonturen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50REBR|Hoehenlinien|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50STOR|Autobahnen und Bundesstrassen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50COL|DTK50-V Kombination farbig|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50SEBL|Gewaesser|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50SWTX|Schrift|21.00028|4.19972
+#LayersUrlPart:     LAYERS=DTKV50WALD|Waldflaechen|21.00028|4.19972
+#LayersUrlPart:     LAYERS=dtkv100babl|Gewaesserkontur u. -schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100colv|DTK100-V Kombination farbig|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100hrot|Bebauungsflaeche|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100rebr|Relief|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100rot|Truppenuebungsplatz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100schw|Grundriss u. Schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100sebl|Gewaesserfuellung|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100stor|Autobahn u. Bundesstrasse|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100swtx|Schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtkv100wald|Waldflaeche|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100ein|DTK100 Kombination einfarbig|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100col|DTK100 Kombination farbig|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100swtx|Schrift schwarz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100schw|Grundriss schwarz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100utmg|UTM-Gitter|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100grbr|Grundriss u. Schrift braun|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100rebr|Relief|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100babl|Gewaesserkontur u. -schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100baum|NSG, gruene Symbole u. Schrift|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100viol|Verwaltungsgrenze|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100stor|Autobahn, Bundesstrasse|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100stge|Landesstrasse|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100haus|Gebaeude (nicht oeffentl.)|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100trup|Truppenuebungplatz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100heid|Heide|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100mrot|Bebauung geschlossen|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100hrot|Bebauung offen|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100grau|Industrie- u. Gewerbeflaeche|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100sebl|Gewaesserfuellung|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100acke|Gartenland, Sonderkultur|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100brac|Brachflaechen|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100wald|Wald- u. Gehoelzflaeche|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100wies|Gruenland, Flugplatz|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100park|Gruenanlage, Sport, Friedhof, Gartenland|42.00028|8.39972
+#LayersUrlPart:     LAYERS=dtk100weis|untergeordnete Strasse u. Symbolfuellung|42.00028|8.39972
+#LayersUrlPart:     LAYERS=TH250|Uebersicht Thueringen|1400.00028|252.00028
+#LayersUrlPart:     LAYERS=GGK250|Gemeindegrenzenkarte Thueringen|280.00028|9.80028
+#LayersUrlPart:     LAYERS=UEK250|UEK250 Thueringen|280.00028|13.99972
+#LayersUrlPart:     LAYERS=dop20c|Digitale Orthophotos Farbe|9.80028|0.06972
+#LayersUrlPart:     LAYERS=dop20sw|Digitale Orthophotos Grau|9.80028|0.06972
+#LayersUrlPart:     LAYERS=dop2c|Digitale Orthophotos Farbe (2m)|252.00028|6.99972
+#LayersUrlPart:     LAYERS=dop2sw|Digitale Orthophotos Grau (2m)|252.00028|6.99972
+#LayersUrlPart:     LAYERS=OTF_2101|Ortslage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2111|Wohnbauflaeche|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2112|Industrie u Gewerbeflaeche|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2113|Fl gem Nutzung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2114|Fl bes fkt Praegung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2121|Bergbaubetrieb|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2122|Deponie|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2126|Kraftwerk|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2127|Umspannstation|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2128|Foerderanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2129|Klaeranlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2131|Ausstell Messegelaende|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2132|Gaertnerei|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2133|Heizwerk|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2134|Wasserwerk|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2135|Abfallbehandlungsanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2201|Sportanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2202|Freizeitanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2211|Freilichttheater|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2212|Freilichtmuseum|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2213|Friedhof|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2221|Stadion|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2222|Sportplatz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2223|Schiessstand|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2224|Schwimm Freibad|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2225|Zoo|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2226|Freizeitpark|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2227|Gruenanlage|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2228|Campingplatz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2230|Golfplatz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2301|Tagebau Steinbruch|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2302|Halde Aufschuettung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2311|Gradierwerk Saline F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2313|Vorratsbeh Speicherbau F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2314|Absetzbecken|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2315|Gebaeude F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2324|Kran F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2325|Pumpe Pumpstelle F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2331|Archaeo Fundstaette F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2332|Denkmal F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2342|Spielfeld Spielflaeche|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2343|Zuschauertribuene|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_2345|Schwimmbecken|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2318|Durchfahrt L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2324|Kran L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2331|Archaeo Fundstaette L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2344|Rennbahn|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2346|Sprungschanze|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2351|Mauer|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_2352|Zaun|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2102|Wohnplatz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2313|Vorratsbeh Speicherbau P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2315|Gebaeude P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2316|Turm|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2317|Schornstein|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2318|Durchfahrt P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2319|Brunnen|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2320|Stollenmundloch|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2324|Kran P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2325|Pumpe Pumpstelle P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2327|Windrad|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2331|Archaeo Fundstaette P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2332|Denkmal P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2333|Bildstock Kreuz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_2334|Meilenstein|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3103|Platz F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3301|Flughafen|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3302|Flugplatz F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3303|Rollbahn F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3304|Vorfeld|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3501|Bahnhofsanlage F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3502|Raststaette|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3513|Tunnel F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_3514|Bruecke F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTDL_3101|Strasse LR|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3101|Strasse L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3102|Weg|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3105|Strassenkoerper L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTDL_3106|Fahrbahn L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3201|Schienenbahn|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3202|Seilbahn|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3205|Bahnstrecke|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3403|Schifffahrtslinie|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3513|Tunnel L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3514|Bruecke L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3515|Furt L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3531|Freileitung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3532|Rohrleitung|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_3533|Foerderband Bandstr|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3103|Platz P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3181|Nullpunkt|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3302|Flugplatz P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3501|Bahnhofsanlage P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3503|Verkehrsknoten P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3512|Anlegestelle P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3515|Furt P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3522|Stationierungspunkt|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_3541|Mast|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4101|Ackerland|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4102|Gruenland|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4103|Gartenland|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4104|Heide|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4105|Moor Moos|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4106|Sumpf|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4107|Wald Forst|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4108|Gehoelz|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4109|Sonderkultur|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4111|Nasser Boden|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4120|Vegetationslose Flaeche|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_4199|Fl z Zt unbestimmbar|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_4202|Baumreihe|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_4203|Hecke Knick|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_4201|Baum|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5101|Strom Fluss Bach F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5103|Graben Kanal F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5105|Quelle F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5112|See Teich|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5302|Talsperre Wehr F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5303|Schleuse F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_5321|Uferbefestigung F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTDL_5101|Strom Fluss Bach LR|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTDL_5103|Graben Kanal LR|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5103|Graben Kanal L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5301|Durchlass|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5302|Talsperre Wehr L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5303|Schleuse L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_5321|Uferbefestigung L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_5105|Quelle P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_5203|Wasserfall P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_5311|Pegel|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_5312|Wasserspiegelhoehe|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_6211|Fels Felsbl Felsnadel F|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_6201|Damm Wall Deich|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_6207|Stuetzmauer|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_6211|Fels Felsbl Felsnadel L|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTP_6211|Fels Felsbl Felsnadel P|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7101|Verwaltungseinheit|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7211|Insel|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7301|Nationalpark|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7302|Naturschutzgebiet|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7303|Gesch Landschaftsteil|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7304|Landsch Schutzgebiet|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7306|Biosphaerenreservat|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7308|Flora Fauna Habitat|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7311|Wasserschutzgebiet|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTF_7403|Truppen u Standortuebpl|70.00028|0.27972
+#LayersUrlPart:     LAYERS=OTL_7299|Grenze|70.00028|0.27972
+#LayersUrlPart:     LAYERS=gaz_street_wms|HKO Strasse|1.40028|0.02772
+#LayersUrlPart:     LAYERS=gaz_hnr_wms|HKO Hausnummer|1.40028|0.02772
+#LayersUrlPart:     LAYERS=BORIS_BF|Bauflaechen|16.8|0.0
+#LayersUrlPart:     LAYERS=BORIS_BFLF|Landwirtschaftliche Flaechen in bebautem Gebiet|16.8|0.0
+#LayersUrlPart:     LAYERS=BORIS_LF|Land- u. Forstwirtschaftliche Flaechen|33.6|0.0
+#LayersUrlPart:     LAYERS=BORIS_MA|Massnahmen|16.8|0.0
+#LayersUrlPart:     LAYERS=BORIS_ALK_51_20081231|BORIS-TH Apolda 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_52_20081231|BORIS-TH Artern 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_53_20081231|BORIS-TH Gotha 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_54_20081231|BORIS-TH Leinefelde-Worbis 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_55_20081231|BORIS-TH Poessneck 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_56_20081231|BORIS-TH Saalfeld 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_57_20081231|BORIS-TH Schmalkalden 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=BORIS_ALK_58_20081231|BORIS-TH Zeulenroda 31.12.2008|1.40028|0.0028
+#LayersUrlPart:     LAYERS=boris_dtkv25col|DTK25-V Kombination farbig (BORIS)|6.99972|0.0
+#LayersUrlPart:     LAYERS=BORIS_GEMUEB_20081231|BORIS-TH GEMUEB 31.12.2008|16.8|0.0028
+LayersUrlPart:     LAYERS=dtkv25col
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/png
+BoundingBoxTopLeftWGS84: N 56.0000 E 5.0000
+BoundingBoxButtomRightWGS84: N 47.0000 E 15.0000
+# testen oder
+# ol=N 53.0000 E 9.0000 , ur=N 49.0000 E 13.0000
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   5
+ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/de-th_topo_50.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/de-th_topo_50.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/de-th_topo_50.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.thueringen.de/de/tlvermgeo/onlineservice/web_map_service/content.html
-GetCapabilitiesUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de.th Topo 50
-MapType:	topo
-MainUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31468
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Top.Karte_50_gesamt
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 52.0000 E 9.5000
-BoundingBoxButtomRightWGS84:	N 50.0000 E 13.0000
-MinScale:	1.49671
-MaxScale:	49.8903
-RecommendedScale:	5.0
-ImageFileExtension: .png
-

Copied: branches/bugfix_1.0/res_noewe/webmapservices/it-88_m.wms (from rev 1942, branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_m.wms)

Copied: branches/bugfix_1.0/res_noewe/webmapservices/it-88_p.wms (from rev 1942, branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_p.wms)

Copied: branches/bugfix_1.0/res_noewe/webmapservices/it-88_t10.wms (from rev 1942, branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_t10.wms)

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/it.tos_topo-monochrome_auto.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/it.tos_topo-monochrome_auto.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/it.tos_topo-monochrome_auto.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-TakenFromUrl:   http://www.rete.toscana.it/sett/territorio/carto/repertorio/geoscopio_wms/
-GetCapabilitiesUrl:      http://web.rete.toscana.it/sgrwms/com.rt.wms.RTmap?ServiceName=_rt_wms_cartografia&service=WMS&request=GetCapabilities
-Name:   it.tos Topo-Monochrome AutoDetail
-MainUrl:   http://web.rete.toscana.it:80/sgrwms/com.rt.wms.RTmap/_rt_wms_cartografia?
-MapType: topo
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.0
-CoordinateReferenceSystemCacheWolf:   3003
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=idrst10k,rst100k,rst25k_igm
-StylesUrlPart:   STYLES=Default,Default,Default,Default,Default,Default,Default,Default
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 44.50080520 E 9.64254863
-BoundingBoxButtomRightWGS84:   N 42.16874557 E 12.46235998
-MinScale:   0
-MaxScale:   71
-#Scale 2 and 3 are scaled versions of scale 1. Scale 5 and 6 are scaled versions of scale 4
-RecommendedScale:   5
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/it.tos_topo-simplistic_auto.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/it.tos_topo-simplistic_auto.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/it.tos_topo-simplistic_auto.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-TakenFromUrl:   http://www.rete.toscana.it/sett/territorio/carto/repertorio/geoscopio_wms/
-GetCapabilitiesUrl:      http://web.rete.toscana.it/sgrwms/com.rt.wms.RTmap?ServiceName=_rt_wms_topogr&service=WMS&request=GetCapabilities
-Name:   it.tos Topo-Simplistic AutoDetail
-MainUrl:   http://web.rete.toscana.it:80/sgrwms/com.rt.wms.RTmap/_rt_wms_topogr?
-MapType: topo
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.0
-CoordinateReferenceSystemCacheWolf:   3003
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=idisoipse,idtoponctr10k,_idbati,idedifici10k,idedifici2k,idareabagnata,idcorsi,idinfrferrovia,_idreg,idstradeestesa,_idstradegallerie
-StylesUrlPart:   STYLES=Default,Default,Default,Default,Default,Default,Default,Default
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 44.50080520 E 9.64254863
-BoundingBoxButtomRightWGS84:   N 42.16874557 E 12.46235998
-MinScale:   0
-MaxScale:   14.14214
-#H?henlinien nur bei Scale unter 4.0
-RecommendedScale:   3.9
-ImageFileExtension: .png
\ No newline at end of file

Added: branches/bugfix_1.0/res_noewe/webmapservices/it_p.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/it_p.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/it_p.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,23 @@
+TakenFromUrl:       http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/ortofoto_colore_06.map&
+GetCapabilitiesUrl: http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/ortofoto_colore_06.map&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               Italien photo
+MapType:                        photo
+MainUrl:            http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/ortofoto_colore_06.map&
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=ortofoto_colore|ortofoto_colore_06||
+#LayersUrlPart:     LAYERS=ortofoto_colore_06|ortofoto_colore_06||
+#LayersUrlPart:     LAYERS=ortofoto_colore_06_32|ortofoto_colore_06_32|0|29.9341709057782
+#LayersUrlPart:     LAYERS=ortofoto_colore_06_33|ortofoto_colore_06_33|0|29.9341709057782
+LayersUrlPart:     LAYERS=ortofoto_colore_06_33
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 48.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 36.0000 E 19.0000
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   1
+ImageFileExtension: .jpg

Added: branches/bugfix_1.0/res_noewe/webmapservices/it_t100.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/it_t100.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/it_t100.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,23 @@
+TakenFromUrl:       http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm100.map&
+GetCapabilitiesUrl: http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm100.map&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               Italien t100
+MapType:                        topo
+MainUrl:            http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm100.map&
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=igm100|igm100||
+#LayersUrlPart:     LAYERS=igm100|igm100||
+#LayersUrlPart:     LAYERS=igm100_f32|igm100_f32||
+#LayersUrlPart:     LAYERS=igm100_f33|igm100_f33||
+LayersUrlPart:     LAYERS=igm100
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 48.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 36.0000 E 19.0000
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   10
+ImageFileExtension: .jpg

Added: branches/bugfix_1.0/res_noewe/webmapservices/it_t25.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/it_t25.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/it_t25.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -0,0 +1,24 @@
+TakenFromUrl:       http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm25.map&
+GetCapabilitiesUrl: http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm25.map&SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               Italien t25
+MapType:                        topo
+MainUrl:            http://wms.pcn.minambiente.it/cgi-bin/mapserv.exe?map=/ms_ogc/service/igm25.map&
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=igm25|igm25||
+#LayersUrlPart:     LAYERS=igm25|igm25||
+#LayersUrlPart:     LAYERS=igm25_f32|igm25_f32||
+#LayersUrlPart:     LAYERS=igm25_f33|igm25_f33||
+#LayersUrlPart:     LAYERS=igm25,igm25_f32,igm25_f33
+LayersUrlPart:     LAYERS=igm25
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 48.0000 E 6.0000
+BoundingBoxButtomRightWGS84: N 36.0000 E 19.0000
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   2,5
+ImageFileExtension: .jpg

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_pt.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_pt.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_pt.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.umwelt.niedersachsen.de/master/C7065327_N6991478_L20_D0_I598.html
-GetCapabilitiesUrl:	http://geoportal.geodaten.niedersachsen.de/geodatenportal/servlet/gtEntryPoint?SERVICE=WMS&REQUEST=GetCapabilities&VERSION=1.1.1
-Name:	de.Niedersachsen photo/topo
-MapType:	photo
-MainUrl:	http://geoportal.geodaten.niedersachsen.de/geodatenportal/servlet/gtEntryPoint?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31466 31467 31468 31469
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466 SRS=EPSG:31467 SRS=EPSG:31468 SRS=EPSG:31469
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=layer_1512,layer_1513,layer_1514,layer_1507,layer_1508,layer_1509,layer_1510,layer_1511,layer_1515
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-# transformed from Gau?-Kr?ger into wgs84
-BoundingBoxTopLeftWGS84:	N 53.99192 E 006.62073
-BoundingBoxButtomRightWGS84:	N 51.27316 E 011.58000
-MinScale:	0.267412
-MaxScale:	59899.495
-RecommendedScale:	5.0
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_t100.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_t100.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/de-ni_t100.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,19 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://www.mapserver.niedersachsen.de/freezoneogc/mapserverogc?REQUEST=GetCapabilities&VERSION=1.1.1&SERVICE=WMS
-Name:	de.Niedersachsen topo 100
-MapType:	topo
-MainUrl:	http://www.mapserver.niedersachsen.de/freezoneogc/mapserverogc?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf: 31467
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31467
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=TK100
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 54.940306 E 6.180364
-BoundingBoxButtomRightWGS84:	N 50.502795 E 13.683332
-MinScale:	6.76160460880501
-MaxScale:	52.82503600628914
-RecommendedScale:	15.0
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_p.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_p.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_p.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,28 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.Rheinland-Pfalz photo
-MapType:	photo
-MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-RequestUrlPart:   REQUEST=GetMap
-#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
-#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
-#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
-#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
-#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
-#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
-#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
-#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
-#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
-LayersUrlPart:   LAYERS=freedop%3Adop
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   0.5
-MaxScale:   24.95
-RecommendedScale:	0.4
-ImageFileExtension: .png 

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_t50.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_t50.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/de-rp_t50.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,28 +0,0 @@
-TakenFromUrl:	http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten
-GetCapabilitiesUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?REQUEST=GetCapabilities&VERSION=1.1.0&SERVICE=WMS
-Name:	de.Rheinland-Pfalz topo 50
-MapType:	topo
-MainUrl:	http://geodaten.service24.rlp.de/cgi-bin/wms.cgi?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1 
-CoordinateReferenceSystemCacheWolf:   31466 31467
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:31466 SRS=EPSG:31467
-#LayersUrlPart:     LAYERS=rlp:rlp|VermKV RLP||
-#LayersUrlPart:     LAYERS=rlp:ovw|?bersichtskarte Relief|100.001|5000
-#LayersUrlPart:     LAYERS=freedop:dop|Luftbilder|0.495|24.95
-#LayersUrlPart:     LAYERS=rlp:uek500|?bersichtskarte 1:500.000|60.001|100
-#LayersUrlPart:     LAYERS=rlp:uek250|?bersichtskarte 1:250.000|30.001|60
-#LayersUrlPart:     LAYERS=rlp:tk100|TK 1:100.000|15.001|30
-#LayersUrlPart:     LAYERS=rlp:tk50|TK 1:50.000|8.001|15
-#LayersUrlPart:     LAYERS=rlp:tk25|TK 1:25.000|1|8
-#LayersUrlPart:     LAYERS=likar:likar|Liegenschaftskarte-WA|0.001|3
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=rlp%3Atk50
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 50.400 E 6.000
-BoundingBoxButtomRightWGS84:   N 49.300 E 8.200
-MinScale:   1
-MaxScale:   45
-RecommendedScale:	5.0
-ImageFileExtension: .png 
\ No newline at end of file

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/de-th_p.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-th_p.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/de-th_p.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.thueringen.de/de/tlvermgeo/onlineservice/web_map_service/content.html
-GetCapabilitiesUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de.Thueringen photo
-MapType:	photo
-MainUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31468
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Orthophotos_TH-2m
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84:	N 52.0000 E 9.5000
-BoundingBoxButtomRightWGS84:	N 50.0000 E 13.0000
-MinScale:   0.399122
-MaxScale:   9.97806
-RecommendedScale:   2.0
-ImageFileExtension: .jpg
-

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/de-th_t50.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/de-th_t50.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/de-th_t50.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,20 +0,0 @@
-TakenFromUrl:	http://www.thueringen.de/de/tlvermgeo/onlineservice/web_map_service/content.html
-GetCapabilitiesUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?service=WMS&version=1.1.1&request=GetCapabilities
-Name:	de.Thueringen topo 50
-MapType:	topo
-MainUrl:	http://www.webmap-test.thueringen.de/deegreewms/wms?
-ServiceTypeUrlPart:	SERVICE=WMS 
-VersionUrlPart:	VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:	31468
-CoordinateReferenceSystemUrlPart:	SRS=EPSG:31468
-RequestUrlPart:	REQUEST=GetMap
-LayersUrlPart:	LAYERS=Top.Karte_50_gesamt
-StylesUrlPart:	STYLES=
-ImageFormatUrlPart:	FORMAT=image/png
-BoundingBoxTopLeftWGS84:	N 52.0000 E 9.5000
-BoundingBoxButtomRightWGS84:	N 50.0000 E 13.0000
-MinScale:	1.49671
-MaxScale:	49.8903
-RecommendedScale:	5.0
-ImageFileExtension: .png
-

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_m.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_m.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_m.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,30 +0,0 @@
-TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
-GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
-Name:   it.Sardinien photo+topo10
-MapType:   topo
-MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   3003
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
-RequestUrlPart:   REQUEST=GetMap
-# Topographisch schwarz/weiss
-#LayersUrlPart:   LAYERS=CTR10K%20raster
-# Luftbild farbig
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
-# Luftbild schwarz/weiss
-#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
-# farbiges Luftbild mit Raterdaten ?berlagert 
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
-# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1
-LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
-BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
-MinScale:   1
-MaxScale:   3
-#RecommendedScale:   1.000 sonst kann man die Topodaten nicht lesen bzw es werden keine Fotos geladen
-RecommendedScale:   1.000
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_p.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_p.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_p.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,30 +0,0 @@
-TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
-GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
-Name:   it.Sardinien photo
-MapType:   photo
-MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   3003
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
-RequestUrlPart:   REQUEST=GetMap
-# Topographisch schwarz/weiss
-#LayersUrlPart:   LAYERS=CTR10K%20raster
-# Luftbild farbig
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
-# Luftbild schwarz/weiss
-#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
-# farbiges Luftbild mit Raterdaten ?berlagert 
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
-# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1
-LayersUrlPart:   LAYERS=mosaico_2006IT_4
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
-BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
-MinScale:   4
-MaxScale:   6
-# RecommendedScale:   1.000
-RecommendedScale:   4
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_t10.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_t10.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/it-88_t10.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,30 +0,0 @@
-TakenFromUrl:   http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
-GetCapabilitiesUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?request=getcapabilities&service=WMS&version=1.1.1
-Name:   it.Sardinien topo 10
-MapType:   topo
-MainUrl:   http://webgis.regione.sardegna.it/wmsconnector/com.esri.wms.Esrimap/ras_wms?
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   3003
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:3003
-RequestUrlPart:   REQUEST=GetMap
-# Topographisch schwarz/weiss
-#LayersUrlPart:   LAYERS=CTR10K%20raster
-# Luftbild farbig
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,mosaico_2006IT_2,mosaico_2006IT_3,mosaico_2006IT_4,mosaico_2006IT_5,mosaico_2006IT_6,mosaico_2006IT_7,mosaico_2006IT_8,mosaico_2006IT_9,CTR10K%20raster
-# Luftbild schwarz/weiss
-#LayersUrlPart:   LAYERS=sardegna_2003gb_1,sardegna_2003gb_2,sardegna_2003gb_3,sardegna_2003gb_4,sardegna_2003gb_5,sardegna_2003gb_6,sardegna_2003gb_7,sardegna_2003gb_8,sardegna_2003gb_9,CTR10K%20raster
-# farbiges Luftbild mit Raterdaten ?berlagert 
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1,CTR10K%20raster
-# farbiges Luftbild anscheinend nur die layer entsprchend der Skalierung angeben ( es tun nur die Skalierungen 1 bis 4)
-#LayersUrlPart:   LAYERS=mosaico_2006IT_1
-LayersUrlPart:   LAYERS=CTR10K%20raster
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/png
-BoundingBoxTopLeftWGS84:   N 41.400307 E 7.964019
-BoundingBoxButtomRightWGS84:   N 38.792131 E 10.022418
-MinScale:   1
-MaxScale:   3
-#RecommendedScale:   1 - 2.000 bei gr?sserer Skalierung wird es un?bersichtlich
-RecommendedScale:   1.000
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/it_t.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/it_t.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/it_t.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,19 +0,0 @@
-TakenFromUrl: http://wiki.gfoss.it/index.php/GIS_Open_Data#Italia
-GetCapabilitiesUrl: http://151.13.182.121/geoserver/wms?service=WMS&request=GetCapabilities
-Name: it topo 25
-MapType: topo
-MainUrl: http://151.13.182.121/geoserver/wms?
-ServiceTypeUrlPart: SERVICE=WMS
-VersionUrlPart: VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf: 31466 31467 4326
-CoordinateReferenceSystemUrlPart: SRS=EPSG:31466 SRS=EPSG:31467 SRS=EPSG:4326
-RequestUrlPart: REQUEST=GetMap
-LayersUrlPart: LAYERS=cnr_imaa:igm25000
-StylesUrlPart: STYLES=raster
-ImageFormatUrlPart: FORMAT=image/png
-BoundingBoxTopLeftWGS84: N 47.165454 E 6.581957
-BoundingBoxButtomRightWGS84: N 35.485254 E 18.548357
-MinScale: 0.0
-MaxScale: 23.335
-RecommendedScale: 5
-ImageFileExtension: .png

Deleted: branches/bugfix_1.0/res_noewe/webmapservices/untested/us_t.wms
===================================================================
--- branches/bugfix_1.0/res_noewe/webmapservices/untested/us_t.wms	2009-06-26 06:22:17 UTC (rev 1946)
+++ branches/bugfix_1.0/res_noewe/webmapservices/untested/us_t.wms	2009-06-26 10:46:32 UTC (rev 1947)
@@ -1,19 +0,0 @@
-TakenFromUrl:   http://www.perrygeo.net/wordpress/?p=35
-GetCapabilitiesUrl:      -
-Name:   us topo 24
-MainUrl:   http://terraservice.net/ogcmap.ashx?
-MapType: topo
-ServiceTypeUrlPart:   SERVICE=WMS
-VersionUrlPart:   VERSION=1.1.1
-CoordinateReferenceSystemCacheWolf:   4326
-CoordinateReferenceSystemUrlPart:   SRS=EPSG:4326
-RequestUrlPart:   REQUEST=GetMap
-LayersUrlPart:   LAYERS=DRG
-StylesUrlPart:   STYLES=
-ImageFormatUrlPart:   FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84:   N 75.0 W 179.9
-BoundingBoxButtomRightWGS84:   N 20.0 W 60.0
-MinScale:   0
-MaxScale:   45
-RecommendedScale:   5
-ImageFileExtension: .jpg



From mik77 at mail.berlios.de  Fri Jun 26 13:15:54 2009
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Fri, 26 Jun 2009 13:15:54 +0200
Subject: [Cachewolf-svn] r1948 - trunk
Message-ID: <200906261115.n5QBFsV4018570@sheep.berlios.de>

Author: mik77
Date: 2009-06-26 13:15:44 +0200 (Fri, 26 Jun 2009)
New Revision: 1948

Modified:
   trunk/currentversions.txt
Log:
Update of the version file for bugfix release 1.0.1947

Modified: trunk/currentversions.txt
===================================================================
--- trunk/currentversions.txt	2009-06-26 10:46:32 UTC (rev 1947)
+++ trunk/currentversions.txt	2009-06-26 11:15:44 UTC (rev 1948)
@@ -1,16 +1,16 @@
 # Release
 T0VersionMajor: 1
 T0VersionMinor: 0
-T0SvnRevision: 1839
+T0SvnRevision: 1947
 
 # ReleaseCandidate
 T1VersionMajor: 1
 T1VersionMinor: 0
-T1SvnRevision: 1520
+T1SvnRevision: 1947
 
 # InDevelopmentStable
 T2VersionMajor: 1
-T2VersionMinor: 0
+T2VersionMinor: 1
 T2SvnRevision: 1536
 
 # InDevelopmentNewest



From greiol at mail.berlios.de  Fri Jun 26 19:05:27 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 26 Jun 2009 19:05:27 +0200
Subject: [Cachewolf-svn] r1949 - trunk/src/exp
Message-ID: <200906261705.n5QH5Ric019293@sheep.berlios.de>

Author: greiol
Date: 2009-06-26 19:05:17 +0200 (Fri, 26 Jun 2009)
New Revision: 1949

Modified:
   trunk/src/exp/GpxExportNg.java
   trunk/src/exp/HTMLExporter.java
Log:
added support for a free prefix
added support to limit number of logs

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-26 11:15:44 UTC (rev 1948)
+++ trunk/src/exp/GpxExportNg.java	2009-06-26 17:05:17 UTC (rev 1949)
@@ -17,14 +17,15 @@
 
 import ewe.filechooser.FileChooser;
 import ewe.filechooser.FileChooserBase;
+import ewe.fx.Sound;
 import ewe.io.BufferedWriter;
 import ewe.io.File;
 import ewe.io.FileBase;
 import ewe.io.FileWriter;
 import ewe.io.PrintWriter;
+import ewe.sys.Convert;
 import ewe.sys.Date;
 import ewe.sys.Handle;
-import ewe.sys.Vm;
 import ewe.ui.CheckBoxGroup;
 import ewe.ui.Control;
 import ewe.ui.ControlEvent;
@@ -34,12 +35,12 @@
 import ewe.ui.ProgressBarForm;
 import ewe.ui.mButton;
 import ewe.ui.mCheckBox;
+import ewe.ui.mInput;
+import ewe.ui.mLabel;
 import ewe.util.Enumeration;
 import ewe.util.Hashtable;
 import ewe.util.Iterator;
-import ewe.util.Random;
 
-
 /**
  * experimental GPX exporter that should better handle the various tasks that
  * can be accomplished with GPX it is not yet linked to any menu, so if you want
@@ -59,6 +60,7 @@
 	final static String TRUE = "True";
 	final static String FALSE = "False";
 	private static GarminMap gm;
+	private int maxLogs = ewe.math.Number.INTEGER_MAX_VALUE;
 
 	final static String GPXHEADER = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
 			.concat("<gpx xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" version=\"1.0\" creator=\"CacheWolf\" xsi:schemaLocation=\"http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd http://www.groundspeak.com/cache/1/0 http://www.groundspeak.com/cache/1/0/cache.xsd\" xmlns=\"http://www.topografix.com/GPX/1/0\">\n")
@@ -142,7 +144,7 @@
 			final String outDir;
 			final String tempDir;
 			final String baseDir = FileBase.getProgramDirectory();
-			final String prefix="GC-";
+			final String prefix = exportOptions.getPrefix();
 			final FileChooser fc;
 			
 			if (sendToGarmin) { 
@@ -267,6 +269,10 @@
 					Global.getPref().log("unable to load garminmap.xml");
 				}
 			}
+			
+			if (outType == GPX_PQLIKE) {
+				maxLogs = exportOptions.getMaxLogs();
+			}
 			final File file;
 			final FileChooser fc = new FileChooser(FileChooserBase.SAVE, 
 					Global.getPref().getExportPath(expName+"-GPX"));
@@ -375,8 +381,8 @@
 				trans.add(new Regex("@@WPNAME@@", SafeXML.cleanGPX(ch.getWayPoint()
 						.concat(" ")
 						.concat(CacheType.getExportShortId(ch.getType()))
+						.concat(String.valueOf(ch.getHard()))
 						.concat(String.valueOf(ch.getTerrain()))
-						.concat(String.valueOf(ch.getHard()))
 						.concat(CacheSize.getExportShortId(ch.getCacheSize()))
 						)));
 			}
@@ -518,7 +524,15 @@
 		if (0 == logs.size())
 			return "";
 		
-		for (int i = 0; i < logs.size(); i++) {
+		int exportlogs;
+		
+		if (outType == GPX_PQLIKE && maxLogs < logs.size()) {
+			exportlogs = maxLogs;
+		} else {
+			exportlogs = logs.size();
+		}
+		
+		for (int i = 0; i < exportlogs; i++) {
 			Log log = logs.getLog(i);
 			
 			if (outType == GPX_MYFINDSPQ
@@ -635,6 +649,7 @@
 		private CheckBoxGroup cbgExportType;
 		private mCheckBox cbCompact, cbPqLike, cbMyFinds, cbCustomIcons,
 				cbSeperateFiles, cbSendToGarmin, cbSmartId;
+		private mInput ibMaxLogs,ibPrefix;
 		private mButton btnOk, btnCancel;
 
 		/**
@@ -666,6 +681,11 @@
 			cbSendToGarmin.modify(Control.Disabled, 0); // not yet
 
 			cbSmartId = new mCheckBox("use smart IDs");
+			
+			ibPrefix = new mInput("GC-");
+			ibPrefix.modify(Control.Disabled, 0);
+			ibMaxLogs = new mInput(String.valueOf(Global.getPref().numberOfLogsToExport));
+			ibMaxLogs.modify(Control.Disabled, 0);
 
 			btnOk = new mButton("OK");
 			btnCancel = new mButton("Cancel");
@@ -677,6 +697,11 @@
 			addNext(cbSendToGarmin);
 			addLast(cbMyFinds);
 			addLast(cbSmartId);
+			addNext(new mLabel("Prefix"));
+			addLast(new mLabel("Max Logs"));
+			
+			addNext(ibPrefix);
+			addLast(ibMaxLogs);
 
 			addButton(btnOk);
 			addButton(btnCancel);
@@ -699,6 +724,8 @@
 						// cbSendToGarmin.repaint();
 						if (cbSmartId.change(0, Control.Disabled))
 							cbSmartId.repaint();
+						if (ibMaxLogs.change(Control.Disabled, 0))
+							ibMaxLogs.repaint();
 					} else if (cbgExportType.getSelected() == cbPqLike) {
 						cbSeperateFiles.setState(false);
 						if (cbCustomIcons.change(0, Control.Disabled))
@@ -709,6 +736,10 @@
 						// cbSendToGarmin.repaint();
 						if (cbSmartId.change(0, Control.Disabled))
 							cbSmartId.repaint();
+						if (ibPrefix.change(Control.Disabled, 0))
+							ibPrefix.repaint();
+						if (ibMaxLogs.change(Control.Disabled, 1))
+							ibMaxLogs.repaint();
 					} else if (cbgExportType.getSelected() == cbMyFinds) {
 						cbCustomIcons.setState(false);
 						cbSeperateFiles.setState(false);
@@ -722,9 +753,37 @@
 						// cbSendToGarmin.repaint();
 						if (cbSmartId.change(Control.Disabled, 0))
 							cbSmartId.repaint();
+						if (ibPrefix.change(Control.Disabled, 0))
+							ibPrefix.repaint();
+						if (ibMaxLogs.change(Control.Disabled, 0))
+							ibMaxLogs.repaint();
 					}
+				} else if (ev.target == cbSeperateFiles) {
+					if (cbSeperateFiles.state) {
+						if (ibPrefix.change(Control.Disabled, 1)) ibPrefix.repaint();
+					} else {
+						if (ibPrefix.change(Control.Disabled, 0)) ibPrefix.repaint();
+					}
 				} else if (ev.target == btnOk) {
-					close(1);
+					if (cbPqLike.state) {
+						try {
+							int logs = getMaxLogs();
+							if (logs > -1) {
+								close(1);
+							} else {
+								ibMaxLogs.selectAll();
+								ibMaxLogs.takeFocus(0);
+								Sound.beep();
+							}
+						} catch (NumberFormatException e) {
+							ibMaxLogs.selectAll();
+							ibMaxLogs.takeFocus(0);
+							Sound.beep();
+						}
+					} else {
+						close(1);
+					}
+					
 				} else if (ev.target == btnCancel) {
 					close(-1);
 				}
@@ -777,5 +836,21 @@
 		public boolean getSeparateFiles() {
 			return cbSeperateFiles.state;
 		}
+		
+		/**
+		 * get the number of logs to export. used in PQlike export.
+		 * @return number of logs to export
+		 */
+		public int getMaxLogs() {
+			return Convert.parseInt(ibMaxLogs.getText());
+		}
+		
+		/**
+		 * get prefix for sepearte file export
+		 * @return prefix for separate file export
+		 */
+		public String getPrefix() {
+			return ibPrefix.getText();
+		}
 	}
 }

Modified: trunk/src/exp/HTMLExporter.java
===================================================================
--- trunk/src/exp/HTMLExporter.java	2009-06-26 11:15:44 UTC (rev 1948)
+++ trunk/src/exp/HTMLExporter.java	2009-06-26 17:05:17 UTC (rev 1949)
@@ -228,7 +228,7 @@
 						pagefile.close();
 					}catch(Exception e){
 						exportErrors++;
-						Global.getPref().log("HTMLExport: error wehen exporting "+ch.getWayPoint()+" reason: ",e);
+						Global.getPref().log("HTMLExport: error wehen exporting "+ch.getWayPoint()+" reason: ",e,Global.getPref().debug);
 					}
 					if (exportErrors > 0) {
 						new MessageBox("Export Error", exportErrors+" waypoints have not been exported. See log for details.", FormBase.OKB).execute();



From greiol at mail.berlios.de  Fri Jun 26 20:54:05 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 26 Jun 2009 20:54:05 +0200
Subject: [Cachewolf-svn] r1950 - in trunk/src/CacheWolf: . imp
Message-ID: <200906261854.n5QIs5Oc015058@sheep.berlios.de>

Author: greiol
Date: 2009-06-26 20:53:49 +0200 (Fri, 26 Jun 2009)
New Revision: 1950

Added:
   trunk/src/CacheWolf/imp/GPXImporter.java
   trunk/src/CacheWolf/imp/OCXMLImporter.java
   trunk/src/CacheWolf/imp/OCXMLImporterScreen.java
   trunk/src/CacheWolf/imp/SpiderGC.java
Removed:
   trunk/src/CacheWolf/GPXImporter.java
   trunk/src/CacheWolf/OCXMLImporter.java
   trunk/src/CacheWolf/OCXMLImporterScreen.java
   trunk/src/CacheWolf/SpiderGC.java
Modified:
   trunk/src/CacheWolf/CacheTerrDiff.java
   trunk/src/CacheWolf/CoordsScreen.java
   trunk/src/CacheWolf/DateFormat.java
   trunk/src/CacheWolf/GuiImageBroker.java
   trunk/src/CacheWolf/InfoBox.java
   trunk/src/CacheWolf/Log.java
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/Profile.java
   trunk/src/CacheWolf/TravelbugJourneyScreen.java
Log:
moved gpximporter, ocxmlimporter and gcspider to package cachewolf.imp

Modified: trunk/src/CacheWolf/CacheTerrDiff.java
===================================================================
--- trunk/src/CacheWolf/CacheTerrDiff.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/CacheTerrDiff.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -10,27 +10,27 @@
 public class CacheTerrDiff {
 	
 	/** terrain or difficulty 1.0 */
-	protected static final byte CW_DT_10 = 10;
+	public static final byte CW_DT_10 = 10;
 	/** terrain or difficulty 1.5 */
-	protected static final byte CW_DT_15 = 15;
+	public static final byte CW_DT_15 = 15;
 	/** terrain or difficulty 2.0 */
-	protected static final byte CW_DT_20 = 20;
+	public static final byte CW_DT_20 = 20;
 	/** terrain or difficulty 2.5 */
-	protected static final byte CW_DT_25 = 25;
+	public static final byte CW_DT_25 = 25;
 	/** terrain or difficulty 3.0 */
-	protected static final byte CW_DT_30 = 30;
+	public static final byte CW_DT_30 = 30;
 	/** terrain or difficulty 3.5 */
-	protected static final byte CW_DT_35 = 35;
+	public static final byte CW_DT_35 = 35;
 	/** terrain or difficulty 4.0 */
-	protected static final byte CW_DT_40 = 40;
+	public static final byte CW_DT_40 = 40;
 	/** terrain or difficulty 4.5 */
-	protected static final byte CW_DT_45 = 45;
+	public static final byte CW_DT_45 = 45;
 	/** terrain or difficulty 5.0 */
-	protected static final byte CW_DT_50 = 50;
+	public static final byte CW_DT_50 = 50;
 	/** wrong terrain or difficulty */
-	protected static final byte CW_DT_ERROR = -1;
+	public static final byte CW_DT_ERROR = -1;
 	/** terrain or difficulty for additional/custom waypoints */
-	protected static final byte CW_DT_UNSET = 0;
+	public static final byte CW_DT_UNSET = 0;
 
 	/** constructor dies nothing */
 	private CacheTerrDiff() { // no instantiation needed 
@@ -44,7 +44,7 @@
 	 * @return internal representation of terrain or difficulty
 	 * @throws IllegalArgumentException if <code>v1TerrDiff</code> can not be mapped
 	 */
-	static final byte v1Converter(String v1TerrDiff) throws IllegalArgumentException {
+	public static final byte v1Converter(String v1TerrDiff) throws IllegalArgumentException {
 		if (v1TerrDiff == null) {
 			throw new IllegalArgumentException("error mapping terrain or difficulty");
 		}

Modified: trunk/src/CacheWolf/CoordsScreen.java
===================================================================
--- trunk/src/CacheWolf/CoordsScreen.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/CoordsScreen.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import CacheWolf.imp.SpiderGC;
 import CacheWolf.navi.Navigate;
 import ewe.ui.*;
 import ewe.fx.Dimension;

Modified: trunk/src/CacheWolf/DateFormat.java
===================================================================
--- trunk/src/CacheWolf/DateFormat.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/DateFormat.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,4 +1,5 @@
 package CacheWolf;
+
 /* Several date formats are used by GC.COM
  *    2/27/2004   - Hidden dates are in format mm/dd/yyyy (=US style)
  *    February 27 - Found dates which happened this year
@@ -6,48 +7,54 @@
  * The internal standard is sortable:
  *    2004-02-27    - YYYY-MM-DD   
  */
-import ewe.sys.*;
 
+import ewe.sys.Convert;
+import ewe.sys.Time;
+
 public class DateFormat {
 
-/** Convert the US Format into a sortable format */
-static String MDY2YMD(String date) {
-	// Dates are in format M/D/Y
-	int p1,p2=-1;
-	p1=date.indexOf("/");
-	if (p1>0) p2=date.indexOf("/",p1+1);
-	if (p1>0 && p2>0) {
-		return date.substring(p2+1)+"-"+
-		        (p1==1?"0":"")+date.substring(0,p1)+"-"+
-		        (p1+2==p2?"0":"")+date.substring(p1+1,p2);
-	} else
-		return date;
-}
+	/** Convert the US Format into a sortable format */
+	public static String MDY2YMD(String date) {
+		// Dates are in format M/D/Y
+		int p1, p2 = -1;
+		p1 = date.indexOf("/");
+		if (p1 > 0)
+			p2 = date.indexOf("/", p1 + 1);
+		if (p1 > 0 && p2 > 0) {
+			return date.substring(p2 + 1) + "-" + (p1 == 1 ? "0" : "")
+					+ date.substring(0, p1) + "-" + (p1 + 2 == p2 ? "0" : "")
+					+ date.substring(p1 + 1, p2);
+		} else
+			return date;
+	}
 
-/* Convert the sortable date into a US date */
-//static String YMD2MDY(String date) {
-//	return date.substring(4,6)+"/"+date.substring(6,8)+"/"+date.substring(0,4);
-//}
+	/* Convert the sortable date into a US date */
+	// static String YMD2MDY(String date) {
+	// return
+	// date.substring(4,6)+"/"+date.substring(6,8)+"/"+date.substring(0,4);
+	// }
+	/** Convert the log format into a sortable format */
+	public static String logdate2YMD(String logdate) {
+		String monthNames[] = { "January", "February", "March", "April", "May",
+				"June", "July", "August", "September", "October", "November",
+				"December" };
+		Time t = new Time();
+		String year, month, day;
+		int i, m;
+		logdate += ", " + t.year; // If logdate already has a year, this one is
+									// ignored
+		i = logdate.indexOf(',');
+		year = logdate.substring(i + 2, i + 6);
+		for (m = 0; m < 12; m++) {
+			if (logdate.startsWith(monthNames[m])) {
+				month = (m < 9 ? "0" : "") + Convert.formatInt(m + 1);
+				day = logdate.substring(monthNames[m].length() + 1, i);
+				if (day.length() == 1)
+					day = "0" + day;
+				return year + "-" + month + "-" + day;
+			}
+		}
+		return "";
+	}
 
-/** Convert the log format into a sortable format */
-static String logdate2YMD(String logdate) {
-   String monthNames[]={"January","February","March","April","May","June","July","August","September","October","November","December"};
-   Time t=new Time();
-   String year,month,day;
-   int i,m;
-   logdate+=", "+t.year; // If logdate already has a year, this one is ignored
-   i=logdate.indexOf(',');
-   year=logdate.substring(i+2,i+6);
-   for (m=0; m<12; m++) {
-	   if (logdate.startsWith(monthNames[m])) {
-		   month=(m<9?"0":"")+Convert.formatInt(m+1);
-		   day=logdate.substring(monthNames[m].length()+1,i);
-		   if (day.length()==1)day="0"+day;
-		   return year+"-"+month+"-"+day;
-	   }
-   }
-   return "";
 }
-
-
-}

Deleted: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/GPXImporter.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,576 +0,0 @@
-package CacheWolf;
-
-import ewesoft.xml.*;
-import ewesoft.xml.sax.*;
-import ewe.sys.*;
-import ewe.ui.FormBase;
-import ewe.ui.MessageBox;
-import ewe.util.*;
-import ewe.util.zip.*;
-
-/**
-*	Class to import Data from an GPX File. If cache data exists, the data from 
-*	the GPX-File is ignored.
-*	Class ID = 4000
-*/
-public class GPXImporter extends MinML {
-	
-	static Preferences pref;
-	Profile profile;
-	CacheDB cacheDB;
-	CacheHolder holder;
-	String strData, saveDir, logData, logIcon, logDate, logFinder, logId;
-	boolean inWpt, inCache, inLogs, inBug;
-	public XMLElement document;
-	private Vector files = new Vector();
-	private boolean debugGPX = false; 
-	InfoBox infB;
-	boolean spiderOK = true;
-	boolean doSpider = false;
-	boolean fromOC = false;
-	boolean fromTC = false;
-	boolean nameFound = false;
-	static final Time gpxDate = new Time();
-	int zaehlerGel = 0;
-	public static final int DOIT_ASK = 0;
-	public static final int DOIT_NOSPOILER = 1;
-	public static final int DOIT_WITHSPOILER = 2;
-	boolean getMaps = false;
-	SpiderGC imgSpider;
-	StringBuffer strBuf;
-	
-	public GPXImporter(Preferences p, Profile prof, String f )
-	{
-		profile=prof;
-		pref = p;
-		cacheDB = profile.cacheDB;
-		//file = f;
-		files.add(f);
-		saveDir = profile.dataDir;
-		//msgA = msgArea;
-		inWpt = false;
-		inCache = false;
-		inLogs = false;
-		inBug =false;
-	}
-/*	skg: This Constructor is not referenced, therefore commented out 
-	public GPXImporter(Vector DB, String[] f,String d, Preferences p)
-	{
-		pref = p;
-		cacheDB = DB;
-		saveDir = pref.mydatadir;
-		for (int i=0;i<f.length;i++){
-			files.add(d + "/" + f[i]);
-		}
-		
-		//msgA = msgArea;
-		inWpt = false;
-		inCache = false;
-		inLogs = false;
-		inBug =false;
-		strData = new String();
-		//index db for faster search
-		CacheHolder ch;
-		for(int i = 0; i<cacheDB.size();i++){
-			ch = (CacheHolder)cacheDB.get(i);
-			DBindex.put((String)ch.wayPoint, new Integer(i));
-		}//for
-	}
-*/	
-	public void doIt(int how){
-		Filter flt = new Filter();
-		boolean wasFiltered = (profile.getFilterActive()==Filter.FILTER_ACTIVE);
-		flt.clearFilter();
-		try{
-			ewe.io.Reader r;
-			String file;
-			
-			OCXMLImporterScreen options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"), OCXMLImporterScreen.IMAGES| OCXMLImporterScreen.ISGC);
-			if (options.execute() == FormBase.IDCANCEL) {	return; }
-			//String dist = options.distanceInput.getText();
-			//if (dist.length()== 0) return;
-			//getMaps = options.mapsCheckBox.getState();
-			boolean getImages = options.imagesCheckBox.getState();
-			doSpider = false;
-			if(getImages){
-				doSpider = true;
-				imgSpider = new SpiderGC(pref, profile, false);
-			}
-			options.close(0);
-			
-			//Vm.debug("State of: " + doSpider);
-			Vm.showWait(true);
-			for (int i=0; i<files.size();i++){
-				//Test for zip.file
-				file = (String)files.get(i);
-				if (file.indexOf(".zip") > 0){
-					ZipFile zif = new ZipFile (file);
-					ZipEntry zipEnt;
-					Enumeration zipEnum = zif.entries();
-					// there could be more than one file in the archive
-					while (zipEnum.hasMoreElements())
-					{
-						zipEnt = (ZipEntry) zipEnum.nextElement();
-						// skip over PRC-files
-						if (zipEnt.getName().endsWith("gpx")){
-							r = new ewe.io.InputStreamReader(zif.getInputStream(zipEnt));
-							infB = new InfoBox(zipEnt.toString(),(MyLocale.getMsg(4000,"Loaded caches: ") + zaehlerGel));
-							infB.exec();
-							if (r.read() != 65279)
-								r = new ewe.io.InputStreamReader(zif.getInputStream(zipEnt));
-							parse(r);
-							r.close();
-							infB.close(0);
-						}
-					}
-				}
-				else {
-					r = new ewe.io.InputStreamReader(new ewe.io.FileInputStream(file));
-					infB = new InfoBox("Info",(MyLocale.getMsg(4000,"Loaded caches: ") + zaehlerGel));
-					infB.show();
-					if (r.read() != 65279)
-						r = new ewe.io.InputStreamReader(new ewe.io.FileInputStream(file));
-					parse(r);
-					r.close();
-					infB.close(0);
-				}
-				// save Index 
-				profile.saveIndex(pref,Profile.SHOW_PROGRESS_BAR);
-				infB.close(0);
-			}
-				Vm.showWait(false);
-			}catch(Exception e){
-				e.printStackTrace();
-				Vm.showWait(false);
-			}
-		if(wasFiltered){
-			flt.setFilter();
-			flt.doFilter();
-		}
-	}
-	public void startElement(String name, AttributeList atts){
-		strBuf=new StringBuffer(300);
-		if (name.equals("gpx")){
-			// check for opencaching
-			if (atts.getValue("creator").indexOf("opencaching")> 0) fromOC = true;
-			else fromOC = false;
-			if (atts.getValue("creator").startsWith("TerraCaching")) fromTC = true;
-			else fromTC = false;
-
-			if (fromOC && doSpider) (new MessageBox("Warnung", MyLocale.getMsg(4001, "GPX files from opencaching don't contain information of images, they cannot be laoded. Best you get caches from opencaching by menu /Application/Import/Download from Opencaching"), FormBase.OKB)).execute();
-			zaehlerGel = 0;
-		}
-		if (name.equals("wpt")) {
-			holder = new CacheHolder();
-			holder.pos.set(Common.parseDouble(atts.getValue("lat")),Common.parseDouble(atts.getValue("lon")));
-			holder.LatLon=holder.pos.toString();
-			inWpt = true;
-			inLogs = false;
-			inBug = false;
-			nameFound = false;
-			zaehlerGel++;
-			infB.setInfo(MyLocale.getMsg(4000,"Loaded caches: ") + zaehlerGel);
-			return;
-		}
-		
-		if (name.equals("link")&& inWpt){
-			holder.getFreshDetails().URL = atts.getValue("href");
-			return;
-		}
-
-		if (name.equals("groundspeak:cache")) {
-			inCache = true;
-			holder.setAvailable(atts.getValue("available").equals("True"));
-			holder.setArchived(atts.getValue("archived").equals("True"));
-			return;
-		}
-
-		if (name.equals("geocache")) {
-			boolean available = false;
-			boolean archived  = false;
-			inCache=true;
-			// get status
-			String status = new String(atts.getValue("status"));
-			if (status.equals("Available")) available = true;
-			else if (status.equals("Unavailable")) available = false;
-			else if (status.equals("Draft")) available = false;
-			else if (status.equals("Archived")) archived = true;
-			holder.setArchived(archived);
-			holder.setAvailable(available);
-			return;
-		}
-		
-		if (name.equals("terra:terracache")) {
-			inCache=true;
-		}
-
-		
-		if (name.equals("groundspeak:long_description")) {
-			holder.setHTML(atts.getValue("html").toLowerCase().equals("true"));
-		}
-		if (name.equals("description") || name.equals("terra:description") ) {
-			//set HTML always to true if from oc.de or TC
-			holder.setHTML(true);
-		}
-
-		if (name.equals("groundspeak:logs") || name.equals("logs") || name.equals("terra:logs")) {
-			inLogs = true;
-			return;
-		}
-		if (name.equals("groundspeak:log") || name.equals("log") || name.equals("terra:log")) {
-			inLogs = true;
-			logId = atts.getValue("id");
-			return;
-		}
-		if (name.equals("groundspeak:travelbugs")) {
-			inBug = true;
-			return;
-		}
-		if (debugGPX){
-			for (int i = 0; i < atts.getLength(); i++) {
-				Vm.debug("Type: " + atts.getType(i) + " Name: " + atts.getName(i)+ " Value: "+atts.getValue(i));
-			}
-		}
-	}
-	
-	public void endElement(String name){
-		strData=strBuf.toString();
-		//Vm.debug("Ende: " + name);
-		
-		// logs
-		if (inLogs){
-			if (name.equals("groundspeak:date")|| name.equals("time")|| name.equals("terra:date"))  {
-				logDate = new String(strData.substring(0,10));
-				return;
-			}
-			if (name.equals("groundspeak:type") || name.equals("type") || name.equals("terra:type")){
-				logIcon = new String(typeText2Image(strData));
-				return;
-			}
-			if (name.equals("groundspeak:finder")|| name.equals("geocacher")|| name.equals("terra:user")){
-				logFinder = new String(strData);
-				return;
-			}
-			if (name.equals("groundspeak:text") || name.equals("text") || name.equals("terra:entry")){ 
-				logData = new String(strData);
-				return;
-			}
-			if (name.equals("groundspeak:log") || name.equals("log") || name.equals("terra:log") ) {
-				holder.getFreshDetails().CacheLogs.add(new Log(logIcon,logDate,logFinder,logData));
-				if((logIcon.equals("icon_smile.gif") || logIcon.equals("11.png") || logIcon.equals("icon_attended.gif")) && 
-						  (logFinder.equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()>0 && logFinder.equalsIgnoreCase(pref.myAlias2)))) {
-							holder.setCacheStatus(logDate);
-							holder.setFound(true);
-							holder.getFreshDetails().OwnLogId = logId;
-							holder.getFreshDetails().OwnLog = new Log(logIcon,logDate,logFinder,logData);
-				}
-				return;
-			}
-		}
-		
-		if (name.equals("wpt")){
-			// Add cache Data only, if waypoint not already in database
-			//if (searchWpt(cacheDB, holder.wayPoint)== -1){
-			int index=cacheDB.getIndex(holder.getWayPoint());
-			//Vm.debug("here ?!?!?");
-			//Vm.debug("chould be new!!!!");
-			if (index == -1){
-				holder.setNoFindLogs(holder.getFreshDetails().CacheLogs.countNotFoundLogs());
-				holder.setNew(true);
-				cacheDB.add(holder);
-				// don't spider additional waypoints, so check
-				// if waypoint starts with "GC"
-				if(doSpider == true) {
-					if(spiderOK == true && holder.is_archived() == false){
-							if(holder.LatLon.length() > 1){
-							if(getMaps){
-								ParseLatLon pll = new ParseLatLon(holder.LatLon,".");
-								pll.parse();
-								//MapLoader mpl = new MapLoader(pref.myproxy, pref.myproxyport);
-								//mpl.loadTo(profile.dataDir + "/" + holder.wayPoint + "_map.gif", "3");
-								//mpl.loadTo(profile.dataDir + "/" + holder.wayPoint + "_map_2.gif", "10");
-							}
-						}
-					if(holder.getWayPoint().startsWith("GC")|| fromTC) {
-						//spiderImages();
-						spiderImagesUsingSpider();
-						//Rename image sources
-						String text;
-						String orig;
-						String imgName;
-						orig = holder.getFreshDetails().LongDescription;
-						Extractor ex = new Extractor(orig, "<img src=\"", ">", 0, false);
-						text = ex.findNext();
-						int num = 0;
-						while(ex.endOfSearch() == false && spiderOK == true){
-							//Vm.debug("Replacing: " + text);
-							if (num >= holder.getFreshDetails().ImagesText.getCount())break;
-							imgName = (String)holder.getFreshDetails().ImagesText.get(num);
-							holder.getFreshDetails().LongDescription = replace(holder.getFreshDetails().LongDescription, text, "[[Image: " + imgName + "]]");
-							num++;
-							text = ex.findNext();
-						}
-					}
-						
-					}
-				}
-				holder.save();
-				//crw.saveIndex(cacheDB,saveDir);
-			}
-			//Update cache data
-			else {
-				CacheHolder oldCh= cacheDB.get(index);
-				oldCh.update(holder);
-				oldCh.save();
-			}
-			
-			inWpt = false;
-			return;
-		}
-		if (name.equals("sym")&& strData.endsWith("Found")) {
-			holder.setFound(true);
-			holder.setCacheStatus(MyLocale.getMsg(318,"Found"));
-			return;
-		}
-		if (name.equals("groundspeak:travelbugs")) {
-			inBug = false;
-			return;
-		}
-
-		if (name.equals("groundspeak:name")&& inBug) {
-			Travelbug tb=new Travelbug(strData);
-			holder.getFreshDetails().Travelbugs.add(tb);
-			//holder.Bugs += "<b>Name:</b> " + strData + "<br><hr>";
-			holder.setHas_bugs(true);
-			return;
-		}
-		
-		if (name.equals("time") && !inWpt) {		    
-			try {
-			    gpxDate.parse(strData.substring(0,19),"yyyy-MM-dd'T'HH:mm:ss");
-			} catch (IllegalArgumentException e) {
-			    gpxDate.setTime(0);
-			    Global.getPref().log("Error parsing date: '"+strData+"'. Ignoring.");
-			}
-			return;
-		}
-
-		if (name.equals("time") && inWpt) {
-			holder.setDateHidden(strData.substring(0,10)); //Date;
-			return;
-		}
-		// cache information
-		if (name.equals("groundspeak:cache") || name.equals("geocache")|| name.equals("terra:terracache")) {
-			inCache = false;
-		}
-		
-		if (name.equals("name") && inWpt && !inCache) {
-			holder.setWayPoint(strData);
-			if (gpxDate.getTime()!=0) {
-			    holder.setLastSync(gpxDate.format("yyyyMMddHHmmss"));
-			} else {
-			    holder.setLastSync("");
-			}    
-			//msgA.setText("import " + strData);
-			return;
-		}
-		//Vm.debug("Check: " + inWpt + " / " + fromOC);
-		//if (name.equals("desc") && inWpt && fromOC) {
-		// fill name with contents of <desc>, in case of gc.com the name is
-		// later replaced by the contents of <groundspeak:name> which is shorter
-		if (name.equals("desc")&& inWpt ) {
-			holder.setCacheName(strData);
-			//Vm.debug("CacheName: " + strData);
-			//msgA.setText("import " + strData);
-			return;
-		}
-		if (name.equals("url")&& inWpt){
-			holder.getFreshDetails().URL = strData;
-			return;
-		}
-		
-		// Text for additional waypoints, no HTML
-		if (name.equals("cmt")&& inWpt){
-			holder.getFreshDetails().LongDescription = strData;
-			holder.setHTML(false);
-			return;
-		}
-		
-		// aditional wapypoint
-		if (name.equals("type")&& inWpt && !inCache && strData.startsWith("Waypoint")){
-			holder.setType(CacheType.gpxType2CwType(strData));
-			holder.setCacheSize(CacheSize.CW_SIZE_NOTCHOSEN);
-			holder.setHard(CacheTerrDiff.CW_DT_UNSET);
-			holder.setTerrain(CacheTerrDiff.CW_DT_UNSET);
-			holder.setLastSync("");
-		}
-		
-		if ((name.equals("groundspeak:name")|| name.equals("terra:name")) && inCache) {
-			holder.setCacheName(strData);
-			return;
-		}
-		if (name.equals("groundspeak:owner") || name.equals("owner")||name.equals("terra:owner")) {
-			holder.setCacheOwner(strData);
-			if(pref.myAlias.equals(strData)) holder.setOwned(true);
-			return;
-		}
-		if (name.equals("groundspeak:difficulty") || name.equals("difficulty") || name.equals("terra:mental_challenge")) {
-			holder.setHard(CacheTerrDiff.v1Converter(strData));
-			return;
-		}
-		if (name.equals("groundspeak:terrain")|| name.equals("terrain")|| name.equals("terra:physical_challenge")) {
-			holder.setTerrain(CacheTerrDiff.v1Converter(strData));
-			return;
-		}
-		if ((name.equals("groundspeak:type") || name.equals("type")|| name.equals("terra:style"))&& inCache){
-			holder.setType(CacheType.gpxType2CwType(strData));
-			if (holder.getType() == CacheType.CW_TYPE_CUSTOM) {
-				holder.setCacheSize(CacheSize.CW_SIZE_NOTCHOSEN);
-				holder.setHard(CacheTerrDiff.CW_DT_UNSET);
-				holder.setTerrain(CacheTerrDiff.CW_DT_UNSET);
-			}
-			return;
-		}
-		if (name.equals("groundspeak:container")|| name.equals("container")){
-			holder.setCacheSize(CacheSize.gcGpxString2Cw(strData));
-			return;
-		}
-		if (name.equals("groundspeak:country")|| name.equals("country")){
-			holder.getFreshDetails().Country = strData;
-			return;
-		}
-		if (name.equals("groundspeak:state")|| name.equals("state")){
-			holder.getFreshDetails().State = strData;
-			return;
-		}
-		if (name.equals("terra:size")){
-			holder.setCacheSize(CacheSize.tcGpxString2Cw(strData));
-		}
-
-		if (name.equals("groundspeak:short_description")|| name.equals("summary")) {
-			if (holder.is_HTML())	holder.getFreshDetails().LongDescription =SafeXML.cleanback(strData)+"<br>"; // <br> needed because we also use a <br> in SpiderGC. Without it the comparison in ch.update fails
-			else holder.getFreshDetails().LongDescription =strData+"\n";
-			return;
-		}
-
-		if (name.equals("groundspeak:long_description")|| name.equals("description")|| name.equals("terra:description")) {
-			if (holder.is_HTML())	holder.getFreshDetails().LongDescription +=SafeXML.cleanback(strData);
-			else holder.getFreshDetails().LongDescription +=strData;
-			return;
-		}
-		if (name.equals("groundspeak:encoded_hints") || name.equals("hints")) {
-			holder.getFreshDetails().Hints = Common.rot13(strData);
-			return;
-		}
-		
-		if (name.equals("terra:hint")) {
-			// remove "&lt;br&gt;<br>" from the end
-			int indexTrash = strData.indexOf("&lt;br&gt;<br>");
-			if (indexTrash > 0)	holder.getFreshDetails().Hints = Common.rot13(strData.substring(0,indexTrash));
-			return;
-		}
-
-
-	}
-	public void characters(char[] ch,int start,int length){
-		strBuf.append(ch,start,length);
-		if (debugGPX) Vm.debug("Char: " + strBuf.toString());
-	}
-	
-
-	public static String typeText2Image(String typeText){
-		if (typeText.equals("Found it")||typeText.equals("Found")||typeText.equals("find")) return "icon_smile.gif";
-		if (typeText.equals("Didn't find it")||typeText.equals("Not Found")||typeText.equals("no_find")) return "icon_sad.gif";
-		if (typeText.equals("Write note")||typeText.equals("Note")||typeText.equals("note")
-			||typeText.equals("Not Attempted")||typeText.equals("Other")) return "icon_note.gif";
-		if (typeText.equals("Enable Listing")) return "icon_enabled.gif";
-		if (typeText.equals("Temporarily Disable Listing")) return "icon_disabled.gif";
-		if (typeText.equals("Webcam Photo Taken")) return "11.png";
-		if (typeText.equals("Attended")) return "icon_attended.gif";
-		if (typeText.equals("Publish Listing")) return "green.png";
-		if (typeText.equals("Will Attend")) return "icon_rsvp.gif";
-		if (typeText.equals("Post Reviewer Note")) return "big_smile.gif";
-		if (typeText.equals("Unarchive")) return "traffic_cone.gif";
-		if (typeText.equals("Archive (show)")) return "traffic_cone.gif";
-		if (typeText.equals("Owner Maintenance")) return "icon_maint.gif";
-		if (typeText.equals("Needs Maintenance")) return "icon_needsmaint.gif";
-		if (typeText.equals("Update Coordinates")) return "coord_update.gif";
-		//Vm.debug("Unknown Log Type:" + typeText);
-		return typeText;
-	}
-	
-	public static String TCSizetoText(String size){
-		if (size.equals("1")) return "Micro";
-		if (size.equals("2")) return "Medium";
-		if (size.equals("3")) return "Regular";
-		if (size.equals("4")) return "Large";
-		if (size.equals("5")) return "Very Large";
-
-		return "None";
-	}
-
-	/**
-	* Method to iterate through cache database and look for waypoint.
-	* Returns value >= 0 if waypoint is found, else -1
-	*/
-	/*
-	private int searchWpt(Vector db, String wpt){
-		if(wpt.length()>0){
-			wpt = wpt.toUpperCase();
-			CacheHolder ch = new CacheHolder();
-			//Search through complete database
-			for(int i = 0;i < db.size();i++){
-				ch = (CacheHolder)db.get(i);
-				if(ch.wayPoint.indexOf(wpt) >=0 ){
-					return i;
-				}
-			} // for
-		} // if
-		return -1;
-	}
-	*/
-	
-	private void spiderImagesUsingSpider(){
-		String addr;
-		String cacheText;
-		
-		// just to be sure to have a spider object
-		if (imgSpider == null) imgSpider = new SpiderGC(pref, profile, false);
-		
-		if (fromTC) {
-				imgSpider.getImages(holder.getFreshDetails().LongDescription, holder.getFreshDetails());
-		}
-		else {
-			addr = "http://www.geocaching.com/seek/cache_details.aspx?wp=" + holder.getWayPoint() ;
-			//Vm.debug(addr + "|");
-			cacheText = SpiderGC.fetch(addr);
-			imgSpider.getImages(cacheText, holder.getFreshDetails());
-			try {
-				imgSpider.getAttributes(cacheText, holder.getFreshDetails());
-			} catch (Exception e) {
-				if (Global.getPref().debug) Global.getPref().log("unable to fetch attrivbutes for"+holder.getWayPoint(), e);
-			}
-		}
-	}
-	
-	public static String replace(String source, String pattern, String replace){
-		if (source!=null)
-		{
-			final int len = pattern.length();
-			StringBuffer sb = new StringBuffer();
-			int found = -1;
-			int start = 0;
-		
-			while( (found = source.indexOf(pattern, start) ) != -1) {
-			    sb.append(source.substring(start, found));
-			    sb.append(replace);
-			    start = found + len;
-			}
-		
-			sb.append(source.substring(start));
-		
-			return sb.toString();
-		}
-		else return "";
-	}
-}

Modified: trunk/src/CacheWolf/GuiImageBroker.java
===================================================================
--- trunk/src/CacheWolf/GuiImageBroker.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/GuiImageBroker.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -49,7 +49,12 @@
 
 	// TODO: move size images here
 	private static final Image[] sizeImages = {
-
+//		new Image(CacheSize.CW_GUIIMG_NONPHYSICAL),
+//		new Image(CacheSize.CW_GUIIMG_MICRO),
+//		new Image(CacheSize.CW_GUIIMG_SMALL),
+//		new Image(CacheSize.CW_GUIIMG_NORMAL),
+//		new Image(CacheSize.CW_GUIIMG_LARGE),
+//		new Image(CacheSize.CW_GUIIMG_VERYLARGE)
 	};
 
 	/** constructor does nothing */
@@ -90,10 +95,10 @@
 	}
 
 	/**
-	 * Replaces the buildt-in symbols by images stored in /symbols:
-	 * If the subdirectory symbols exists in CW-directory *.png-files
+	 * Replaces the build-in symbols by images stored in /symbols:
+	 * If the sub directory symbols exists in CW-directory *.png-files
 	 * are read in and roughly checked for validity (names must be
-	 * convertable to integers between 0 and 21).
+	 * convertible to integers between 0 and 21).
 	 * For every valid file x.png the corresponding typeImages[x] is
 	 * replaced by the image in x.png.
 	 * Images are NOT checked for size etc.

Modified: trunk/src/CacheWolf/InfoBox.java
===================================================================
--- trunk/src/CacheWolf/InfoBox.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/InfoBox.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -8,7 +8,7 @@
 	public boolean mCB_state = false;
 	mButton mB = new mButton("OK");
 	mButton mC = new mButton("Cancel");
-	mInput feedback = new mInput();
+	public mInput feedback = new mInput();
 	public final static int CHECKBOX = 1;
 	public final static int INPUT = 2;
 	public final static int DISPLAY_ONLY = 3;

Modified: trunk/src/CacheWolf/Log.java
===================================================================
--- trunk/src/CacheWolf/Log.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/Log.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,5 +1,7 @@
 package CacheWolf;
 
+import CacheWolf.imp.GPXImporter;
+
 public class Log {
 	private static String MAXLOGICON="MAXLOG";
 	private static String INVALIDLOGICON=null;
@@ -19,7 +21,7 @@
 	 * or <img src='ICON'>&nbsp;DATE by LOGGER<br>MESSAGE</pre>
 	 * @param logLine
 	 */
-	Log(String logLine) {
+	public Log(String logLine) {
 //		RECOMMENDED="1"<img src='icon_smile.gif'>&nbsp;2007-01-14 xyz<br>a wonderful log
 		try {
 			int ic1=logLine.indexOf("RECOMMENDED=\"1\"");
@@ -47,11 +49,11 @@
 		}
 	}
 	
-	Log(String icon, String date, String logger, String message) {
+	public Log(String icon, String date, String logger, String message) {
 		this(icon, date, logger, message, false);
 	}
 	
-	Log(String icon, String date, String logger, String message, boolean recommended_) {
+	public Log(String icon, String date, String logger, String message, boolean recommended_) {
 		this.icon=icon;
 		this.date=date;
 		this.logger=logger;

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/MainMenu.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,18 +1,45 @@
 package CacheWolf;
 
+import CacheWolf.imp.GPXImporter;
+import CacheWolf.imp.OCXMLImporter;
+import CacheWolf.imp.OCXMLImporterScreen;
+import CacheWolf.imp.Rating;
+import CacheWolf.imp.SpiderGC;
 import CacheWolf.navi.MapImporter;
 import CacheWolf.navi.MapLoaderGui;
 import CacheWolf.navi.SelectMap;
-import CacheWolf.imp.Rating;
-import ewe.ui.*;
+import ewe.filechooser.FileChooser;
+import ewe.filechooser.FileChooserBase;
+import ewe.fx.Font;
+import ewe.io.FileBase;
+import ewe.io.IOException;
+import ewe.sys.Vm;
+import ewe.ui.ControlEvent;
+import ewe.ui.Event;
+import ewe.ui.Form;
+import ewe.ui.FormBase;
+import ewe.ui.Gui;
+import ewe.ui.Menu;
+import ewe.ui.MenuBar;
+import ewe.ui.MenuEvent;
+import ewe.ui.MenuItem;
+import ewe.ui.MessageBox;
+import ewe.ui.ProgressBarForm;
+import ewe.ui.PullDownMenu;
+import ewe.ui.mApp;
 import ewe.util.Vector;
-//import ewe.util.mString;
-import ewe.fx.*;
-import ewe.sys.*;
-//import ewe.util.*;
-import ewe.io.*;
-import ewe.filechooser.*;
-import exp.*;
+import exp.ASCExporter;
+import exp.ExploristExporter;
+import exp.GPXExporter;
+import exp.GpxExportNg;
+import exp.HTMLExporter;
+import exp.KMLExporter;
+import exp.LocExporter;
+import exp.MSARCSVExporter;
+import exp.OVLExporter;
+import exp.OziExporter;
+import exp.TPLExporter;
+import exp.TomTomExporter;
 
 /**
  *	This class creates the menu for cachewolf. It is also responsible

Deleted: trunk/src/CacheWolf/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/OCXMLImporter.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,716 +0,0 @@
-package CacheWolf;
-
-import utils.FileBugfix;
-
-import com.stevesoft.ewe_pat.Regex;
-
-import ewesoft.xml.*;
-import ewesoft.xml.sax.*;
-import ewe.io.*;
-import ewe.sys.*;
-import ewe.ui.FormBase;
-import ewe.ui.MessageBox;
-import ewe.util.*;
-import ewe.util.zip.*;
-import ewe.net.*;
-import ewe.sys.Double;
-
-/**
- *	Class to import Data from opencaching.de. 
- *	It uses the lastmodified parameter to identify new or changed caches.
- *	See here: http://www.opencaching.com/phpBB2/viewtopic.php?t=281 (out-dated)
- *   See here: http://www.opencaching.de/doc/xml/xml11.htm and http://develforum.opencaching.de/viewtopic.php?t=135&postdays=0&postorder=asc&start=0
- *	for more information.
- */
-public class OCXMLImporter extends MinML {
-	static protected final int STAT_INIT = 0;
-	static protected final int STAT_CACHE = 1;
-	static protected final int STAT_CACHE_DESC = 2;
-	static protected final int STAT_CACHE_LOG = 3;
-	static protected final int STAT_PICTURE = 4;
-
-	final static String OPENCACHING_HOST = "www.opencaching.de";
-	int state = STAT_INIT;
-	int numCacheImported, numDescImported, numLogImported= 0;
-
-	boolean debugGPX = false;
-	CacheDB cacheDB;
-	InfoBox inf;
-	CacheHolder ch;
-	CacheHolder holder;
-	Preferences pref;
-	Profile profile;
-	Time dateOfthisSync;
-	String strData = new String();
-	int picCnt;
-	boolean incUpdate = true; // complete or incremental Update
-	boolean ignoreDesc = false;
-	boolean askForOptions = true;
-	Hashtable DBindexID = new Hashtable();
-
-	String picUrl = new String();
-	String picTitle =  new String();
-	String picID = new String();
-	String ocSeekUrl = new String("http://"+OPENCACHING_HOST+"/viewcache.php?cacheid=");
-	String cacheID = new String();
-
-	String logData, logIcon, logDate, logFinder, logId;
-	boolean loggerRecommended;
-	int logtype;
-	String user;
-	double longitude;
-
-
-	public OCXMLImporter(Preferences p,Profile prof)
-	{
-		pref = p;
-		profile=prof;
-		cacheDB = profile.cacheDB;
-		if(profile.getLast_sync_opencaching() == null ||
-				profile.getLast_sync_opencaching().length() < 12){
-			profile.setLast_sync_opencaching("20050801000000");
-			incUpdate = false;
-		}
-		user = p.myAlias.toLowerCase();
-		for(int i = 0; i<cacheDB.size();i++){
-			ch = cacheDB.get(i);
-			if (!ch.getOcCacheID().equals(""))
-				DBindexID.put(ch.getOcCacheID(), new Integer(i));
-		}//for
-
-	}
-
-	/** true, if not the last syncdate shall be used, but the caches shall be reloaded
-	 * only used in syncSingle */
-	boolean reload;
-	/**
-	 * 
-	 * @param number
-	 * @param infB
-	 * @return true, if some change was made to the cacheDB
-	 */
-	public boolean syncSingle(int number, InfoBox infB) {
-		ch = cacheDB.get(number);
-		holder= null; //new CacheHolderDetail(ch); //TODO is this still correct? use getDetails ?
-
-		if (infB.isClosed) {
-			if (askForOptions) return false; 
-			else return true;
-		}
-		if (askForOptions) {
-			OCXMLImporterScreen importOpt = new OCXMLImporterScreen( MyLocale.getMsg(1600, "Opencaching.de Download"),OCXMLImporterScreen.IMAGES | OCXMLImporterScreen.ALL);
-			if (importOpt.execute() == FormBase.IDCANCEL) {	return false; }
-			askForOptions = false;
-			reload = importOpt.missingCheckBox.getState();
-		}
-
-		// this is only a dummy-InfoBox for capturing the output
-		inf = new InfoBox("Opencaching download", MyLocale.getMsg(1608,"downloading data\n from opencaching"), InfoBox.PROGRESS_WITH_WARNINGS, false);
-//		inf.setPreferredSize(220, 300);
-//		inf.relayout(false);
-//		inf.exec();
-
-		String lastS; 
-		if (reload)  lastS = "20050801000000";
-		else {
-			if (ch.getLastSync().length() < 14) lastS = "20050801000000";
-			else lastS = ch.getLastSync();
-		}
-		dateOfthisSync = new Time();
-		dateOfthisSync.parse(lastS, "yyyyMMddHHmmss");
-	
-
-		String url = new String();
-		picCnt = 0;
-		//Build url
-		url = "http://" + OPENCACHING_HOST + "/xml/ocxml11.php?"
-			+ "modifiedsince=" + lastS
-			+ "&cache=1"
-			+ "&cachedesc=1";
-		if (pref.downloadPics) url += "&picture=1";
-		else url += "&picture=0";
-		url += "&cachelog=1"
-			+ "&removedobject=0"
-			+ "&wp=" + ch.getWayPoint()
-			+ "&charset=utf-8"
-			+ "&cdata=0"
-			+ "&session=0";
-		syncOC(url);
-		inf.close(0);
-		return true;
-	}
-
-	public void doIt(){
-		boolean success=true;
-		String finalMessage;
-
-		
-		String url = new String();
-
-		String lastS =  profile.getLast_sync_opencaching();
-		CWPoint centre = pref.curCentrePt; // No need to clone curCentrePt as centre is only read
-		if (!centre.isValid()) {
-			(new MessageBox("Error", "Coordinates for centre must be set", FormBase.OKB)).execute();
-			return;
-		}
-		OCXMLImporterScreen importOpt = new OCXMLImporterScreen( MyLocale.getMsg(1600, "Opencaching.de Download"),
-																 OCXMLImporterScreen.ALL | OCXMLImporterScreen.DIST | OCXMLImporterScreen.IMAGES);
-		if (importOpt.execute() == FormBase.IDCANCEL) {	return; }
-		Vm.showWait(true);
-		String dist = importOpt.distanceInput.getText();
-		if (dist.length()== 0) return;
-		
-		Double distDouble = new Double();
-		distDouble.value = Common.parseDouble(dist);
-		dist = distDouble.toString(0, 1, 0).replace(',', '.');
-		//check, if distance is greater than before
-		if (Convert.toInt(dist) > Convert.toInt(profile.getDistOC()) ||
-				pref.downloadmissingOC  ){
-			// resysnc
-			lastS = "20050801000000";
-			incUpdate = false;
-		}
-		profile.setDistOC(dist);
-		// Clear status of caches in db
-		for(int i = cacheDB.size()-1; i>=0 ;i--){
-			ch = cacheDB.get(i);
-			ch.setUpdated(false);
-			ch.setNew(false);
-			ch.setLog_updated(false);
-		}	
-		picCnt = 0;
-		//Build url
-		url = "http://" + OPENCACHING_HOST + "/xml/ocxml11.php?"
-			+ "modifiedsince=" + lastS
-			+ "&cache=1"
-			+ "&cachedesc=1";
-		if (pref.downloadPics) url += "&picture=1";
-		else url += "&picture=0";
-		url += "&cachelog=1"
-			+ "&removedobject=0"
-			+ "&lat=" + centre.getLatDeg(CWPoint.DD)
-			+ "&lon=" + centre.getLonDeg(CWPoint.DD)
-			+ "&distance=" + dist
-			+ "&charset=utf-8"
-			+ "&cdata=0"
-			+ "&session=0";
-		inf = new InfoBox("Opencaching download", MyLocale.getMsg(1608,"downloading data\n from opencaching"), InfoBox.PROGRESS_WITH_WARNINGS, false);
-		inf.setPreferredSize(220, 300);
-		inf.relayout(false);
-		inf.exec();
-
-		success = syncOC(url);
-		profile.saveIndex(pref,Profile.SHOW_PROGRESS_BAR);
-		Vm.showWait(false);
-		if (success) {
-			profile.setLast_sync_opencaching(dateOfthisSync.format("yyyyMMddHHmmss"));
-			//pref.savePreferences();
-			finalMessage = MyLocale.getMsg(1607,"Update from opencaching successful"); 
-			inf.addWarning("\nNumber of"+
-			"\n...caches new/updated: " + numCacheImported +
-			"\n...cache descriptions new/updated: " + numDescImported +
-			"\n...logs new/updated: " + numLogImported);
-			inf.setInfo(finalMessage);
-		}
-		inf.addOkButton();
-	}
-	
-	private boolean syncOC(String url) {
-		String finalMessage = new String();
-		boolean success=true;
-		File tmpFile = null;
-		BufferedReader r;
-		String file = new String();
-
-		//inf = new InfoBox("Opencaching download", MyLocale.getMsg(1608,"downloading data\n from opencaching"), InfoBox.PROGRESS_WITH_WARNINGS, false);
-		
-		picCnt = 0;
-		try{
-			holder = null;
-			file = fetch(url, "dummy");
-
-			//parse
-			tmpFile = new FileBugfix(profile.dataDir + file);
-			if (tmpFile.getLength() == 0 ) {
-				throw new IOException("no updates available");
-			}
-
-			ZipFile zif = new ZipFile (profile.dataDir + file);
-			ZipEntry zipEnt;
-			Enumeration zipEnum = zif.entries();
-			inf.setInfo("...unzipping update file"); 
-			while (zipEnum.hasMoreElements())
-			{
-				zipEnt = (ZipEntry) zipEnum.nextElement();
-				// skip over PRC-files and empty files
-				if (zipEnt.getSize()> 0 && zipEnt.getName().endsWith("xml")){
-					r = new BufferedReader (new InputStreamReader(zif.getInputStream(zipEnt), IO.JAVA_UTF8_CODEC));
-					parse(r);
-					r.close();
-				}
-			}
-			zif.close();
-		}catch (ZipException e){
-			finalMessage = MyLocale.getMsg(1614,"Error while unzipping udpate file");
-			success = false;
-		}catch (IOException e){
-			if (e.getMessage().equalsIgnoreCase("no updates available")) { finalMessage = "No updates available"; success = false; }
-			else {
-				if (e.getMessage().equalsIgnoreCase("could not connect") ||
-						e.getMessage().equalsIgnoreCase("unkown host")) { // is there a better way to find out what happened?
-					finalMessage = MyLocale.getMsg(1616,"Error: could not download udpate file from opencaching.de");
-				} else { finalMessage = "IOException: "+e.getMessage(); }
-				success = false;
-			}
-		}catch (IllegalArgumentException e) {
-			finalMessage = MyLocale.getMsg(1621,"Error parsing update file\n this is likely a bug in opencaching.de\nplease try again later\n, state:")+" "+state+", waypoint: "+ holder.getWayPoint();
-			success = false;
-			Vm.debug("Parse error: " + state + " " + holder.getWayPoint());
-			e.printStackTrace();
-		}catch (Exception e){ // here should be used the correct exception
-			if (holder != null)	finalMessage = MyLocale.getMsg(1615,"Error parsing update file, state:")+" "+state+", waypoint: "+ holder.getWayPoint();
-			else finalMessage = MyLocale.getMsg(1615,"Error parsing update file, state:")+" "+state+", waypoint: <unkown>";
-			success = false;
-			Vm.debug("Parse error: " + state + " Exception:" + e.toString()+"   "+holder.getOcCacheID());
-			e.printStackTrace();
-		} finally {
-			if (tmpFile != null) tmpFile.delete();
-		}
-		/*
-		for (int i=cacheDB.size()-1; i >=0; i--) {
-			ch = (CacheHolder)cacheDB.get(i);
-			if (ch.wayPoint.toUpperCase().startsWith("OC")) { //TODO only handle changed caches
-				ch.calcRecommendationScore();
-			}
-		} */
-		inf.setInfo(finalMessage);
-
-		return success;
-	}
-
-	public void startElement(String name, AttributeList atts){
-		if (debugGPX){
-			for (int i = 0; i < atts.getLength(); i++) {
-				Vm.debug(" Name: " + atts.getName(i)+ " Value: "+atts.getValue(i));
-			}
-		}
-		strData ="";
-
-		if (name.equals("oc11xml")){
-			Time lastSync = new Time();
-			try {
-				lastSync.parse(atts.getValue("date"),"yyyy-MM-dd HH:mm:ss");
-			}catch (IllegalArgumentException e){ // TODO Fehler werfen
-				Vm.debug(e.toString());
-			}
-			// reduce time at 1 second to avoid sync problems
-			lastSync.setTime(lastSync.getTime() - 1000);
-			dateOfthisSync = lastSync;
-			state = STAT_INIT;
-		}
-
-		// look for changes in the state
-		if (name.equals("cache")) 		{ state = STAT_CACHE; numCacheImported++;}
-		if (name.equals("cachedesc")) 	{ state = STAT_CACHE_DESC; numDescImported++;}
-		if (name.equals("cachelog")) 	{ state = STAT_CACHE_LOG; numLogImported++; logtype = 0;}
-		if (name.equals("picture")) 	{ state = STAT_PICTURE; }
-
-		//examine data
-		switch (state) {
-		case STAT_CACHE: startCache(name, atts); break;
-		case STAT_CACHE_DESC: startCacheDesc(name, atts); break; 
-		case STAT_CACHE_LOG: startCacheLog(name, atts); break;
-		case STAT_PICTURE: startPicture(name,atts); break;
-		}
-
-	}
-
-	public void endElement(String name){
-		//examine data
-		switch (state) {
-		case STAT_CACHE: endCache(name); break;
-		case STAT_CACHE_DESC: endCacheDesc(name);break;
-		case STAT_CACHE_LOG: endCacheLog(name); break;
-		case STAT_PICTURE: endPicture(name); break;
-		}
-
-		// look for changes in the state
-		if (name.equals("cache")) 		state = STAT_INIT;
-		if (name.equals("cachedesc")) 	state = STAT_INIT;
-		if (name.equals("cachelog")) 	state = STAT_INIT;
-		if (name.equals("picture")) 	state = STAT_INIT;
-
-	}
-
-	public void characters(char[] ch2,int start,int length){
-		String chars = new String(ch2,start,length);
-		strData += chars;
-		if (debugGPX) Vm.debug(strData);
-	}
-
-	private void startCache(String name, AttributeList atts){
-		inf.setInfo(MyLocale.getMsg(1609,"Importing Cache:")+" " + numCacheImported + "\n");
-		if(name.equals("id")){
-			cacheID = atts.getValue("id");
-		}
-		if(name.equals("type")){
-			holder.setType(CacheType.ocType2CwType(atts.getValue("id")));
-			return;
-		}
-		if(name.equals("status")){
-			if(atts.getValue("id").equals("1")) holder.setAvailable(true);
-			if(atts.getValue("id").equals("2")) holder.setAvailable(false);
-			if(atts.getValue("id").equals("3")) {
-				holder.setArchived(true);
-				holder.setAvailable(false);
-			}
-			if(atts.getValue("id").equals("4")) holder.setAvailable(false);
-			return;
-		}
-		if(name.equals("size")){
-			holder.setCacheSize(CacheSize.ocXmlString2Cw(atts.getValue("id")));
-			return;
-		}
-
-		if(name.equals("waypoints")){
-			holder.setWayPoint(atts.getValue("oc"));
-			if (holder.getWayPoint().length()==0) throw new IllegalArgumentException("empty waypointname"); // this should not happen - it is likey a bug in opencaching.de / it happens on 27-12-2006 on cache OC143E
-			return;
-		}
-
-	}
-	private void startCacheDesc(String name, AttributeList atts){
-		inf.setInfo(MyLocale.getMsg(1611,"Importing cache description:")+" " + numDescImported);
-		if (name.equals("cachedesc")){
-			ignoreDesc = false;
-		}
-
-		if (name.equals("desc")){
-			holder.setHTML(atts.getValue("html").equals("1")?true:false);
-		}
-
-		if (name.equals("language") && !atts.getValue("id").equals("DE")){
-			if (holder.getFreshDetails().LongDescription.length()> 0) ignoreDesc = true; // TODO "DE" in preferences adjustable
-			else ignoreDesc = false;
-		}
-	}
-
-	private void startPicture(String name, AttributeList atts){
-		if(name.equals("picture")){
-			inf.setInfo(MyLocale.getMsg(1613,"Pictures:")+" " + ++picCnt);
-		}
-	}
-
-	private void startCacheLog(String name, AttributeList atts){
-		inf.setInfo(MyLocale.getMsg(1612,"Importing Cachlog:")+" " + numLogImported);
-		if (name.equals("logtype")){
-			logtype = Convert.toInt(atts.getValue("id"));
-			switch (logtype) {
-			case 1: 
-				logIcon = GPXImporter.typeText2Image("Found");
-				break;
-			case 2:	logIcon = GPXImporter.typeText2Image("Not Found"); 
-			holder.setNoFindLogs((byte)(holder.getNoFindLogs()+1));
-			break;
-			case 3: logIcon = GPXImporter.typeText2Image("Note");
-			}
-			loggerRecommended = atts.getValue("recommended").equals("1");
-			return;
-		}
-		
-		if (name.equals("id")){
-			logId = atts.getValue("id");
-		}
-	}
-
-	// TODO Do we have to release the "holder" cache details ?
-	private void endCache(String name){
-		if (name.equals("cache")){
-			holder.setLastSync(dateOfthisSync.format("yyyyMMddHHmmss"));
-			int index;
-			index = cacheDB.getIndex(holder.getWayPoint());
-			if (index == -1){
-				holder.setNew(true);
-				cacheDB.add(holder);
-				Integer indexInt = new Integer(cacheDB.size()-1);
-				DBindexID.put(holder.getOcCacheID(), indexInt);
-			}
-			// update (overwrite) data
-			else {
-				holder.setNew(false);
-				holder.setIncomplete(false);
-				cacheDB.get(index).update(holder);
-				// save ocCacheID, in case, the previous data is from GPX
-				DBindexID.put(holder.getOcCacheID(), new Integer(index));
-			}
-			// clear data (picture, logs) if we do a complete Update
-			if (incUpdate == false){
-				holder.getFreshDetails().CacheLogs.clear();
-				holder.getFreshDetails().Images.clear();
-				holder.getFreshDetails().ImagesText.clear();
-				holder.getFreshDetails().ImagesInfo.clear();
-			}
-
-			// save all
-			holder.getFreshDetails().hasUnsavedChanges = true; // this makes CachHolder save the details in case that they are unloaded from memory
-			// chD.saveCacheDetails(profile.dataDir); 
-			// profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR); // this is done after .xml is completly processed
-			return;
-		}
-		if(name.equals("id")){ // </id>
-			holder = getHolder(strData); // Allocate a new CacheHolder object
-			holder.setOcCacheID(strData);
-			holder.getFreshDetails().URL = ocSeekUrl + cacheID;
-			return;
-		}
-
-		if(name.equals("name")){
-			holder.setCacheName(strData);
-			return;
-		}
-		if(name.equals("userid")) {
-			holder.setCacheOwner(strData);
-			if(holder.getCacheOwner().equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()>0 && holder.getCacheOwner().equalsIgnoreCase(pref.myAlias2))) holder.setOwned(true);
-			return;
-		}
-
-		if(name.equals("longitude")){
-			longitude = Common.parseDouble(strData);
-			return;
-		}
-		if(name.equals("latitude")) {
-			holder.pos.set(Common.parseDouble(strData),longitude);
-			holder.LatLon = holder.pos.toString();
-			return;
-		}
-		if(name.equals("difficulty")) {
-			holder.setHard(CacheTerrDiff.v1Converter(strData));
-			return;
-		}
-		if(name.equals("terrain")) {
-			holder.setTerrain(CacheTerrDiff.v1Converter(strData));
-			return;
-		}
-		if(name.equals("datehidden")) {
-			holder.setDateHidden(strData.substring(0,10)); //Date;
-			return;
-		}
-		if (name.equals("country")){
-			holder.getFreshDetails().Country = strData;
-			return;
-		}
-	}
-
-	private void endCacheDesc(String name){
-
-		if (!ignoreDesc){
-			if (name.equals("cachedesc")){
-				if (pref.downloadPics && holder.is_HTML()) {
-					String fetchUrl, imgTag, imgAltText;
-					Regex imgRegexUrl = new Regex("(<img[^>]*src=[\"\']([^>^\"^\']*)[^>]*>|<img[^>]*src=([^>^\"^\'^ ]*)[^>]*>)"); //  Ergebnis enth?lt keine Anf?hrungszeichen
-					Regex imgRegexAlt = new Regex("(?:alt=[\"\']([^>^\"^\']*)|alt=([^>^\"^\'^ ]*))"); // get alternative text for Pic
-					imgRegexAlt.setIgnoreCase(true);
-					imgRegexUrl.setIgnoreCase(true);
-					int descIndex=0;
-					int numDownloaded=1;
-					while (imgRegexUrl.searchFrom(holder.getFreshDetails().LongDescription, descIndex)) { // "img" found
-						imgTag=imgRegexUrl.stringMatched(1); // (1) enth?lt das gesamte <img ...>-tag
-						fetchUrl=imgRegexUrl.stringMatched(2); // URL in Anf?hrungszeichen in (2) falls ohne in (3) Ergebnis ist auf jeden Fall ohne Anf?hrungszeichen 
-						if (fetchUrl==null) { fetchUrl=imgRegexUrl.stringMatched(3); }
-						if (fetchUrl==null) { // TODO Fehler ausgeben: nicht abgedeckt ist der Fall, dass in einem Cache Links auf Bilder mit unterschiedlichen URL, aber gleichem Dateinamen sind.
-							inf.addWarning(MyLocale.getMsg(1617, "Ignoriere Fehler in html-Cache-Description: \"<img\" without \"src=\" in cache "+holder.getWayPoint()));
-							continue;
-						}
-						inf.setInfo(MyLocale.getMsg(1611,"Importing cache description:")+" " + numDescImported + "\n"+MyLocale.getMsg(1620, "downloading embedded images: ") + numDownloaded++);
-						if (imgRegexAlt.search(imgTag)) {
-							imgAltText=imgRegexAlt.stringMatched(1);
-							if (imgAltText==null)	imgAltText=imgRegexAlt.stringMatched(2);
-							// kein alternativer Text als Bild?berschrift -> Dateiname
-						} else { 
-							if (fetchUrl.toLowerCase().indexOf("opencaching.de") > 0 || fetchUrl.toLowerCase().indexOf("geocaching.com") > 0) //wenn von Opencaching oder geocaching ist Dateiname doch nicht so toll, weil nur aus Nummer bestehend 
-								imgAltText = new String("No image title");
-							else imgAltText = fetchUrl.substring(fetchUrl.lastIndexOf("/")+1);
-						}
-						descIndex = imgRegexUrl.matchedTo();
-						getPic(fetchUrl, imgAltText);
-					}
-				}
-				holder.getFreshDetails().hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
-				return;
-			}
-
-
-			if (name.equals("cacheid")){
-				// load cachedata
-				holder = getHolder(strData);
-				holder.setUpdated(true);
-				return;
-			}
-
-			if (name.equals("shortdesc")){
-				holder.getFreshDetails().LongDescription = strData;
-				return;
-			}
-
-			if (name.equals("desc")){ // </desc>
-				if (holder.is_HTML())	holder.getFreshDetails().LongDescription +=SafeXML.cleanback(strData);
-				else holder.getFreshDetails().LongDescription +=strData;
-				return;
-			}
-			if (name.equals("hint")){
-				holder.getFreshDetails().Hints = Common.rot13(strData);
-				return;
-			}
-		}
-	}
-
-	private String createPicFilename(String fetchURL) {
-		String fileName = holder.getWayPoint() + "_" + fetchURL.substring(fetchURL.lastIndexOf("/")+1);
-		return Common.ClearForFileName(fileName);
-	}
-	
-	private void getPic(String fetchURL, String picDesc) { // TODO handling of relativ URLs
-		try {
-			if (!fetchURL.startsWith("http://")) fetchURL = new URL(new URL("http://" + OPENCACHING_HOST+"/"), fetchURL).toString(); // TODO this is not quite correct: actually the "base" URL must be known... but anyway a different baseURL should not happen very often  - it doesn't in my area
-			String fileName = createPicFilename(fetchURL);
-			// add title
-			holder.getFreshDetails().ImagesText.add(picDesc);
-			holder.getFreshDetails().ImagesInfo.add(null); // need to stay in sync with ImagesText
-			try {
-				File ftest = new File(profile.dataDir + fileName);
-				if (ftest.exists()){
-					holder.getFreshDetails().Images.add(fileName);
-				}
-				else {
-					if (pref.downloadPics) {
-						holder.getFreshDetails().Images.add(fetch(fetchURL, fileName));
-					}
-				}
-			} catch (IOException e) {
-				String ErrMessage = new String (MyLocale.getMsg(1618,"Ignoring error in cache: ") + holder.getWayPoint() + ": ignoring IOException: "+e.getMessage()+ " while downloading picture:"+fileName+" from URL:"+fetchURL); 
-				if (e.getMessage().toLowerCase().equalsIgnoreCase("could not connect") ||
-						e.getMessage().equalsIgnoreCase("unkown host")) { // is there a better way to find out what happened?
-					ErrMessage = MyLocale.getMsg(1618,"Ignoring error in cache: ")+holder.getCacheName() + " ("+holder.getWayPoint()+")"+MyLocale.getMsg(1619,": could not download image from URL: ")+fetchURL;
-				} 
-				inf.addWarning("\n"+ErrMessage);
-				//(new MessageBox(MyLocale.getMsg(144, "Warning"), ErrMessage, MessageBox.OKB)).exec();
-				pref.log(ErrMessage);
-				e.printStackTrace();
-			}
-		} catch (MalformedURLException e) {
-			String ErrMessage = new String (MyLocale.getMsg(1618,"Ignoring error in cache: ") + holder.getWayPoint() + ": ignoring MalformedUrlException: " + e.getMessage()+ " while downloading from URL:" + fetchURL); 
-			inf.addWarning("\n"+ErrMessage);
-			pref.log(ErrMessage);
-		}
-
-	}
-
-
-	private void endPicture(String name){
-
-		if(name.equals("id")){
-			picID = strData;
-			return;
-		}
-
-		if (name.equals("url")){
-			picUrl = strData;
-			return;
-		}
-		if (name.equals("title")){
-			picTitle = strData;
-			return;
-		}
-		if(name.equals("object")){
-			// get cachedata
-			holder = getHolder(strData);
-			return;
-		}
-		if(name.equals("picture")){ 
-			//String fileName = holder.wayPoint + "_" + picUrl.substring(picUrl.lastIndexOf("/")+1);
-			getPic(picUrl,picTitle);
-			holder.getFreshDetails().hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
-			return;
-		}
-	}
-
-	private void endCacheLog(String name){
-		if (name.equals("cachelog")){ // </cachelog>
-			holder.getFreshDetails().CacheLogs.merge(new Log(logIcon, logDate, logFinder, logData, loggerRecommended));
-			if((logFinder.toLowerCase().compareTo(user) == 0 || logFinder.equalsIgnoreCase(pref.myAlias2)) && logtype == 1) {
-						holder.setCacheStatus(logDate);
-						holder.setFound(true);
-						holder.getFreshDetails().OwnLogId = logId;
-						holder.getFreshDetails().OwnLog = new Log(logIcon, logDate, logFinder, logData, loggerRecommended);
-			}
-			holder.getFreshDetails().hasUnsavedChanges = true; //chD.saveCacheDetails(profile.dataDir);
-			return;
-		}
-
-		if (name.equals("cacheid")){ // </cacheid>
-			// load cachedata
-			holder = getHolder(strData);
-			return;
-		}
-
-		if (name.equals("date"))  {
-			logDate = new String(strData);
-			return;
-		}
-		if (name.equals("userid")){
-			logFinder = new String(strData);
-			return;
-		}
-		if (name.equals("text")){ 
-			logData = new String(strData);
-			return;
-		}
-
-	}
-
-	private String fetch(String addr, String fileName ) throws IOException
-	{
-		//Vm.debug("Redirect: " + redirect);
-		CharArray realurl = new CharArray();
-		ByteArray daten = UrlFetcher.fetchByteArray(addr, realurl);
-		String address = realurl.toString();
-		if (holder != null) fileName = holder.getWayPoint() + "_" + Common.ClearForFileName(address.substring(address.lastIndexOf("/")+1));
-		// else fileName = Common.ClearForFileName(address.substring(address.lastIndexOf("/")+1));
-
-		//save file
-		//Vm.debug("Save: " + myPref.mydatadir + fileName);
-		//Vm.debug("Daten: " + daten.length);
-		FileOutputStream outp =  new FileOutputStream(profile.dataDir + fileName);
-		outp.write(daten.toBytes());
-		outp.close();
-		return fileName;
-	}
-
-
-	/**
-	 * Method to iterate through cache database and look for cacheID.
-	 * Returns value >= 0 if cacheID is found, else -1
-	 */
-	private int searchID(String cacxheID){
-		Integer INTR = (Integer)DBindexID.get(cacxheID);
-		if(INTR != null){
-			return INTR.intValue();
-		} else return -1;
-	}
-
-
-	private CacheHolder getHolder(String wpt){// See also LOCXMLImporter
-		CacheHolder chx;
-		int index;
-		
-		index = cacheDB.getIndex(wpt);
-		if (index == -1) index = searchID(wpt);
-		if (index == -1) {
-			chx = new CacheHolder();
-		} else {
-			chx = cacheDB.get(index);
-		}
-		return chx;
-	}
-
-}

Deleted: trunk/src/CacheWolf/OCXMLImporterScreen.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporterScreen.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/OCXMLImporterScreen.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,207 +0,0 @@
-/**
- * 
- */
-package CacheWolf;
-
-import CacheWolf.SpiderGC.SpiderProperties;
-import ewe.sys.Convert;
-import ewe.ui.*;
-
-/**
- * @author pfeffer
- * This Class is the Dialog for Download from Opencaching.de 
- * is called from OCXMLImporter
- * 20061209 Bugfix: Checking for uninitialised missingCheckBox
- */
-public class OCXMLImporterScreen extends Form {
-	mButton cancelB, okB;
-	Preferences pref;
-	mChoice chcType;
-	mInput distanceInput;
-	mInput maxNumberInput;
-	mInput maxLogsInput;
-	mCheckBox imagesCheckBox, /*mapsCheckBox, */ missingCheckBox, foundCheckBox, travelbugsCheckBox;
-	mLabel distLbl;
-	mLabel maxNumberLbl;
-	mLabel distUnit;
-	boolean isGC = true;
-	static int DIST = 1;
-	static int IMAGES = 2;
-	static int ALL = 4;
-	static int INCLUDEFOUND = 8;
-	static int ISGC = 16;
-	static int MAXNUMBER = 32;
-	static int TRAVELBUGS = 64;
-	static int MAXLOGS = 128;
-	static int TYPE = 256;
-
-	
-	public OCXMLImporterScreen(String title, int options) {
-		super();
-		pref = Global.getPref(); // myPreferences sollte sp?ter auch diese Einstellungen speichern
-		
-		isGC = ((options & ISGC) > 0);
-		
-		this.title = title;
-				
-		if ((options & TYPE) > 0) {
-			this.addLast( chcType = new mChoice(new String[] {
-					MyLocale.getMsg(1627,"All caches"),	
-					CacheType.CW_GUISTR_TRADI,
-					CacheType.CW_GUISTR_MULTI,
-					CacheType.CW_GUISTR_VIRTUAL,
-					CacheType.CW_GUISTR_LETTERBOX,
-					CacheType.CW_GUISTR_EVENT,
-					CacheType.CW_GUISTR_MEGAEVENT,
-					CacheType.CW_GUISTR_WEBCAM,
-					CacheType.CW_GUISTR_UNKNOWN,
-					CacheType.CW_GUISTR_CITO,
-					CacheType.CW_GUISTR_EARTH,
-					CacheType.CW_GUISTR_WHEREIGO
-				},0), CellConstants.STRETCH, (CellConstants.FILL|CellConstants.WEST));
-		}
-
-		if ((options & DIST) > 0) {
-			this.addNext(distLbl = new mLabel(MyLocale.getMsg(1601,"Distance:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-			distanceInput = new mInput();
-			String dist1;
-			String dist2;
-			if (isGC) {
-				dist1 = Global.getProfile().getDistGC();
-				dist2 = Global.getProfile().getDistOC();
-			} else {
-				dist1 = Global.getProfile().getDistOC();
-				dist2 = Global.getProfile().getDistGC();
-			}
-			if ( dist1.equals("") || dist1.equals("0") || dist1.equals("0.0") ) {
-				dist1 = dist2;
-			}
-			distanceInput.setText(dist1);
-			this.addNext(distanceInput,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-			this.addLast(distUnit = new mLabel(" km/mi."),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		}
-		
-		if ((options & MAXNUMBER) > 0) {
-			this.addNext(maxNumberLbl = new mLabel(MyLocale.getMsg(1623,"Max. number:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-			maxNumberInput = new mInput();
-			if ( pref.maxSpiderNumber < 0 ) {
-				maxNumberInput.setText("");
-			} else {
-				maxNumberInput.setText(Integer.toString(pref.maxSpiderNumber));
-			}
-			this.addNext(maxNumberInput,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-			this.addLast( new mLabel(MyLocale.getMsg(1624," caches")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		}
-		
-		if ((options & MAXLOGS) > 0) {
-			this.addNext(new mLabel(MyLocale.getMsg(1626,"Max. logs:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-			maxLogsInput = new mInput();
-			maxLogsInput.setText(Convert.toString(pref.maxLogsToSpider));
-			this.addLast(maxLogsInput,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		}
-
-		if ((options & IMAGES) > 0) {
-			imagesCheckBox = new mCheckBox();
-			imagesCheckBox.setText(MyLocale.getMsg(1602,"Download Images"));
-			imagesCheckBox.setState(pref.downloadPics);
-			this.addLast(imagesCheckBox, CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST);
-		}
-		
-		if ((options & TRAVELBUGS) > 0) {
-			travelbugsCheckBox = new mCheckBox();
-			travelbugsCheckBox.setText(MyLocale.getMsg(1625,"Download TBs"));
-			travelbugsCheckBox.setState(pref.downloadTBs);
-			this.addLast(travelbugsCheckBox, CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST);
-		}
-		
-		if((options & INCLUDEFOUND) > 0){
-			foundCheckBox = new mCheckBox();
-			foundCheckBox.setText(MyLocale.getMsg(1622,"Exclude found caches"));
-			foundCheckBox.setState(true);
-			this.addLast(foundCheckBox, CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST);
-		}
-
-		if((options & ALL) > 0){
-			missingCheckBox = new mCheckBox();
-			missingCheckBox.setText(MyLocale.getMsg(1606,"Alle erneut downloaden"));
-			missingCheckBox.setState(pref.downloadmissingOC);
-			this.addLast(missingCheckBox, CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST);
-		}
-
-		cancelB = new mButton(MyLocale.getMsg(1604,"Cancel"));
-		cancelB.setHotKey(0, IKeys.ESCAPE);
-		this.addNext(cancelB,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		okB = new mButton(MyLocale.getMsg(1605,"OK"));
-		okB.setHotKey(0, IKeys.ACTION);
-		okB.setHotKey(0, IKeys.ENTER);
-		this.addLast(okB,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-	}
-	public void onEvent(Event ev){
-		if (ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED){
-			if (ev.target == cancelB){
-				this.close(FormBase.IDCANCEL);
-			}
-			if (ev.target == okB){
-				    // distOC wird hier noch nicht in Pref eingetragen, damit noch gepr?ft werden kann, ob es gr??er oder kleiner ist als vorher
-					if (imagesCheckBox!=null) pref.downloadPics = imagesCheckBox.state;
-					if (missingCheckBox!=null) pref.downloadmissingOC = missingCheckBox.state;
-					if (travelbugsCheckBox!=null) pref.downloadTBs = travelbugsCheckBox.state;
-					if (maxLogsInput!=null) pref.maxLogsToSpider=Common.parseInt(maxLogsInput.getText());
-					pref.savePreferences();
-				this.close(FormBase.IDOK);
-				}
-		}
-		super.onEvent(ev);
-	}
-	
-	public String getCacheTypeRestriction(SpiderProperties p){
-		String cacheTypeRestriction = "";
-
-		if (chcType!=null){
-			try {
-				switch (chcType.getInt()) {
-				case  0:
-					cacheTypeRestriction = "";
-					break;
-				case  1: 
-					cacheTypeRestriction = p.getProp("onlyTraditional");
-					break;
-				case  2:
-					cacheTypeRestriction = p.getProp("onlyMulti");
-					break;
-				case  3:
-					cacheTypeRestriction = p.getProp("onlyVirtual") ;
-					break;
-				case  4:
-					cacheTypeRestriction = p.getProp("onlyLetterboxHybrid");
-					break;
-				case  5:
-					cacheTypeRestriction = p.getProp("onlyEvent");
-					break;
-				case  6:
-					cacheTypeRestriction = p.getProp("onlyMegaEvent");
-					break;
-				case  7:
-					cacheTypeRestriction = p.getProp("onlyWebcam");
-					break;
-				case  8:
-					cacheTypeRestriction = p.getProp("onlyUnknown");
-					break;
-				case 9:
-					cacheTypeRestriction = p.getProp("onlyCito");
-					break;
-				case 10:
-					cacheTypeRestriction = p.getProp("onlyEarth");
-					break;
-				case 11:
-					cacheTypeRestriction = p.getProp("onlyWherigo");
-					break;
-				default:
-					cacheTypeRestriction = "";
-				}
-			}catch (Exception ex) { // Some tag missing from spider.def
-			}
-		}
-		return cacheTypeRestriction;
-	}
-}

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import CacheWolf.imp.SpiderGC;
 import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.io.*;

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import CacheWolf.imp.SpiderGC;
 import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.ui.*;

Modified: trunk/src/CacheWolf/Profile.java
===================================================================
--- trunk/src/CacheWolf/Profile.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/Profile.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -364,7 +364,7 @@
 	 *  Called from Main Form and MainMenu 
 	 *  The values of Filter.isActive and Filter.isInactive are set by the filter 
 	 **/
-	void restoreFilter() {
+	public void restoreFilter() {
 		restoreFilter( true );		
 	}
 	

Deleted: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/SpiderGC.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -1,1676 +0,0 @@
-/*
-    CacheWolf is a software for PocketPC, Win and Linux that
-    enables paperless caching.
-    It supports the sites geocaching.com and opencaching.de
-
-    Copyright (C) 2006  CacheWolf development team
-    See http://developer.berlios.de/projects/cachewolf/
-    for more information.
-    Contact: 	bilbowolf at users.berlios.de
-		kalli at users.berlios.de
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation version 2 of the License.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
-    */
-
-package CacheWolf;
-import ewe.net.*;
-import ewe.io.*;
-import ewe.sys.*;
-import ewe.sys.Double;
-import ewe.util.*;
-import CacheWolf.navi.Metrics;
-
-import com.stevesoft.ewe_pat.*;
-import ewe.ui.*;
-import ewe.data.Property;
-import ewe.data.PropertyList;
-
-/**
-*	Class to spider caches from gc.com
-*/
-public class SpiderGC{
-
-	/**
-	 * The maximum number of logs that will be stored
-	 */
-	public static int MAXLOGS=250; // Can be pre-set from preferences
-	public static String passwort = ""; // Can be pre-set from preferences
-	public static boolean loggedIn = false;
-
-	private static int ERR_LOGIN = -10;
-	private static Preferences pref;
-	private Profile profile;
-	private static String viewstate = "";
-	private static String viewstate1 = "";
-	private static String eventvalidation = "";
-	private static String cookieID = "";
-	private static String cookieSession = "";
-	private static double distance = 0;
-	private Regex inRex = new Regex();
-	private CacheDB cacheDB;
-	private Vector cachesToLoad = new Vector();
-	private InfoBox infB;
-	private static SpiderProperties p=null;
-
-	public SpiderGC(Preferences prf, Profile profile, boolean bypass){
-		this.profile=profile;
-		this.cacheDB = profile.cacheDB;
-		pref = prf;
-		if (p==null) {
-			pref.logInit();
-			p=new SpiderProperties();
-		}
-		MAXLOGS=pref.maxLogsToSpider;
-	}
-
-	/**
-	 * Method to login the user to gc.com
-	 * It will request a password and use the alias defined in preferences
-	 * If the login page cannot be fetched, the password is cleared.
-	 * If the login fails, an appropriate message is displayed.
-	 */
-	public int login(){
-		loggedIn = false;
-		String start,loginPage,loginSuccess,nextPage;
-		try {
-			loginPage=p.getProp("loginPage");
-			loginSuccess=p.getProp("loginSuccess");
-			nextPage=p.getProp("nextPage");
-		} catch (Exception ex) { // Tag not found in spider.def
-			return ERR_LOGIN;
-		}
-		//Get password
-		InfoBox localInfB = new InfoBox(MyLocale.getMsg(5506,"Password"), MyLocale.getMsg(5505,"Enter Password"), InfoBox.INPUT);
-		localInfB.feedback.setText(passwort); // Remember the PWD for next time
-		localInfB.feedback.isPassword=true;
-		int code=FormBase.IDOK;
-		if (passwort.equals("")) {
-			code = localInfB.execute();
-			passwort = localInfB.getInput();
-		}
-		localInfB.close(0);
-		if(code != FormBase.IDOK) return code;
-		// Now start the login proper
-		localInfB = new InfoBox(MyLocale.getMsg(5507,"Status"), MyLocale.getMsg(5508,"Logging in..."));
-		localInfB.exec();
-		try{
-			pref.log("[login]:Fetching login page");
-			//Access the page once to get a viewstate
-			start = fetch(loginPage);   //http://www.geocaching.com/login/Default.aspx
-			if (start.equals("")) {
-				localInfB.close(0);
-				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5499,"Error loading login page.%0aPlease check your internet connection."), FormBase.OKB)).execute();
-				pref.log("[login]:Could not fetch: gc.com login page");
-				return ERR_LOGIN;
-			}
-		} catch(Exception ex){
-			localInfB.close(0);
-			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5499,"Error loading login page.%0aPlease check your internet connection."), FormBase.OKB)).execute();
-			pref.log("[login]:Could not fetch: gc.com login page",ex);
-			return ERR_LOGIN;
-		}
-		if (!localInfB.isClosed) { // If user has not aborted, we continue
-			Regex rexCookieID = new Regex("(?i)Set-Cookie: userid=(.*?);.*");
-			Regex rexViewstate = new Regex("id=\"__VIEWSTATE\" value=\"(.*?)\" />");
-			Regex rexViewstate1 = new Regex("id=\"__VIEWSTATE1\" value=\"(.*?)\" />");
-			Regex rexEventvalidation = new Regex("id=\"__EVENTVALIDATION\" value=\"(.*?)\" />");
-			Regex rexCookieSession = new Regex("(?i)Set-Cookie: ASP.NET_SessionId=(.*?);.*");
-			rexViewstate.search(start);
-			if(rexViewstate.didMatch()){
-				viewstate = rexViewstate.stringMatched(1);
-				//Vm.debug("ViewState: " + viewstate);
-			} else
-				pref.log("[login]:Viewstate not found before login");
-
-			if(start.indexOf(loginSuccess) > 0)
-				pref.log("[login]:Already logged in");
-			else {
-				rexEventvalidation.search(start);
-				if(rexEventvalidation.didMatch()){
-					eventvalidation = rexEventvalidation.stringMatched(1);
-					//Vm.debug("EVENTVALIDATION: " + eventvalidation);
-				} else
-					pref.log("[login]:Eventvalidation not found before login");
-				//Ok now login!
-				try{
-					pref.log("[login]:Logging in as "+pref.myAlias);
-					StringBuffer sb=new StringBuffer(1000);
-					sb.append(URL.encodeURL("__VIEWSTATE",false));	sb.append("="); sb.append(URL.encodeURL(viewstate,false));
-					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("myUsername",false));
-					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(pref.myAlias)));
-					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("myPassword",false));
-					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(passwort)));
-					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("cookie",false));
-					sb.append("="); sb.append(URL.encodeURL("on",false));
-					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("Button1",false));
-					sb.append("="); sb.append(URL.encodeURL("Login",false));
-//					sb.append("&"); sb.append(URL.encodeURL("__EVENTVALIDATION",false));
-//					sb.append("="); sb.append(URL.encodeURL(eventvalidation,false));
-					start = fetch_post(loginPage, sb.toString(), nextPage);  // /login/default.aspx
-					if(start.indexOf(loginSuccess) > 0)
-						pref.log("[login]:Login successful");
-					else {
-						pref.log("[login]:Login failed. Wrong Account or Password?");
-						if (pref.debug) {
-							pref.log("[login.LoginUrl]:"+sb.toString());
-							pref.log("[login.Answer]:"+start);
-						}
-						localInfB.close(0);
-						(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed! Wrong account or password?"), FormBase.OKB)).execute();
-						return ERR_LOGIN;
-					}
-				}catch(Exception ex){
-					pref.log("[login]:Login failed with exception.", ex);
-					localInfB.close(0);
-					(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed. Error loading page after login."), FormBase.OKB)).execute();
-					return ERR_LOGIN;
-				}
-			}
-
-			rexViewstate.search(start);
-			if (!rexViewstate.didMatch()) {
-				pref.log("[login]:Viewstate not found");
-			}
-			viewstate = rexViewstate.stringMatched(1);
-
-			rexViewstate1.search(start);
-			if (!rexViewstate1.didMatch()) {
-				pref.log("[login]:Viewstate1 not found");
-			}
-			viewstate1 = rexViewstate1.stringMatched(1);
-
-			rexCookieID.search(start);
-			if (!rexCookieID.didMatch()) {
-				pref.log("[login]:CookieID not found. Using old one.");
-			} else
-				cookieID = rexCookieID.stringMatched(1);
-			//Vm.debug(cookieID);
-			rexCookieSession.search(start);
-			if (!rexCookieSession.didMatch()) {
-				pref.log("[login]:CookieSession not found. Using old one.");
-				//cookieSession="";
-			} else
-				cookieSession = rexCookieSession.stringMatched(1);
-			//Vm.debug("cookieSession = " + cookieSession);
-		}
-		boolean loginAborted=localInfB.isClosed;
-		localInfB.close(0);
-		if (loginAborted)
-			return FormBase.IDCANCEL;
-		else {
-			loggedIn = true;
-			return FormBase.IDOK;
-		}
-	}
-
-	/**
-	 * Method to spider a single cache.
-	 * It assumes a login has already been performed!
-	 * @return 1 if spider was successful, -1 if spider was cancelled by closing the infobox, 0 error, but continue with next cache
-	 */
-	public int spiderSingle(int number, InfoBox pInfB, boolean forceLogin){
-		int ret=-1;
-		this.infB = pInfB;
-		CacheHolder ch = new CacheHolder(); // cacheDB.get(number);
-		ch.setWayPoint(cacheDB.get(number).getWayPoint());
-		if (ch.isAddiWpt()) return -1;  // No point re-spidering an addi waypoint, comes with parent
-
-		// check if we need to login
-		if (!loggedIn || forceLogin){
-			if (this.login()!=FormBase.IDOK) return -1;
-			// loggedIn is already set by this.login()
-		}
-		try{
-			// Read the cache data from GC.COM and compare to old data
-			boolean loadAllLogs = (MAXLOGS > 5);
-			ret=getCacheByWaypointName(ch,true,pref.downloadPics,pref.downloadTBs,false,loadAllLogs);
-			// Save the spidered data
-			if (ret == 1) {
-				CacheHolder cacheInDB = cacheDB.get(number);
-				cacheInDB.initStates(false);
-				if (cacheInDB.is_found() && !ch.is_found() && ! loadAllLogs) {
-					// If the number of logs to spider is 5 or less, then the "not found" information
-					// of the spidered cache is not credible. In this case it should not overwrite
-					// the "found" state of an existing cache.
-					ch.setFound(true);
-				}
-				cacheInDB.update(ch);
-				cacheInDB.save();
-			}
-		}catch(Exception ex){
-			pref.log("Error spidering " + ch.getWayPoint() + " in spiderSingle");
-		}
-		return ret;
-	} // spiderSingle
-
-	/**
-	 * Fetch the coordinates of a waypoint from GC
-	 * @param wayPoint the name of the waypoint
-	 * @return the cache coordinates
-	 */
-	public String getCacheCoordinates(String wayPoint) {
-		String completeWebPage;
-		// Check whether spider definitions could be loaded, if not issue appropriate message and terminate
-		// Try to login. If login fails, issue appropriate message and terminate
-		if (!loggedIn || Global.getPref().forceLogin) {
-			if (login()!=FormBase.IDOK) {
-				return "";
-			}
-		}
-		InfoBox localInfB = new InfoBox("Info", "Loading", InfoBox.PROGRESS_WITH_WARNINGS);
-		localInfB.exec();
-		try{
-			String doc = p.getProp("waypoint") + wayPoint;
-			pref.log("Fetching: " + wayPoint);
-			completeWebPage = fetch(doc);
-		}catch(Exception ex){
-			localInfB.close(0);
-			pref.log("Could not fetch " + wayPoint,ex);
-			return "";
-		}
-		localInfB.close(0);
-		try {
-			return getLatLon(completeWebPage);
-		} catch (Exception ex) {
-			return "????";
-		}
-	}
-
-	/**
-	*	Method to start the spider for a search around the centre coordinates
-	*/
-	public void doIt(){
-		doIt(false);
-	}
-	public void doIt(boolean spiderAllFinds){
-		String postStr, dummy, ln, wpt;
-		Regex lineRex;
-		CacheHolder holder;
-		CWPoint origin = pref.curCentrePt; // No need to copy curCentrePt as it is only read and not written
-		if ( !spiderAllFinds && !origin.isValid()) {
-			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5509,"Coordinates for centre must be set"), FormBase.OKB)).execute();
-			return;
-		}
-		if (System.getProperty("os.name")!=null)pref.log("Operating system: "+System.getProperty("os.name")+"/"+System.getProperty("os.arch"));
-		if (System.getProperty("java.vendor")!=null)pref.log("Java: "+System.getProperty("java.vendor")+"/"+System.getProperty("java.version"));
-		CacheHolder ch;
-		// Reset states for all caches when spidering (http://tinyurl.com/dzjh7p)
-		for(int i = 0; i<cacheDB.size();i++){
-			ch = cacheDB.get(i);
-			if (ch.mainCache==null) ch.initStates(false);
-		}
-		String start = "";
-		Regex rexViewstate = new Regex("id=\"__VIEWSTATE\" value=\"(.*)\" />");
-		Regex rexViewstate1 = new Regex("id=\"__VIEWSTATE1\" value=\"(.*)\" />");
-		Regex rexEventvalidation = new Regex("id=\"__EVENTVALIDATION\" value=\"(.*)\" />");
-		String doc = "";
-
-		if (!loggedIn || Global.getPref().forceLogin) {
-			if(login() != FormBase.IDOK) return;
-		}
-
-		boolean doNotgetFound = false;
-
-		OCXMLImporterScreen options;
-		if (spiderAllFinds) {
-			options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"), OCXMLImporterScreen.MAXNUMBER|OCXMLImporterScreen.IMAGES| OCXMLImporterScreen.ISGC| OCXMLImporterScreen.TRAVELBUGS| OCXMLImporterScreen.MAXLOGS| OCXMLImporterScreen.TYPE);
-			if (options.execute() == FormBase.IDCANCEL) {return; }
-
-			distance = 1;
-		} else {
-			options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"),	OCXMLImporterScreen.MAXNUMBER|OCXMLImporterScreen.INCLUDEFOUND | OCXMLImporterScreen.DIST| OCXMLImporterScreen.IMAGES| OCXMLImporterScreen.ISGC| OCXMLImporterScreen.TRAVELBUGS| OCXMLImporterScreen.MAXLOGS| OCXMLImporterScreen.TYPE);
-			if (options.execute() == FormBase.IDCANCEL) {return; }
-			String dist = options.distanceInput.getText();
-			if (dist.length()== 0) return;
-			distance = Common.parseDouble(dist);
-
-			//save last radius to profile
-			Double distDouble = new Double();
-			distDouble.value = distance;
-			dist = distDouble.toString(0, 1, 0).replace(',', '.');
-			profile.setDistGC(dist);
-
-			doNotgetFound = options.foundCheckBox.getState();
-		}
-
-		int maxNumber = -1;
-		String maxNumberString = options.maxNumberInput.getText();
-		if (maxNumberString.length()!= 0) {
-			maxNumber = Common.parseInt(maxNumberString);
-		}
-		if (maxNumber != pref.maxSpiderNumber) {
-			pref.maxSpiderNumber = maxNumber;
-			pref.savePreferences();
-		}
-		if (maxNumber == 0) return;
-		boolean maxNumberAbort = false;
-
-		boolean getImages = options.imagesCheckBox.getState();
-		boolean getTBs = options.travelbugsCheckBox.getState();
-
-		String cacheTypeRestriction = options.getCacheTypeRestriction(p);
-
-		options.close(0);
-
-		//max distance in miles for URL, so we can get more than 80km
-		double saveDistanceInMiles = distance;
-		if ( Global.getPref().metricSystem != Metrics.IMPERIAL ) {
-			saveDistanceInMiles = Metrics.convertUnit(distance, Metrics.KILOMETER, Metrics.MILES);
-		}
-		// add a mile to be save from different distance calculations in CW and at GC
-		saveDistanceInMiles = java.lang.Math.ceil(saveDistanceInMiles) + 1;
-
-		Hashtable cachesToUpdate = new Hashtable(cacheDB.size());
-		double distanceInKm = distance;
-		if ( Global.getPref().metricSystem == Metrics.IMPERIAL ) {
-			distanceInKm = Metrics.convertUnit(distance, Metrics.MILES, Metrics.KILOMETER);
-		}
-		for(int i = 0; i<cacheDB.size();i++){
-			ch = cacheDB.get(i);
-			if (spiderAllFinds) {
-				if ( (ch.getWayPoint().substring(0,2).equalsIgnoreCase("GC")) ) {
-					cachesToUpdate.put(ch.getWayPoint(), ch);
-				}
-			} else {
-				if ( (!ch.is_archived()) && (ch.kilom <= distanceInKm) && !(doNotgetFound && ch.is_found()) && (ch.getWayPoint().substring(0,2).equalsIgnoreCase("GC")) ) {
-					cachesToUpdate.put(ch.getWayPoint(), ch);
-				}
-			}
-		}
-
-		//=======
-		// Prepare list of all caches that are to be spidered
-		//=======
-		Vm.showWait(true);
-		infB = new InfoBox("Status", MyLocale.getMsg(5502,"Fetching first page..."));
-		infB.exec();
-		//Get first page
-		try{
-			if (spiderAllFinds) {
-				ln = p.getProp("firstPageFinds") + encodeUTF8URL(Utils.encodeJavaUtf8String(pref.myAlias));
-			} else {
-				ln = p.getProp("firstPage") + origin.getLatDeg(CWPoint.DD) + p.getProp("firstPage2") + origin.getLonDeg(CWPoint.DD)
-			                              + p.getProp("maxDistance") + Integer.toString( (int)saveDistanceInMiles );
-				if(doNotgetFound) ln = ln + p.getProp("showOnlyFound");
-			}
-			ln = ln + cacheTypeRestriction;
-			pref.log("Getting first page: "+ln);
-			start = fetch(ln);
-			pref.log("Got first page");
-		}catch(Exception ex){
-			pref.log("Error fetching first list page",ex,true);
-			Vm.showWait(false);
-			infB.close(0);
-			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5503,"Error fetching first list page."), FormBase.OKB)).execute();
-			return;
-		}
-		dummy = "";
-		//String lineBlck = "";
-		int page_number = 4;
-		try  {
-			lineRex = new Regex(p.getProp("lineRex")); //"<tr bgcolor=((?s).*?)</tr>"
-		} catch (Exception ex) {
-			infB.close(0);
-			Vm.showWait(false);
-			return;
-		}
-		int page = 0;
-		int found_on_page = 0;
-		try {
-			//Loop till maximum distance has been found or no more caches are in the list
-			while(distance > 0){
-				if (infB.isClosed) break;
-
-				rexViewstate.search(start);
-				if(rexViewstate.didMatch()){
-					viewstate = rexViewstate.stringMatched(1);
-					//Vm.debug("ViewState: " + viewstate);
-				} else {
-					viewstate = "";
-					pref.log("Viewstate not found");
-				}
-
-				rexViewstate1.search(start);
-				if(rexViewstate1.didMatch()){
-					viewstate1 = rexViewstate1.stringMatched(1);
-					//Vm.debug("ViewState: " + viewstate);
-				} else {
-					viewstate1 = "";
-					pref.log("Viewstate1 not found");
-				}
-
-				rexEventvalidation.search(start);
-				if(rexEventvalidation.didMatch()){
-					eventvalidation = rexEventvalidation.stringMatched(1);
-					//Vm.debug("EVENTVALIDATION: " + eventvalidation);
-				} else {
-					eventvalidation = "";
-					pref.log("Eventvalidation not found");
-				}
-
-				//Vm.debug("In loop");
-				Regex listBlockRex = new Regex(p.getProp("listBlockRex")); // "<table id=\"dlResults\"((?s).*?)</table>"
-				listBlockRex.search(start);
-				dummy = listBlockRex.stringMatched(1);
-				try{
-					lineRex.search(dummy);
-				}catch(NullPointerException nex){
-					Global.getPref().log("Ignored Exception", nex, true);
-				}
-				while(lineRex.didMatch()){
-					//Vm.debug(getDist(lineRex.stringMatched(1)) + " / " +getWP(lineRex.stringMatched(1)));
-					found_on_page++;
-					if(getDist(lineRex.stringMatched(1)) <= distance){
-						String waypoint=getWP(lineRex.stringMatched(1));
-						CacheHolder existingCache;
-						if((existingCache=cacheDB.get(waypoint)) == null){
-							if ( (maxNumber > 0) && (cachesToLoad.size() >= maxNumber) ) {
-								maxNumberAbort = true;
-
-								//add no more caches
-								distance = 0;
-
-								//don't update existing caches, because list is not correct when aborting
-								cachesToUpdate.clear();
-							} else {
-								cachesToLoad.add(waypoint);
-							}
-						} else {
-							pref.log(waypoint+" already in DB");
-							ch=existingCache;
-							// If the <strike> tag is used, the cache is marked as unavailable or archived
-							boolean is_archived_GC=lineRex.stringMatched(1).indexOf("<strike><font color=\"red\">")!=-1;
-							boolean is_available_GC=lineRex.stringMatched(1).indexOf("<strike>")==-1;
-							if (ch.is_archived()!=is_archived_GC) { // Update the database with the cache status
-								pref.log("Updating status of "+waypoint+" to "+(is_archived_GC?"archived":"not archived"));
-								if ( ch.is_archived() ) {
-									cachesToUpdate.put(ch.getWayPoint(), ch);
-								}
-								ch.setArchived(is_archived_GC);
-							} else if (ch.is_available()!=is_available_GC) { // Update the database with the cache status
-								pref.log("Updating status of "+waypoint+" to "+(is_available_GC?"available":"not available"));
-								ch.setAvailable(is_available_GC);
-							} else if (spiderAllFinds && !ch.is_found()) { // Update the database with the cache status
-								pref.log("Updating status of "+waypoint+" to found");
-								ch.setFound(true);
-							} else {
-								cachesToUpdate.remove( ch.getWayPoint() );
-							}
-						}
-					} else distance = 0;
-					lineRex.searchFrom(dummy, lineRex.matchedTo());
-				}
-
-				page++;
-				infB.setInfo(MyLocale.getMsg(5521,"Page ") + page + "\n" + MyLocale.getMsg(5511,"Found ") + cachesToLoad.size() + MyLocale.getMsg(5512," caches"));
-
-				if(found_on_page < 20) distance = 0;
-				if (spiderAllFinds) {
-					postStr = p.getProp("firstLine");
-				} else {
-					postStr = p.getProp("firstLine") + origin.getLatDeg(CWPoint.DD) + "&" + origin.getLonDeg(CWPoint.DD)
-							                             + p.getProp("maxDistance") + Integer.toString( (int)saveDistanceInMiles );
-					if(doNotgetFound) postStr = postStr + p.getProp("showOnlyFound");
-				}
-				postStr = postStr + cacheTypeRestriction;
-				if(distance > 0){
-					page_number++;
-					if(page_number >= 15) page_number = 5;
-					String strNextPage;
-					if (page_number < 10) {
-						strNextPage = "ctl00$ContentBody$pgrTop$ctl0" + page_number;
-					} else {
-						strNextPage = "ctl00$ContentBody$pgrTop$ctl" + page_number;
-					}
-					doc = URL.encodeURL("__EVENTTARGET",false) +"="+ URL.encodeURL(strNextPage,false)
-					    + "&" + URL.encodeURL("__EVENTARGUMENT",false) +"="+ URL.encodeURL("",false)
-					    + "&" + URL.encodeURL("__VIEWSTATEFIELDCOUNT",false) +"=2"
-					    + "&" + URL.encodeURL("__VIEWSTATE",false) +"="+ URL.encodeURL(viewstate,false)
-					    + "&" + URL.encodeURL("__VIEWSTATE1",false) +"="+ URL.encodeURL(viewstate1,false);
-//					    + "&" + URL.encodeURL("__EVENTVALIDATION",false) +"="+ URL.encodeURL(eventvalidation,false);
-					try{
-						start = "";
-						pref.log("Fetching next list page:" + doc);
-						start = fetch_post(postStr, doc, p.getProp("nextListPage"));
-					}catch(Exception ex){
-						//Vm.debug("Couldn't get the next page");
-						pref.log("Error getting next page");
-					}
-				}
-				//Vm.debug("Distance is now: " + distance);
-				found_on_page = 0;
-			}
-		} catch (Exception ex) { // Some tag missing from spider.def
-			infB.close(0);
-			Vm.showWait(false);
-			return;
-		}
-		pref.log("Found " + cachesToLoad.size() + " new caches");
-		pref.log("Found " + cachesToUpdate.size() + " caches for update");
-		if (!infB.isClosed) infB.setInfo(MyLocale.getMsg(5511,"Found ") + cachesToLoad.size() + MyLocale.getMsg(5512," caches"));
-
-		//=======
-		// Now ready to spider each cache in the list
-		//=======
-		boolean loadAllLogs = (MAXLOGS > 5);
-
-		int spiderErrors = 0;
-
-		if ( cachesToUpdate.size() > 0 ) {
-			switch (pref.spiderUpdates) {
-			case Preferences.NO:
-				cachesToUpdate.clear();
-				break;
-			case Preferences.ASK:
-				MessageBox mBox = new MessageBox(MyLocale.getMsg(5517,"Spider Updates?"), cachesToUpdate.size() + MyLocale.getMsg(5518," caches in database need an update. Update now?") , FormBase.IDYES |FormBase.IDNO);
-				if (mBox.execute() != FormBase.IDOK){
-					cachesToUpdate.clear();
-				}
-				break;
-			}
-		}
-
-		int totalCachesToLoad = cachesToLoad.size() + cachesToUpdate.size();
-
-		for(int i = 0; i<cachesToLoad.size(); i++){
-			if (infB.isClosed) break;
-
-			wpt = (String)cachesToLoad.get(i);
-			// Get only caches not already available in the DB
-			if(cacheDB.getIndex(wpt) == -1){
-				infB.setInfo(MyLocale.getMsg(5513,"Loading: ") + wpt +" (" + (i+1) + " / " + totalCachesToLoad + ")");
-				holder = new CacheHolder();
-				holder.setWayPoint(wpt);
-				int test = getCacheByWaypointName(holder,false,getImages,getTBs,doNotgetFound,loadAllLogs);
-				if (test == -1) {
-					infB.close(0);
-					break;
-				} else if (test == 0) {
-					spiderErrors++;
-				} else {
-					if (!holder.is_found() || !doNotgetFound ) {
-						cacheDB.add(holder);
-						holder.save();
-					}
-				}
-			}
-		}
-
-		if (!infB.isClosed) {
-			int j = 1;
-			for (Enumeration e = cachesToUpdate.elements() ; e.hasMoreElements() ; j++) {
-				ch = (CacheHolder)e.nextElement();
-				infB.setInfo(MyLocale.getMsg(5513,"Loading: ") + ch.getWayPoint() +" (" + (cachesToLoad.size()+j) + " / " + totalCachesToLoad + ")");
-				infB.redisplay();
-
-				int test = spiderSingle(cacheDB.getIndex(ch), infB,false);
-				if (test == -1) {
-					break;
-				} else if (test == 0) {
-					spiderErrors++;
-				} else {
-					//profile.hasUnsavedChanges=true;
-				}
-			}
-		}
-
-		infB.close(0);
-		Vm.showWait(false);
-		if ( spiderErrors > 0) {
-			new MessageBox(MyLocale.getMsg(5500,"Error"),spiderErrors + MyLocale.getMsg(5516," cache descriptions%0acould not be loaded."),FormBase.DEFOKB).execute();
-		}
-		if ( maxNumberAbort ) {
-			new MessageBox(MyLocale.getMsg(5519,"Information"),MyLocale.getMsg(5520,"Only the given maximum of caches were loaded.%0aRepeat spidering later to load more caches.%0aNo already existing caches were updated."),FormBase.DEFOKB).execute();
-		}
-		Global.getProfile().restoreFilter();
-		Global.getProfile().saveIndex(Global.getPref(),true);
-	}
-
-	/**
-	 * Read a complete cachepage from geocaching.com including all logs. This is used both when
-	 * updating already existing caches (via spiderSingle) and when spidering around a centre. It
-	 * is also used when reading a GPX file and fetching the images.
-	 *
-	 * This is the workhorse function of the spider.
-	 *
-	 * @param CacheHolderDetail chD The element wayPoint must be set to the name of a waypoint
-	 * @param boolean isUpdate True if an existing cache is being updated, false if it is a new cache
-	 * @param boolean fetchImages True if the pictures are to be fetched
-	 * @param boolean fetchTBs True if the TBs are to be fetched
-	 * @param boolean doNotGetFound True if the cache is not to be spidered if it has already been found
-	 * @param boolean fetchAllLogs True if all logs are to be fetched (by adding option '&logs=y' to command line).
-	 *     This is normally false when spidering from GPXImport as the logs are part of the GPX file, and true otherwise
-	 * @return -1 if the infoBox was closed (cancel spidering), 0 if there was an error (continue with next cache), 1 if everything ok
-	 */
-	private int getCacheByWaypointName(CacheHolder ch, boolean isUpdate, boolean fetchImages, boolean fetchTBs, boolean doNotGetFound, boolean fetchAllLogs) {
-		int ret = 1;
-		while (true) {
-			String completeWebPage;
-			int spiderTrys=0;
-			int MAX_SPIDER_TRYS=3;
-			while (spiderTrys++<MAX_SPIDER_TRYS) {
-				ret = 1;
-				try{
-					String doc = p.getProp("getPageByName") + ch.getWayPoint() +(fetchAllLogs?p.getProp("fetchAllLogs"):"");
-					pref.log("Fetching: " + ch.getWayPoint());
-					completeWebPage = fetch(doc);
-					if	( completeWebPage.equals("")) {
-						pref.log("Could not fetch " + ch.getWayPoint());
-						if (!infB.isClosed) {
-							continue;
-						} else {
-							ch.setIncomplete(true);
-							return -1;
-						}
-					}
-				}catch(Exception ex){
-					pref.log("Could not fetch " + ch.getWayPoint(),ex);
-					if (!infB.isClosed) {
-						continue;
-					} else {
-						ch.setIncomplete(true);
-						return -1;
-					}
-				}
-				// Only analyse the cache data and fetch pictures if user has not closed the progress window
-				if (!infB.isClosed) {
-					try{
-						ch.initStates(!isUpdate);
-
-						//first check if coordinates are available to prevent deleting existing coorinates
-						String latLon = getLatLon(completeWebPage);
-						if (latLon.equals("???")) {
-							pref.log(">>>> Failed to spider Cache. Retry.");
-							ret = 0;
-							continue; // Restart the spider
-						}
-
-						ch.setHTML(true);
-						ch.setAvailable(true);
-						ch.setArchived(false);
-						ch.setIncomplete(true);
-						// Save size of logs to be able to check whether any new logs were added
-						//int logsz = chD.CacheLogs.size();
-						//chD.CacheLogs.clear();
-						ch.addiWpts.clear();
-						ch.getFreshDetails().Images.clear();
-						ch.getFreshDetails().ImagesText.clear();
-						ch.getFreshDetails().ImagesInfo.clear();
-
-						if(completeWebPage.indexOf(p.getProp("cacheUnavailable")) >= 0) ch.setAvailable(false);
-						if(completeWebPage.indexOf(p.getProp("cacheArchived")) >= 0) ch.setArchived(true);
-						//==========
-						// General Cache Data
-						//==========
-						ch.setLatLon(latLon);
-						pref.log("LatLon: " + ch.LatLon);
-						if (pref.debug) pref.log("chD.pos: " + ch.pos.toString());
-
-						pref.log("Trying description");
-						ch.getFreshDetails().setLongDescription(getLongDesc(completeWebPage));
-						pref.log("Got description");
-
-						pref.log("Getting cache name");
-						ch.setCacheName(SafeXML.cleanback(getName(completeWebPage)));
-						if (pref.debug) pref.log("Name: " + ch.getCacheName()); else pref.log("Got name");
-
-						pref.log("Trying location (country/state)");
-						String location = getLocation(completeWebPage);
-						if (location.length() != 0) {
-							int countryStart = location.indexOf(",");
-							if (countryStart > -1) {
-								ch.getFreshDetails().Country = SafeXML.cleanback(location.substring(countryStart + 1).trim());
-								ch.getFreshDetails().State = SafeXML.cleanback(location.substring(0, countryStart).trim());
-							} else {
-								ch.getFreshDetails().Country = location.trim();
-								ch.getFreshDetails().State = "";
-							}
-							pref.log("Got location (country/state)");
-						} else {
-							ch.getFreshDetails().Country = "";
-							ch.getFreshDetails().State = "";
-							pref.log("No location (country/state) found");
-						}
-
-						pref.log("Trying owner");
-						ch.setCacheOwner(SafeXML.cleanback(getOwner(completeWebPage)).trim());
-						if(ch.getCacheOwner().equals(pref.myAlias) || (pref.myAlias2.length()>0 && ch.getCacheOwner().equals(pref.myAlias2))) ch.setOwned(true);
-						if (pref.debug) pref.log("Owner: " + ch.getCacheOwner() +"; is_owned = "+ch.is_owned()+";  alias1,2 = ["+pref.myAlias+"|"+pref.myAlias2+"]");
-						else pref.log("Got owner");
-
-
-						pref.log("Trying date hidden");
-						ch.setDateHidden(DateFormat.MDY2YMD(getDateHidden(completeWebPage)));
-						if (pref.debug) pref.log("Hidden: " + ch.getDateHidden());
-						else pref.log("Got date hidden");
-
-						pref.log("Trying hints");
-						ch.getFreshDetails().setHints(getHints(completeWebPage));
-						if (pref.debug) pref.log("Hints: " + ch.getFreshDetails().Hints);
-						else pref.log("Got hints");
-
-						pref.log("Trying size");
-						ch.setCacheSize(CacheSize.gcSpiderString2Cw(getSize(completeWebPage)));
-						if (pref.debug) pref.log("Size: " + ch.getCacheSize());
-						else pref.log("Got size");
-
-						pref.log("Trying difficulty");
-						ch.setHard(CacheTerrDiff.v1Converter(getDiff(completeWebPage)));
-						if (pref.debug) pref.log("Hard: " + ch.getHard());
-						else pref.log("Got difficulty");
-
-						pref.log("Trying terrain");
-						ch.setTerrain(CacheTerrDiff.v1Converter(getTerr(completeWebPage)));
-						if (pref.debug) pref.log("Terr: " + ch.getTerrain());
-						else pref.log("Got terrain");
-
-						pref.log("Trying cache type");
-						ch.setType(getType(completeWebPage));
-						if (pref.debug) pref.log("Type: " + ch.getType());
-						else pref.log("Got cache type");
-
-						//==========
-						// Logs
-						//==========
-						pref.log("Trying logs");
-						ch.getFreshDetails().setCacheLogs(getLogs(completeWebPage, ch.getFreshDetails()));
-						pref.log("Found logs");
-
-						// If the switch is set to not store found caches and we found the cache => return
-						if (ch.is_found() && doNotGetFound) {
-							if (infB.isClosed) {
-								return -1;
-							} else {
-								return 1;
-							}
-						}
-
-						//==========
-						// Bugs
-						//==========
-						// As there may be several bugs, we check whether the user has aborted
-						if (!infB.isClosed && fetchTBs) getBugs(ch.getFreshDetails(),completeWebPage);
-						ch.setHas_bugs(ch.getFreshDetails().Travelbugs.size()>0);
-
-						//==========
-						// Images
-						//==========
-						if(fetchImages){
-							pref.log("Trying images");
-							getImages(completeWebPage, ch.getFreshDetails());
-							pref.log("Got images");
-						}
-						//==========
-						// Addi waypoints
-						//==========
-
-						pref.log("Getting additional waypoints");
-						getAddWaypoints(completeWebPage, ch.getWayPoint(), ch.is_found());
-						pref.log("Got additional waypoints");
-
-						//==========
-						// Attributes
-						//==========
-						pref.log("Getting attributes");
-						getAttributes(completeWebPage, ch.getFreshDetails());
-						pref.log("Got attributes");
-						//if (ch.is_new()) ch.setUpdated(false);
-						//==========
-						// Last sync date
-						//==========
-						ch.setLastSync((new Time()).format("yyyyMMddHHmmss"));
-
-						ch.setIncomplete(false);
-						break;
-					}catch(Exception ex){
-						pref.log("Error reading cache: "+ch.getWayPoint());
-						pref.log("Exception in getCacheByWaypointName: ",ex);
-					}
-				} else {
-					break;
-				}
-			} // spiderTrys
-			if ( ( spiderTrys >= MAX_SPIDER_TRYS ) && ( ret == 1 ) ) {
-				pref.log(">>> Failed to spider cache. Number of retrys exhausted.");
-				int decision = (new MessageBox(MyLocale.getMsg(5500,"Error"),MyLocale.getMsg(5515,"Failed to load cache.%0aPleas check your internet connection.%0aRetry?"),FormBase.DEFOKB|FormBase.NOB|FormBase.CANCELB)).execute();
-				if ( decision == FormBase.IDOK ) {
-					continue;
-				} else if ( decision == FormBase.IDNO ){
-					ret = 0;
-				} else {
-					ret = -1;
-				}
-			}
-			break;
-		}//while(true)
-		if (infB.isClosed) {// If the infoBox was closed before getting here, we return -1
-			return -1;
-		}
-		return ret;
-	} // getCacheByWaypointName
-
-
-	/**
-	 * Get the Distance to the centre
-	 * @param doc A previously fetched cachepage
-	 * @return Distance
-	 */
-	private double getDist(String doc) throws Exception {
-		inRex = new Regex(p.getProp("distRex"));
-		inRex.search(doc);
-		if(doc.indexOf("Here") >= 0) return(0);
-		if (!inRex.didMatch()) return 0;
-		if(MyLocale.getDigSeparator().equals(",")) return Convert.toDouble(inRex.stringMatched(1).replace('.',','));
-		return Convert.toDouble(inRex.stringMatched(1));
-	}
-
-	/**
-	 * Get the waypoint name
-	 * @param doc A previously fetched cachepage
-	 * @return Name of waypoint to add to list
-	 */
-	private String getWP(String doc) throws Exception {
-		inRex = new Regex(p.getProp("waypointRex"));
-		inRex.search(doc);
-		if (!inRex.didMatch()) return "???";
-		return "GC"+inRex.stringMatched(1);
-	}
-
-	/**
-	 * Get the coordinates of the cache
-	 * @param doc A previously fetched cachepage
-	 * @return Cache coordinates
-	 */
-	private String getLatLon(String doc) throws Exception{
-		inRex = new Regex(p.getProp("latLonRex"));
-		inRex.search(doc);
-		if (!inRex.didMatch()) return "???";
-		return inRex.stringMatched(1);
-	}
-
-	/**
-	 * Get the long description
-	 * @param doc A previously fetched cachepage
-	 * @return the long description
-	 */
-	private String getLongDesc(String doc) throws Exception{
-		String res = "";
-		inRex = new Regex(p.getProp("shortDescRex"));
-		Regex rex2 = new Regex(p.getProp("longDescRex"));
-		inRex.search(doc);
-		rex2.search(doc);
-		res = ((inRex.stringMatched(1)==null)?"":inRex.stringMatched(1)) + "<br>";
-		res += rex2.stringMatched(1);
-		return res; // SafeXML.cleanback(res);
-	}
-
-	/**
-	 * Get the cache location (country and state)
-	 * @param doc A previously fetched cachepage
-	 * @return the location (country and state) of the cache
-	 */
-	private String getLocation(String doc) throws Exception{
-		inRex = new Regex(p.getProp("cacheLocationRex"));
-		inRex.search(doc);
-		if (!inRex.didMatch()) return "";
-
-		return inRex.stringMatched(1);
-	}
-
-	/**
-	 * Get the cache name
-	 * @param doc A previously fetched cachepage
-	 * @return the name of the cache
-	 */
-	private String getName(String doc) throws Exception{
-		inRex = new Regex(p.getProp("cacheNameRex"));
-		inRex.search(doc);
-		if (!inRex.didMatch()) return "???";
-		return inRex.stringMatched(1);
-	}
-
-	/**
-	 * Get the cache owner
-	 * @param doc A previously fetched cachepage
-	 * @return the cache owner
-	 */
-	private String getOwner(String doc) throws Exception{
-		inRex = new Regex(p.getProp("cacheOwnerRex"));
-		inRex.search(doc);
-		if (!inRex.didMatch()) return "???";
-		return inRex.stringMatched(1);
-	}
-
-	/**
-	 * Get the date when the cache was hidden
-	 * @param doc A previously fetched cachepage
-	 * @return Hidden date
-	 */
-	private String getDateHidden(String doc) throws Exception{
-		inRex = new Regex(p.getProp("dateHiddenRex"));
-		inRex.search(doc);
-		if (!inRex.didMatch()) return "???";
-		return inRex.stringMatched(1);
-	}
-
-	/**
-	 * Get the hints
-	 * @param doc A previously fetched cachepage
-	 * @return Cachehints
-	 */
-	private String getHints(String doc) throws Exception{
-		inRex = new Regex(p.getProp("hintsRex"));
-		inRex.search(doc);
-		if (!inRex.didMatch()) return "";
-		return inRex.stringMatched(1);
-	}
-
-	/**
-	 * Get the cache size
-	 * @param doc A previously fetched cachepage
-	 * @return Cache size
-	 */
-	private String getSize(String doc) throws Exception{
-		inRex = new Regex(p.getProp("sizeRex"));
-		inRex.search(doc);
-		if(inRex.didMatch()) return inRex.stringMatched(1);
-		else return "None";
-	}
-
-	/**
-	 * Get the Difficulty
-	 * @param doc A previously fetched cachepage
-	 * @return The cache difficulty
-	 */
-	private String getDiff(String doc) throws Exception{
-		inRex = new Regex(p.getProp("difficultyRex"));
-		inRex.search(doc);
-		if(inRex.didMatch()) return inRex.stringMatched(1);
-		else return "";
-	}
-
-	/**
-	 * Get the terrain rating
-	 * @param doc A previously fetched cachepage
-	 * @return Terrain rating
-	 */
-	private String getTerr(String doc) throws Exception{
-		inRex = new Regex(p.getProp("terrainRex"));
-		inRex.search(doc);
-		if(inRex.didMatch()) return inRex.stringMatched(1);
-		else return "";
-	}
-
-	/**
-	 * Get the waypoint type
-	 * @param doc A previously fetched cachepage
-	 * @return the waypoint type (Tradi, Multi, etc.)
-	 */
-	private byte getType(String doc) throws Exception {
-		inRex = new Regex(p.getProp("cacheTypeRex"));
-		inRex.search(doc);
-		if(inRex.didMatch()) return CacheType.gcSpider2CwType(inRex.stringMatched(1));
-		else return 0;
-	}
-
-	/**
-	 * Get the logs
-	 * @param doc A previously fetched cachepage
-	 * @param chD Cache Details
-	 * @return A HTML string containing the logs
-	 */
-	private LogList getLogs(String doc, CacheHolderDetail chD) throws Exception {
-		String icon = "";
-		String name = "";
-		String logText = "";
-		String logId = "";
-		LogList reslts = new LogList();
-		Regex blockRex = new Regex(p.getProp("blockRex"));
-		blockRex.search(doc);
-		doc = blockRex.stringMatched(1);
-		String singleLog = "";
-		Extractor exSingleLog = new Extractor(doc,p.getProp("singleLogExStart"), p.getProp("singleLogExEnd"), 0, false); // maybe here is some change neccessary because findnext now gives the whole endstring back???
-		singleLog = exSingleLog.findNext();
-		Extractor exIcon = new Extractor(singleLog,p.getProp("iconExStart"), p.getProp("iconExEnd"), 0, true);
-		Extractor exNameTemp = new Extractor(singleLog,p.getProp("nameTempExStart"), p.getProp("nameTempExEnd"), 0 , true);
-		String nameTemp = "";
-		nameTemp = exNameTemp.findNext();
-		Extractor exName = new Extractor(nameTemp, p.getProp("nameExStart"), p.getProp("nameExEnd"), 0 , true);
-		Extractor exDate = new Extractor(singleLog,p.getProp("dateExStart"), p.getProp("dateExEnd"), 0 , true);
-		Extractor exLog = new Extractor(singleLog, p.getProp("logExStart"), p.getProp("logExEnd"), 0, true);
-		Extractor exLogId = new Extractor(singleLog, p.getProp("logIdExStart"), p.getProp("logIdExEnd"), 0, true);
-		//Vm.debug("Log Block: " + singleLog);
-		int nLogs=0;
-		while(exSingleLog.endOfSearch() == false){
-			nLogs++;
-			//Vm.debug("--------------------------------------------");
-			//Vm.debug("Log Block: " + singleLog);
-			//Vm.debug("Icon: "+exIcon.findNext());
-			//Vm.debug(exName.findNext());
-			//Vm.debug(exDate.findNext());
-			//Vm.debug(exLog.findNext());
-			//Vm.debug("--------------------------------------------");
-			icon = exIcon.findNext();
-			name = exName.findNext();
-			logText = exLog.findNext();
-			logId = exLogId.findNext();
-			String d=DateFormat.logdate2YMD(exDate.findNext());
-			if((icon.equals(p.getProp("icon_smile")) || icon.equals(p.getProp("icon_camera")) || icon.equals(p.getProp("icon_attended"))) &&
-				(name.equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()>0 && name.equalsIgnoreCase(pref.myAlias2))) )  {
-				chD.getParent().setFound(true);
-				chD.getParent().setCacheStatus(d);
-				chD.OwnLogId = logId;
-				chD.OwnLog = new Log(icon,d,name,logText);
-			}
-			if (nLogs<=MAXLOGS) reslts.add(new Log(icon,d,name,logText));
-
-			singleLog = exSingleLog.findNext();
-			exIcon.setSource(singleLog);
-			exNameTemp.setSource(singleLog);
-			nameTemp = exNameTemp.findNext();
-			exName.setSource(nameTemp);
-			exDate.setSource(singleLog);
-			exLog.setSource(singleLog);
-			exLogId.setSource(singleLog);
-			// We cannot simply stop if we have reached MAXLOGS just in case we are waiting for
-			// a log by our alias that happened earlier.
-			if (nLogs>=MAXLOGS && chD.getParent().is_found() && (chD.OwnLogId.length() != 0) && (chD.OwnLog != null) && !(chD.OwnLog.getDate().equals("1900-01-01"))) break;
-		}
-		if (nLogs>MAXLOGS) {
-			reslts.add(Log.maxLog());
-			pref.log("Too many logs. MAXLOGS reached ("+MAXLOGS+")");
-		} else
-			pref.log(nLogs+" logs found");
-		return reslts;
-	}
-
-	/**
-	 * Read the travelbug names from a previously fetched Cache page and then
-	 * read the travelbug purpose for each travelbug
-	 * @param doc The previously fetched cachepage
-	 * @return A HTML formatted string with bug names and there purpose
-	 */
-	public void getBugs(CacheHolderDetail chD, String doc) throws Exception{
-		Extractor exBlock = new Extractor(doc,p.getProp("blockExStart"),p.getProp("blockExEnd") ,0,Extractor.EXCLUDESTARTEND);
-		String bugBlock = exBlock.findNext();
-		//Vm.debug("Bugblock: "+bugBlock);
-		Extractor exBug = new Extractor(bugBlock,p.getProp("bugExStart"),p.getProp("bugExEnd"),0,Extractor.EXCLUDESTARTEND);
-		String link,bug,linkPlusBug,bugDetails;
-		String oldInfoBox=infB.getInfo();
-		chD.Travelbugs.clear();
-		while(exBug.endOfSearch() == false){
-			if (infB.isClosed) break; // Allow user to cancel by closing progress form
-			linkPlusBug= exBug.findNext();
-			int idx=linkPlusBug.indexOf("'>");
-			if (idx<0) break; // No link/bug pair found
-			link=linkPlusBug.substring(0,idx);
-			bug=linkPlusBug.substring(idx+2);
-			if(bug.length()>0) { // Found a bug, get its details
-				Travelbug tb=new Travelbug(bug);
-				try{
-					infB.setInfo(oldInfoBox+MyLocale.getMsg(5514,"\nGetting bug: ")+SafeXML.cleanback(bug));
-					pref.log("Fetching bug details: "+bug);
-					bugDetails = fetch(link);
-					Extractor exDetails = new Extractor(bugDetails,p.getProp("bugDetailsStart"),p.getProp("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
-					tb.setMission(exDetails.findNext());
-					Extractor exGuid = new Extractor(bugDetails,"details.aspx?guid=","\" id=\"aspnetForm",0,Extractor.EXCLUDESTARTEND); // TODO Replace with spider.def see also further down
-					tb.setGuid(exGuid.findNext());
-					chD.Travelbugs.add(tb);
-				}catch(Exception ex){
-					pref.log("Could not fetch bug details");
-				}
-			}
-			//Vm.debug("B: " + bug);
-			//Vm.debug("End? " + exBug.endOfSearch());
-		}
-		infB.setInfo(oldInfoBox);
-	}
-
-	/**
-	 * Get the images for a previously fetched cache page. Images are extracted
-	 * from two areas: The long description and the pictures section (including
-	 * the spoiler)
-	 * @param doc The previously fetched cachepage
-	 * @param chD The Cachedetails
-	 */
-	public void getImages(String doc, CacheHolderDetail chD){
-		int imgCounter = 0;
-		String imgName, oldImgName, imgType, imgUrl, imgComment;
-		Vector spideredUrls=new Vector(15);
-		Extractor exImgBlock,exImgComment;
-		int idxUrl; // Index of already spidered Url in list of spideredUrls
-		//========
-		//In the long description
-		//========
-		String longDesc = "";
-		try {
-			if (chD.getParent().getWayPoint().startsWith("TC")) longDesc = doc;
-			else
-				longDesc = getLongDesc(doc);
-			longDesc = STRreplace.replace(longDesc, "<img", "<IMG");
-			longDesc = STRreplace.replace(longDesc, "src=", "SRC=");
-			longDesc = STRreplace.replace(longDesc, "'", "\"");
-			exImgBlock = new Extractor(longDesc,p.getProp("imgBlockExStart"),p.getProp("imgBlockExEnd"), 0, false);
-		} catch (Exception ex) {//Missing property in spider.def
-			return;
-		}
-		//Vm.debug("In getImages: Have longDesc" + longDesc);
-		String tst;
-		tst = exImgBlock.findNext();
-		//Vm.debug("Test: \n" + tst);
-		Extractor exImgSrc = new Extractor(tst, "http://", "\"", 0, true);
-		while(exImgBlock.endOfSearch() == false){
-			imgUrl = exImgSrc.findNext();
-			//Vm.debug("Img Url: " +imgUrl);
-			if(imgUrl.length()>0){
-				imgUrl = "http://" + imgUrl;
-				try{
-					imgType = (imgUrl.substring(imgUrl.lastIndexOf(".")).toLowerCase()+"    ").substring(0,4).trim();
-					// imgType is now max 4 chars, starting with .
-					if(imgType.startsWith(".png") || imgType.startsWith(".jpg") || imgType.startsWith(".gif")){
-						// Check whether image was already spidered for this cache
-						idxUrl=spideredUrls.find(imgUrl);
-						imgName = chD.getParent().getWayPoint() + "_" + Convert.toString(imgCounter);
-						if (idxUrl<0) { // New image
-							pref.log("Loading image: " + imgUrl+" as "+imgName);
-							spiderImage(imgUrl, imgName+imgType);
-							chD.Images.add(imgName+imgType);
-							spideredUrls.add(imgUrl);
-						} else { // Image already spidered as wayPoint_'idxUrl'
-							pref.log("Already loaded image: " + imgUrl);
-							oldImgName = chD.getParent().getWayPoint() + "_" + Convert.toString(idxUrl);
-							chD.Images.add(oldImgName+imgType); // Store name of old image as image to load
-						}
-						chD.ImagesText.add(imgName); // Keep the image name
-						chD.ImagesInfo.add(null); // Need to stay in synch with ImagesText
-						imgCounter++;
-					}
-				} catch (IndexOutOfBoundsException e) {
-					//Vm.debug("IndexOutOfBoundsException not in image span"+e.toString()+"imgURL:"+imgUrl);
-					pref.log("Problem loading image. imgURL:"+imgUrl);
-				}
-				}
-			exImgSrc.setSource(exImgBlock.findNext());
-		}
-		//========
-		//In the image span
-		//========
-		Extractor spanBlock,exImgName;
-		try {
-			spanBlock = new Extractor(doc,p.getProp("imgSpanExStart"),p.getProp("imgSpanExEnd"), 0 , true);
-			tst = spanBlock.findNext();
-			exImgName = new Extractor(tst,p.getProp("imgNameExStart"),p.getProp("imgNameExEnd"), 0 , true);
-			exImgSrc = new Extractor(tst,p.getProp("imgSrcExStart"),p.getProp("imgSrcExEnd"), 0, true);
-			exImgComment = new Extractor(tst,p.getProp("imgCommentExStart"),p.getProp("imgCommentExEnd"), 0, true);
-		} catch (Exception ex) { // Missing property in spider .def
-			return;
-		}
-		while(exImgSrc.endOfSearch() == false){
-			imgUrl = exImgSrc.findNext();
-			imgComment = exImgComment.findNext();
-			//Vm.debug("Img Url: " +imgUrl);
-			if(imgUrl.length()>0){
-				imgUrl = "http://" + imgUrl;
-				try{
-					imgType = (imgUrl.substring(imgUrl.lastIndexOf(".")).toLowerCase()+"    ").substring(0,4).trim();
-					// imgType is now max 4 chars, starting with .
-					if(imgType.startsWith(".png") || imgType.startsWith(".jpg") || imgType.startsWith(".gif")){
-						// Check whether image was already spidered for this cache
-						idxUrl=spideredUrls.find(imgUrl);
-						imgName = chD.getParent().getWayPoint() + "_" + Convert.toString(imgCounter);
-						if (idxUrl<0) { // New image
-							pref.log("Loading image: " + imgUrl);
-							spiderImage(imgUrl, imgName+imgType);
-							chD.Images.add(imgName+imgType);
-						} else { // Image already spidered as wayPoint_ 'idxUrl'
-							pref.log("Already loaded image: " + imgUrl);
-							oldImgName = chD.getParent().getWayPoint() + "_" + Convert.toString(idxUrl);
-							chD.Images.add(oldImgName+imgType); // Store name of old image as image to load
-						}
-						chD.ImagesText.add(exImgName.findNext()); // Keep the image description
-						while (imgComment.startsWith("<br />")) imgComment=imgComment.substring(6);
-						while (imgComment.endsWith("<br />")) imgComment=imgComment.substring(0,imgComment.length()-6);
-						if (imgComment.length()==0)
-							chD.ImagesInfo.add(null);
-						else
-							chD.ImagesInfo.add(imgComment);
-						imgCounter++;
-					}
-				} catch (IndexOutOfBoundsException e) {
-					pref.log("IndexOutOfBoundsException in image span. imgURL:"+imgUrl,e);
-				}
-			}
-		}
-		//========
-		//Final sweep to check for images in hrefs
-		//========
-		Extractor exFinal = new Extractor(longDesc, "http://", "\"", 0, true);
-		while(exFinal.endOfSearch() == false){
-			imgUrl = exFinal.findNext();
-			if(imgUrl.length()>0){
-				imgUrl = "http://" + imgUrl;
-				try{
-					imgType = (imgUrl.substring(imgUrl.lastIndexOf(".")).toLowerCase()+"    ").substring(0,4).trim();
-					// imgType is now max 4 chars, starting with . Delete characters in URL after the image extension
-					imgUrl=imgUrl.substring(0,imgUrl.lastIndexOf(".")+imgType.length());
-					if( imgType.startsWith(".jpg") || imgType.startsWith(".bmp") || imgType.startsWith(".png") || imgType.startsWith(".gif")){
-						// Check whether image was already spidered for this cache
-						idxUrl=spideredUrls.find(imgUrl);
-						if (idxUrl<0) { // New image
-							imgName = chD.getParent().getWayPoint() + "_" + Convert.toString(imgCounter);
-							pref.log("Loading image: " + imgUrl+" as "+imgName);
-							spiderImage(imgUrl, imgName+imgType);
-							chD.Images.add(imgName+imgType);
-							spideredUrls.add(imgUrl);
-							chD.ImagesText.add(imgName); // Keep the image name
-							chD.ImagesInfo.add(null);
-							imgCounter++;
-						}
-					}
-				} catch (IndexOutOfBoundsException e) {
-					pref.log("Problem loading image. imgURL:"+imgUrl);
-				}
-			}
-		}
-	}
-
-
-	/**
-	 * Read an image from the server
-	 * @param imgUrl The Url of the image
-	 * @param target The bytes of the image
-	 */
-	private void spiderImage(String imgUrl, String target){ // TODO implement a fetch(URL, filename) in HttpConnection and use that one
-		HttpConnection connImg;
-		Socket sockImg;
-		//InputStream is;
-		FileOutputStream fos;
-		//int bytes_read;
-		//byte[] buffer = new byte[9000];
-		ByteArray daten;
-		String datei = "";
-		datei = profile.dataDir + target;
-		connImg = new HttpConnection(imgUrl);
-		if (imgUrl.indexOf('%')>=0) connImg.documentIsEncoded=true;
-		connImg.setRequestorProperty("Connection", "close");
-		//connImg.setRequestorProperty("User-Agent","Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.12) Gecko/20080201 Firefox/2.0.0.12");
-		//connImg.setRequestorProperty("Accept","text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5");
-		try{
-			pref.log("Trying to fetch image from: " + imgUrl);
-			String redirect=null;
-			do {
-				sockImg = connImg.connect();
-				redirect=connImg.getRedirectTo();
-				if (redirect!=null) {
-					connImg=connImg.getRedirectedConnection(redirect);
-					pref.log("Redirect to "+redirect);
-				}
-			} while(redirect!=null); // TODO this can end up in an endless loop if trying to load from a malicous site
-			daten = connImg.readData(sockImg);
-			fos = new FileOutputStream(new File(datei));
-			fos.write(daten.toBytes());
-			fos.close();
-			sockImg.close();
-		} catch (UnknownHostException e) {
-			pref.log("Host not there...");
-		}catch(IOException ioex){
-			pref.log("File not found!");
-		} catch (Exception ex){
-			pref.log("Some other problem while fetching image",ex);
-		} finally {
-			//Continue with the spider
-		}
-	}
-
-	/**
-	 * Read all additional waypoints from a previously fetched cachepage.
-	 * @param doc The previously fetched cachepage
-	 * @param wayPoint The name of the cache
-	 * @param is_found Found status of the cached (is inherited by the additional waypoints)
-	 */
-	public void getAddWaypoints(String doc, String wayPoint, boolean is_found) throws Exception{
-		Extractor exWayBlock = new Extractor(doc,p.getProp("wayBlockExStart"),p.getProp("wayBlockExEnd"), 0, false);
-		String wayBlock = "";
-		String rowBlock = "";
-		wayBlock = exWayBlock.findNext();
-		Regex nameRex = new Regex(p.getProp("nameRex"));
-		Regex koordRex = new Regex(p.getProp("koordRex"));
-		Regex descRex = new Regex(p.getProp("descRex"));
-		Regex typeRex = new Regex(p.getProp("typeRex"));
-		int counter = 0;
-		if(exWayBlock.endOfSearch() == false && wayBlock.indexOf("No additional waypoints to display.")<0){
-			Extractor exRowBlock = new Extractor(wayBlock,p.getProp("rowBlockExStart"),p.getProp("rowBlockExEnd"), 0, false);
-			rowBlock = exRowBlock.findNext();
-			rowBlock = exRowBlock.findNext();
-			while(exRowBlock.endOfSearch()==false){
-				CacheHolder hd = null;
-				Extractor exPrefix=new Extractor(rowBlock,p.getProp("prefixExStart"),p.getProp("prefixExEnd"),0,true);
-				String prefix=exPrefix.findNext();
-				String adWayPoint;
-				if (prefix.length()==2)
-					adWayPoint=prefix+wayPoint.substring(2);
-				else
-				    adWayPoint = MyLocale.formatLong(counter, "00") + wayPoint.substring(2);
-				counter++;
-				int idx=profile.getCacheIndex(adWayPoint);
-				if (idx>=0) {
-					// Creating new CacheHolder, but accessing old cache.xml file
-					hd=new CacheHolder();
-					hd.setWayPoint(adWayPoint);
-					hd.getExistingDetails(); // Accessing Details reads file if not yet done
-				} else {
-					hd=new CacheHolder();
-					hd.setWayPoint(adWayPoint);
-				}
-				hd.initStates(idx<0);
-				nameRex.search(rowBlock);
-				koordRex.search(rowBlock);
-				typeRex.search(rowBlock);
-				hd.setCacheName(nameRex.stringMatched(1));
-				if(koordRex.didMatch()) hd.setLatLon(koordRex.stringMatched(1));
-				if(typeRex.didMatch()) hd.setType(CacheType.gpxType2CwType("Waypoint|"+typeRex.stringMatched(1)));
-				rowBlock = exRowBlock.findNext();
-				descRex.search(rowBlock);
-				hd.getFreshDetails().setLongDescription(descRex.stringMatched(1));
-				hd.setFound(is_found);
-				hd.setCacheSize(CacheSize.CW_SIZE_NOTCHOSEN);
-				hd.setHard(CacheTerrDiff.CW_DT_UNSET);
-				hd.setTerrain(CacheTerrDiff.CW_DT_UNSET);
-				if (idx<0){
-					cacheDB.add(hd);
-					hd.save();
-				}else {
-					CacheHolder cx=cacheDB.get(idx);
-					if (cx.is_Checked && // Only re-spider existing addi waypoints that are ticked
-				 	   cx.isVisible()) { // and are visible (i.e.  not filtered)
-					   cx.initStates(false);
-					   cx.update(hd);
-					   cx.is_Checked=true;
-					   cx.save();
-					}
-				}
-				rowBlock = exRowBlock.findNext();
-
-			}
-		}
-	}
-
-	public void getAttributes(String doc, CacheHolderDetail chD) throws Exception {
-		Extractor attBlock = new Extractor(doc,p.getProp("attBlockExStart"),p.getProp("attBlockExEnd"), 0 , true);
-		String atts = attBlock.findNext();
-		Extractor attEx = new Extractor(atts,p.getProp("attExStart"),p.getProp("attExEnd"), 0 , true);
-		String attribute=attEx.findNext();
-		chD.attributes.clear();
-		while (attEx.endOfSearch()==false) {
-			chD.attributes.add(attribute);
-			attribute=attEx.findNext();
-		}
-		chD.getParent().setAttributesYes(chD.attributes.attributesYes);
-		chD.getParent().setAttributesNo(chD.attributes.attributesNo);
-	}
-
-
-	/**
-	*	Performs an initial fetch to a given address. In this case
-	*	it will be a gc.com address. This method is used to obtain
-	*	the result of a search for caches screen.
-	*/
-	public static String fetch(String address) {
-		CharArray c_data;
-		try{
-			HttpConnection conn;
-			if(pref.myproxy.length() > 0 && pref.proxyActive){
-				pref.log("[fetch]:Using proxy: " + pref.myproxy + " / " +pref.myproxyport);
-			}
-			conn = new HttpConnection(address);
-			conn.setRequestorProperty("User-Agent", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
-			if(cookieSession.length()>0){
-				conn.setRequestorProperty("Cookie", "ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
-				pref.log("[fetch]:Cookie Zeug: " + "Cookie: ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
-			} else
-				pref.log("[fetch]:No Cookie found");
-			conn.setRequestorProperty("Connection", "close");
-			conn.documentIsEncoded = true;
-			if (pref.debug) pref.log("[fetch]:Connecting");
-			Socket sock = conn.connect();
-			if (pref.debug) pref.log("[fetch]:Connect ok!");
-			ByteArray daten = conn.readData(sock);
-			if (pref.debug) pref.log("[fetch]:Read data ok");
-			JavaUtf8Codec codec = new JavaUtf8Codec();
-			c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
-			sock.close();
-			return getResponseHeaders(conn)+ c_data.toString();
-		}catch(IOException ioex){
-			pref.log("IOException in fetch", ioex);
-		}finally{
-			//continue
-		}
-		return "";
-	}
-
-	/**
-	*	After a fetch to gc.com the next fetches have to use the post method.
-	*	This method does exactly that. Actually this method is generic in the sense
-	*	that it can be used to post to a URL using http post.
-	*/
-	private static String fetch_post(String address, String document, String path) {
-		HttpConnection conn;
-		try {
-			conn = new HttpConnection(address);
-			JavaUtf8Codec codec = new JavaUtf8Codec();
-			conn.documentIsEncoded = true;
-			conn.setRequestorProperty("User-Agent", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
-			conn.setPostData(codec.encodeText(document.toCharArray(),0,document.length(),true,null));
-			conn.setRequestorProperty("Content-Type", "application/x-www-form-urlencoded");
-			if(cookieSession.length()>0){
-				conn.setRequestorProperty("Cookie", "ASP.NET_SessionId="+cookieSession+"; userid="+cookieID);
-				pref.log("[fetch]:Cookie Zeug: " + "Cookie: ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
-			} else {
-				pref.log("[fetch]:No Cookie found");
-			}
-			conn.setRequestorProperty("Connection", "close");
-			if (pref.debug) pref.log("[fetch]:Connecting");
-			Socket sock = conn.connect();
-			if (pref.debug) pref.log("[fetch]:Connect ok!");
-			ByteArray daten = conn.readData(sock);
-			if (pref.debug) pref.log("[fetch]:Read data ok");
-			CharArray c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
-			sock.close();
-			return getResponseHeaders(conn)+c_data.toString();
-		} catch (Exception e) {
-			Global.getPref().log("Ignored Exception", e, true);
-		}
-		return "";
-	}
-
-	private static String getResponseHeaders(HttpConnection conn) {
-		PropertyList pl = conn.documentProperties;
-		if (pl != null) {
-			StringBuffer sb = new StringBuffer(1000);
-			boolean gotany = false;
-
-			for (int i = 0; i < pl.size(); i++) {
-				Property currProp = (Property)pl.get(i);
-				if (currProp.value != null) {
-					sb.append(currProp.name).append(": ").append(currProp.value).append("\r\n");
-					gotany = true;
-				}
-			}
-			if (gotany)
-				return sb.toString() + "\r\n";
-		}
-		return "";
-	}
-
-
-	final static String hex = ewe.util.TextEncoder.hex;
-
-	public String encodeUTF8URL(byte[] what) {
-		int max = what.length;
-		char [] dest = new char[6*max]; // Assume each char is a UTF char and encoded into 6 chars
-		char d = 0;
-		for (int i = 0; i<max; i++){
-			char c = (char) what[i];
-			if (c <= ' ' || c == '+' || c == '&' || c == '%' || c == '=' ||
-				   c == '|' || c == '{' || c == '}' || c>0x7f ){
-					dest[d++] = '%';
-					dest[d++] = hex.charAt((c >> 4) & 0xf);
-					dest[d++] = hex.charAt(c & 0xf);
-			} else dest[d++] = c;
-		}
-		return new String(dest,0,d);
-	}
-
-	/**
-	 * Load the bug id for a given name. This method is not ideal, as there are
-	 * sometimes several bugs with identical names but different IDs. Normally
-	 * the bug GUID is used which can be obtained from the cache page.<br>
-	 * Note that each bug has both an ID and a GUID.
-	 * @param name The name (or partial name) of a travelbug
-	 * @return the id of the bug
-	 */
-	public String getBugId (String name) {
-		String bugList;
-		try{
-			//infB.setInfo(oldInfoBox+"\nGetting bug: "+bug);
-			pref.log("Fetching bugId: "+name);
-			bugList = fetch(p.getProp("getBugByName")+STRreplace.replace(SafeXML.clean(name)," ","+"));
-		}catch(Exception ex){
-			pref.log("Could not fetch bug list");
-			bugList="";
-		}
-		try {
-			if (bugList.equals("") || bugList.indexOf(p.getProp("bugNotFound"))>=0) {
-				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), FormBase.OKB)).execute();
-				return "";
-			}
-			if (bugList.indexOf(p.getProp("bugTotalRecords"))<0) {
-				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6021,"More than one travelbug found. Specify name more precisely."), FormBase.OKB)).execute();
-				return "";
-			}
-			Extractor exGuid = new Extractor(bugList,p.getProp("bugGuidExStart"),p.getProp("bugGuidExEnd"),0,Extractor.EXCLUDESTARTEND); // TODO Replace with spider.def
-			return exGuid.findNext();
-		} catch (Exception ex) {
-			return "";
-		}
-	}
-
-	/**
-	 * Fetch a bug's mission for a given GUID or ID. If the guid String is longer
-	 * than 10 characters it is assumed to be a GUID, otherwise it is an ID.
-	 * @param guid the guid or id of the travelbug
-	 * @return The mission
-	 */
-	public String getBugMissionByGuid(String guid) {
-		String bugDetails;
-		try{
-			//infB.setInfo(oldInfoBox+"\nGetting bug: "+bug);
-			pref.log("Fetching bug detailsById: "+guid);
-			if (guid.length()>10)
-				bugDetails = fetch(p.getProp("getBugByGuid")+guid);
-			else
-				bugDetails = fetch(p.getProp("getBugById")+guid);
-		}catch(Exception ex){
-			pref.log("Could not fetch bug details");
-			bugDetails="";
-		}
-		try {
-			if (bugDetails.indexOf(p.getProp("bugNotFound"))>=0) {
-				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), FormBase.OKB)).execute();
-				return "";
-			}
-			Extractor exDetails = new Extractor(bugDetails,p.getProp("bugDetailsStart"),p.getProp("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
-			return exDetails.findNext();
-		} catch (Exception ex) {
-			return "";
-		}
-	}
-
-	/**
-	 * Fetch a bug's mission for a given tracking number
-	 * @param trackNr the tracking number of the travelbug
-	 * @return The mission
-	 */
-	public String getBugMissionByTrackNr(String trackNr) {
-		String bugDetails;
-		try{
-			pref.log("Fetching bug detailsByTrackNr: "+trackNr);
-			bugDetails = fetch(p.getProp("getBugByTrackNr")+trackNr);
-		}catch(Exception ex){
-			pref.log("Could not fetch bug details");
-			bugDetails="";
-		}
-		try {
-			if (bugDetails.indexOf(p.getProp("bugNotFound"))>=0) {
-//				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), MessageBox.OKB)).execute();
-				return "";
-			}
-			Extractor exDetails = new Extractor(bugDetails,p.getProp("bugDetailsStart"),p.getProp("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
-			return exDetails.findNext();
-		} catch (Exception ex) {
-			return "";
-		}
-	}
-
-	/**
-	 * Fetch a bug's mission and namefor a given tracking number
-	 * @param TB the travelbug
-	 * @return true if suceeded
-	 */
-	public boolean getBugMissionAndNameByTrackNr(Travelbug TB) {
-		String bugDetails;
-		String trackNr = TB.getTrackingNo();
-		try{
-			pref.log("Fetching bug detailsByTrackNr: "+trackNr);
-			bugDetails = fetch(p.getProp("getBugByTrackNr")+trackNr);
-		}catch(Exception ex){
-			pref.log("Could not fetch bug details");
-			bugDetails="";
-		}
-		try {
-			if (bugDetails.indexOf(p.getProp("bugNotFound"))>=0) {
-//				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), MessageBox.OKB)).execute();
-				return false;
-			}
-			Extractor exDetails = new Extractor(bugDetails,p.getProp("bugDetailsStart"),p.getProp("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
-			TB.setMission( exDetails.findNext() );
-			Extractor exName = new Extractor(bugDetails,p.getProp("bugNameStart"),p.getProp("bugNameEnd"),0,Extractor.EXCLUDESTARTEND);
-			TB.setName( exName.findNext() );
-			return true;
-		} catch (Exception ex) {
-			return false;
-		}
-	}
-
-	public class SpiderProperties extends Properties {
-		SpiderProperties() {
-			super();
-			try {
-				load(new FileInputStream(FileBase.getProgramDirectory()+"/spider.def"));
-			} catch (Exception ex) {
-				pref.log("Failed to load spider.def",ex);
-				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5504,"Could not load 'spider.def'"), FormBase.OKB)).execute();
-			}
-		}
-		public String getProp(String key) throws Exception {
-			String s=super.getProperty(key);
-			if (s==null) {
-				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def") + ": "+key, FormBase.OKB)).execute();
-				throw new Exception("Missing tag in spider.def: "+key);
-			}
-			return s;
-		}
-
-	}
-}

Modified: trunk/src/CacheWolf/TravelbugJourneyScreen.java
===================================================================
--- trunk/src/CacheWolf/TravelbugJourneyScreen.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/TravelbugJourneyScreen.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -11,6 +11,7 @@
  * @author salzkammergut
  */
 
+import CacheWolf.imp.SpiderGC;
 import utils.CWWrapper;
 import ewe.sys.Convert;
 import ewe.sys.Time;

Copied: trunk/src/CacheWolf/imp/GPXImporter.java (from rev 1941, trunk/src/CacheWolf/GPXImporter.java)
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2009-06-24 17:27:40 UTC (rev 1941)
+++ trunk/src/CacheWolf/imp/GPXImporter.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -0,0 +1,597 @@
+package CacheWolf.imp;
+
+import CacheWolf.CacheDB;
+import CacheWolf.CacheHolder;
+import CacheWolf.CacheSize;
+import CacheWolf.CacheTerrDiff;
+import CacheWolf.CacheType;
+import CacheWolf.Common;
+import CacheWolf.Extractor;
+import CacheWolf.Filter;
+import CacheWolf.Global;
+import CacheWolf.InfoBox;
+import CacheWolf.Log;
+import CacheWolf.MyLocale;
+import CacheWolf.ParseLatLon;
+import CacheWolf.Preferences;
+import CacheWolf.Profile;
+import CacheWolf.SafeXML;
+import CacheWolf.Travelbug;
+import ewe.sys.Time;
+import ewe.sys.Vm;
+import ewe.ui.FormBase;
+import ewe.ui.MessageBox;
+import ewe.util.Enumeration;
+import ewe.util.Vector;
+import ewe.util.zip.ZipEntry;
+import ewe.util.zip.ZipFile;
+import ewesoft.xml.MinML;
+import ewesoft.xml.XMLElement;
+import ewesoft.xml.sax.AttributeList;
+
+/**
+*	Class to import Data from an GPX File. If cache data exists, the data from 
+*	the GPX-File is ignored.
+*	Class ID = 4000
+*/
+public class GPXImporter extends MinML {
+	
+	static Preferences pref;
+	Profile profile;
+	CacheDB cacheDB;
+	CacheHolder holder;
+	String strData, saveDir, logData, logIcon, logDate, logFinder, logId;
+	boolean inWpt, inCache, inLogs, inBug;
+	public XMLElement document;
+	private Vector files = new Vector();
+	private boolean debugGPX = false; 
+	InfoBox infB;
+	boolean spiderOK = true;
+	boolean doSpider = false;
+	boolean fromOC = false;
+	boolean fromTC = false;
+	boolean nameFound = false;
+	static final Time gpxDate = new Time();
+	int zaehlerGel = 0;
+	public static final int DOIT_ASK = 0;
+	public static final int DOIT_NOSPOILER = 1;
+	public static final int DOIT_WITHSPOILER = 2;
+	boolean getMaps = false;
+	SpiderGC imgSpider;
+	StringBuffer strBuf;
+	
+	public GPXImporter(Preferences p, Profile prof, String f )
+	{
+		profile=prof;
+		pref = p;
+		cacheDB = profile.cacheDB;
+		//file = f;
+		files.add(f);
+		saveDir = profile.dataDir;
+		//msgA = msgArea;
+		inWpt = false;
+		inCache = false;
+		inLogs = false;
+		inBug =false;
+	}
+/*	skg: This Constructor is not referenced, therefore commented out 
+	public GPXImporter(Vector DB, String[] f,String d, Preferences p)
+	{
+		pref = p;
+		cacheDB = DB;
+		saveDir = pref.mydatadir;
+		for (int i=0;i<f.length;i++){
+			files.add(d + "/" + f[i]);
+		}
+		
+		//msgA = msgArea;
+		inWpt = false;
+		inCache = false;
+		inLogs = false;
+		inBug =false;
+		strData = new String();
+		//index db for faster search
+		CacheHolder ch;
+		for(int i = 0; i<cacheDB.size();i++){
+			ch = (CacheHolder)cacheDB.get(i);
+			DBindex.put((String)ch.wayPoint, new Integer(i));
+		}//for
+	}
+*/	
+	public void doIt(int how){
+		Filter flt = new Filter();
+		boolean wasFiltered = (profile.getFilterActive()==Filter.FILTER_ACTIVE);
+		flt.clearFilter();
+		try{
+			ewe.io.Reader r;
+			String file;
+			
+			OCXMLImporterScreen options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"), OCXMLImporterScreen.IMAGES| OCXMLImporterScreen.ISGC);
+			if (options.execute() == FormBase.IDCANCEL) {	return; }
+			//String dist = options.distanceInput.getText();
+			//if (dist.length()== 0) return;
+			//getMaps = options.mapsCheckBox.getState();
+			boolean getImages = options.imagesCheckBox.getState();
+			doSpider = false;
+			if(getImages){
+				doSpider = true;
+				imgSpider = new SpiderGC(pref, profile, false);
+			}
+			options.close(0);
+			
+			//Vm.debug("State of: " + doSpider);
+			Vm.showWait(true);
+			for (int i=0; i<files.size();i++){
+				//Test for zip.file
+				file = (String)files.get(i);
+				if (file.indexOf(".zip") > 0){
+					ZipFile zif = new ZipFile (file);
+					ZipEntry zipEnt;
+					Enumeration zipEnum = zif.entries();
+					// there could be more than one file in the archive
+					while (zipEnum.hasMoreElements())
+					{
+						zipEnt = (ZipEntry) zipEnum.nextElement();
+						// skip over PRC-files
+						if (zipEnt.getName().endsWith("gpx")){
+							r = new ewe.io.InputStreamReader(zif.getInputStream(zipEnt));
+							infB = new InfoBox(zipEnt.toString(),(MyLocale.getMsg(4000,"Loaded caches: ") + zaehlerGel));
+							infB.exec();
+							if (r.read() != 65279)
+								r = new ewe.io.InputStreamReader(zif.getInputStream(zipEnt));
+							parse(r);
+							r.close();
+							infB.close(0);
+						}
+					}
+				}
+				else {
+					r = new ewe.io.InputStreamReader(new ewe.io.FileInputStream(file));
+					infB = new InfoBox("Info",(MyLocale.getMsg(4000,"Loaded caches: ") + zaehlerGel));
+					infB.show();
+					if (r.read() != 65279)
+						r = new ewe.io.InputStreamReader(new ewe.io.FileInputStream(file));
+					parse(r);
+					r.close();
+					infB.close(0);
+				}
+				// save Index 
+				profile.saveIndex(pref,Profile.SHOW_PROGRESS_BAR);
+				infB.close(0);
+			}
+				Vm.showWait(false);
+			}catch(Exception e){
+				e.printStackTrace();
+				Vm.showWait(false);
+			}
+		if(wasFiltered){
+			flt.setFilter();
+			flt.doFilter();
+		}
+	}
+	public void startElement(String name, AttributeList atts){
+		strBuf=new StringBuffer(300);
+		if (name.equals("gpx")){
+			// check for opencaching
+			if (atts.getValue("creator").indexOf("opencaching")> 0) fromOC = true;
+			else fromOC = false;
+			if (atts.getValue("creator").startsWith("TerraCaching")) fromTC = true;
+			else fromTC = false;
+
+			if (fromOC && doSpider) (new MessageBox("Warnung", MyLocale.getMsg(4001, "GPX files from opencaching don't contain information of images, they cannot be laoded. Best you get caches from opencaching by menu /Application/Import/Download from Opencaching"), FormBase.OKB)).execute();
+			zaehlerGel = 0;
+		}
+		if (name.equals("wpt")) {
+			holder = new CacheHolder();
+			holder.pos.set(Common.parseDouble(atts.getValue("lat")),Common.parseDouble(atts.getValue("lon")));
+			holder.LatLon=holder.pos.toString();
+			inWpt = true;
+			inLogs = false;
+			inBug = false;
+			nameFound = false;
+			zaehlerGel++;
+			infB.setInfo(MyLocale.getMsg(4000,"Loaded caches: ") + zaehlerGel);
+			return;
+		}
+		
+		if (name.equals("link")&& inWpt){
+			holder.getFreshDetails().URL = atts.getValue("href");
+			return;
+		}
+
+		if (name.equals("groundspeak:cache")) {
+			inCache = true;
+			holder.setAvailable(atts.getValue("available").equals("True"));
+			holder.setArchived(atts.getValue("archived").equals("True"));
+			return;
+		}
+
+		if (name.equals("geocache")) {
+			boolean available = false;
+			boolean archived  = false;
+			inCache=true;
+			// get status
+			String status = new String(atts.getValue("status"));
+			if (status.equals("Available")) available = true;
+			else if (status.equals("Unavailable")) available = false;
+			else if (status.equals("Draft")) available = false;
+			else if (status.equals("Archived")) archived = true;
+			holder.setArchived(archived);
+			holder.setAvailable(available);
+			return;
+		}
+		
+		if (name.equals("terra:terracache")) {
+			inCache=true;
+		}
+
+		
+		if (name.equals("groundspeak:long_description")) {
+			holder.setHTML(atts.getValue("html").toLowerCase().equals("true"));
+		}
+		if (name.equals("description") || name.equals("terra:description") ) {
+			//set HTML always to true if from oc.de or TC
+			holder.setHTML(true);
+		}
+
+		if (name.equals("groundspeak:logs") || name.equals("logs") || name.equals("terra:logs")) {
+			inLogs = true;
+			return;
+		}
+		if (name.equals("groundspeak:log") || name.equals("log") || name.equals("terra:log")) {
+			inLogs = true;
+			logId = atts.getValue("id");
+			return;
+		}
+		if (name.equals("groundspeak:travelbugs")) {
+			inBug = true;
+			return;
+		}
+		if (debugGPX){
+			for (int i = 0; i < atts.getLength(); i++) {
+				Vm.debug("Type: " + atts.getType(i) + " Name: " + atts.getName(i)+ " Value: "+atts.getValue(i));
+			}
+		}
+	}
+	
+	public void endElement(String name){
+		strData=strBuf.toString();
+		//Vm.debug("Ende: " + name);
+		
+		// logs
+		if (inLogs){
+			if (name.equals("groundspeak:date")|| name.equals("time")|| name.equals("terra:date"))  {
+				logDate = new String(strData.substring(0,10));
+				return;
+			}
+			if (name.equals("groundspeak:type") || name.equals("type") || name.equals("terra:type")){
+				logIcon = new String(typeText2Image(strData));
+				return;
+			}
+			if (name.equals("groundspeak:finder")|| name.equals("geocacher")|| name.equals("terra:user")){
+				logFinder = new String(strData);
+				return;
+			}
+			if (name.equals("groundspeak:text") || name.equals("text") || name.equals("terra:entry")){ 
+				logData = new String(strData);
+				return;
+			}
+			if (name.equals("groundspeak:log") || name.equals("log") || name.equals("terra:log") ) {
+				holder.getFreshDetails().CacheLogs.add(new Log(logIcon,logDate,logFinder,logData));
+				if((logIcon.equals("icon_smile.gif") || logIcon.equals("11.png") || logIcon.equals("icon_attended.gif")) && 
+						  (logFinder.equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()>0 && logFinder.equalsIgnoreCase(pref.myAlias2)))) {
+							holder.setCacheStatus(logDate);
+							holder.setFound(true);
+							holder.getFreshDetails().OwnLogId = logId;
+							holder.getFreshDetails().OwnLog = new Log(logIcon,logDate,logFinder,logData);
+				}
+				return;
+			}
+		}
+		
+		if (name.equals("wpt")){
+			// Add cache Data only, if waypoint not already in database
+			//if (searchWpt(cacheDB, holder.wayPoint)== -1){
+			int index=cacheDB.getIndex(holder.getWayPoint());
+			//Vm.debug("here ?!?!?");
+			//Vm.debug("chould be new!!!!");
+			if (index == -1){
+				holder.setNoFindLogs(holder.getFreshDetails().CacheLogs.countNotFoundLogs());
+				holder.setNew(true);
+				cacheDB.add(holder);
+				// don't spider additional waypoints, so check
+				// if waypoint starts with "GC"
+				if(doSpider == true) {
+					if(spiderOK == true && holder.is_archived() == false){
+							if(holder.LatLon.length() > 1){
+							if(getMaps){
+								ParseLatLon pll = new ParseLatLon(holder.LatLon,".");
+								pll.parse();
+								//MapLoader mpl = new MapLoader(pref.myproxy, pref.myproxyport);
+								//mpl.loadTo(profile.dataDir + "/" + holder.wayPoint + "_map.gif", "3");
+								//mpl.loadTo(profile.dataDir + "/" + holder.wayPoint + "_map_2.gif", "10");
+							}
+						}
+					if(holder.getWayPoint().startsWith("GC")|| fromTC) {
+						//spiderImages();
+						spiderImagesUsingSpider();
+						//Rename image sources
+						String text;
+						String orig;
+						String imgName;
+						orig = holder.getFreshDetails().LongDescription;
+						Extractor ex = new Extractor(orig, "<img src=\"", ">", 0, false);
+						text = ex.findNext();
+						int num = 0;
+						while(ex.endOfSearch() == false && spiderOK == true){
+							//Vm.debug("Replacing: " + text);
+							if (num >= holder.getFreshDetails().ImagesText.getCount())break;
+							imgName = (String)holder.getFreshDetails().ImagesText.get(num);
+							holder.getFreshDetails().LongDescription = replace(holder.getFreshDetails().LongDescription, text, "[[Image: " + imgName + "]]");
+							num++;
+							text = ex.findNext();
+						}
+					}
+						
+					}
+				}
+				holder.save();
+				//crw.saveIndex(cacheDB,saveDir);
+			}
+			//Update cache data
+			else {
+				CacheHolder oldCh= cacheDB.get(index);
+				oldCh.update(holder);
+				oldCh.save();
+			}
+			
+			inWpt = false;
+			return;
+		}
+		if (name.equals("sym")&& strData.endsWith("Found")) {
+			holder.setFound(true);
+			holder.setCacheStatus(MyLocale.getMsg(318,"Found"));
+			return;
+		}
+		if (name.equals("groundspeak:travelbugs")) {
+			inBug = false;
+			return;
+		}
+
+		if (name.equals("groundspeak:name")&& inBug) {
+			Travelbug tb=new Travelbug(strData);
+			holder.getFreshDetails().Travelbugs.add(tb);
+			//holder.Bugs += "<b>Name:</b> " + strData + "<br><hr>";
+			holder.setHas_bugs(true);
+			return;
+		}
+		
+		if (name.equals("time") && !inWpt) {		    
+			try {
+			    gpxDate.parse(strData.substring(0,19),"yyyy-MM-dd'T'HH:mm:ss");
+			} catch (IllegalArgumentException e) {
+			    gpxDate.setTime(0);
+			    Global.getPref().log("Error parsing date: '"+strData+"'. Ignoring.");
+			}
+			return;
+		}
+
+		if (name.equals("time") && inWpt) {
+			holder.setDateHidden(strData.substring(0,10)); //Date;
+			return;
+		}
+		// cache information
+		if (name.equals("groundspeak:cache") || name.equals("geocache")|| name.equals("terra:terracache")) {
+			inCache = false;
+		}
+		
+		if (name.equals("name") && inWpt && !inCache) {
+			holder.setWayPoint(strData);
+			if (gpxDate.getTime()!=0) {
+			    holder.setLastSync(gpxDate.format("yyyyMMddHHmmss"));
+			} else {
+			    holder.setLastSync("");
+			}    
+			//msgA.setText("import " + strData);
+			return;
+		}
+		//Vm.debug("Check: " + inWpt + " / " + fromOC);
+		//if (name.equals("desc") && inWpt && fromOC) {
+		// fill name with contents of <desc>, in case of gc.com the name is
+		// later replaced by the contents of <groundspeak:name> which is shorter
+		if (name.equals("desc")&& inWpt ) {
+			holder.setCacheName(strData);
+			//Vm.debug("CacheName: " + strData);
+			//msgA.setText("import " + strData);
+			return;
+		}
+		if (name.equals("url")&& inWpt){
+			holder.getFreshDetails().URL = strData;
+			return;
+		}
+		
+		// Text for additional waypoints, no HTML
+		if (name.equals("cmt")&& inWpt){
+			holder.getFreshDetails().LongDescription = strData;
+			holder.setHTML(false);
+			return;
+		}
+		
+		// aditional wapypoint
+		if (name.equals("type")&& inWpt && !inCache && strData.startsWith("Waypoint")){
+			holder.setType(CacheType.gpxType2CwType(strData));
+			holder.setCacheSize(CacheSize.CW_SIZE_NOTCHOSEN);
+			holder.setHard(CacheTerrDiff.CW_DT_UNSET);
+			holder.setTerrain(CacheTerrDiff.CW_DT_UNSET);
+			holder.setLastSync("");
+		}
+		
+		if ((name.equals("groundspeak:name")|| name.equals("terra:name")) && inCache) {
+			holder.setCacheName(strData);
+			return;
+		}
+		if (name.equals("groundspeak:owner") || name.equals("owner")||name.equals("terra:owner")) {
+			holder.setCacheOwner(strData);
+			if(pref.myAlias.equals(strData)) holder.setOwned(true);
+			return;
+		}
+		if (name.equals("groundspeak:difficulty") || name.equals("difficulty") || name.equals("terra:mental_challenge")) {
+			holder.setHard(CacheTerrDiff.v1Converter(strData));
+			return;
+		}
+		if (name.equals("groundspeak:terrain")|| name.equals("terrain")|| name.equals("terra:physical_challenge")) {
+			holder.setTerrain(CacheTerrDiff.v1Converter(strData));
+			return;
+		}
+		if ((name.equals("groundspeak:type") || name.equals("type")|| name.equals("terra:style"))&& inCache){
+			holder.setType(CacheType.gpxType2CwType(strData));
+			if (holder.getType() == CacheType.CW_TYPE_CUSTOM) {
+				holder.setCacheSize(CacheSize.CW_SIZE_NOTCHOSEN);
+				holder.setHard(CacheTerrDiff.CW_DT_UNSET);
+				holder.setTerrain(CacheTerrDiff.CW_DT_UNSET);
+			}
+			return;
+		}
+		if (name.equals("groundspeak:container")|| name.equals("container")){
+			holder.setCacheSize(CacheSize.gcGpxString2Cw(strData));
+			return;
+		}
+		if (name.equals("groundspeak:country")|| name.equals("country")){
+			holder.getFreshDetails().Country = strData;
+			return;
+		}
+		if (name.equals("groundspeak:state")|| name.equals("state")){
+			holder.getFreshDetails().State = strData;
+			return;
+		}
+		if (name.equals("terra:size")){
+			holder.setCacheSize(CacheSize.tcGpxString2Cw(strData));
+		}
+
+		if (name.equals("groundspeak:short_description")|| name.equals("summary")) {
+			if (holder.is_HTML())	holder.getFreshDetails().LongDescription =SafeXML.cleanback(strData)+"<br>"; // <br> needed because we also use a <br> in SpiderGC. Without it the comparison in ch.update fails
+			else holder.getFreshDetails().LongDescription =strData+"\n";
+			return;
+		}
+
+		if (name.equals("groundspeak:long_description")|| name.equals("description")|| name.equals("terra:description")) {
+			if (holder.is_HTML())	holder.getFreshDetails().LongDescription +=SafeXML.cleanback(strData);
+			else holder.getFreshDetails().LongDescription +=strData;
+			return;
+		}
+		if (name.equals("groundspeak:encoded_hints") || name.equals("hints")) {
+			holder.getFreshDetails().Hints = Common.rot13(strData);
+			return;
+		}
+		
+		if (name.equals("terra:hint")) {
+			// remove "&lt;br&gt;<br>" from the end
+			int indexTrash = strData.indexOf("&lt;br&gt;<br>");
+			if (indexTrash > 0)	holder.getFreshDetails().Hints = Common.rot13(strData.substring(0,indexTrash));
+			return;
+		}
+
+
+	}
+	public void characters(char[] ch,int start,int length){
+		strBuf.append(ch,start,length);
+		if (debugGPX) Vm.debug("Char: " + strBuf.toString());
+	}
+	
+
+	public static String typeText2Image(String typeText){
+		if (typeText.equals("Found it")||typeText.equals("Found")||typeText.equals("find")) return "icon_smile.gif";
+		if (typeText.equals("Didn't find it")||typeText.equals("Not Found")||typeText.equals("no_find")) return "icon_sad.gif";
+		if (typeText.equals("Write note")||typeText.equals("Note")||typeText.equals("note")
+			||typeText.equals("Not Attempted")||typeText.equals("Other")) return "icon_note.gif";
+		if (typeText.equals("Enable Listing")) return "icon_enabled.gif";
+		if (typeText.equals("Temporarily Disable Listing")) return "icon_disabled.gif";
+		if (typeText.equals("Webcam Photo Taken")) return "11.png";
+		if (typeText.equals("Attended")) return "icon_attended.gif";
+		if (typeText.equals("Publish Listing")) return "green.png";
+		if (typeText.equals("Will Attend")) return "icon_rsvp.gif";
+		if (typeText.equals("Post Reviewer Note")) return "big_smile.gif";
+		if (typeText.equals("Unarchive")) return "traffic_cone.gif";
+		if (typeText.equals("Archive (show)")) return "traffic_cone.gif";
+		if (typeText.equals("Owner Maintenance")) return "icon_maint.gif";
+		if (typeText.equals("Needs Maintenance")) return "icon_needsmaint.gif";
+		if (typeText.equals("Update Coordinates")) return "coord_update.gif";
+		//Vm.debug("Unknown Log Type:" + typeText);
+		return typeText;
+	}
+	
+	public static String TCSizetoText(String size){
+		if (size.equals("1")) return "Micro";
+		if (size.equals("2")) return "Medium";
+		if (size.equals("3")) return "Regular";
+		if (size.equals("4")) return "Large";
+		if (size.equals("5")) return "Very Large";
+
+		return "None";
+	}
+
+	/**
+	* Method to iterate through cache database and look for waypoint.
+	* Returns value >= 0 if waypoint is found, else -1
+	*/
+	/*
+	private int searchWpt(Vector db, String wpt){
+		if(wpt.length()>0){
+			wpt = wpt.toUpperCase();
+			CacheHolder ch = new CacheHolder();
+			//Search through complete database
+			for(int i = 0;i < db.size();i++){
+				ch = (CacheHolder)db.get(i);
+				if(ch.wayPoint.indexOf(wpt) >=0 ){
+					return i;
+				}
+			} // for
+		} // if
+		return -1;
+	}
+	*/
+	
+	private void spiderImagesUsingSpider(){
+		String addr;
+		String cacheText;
+		
+		// just to be sure to have a spider object
+		if (imgSpider == null) imgSpider = new SpiderGC(pref, profile, false);
+		
+		if (fromTC) {
+				imgSpider.getImages(holder.getFreshDetails().LongDescription, holder.getFreshDetails());
+		}
+		else {
+			addr = "http://www.geocaching.com/seek/cache_details.aspx?wp=" + holder.getWayPoint() ;
+			//Vm.debug(addr + "|");
+			cacheText = SpiderGC.fetch(addr);
+			imgSpider.getImages(cacheText, holder.getFreshDetails());
+			try {
+				imgSpider.getAttributes(cacheText, holder.getFreshDetails());
+			} catch (Exception e) {
+				if (Global.getPref().debug) Global.getPref().log("unable to fetch attrivbutes for"+holder.getWayPoint(), e);
+			}
+		}
+	}
+	
+	public static String replace(String source, String pattern, String replace){
+		if (source!=null)
+		{
+			final int len = pattern.length();
+			StringBuffer sb = new StringBuffer();
+			int found = -1;
+			int start = 0;
+		
+			while( (found = source.indexOf(pattern, start) ) != -1) {
+			    sb.append(source.substring(start, found));
+			    sb.append(replace);
+			    start = found + len;
+			}
+		
+			sb.append(source.substring(start));
+		
+			return sb.toString();
+		}
+		else return "";
+	}
+}


Property changes on: trunk/src/CacheWolf/imp/GPXImporter.java
___________________________________________________________________
Name: svn:mergeinfo
   + 

Copied: trunk/src/CacheWolf/imp/OCXMLImporter.java (from rev 1941, trunk/src/CacheWolf/OCXMLImporter.java)
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2009-06-24 17:27:40 UTC (rev 1941)
+++ trunk/src/CacheWolf/imp/OCXMLImporter.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -0,0 +1,731 @@
+package CacheWolf.imp;
+
+import utils.FileBugfix;
+
+import CacheWolf.CWPoint;
+import CacheWolf.CacheDB;
+import CacheWolf.CacheHolder;
+import CacheWolf.CacheSize;
+import CacheWolf.CacheTerrDiff;
+import CacheWolf.CacheType;
+import CacheWolf.Common;
+import CacheWolf.InfoBox;
+import CacheWolf.Log;
+import CacheWolf.MyLocale;
+import CacheWolf.Preferences;
+import CacheWolf.Profile;
+import CacheWolf.SafeXML;
+import CacheWolf.UrlFetcher;
+
+import com.stevesoft.ewe_pat.Regex;
+
+import ewesoft.xml.*;
+import ewesoft.xml.sax.*;
+import ewe.io.*;
+import ewe.sys.*;
+import ewe.ui.FormBase;
+import ewe.ui.MessageBox;
+import ewe.util.*;
+import ewe.util.zip.*;
+import ewe.net.*;
+import ewe.sys.Double;
+
+/**
+ *	Class to import Data from opencaching.de. 
+ *	It uses the lastmodified parameter to identify new or changed caches.
+ *	See here: http://www.opencaching.com/phpBB2/viewtopic.php?t=281 (out-dated)
+ *   See here: http://www.opencaching.de/doc/xml/xml11.htm and http://develforum.opencaching.de/viewtopic.php?t=135&postdays=0&postorder=asc&start=0
+ *	for more information.
+ */
+public class OCXMLImporter extends MinML {
+	static protected final int STAT_INIT = 0;
+	static protected final int STAT_CACHE = 1;
+	static protected final int STAT_CACHE_DESC = 2;
+	static protected final int STAT_CACHE_LOG = 3;
+	static protected final int STAT_PICTURE = 4;
+
+	final static String OPENCACHING_HOST = "www.opencaching.de";
+	int state = STAT_INIT;
+	int numCacheImported, numDescImported, numLogImported= 0;
+
+	boolean debugGPX = false;
+	CacheDB cacheDB;
+	InfoBox inf;
+	CacheHolder ch;
+	CacheHolder holder;
+	Preferences pref;
+	Profile profile;
+	Time dateOfthisSync;
+	String strData = new String();
+	int picCnt;
+	boolean incUpdate = true; // complete or incremental Update
+	boolean ignoreDesc = false;
+	boolean askForOptions = true;
+	Hashtable DBindexID = new Hashtable();
+
+	String picUrl = new String();
+	String picTitle =  new String();
+	String picID = new String();
+	String ocSeekUrl = new String("http://"+OPENCACHING_HOST+"/viewcache.php?cacheid=");
+	String cacheID = new String();
+
+	String logData, logIcon, logDate, logFinder, logId;
+	boolean loggerRecommended;
+	int logtype;
+	String user;
+	double longitude;
+
+
+	public OCXMLImporter(Preferences p,Profile prof)
+	{
+		pref = p;
+		profile=prof;
+		cacheDB = profile.cacheDB;
+		if(profile.getLast_sync_opencaching() == null ||
+				profile.getLast_sync_opencaching().length() < 12){
+			profile.setLast_sync_opencaching("20050801000000");
+			incUpdate = false;
+		}
+		user = p.myAlias.toLowerCase();
+		for(int i = 0; i<cacheDB.size();i++){
+			ch = cacheDB.get(i);
+			if (!ch.getOcCacheID().equals(""))
+				DBindexID.put(ch.getOcCacheID(), new Integer(i));
+		}//for
+
+	}
+
+	/** true, if not the last syncdate shall be used, but the caches shall be reloaded
+	 * only used in syncSingle */
+	boolean reload;
+	/**
+	 * 
+	 * @param number
+	 * @param infB
+	 * @return true, if some change was made to the cacheDB
+	 */
+	public boolean syncSingle(int number, InfoBox infB) {
+		ch = cacheDB.get(number);
+		holder= null; //new CacheHolderDetail(ch); //TODO is this still correct? use getDetails ?
+
+		if (infB.isClosed) {
+			if (askForOptions) return false; 
+			else return true;
+		}
+		if (askForOptions) {
+			OCXMLImporterScreen importOpt = new OCXMLImporterScreen( MyLocale.getMsg(1600, "Opencaching.de Download"),OCXMLImporterScreen.IMAGES | OCXMLImporterScreen.ALL);
+			if (importOpt.execute() == FormBase.IDCANCEL) {	return false; }
+			askForOptions = false;
+			reload = importOpt.missingCheckBox.getState();
+		}
+
+		// this is only a dummy-InfoBox for capturing the output
+		inf = new InfoBox("Opencaching download", MyLocale.getMsg(1608,"downloading data\n from opencaching"), InfoBox.PROGRESS_WITH_WARNINGS, false);
+//		inf.setPreferredSize(220, 300);
+//		inf.relayout(false);
+//		inf.exec();
+
+		String lastS; 
+		if (reload)  lastS = "20050801000000";
+		else {
+			if (ch.getLastSync().length() < 14) lastS = "20050801000000";
+			else lastS = ch.getLastSync();
+		}
+		dateOfthisSync = new Time();
+		dateOfthisSync.parse(lastS, "yyyyMMddHHmmss");
+	
+
+		String url = new String();
+		picCnt = 0;
+		//Build url
+		url = "http://" + OPENCACHING_HOST + "/xml/ocxml11.php?"
+			+ "modifiedsince=" + lastS
+			+ "&cache=1"
+			+ "&cachedesc=1";
+		if (pref.downloadPics) url += "&picture=1";
+		else url += "&picture=0";
+		url += "&cachelog=1"
+			+ "&removedobject=0"
+			+ "&wp=" + ch.getWayPoint()
+			+ "&charset=utf-8"
+			+ "&cdata=0"
+			+ "&session=0";
+		syncOC(url);
+		inf.close(0);
+		return true;
+	}
+
+	public void doIt(){
+		boolean success=true;
+		String finalMessage;
+
+		
+		String url = new String();
+
+		String lastS =  profile.getLast_sync_opencaching();
+		CWPoint centre = pref.curCentrePt; // No need to clone curCentrePt as centre is only read
+		if (!centre.isValid()) {
+			(new MessageBox("Error", "Coordinates for centre must be set", FormBase.OKB)).execute();
+			return;
+		}
+		OCXMLImporterScreen importOpt = new OCXMLImporterScreen( MyLocale.getMsg(1600, "Opencaching.de Download"),
+																 OCXMLImporterScreen.ALL | OCXMLImporterScreen.DIST | OCXMLImporterScreen.IMAGES);
+		if (importOpt.execute() == FormBase.IDCANCEL) {	return; }
+		Vm.showWait(true);
+		String dist = importOpt.distanceInput.getText();
+		if (dist.length()== 0) return;
+		
+		Double distDouble = new Double();
+		distDouble.value = Common.parseDouble(dist);
+		dist = distDouble.toString(0, 1, 0).replace(',', '.');
+		//check, if distance is greater than before
+		if (Convert.toInt(dist) > Convert.toInt(profile.getDistOC()) ||
+				pref.downloadmissingOC  ){
+			// resysnc
+			lastS = "20050801000000";
+			incUpdate = false;
+		}
+		profile.setDistOC(dist);
+		// Clear status of caches in db
+		for(int i = cacheDB.size()-1; i>=0 ;i--){
+			ch = cacheDB.get(i);
+			ch.setUpdated(false);
+			ch.setNew(false);
+			ch.setLog_updated(false);
+		}	
+		picCnt = 0;
+		//Build url
+		url = "http://" + OPENCACHING_HOST + "/xml/ocxml11.php?"
+			+ "modifiedsince=" + lastS
+			+ "&cache=1"
+			+ "&cachedesc=1";
+		if (pref.downloadPics) url += "&picture=1";
+		else url += "&picture=0";
+		url += "&cachelog=1"
+			+ "&removedobject=0"
+			+ "&lat=" + centre.getLatDeg(CWPoint.DD)
+			+ "&lon=" + centre.getLonDeg(CWPoint.DD)
+			+ "&distance=" + dist
+			+ "&charset=utf-8"
+			+ "&cdata=0"
+			+ "&session=0";
+		inf = new InfoBox("Opencaching download", MyLocale.getMsg(1608,"downloading data\n from opencaching"), InfoBox.PROGRESS_WITH_WARNINGS, false);
+		inf.setPreferredSize(220, 300);
+		inf.relayout(false);
+		inf.exec();
+
+		success = syncOC(url);
+		profile.saveIndex(pref,Profile.SHOW_PROGRESS_BAR);
+		Vm.showWait(false);
+		if (success) {
+			profile.setLast_sync_opencaching(dateOfthisSync.format("yyyyMMddHHmmss"));
+			//pref.savePreferences();
+			finalMessage = MyLocale.getMsg(1607,"Update from opencaching successful"); 
+			inf.addWarning("\nNumber of"+
+			"\n...caches new/updated: " + numCacheImported +
+			"\n...cache descriptions new/updated: " + numDescImported +
+			"\n...logs new/updated: " + numLogImported);
+			inf.setInfo(finalMessage);
+		}
+		inf.addOkButton();
+	}
+	
+	private boolean syncOC(String url) {
+		String finalMessage = new String();
+		boolean success=true;
+		File tmpFile = null;
+		BufferedReader r;
+		String file = new String();
+
+		//inf = new InfoBox("Opencaching download", MyLocale.getMsg(1608,"downloading data\n from opencaching"), InfoBox.PROGRESS_WITH_WARNINGS, false);
+		
+		picCnt = 0;
+		try{
+			holder = null;
+			file = fetch(url, "dummy");
+
+			//parse
+			tmpFile = new FileBugfix(profile.dataDir + file);
+			if (tmpFile.getLength() == 0 ) {
+				throw new IOException("no updates available");
+			}
+
+			ZipFile zif = new ZipFile (profile.dataDir + file);
+			ZipEntry zipEnt;
+			Enumeration zipEnum = zif.entries();
+			inf.setInfo("...unzipping update file"); 
+			while (zipEnum.hasMoreElements())
+			{
+				zipEnt = (ZipEntry) zipEnum.nextElement();
+				// skip over PRC-files and empty files
+				if (zipEnt.getSize()> 0 && zipEnt.getName().endsWith("xml")){
+					r = new BufferedReader (new InputStreamReader(zif.getInputStream(zipEnt), IO.JAVA_UTF8_CODEC));
+					parse(r);
+					r.close();
+				}
+			}
+			zif.close();
+		}catch (ZipException e){
+			finalMessage = MyLocale.getMsg(1614,"Error while unzipping udpate file");
+			success = false;
+		}catch (IOException e){
+			if (e.getMessage().equalsIgnoreCase("no updates available")) { finalMessage = "No updates available"; success = false; }
+			else {
+				if (e.getMessage().equalsIgnoreCase("could not connect") ||
+						e.getMessage().equalsIgnoreCase("unkown host")) { // is there a better way to find out what happened?
+					finalMessage = MyLocale.getMsg(1616,"Error: could not download udpate file from opencaching.de");
+				} else { finalMessage = "IOException: "+e.getMessage(); }
+				success = false;
+			}
+		}catch (IllegalArgumentException e) {
+			finalMessage = MyLocale.getMsg(1621,"Error parsing update file\n this is likely a bug in opencaching.de\nplease try again later\n, state:")+" "+state+", waypoint: "+ holder.getWayPoint();
+			success = false;
+			Vm.debug("Parse error: " + state + " " + holder.getWayPoint());
+			e.printStackTrace();
+		}catch (Exception e){ // here should be used the correct exception
+			if (holder != null)	finalMessage = MyLocale.getMsg(1615,"Error parsing update file, state:")+" "+state+", waypoint: "+ holder.getWayPoint();
+			else finalMessage = MyLocale.getMsg(1615,"Error parsing update file, state:")+" "+state+", waypoint: <unkown>";
+			success = false;
+			Vm.debug("Parse error: " + state + " Exception:" + e.toString()+"   "+holder.getOcCacheID());
+			e.printStackTrace();
+		} finally {
+			if (tmpFile != null) tmpFile.delete();
+		}
+		/*
+		for (int i=cacheDB.size()-1; i >=0; i--) {
+			ch = (CacheHolder)cacheDB.get(i);
+			if (ch.wayPoint.toUpperCase().startsWith("OC")) { //TODO only handle changed caches
+				ch.calcRecommendationScore();
+			}
+		} */
+		inf.setInfo(finalMessage);
+
+		return success;
+	}
+
+	public void startElement(String name, AttributeList atts){
+		if (debugGPX){
+			for (int i = 0; i < atts.getLength(); i++) {
+				Vm.debug(" Name: " + atts.getName(i)+ " Value: "+atts.getValue(i));
+			}
+		}
+		strData ="";
+
+		if (name.equals("oc11xml")){
+			Time lastSync = new Time();
+			try {
+				lastSync.parse(atts.getValue("date"),"yyyy-MM-dd HH:mm:ss");
+			}catch (IllegalArgumentException e){ // TODO Fehler werfen
+				Vm.debug(e.toString());
+			}
+			// reduce time at 1 second to avoid sync problems
+			lastSync.setTime(lastSync.getTime() - 1000);
+			dateOfthisSync = lastSync;
+			state = STAT_INIT;
+		}
+
+		// look for changes in the state
+		if (name.equals("cache")) 		{ state = STAT_CACHE; numCacheImported++;}
+		if (name.equals("cachedesc")) 	{ state = STAT_CACHE_DESC; numDescImported++;}
+		if (name.equals("cachelog")) 	{ state = STAT_CACHE_LOG; numLogImported++; logtype = 0;}
+		if (name.equals("picture")) 	{ state = STAT_PICTURE; }
+
+		//examine data
+		switch (state) {
+		case STAT_CACHE: startCache(name, atts); break;
+		case STAT_CACHE_DESC: startCacheDesc(name, atts); break; 
+		case STAT_CACHE_LOG: startCacheLog(name, atts); break;
+		case STAT_PICTURE: startPicture(name,atts); break;
+		}
+
+	}
+
+	public void endElement(String name){
+		//examine data
+		switch (state) {
+		case STAT_CACHE: endCache(name); break;
+		case STAT_CACHE_DESC: endCacheDesc(name);break;
+		case STAT_CACHE_LOG: endCacheLog(name); break;
+		case STAT_PICTURE: endPicture(name); break;
+		}
+
+		// look for changes in the state
+		if (name.equals("cache")) 		state = STAT_INIT;
+		if (name.equals("cachedesc")) 	state = STAT_INIT;
+		if (name.equals("cachelog")) 	state = STAT_INIT;
+		if (name.equals("picture")) 	state = STAT_INIT;
+
+	}
+
+	public void characters(char[] ch2,int start,int length){
+		String chars = new String(ch2,start,length);
+		strData += chars;
+		if (debugGPX) Vm.debug(strData);
+	}
+
+	private void startCache(String name, AttributeList atts){
+		inf.setInfo(MyLocale.getMsg(1609,"Importing Cache:")+" " + numCacheImported + "\n");
+		if(name.equals("id")){
+			cacheID = atts.getValue("id");
+		}
+		if(name.equals("type")){
+			holder.setType(CacheType.ocType2CwType(atts.getValue("id")));
+			return;
+		}
+		if(name.equals("status")){
+			if(atts.getValue("id").equals("1")) holder.setAvailable(true);
+			if(atts.getValue("id").equals("2")) holder.setAvailable(false);
+			if(atts.getValue("id").equals("3")) {
+				holder.setArchived(true);
+				holder.setAvailable(false);
+			}
+			if(atts.getValue("id").equals("4")) holder.setAvailable(false);
+			return;
+		}
+		if(name.equals("size")){
+			holder.setCacheSize(CacheSize.ocXmlString2Cw(atts.getValue("id")));
+			return;
+		}
+
+		if(name.equals("waypoints")){
+			holder.setWayPoint(atts.getValue("oc"));
+			if (holder.getWayPoint().length()==0) throw new IllegalArgumentException("empty waypointname"); // this should not happen - it is likey a bug in opencaching.de / it happens on 27-12-2006 on cache OC143E
+			return;
+		}
+
+	}
+	private void startCacheDesc(String name, AttributeList atts){
+		inf.setInfo(MyLocale.getMsg(1611,"Importing cache description:")+" " + numDescImported);
+		if (name.equals("cachedesc")){
+			ignoreDesc = false;
+		}
+
+		if (name.equals("desc")){
+			holder.setHTML(atts.getValue("html").equals("1")?true:false);
+		}
+
+		if (name.equals("language") && !atts.getValue("id").equals("DE")){
+			if (holder.getFreshDetails().LongDescription.length()> 0) ignoreDesc = true; // TODO "DE" in preferences adjustable
+			else ignoreDesc = false;
+		}
+	}
+
+	private void startPicture(String name, AttributeList atts){
+		if(name.equals("picture")){
+			inf.setInfo(MyLocale.getMsg(1613,"Pictures:")+" " + ++picCnt);
+		}
+	}
+
+	private void startCacheLog(String name, AttributeList atts){
+		inf.setInfo(MyLocale.getMsg(1612,"Importing Cachlog:")+" " + numLogImported);
+		if (name.equals("logtype")){
+			logtype = Convert.toInt(atts.getValue("id"));
+			switch (logtype) {
+			case 1: 
+				logIcon = GPXImporter.typeText2Image("Found");
+				break;
+			case 2:	logIcon = GPXImporter.typeText2Image("Not Found"); 
+			holder.setNoFindLogs((byte)(holder.getNoFindLogs()+1));
+			break;
+			case 3: logIcon = GPXImporter.typeText2Image("Note");
+			}
+			loggerRecommended = atts.getValue("recommended").equals("1");
+			return;
+		}
+		
+		if (name.equals("id")){
+			logId = atts.getValue("id");
+		}
+	}
+
+	// TODO Do we have to release the "holder" cache details ?
+	private void endCache(String name){
+		if (name.equals("cache")){
+			holder.setLastSync(dateOfthisSync.format("yyyyMMddHHmmss"));
+			int index;
+			index = cacheDB.getIndex(holder.getWayPoint());
+			if (index == -1){
+				holder.setNew(true);
+				cacheDB.add(holder);
+				Integer indexInt = new Integer(cacheDB.size()-1);
+				DBindexID.put(holder.getOcCacheID(), indexInt);
+			}
+			// update (overwrite) data
+			else {
+				holder.setNew(false);
+				holder.setIncomplete(false);
+				cacheDB.get(index).update(holder);
+				// save ocCacheID, in case, the previous data is from GPX
+				DBindexID.put(holder.getOcCacheID(), new Integer(index));
+			}
+			// clear data (picture, logs) if we do a complete Update
+			if (incUpdate == false){
+				holder.getFreshDetails().CacheLogs.clear();
+				holder.getFreshDetails().Images.clear();
+				holder.getFreshDetails().ImagesText.clear();
+				holder.getFreshDetails().ImagesInfo.clear();
+			}
+
+			// save all
+			holder.getFreshDetails().hasUnsavedChanges = true; // this makes CachHolder save the details in case that they are unloaded from memory
+			// chD.saveCacheDetails(profile.dataDir); 
+			// profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR); // this is done after .xml is completly processed
+			return;
+		}
+		if(name.equals("id")){ // </id>
+			holder = getHolder(strData); // Allocate a new CacheHolder object
+			holder.setOcCacheID(strData);
+			holder.getFreshDetails().URL = ocSeekUrl + cacheID;
+			return;
+		}
+
+		if(name.equals("name")){
+			holder.setCacheName(strData);
+			return;
+		}
+		if(name.equals("userid")) {
+			holder.setCacheOwner(strData);
+			if(holder.getCacheOwner().equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()>0 && holder.getCacheOwner().equalsIgnoreCase(pref.myAlias2))) holder.setOwned(true);
+			return;
+		}
+
+		if(name.equals("longitude")){
+			longitude = Common.parseDouble(strData);
+			return;
+		}
+		if(name.equals("latitude")) {
+			holder.pos.set(Common.parseDouble(strData),longitude);
+			holder.LatLon = holder.pos.toString();
+			return;
+		}
+		if(name.equals("difficulty")) {
+			holder.setHard(CacheTerrDiff.v1Converter(strData));
+			return;
+		}
+		if(name.equals("terrain")) {
+			holder.setTerrain(CacheTerrDiff.v1Converter(strData));
+			return;
+		}
+		if(name.equals("datehidden")) {
+			holder.setDateHidden(strData.substring(0,10)); //Date;
+			return;
+		}
+		if (name.equals("country")){
+			holder.getFreshDetails().Country = strData;
+			return;
+		}
+	}
+
+	private void endCacheDesc(String name){
+
+		if (!ignoreDesc){
+			if (name.equals("cachedesc")){
+				if (pref.downloadPics && holder.is_HTML()) {
+					String fetchUrl, imgTag, imgAltText;
+					Regex imgRegexUrl = new Regex("(<img[^>]*src=[\"\']([^>^\"^\']*)[^>]*>|<img[^>]*src=([^>^\"^\'^ ]*)[^>]*>)"); //  Ergebnis enth?lt keine Anf?hrungszeichen
+					Regex imgRegexAlt = new Regex("(?:alt=[\"\']([^>^\"^\']*)|alt=([^>^\"^\'^ ]*))"); // get alternative text for Pic
+					imgRegexAlt.setIgnoreCase(true);
+					imgRegexUrl.setIgnoreCase(true);
+					int descIndex=0;
+					int numDownloaded=1;
+					while (imgRegexUrl.searchFrom(holder.getFreshDetails().LongDescription, descIndex)) { // "img" found
+						imgTag=imgRegexUrl.stringMatched(1); // (1) enth?lt das gesamte <img ...>-tag
+						fetchUrl=imgRegexUrl.stringMatched(2); // URL in Anf?hrungszeichen in (2) falls ohne in (3) Ergebnis ist auf jeden Fall ohne Anf?hrungszeichen 
+						if (fetchUrl==null) { fetchUrl=imgRegexUrl.stringMatched(3); }
+						if (fetchUrl==null) { // TODO Fehler ausgeben: nicht abgedeckt ist der Fall, dass in einem Cache Links auf Bilder mit unterschiedlichen URL, aber gleichem Dateinamen sind.
+							inf.addWarning(MyLocale.getMsg(1617, "Ignoriere Fehler in html-Cache-Description: \"<img\" without \"src=\" in cache "+holder.getWayPoint()));
+							continue;
+						}
+						inf.setInfo(MyLocale.getMsg(1611,"Importing cache description:")+" " + numDescImported + "\n"+MyLocale.getMsg(1620, "downloading embedded images: ") + numDownloaded++);
+						if (imgRegexAlt.search(imgTag)) {
+							imgAltText=imgRegexAlt.stringMatched(1);
+							if (imgAltText==null)	imgAltText=imgRegexAlt.stringMatched(2);
+							// kein alternativer Text als Bild?berschrift -> Dateiname
+						} else { 
+							if (fetchUrl.toLowerCase().indexOf("opencaching.de") > 0 || fetchUrl.toLowerCase().indexOf("geocaching.com") > 0) //wenn von Opencaching oder geocaching ist Dateiname doch nicht so toll, weil nur aus Nummer bestehend 
+								imgAltText = new String("No image title");
+							else imgAltText = fetchUrl.substring(fetchUrl.lastIndexOf("/")+1);
+						}
+						descIndex = imgRegexUrl.matchedTo();
+						getPic(fetchUrl, imgAltText);
+					}
+				}
+				holder.getFreshDetails().hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
+				return;
+			}
+
+
+			if (name.equals("cacheid")){
+				// load cachedata
+				holder = getHolder(strData);
+				holder.setUpdated(true);
+				return;
+			}
+
+			if (name.equals("shortdesc")){
+				holder.getFreshDetails().LongDescription = strData;
+				return;
+			}
+
+			if (name.equals("desc")){ // </desc>
+				if (holder.is_HTML())	holder.getFreshDetails().LongDescription +=SafeXML.cleanback(strData);
+				else holder.getFreshDetails().LongDescription +=strData;
+				return;
+			}
+			if (name.equals("hint")){
+				holder.getFreshDetails().Hints = Common.rot13(strData);
+				return;
+			}
+		}
+	}
+
+	private String createPicFilename(String fetchURL) {
+		String fileName = holder.getWayPoint() + "_" + fetchURL.substring(fetchURL.lastIndexOf("/")+1);
+		return Common.ClearForFileName(fileName);
+	}
+	
+	private void getPic(String fetchURL, String picDesc) { // TODO handling of relativ URLs
+		try {
+			if (!fetchURL.startsWith("http://")) fetchURL = new URL(new URL("http://" + OPENCACHING_HOST+"/"), fetchURL).toString(); // TODO this is not quite correct: actually the "base" URL must be known... but anyway a different baseURL should not happen very often  - it doesn't in my area
+			String fileName = createPicFilename(fetchURL);
+			// add title
+			holder.getFreshDetails().ImagesText.add(picDesc);
+			holder.getFreshDetails().ImagesInfo.add(null); // need to stay in sync with ImagesText
+			try {
+				File ftest = new File(profile.dataDir + fileName);
+				if (ftest.exists()){
+					holder.getFreshDetails().Images.add(fileName);
+				}
+				else {
+					if (pref.downloadPics) {
+						holder.getFreshDetails().Images.add(fetch(fetchURL, fileName));
+					}
+				}
+			} catch (IOException e) {
+				String ErrMessage = new String (MyLocale.getMsg(1618,"Ignoring error in cache: ") + holder.getWayPoint() + ": ignoring IOException: "+e.getMessage()+ " while downloading picture:"+fileName+" from URL:"+fetchURL); 
+				if (e.getMessage().toLowerCase().equalsIgnoreCase("could not connect") ||
+						e.getMessage().equalsIgnoreCase("unkown host")) { // is there a better way to find out what happened?
+					ErrMessage = MyLocale.getMsg(1618,"Ignoring error in cache: ")+holder.getCacheName() + " ("+holder.getWayPoint()+")"+MyLocale.getMsg(1619,": could not download image from URL: ")+fetchURL;
+				} 
+				inf.addWarning("\n"+ErrMessage);
+				//(new MessageBox(MyLocale.getMsg(144, "Warning"), ErrMessage, MessageBox.OKB)).exec();
+				pref.log(ErrMessage);
+				e.printStackTrace();
+			}
+		} catch (MalformedURLException e) {
+			String ErrMessage = new String (MyLocale.getMsg(1618,"Ignoring error in cache: ") + holder.getWayPoint() + ": ignoring MalformedUrlException: " + e.getMessage()+ " while downloading from URL:" + fetchURL); 
+			inf.addWarning("\n"+ErrMessage);
+			pref.log(ErrMessage);
+		}
+
+	}
+
+
+	private void endPicture(String name){
+
+		if(name.equals("id")){
+			picID = strData;
+			return;
+		}
+
+		if (name.equals("url")){
+			picUrl = strData;
+			return;
+		}
+		if (name.equals("title")){
+			picTitle = strData;
+			return;
+		}
+		if(name.equals("object")){
+			// get cachedata
+			holder = getHolder(strData);
+			return;
+		}
+		if(name.equals("picture")){ 
+			//String fileName = holder.wayPoint + "_" + picUrl.substring(picUrl.lastIndexOf("/")+1);
+			getPic(picUrl,picTitle);
+			holder.getFreshDetails().hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
+			return;
+		}
+	}
+
+	private void endCacheLog(String name){
+		if (name.equals("cachelog")){ // </cachelog>
+			holder.getFreshDetails().CacheLogs.merge(new Log(logIcon, logDate, logFinder, logData, loggerRecommended));
+			if((logFinder.toLowerCase().compareTo(user) == 0 || logFinder.equalsIgnoreCase(pref.myAlias2)) && logtype == 1) {
+						holder.setCacheStatus(logDate);
+						holder.setFound(true);
+						holder.getFreshDetails().OwnLogId = logId;
+						holder.getFreshDetails().OwnLog = new Log(logIcon, logDate, logFinder, logData, loggerRecommended);
+			}
+			holder.getFreshDetails().hasUnsavedChanges = true; //chD.saveCacheDetails(profile.dataDir);
+			return;
+		}
+
+		if (name.equals("cacheid")){ // </cacheid>
+			// load cachedata
+			holder = getHolder(strData);
+			return;
+		}
+
+		if (name.equals("date"))  {
+			logDate = new String(strData);
+			return;
+		}
+		if (name.equals("userid")){
+			logFinder = new String(strData);
+			return;
+		}
+		if (name.equals("text")){ 
+			logData = new String(strData);
+			return;
+		}
+
+	}
+
+	private String fetch(String addr, String fileName ) throws IOException
+	{
+		//Vm.debug("Redirect: " + redirect);
+		CharArray realurl = new CharArray();
+		ByteArray daten = UrlFetcher.fetchByteArray(addr, realurl);
+		String address = realurl.toString();
+		if (holder != null) fileName = holder.getWayPoint() + "_" + Common.ClearForFileName(address.substring(address.lastIndexOf("/")+1));
+		// else fileName = Common.ClearForFileName(address.substring(address.lastIndexOf("/")+1));
+
+		//save file
+		//Vm.debug("Save: " + myPref.mydatadir + fileName);
+		//Vm.debug("Daten: " + daten.length);
+		FileOutputStream outp =  new FileOutputStream(profile.dataDir + fileName);
+		outp.write(daten.toBytes());
+		outp.close();
+		return fileName;
+	}
+
+
+	/**
+	 * Method to iterate through cache database and look for cacheID.
+	 * Returns value >= 0 if cacheID is found, else -1
+	 */
+	private int searchID(String cacxheID){
+		Integer INTR = (Integer)DBindexID.get(cacxheID);
+		if(INTR != null){
+			return INTR.intValue();
+		} else return -1;
+	}
+
+
+	private CacheHolder getHolder(String wpt){// See also LOCXMLImporter
+		CacheHolder chx;
+		int index;
+		
+		index = cacheDB.getIndex(wpt);
+		if (index == -1) index = searchID(wpt);
+		if (index == -1) {
+			chx = new CacheHolder();
+		} else {
+			chx = cacheDB.get(index);
+		}
+		return chx;
+	}
+
+}


Property changes on: trunk/src/CacheWolf/imp/OCXMLImporter.java
___________________________________________________________________
Name: svn:mergeinfo
   + 

Copied: trunk/src/CacheWolf/imp/OCXMLImporterScreen.java (from rev 1941, trunk/src/CacheWolf/OCXMLImporterScreen.java)
===================================================================
--- trunk/src/CacheWolf/OCXMLImporterScreen.java	2009-06-24 17:27:40 UTC (rev 1941)
+++ trunk/src/CacheWolf/imp/OCXMLImporterScreen.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -0,0 +1,212 @@
+/**
+ * 
+ */
+package CacheWolf.imp;
+
+import CacheWolf.CacheType;
+import CacheWolf.Common;
+import CacheWolf.Global;
+import CacheWolf.MyLocale;
+import CacheWolf.Preferences;
+import CacheWolf.imp.SpiderGC.SpiderProperties;
+import ewe.sys.Convert;
+import ewe.ui.*;
+
+/**
+ * @author pfeffer
+ * This Class is the Dialog for Download from Opencaching.de 
+ * is called from OCXMLImporter
+ * 20061209 Bugfix: Checking for uninitialised missingCheckBox
+ */
+public class OCXMLImporterScreen extends Form {
+	mButton cancelB, okB;
+	Preferences pref;
+	mChoice chcType;
+	mInput distanceInput;
+	mInput maxNumberInput;
+	mInput maxLogsInput;
+	mCheckBox imagesCheckBox, /*mapsCheckBox, */ missingCheckBox, foundCheckBox, travelbugsCheckBox;
+	mLabel distLbl;
+	mLabel maxNumberLbl;
+	mLabel distUnit;
+	boolean isGC = true;
+	static int DIST = 1;
+	public static int IMAGES = 2;
+	static int ALL = 4;
+	static int INCLUDEFOUND = 8;
+	static int ISGC = 16;
+	static int MAXNUMBER = 32;
+	public static int TRAVELBUGS = 64;
+	public static int MAXLOGS = 128;
+	static int TYPE = 256;
+
+	
+	public OCXMLImporterScreen(String title, int options) {
+		super();
+		pref = Global.getPref(); // myPreferences sollte sp?ter auch diese Einstellungen speichern
+		
+		isGC = ((options & ISGC) > 0);
+		
+		this.title = title;
+				
+		if ((options & TYPE) > 0) {
+			this.addLast( chcType = new mChoice(new String[] {
+					MyLocale.getMsg(1627,"All caches"),	
+					CacheType.CW_GUISTR_TRADI,
+					CacheType.CW_GUISTR_MULTI,
+					CacheType.CW_GUISTR_VIRTUAL,
+					CacheType.CW_GUISTR_LETTERBOX,
+					CacheType.CW_GUISTR_EVENT,
+					CacheType.CW_GUISTR_MEGAEVENT,
+					CacheType.CW_GUISTR_WEBCAM,
+					CacheType.CW_GUISTR_UNKNOWN,
+					CacheType.CW_GUISTR_CITO,
+					CacheType.CW_GUISTR_EARTH,
+					CacheType.CW_GUISTR_WHEREIGO
+				},0), CellConstants.STRETCH, (CellConstants.FILL|CellConstants.WEST));
+		}
+
+		if ((options & DIST) > 0) {
+			this.addNext(distLbl = new mLabel(MyLocale.getMsg(1601,"Distance:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+			distanceInput = new mInput();
+			String dist1;
+			String dist2;
+			if (isGC) {
+				dist1 = Global.getProfile().getDistGC();
+				dist2 = Global.getProfile().getDistOC();
+			} else {
+				dist1 = Global.getProfile().getDistOC();
+				dist2 = Global.getProfile().getDistGC();
+			}
+			if ( dist1.equals("") || dist1.equals("0") || dist1.equals("0.0") ) {
+				dist1 = dist2;
+			}
+			distanceInput.setText(dist1);
+			this.addNext(distanceInput,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+			this.addLast(distUnit = new mLabel(" km/mi."),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		}
+		
+		if ((options & MAXNUMBER) > 0) {
+			this.addNext(maxNumberLbl = new mLabel(MyLocale.getMsg(1623,"Max. number:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+			maxNumberInput = new mInput();
+			if ( pref.maxSpiderNumber < 0 ) {
+				maxNumberInput.setText("");
+			} else {
+				maxNumberInput.setText(Integer.toString(pref.maxSpiderNumber));
+			}
+			this.addNext(maxNumberInput,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+			this.addLast( new mLabel(MyLocale.getMsg(1624," caches")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		}
+		
+		if ((options & MAXLOGS) > 0) {
+			this.addNext(new mLabel(MyLocale.getMsg(1626,"Max. logs:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+			maxLogsInput = new mInput();
+			maxLogsInput.setText(Convert.toString(pref.maxLogsToSpider));
+			this.addLast(maxLogsInput,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		}
+
+		if ((options & IMAGES) > 0) {
+			imagesCheckBox = new mCheckBox();
+			imagesCheckBox.setText(MyLocale.getMsg(1602,"Download Images"));
+			imagesCheckBox.setState(pref.downloadPics);
+			this.addLast(imagesCheckBox, CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST);
+		}
+		
+		if ((options & TRAVELBUGS) > 0) {
+			travelbugsCheckBox = new mCheckBox();
+			travelbugsCheckBox.setText(MyLocale.getMsg(1625,"Download TBs"));
+			travelbugsCheckBox.setState(pref.downloadTBs);
+			this.addLast(travelbugsCheckBox, CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST);
+		}
+		
+		if((options & INCLUDEFOUND) > 0){
+			foundCheckBox = new mCheckBox();
+			foundCheckBox.setText(MyLocale.getMsg(1622,"Exclude found caches"));
+			foundCheckBox.setState(true);
+			this.addLast(foundCheckBox, CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST);
+		}
+
+		if((options & ALL) > 0){
+			missingCheckBox = new mCheckBox();
+			missingCheckBox.setText(MyLocale.getMsg(1606,"Alle erneut downloaden"));
+			missingCheckBox.setState(pref.downloadmissingOC);
+			this.addLast(missingCheckBox, CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST);
+		}
+
+		cancelB = new mButton(MyLocale.getMsg(1604,"Cancel"));
+		cancelB.setHotKey(0, IKeys.ESCAPE);
+		this.addNext(cancelB,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		okB = new mButton(MyLocale.getMsg(1605,"OK"));
+		okB.setHotKey(0, IKeys.ACTION);
+		okB.setHotKey(0, IKeys.ENTER);
+		this.addLast(okB,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+	}
+	public void onEvent(Event ev){
+		if (ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED){
+			if (ev.target == cancelB){
+				this.close(FormBase.IDCANCEL);
+			}
+			if (ev.target == okB){
+				    // distOC wird hier noch nicht in Pref eingetragen, damit noch gepr?ft werden kann, ob es gr??er oder kleiner ist als vorher
+					if (imagesCheckBox!=null) pref.downloadPics = imagesCheckBox.state;
+					if (missingCheckBox!=null) pref.downloadmissingOC = missingCheckBox.state;
+					if (travelbugsCheckBox!=null) pref.downloadTBs = travelbugsCheckBox.state;
+					if (maxLogsInput!=null) pref.maxLogsToSpider=Common.parseInt(maxLogsInput.getText());
+					pref.savePreferences();
+				this.close(FormBase.IDOK);
+				}
+		}
+		super.onEvent(ev);
+	}
+	
+	public String getCacheTypeRestriction(SpiderProperties p){
+		String cacheTypeRestriction = "";
+
+		if (chcType!=null){
+			try {
+				switch (chcType.getInt()) {
+				case  0:
+					cacheTypeRestriction = "";
+					break;
+				case  1: 
+					cacheTypeRestriction = p.getProp("onlyTraditional");
+					break;
+				case  2:
+					cacheTypeRestriction = p.getProp("onlyMulti");
+					break;
+				case  3:
+					cacheTypeRestriction = p.getProp("onlyVirtual") ;
+					break;
+				case  4:
+					cacheTypeRestriction = p.getProp("onlyLetterboxHybrid");
+					break;
+				case  5:
+					cacheTypeRestriction = p.getProp("onlyEvent");
+					break;
+				case  6:
+					cacheTypeRestriction = p.getProp("onlyMegaEvent");
+					break;
+				case  7:
+					cacheTypeRestriction = p.getProp("onlyWebcam");
+					break;
+				case  8:
+					cacheTypeRestriction = p.getProp("onlyUnknown");
+					break;
+				case 9:
+					cacheTypeRestriction = p.getProp("onlyCito");
+					break;
+				case 10:
+					cacheTypeRestriction = p.getProp("onlyEarth");
+					break;
+				case 11:
+					cacheTypeRestriction = p.getProp("onlyWherigo");
+					break;
+				default:
+					cacheTypeRestriction = "";
+				}
+			}catch (Exception ex) { // Some tag missing from spider.def
+			}
+		}
+		return cacheTypeRestriction;
+	}
+}


Property changes on: trunk/src/CacheWolf/imp/OCXMLImporterScreen.java
___________________________________________________________________
Name: svn:mergeinfo
   + 

Copied: trunk/src/CacheWolf/imp/SpiderGC.java (from rev 1949, trunk/src/CacheWolf/SpiderGC.java)
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2009-06-26 17:05:17 UTC (rev 1949)
+++ trunk/src/CacheWolf/imp/SpiderGC.java	2009-06-26 18:53:49 UTC (rev 1950)
@@ -0,0 +1,1697 @@
+/*
+    CacheWolf is a software for PocketPC, Win and Linux that
+    enables paperless caching.
+    It supports the sites geocaching.com and opencaching.de
+
+    Copyright (C) 2006  CacheWolf development team
+    See http://developer.berlios.de/projects/cachewolf/
+    for more information.
+    Contact: 	bilbowolf at users.berlios.de
+		kalli at users.berlios.de
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation version 2 of the License.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
+    */
+
+package CacheWolf.imp;
+import ewe.net.*;
+import ewe.io.*;
+import ewe.sys.*;
+import ewe.sys.Double;
+import ewe.util.*;
+import CacheWolf.CWPoint;
+import CacheWolf.CacheDB;
+import CacheWolf.CacheHolder;
+import CacheWolf.CacheHolderDetail;
+import CacheWolf.CacheSize;
+import CacheWolf.CacheTerrDiff;
+import CacheWolf.CacheType;
+import CacheWolf.Common;
+import CacheWolf.DateFormat;
+import CacheWolf.Extractor;
+import CacheWolf.Global;
+import CacheWolf.HttpConnection;
+import CacheWolf.InfoBox;
+import CacheWolf.Log;
+import CacheWolf.LogList;
+import CacheWolf.MyLocale;
+import CacheWolf.Preferences;
+import CacheWolf.Profile;
+import CacheWolf.STRreplace;
+import CacheWolf.SafeXML;
+import CacheWolf.Travelbug;
+import CacheWolf.navi.Metrics;
+
+import com.stevesoft.ewe_pat.*;
+import ewe.ui.*;
+import ewe.data.Property;
+import ewe.data.PropertyList;
+
+/**
+*	Class to spider caches from gc.com
+*/
+public class SpiderGC{
+
+	/**
+	 * The maximum number of logs that will be stored
+	 */
+	public static int MAXLOGS=250; // Can be pre-set from preferences
+	public static String passwort = ""; // Can be pre-set from preferences
+	public static boolean loggedIn = false;
+
+	private static int ERR_LOGIN = -10;
+	private static Preferences pref;
+	private Profile profile;
+	private static String viewstate = "";
+	private static String viewstate1 = "";
+	private static String eventvalidation = "";
+	private static String cookieID = "";
+	private static String cookieSession = "";
+	private static double distance = 0;
+	private Regex inRex = new Regex();
+	private CacheDB cacheDB;
+	private Vector cachesToLoad = new Vector();
+	private InfoBox infB;
+	private static SpiderProperties p=null;
+
+	public SpiderGC(Preferences prf, Profile profile, boolean bypass){
+		this.profile=profile;
+		this.cacheDB = profile.cacheDB;
+		pref = prf;
+		if (p==null) {
+			pref.logInit();
+			p=new SpiderProperties();
+		}
+		MAXLOGS=pref.maxLogsToSpider;
+	}
+
+	/**
+	 * Method to login the user to gc.com
+	 * It will request a password and use the alias defined in preferences
+	 * If the login page cannot be fetched, the password is cleared.
+	 * If the login fails, an appropriate message is displayed.
+	 */
+	public int login(){
+		loggedIn = false;
+		String start,loginPage,loginSuccess,nextPage;
+		try {
+			loginPage=p.getProp("loginPage");
+			loginSuccess=p.getProp("loginSuccess");
+			nextPage=p.getProp("nextPage");
+		} catch (Exception ex) { // Tag not found in spider.def
+			return ERR_LOGIN;
+		}
+		//Get password
+		InfoBox localInfB = new InfoBox(MyLocale.getMsg(5506,"Password"), MyLocale.getMsg(5505,"Enter Password"), InfoBox.INPUT);
+		localInfB.feedback.setText(passwort); // Remember the PWD for next time
+		localInfB.feedback.isPassword=true;
+		int code=FormBase.IDOK;
+		if (passwort.equals("")) {
+			code = localInfB.execute();
+			passwort = localInfB.getInput();
+		}
+		localInfB.close(0);
+		if(code != FormBase.IDOK) return code;
+		// Now start the login proper
+		localInfB = new InfoBox(MyLocale.getMsg(5507,"Status"), MyLocale.getMsg(5508,"Logging in..."));
+		localInfB.exec();
+		try{
+			pref.log("[login]:Fetching login page");
+			//Access the page once to get a viewstate
+			start = fetch(loginPage);   //http://www.geocaching.com/login/Default.aspx
+			if (start.equals("")) {
+				localInfB.close(0);
+				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5499,"Error loading login page.%0aPlease check your internet connection."), FormBase.OKB)).execute();
+				pref.log("[login]:Could not fetch: gc.com login page");
+				return ERR_LOGIN;
+			}
+		} catch(Exception ex){
+			localInfB.close(0);
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5499,"Error loading login page.%0aPlease check your internet connection."), FormBase.OKB)).execute();
+			pref.log("[login]:Could not fetch: gc.com login page",ex);
+			return ERR_LOGIN;
+		}
+		if (!localInfB.isClosed) { // If user has not aborted, we continue
+			Regex rexCookieID = new Regex("(?i)Set-Cookie: userid=(.*?);.*");
+			Regex rexViewstate = new Regex("id=\"__VIEWSTATE\" value=\"(.*?)\" />");
+			Regex rexViewstate1 = new Regex("id=\"__VIEWSTATE1\" value=\"(.*?)\" />");
+			Regex rexEventvalidation = new Regex("id=\"__EVENTVALIDATION\" value=\"(.*?)\" />");
+			Regex rexCookieSession = new Regex("(?i)Set-Cookie: ASP.NET_SessionId=(.*?);.*");
+			rexViewstate.search(start);
+			if(rexViewstate.didMatch()){
+				viewstate = rexViewstate.stringMatched(1);
+				//Vm.debug("ViewState: " + viewstate);
+			} else
+				pref.log("[login]:Viewstate not found before login");
+
+			if(start.indexOf(loginSuccess) > 0)
+				pref.log("[login]:Already logged in");
+			else {
+				rexEventvalidation.search(start);
+				if(rexEventvalidation.didMatch()){
+					eventvalidation = rexEventvalidation.stringMatched(1);
+					//Vm.debug("EVENTVALIDATION: " + eventvalidation);
+				} else
+					pref.log("[login]:Eventvalidation not found before login");
+				//Ok now login!
+				try{
+					pref.log("[login]:Logging in as "+pref.myAlias);
+					StringBuffer sb=new StringBuffer(1000);
+					sb.append(URL.encodeURL("__VIEWSTATE",false));	sb.append("="); sb.append(URL.encodeURL(viewstate,false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("myUsername",false));
+					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(pref.myAlias)));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("myPassword",false));
+					sb.append("="); sb.append(encodeUTF8URL(Utils.encodeJavaUtf8String(passwort)));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("cookie",false));
+					sb.append("="); sb.append(URL.encodeURL("on",false));
+					sb.append("&ctl00%24ContentBody%24"); sb.append(URL.encodeURL("Button1",false));
+					sb.append("="); sb.append(URL.encodeURL("Login",false));
+//					sb.append("&"); sb.append(URL.encodeURL("__EVENTVALIDATION",false));
+//					sb.append("="); sb.append(URL.encodeURL(eventvalidation,false));
+					start = fetch_post(loginPage, sb.toString(), nextPage);  // /login/default.aspx
+					if(start.indexOf(loginSuccess) > 0)
+						pref.log("[login]:Login successful");
+					else {
+						pref.log("[login]:Login failed. Wrong Account or Password?");
+						if (pref.debug) {
+							pref.log("[login.LoginUrl]:"+sb.toString());
+							pref.log("[login.Answer]:"+start);
+						}
+						localInfB.close(0);
+						(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed! Wrong account or password?"), FormBase.OKB)).execute();
+						return ERR_LOGIN;
+					}
+				}catch(Exception ex){
+					pref.log("[login]:Login failed with exception.", ex);
+					localInfB.close(0);
+					(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed. Error loading page after login."), FormBase.OKB)).execute();
+					return ERR_LOGIN;
+				}
+			}
+
+			rexViewstate.search(start);
+			if (!rexViewstate.didMatch()) {
+				pref.log("[login]:Viewstate not found");
+			}
+			viewstate = rexViewstate.stringMatched(1);
+
+			rexViewstate1.search(start);
+			if (!rexViewstate1.didMatch()) {
+				pref.log("[login]:Viewstate1 not found");
+			}
+			viewstate1 = rexViewstate1.stringMatched(1);
+
+			rexCookieID.search(start);
+			if (!rexCookieID.didMatch()) {
+				pref.log("[login]:CookieID not found. Using old one.");
+			} else
+				cookieID = rexCookieID.stringMatched(1);
+			//Vm.debug(cookieID);
+			rexCookieSession.search(start);
+			if (!rexCookieSession.didMatch()) {
+				pref.log("[login]:CookieSession not found. Using old one.");
+				//cookieSession="";
+			} else
+				cookieSession = rexCookieSession.stringMatched(1);
+			//Vm.debug("cookieSession = " + cookieSession);
+		}
+		boolean loginAborted=localInfB.isClosed;
+		localInfB.close(0);
+		if (loginAborted)
+			return FormBase.IDCANCEL;
+		else {
+			loggedIn = true;
+			return FormBase.IDOK;
+		}
+	}
+
+	/**
+	 * Method to spider a single cache.
+	 * It assumes a login has already been performed!
+	 * @return 1 if spider was successful, -1 if spider was cancelled by closing the infobox, 0 error, but continue with next cache
+	 */
+	public int spiderSingle(int number, InfoBox pInfB, boolean forceLogin){
+		int ret=-1;
+		this.infB = pInfB;
+		CacheHolder ch = new CacheHolder(); // cacheDB.get(number);
+		ch.setWayPoint(cacheDB.get(number).getWayPoint());
+		if (ch.isAddiWpt()) return -1;  // No point re-spidering an addi waypoint, comes with parent
+
+		// check if we need to login
+		if (!loggedIn || forceLogin){
+			if (this.login()!=FormBase.IDOK) return -1;
+			// loggedIn is already set by this.login()
+		}
+		try{
+			// Read the cache data from GC.COM and compare to old data
+			boolean loadAllLogs = (MAXLOGS > 5);
+			ret=getCacheByWaypointName(ch,true,pref.downloadPics,pref.downloadTBs,false,loadAllLogs);
+			// Save the spidered data
+			if (ret == 1) {
+				CacheHolder cacheInDB = cacheDB.get(number);
+				cacheInDB.initStates(false);
+				if (cacheInDB.is_found() && !ch.is_found() && ! loadAllLogs) {
+					// If the number of logs to spider is 5 or less, then the "not found" information
+					// of the spidered cache is not credible. In this case it should not overwrite
+					// the "found" state of an existing cache.
+					ch.setFound(true);
+				}
+				cacheInDB.update(ch);
+				cacheInDB.save();
+			}
+		}catch(Exception ex){
+			pref.log("Error spidering " + ch.getWayPoint() + " in spiderSingle");
+		}
+		return ret;
+	} // spiderSingle
+
+	/**
+	 * Fetch the coordinates of a waypoint from GC
+	 * @param wayPoint the name of the waypoint
+	 * @return the cache coordinates
+	 */
+	public String getCacheCoordinates(String wayPoint) {
+		String completeWebPage;
+		// Check whether spider definitions could be loaded, if not issue appropriate message and terminate
+		// Try to login. If login fails, issue appropriate message and terminate
+		if (!loggedIn || Global.getPref().forceLogin) {
+			if (login()!=FormBase.IDOK) {
+				return "";
+			}
+		}
+		InfoBox localInfB = new InfoBox("Info", "Loading", InfoBox.PROGRESS_WITH_WARNINGS);
+		localInfB.exec();
+		try{
+			String doc = p.getProp("waypoint") + wayPoint;
+			pref.log("Fetching: " + wayPoint);
+			completeWebPage = fetch(doc);
+		}catch(Exception ex){
+			localInfB.close(0);
+			pref.log("Could not fetch " + wayPoint,ex);
+			return "";
+		}
+		localInfB.close(0);
+		try {
+			return getLatLon(completeWebPage);
+		} catch (Exception ex) {
+			return "????";
+		}
+	}
+
+	/**
+	*	Method to start the spider for a search around the centre coordinates
+	*/
+	public void doIt(){
+		doIt(false);
+	}
+	public void doIt(boolean spiderAllFinds){
+		String postStr, dummy, ln, wpt;
+		Regex lineRex;
+		CacheHolder holder;
+		CWPoint origin = pref.curCentrePt; // No need to copy curCentrePt as it is only read and not written
+		if ( !spiderAllFinds && !origin.isValid()) {
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5509,"Coordinates for centre must be set"), FormBase.OKB)).execute();
+			return;
+		}
+		if (System.getProperty("os.name")!=null)pref.log("Operating system: "+System.getProperty("os.name")+"/"+System.getProperty("os.arch"));
+		if (System.getProperty("java.vendor")!=null)pref.log("Java: "+System.getProperty("java.vendor")+"/"+System.getProperty("java.version"));
+		CacheHolder ch;
+		// Reset states for all caches when spidering (http://tinyurl.com/dzjh7p)
+		for(int i = 0; i<cacheDB.size();i++){
+			ch = cacheDB.get(i);
+			if (ch.mainCache==null) ch.initStates(false);
+		}
+		String start = "";
+		Regex rexViewstate = new Regex("id=\"__VIEWSTATE\" value=\"(.*)\" />");
+		Regex rexViewstate1 = new Regex("id=\"__VIEWSTATE1\" value=\"(.*)\" />");
+		Regex rexEventvalidation = new Regex("id=\"__EVENTVALIDATION\" value=\"(.*)\" />");
+		String doc = "";
+
+		if (!loggedIn || Global.getPref().forceLogin) {
+			if(login() != FormBase.IDOK) return;
+		}
+
+		boolean doNotgetFound = false;
+
+		OCXMLImporterScreen options;
+		if (spiderAllFinds) {
+			options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"), OCXMLImporterScreen.MAXNUMBER|OCXMLImporterScreen.IMAGES| OCXMLImporterScreen.ISGC| OCXMLImporterScreen.TRAVELBUGS| OCXMLImporterScreen.MAXLOGS| OCXMLImporterScreen.TYPE);
+			if (options.execute() == FormBase.IDCANCEL) {return; }
+
+			distance = 1;
+		} else {
+			options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"),	OCXMLImporterScreen.MAXNUMBER|OCXMLImporterScreen.INCLUDEFOUND | OCXMLImporterScreen.DIST| OCXMLImporterScreen.IMAGES| OCXMLImporterScreen.ISGC| OCXMLImporterScreen.TRAVELBUGS| OCXMLImporterScreen.MAXLOGS| OCXMLImporterScreen.TYPE);
+			if (options.execute() == FormBase.IDCANCEL) {return; }
+			String dist = options.distanceInput.getText();
+			if (dist.length()== 0) return;
+			distance = Common.parseDouble(dist);
+
+			//save last radius to profile
+			Double distDouble = new Double();
+			distDouble.value = distance;
+			dist = distDouble.toString(0, 1, 0).replace(',', '.');
+			profile.setDistGC(dist);
+
+			doNotgetFound = options.foundCheckBox.getState();
+		}
+
+		int maxNumber = -1;
+		String maxNumberString = options.maxNumberInput.getText();
+		if (maxNumberString.length()!= 0) {
+			maxNumber = Common.parseInt(maxNumberString);
+		}
+		if (maxNumber != pref.maxSpiderNumber) {
+			pref.maxSpiderNumber = maxNumber;
+			pref.savePreferences();
+		}
+		if (maxNumber == 0) return;
+		boolean maxNumberAbort = false;
+
+		boolean getImages = options.imagesCheckBox.getState();
+		boolean getTBs = options.travelbugsCheckBox.getState();
+
+		String cacheTypeRestriction = options.getCacheTypeRestriction(p);
+
+		options.close(0);
+
+		//max distance in miles for URL, so we can get more than 80km
+		double saveDistanceInMiles = distance;
+		if ( Global.getPref().metricSystem != Metrics.IMPERIAL ) {
+			saveDistanceInMiles = Metrics.convertUnit(distance, Metrics.KILOMETER, Metrics.MILES);
+		}
+		// add a mile to be save from different distance calculations in CW and at GC
+		saveDistanceInMiles = java.lang.Math.ceil(saveDistanceInMiles) + 1;
+
+		Hashtable cachesToUpdate = new Hashtable(cacheDB.size());
+		double distanceInKm = distance;
+		if ( Global.getPref().metricSystem == Metrics.IMPERIAL ) {
+			distanceInKm = Metrics.convertUnit(distance, Metrics.MILES, Metrics.KILOMETER);
+		}
+		for(int i = 0; i<cacheDB.size();i++){
+			ch = cacheDB.get(i);
+			if (spiderAllFinds) {
+				if ( (ch.getWayPoint().substring(0,2).equalsIgnoreCase("GC")) ) {
+					cachesToUpdate.put(ch.getWayPoint(), ch);
+				}
+			} else {
+				if ( (!ch.is_archived()) && (ch.kilom <= distanceInKm) && !(doNotgetFound && ch.is_found()) && (ch.getWayPoint().substring(0,2).equalsIgnoreCase("GC")) ) {
+					cachesToUpdate.put(ch.getWayPoint(), ch);
+				}
+			}
+		}
+
+		//=======
+		// Prepare list of all caches that are to be spidered
+		//=======
+		Vm.showWait(true);
+		infB = new InfoBox("Status", MyLocale.getMsg(5502,"Fetching first page..."));
+		infB.exec();
+		//Get first page
+		try{
+			if (spiderAllFinds) {
+				ln = p.getProp("firstPageFinds") + encodeUTF8URL(Utils.encodeJavaUtf8String(pref.myAlias));
+			} else {
+				ln = p.getProp("firstPage") + origin.getLatDeg(CWPoint.DD) + p.getProp("firstPage2") + origin.getLonDeg(CWPoint.DD)
+			                              + p.getProp("maxDistance") + Integer.toString( (int)saveDistanceInMiles );
+				if(doNotgetFound) ln = ln + p.getProp("showOnlyFound");
+			}
+			ln = ln + cacheTypeRestriction;
+			pref.log("Getting first page: "+ln);
+			start = fetch(ln);
+			pref.log("Got first page");
+		}catch(Exception ex){
+			pref.log("Error fetching first list page",ex,true);
+			Vm.showWait(false);
+			infB.close(0);
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5503,"Error fetching first list page."), FormBase.OKB)).execute();
+			return;
+		}
+		dummy = "";
+		//String lineBlck = "";
+		int page_number = 4;
+		try  {
+			lineRex = new Regex(p.getProp("lineRex")); //"<tr bgcolor=((?s).*?)</tr>"
+		} catch (Exception ex) {
+			infB.close(0);
+			Vm.showWait(false);
+			return;
+		}
+		int page = 0;
+		int found_on_page = 0;
+		try {
+			//Loop till maximum distance has been found or no more caches are in the list
+			while(distance > 0){
+				if (infB.isClosed) break;
+
+				rexViewstate.search(start);
+				if(rexViewstate.didMatch()){
+					viewstate = rexViewstate.stringMatched(1);
+					//Vm.debug("ViewState: " + viewstate);
+				} else {
+					viewstate = "";
+					pref.log("Viewstate not found");
+				}
+
+				rexViewstate1.search(start);
+				if(rexViewstate1.didMatch()){
+					viewstate1 = rexViewstate1.stringMatched(1);
+					//Vm.debug("ViewState: " + viewstate);
+				} else {
+					viewstate1 = "";
+					pref.log("Viewstate1 not found");
+				}
+
+				rexEventvalidation.search(start);
+				if(rexEventvalidation.didMatch()){
+					eventvalidation = rexEventvalidation.stringMatched(1);
+					//Vm.debug("EVENTVALIDATION: " + eventvalidation);
+				} else {
+					eventvalidation = "";
+					pref.log("Eventvalidation not found");
+				}
+
+				//Vm.debug("In loop");
+				Regex listBlockRex = new Regex(p.getProp("listBlockRex")); // "<table id=\"dlResults\"((?s).*?)</table>"
+				listBlockRex.search(start);
+				dummy = listBlockRex.stringMatched(1);
+				try{
+					lineRex.search(dummy);
+				}catch(NullPointerException nex){
+					Global.getPref().log("Ignored Exception", nex, true);
+				}
+				while(lineRex.didMatch()){
+					//Vm.debug(getDist(lineRex.stringMatched(1)) + " / " +getWP(lineRex.stringMatched(1)));
+					found_on_page++;
+					if(getDist(lineRex.stringMatched(1)) <= distance){
+						String waypoint=getWP(lineRex.stringMatched(1));
+						CacheHolder existingCache;
+						if((existingCache=cacheDB.get(waypoint)) == null){
+							if ( (maxNumber > 0) && (cachesToLoad.size() >= maxNumber) ) {
+								maxNumberAbort = true;
+
+								//add no more caches
+								distance = 0;
+
+								//don't update existing caches, because list is not correct when aborting
+								cachesToUpdate.clear();
+							} else {
+								cachesToLoad.add(waypoint);
+							}
+						} else {
+							pref.log(waypoint+" already in DB");
+							ch=existingCache;
+							// If the <strike> tag is used, the cache is marked as unavailable or archived
+							boolean is_archived_GC=lineRex.stringMatched(1).indexOf("<strike><font color=\"red\">")!=-1;
+							boolean is_available_GC=lineRex.stringMatched(1).indexOf("<strike>")==-1;
+							if (ch.is_archived()!=is_archived_GC) { // Update the database with the cache status
+								pref.log("Updating status of "+waypoint+" to "+(is_archived_GC?"archived":"not archived"));
+								if ( ch.is_archived() ) {
+									cachesToUpdate.put(ch.getWayPoint(), ch);
+								}
+								ch.setArchived(is_archived_GC);
+							} else if (ch.is_available()!=is_available_GC) { // Update the database with the cache status
+								pref.log("Updating status of "+waypoint+" to "+(is_available_GC?"available":"not available"));
+								ch.setAvailable(is_available_GC);
+							} else if (spiderAllFinds && !ch.is_found()) { // Update the database with the cache status
+								pref.log("Updating status of "+waypoint+" to found");
+								ch.setFound(true);
+							} else {
+								cachesToUpdate.remove( ch.getWayPoint() );
+							}
+						}
+					} else distance = 0;
+					lineRex.searchFrom(dummy, lineRex.matchedTo());
+				}
+
+				page++;
+				infB.setInfo(MyLocale.getMsg(5521,"Page ") + page + "\n" + MyLocale.getMsg(5511,"Found ") + cachesToLoad.size() + MyLocale.getMsg(5512," caches"));
+
+				if(found_on_page < 20) distance = 0;
+				if (spiderAllFinds) {
+					postStr = p.getProp("firstLine");
+				} else {
+					postStr = p.getProp("firstLine") + origin.getLatDeg(CWPoint.DD) + "&" + origin.getLonDeg(CWPoint.DD)
+							                             + p.getProp("maxDistance") + Integer.toString( (int)saveDistanceInMiles );
+					if(doNotgetFound) postStr = postStr + p.getProp("showOnlyFound");
+				}
+				postStr = postStr + cacheTypeRestriction;
+				if(distance > 0){
+					page_number++;
+					if(page_number >= 15) page_number = 5;
+					String strNextPage;
+					if (page_number < 10) {
+						strNextPage = "ctl00$ContentBody$pgrTop$ctl0" + page_number;
+					} else {
+						strNextPage = "ctl00$ContentBody$pgrTop$ctl" + page_number;
+					}
+					doc = URL.encodeURL("__EVENTTARGET",false) +"="+ URL.encodeURL(strNextPage,false)
+					    + "&" + URL.encodeURL("__EVENTARGUMENT",false) +"="+ URL.encodeURL("",false)
+					    + "&" + URL.encodeURL("__VIEWSTATEFIELDCOUNT",false) +"=2"
+					    + "&" + URL.encodeURL("__VIEWSTATE",false) +"="+ URL.encodeURL(viewstate,false)
+					    + "&" + URL.encodeURL("__VIEWSTATE1",false) +"="+ URL.encodeURL(viewstate1,false);
+//					    + "&" + URL.encodeURL("__EVENTVALIDATION",false) +"="+ URL.encodeURL(eventvalidation,false);
+					try{
+						start = "";
+						pref.log("Fetching next list page:" + doc);
+						start = fetch_post(postStr, doc, p.getProp("nextListPage"));
+					}catch(Exception ex){
+						//Vm.debug("Couldn't get the next page");
+						pref.log("Error getting next page");
+					}
+				}
+				//Vm.debug("Distance is now: " + distance);
+				found_on_page = 0;
+			}
+		} catch (Exception ex) { // Some tag missing from spider.def
+			infB.close(0);
+			Vm.showWait(false);
+			return;
+		}
+		pref.log("Found " + cachesToLoad.size() + " new caches");
+		pref.log("Found " + cachesToUpdate.size() + " caches for update");
+		if (!infB.isClosed) infB.setInfo(MyLocale.getMsg(5511,"Found ") + cachesToLoad.size() + MyLocale.getMsg(5512," caches"));
+
+		//=======
+		// Now ready to spider each cache in the list
+		//=======
+		boolean loadAllLogs = (MAXLOGS > 5);
+
+		int spiderErrors = 0;
+
+		if ( cachesToUpdate.size() > 0 ) {
+			switch (pref.spiderUpdates) {
+			case Preferences.NO:
+				cachesToUpdate.clear();
+				break;
+			case Preferences.ASK:
+				MessageBox mBox = new MessageBox(MyLocale.getMsg(5517,"Spider Updates?"), cachesToUpdate.size() + MyLocale.getMsg(5518," caches in database need an update. Update now?") , FormBase.IDYES |FormBase.IDNO);
+				if (mBox.execute() != FormBase.IDOK){
+					cachesToUpdate.clear();
+				}
+				break;
+			}
+		}
+
+		int totalCachesToLoad = cachesToLoad.size() + cachesToUpdate.size();
+
+		for(int i = 0; i<cachesToLoad.size(); i++){
+			if (infB.isClosed) break;
+
+			wpt = (String)cachesToLoad.get(i);
+			// Get only caches not already available in the DB
+			if(cacheDB.getIndex(wpt) == -1){
+				infB.setInfo(MyLocale.getMsg(5513,"Loading: ") + wpt +" (" + (i+1) + " / " + totalCachesToLoad + ")");
+				holder = new CacheHolder();
+				holder.setWayPoint(wpt);
+				int test = getCacheByWaypointName(holder,false,getImages,getTBs,doNotgetFound,loadAllLogs);
+				if (test == -1) {
+					infB.close(0);
+					break;
+				} else if (test == 0) {
+					spiderErrors++;
+				} else {
+					if (!holder.is_found() || !doNotgetFound ) {
+						cacheDB.add(holder);
+						holder.save();
+					}
+				}
+			}
+		}
+
+		if (!infB.isClosed) {
+			int j = 1;
+			for (Enumeration e = cachesToUpdate.elements() ; e.hasMoreElements() ; j++) {
+				ch = (CacheHolder)e.nextElement();
+				infB.setInfo(MyLocale.getMsg(5513,"Loading: ") + ch.getWayPoint() +" (" + (cachesToLoad.size()+j) + " / " + totalCachesToLoad + ")");
+				infB.redisplay();
+
+				int test = spiderSingle(cacheDB.getIndex(ch), infB,false);
+				if (test == -1) {
+					break;
+				} else if (test == 0) {
+					spiderErrors++;
+				} else {
+					//profile.hasUnsavedChanges=true;
+				}
+			}
+		}
+
+		infB.close(0);
+		Vm.showWait(false);
+		if ( spiderErrors > 0) {
+			new MessageBox(MyLocale.getMsg(5500,"Error"),spiderErrors + MyLocale.getMsg(5516," cache descriptions%0acould not be loaded."),FormBase.DEFOKB).execute();
+		}
+		if ( maxNumberAbort ) {
+			new MessageBox(MyLocale.getMsg(5519,"Information"),MyLocale.getMsg(5520,"Only the given maximum of caches were loaded.%0aRepeat spidering later to load more caches.%0aNo already existing caches were updated."),FormBase.DEFOKB).execute();
+		}
+		Global.getProfile().restoreFilter();
+		Global.getProfile().saveIndex(Global.getPref(),true);
+	}
+
+	/**
+	 * Read a complete cachepage from geocaching.com including all logs. This is used both when
+	 * updating already existing caches (via spiderSingle) and when spidering around a centre. It
+	 * is also used when reading a GPX file and fetching the images.
+	 *
+	 * This is the workhorse function of the spider.
+	 *
+	 * @param CacheHolderDetail chD The element wayPoint must be set to the name of a waypoint
+	 * @param boolean isUpdate True if an existing cache is being updated, false if it is a new cache
+	 * @param boolean fetchImages True if the pictures are to be fetched
+	 * @param boolean fetchTBs True if the TBs are to be fetched
+	 * @param boolean doNotGetFound True if the cache is not to be spidered if it has already been found
+	 * @param boolean fetchAllLogs True if all logs are to be fetched (by adding option '&logs=y' to command line).
+	 *     This is normally false when spidering from GPXImport as the logs are part of the GPX file, and true otherwise
+	 * @return -1 if the infoBox was closed (cancel spidering), 0 if there was an error (continue with next cache), 1 if everything ok
+	 */
+	private int getCacheByWaypointName(CacheHolder ch, boolean isUpdate, boolean fetchImages, boolean fetchTBs, boolean doNotGetFound, boolean fetchAllLogs) {
+		int ret = 1;
+		while (true) {
+			String completeWebPage;
+			int spiderTrys=0;
+			int MAX_SPIDER_TRYS=3;
+			while (spiderTrys++<MAX_SPIDER_TRYS) {
+				ret = 1;
+				try{
+					String doc = p.getProp("getPageByName") + ch.getWayPoint() +(fetchAllLogs?p.getProp("fetchAllLogs"):"");
+					pref.log("Fetching: " + ch.getWayPoint());
+					completeWebPage = fetch(doc);
+					if	( completeWebPage.equals("")) {
+						pref.log("Could not fetch " + ch.getWayPoint());
+						if (!infB.isClosed) {
+							continue;
+						} else {
+							ch.setIncomplete(true);
+							return -1;
+						}
+					}
+				}catch(Exception ex){
+					pref.log("Could not fetch " + ch.getWayPoint(),ex);
+					if (!infB.isClosed) {
+						continue;
+					} else {
+						ch.setIncomplete(true);
+						return -1;
+					}
+				}
+				// Only analyse the cache data and fetch pictures if user has not closed the progress window
+				if (!infB.isClosed) {
+					try{
+						ch.initStates(!isUpdate);
+
+						//first check if coordinates are available to prevent deleting existing coorinates
+						String latLon = getLatLon(completeWebPage);
+						if (latLon.equals("???")) {
+							pref.log(">>>> Failed to spider Cache. Retry.");
+							ret = 0;
+							continue; // Restart the spider
+						}
+
+						ch.setHTML(true);
+						ch.setAvailable(true);
+						ch.setArchived(false);
+						ch.setIncomplete(true);
+						// Save size of logs to be able to check whether any new logs were added
+						//int logsz = chD.CacheLogs.size();
+						//chD.CacheLogs.clear();
+						ch.addiWpts.clear();
+						ch.getFreshDetails().Images.clear();
+						ch.getFreshDetails().ImagesText.clear();
+						ch.getFreshDetails().ImagesInfo.clear();
+
+						if(completeWebPage.indexOf(p.getProp("cacheUnavailable")) >= 0) ch.setAvailable(false);
+						if(completeWebPage.indexOf(p.getProp("cacheArchived")) >= 0) ch.setArchived(true);
+						//==========
+						// General Cache Data
+						//==========
+						ch.setLatLon(latLon);
+						pref.log("LatLon: " + ch.LatLon);
+						if (pref.debug) pref.log("chD.pos: " + ch.pos.toString());
+
+						pref.log("Trying description");
+						ch.getFreshDetails().setLongDescription(getLongDesc(completeWebPage));
+						pref.log("Got description");
+
+						pref.log("Getting cache name");
+						ch.setCacheName(SafeXML.cleanback(getName(completeWebPage)));
+						if (pref.debug) pref.log("Name: " + ch.getCacheName()); else pref.log("Got name");
+
+						pref.log("Trying location (country/state)");
+						String location = getLocation(completeWebPage);
+						if (location.length() != 0) {
+							int countryStart = location.indexOf(",");
+							if (countryStart > -1) {
+								ch.getFreshDetails().Country = SafeXML.cleanback(location.substring(countryStart + 1).trim());
+								ch.getFreshDetails().State = SafeXML.cleanback(location.substring(0, countryStart).trim());
+							} else {
+								ch.getFreshDetails().Country = location.trim();
+								ch.getFreshDetails().State = "";
+							}
+							pref.log("Got location (country/state)");
+						} else {
+							ch.getFreshDetails().Country = "";
+							ch.getFreshDetails().State = "";
+							pref.log("No location (country/state) found");
+						}
+
+						pref.log("Trying owner");
+						ch.setCacheOwner(SafeXML.cleanback(getOwner(completeWebPage)).trim());
+						if(ch.getCacheOwner().equals(pref.myAlias) || (pref.myAlias2.length()>0 && ch.getCacheOwner().equals(pref.myAlias2))) ch.setOwned(true);
+						if (pref.debug) pref.log("Owner: " + ch.getCacheOwner() +"; is_owned = "+ch.is_owned()+";  alias1,2 = ["+pref.myAlias+"|"+pref.myAlias2+"]");
+						else pref.log("Got owner");
+
+
+						pref.log("Trying date hidden");
+						ch.setDateHidden(DateFormat.MDY2YMD(getDateHidden(completeWebPage)));
+						if (pref.debug) pref.log("Hidden: " + ch.getDateHidden());
+						else pref.log("Got date hidden");
+
+						pref.log("Trying hints");
+						ch.getFreshDetails().setHints(getHints(completeWebPage));
+						if (pref.debug) pref.log("Hints: " + ch.getFreshDetails().Hints);
+						else pref.log("Got hints");
+
+						pref.log("Trying size");
+						ch.setCacheSize(CacheSize.gcSpiderString2Cw(getSize(completeWebPage)));
+						if (pref.debug) pref.log("Size: " + ch.getCacheSize());
+						else pref.log("Got size");
+
+						pref.log("Trying difficulty");
+						ch.setHard(CacheTerrDiff.v1Converter(getDiff(completeWebPage)));
+						if (pref.debug) pref.log("Hard: " + ch.getHard());
+						else pref.log("Got difficulty");
+
+						pref.log("Trying terrain");
+						ch.setTerrain(CacheTerrDiff.v1Converter(getTerr(completeWebPage)));
+						if (pref.debug) pref.log("Terr: " + ch.getTerrain());
+						else pref.log("Got terrain");
+
+						pref.log("Trying cache type");
+						ch.setType(getType(completeWebPage));
+						if (pref.debug) pref.log("Type: " + ch.getType());
+						else pref.log("Got cache type");
+
+						//==========
+						// Logs
+						//==========
+						pref.log("Trying logs");
+						ch.getFreshDetails().setCacheLogs(getLogs(completeWebPage, ch.getFreshDetails()));
+						pref.log("Found logs");
+
+						// If the switch is set to not store found caches and we found the cache => return
+						if (ch.is_found() && doNotGetFound) {
+							if (infB.isClosed) {
+								return -1;
+							} else {
+								return 1;
+							}
+						}
+
+						//==========
+						// Bugs
+						//==========
+						// As there may be several bugs, we check whether the user has aborted
+						if (!infB.isClosed && fetchTBs) getBugs(ch.getFreshDetails(),completeWebPage);
+						ch.setHas_bugs(ch.getFreshDetails().Travelbugs.size()>0);
+
+						//==========
+						// Images
+						//==========
+						if(fetchImages){
+							pref.log("Trying images");
+							getImages(completeWebPage, ch.getFreshDetails());
+							pref.log("Got images");
+						}
+						//==========
+						// Addi waypoints
+						//==========
+
+						pref.log("Getting additional waypoints");
+						getAddWaypoints(completeWebPage, ch.getWayPoint(), ch.is_found());
+						pref.log("Got additional waypoints");
+
+						//==========
+						// Attributes
+						//==========
+						pref.log("Getting attributes");
+						getAttributes(completeWebPage, ch.getFreshDetails());
+						pref.log("Got attributes");
+						//if (ch.is_new()) ch.setUpdated(false);
+						//==========
+						// Last sync date
+						//==========
+						ch.setLastSync((new Time()).format("yyyyMMddHHmmss"));
+
+						ch.setIncomplete(false);
+						break;
+					}catch(Exception ex){
+						pref.log("Error reading cache: "+ch.getWayPoint());
+						pref.log("Exception in getCacheByWaypointName: ",ex);
+					}
+				} else {
+					break;
+				}
+			} // spiderTrys
+			if ( ( spiderTrys >= MAX_SPIDER_TRYS ) && ( ret == 1 ) ) {
+				pref.log(">>> Failed to spider cache. Number of retrys exhausted.");
+				int decision = (new MessageBox(MyLocale.getMsg(5500,"Error"),MyLocale.getMsg(5515,"Failed to load cache.%0aPleas check your internet connection.%0aRetry?"),FormBase.DEFOKB|FormBase.NOB|FormBase.CANCELB)).execute();
+				if ( decision == FormBase.IDOK ) {
+					continue;
+				} else if ( decision == FormBase.IDNO ){
+					ret = 0;
+				} else {
+					ret = -1;
+				}
+			}
+			break;
+		}//while(true)
+		if (infB.isClosed) {// If the infoBox was closed before getting here, we return -1
+			return -1;
+		}
+		return ret;
+	} // getCacheByWaypointName
+
+
+	/**
+	 * Get the Distance to the centre
+	 * @param doc A previously fetched cachepage
+	 * @return Distance
+	 */
+	private double getDist(String doc) throws Exception {
+		inRex = new Regex(p.getProp("distRex"));
+		inRex.search(doc);
+		if(doc.indexOf("Here") >= 0) return(0);
+		if (!inRex.didMatch()) return 0;
+		if(MyLocale.getDigSeparator().equals(",")) return Convert.toDouble(inRex.stringMatched(1).replace('.',','));
+		return Convert.toDouble(inRex.stringMatched(1));
+	}
+
+	/**
+	 * Get the waypoint name
+	 * @param doc A previously fetched cachepage
+	 * @return Name of waypoint to add to list
+	 */
+	private String getWP(String doc) throws Exception {
+		inRex = new Regex(p.getProp("waypointRex"));
+		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
+		return "GC"+inRex.stringMatched(1);
+	}
+
+	/**
+	 * Get the coordinates of the cache
+	 * @param doc A previously fetched cachepage
+	 * @return Cache coordinates
+	 */
+	private String getLatLon(String doc) throws Exception{
+		inRex = new Regex(p.getProp("latLonRex"));
+		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
+		return inRex.stringMatched(1);
+	}
+
+	/**
+	 * Get the long description
+	 * @param doc A previously fetched cachepage
+	 * @return the long description
+	 */
+	private String getLongDesc(String doc) throws Exception{
+		String res = "";
+		inRex = new Regex(p.getProp("shortDescRex"));
+		Regex rex2 = new Regex(p.getProp("longDescRex"));
+		inRex.search(doc);
+		rex2.search(doc);
+		res = ((inRex.stringMatched(1)==null)?"":inRex.stringMatched(1)) + "<br>";
+		res += rex2.stringMatched(1);
+		return res; // SafeXML.cleanback(res);
+	}
+
+	/**
+	 * Get the cache location (country and state)
+	 * @param doc A previously fetched cachepage
+	 * @return the location (country and state) of the cache
+	 */
+	private String getLocation(String doc) throws Exception{
+		inRex = new Regex(p.getProp("cacheLocationRex"));
+		inRex.search(doc);
+		if (!inRex.didMatch()) return "";
+
+		return inRex.stringMatched(1);
+	}
+
+	/**
+	 * Get the cache name
+	 * @param doc A previously fetched cachepage
+	 * @return the name of the cache
+	 */
+	private String getName(String doc) throws Exception{
+		inRex = new Regex(p.getProp("cacheNameRex"));
+		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
+		return inRex.stringMatched(1);
+	}
+
+	/**
+	 * Get the cache owner
+	 * @param doc A previously fetched cachepage
+	 * @return the cache owner
+	 */
+	private String getOwner(String doc) throws Exception{
+		inRex = new Regex(p.getProp("cacheOwnerRex"));
+		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
+		return inRex.stringMatched(1);
+	}
+
+	/**
+	 * Get the date when the cache was hidden
+	 * @param doc A previously fetched cachepage
+	 * @return Hidden date
+	 */
+	private String getDateHidden(String doc) throws Exception{
+		inRex = new Regex(p.getProp("dateHiddenRex"));
+		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
+		return inRex.stringMatched(1);
+	}
+
+	/**
+	 * Get the hints
+	 * @param doc A previously fetched cachepage
+	 * @return Cachehints
+	 */
+	private String getHints(String doc) throws Exception{
+		inRex = new Regex(p.getProp("hintsRex"));
+		inRex.search(doc);
+		if (!inRex.didMatch()) return "";
+		return inRex.stringMatched(1);
+	}
+
+	/**
+	 * Get the cache size
+	 * @param doc A previously fetched cachepage
+	 * @return Cache size
+	 */
+	private String getSize(String doc) throws Exception{
+		inRex = new Regex(p.getProp("sizeRex"));
+		inRex.search(doc);
+		if(inRex.didMatch()) return inRex.stringMatched(1);
+		else return "None";
+	}
+
+	/**
+	 * Get the Difficulty
+	 * @param doc A previously fetched cachepage
+	 * @return The cache difficulty
+	 */
+	private String getDiff(String doc) throws Exception{
+		inRex = new Regex(p.getProp("difficultyRex"));
+		inRex.search(doc);
+		if(inRex.didMatch()) return inRex.stringMatched(1);
+		else return "";
+	}
+
+	/**
+	 * Get the terrain rating
+	 * @param doc A previously fetched cachepage
+	 * @return Terrain rating
+	 */
+	private String getTerr(String doc) throws Exception{
+		inRex = new Regex(p.getProp("terrainRex"));
+		inRex.search(doc);
+		if(inRex.didMatch()) return inRex.stringMatched(1);
+		else return "";
+	}
+
+	/**
+	 * Get the waypoint type
+	 * @param doc A previously fetched cachepage
+	 * @return the waypoint type (Tradi, Multi, etc.)
+	 */
+	private byte getType(String doc) throws Exception {
+		inRex = new Regex(p.getProp("cacheTypeRex"));
+		inRex.search(doc);
+		if(inRex.didMatch()) return CacheType.gcSpider2CwType(inRex.stringMatched(1));
+		else return 0;
+	}
+
+	/**
+	 * Get the logs
+	 * @param doc A previously fetched cachepage
+	 * @param chD Cache Details
+	 * @return A HTML string containing the logs
+	 */
+	private LogList getLogs(String doc, CacheHolderDetail chD) throws Exception {
+		String icon = "";
+		String name = "";
+		String logText = "";
+		String logId = "";
+		LogList reslts = new LogList();
+		Regex blockRex = new Regex(p.getProp("blockRex"));
+		blockRex.search(doc);
+		doc = blockRex.stringMatched(1);
+		String singleLog = "";
+		Extractor exSingleLog = new Extractor(doc,p.getProp("singleLogExStart"), p.getProp("singleLogExEnd"), 0, false); // maybe here is some change neccessary because findnext now gives the whole endstring back???
+		singleLog = exSingleLog.findNext();
+		Extractor exIcon = new Extractor(singleLog,p.getProp("iconExStart"), p.getProp("iconExEnd"), 0, true);
+		Extractor exNameTemp = new Extractor(singleLog,p.getProp("nameTempExStart"), p.getProp("nameTempExEnd"), 0 , true);
+		String nameTemp = "";
+		nameTemp = exNameTemp.findNext();
+		Extractor exName = new Extractor(nameTemp, p.getProp("nameExStart"), p.getProp("nameExEnd"), 0 , true);
+		Extractor exDate = new Extractor(singleLog,p.getProp("dateExStart"), p.getProp("dateExEnd"), 0 , true);
+		Extractor exLog = new Extractor(singleLog, p.getProp("logExStart"), p.getProp("logExEnd"), 0, true);
+		Extractor exLogId = new Extractor(singleLog, p.getProp("logIdExStart"), p.getProp("logIdExEnd"), 0, true);
+		//Vm.debug("Log Block: " + singleLog);
+		int nLogs=0;
+		while(exSingleLog.endOfSearch() == false){
+			nLogs++;
+			//Vm.debug("--------------------------------------------");
+			//Vm.debug("Log Block: " + singleLog);
+			//Vm.debug("Icon: "+exIcon.findNext());
+			//Vm.debug(exName.findNext());
+			//Vm.debug(exDate.findNext());
+			//Vm.debug(exLog.findNext());
+			//Vm.debug("--------------------------------------------");
+			icon = exIcon.findNext();
+			name = exName.findNext();
+			logText = exLog.findNext();
+			logId = exLogId.findNext();
+			String d=DateFormat.logdate2YMD(exDate.findNext());
+			if((icon.equals(p.getProp("icon_smile")) || icon.equals(p.getProp("icon_camera")) || icon.equals(p.getProp("icon_attended"))) &&
+				(name.equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()>0 && name.equalsIgnoreCase(pref.myAlias2))) )  {
+				chD.getParent().setFound(true);
+				chD.getParent().setCacheStatus(d);
+				chD.OwnLogId = logId;
+				chD.OwnLog = new Log(icon,d,name,logText);
+			}
+			if (nLogs<=MAXLOGS) reslts.add(new Log(icon,d,name,logText));
+
+			singleLog = exSingleLog.findNext();
+			exIcon.setSource(singleLog);
+			exNameTemp.setSource(singleLog);
+			nameTemp = exNameTemp.findNext();
+			exName.setSource(nameTemp);
+			exDate.setSource(singleLog);
+			exLog.setSource(singleLog);
+			exLogId.setSource(singleLog);
+			// We cannot simply stop if we have reached MAXLOGS just in case we are waiting for
+			// a log by our alias that happened earlier.
+			if (nLogs>=MAXLOGS && chD.getParent().is_found() && (chD.OwnLogId.length() != 0) && (chD.OwnLog != null) && !(chD.OwnLog.getDate().equals("1900-01-01"))) break;
+		}
+		if (nLogs>MAXLOGS) {
+			reslts.add(Log.maxLog());
+			pref.log("Too many logs. MAXLOGS reached ("+MAXLOGS+")");
+		} else
+			pref.log(nLogs+" logs found");
+		return reslts;
+	}
+
+	/**
+	 * Read the travelbug names from a previously fetched Cache page and then
+	 * read the travelbug purpose for each travelbug
+	 * @param doc The previously fetched cachepage
+	 * @return A HTML formatted string with bug names and there purpose
+	 */
+	public void getBugs(CacheHolderDetail chD, String doc) throws Exception{
+		Extractor exBlock = new Extractor(doc,p.getProp("blockExStart"),p.getProp("blockExEnd") ,0,Extractor.EXCLUDESTARTEND);
+		String bugBlock = exBlock.findNext();
+		//Vm.debug("Bugblock: "+bugBlock);
+		Extractor exBug = new Extractor(bugBlock,p.getProp("bugExStart"),p.getProp("bugExEnd"),0,Extractor.EXCLUDESTARTEND);
+		String link,bug,linkPlusBug,bugDetails;
+		String oldInfoBox=infB.getInfo();
+		chD.Travelbugs.clear();
+		while(exBug.endOfSearch() == false){
+			if (infB.isClosed) break; // Allow user to cancel by closing progress form
+			linkPlusBug= exBug.findNext();
+			int idx=linkPlusBug.indexOf("'>");
+			if (idx<0) break; // No link/bug pair found
+			link=linkPlusBug.substring(0,idx);
+			bug=linkPlusBug.substring(idx+2);
+			if(bug.length()>0) { // Found a bug, get its details
+				Travelbug tb=new Travelbug(bug);
+				try{
+					infB.setInfo(oldInfoBox+MyLocale.getMsg(5514,"\nGetting bug: ")+SafeXML.cleanback(bug));
+					pref.log("Fetching bug details: "+bug);
+					bugDetails = fetch(link);
+					Extractor exDetails = new Extractor(bugDetails,p.getProp("bugDetailsStart"),p.getProp("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
+					tb.setMission(exDetails.findNext());
+					Extractor exGuid = new Extractor(bugDetails,"details.aspx?guid=","\" id=\"aspnetForm",0,Extractor.EXCLUDESTARTEND); // TODO Replace with spider.def see also further down
+					tb.setGuid(exGuid.findNext());
+					chD.Travelbugs.add(tb);
+				}catch(Exception ex){
+					pref.log("Could not fetch bug details");
+				}
+			}
+			//Vm.debug("B: " + bug);
+			//Vm.debug("End? " + exBug.endOfSearch());
+		}
+		infB.setInfo(oldInfoBox);
+	}
+
+	/**
+	 * Get the images for a previously fetched cache page. Images are extracted
+	 * from two areas: The long description and the pictures section (including
+	 * the spoiler)
+	 * @param doc The previously fetched cachepage
+	 * @param chD The Cachedetails
+	 */
+	public void getImages(String doc, CacheHolderDetail chD){
+		int imgCounter = 0;
+		String imgName, oldImgName, imgType, imgUrl, imgComment;
+		Vector spideredUrls=new Vector(15);
+		Extractor exImgBlock,exImgComment;
+		int idxUrl; // Index of already spidered Url in list of spideredUrls
+		//========
+		//In the long description
+		//========
+		String longDesc = "";
+		try {
+			if (chD.getParent().getWayPoint().startsWith("TC")) longDesc = doc;
+			else
+				longDesc = getLongDesc(doc);
+			longDesc = STRreplace.replace(longDesc, "<img", "<IMG");
+			longDesc = STRreplace.replace(longDesc, "src=", "SRC=");
+			longDesc = STRreplace.replace(longDesc, "'", "\"");
+			exImgBlock = new Extractor(longDesc,p.getProp("imgBlockExStart"),p.getProp("imgBlockExEnd"), 0, false);
+		} catch (Exception ex) {//Missing property in spider.def
+			return;
+		}
+		//Vm.debug("In getImages: Have longDesc" + longDesc);
+		String tst;
+		tst = exImgBlock.findNext();
+		//Vm.debug("Test: \n" + tst);
+		Extractor exImgSrc = new Extractor(tst, "http://", "\"", 0, true);
+		while(exImgBlock.endOfSearch() == false){
+			imgUrl = exImgSrc.findNext();
+			//Vm.debug("Img Url: " +imgUrl);
+			if(imgUrl.length()>0){
+				imgUrl = "http://" + imgUrl;
+				try{
+					imgType = (imgUrl.substring(imgUrl.lastIndexOf(".")).toLowerCase()+"    ").substring(0,4).trim();
+					// imgType is now max 4 chars, starting with .
+					if(imgType.startsWith(".png") || imgType.startsWith(".jpg") || imgType.startsWith(".gif")){
+						// Check whether image was already spidered for this cache
+						idxUrl=spideredUrls.find(imgUrl);
+						imgName = chD.getParent().getWayPoint() + "_" + Convert.toString(imgCounter);
+						if (idxUrl<0) { // New image
+							pref.log("Loading image: " + imgUrl+" as "+imgName);
+							spiderImage(imgUrl, imgName+imgType);
+							chD.Images.add(imgName+imgType);
+							spideredUrls.add(imgUrl);
+						} else { // Image already spidered as wayPoint_'idxUrl'
+							pref.log("Already loaded image: " + imgUrl);
+							oldImgName = chD.getParent().getWayPoint() + "_" + Convert.toString(idxUrl);
+							chD.Images.add(oldImgName+imgType); // Store name of old image as image to load
+						}
+						chD.ImagesText.add(imgName); // Keep the image name
+						chD.ImagesInfo.add(null); // Need to stay in synch with ImagesText
+						imgCounter++;
+					}
+				} catch (IndexOutOfBoundsException e) {
+					//Vm.debug("IndexOutOfBoundsException not in image span"+e.toString()+"imgURL:"+imgUrl);
+					pref.log("Problem loading image. imgURL:"+imgUrl);
+				}
+				}
+			exImgSrc.setSource(exImgBlock.findNext());
+		}
+		//========
+		//In the image span
+		//========
+		Extractor spanBlock,exImgName;
+		try {
+			spanBlock = new Extractor(doc,p.getProp("imgSpanExStart"),p.getProp("imgSpanExEnd"), 0 , true);
+			tst = spanBlock.findNext();
+			exImgName = new Extractor(tst,p.getProp("imgNameExStart"),p.getProp("imgNameExEnd"), 0 , true);
+			exImgSrc = new Extractor(tst,p.getProp("imgSrcExStart"),p.getProp("imgSrcExEnd"), 0, true);
+			exImgComment = new Extractor(tst,p.getProp("imgCommentExStart"),p.getProp("imgCommentExEnd"), 0, true);
+		} catch (Exception ex) { // Missing property in spider .def
+			return;
+		}
+		while(exImgSrc.endOfSearch() == false){
+			imgUrl = exImgSrc.findNext();
+			imgComment = exImgComment.findNext();
+			//Vm.debug("Img Url: " +imgUrl);
+			if(imgUrl.length()>0){
+				imgUrl = "http://" + imgUrl;
+				try{
+					imgType = (imgUrl.substring(imgUrl.lastIndexOf(".")).toLowerCase()+"    ").substring(0,4).trim();
+					// imgType is now max 4 chars, starting with .
+					if(imgType.startsWith(".png") || imgType.startsWith(".jpg") || imgType.startsWith(".gif")){
+						// Check whether image was already spidered for this cache
+						idxUrl=spideredUrls.find(imgUrl);
+						imgName = chD.getParent().getWayPoint() + "_" + Convert.toString(imgCounter);
+						if (idxUrl<0) { // New image
+							pref.log("Loading image: " + imgUrl);
+							spiderImage(imgUrl, imgName+imgType);
+							chD.Images.add(imgName+imgType);
+						} else { // Image already spidered as wayPoint_ 'idxUrl'
+							pref.log("Already loaded image: " + imgUrl);
+							oldImgName = chD.getParent().getWayPoint() + "_" + Convert.toString(idxUrl);
+							chD.Images.add(oldImgName+imgType); // Store name of old image as image to load
+						}
+						chD.ImagesText.add(exImgName.findNext()); // Keep the image description
+						while (imgComment.startsWith("<br />")) imgComment=imgComment.substring(6);
+						while (imgComment.endsWith("<br />")) imgComment=imgComment.substring(0,imgComment.length()-6);
+						if (imgComment.length()==0)
+							chD.ImagesInfo.add(null);
+						else
+							chD.ImagesInfo.add(imgComment);
+						imgCounter++;
+					}
+				} catch (IndexOutOfBoundsException e) {
+					pref.log("IndexOutOfBoundsException in image span. imgURL:"+imgUrl,e);
+				}
+			}
+		}
+		//========
+		//Final sweep to check for images in hrefs
+		//========
+		Extractor exFinal = new Extractor(longDesc, "http://", "\"", 0, true);
+		while(exFinal.endOfSearch() == false){
+			imgUrl = exFinal.findNext();
+			if(imgUrl.length()>0){
+				imgUrl = "http://" + imgUrl;
+				try{
+					imgType = (imgUrl.substring(imgUrl.lastIndexOf(".")).toLowerCase()+"    ").substring(0,4).trim();
+					// imgType is now max 4 chars, starting with . Delete characters in URL after the image extension
+					imgUrl=imgUrl.substring(0,imgUrl.lastIndexOf(".")+imgType.length());
+					if( imgType.startsWith(".jpg") || imgType.startsWith(".bmp") || imgType.startsWith(".png") || imgType.startsWith(".gif")){
+						// Check whether image was already spidered for this cache
+						idxUrl=spideredUrls.find(imgUrl);
+						if (idxUrl<0) { // New image
+							imgName = chD.getParent().getWayPoint() + "_" + Convert.toString(imgCounter);
+							pref.log("Loading image: " + imgUrl+" as "+imgName);
+							spiderImage(imgUrl, imgName+imgType);
+							chD.Images.add(imgName+imgType);
+							spideredUrls.add(imgUrl);
+							chD.ImagesText.add(imgName); // Keep the image name
+							chD.ImagesInfo.add(null);
+							imgCounter++;
+						}
+					}
+				} catch (IndexOutOfBoundsException e) {
+					pref.log("Problem loading image. imgURL:"+imgUrl);
+				}
+			}
+		}
+	}
+
+
+	/**
+	 * Read an image from the server
+	 * @param imgUrl The Url of the image
+	 * @param target The bytes of the image
+	 */
+	private void spiderImage(String imgUrl, String target){ // TODO implement a fetch(URL, filename) in HttpConnection and use that one
+		HttpConnection connImg;
+		Socket sockImg;
+		//InputStream is;
+		FileOutputStream fos;
+		//int bytes_read;
+		//byte[] buffer = new byte[9000];
+		ByteArray daten;
+		String datei = "";
+		datei = profile.dataDir + target;
+		connImg = new HttpConnection(imgUrl);
+		if (imgUrl.indexOf('%')>=0) connImg.documentIsEncoded=true;
+		connImg.setRequestorProperty("Connection", "close");
+		//connImg.setRequestorProperty("User-Agent","Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.12) Gecko/20080201 Firefox/2.0.0.12");
+		//connImg.setRequestorProperty("Accept","text/xml,application/xml,application/xhtml+xml,text/html;q=0.9,text/plain;q=0.8,image/png,*/*;q=0.5");
+		try{
+			pref.log("Trying to fetch image from: " + imgUrl);
+			String redirect=null;
+			do {
+				sockImg = connImg.connect();
+				redirect=connImg.getRedirectTo();
+				if (redirect!=null) {
+					connImg=connImg.getRedirectedConnection(redirect);
+					pref.log("Redirect to "+redirect);
+				}
+			} while(redirect!=null); // TODO this can end up in an endless loop if trying to load from a malicous site
+			daten = connImg.readData(sockImg);
+			fos = new FileOutputStream(new File(datei));
+			fos.write(daten.toBytes());
+			fos.close();
+			sockImg.close();
+		} catch (UnknownHostException e) {
+			pref.log("Host not there...");
+		}catch(IOException ioex){
+			pref.log("File not found!");
+		} catch (Exception ex){
+			pref.log("Some other problem while fetching image",ex);
+		} finally {
+			//Continue with the spider
+		}
+	}
+
+	/**
+	 * Read all additional waypoints from a previously fetched cachepage.
+	 * @param doc The previously fetched cachepage
+	 * @param wayPoint The name of the cache
+	 * @param is_found Found status of the cached (is inherited by the additional waypoints)
+	 */
+	public void getAddWaypoints(String doc, String wayPoint, boolean is_found) throws Exception{
+		Extractor exWayBlock = new Extractor(doc,p.getProp("wayBlockExStart"),p.getProp("wayBlockExEnd"), 0, false);
+		String wayBlock = "";
+		String rowBlock = "";
+		wayBlock = exWayBlock.findNext();
+		Regex nameRex = new Regex(p.getProp("nameRex"));
+		Regex koordRex = new Regex(p.getProp("koordRex"));
+		Regex descRex = new Regex(p.getProp("descRex"));
+		Regex typeRex = new Regex(p.getProp("typeRex"));
+		int counter = 0;
+		if(exWayBlock.endOfSearch() == false && wayBlock.indexOf("No additional waypoints to display.")<0){
+			Extractor exRowBlock = new Extractor(wayBlock,p.getProp("rowBlockExStart"),p.getProp("rowBlockExEnd"), 0, false);
+			rowBlock = exRowBlock.findNext();
+			rowBlock = exRowBlock.findNext();
+			while(exRowBlock.endOfSearch()==false){
+				CacheHolder hd = null;
+				Extractor exPrefix=new Extractor(rowBlock,p.getProp("prefixExStart"),p.getProp("prefixExEnd"),0,true);
+				String prefix=exPrefix.findNext();
+				String adWayPoint;
+				if (prefix.length()==2)
+					adWayPoint=prefix+wayPoint.substring(2);
+				else
+				    adWayPoint = MyLocale.formatLong(counter, "00") + wayPoint.substring(2);
+				counter++;
+				int idx=profile.getCacheIndex(adWayPoint);
+				if (idx>=0) {
+					// Creating new CacheHolder, but accessing old cache.xml file
+					hd=new CacheHolder();
+					hd.setWayPoint(adWayPoint);
+					hd.getExistingDetails(); // Accessing Details reads file if not yet done
+				} else {
+					hd=new CacheHolder();
+					hd.setWayPoint(adWayPoint);
+				}
+				hd.initStates(idx<0);
+				nameRex.search(rowBlock);
+				koordRex.search(rowBlock);
+				typeRex.search(rowBlock);
+				hd.setCacheName(nameRex.stringMatched(1));
+				if(koordRex.didMatch()) hd.setLatLon(koordRex.stringMatched(1));
+				if(typeRex.didMatch()) hd.setType(CacheType.gpxType2CwType("Waypoint|"+typeRex.stringMatched(1)));
+				rowBlock = exRowBlock.findNext();
+				descRex.search(rowBlock);
+				hd.getFreshDetails().setLongDescription(descRex.stringMatched(1));
+				hd.setFound(is_found);
+				hd.setCacheSize(CacheSize.CW_SIZE_NOTCHOSEN);
+				hd.setHard(CacheTerrDiff.CW_DT_UNSET);
+				hd.setTerrain(CacheTerrDiff.CW_DT_UNSET);
+				if (idx<0){
+					cacheDB.add(hd);
+					hd.save();
+				}else {
+					CacheHolder cx=cacheDB.get(idx);
+					if (cx.is_Checked && // Only re-spider existing addi waypoints that are ticked
+				 	   cx.isVisible()) { // and are visible (i.e.  not filtered)
+					   cx.initStates(false);
+					   cx.update(hd);
+					   cx.is_Checked=true;
+					   cx.save();
+					}
+				}
+				rowBlock = exRowBlock.findNext();
+
+			}
+		}
+	}
+
+	public void getAttributes(String doc, CacheHolderDetail chD) throws Exception {
+		Extractor attBlock = new Extractor(doc,p.getProp("attBlockExStart"),p.getProp("attBlockExEnd"), 0 , true);
+		String atts = attBlock.findNext();
+		Extractor attEx = new Extractor(atts,p.getProp("attExStart"),p.getProp("attExEnd"), 0 , true);
+		String attribute=attEx.findNext();
+		chD.attributes.clear();
+		while (attEx.endOfSearch()==false) {
+			chD.attributes.add(attribute);
+			attribute=attEx.findNext();
+		}
+		chD.getParent().setAttributesYes(chD.attributes.attributesYes);
+		chD.getParent().setAttributesNo(chD.attributes.attributesNo);
+	}
+
+
+	/**
+	*	Performs an initial fetch to a given address. In this case
+	*	it will be a gc.com address. This method is used to obtain
+	*	the result of a search for caches screen.
+	*/
+	public static String fetch(String address) {
+		CharArray c_data;
+		try{
+			HttpConnection conn;
+			if(pref.myproxy.length() > 0 && pref.proxyActive){
+				pref.log("[fetch]:Using proxy: " + pref.myproxy + " / " +pref.myproxyport);
+			}
+			conn = new HttpConnection(address);
+			conn.setRequestorProperty("User-Agent", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
+			if(cookieSession.length()>0){
+				conn.setRequestorProperty("Cookie", "ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
+				pref.log("[fetch]:Cookie Zeug: " + "Cookie: ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
+			} else
+				pref.log("[fetch]:No Cookie found");
+			conn.setRequestorProperty("Connection", "close");
+			conn.documentIsEncoded = true;
+			if (pref.debug) pref.log("[fetch]:Connecting");
+			Socket sock = conn.connect();
+			if (pref.debug) pref.log("[fetch]:Connect ok!");
+			ByteArray daten = conn.readData(sock);
+			if (pref.debug) pref.log("[fetch]:Read data ok");
+			JavaUtf8Codec codec = new JavaUtf8Codec();
+			c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
+			sock.close();
+			return getResponseHeaders(conn)+ c_data.toString();
+		}catch(IOException ioex){
+			pref.log("IOException in fetch", ioex);
+		}finally{
+			//continue
+		}
+		return "";
+	}
+
+	/**
+	*	After a fetch to gc.com the next fetches have to use the post method.
+	*	This method does exactly that. Actually this method is generic in the sense
+	*	that it can be used to post to a URL using http post.
+	*/
+	private static String fetch_post(String address, String document, String path) {
+		HttpConnection conn;
+		try {
+			conn = new HttpConnection(address);
+			JavaUtf8Codec codec = new JavaUtf8Codec();
+			conn.documentIsEncoded = true;
+			conn.setRequestorProperty("User-Agent", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
+			conn.setPostData(codec.encodeText(document.toCharArray(),0,document.length(),true,null));
+			conn.setRequestorProperty("Content-Type", "application/x-www-form-urlencoded");
+			if(cookieSession.length()>0){
+				conn.setRequestorProperty("Cookie", "ASP.NET_SessionId="+cookieSession+"; userid="+cookieID);
+				pref.log("[fetch]:Cookie Zeug: " + "Cookie: ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
+			} else {
+				pref.log("[fetch]:No Cookie found");
+			}
+			conn.setRequestorProperty("Connection", "close");
+			if (pref.debug) pref.log("[fetch]:Connecting");
+			Socket sock = conn.connect();
+			if (pref.debug) pref.log("[fetch]:Connect ok!");
+			ByteArray daten = conn.readData(sock);
+			if (pref.debug) pref.log("[fetch]:Read data ok");
+			CharArray c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
+			sock.close();
+			return getResponseHeaders(conn)+c_data.toString();
+		} catch (Exception e) {
+			Global.getPref().log("Ignored Exception", e, true);
+		}
+		return "";
+	}
+
+	private static String getResponseHeaders(HttpConnection conn) {
+		PropertyList pl = conn.documentProperties;
+		if (pl != null) {
+			StringBuffer sb = new StringBuffer(1000);
+			boolean gotany = false;
+
+			for (int i = 0; i < pl.size(); i++) {
+				Property currProp = (Property)pl.get(i);
+				if (currProp.value != null) {
+					sb.append(currProp.name).append(": ").append(currProp.value).append("\r\n");
+					gotany = true;
+				}
+			}
+			if (gotany)
+				return sb.toString() + "\r\n";
+		}
+		return "";
+	}
+
+
+	final static String hex = ewe.util.TextEncoder.hex;
+
+	public String encodeUTF8URL(byte[] what) {
+		int max = what.length;
+		char [] dest = new char[6*max]; // Assume each char is a UTF char and encoded into 6 chars
+		char d = 0;
+		for (int i = 0; i<max; i++){
+			char c = (char) what[i];
+			if (c <= ' ' || c == '+' || c == '&' || c == '%' || c == '=' ||
+				   c == '|' || c == '{' || c == '}' || c>0x7f ){
+					dest[d++] = '%';
+					dest[d++] = hex.charAt((c >> 4) & 0xf);
+					dest[d++] = hex.charAt(c & 0xf);
+			} else dest[d++] = c;
+		}
+		return new String(dest,0,d);
+	}
+
+	/**
+	 * Load the bug id for a given name. This method is not ideal, as there are
+	 * sometimes several bugs with identical names but different IDs. Normally
+	 * the bug GUID is used which can be obtained from the cache page.<br>
+	 * Note that each bug has both an ID and a GUID.
+	 * @param name The name (or partial name) of a travelbug
+	 * @return the id of the bug
+	 */
+	public String getBugId (String name) {
+		String bugList;
+		try{
+			//infB.setInfo(oldInfoBox+"\nGetting bug: "+bug);
+			pref.log("Fetching bugId: "+name);
+			bugList = fetch(p.getProp("getBugByName")+STRreplace.replace(SafeXML.clean(name)," ","+"));
+		}catch(Exception ex){
+			pref.log("Could not fetch bug list");
+			bugList="";
+		}
+		try {
+			if (bugList.equals("") || bugList.indexOf(p.getProp("bugNotFound"))>=0) {
+				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), FormBase.OKB)).execute();
+				return "";
+			}
+			if (bugList.indexOf(p.getProp("bugTotalRecords"))<0) {
+				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6021,"More than one travelbug found. Specify name more precisely."), FormBase.OKB)).execute();
+				return "";
+			}
+			Extractor exGuid = new Extractor(bugList,p.getProp("bugGuidExStart"),p.getProp("bugGuidExEnd"),0,Extractor.EXCLUDESTARTEND); // TODO Replace with spider.def
+			return exGuid.findNext();
+		} catch (Exception ex) {
+			return "";
+		}
+	}
+
+	/**
+	 * Fetch a bug's mission for a given GUID or ID. If the guid String is longer
+	 * than 10 characters it is assumed to be a GUID, otherwise it is an ID.
+	 * @param guid the guid or id of the travelbug
+	 * @return The mission
+	 */
+	public String getBugMissionByGuid(String guid) {
+		String bugDetails;
+		try{
+			//infB.setInfo(oldInfoBox+"\nGetting bug: "+bug);
+			pref.log("Fetching bug detailsById: "+guid);
+			if (guid.length()>10)
+				bugDetails = fetch(p.getProp("getBugByGuid")+guid);
+			else
+				bugDetails = fetch(p.getProp("getBugById")+guid);
+		}catch(Exception ex){
+			pref.log("Could not fetch bug details");
+			bugDetails="";
+		}
+		try {
+			if (bugDetails.indexOf(p.getProp("bugNotFound"))>=0) {
+				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), FormBase.OKB)).execute();
+				return "";
+			}
+			Extractor exDetails = new Extractor(bugDetails,p.getProp("bugDetailsStart"),p.getProp("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
+			return exDetails.findNext();
+		} catch (Exception ex) {
+			return "";
+		}
+	}
+
+	/**
+	 * Fetch a bug's mission for a given tracking number
+	 * @param trackNr the tracking number of the travelbug
+	 * @return The mission
+	 */
+	public String getBugMissionByTrackNr(String trackNr) {
+		String bugDetails;
+		try{
+			pref.log("Fetching bug detailsByTrackNr: "+trackNr);
+			bugDetails = fetch(p.getProp("getBugByTrackNr")+trackNr);
+		}catch(Exception ex){
+			pref.log("Could not fetch bug details");
+			bugDetails="";
+		}
+		try {
+			if (bugDetails.indexOf(p.getProp("bugNotFound"))>=0) {
+//				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), MessageBox.OKB)).execute();
+				return "";
+			}
+			Extractor exDetails = new Extractor(bugDetails,p.getProp("bugDetailsStart"),p.getProp("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
+			return exDetails.findNext();
+		} catch (Exception ex) {
+			return "";
+		}
+	}
+
+	/**
+	 * Fetch a bug's mission and namefor a given tracking number
+	 * @param TB the travelbug
+	 * @return true if suceeded
+	 */
+	public boolean getBugMissionAndNameByTrackNr(Travelbug TB) {
+		String bugDetails;
+		String trackNr = TB.getTrackingNo();
+		try{
+			pref.log("Fetching bug detailsByTrackNr: "+trackNr);
+			bugDetails = fetch(p.getProp("getBugByTrackNr")+trackNr);
+		}catch(Exception ex){
+			pref.log("Could not fetch bug details");
+			bugDetails="";
+		}
+		try {
+			if (bugDetails.indexOf(p.getProp("bugNotFound"))>=0) {
+//				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), MessageBox.OKB)).execute();
+				return false;
+			}
+			Extractor exDetails = new Extractor(bugDetails,p.getProp("bugDetailsStart"),p.getProp("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
+			TB.setMission( exDetails.findNext() );
+			Extractor exName = new Extractor(bugDetails,p.getProp("bugNameStart"),p.getProp("bugNameEnd"),0,Extractor.EXCLUDESTARTEND);
+			TB.setName( exName.findNext() );
+			return true;
+		} catch (Exception ex) {
+			return false;
+		}
+	}
+
+	public class SpiderProperties extends Properties {
+		SpiderProperties() {
+			super();
+			try {
+				load(new FileInputStream(FileBase.getProgramDirectory()+"/spider.def"));
+			} catch (Exception ex) {
+				pref.log("Failed to load spider.def",ex);
+				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5504,"Could not load 'spider.def'"), FormBase.OKB)).execute();
+			}
+		}
+		public String getProp(String key) throws Exception {
+			String s=super.getProperty(key);
+			if (s==null) {
+				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def") + ": "+key, FormBase.OKB)).execute();
+				throw new Exception("Missing tag in spider.def: "+key);
+			}
+			return s;
+		}
+
+	}
+}


Property changes on: trunk/src/CacheWolf/imp/SpiderGC.java
___________________________________________________________________
Name: svn:mergeinfo
   + 



From greiol at mail.berlios.de  Fri Jun 26 21:55:05 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Fri, 26 Jun 2009 21:55:05 +0200
Subject: [Cachewolf-svn] r1951 - trunk/src/exp
Message-ID: <200906261955.n5QJt59w022459@sheep.berlios.de>

Author: greiol
Date: 2009-06-26 21:55:03 +0200 (Fri, 26 Jun 2009)
New Revision: 1951

Modified:
   trunk/src/exp/GpxExportNg.java
Log:
force . as decimal separator

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-26 18:53:49 UTC (rev 1950)
+++ trunk/src/exp/GpxExportNg.java	2009-06-26 19:55:03 UTC (rev 1951)
@@ -354,9 +354,9 @@
 		
 		Transformer trans = new Transformer(true);
 
-		trans.add(new Regex("@@WPLAT@@", String.valueOf(ch.pos.latDec)));
+		trans.add(new Regex("@@WPLAT@@", String.valueOf(ch.pos.latDec).replace(',', '.')));
 
-		trans.add(new Regex("@@WPLON@@", String.valueOf(ch.pos.lonDec)));
+		trans.add(new Regex("@@WPLON@@", String.valueOf(ch.pos.lonDec).replace(',', '.')));
 
 		if (ch.isAddiWpt()) {
 			try {



From greiol at mail.berlios.de  Sat Jun 27 19:06:48 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Sat, 27 Jun 2009 19:06:48 +0200
Subject: [Cachewolf-svn] r1952 - trunk/src/CacheWolf
Message-ID: <200906271706.n5RH6mGl024931@sheep.berlios.de>

Author: greiol
Date: 2009-06-27 19:06:45 +0200 (Sat, 27 Jun 2009)
New Revision: 1952

Modified:
   trunk/src/CacheWolf/Parser.java
Log:
add defaults for created additional waypoints

Modified: trunk/src/CacheWolf/Parser.java
===================================================================
--- trunk/src/CacheWolf/Parser.java	2009-06-26 19:55:03 UTC (rev 1951)
+++ trunk/src/CacheWolf/Parser.java	2009-06-27 17:06:45 UTC (rev 1952)
@@ -1104,6 +1104,8 @@
 		ch.setWayPoint(wayPoint);
 		ch.setType(type);
 		ch.setCacheSize(CacheSize.CW_SIZE_NOTCHOSEN);
+		ch.setHard(CacheTerrDiff.CW_DT_UNSET);
+		ch.setTerrain(CacheTerrDiff.CW_DT_UNSET);
 		ch.setCacheName(name);
 
 		Global.getProfile().setAddiRef(ch);



From greiol at mail.berlios.de  Sat Jun 27 19:51:55 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Sat, 27 Jun 2009 19:51:55 +0200
Subject: [Cachewolf-svn] r1953 - trunk/res_noewe
Message-ID: <200906271751.n5RHptK9009484@sheep.berlios.de>

Author: greiol
Date: 2009-06-27 19:51:54 +0200 (Sat, 27 Jun 2009)
New Revision: 1953

Modified:
   trunk/res_noewe/Garmin User Symbols.zip
Log:
updated list of internal types in readme.txt

Modified: trunk/res_noewe/Garmin User Symbols.zip
===================================================================
(Binary files differ)



From jennergruhle at mail.berlios.de  Sat Jun 27 22:16:41 2009
From: jennergruhle at mail.berlios.de (jennergruhle at mail.berlios.de)
Date: Sat, 27 Jun 2009 22:16:41 +0200
Subject: [Cachewolf-svn] r1954 - trunk
Message-ID: <200906272016.n5RKGfmM023904@sheep.berlios.de>

Author: jennergruhle
Date: 2009-06-27 22:16:39 +0200 (Sat, 27 Jun 2009)
New Revision: 1954

Added:
   trunk/cachewolf/
Log:
Share project 'cachewolf' into 'http://svn.berlios.de/svnroot/repos/cachewolf'



From jennergruhle at mail.berlios.de  Sun Jun 28 11:47:29 2009
From: jennergruhle at mail.berlios.de (jennergruhle at mail.berlios.de)
Date: Sun, 28 Jun 2009 11:47:29 +0200
Subject: [Cachewolf-svn] r1955 - trunk/res_noewe/languages
Message-ID: <200906280947.n5S9lTwj011078@sheep.berlios.de>

Author: jennergruhle
Date: 2009-06-28 11:47:26 +0200 (Sun, 28 Jun 2009)
New Revision: 1955

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
Log:
Added texts for GPSD use

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-06-27 20:16:39 UTC (rev 1954)
+++ trunk/res_noewe/languages/DE.cfg	2009-06-28 09:47:26 UTC (rev 1955)
@@ -701,13 +701,15 @@
 		4402=F%fcr einen neuen Versuch, stoppe und starte GPS neu
 		4403=Fehler
 		4404=Konnte keine Verbindung zum GPS-Empf%e4nger %0a herstellen. Fehler beim %f6ffnen des seriellen Ports%0a
-		4405=%0aM%f6gliche Gr%fcnde:%0a Falscher Port %0a Ein anderes Programm blokiert den Anschluss %0a gilt nur auf Loox-Ger%e4ten: ge%f6ffneter Infrarot-Port blockiert das GPS
+		4405=%0aM%f6gliche Gr%fcnde:%0a Falscher Port %0a Ein anderes Programm blockiert den Anschluss %0a gilt nur auf Loox-Ger%e4ten: ge%f6ffneter Infrarot-Port blockiert das GPS
 		4406=Kopieren Sie java_ewe.dll in das Verzeichnis des CacheWolf-Programms
 		4407=Die vorgefundenen Dateien entsprechen nicht dem aktuellen Format.%0aDaher werden sie nun in das aktuelle Format konvertiert. Abh%e4ngig von der Gr%f6%dfe des Profils und dem verwendeten Rechner kann das einige Minuten dauern. Wir bitten um Geduld.
+		4408=Konnte keine Verbindung zum GPSD herstellen:
+		4409=%0aM%f6gliche Gr%fcnde:%0a Adresse/Port falsch%0a GPSD l%e4uft dort nicht
 		4500=Ges:
 		4501=Gez:
 		4502=Gef:
-		4600=Nicht alle Caches k%f6nnen angezeigt werden. Inkompatibler Blacklist Status.
+		4600=Nicht alle Caches k%f6nnen angezeigt werden. Inkompatibler Blacklist-Status.
 		4700=Ignoriere Fehler beim%0aLaden der Kalibrierungsdatei%0a
 		4701=Suche nach bester Karte
 		4702=Optimierung
@@ -860,7 +862,7 @@
 		7106=Alle Daten vom GPS-Empf%e4nger werden an den eingetragenen Host an TCP-Port 23 weitergeleitet. Mit dem Programm HW Virtual Serial Port kann damit ein virtueller COM-Port eingerichtet werden
 		7107=Position alle X Sekunden speichern (NMEA-LOG)
 		7108=Fehler: Konnte folgenden seriellen Port nicht %d6ffnen:+
-		7109=Fehler beim Ermitteln der verf%fcgbaren serielle Ports%0a
+		7109=Fehler beim Ermitteln der verf%fcgbaren seriellen Ports%0a
 		7110=GPS nicht gefunden%0a
 		7111=Versuche+
 		7112= mit+
@@ -872,6 +874,8 @@
 		7118=Stop
 		7119=Stop
 		7120=Abgebrochen
+		7121=Daten per GPSD empfangen von
+		7122=Die GPS-Daten werden per GPSD von einem anderen Server oder localhost empfangen (statt per seriellem Port)
 		7200=Aufruf: CacheWolf [-c <Pfad zur Einstellungsdatei>] [-debug]
 		{..}
 	{..}

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-06-27 20:16:39 UTC (rev 1954)
+++ trunk/res_noewe/languages/EN.cfg	2009-06-28 09:47:26 UTC (rev 1955)
@@ -693,6 +693,8 @@
 		4405=%0apossible reasons:\n Another (GPS-)program is blocking the port%0awrong port%0aOn Loox: active infra-red port is blocking GPS"
 		4406=Please copy jave_ewe.dll into the directory of the cachewolf program
 		4407=The profile files are not in the current format.%0aTherefore they are now converted to the current format. Depending of the size of the profile and the computer involved this may take some minutes. Please bear with us until the conversion is done.
+		4408=Could not connect to GPSD:
+		4409=%0apossible reasons:%0aGPSD host is not reachable or GPSD is not running there
 		4500=Tot:
 		4501=Vis:
 		4502=Fnd:
@@ -856,6 +858,8 @@
 		7118=Stop
 		7119=Stop
 		7120=Canceled
+		7121=Receive GPS from gpsd host
+		7122=GPS data will be received from a gpsd server, not from a serial port
 		7200=Usage: CacheWolf [-c <path to pref.xml>] [-debug]
 		{..}
 	{..}



From jennergruhle at mail.berlios.de  Sun Jun 28 11:48:49 2009
From: jennergruhle at mail.berlios.de (jennergruhle at mail.berlios.de)
Date: Sun, 28 Jun 2009 11:48:49 +0200
Subject: [Cachewolf-svn] r1956 - trunk/src/CacheWolf
Message-ID: <200906280948.n5S9mnqY011129@sheep.berlios.de>

Author: jennergruhle
Date: 2009-06-28 11:48:45 +0200 (Sun, 28 Jun 2009)
New Revision: 1956

Modified:
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
Log:
Added GPSD options.

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-28 09:47:26 UTC (rev 1955)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-28 09:48:45 UTC (rev 1956)
@@ -1,6 +1,5 @@
 package CacheWolf;
 
-import CacheWolf.imp.SpiderGC;
 import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.io.*;
@@ -22,6 +21,7 @@
 	public final int DEFAULT_MAX_LOGS_TO_SPIDER=250;
 	public final int DEFAULT_LOGS_PER_PAGE=5;
 	public final int DEFAULT_INITIAL_HINT_HEIGHT=10;
+	public final int DEFAULT_GPSD_PORT=2947;
 	public static final int YES = 0;
 	public static final int NO = 1;
 	public static final int ASK = 2;
@@ -134,6 +134,12 @@
 	public boolean forwardGPS = false;
 	/** IP address for forwarding GPS data */
 	public String forwardGpsHost = "192.168.1.15";
+	/** True if the GPS data should be received from a GPSD on this or another host */
+	public boolean useGPSD = false;
+	/** IP address of GPSD host */
+	public String gpsdHost = "127.0.0.1";
+	/** Port for forwarding GPS data */
+	public int gpsdPort = DEFAULT_GPSD_PORT;
 	/** True if the GPS data should be logged to a file */
 	public boolean logGPS = false;
 	/** Timer for logging GPS data */
@@ -309,6 +315,11 @@
 			forwardGPS = Convert.toBoolean(atts.getValue("active"));
 			forwardGpsHost = atts.getValue("destinationHost");
 		}
+		else if(name.equals("gpsd")) {
+			useGPSD = Convert.toBoolean(atts.getValue("active"));
+			gpsdHost = atts.getValue("host");
+			gpsdPort = Convert.toInt(atts.getValue("port"));
+		}
 		else if(name.equals("portlog")) {
 			logGPS = Convert.toBoolean(atts.getValue("active"));
 			logGPSTimer = atts.getValue("logTimer");
@@ -501,6 +512,7 @@
 			outp.print("    <proxy prx = \"" + SafeXML.strxmlencode(myproxy) + "\" prt = \"" + SafeXML.strxmlencode(myproxyport) + "\" active = \"" + SafeXML.strxmlencode(proxyActive) + "\" />\n");
 			outp.print("    <port portname = \"" + SafeXML.strxmlencode(mySPO.portName) + "\" baud = \"" + SafeXML.strxmlencode(mySPO.baudRate) + "\"/>\n");
 			outp.print("    <portforward active= \"" + SafeXML.strxmlencode(Convert.toString(forwardGPS)) + "\" destinationHost = \"" + SafeXML.strxmlencode(forwardGpsHost) + "\"/>\n");
+			outp.print("    <gpsd active= \"" + SafeXML.strxmlencode(Convert.toString(useGPSD)) + "\" host = \"" + SafeXML.strxmlencode(gpsdHost) + "\" port = \"" + SafeXML.strxmlencode(gpsdPort) + "\"/>\n");
 			outp.print("    <portlog active= \"" + SafeXML.strxmlencode(Convert.toString(logGPS)) + "\" logTimer = \"" + SafeXML.strxmlencode(logGPSTimer) + "\"/>\n");
 			outp.print("    <font size =\"" + SafeXML.strxmlencode(fontSize) + "\"/>\n");
 			outp.print("    <screen menuattop=\""+menuAtTop+"\" tabsattop=\""+tabsAtTop+"\" showstatus=\""+showStatus+"\" hasclosebutton=\""+hasCloseButton+

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2009-06-28 09:47:26 UTC (rev 1955)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2009-06-28 09:48:45 UTC (rev 1956)
@@ -1,6 +1,5 @@
 package CacheWolf;
 
-import CacheWolf.imp.SpiderGC;
 import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.ui.*;
@@ -105,7 +104,9 @@
 		inpPassword.isPassword=true;
 		pnlGeneral.addLast(pnlBrowser,HSTRETCH,HFILL);
 		
-		pnlGeneral.addLast(gpsB = new mButton("GPS: " + pref.mySPO.portName+"/"+pref.mySPO.baudRate),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
+		pnlGeneral.addLast(gpsB = new mButton("GPS: " + 
+			(pref.useGPSD ? "gpsd " + pref.gpsdHost : pref.mySPO.portName+"/"+pref.mySPO.baudRate) ),
+			CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
 
 		// Garmin and GPSBabel
 		pnlGeneral.addNext(lblGarmin=new mLabel(MyLocale.getMsg(173,"Garmin:  PC Port:")),DONTSTRETCH,LEFT);
@@ -341,6 +342,12 @@
 				Editor s = gpo.getEditor();
 				gpo.forwardGpsChkB.setState(pref.forwardGPS);
 				gpo.inputBoxForwardHost.setText(pref.forwardGpsHost);
+				gpo.gpsdChkB.setState(pref.useGPSD);
+				if(pref.gpsdPort!=pref.DEFAULT_GPSD_PORT){
+					gpo.inputBoxGpsdHost.setText(pref.gpsdHost + ":" + Convert.toString(pref.gpsdPort));
+				}else{
+					gpo.inputBoxGpsdHost.setText(pref.gpsdHost);
+				}
 				gpo.logGpsChkB.setState(pref.logGPS);
 				gpo.inputBoxLogTimer.setText(pref.logGPSTimer);
 				Gui.setOKCancel(s);
@@ -349,6 +356,16 @@
 					pref.mySPO.baudRate = gpo.baudRate;
 					pref.forwardGPS = gpo.forwardGpsChkB.getState();
 					pref.forwardGpsHost = gpo.inputBoxForwardHost.getText();
+					pref.useGPSD = gpo.gpsdChkB.getState();
+					String gpsdHostString = gpo.inputBoxGpsdHost.getText();	// hostname[:port]
+					int posColon = gpsdHostString.indexOf(':');
+					if(posColon>=0){
+						pref.gpsdHost=gpsdHostString.substring(0,posColon);
+						pref.gpsdPort=Convert.toInt(gpsdHostString.substring(posColon+1));
+					}else{
+						pref.gpsdHost=gpsdHostString;
+						pref.gpsdPort=pref.DEFAULT_GPSD_PORT;
+					}
 					pref.logGPS = gpo.logGpsChkB.getState();
 					pref.logGPSTimer = gpo.inputBoxLogTimer.getText();
 					gpsB.setText("GPS: " + pref.mySPO.portName+"/"+pref.mySPO.baudRate);



From jennergruhle at mail.berlios.de  Sun Jun 28 11:53:31 2009
From: jennergruhle at mail.berlios.de (jennergruhle at mail.berlios.de)
Date: Sun, 28 Jun 2009 11:53:31 +0200
Subject: [Cachewolf-svn] r1957 - trunk/src/CacheWolf/navi
Message-ID: <200906280953.n5S9rVAB011395@sheep.berlios.de>

Author: jennergruhle
Date: 2009-06-28 11:53:27 +0200 (Sun, 28 Jun 2009)
New Revision: 1957

Modified:
   trunk/src/CacheWolf/navi/CWGPSPoint.java
Log:
Added GPSD data parsing

Modified: trunk/src/CacheWolf/navi/CWGPSPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/CWGPSPoint.java	2009-06-28 09:48:45 UTC (rev 1956)
+++ trunk/src/CacheWolf/navi/CWGPSPoint.java	2009-06-28 09:53:27 UTC (rev 1957)
@@ -5,6 +5,8 @@
  * Window - Preferences - Java - Code Style - Code Templates
  */
 package CacheWolf.navi;
+import com.stevesoft.ewe_pat.Regex;
+
 import CacheWolf.CWPoint;
 import CacheWolf.Common;
 import CacheWolf.Extractor;
@@ -42,6 +44,7 @@
 	FileWriter logFile;
 	String lastStrExamined = new String();
 
+	Regex numberMatcher = new Regex("\\-?\\d+");
 
 	public CWGPSPoint()
 	{
@@ -170,7 +173,7 @@
 	}
 
 	/**
-	 * 
+	 * Sets the attributes from a NMEA String
 	 * @param NMEA	string with data to examine
 	 * @return true if some data could be interpreted false otherwise
 	 */
@@ -379,6 +382,79 @@
 		return interpreted;
 	}
 
+	
+	/**
+	 * Sets the attributes from a GPSD string
+	 * @param gps	GPSD string with data to examine
+	 *              Format: GPSD,key=value,... 
+	 * @return true if some data could be interpreted false otherwise
+	 */
+	public boolean examineGpsd(String gps){
+		boolean valid = false;
+		if(!gps.startsWith("GPSD,"))
+			return false;
+		Extractor ex = new Extractor (gps, ",",",",4,true);
+		while(!ex.endOfSearch()){
+			String part = ex.findNext();
+			if(part.startsWith("A=") && part.indexOf('?')<0){
+				// The current altitude as "A=%f", meters above mean sea level. 
+				this.Alt=Common.parseDouble(part.substring(2));
+				valid = true;
+			}else if(part.startsWith("D=") && part.indexOf('?')<0){
+				// Returns the UTC time in the ISO 8601 format, "D=yyyy-mm-ddThh:mm:ss.ssZ"
+				//                                               0000000000111111111122 
+				//                                               0123456789012345678901
+				String year = part.substring(2,6);
+				String month = part.substring(7,9);
+				String day = part.substring(10,12);
+				String hour = part.substring(13,15);
+				String min = part.substring(16,18);
+				String sec = part.substring(19,21);
+				this.Date=year+month+day;
+				this.Time=hour+min+sec;
+				valid = true;
+			}else if(part.startsWith("P=")){
+				// Returns the current position in the form "P=%f %f"; numbers are in degrees, latitude first. 
+				if(part.indexOf('?')<0){
+					this.Fix = 1;
+					int spacepos=part.indexOf(' ');
+					if(spacepos>=3){
+						String lat=part.substring(2,spacepos);
+						String lon=part.substring(spacepos+1);
+						this.latDec=Common.parseDouble(lat);
+						this.lonDec=Common.parseDouble(lon);
+					}else
+						this.set(part.substring(2));
+				}else{
+					this.Fix = 0;
+				}
+				valid = true;
+			}else if(part.startsWith("Q=")){
+				// Returns "Q=%d %f %f %f %f %f": a count of satellites used in the last fix,
+				// and five dimensionless dilution-of-precision (DOP) numbers -- 
+				// spherical, horizontal, vertical, time, and total geometric.
+				int spacepos=part.indexOf(' ');
+				if(part.indexOf('?')<0 && spacepos>=3){
+					this.numSat = Common.parseInt(part.substring(2, spacepos));
+					valid = true;
+				}else{
+					this.numSat = 0;
+				}
+				this.numSatsInView = 0;			// Not supported by GPSD
+				//TODO parse DOP values
+			}else if(part.startsWith("T=") && part.indexOf('?')<0){
+				// Track made good; course "T=%f" in degrees from true north.
+				this.Bear = Common.parseDouble(part.substring(2));
+				valid = true;
+			}else if(part.startsWith("V=") && part.indexOf('?')<0){
+				// The current speed over ground as "V=%f" in knots.
+				this.Speed = Common.parseDouble(part.substring(2));
+				valid = true;
+			}
+		}
+		return valid;
+	}
+		
 	private boolean checkSumOK(String nmea){
 		int startPos = 1; // begin after $
 		int endPos = nmea.length() - 3;// without * an two checksum chars



From jennergruhle at mail.berlios.de  Sun Jun 28 11:53:52 2009
From: jennergruhle at mail.berlios.de (jennergruhle at mail.berlios.de)
Date: Sun, 28 Jun 2009 11:53:52 +0200
Subject: [Cachewolf-svn] r1958 - trunk/src/CacheWolf/navi
Message-ID: <200906280953.n5S9rqaV011422@sheep.berlios.de>

Author: jennergruhle
Date: 2009-06-28 11:53:49 +0200 (Sun, 28 Jun 2009)
New Revision: 1958

Modified:
   trunk/src/CacheWolf/navi/Navigate.java
Log:
Added GPSD usage

Modified: trunk/src/CacheWolf/navi/Navigate.java
===================================================================
--- trunk/src/CacheWolf/navi/Navigate.java	2009-06-28 09:53:27 UTC (rev 1957)
+++ trunk/src/CacheWolf/navi/Navigate.java	2009-06-28 09:53:49 UTC (rev 1958)
@@ -9,6 +9,7 @@
 import ewe.io.SerialPort;
 import ewe.io.SerialPortOptions;
 import ewe.net.Socket;
+import ewe.sys.Vm;
 import ewe.sys.mThread;
 import ewe.ui.FormBase;
 import ewe.ui.MessageBox;
@@ -35,6 +36,7 @@
 
 	public GotoPanel gotoPanel = null;
 	public MovingMap movingMap = null;
+	public GpsdThread gpsdThread = null;
 	public SerialThread serThread = null;
 	public Preferences pref = Global.getPref();
 	public UpdateThread tickerThread;
@@ -52,37 +54,60 @@
 
 	public void startGps(boolean loggingOn, int loggingIntervall) {
 		setRawLogging(loggingOn, loggingIntervall);
-		if (serThread != null) if (serThread.isAlive()) return; // TODO use gpsRunning
-		try {
-			serThread = new SerialThread(pref.mySPO, gpsPos, (pref.forwardGPS ? pref.forwardGpsHost : ""));
-			if (pref.forwardGPS && !serThread.tcpForward) {
-				(new MessageBox(MyLocale.getMsg(4400, "Warning"), 
-						MyLocale.getMsg(4401, "Ignoring error:\n could not forward GPS data to host:\n")
-						+ pref.forwardGpsHost+"\n" + serThread.lastError
-						+ MyLocale.getMsg(4402, "\nstop and start GPS to retry"), FormBase.OKB)).exec();
+		if(Global.getPref().useGPSD){
+			try {
+				gpsdThread = new GpsdThread(gpsPos);
+				if (gpsPos.latDec == 0 && gpsPos.lonDec == 0) { // TODO use isValid() // TODO raus damit?
+					gpsPos.latDec = destination.latDec; // setze Zielpunkt als Ausgangspunkt
+					gpsPos.lonDec = destination.lonDec;
+				}
+				gpsdThread.start();
+				startDisplayTimer();
+				gpsRunning = true;
+				curTrack = new Track(trackColor); // TODO addTrack here to MovingMap? see MovingMapPanel.snapToGps
+				if (lograw)	gpsPos.startLog(Global.getProfile().dataDir, logIntervall, CWGPSPoint.LOGALL);
+				if (gotoPanel != null) gotoPanel.gpsStarted();
+				if (movingMap != null) movingMap.gpsStarted();
+			} catch (IOException e) {
+				(new MessageBox(MyLocale.getMsg(4403, "Error"), 
+					MyLocale.getMsg(4408, "Could not connect to GPSD:") 
+					+ e.getMessage()
+					+ MyLocale.getMsg(4409, "\npossible reasons:\nGPSD is not running or GPSD host is not reachable"), 
+					FormBase.OKB)).execute(); 
 			}
-			if (gpsPos.latDec == 0 && gpsPos.lonDec == 0) { // TODO use isValid() // TODO raus damit?
-				gpsPos.latDec = destination.latDec; // setze Zielpunkt als Ausgangspunkt
-				gpsPos.lonDec = destination.lonDec;
+		}else{
+			if (serThread != null) if (serThread.isAlive()) return; // TODO use gpsRunning
+			try {
+				serThread = new SerialThread(pref.mySPO, gpsPos, (pref.forwardGPS ? pref.forwardGpsHost : ""));
+				if (pref.forwardGPS && !serThread.tcpForward) {
+					(new MessageBox(MyLocale.getMsg(4400, "Warning"), 
+							MyLocale.getMsg(4401, "Ignoring error:\n could not forward GPS data to host:\n")
+							+ pref.forwardGpsHost+"\n" + serThread.lastError
+							+ MyLocale.getMsg(4402, "\nstop and start GPS to retry"), FormBase.OKB)).exec();
+				}
+				if (gpsPos.latDec == 0 && gpsPos.lonDec == 0) { // TODO use isValid() // TODO raus damit?
+					gpsPos.latDec = destination.latDec; // setze Zielpunkt als Ausgangspunkt
+					gpsPos.lonDec = destination.lonDec;
+				}
+				serThread.start();
+				startDisplayTimer();
+				gpsRunning = true;
+				curTrack = new Track(trackColor); // TODO addTrack here to MovingMap? see MovingMapPanel.snapToGps
+				if (lograw)	gpsPos.startLog(Global.getProfile().dataDir, logIntervall, CWGPSPoint.LOGALL);
+				if (gotoPanel != null) gotoPanel.gpsStarted();
+				if (movingMap != null) movingMap.gpsStarted();
+			} catch (IOException e) {
+				(new MessageBox(MyLocale.getMsg(4403, "Error"), 
+						MyLocale.getMsg(4404, "Could not connect to GPS-receiver.\n Error while opening serial Port ") 
+						+ e.getMessage()
+						+ MyLocale.getMsg(4405, "\npossible reasons:\n Another (GPS-)program is blocking the port\nwrong port\nOn Loox: active infra-red port is blocking GPS"), 
+						FormBase.OKB)).execute(); 
+			} catch (UnsatisfiedLinkError e) {
+				(new MessageBox(MyLocale.getMsg(4403, "Error"), 
+						MyLocale.getMsg(4404, "Could not connect to GPS-receiver.\n Error while opening serial Port ") 
+						+ MyLocale.getMsg(4406, "Please copy jave_ewe.dll into the directory of the cachewolf program"), 
+						FormBase.OKB)).execute(); 
 			}
-			serThread.start();
-			startDisplayTimer();
-			gpsRunning = true;
-			curTrack = new Track(trackColor); // TODO addTrack here to MovingMap? see MovingMapPanel.snapToGps
-			if (lograw)	gpsPos.startLog(Global.getProfile().dataDir, logIntervall, CWGPSPoint.LOGALL);
-			if (gotoPanel != null) gotoPanel.gpsStarted();
-			if (movingMap != null) movingMap.gpsStarted();
-		} catch (IOException e) {
-			(new MessageBox(MyLocale.getMsg(4403, "Error"), 
-					MyLocale.getMsg(4404, "Could not connect to GPS-receiver.\n Error while opening serial Port ") 
-					+ e.getMessage()
-					+ MyLocale.getMsg(4405, "\npossible reasons:\n Another (GPS-)program is blocking the port\nwrong port\nOn Loox: active infra-red port is blocking GPS"), 
-					FormBase.OKB)).execute(); 
-		} catch (UnsatisfiedLinkError e) {
-			(new MessageBox(MyLocale.getMsg(4403, "Error"), 
-					MyLocale.getMsg(4404, "Could not connect to GPS-receiver.\n Error while opening serial Port ") 
-					+ MyLocale.getMsg(4406, "Please copy jave_ewe.dll into the directory of the cachewolf program"), 
-					FormBase.OKB)).execute(); 
 		}
 	}
 
@@ -100,7 +125,10 @@
 	}
 
 	public void stopGps() {
-		serThread.stop();
+		if(serThread!=null)
+			serThread.stop();
+		if(gpsdThread!=null)
+			gpsdThread.stop();
 		stopDisplayTimer();
 		gpsPos.stopLog();
 		gpsRunning = false;
@@ -109,8 +137,7 @@
 	}
 
 	public boolean isGpsPosValid() {
-		return 	serThread != null && serThread.isAlive() && gpsPos.isValid() ; // && gpsPos.getfiex();
-
+		return (serThread != null && serThread.isAlive() || gpsdThread != null && gpsdThread.isAlive() ) && gpsPos.isValid() ; // && gpsPos.getfiex();
 	}
 
 
@@ -171,6 +198,83 @@
 	}
 }
 
+
+class GpsdThread extends mThread{
+	Socket gpsdSocket;
+	CWGPSPoint myGPS;
+	boolean run, tcpForward;
+	Socket tcpConn;
+	String lastError = new String();
+	
+	public GpsdThread(CWGPSPoint GPSPoint) throws IOException {
+		try{
+			gpsdSocket = new Socket(Global.getPref().gpsdHost, Global.getPref().gpsdPort);
+		} catch (IOException e) {
+			throw new IOException(Global.getPref().gpsdHost);
+		} // catch (UnsatisfiedLinkError e) {} // TODO in original java-vm 
+		myGPS = GPSPoint;
+	}
+	
+	public void run() {
+		String gpsResult;
+		int noData = 0;
+		int notinterpreted = 0;
+		run = true;
+		while (run){
+			try {
+				sleep(900);
+				noData++;
+				if (noData > 5) { myGPS.noDataError(); }
+			} catch (InterruptedException e) {
+				Global.getPref().log("Ignored Exception", e, true);
+			}
+			if (gpsdSocket != null)	{
+				gpsResult = getGpsdData("ADPQTV\r\n");
+				if (gpsResult!=null) {
+					//Vm.debug("P -> " + gpsResult);
+					noData = 0;
+					if (myGPS.examineGpsd(gpsResult))
+						notinterpreted = 0; 
+					else 
+						notinterpreted++;
+					if (notinterpreted > 22) myGPS.noInterpretableData();
+				}
+			}
+		} // while
+		myGPS.noData();
+	}
+
+	private String getGpsdData(String command) {
+		byte[] rcvBuff = new byte[1024*10]; // when some action takes a long time (eg. loading or zooming a map), a lot of data can be in the buffer, read that at once
+		int rcvLength = 0;
+		try {
+			gpsdSocket.write(command.getBytes());
+		} catch (IOException e) {
+			Global.getPref().log("Socket exception", e, true);
+		}
+		try {
+			sleep(100);
+		} catch (InterruptedException e) {
+			Global.getPref().log("Ignored exception", e, true);
+		}
+		try {
+			rcvLength = gpsdSocket.read(rcvBuff);
+		} catch (IOException e) {
+			Global.getPref().log("Socket exception", e, true);
+		}
+		String str = null;
+		if (rcvLength > 0)	{
+			str = mString.fromAscii(rcvBuff, 0, rcvLength); 
+		}
+		return str;
+	}
+
+	public void stop() {
+		run = false;
+		if (gpsdSocket != null) gpsdSocket.close();
+	}
+}
+
 /**
  * Thread for reading data from COM-port
  *



From jennergruhle at mail.berlios.de  Sun Jun 28 11:54:36 2009
From: jennergruhle at mail.berlios.de (jennergruhle at mail.berlios.de)
Date: Sun, 28 Jun 2009 11:54:36 +0200
Subject: [Cachewolf-svn] r1959 - trunk/src/CacheWolf
Message-ID: <200906280954.n5S9sa1X011459@sheep.berlios.de>

Author: jennergruhle
Date: 2009-06-28 11:54:33 +0200 (Sun, 28 Jun 2009)
New Revision: 1959

Modified:
   trunk/src/CacheWolf/Preferences.java
Log:
SpiderGC now in package CacheWolf.imp

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-28 09:53:49 UTC (rev 1958)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-28 09:54:33 UTC (rev 1959)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import CacheWolf.imp.SpiderGC;
 import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.io.*;



From jennergruhle at mail.berlios.de  Sun Jun 28 11:54:52 2009
From: jennergruhle at mail.berlios.de (jennergruhle at mail.berlios.de)
Date: Sun, 28 Jun 2009 11:54:52 +0200
Subject: [Cachewolf-svn] r1960 - trunk/src/CacheWolf
Message-ID: <200906280954.n5S9sqQw011476@sheep.berlios.de>

Author: jennergruhle
Date: 2009-06-28 11:54:49 +0200 (Sun, 28 Jun 2009)
New Revision: 1960

Modified:
   trunk/src/CacheWolf/PreferencesScreen.java
Log:
SpiderGC now in package CacheWolf.imp

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2009-06-28 09:54:33 UTC (rev 1959)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2009-06-28 09:54:49 UTC (rev 1960)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import CacheWolf.imp.SpiderGC;
 import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.ui.*;



From jennergruhle at mail.berlios.de  Sun Jun 28 11:55:31 2009
From: jennergruhle at mail.berlios.de (jennergruhle at mail.berlios.de)
Date: Sun, 28 Jun 2009 11:55:31 +0200
Subject: [Cachewolf-svn] r1961 - trunk/src/CacheWolf
Message-ID: <200906280955.n5S9tVFi011568@sheep.berlios.de>

Author: jennergruhle
Date: 2009-06-28 11:55:29 +0200 (Sun, 28 Jun 2009)
New Revision: 1961

Modified:
   trunk/src/CacheWolf/GPSPortOptions.java
Log:
Added GPSD usage options

Modified: trunk/src/CacheWolf/GPSPortOptions.java
===================================================================
--- trunk/src/CacheWolf/GPSPortOptions.java	2009-06-28 09:54:49 UTC (rev 1960)
+++ trunk/src/CacheWolf/GPSPortOptions.java	2009-06-28 09:55:29 UTC (rev 1961)
@@ -29,6 +29,7 @@
 import ewe.ui.*;
 import ewe.io.*;
 import ewe.ui.formatted.TextDisplay;
+import ewe.net.Socket;
 import ewe.reflect.FieldTransfer;
 import ewe.reflect.Reflect;
 import ewe.sys.*;
@@ -94,16 +95,95 @@
 	}
 }
 
+class GpsdThread extends mThread{
+	Socket gpsdSocket;
+	boolean run;
+	TextDisplay out;
+	Socket tcpConn;
+	String lastError = new String();
+	public String lastgot;
+	
+	public GpsdThread(TextDisplay td) throws IOException {
+		try{
+			gpsdSocket = new Socket(Global.getPref().gpsdHost, Global.getPref().gpsdPort);
+		} catch (IOException e) {
+			throw new IOException(Global.getPref().gpsdHost);
+		} // catch (UnsatisfiedLinkError e) {} // TODO in original java-vm 
+		out = td;
+		lastgot = null;
+	}
+	
+	public void run() {
+		String gpsResult;
+		run = true;
+		while (run){
+			try {
+				sleep(900);
+			} catch (InterruptedException e) {
+				Global.getPref().log("Ignored Exception", e, true);
+			}
+			if (gpsdSocket != null)	{
+				gpsResult = getGpsdData("ADPQTV\r\n");
+				if (gpsResult!=null) {
+					lastgot = gpsResult;
+					if (out != null) out.appendText(gpsResult,true);
+				}
+			}
+		} // while
+	}
+
+	private String getGpsdData(String command) {
+		byte[] rcvBuff = new byte[1024*10]; // when some action takes a long time (eg. loading or zooming a map), a lot of data can be in the buffer, read that at once
+		int rcvLength = 0;
+		try {
+			gpsdSocket.write(command.getBytes());
+		} catch (IOException e) {
+			Global.getPref().log("Socket exception", e, true);
+		}
+		try {
+			sleep(100);
+		} catch (InterruptedException e) {
+			Global.getPref().log("Ignored exception", e, true);
+		}
+		try {
+			rcvLength = gpsdSocket.read(rcvBuff);
+		} catch (IOException e) {
+			Global.getPref().log("Socket exception", e, true);
+		}
+		String str = null;
+		if (rcvLength > 0)	{
+			str = mString.fromAscii(rcvBuff, 0, rcvLength); 
+		}
+		return str;
+	}
+
+	public String nonBlockingRead() {
+		String ret = new String(lastgot); //mString.fromAscii(gpsBuff,0,gpsLen);
+		lastgot = null;
+		return ret;
+
+	}
+
+	public void stop() {
+		run = false;
+		if (gpsdSocket != null) gpsdSocket.close();
+	}
+}
+
 public class GPSPortOptions extends SerialPortOptions {
 	TextDisplay txtOutput;
 	mButton btnTest, btnUpdatePortList, btnScan;
 	public mInput inputBoxForwardHost;
 	mLabel  labelForwardHost;
 	public mCheckBox forwardGpsChkB;
+	public mInput inputBoxGpsdHost;
+	mLabel  labelGpsdHost;
+	public mCheckBox gpsdChkB;
 	public mInput inputBoxLogTimer;
 	mLabel  labelLogTimer;
 	public mCheckBox logGpsChkB;
 	mySerialThread serThread;
+	GpsdThread gpsdThread = null;
 	boolean gpsRunning = false;
 	MyEditor ed = new MyEditor();
 
@@ -141,6 +221,7 @@
 		ScrollBarPanel sbp = new MyScrollBarPanel(txtOutput);
 		sbp.setOptions(ScrollablePanel.AlwaysShowVerticalScrollers | ScrollablePanel.AlwaysShowHorizontalScrollers);
 		ed.addField(ed.addLast(sbp),"out");
+		
 		forwardGpsChkB = new mCheckBox("");
 		ed.addField(ed.addNext(forwardGpsChkB, CellConstants.DONTSTRETCH, (CellConstants.EAST | CellConstants.DONTFILL)), "forwardGpsChkB");
 		labelForwardHost = new mLabel(MyLocale.getMsg(7105, "Forward GPS data to host"));
@@ -149,6 +230,16 @@
 		inputBoxForwardHost.setPromptControl(labelForwardHost);
 		inputBoxForwardHost.setToolTip(MyLocale.getMsg(7106, "All data from GPS will be sent to TCP-port 23\n and can be redirected there to a serial port\n by HW Virtual Serial Port"));
 		ed.addField(ed.addLast(inputBoxForwardHost,0 , (CellConstants.WEST | CellConstants.HFILL)), "tcpForwardHost");
+
+		gpsdChkB = new mCheckBox("");
+		ed.addField(ed.addNext(gpsdChkB, CellConstants.DONTSTRETCH, (CellConstants.EAST | CellConstants.DONTFILL)), "gpsdChkB");
+		labelGpsdHost = new mLabel(MyLocale.getMsg(7121, "Receive GPS from gpsd host"));
+		ed.addField(ed.addNext(labelGpsdHost, CellConstants.DONTSTRETCH, (CellConstants.WEST | CellConstants.DONTFILL)), "labelGpsd");
+		inputBoxGpsdHost = new mInput("GpsdHost");
+		inputBoxGpsdHost.setPromptControl(labelGpsdHost);
+		inputBoxGpsdHost.setToolTip(MyLocale.getMsg(7122, "GPS data will be received from a gpsd server, not from a serial port"));
+		ed.addField(ed.addLast(inputBoxGpsdHost,0 , (CellConstants.WEST | CellConstants.HFILL)), "GpsdHost");
+
 		logGpsChkB = new mCheckBox("");
 		ed.addField(ed.addNext(logGpsChkB, CellConstants.DONTSTRETCH, (CellConstants.EAST | CellConstants.DONTFILL)), "logGpsChkB");
 		labelLogTimer = new mLabel(MyLocale.getMsg(7107, "Interval in sec for logging"));
@@ -215,23 +306,44 @@
 		if (field.equals("test")){
 			if (!gpsRunning){
 				ed_.fromControls();
-				txtOutput.setText(MyLocale.getMsg(7117, "Displaying data from serial port directly:\n"));
-				try {
-					btnScan.set(ControlConstants.Disabled, true);
-					btnScan.repaintNow();
-					this.portName = Common.fixSerialPortName(portName);
-					serThread = new mySerialThread(this, txtOutput);
-					serThread.start();
-					btnTest.setText(Gui.getTextFrom(MyLocale.getMsg(7118, "Stop")));
-					gpsRunning = true;
-				} catch (IOException e) {
-					btnScan.set(ControlConstants.Disabled, false);
-					btnScan.repaintNow();
-					txtOutput.appendText(MyLocale.getMsg(7108, "Failed to open serial port: ") + this.portName + ", IOException: " + e.getMessage() + "\n", true);
+				if(Global.getPref().useGPSD){
+					txtOutput.setText(MyLocale.getMsg(99999, "Displaying data from gpsd directly:\n"));
+					try {
+						btnScan.set(ControlConstants.Disabled, true);
+						btnScan.repaintNow();
+						gpsdThread = new GpsdThread(txtOutput);
+						gpsdThread.start();
+						btnTest.setText(Gui.getTextFrom(MyLocale.getMsg(7118, "Stop")));
+						gpsRunning = true;
+					} catch (IOException e) {
+						(new MessageBox(MyLocale.getMsg(4403, "Error"), 
+							MyLocale.getMsg(99999, "Could not connect to GPSD.") 
+							+ e.getMessage()
+							+ MyLocale.getMsg(99999, "\npossible reasons:\nGPSD is not running or GPSD host is not reachable"), 
+							FormBase.OKB)).execute(); 
+					}
+				}else{
+					txtOutput.setText(MyLocale.getMsg(7117, "Displaying data from serial port directly:\n"));
+					try {
+						btnScan.set(ControlConstants.Disabled, true);
+						btnScan.repaintNow();
+						this.portName = Common.fixSerialPortName(portName);
+						serThread = new mySerialThread(this, txtOutput);
+						serThread.start();
+						btnTest.setText(Gui.getTextFrom(MyLocale.getMsg(7118, "Stop")));
+						gpsRunning = true;
+					} catch (IOException e) {
+						btnScan.set(ControlConstants.Disabled, false);
+						btnScan.repaintNow();
+						txtOutput.appendText(MyLocale.getMsg(7108, "Failed to open serial port: ") + this.portName + ", IOException: " + e.getMessage() + "\n", true);
+					}
 				}
 			}
 			else {
-				serThread.stop();
+				if(serThread!=null)
+					serThread.stop();
+				if(gpsdThread!=null)
+					gpsdThread.stop();
 				btnTest.setText(Gui.getTextFrom(MyLocale.getMsg(7104,"Test$t")));
 				gpsRunning = false;
 				btnScan.set(ControlConstants.Disabled, false);



From greiol at mail.berlios.de  Sun Jun 28 18:31:28 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Sun, 28 Jun 2009 18:31:28 +0200
Subject: [Cachewolf-svn] r1962 - trunk/src/exp
Message-ID: <200906281631.n5SGVSUY002184@sheep.berlios.de>

Author: greiol
Date: 2009-06-28 18:31:18 +0200 (Sun, 28 Jun 2009)
New Revision: 1962

Modified:
   trunk/src/exp/GpxExportNg.java
   trunk/src/exp/HTMLExporter.java
Log:
improved error messages
gpxexport now deletes cmt from main waypoints (as gc.com does)
number of logs to export is saved with preferences

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-28 09:55:29 UTC (rev 1961)
+++ trunk/src/exp/GpxExportNg.java	2009-06-28 16:31:18 UTC (rev 1962)
@@ -32,6 +32,7 @@
 import ewe.ui.Event;
 import ewe.ui.Form;
 import ewe.ui.FormBase;
+import ewe.ui.MessageBox;
 import ewe.ui.ProgressBarForm;
 import ewe.ui.mButton;
 import ewe.ui.mCheckBox;
@@ -61,6 +62,7 @@
 	final static String FALSE = "False";
 	private static GarminMap gm;
 	private int maxLogs = ewe.math.Number.INTEGER_MAX_VALUE;
+	private int exportErrors = 0;
 
 	final static String GPXHEADER = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"
 			.concat("<gpx xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" version=\"1.0\" creator=\"CacheWolf\" xsi:schemaLocation=\"http://www.topografix.com/GPX/1/0 http://www.topografix.com/GPX/1/0/gpx.xsd http://www.groundspeak.com/cache/1/0 http://www.groundspeak.com/cache/1/0/cache.xsd\" xmlns=\"http://www.topografix.com/GPX/1/0\">\n")
@@ -256,7 +258,8 @@
 				pbf.exit(0);
 				
 			} catch (Exception e) {
-				e.printStackTrace();
+				Global.getPref().log("GPX Export: unknown cause for ", e, Global.getPref().debug);
+				exportErrors++;
 				pbf.exit(0);
 			}
 		} else {
@@ -272,7 +275,12 @@
 			
 			if (outType == GPX_PQLIKE) {
 				maxLogs = exportOptions.getMaxLogs();
+				if (maxLogs != Global.getPref().numberOfLogsToExport) {
+					Global.getPref().numberOfLogsToExport = maxLogs;
+					Global.getPref().dirty = true;
+				}
 			}
+			
 			final File file;
 			final FileChooser fc = new FileChooser(FileChooserBase.SAVE, 
 					Global.getPref().getExportPath(expName+"-GPX"));
@@ -305,8 +313,9 @@
 					if (!ch.isVisible()) {
 						continue;
 					} else if (ch.is_incomplete()) {
+						exportErrors++;
 						Global.getPref().log(
-								"skipping export of incomplete waypoint "
+								"GPX Export: skipping export of incomplete waypoint "
 										+ ch.getWayPoint());
 					} else {
 						outp.print(formatCache(ch));
@@ -321,13 +330,17 @@
 				outp.print("</gpx>\n");
 				outp.close();
 			} catch (Exception ex) {
+				exportErrors++;
 				if (Global.getPref().debug)
-					Global.getPref().log("unable to write GPX output to " + file.toString(),ex);
+					Global.getPref().log("GPX Export: unable to write output to " + file.toString(),ex,Global.getPref().debug);
 				else
-					Global.getPref().log("unable to write GPX output to " + file.toString());
+					Global.getPref().log("GPX Export: unable to write output to " + file.toString());
 				// TODO: give a message to the user
 			}
 		}
+		if (exportErrors > 0) {
+			new MessageBox("Export Error", exportErrors+" errors during export. Check log for details.", FormBase.OKB).execute();
+		}
 	}
 
 	private String formatCache(CacheHolder ch) {
@@ -339,13 +352,24 @@
 
 		StringBuffer ret = new StringBuffer();
 
-		ret.append(formatCompact(ch));
+		try {
+			ret.append(formatCompact(ch));
 		
-		if (outType != GPX_COMPACT && !(ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt())) {
-			ret.append(formatPqExtensions(ch));
+			if (outType != GPX_COMPACT && !(ch.getType() == CacheType.CW_TYPE_CUSTOM || ch.isAddiWpt())) {
+				ret.append(formatPqExtensions(ch));
+			}
+		
+			ret.append("\t</wpt>\n");
+		} catch (IllegalArgumentException e) {
+			exportErrors++;
+			ch.setIncomplete(true);
+			Global.getPref().log("GPX Export: "+ch.getWayPoint()+" set to incomplete ", e, Global.getPref().debug);
+			return "";
+		} catch (Exception e) {
+			exportErrors++;
+			Global.getPref().log("GPX Export: "+ch.getWayPoint()+" caused ", e, Global.getPref().debug);
+			return "";
 		}
-		
-		ret.append("\t</wpt>\n");
 
 		return ret.toString();
 	}
@@ -403,7 +427,7 @@
 				if (ch.isAddiWpt()) {
 					trans.add(new Regex("@@WPCMT@@", SafeXML.cleanGPX(ch.getFreshDetails().LongDescription)));
 				} else {
-					trans.add(new Regex("@@WPCMT@@", ""));
+					trans.add(new Regex("\t\t<cmt>@@WPCMT@@</cmt>\n", ""));
 				}
 			}
 		}
@@ -599,7 +623,7 @@
 		}
 	}
 
-	public static String image2TypeText(String image) {
+	public String image2TypeText(String image) {
 		if (image.indexOf("icon_smile.gif") > -1)
 			return "Found it";
 		if (image.indexOf("icon_sad.gif") > -1)
@@ -630,7 +654,8 @@
 			return "Needs Maintenance";
 		if (image.indexOf("coord_update.gif") > -1)
 			return "Update Coordinates";
-		Global.getPref().log("unknown logtype "+image);
+		Global.getPref().log("GPX Export: unknown logtype "+image);
+		exportErrors++;
 		return "Write note";
 	}
 

Modified: trunk/src/exp/HTMLExporter.java
===================================================================
--- trunk/src/exp/HTMLExporter.java	2009-06-28 09:55:29 UTC (rev 1961)
+++ trunk/src/exp/HTMLExporter.java	2009-06-28 16:31:18 UTC (rev 1962)
@@ -226,8 +226,12 @@
 						PrintWriter pagefile = new PrintWriter(new BufferedWriter(new FileWriter(targetDir + ch.getWayPoint()+".html")));
 						pagefile.print(page_tpl.output());
 						pagefile.close();
-					}catch(Exception e){
+					} catch (IllegalArgumentException e) {
 						exportErrors++;
+						ch.setIncomplete(true);
+						Global.getPref().log("HTMLExport: "+ch.getWayPoint()+" is incomplete reason: ",e,Global.getPref().debug);
+					} catch(Exception e){
+						exportErrors++;
 						Global.getPref().log("HTMLExport: error wehen exporting "+ch.getWayPoint()+" reason: ",e,Global.getPref().debug);
 					}
 					if (exportErrors > 0) {



From greiol at mail.berlios.de  Mon Jun 29 19:39:13 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Mon, 29 Jun 2009 19:39:13 +0200
Subject: [Cachewolf-svn] r1963 - trunk/res_noewe
Message-ID: <200906291739.n5THdD3p001527@sheep.berlios.de>

Author: greiol
Date: 2009-06-29 19:39:09 +0200 (Mon, 29 Jun 2009)
New Revision: 1963

Added:
   trunk/res_noewe/100.gif
   trunk/res_noewe/101.gif
   trunk/res_noewe/102.gif
   trunk/res_noewe/103.gif
   trunk/res_noewe/104.gif
   trunk/res_noewe/images.gif
Removed:
   trunk/res_noewe/137.gif
   trunk/res_noewe/1858.gif
Log:
added missing icons for html export/local preview

Added: trunk/res_noewe/100.gif
===================================================================
(Binary files differ)


Property changes on: trunk/res_noewe/100.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Copied: trunk/res_noewe/101.gif (from rev 1962, trunk/res_noewe/1858.gif)


Property changes on: trunk/res_noewe/101.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Added: trunk/res_noewe/102.gif
===================================================================
(Binary files differ)


Property changes on: trunk/res_noewe/102.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Added: trunk/res_noewe/103.gif
===================================================================
(Binary files differ)


Property changes on: trunk/res_noewe/103.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Copied: trunk/res_noewe/104.gif (from rev 1962, trunk/res_noewe/137.gif)


Property changes on: trunk/res_noewe/104.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream
Name: svn:mergeinfo
   + 

Deleted: trunk/res_noewe/137.gif
===================================================================
(Binary files differ)

Deleted: trunk/res_noewe/1858.gif
===================================================================
(Binary files differ)

Added: trunk/res_noewe/images.gif
===================================================================
(Binary files differ)


Property changes on: trunk/res_noewe/images.gif
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream



From greiol at mail.berlios.de  Mon Jun 29 19:39:59 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Mon, 29 Jun 2009 19:39:59 +0200
Subject: [Cachewolf-svn] r1964 - trunk/src/CacheWolf/imp
Message-ID: <200906291739.n5THdxQv001592@sheep.berlios.de>

Author: greiol
Date: 2009-06-29 19:39:58 +0200 (Mon, 29 Jun 2009)
New Revision: 1964

Modified:
   trunk/src/CacheWolf/imp/SpiderGC.java
Log:
preserve rating

Modified: trunk/src/CacheWolf/imp/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/imp/SpiderGC.java	2009-06-29 17:39:09 UTC (rev 1963)
+++ trunk/src/CacheWolf/imp/SpiderGC.java	2009-06-29 17:39:58 UTC (rev 1964)
@@ -266,6 +266,8 @@
 					// the "found" state of an existing cache.
 					ch.setFound(true);
 				}
+				// preserve rating information
+				ch.setNumRecommended(cacheInDB.getNumRecommended());
 				cacheInDB.update(ch);
 				cacheInDB.save();
 			}



From greiol at mail.berlios.de  Mon Jun 29 19:42:32 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Mon, 29 Jun 2009 19:42:32 +0200
Subject: [Cachewolf-svn] r1965 - trunk/src/CacheWolf
Message-ID: <200906291742.n5THgWcR001849@sheep.berlios.de>

Author: greiol
Date: 2009-06-29 19:42:30 +0200 (Mon, 29 Jun 2009)
New Revision: 1965

Modified:
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/Preferences.java
Log:
moved gpsbabel detection to preferences

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2009-06-29 17:39:58 UTC (rev 1964)
+++ trunk/src/CacheWolf/MainMenu.java	2009-06-29 17:42:30 UTC (rev 1965)
@@ -65,7 +65,6 @@
 	private Form father;
 	private TablePanel tbp;
 	private FilterScreen scnFilter=new FilterScreen();
-	private boolean addExeToGpsbabel = false;
 	private static boolean searchInDescriptionAndNotes = false;
 	private static boolean searchInLogs = false;
 
@@ -108,33 +107,9 @@
 		exitems[6] = exportMSARCSV = new MenuItem(MyLocale.getMsg(106,"to MS AutoRoute CSV"));
 		exitems[7] = exportLOC = new MenuItem(MyLocale.getMsg(215,"to LOC"));
 		exitems[8] = exportGPS = new MenuItem(MyLocale.getMsg(122,"to GPS"));
-		boolean gpsbabelFound = false;
-		try{
-			// this will *only* work with ewe.jar at the moment
-			ewe.sys.Process p = Vm.exec("gpsbabel -V");
-			p.waitFor();
-			gpsbabelFound = true;
-		}catch(IOException ioex){
-			// Most of the time there will be an exception, so don't complain
-		}
-		if ( !gpsbabelFound ) {
-			try{
-				// this will *only* work with ewe.jar at the moment
-				ewe.sys.Process p = Vm.exec("gpsbabel.exe -V");
-				p.waitFor();
-				addExeToGpsbabel = true;
-				gpsbabelFound = true;
-			}catch(IOException ioex){
-				// Most of the time there will be an exception, so don't complain
-			}
-		}		
-		
-		if ( !gpsbabelFound ) {
+		if ( Global.getPref().gpsbabel == null ) {
 			exitems[8].modifiers = MenuItem.Disabled;	
 		}
-		
-		//exitems[8] = exportCacheMate = new MenuItem(MyLocale.getMsg(123,"to Cachemate"));
-		//if(!(new File(cwd + "/cmconvert/cmconvert.exe")).exists()) exitems[8].modifiers = MenuItem.Disabled;
 		exitems[9] = exportOZI = new MenuItem(MyLocale.getMsg(124,"to OZI"));
 		exitems[10] = exportKML = new MenuItem(MyLocale.getMsg(125,"to Google Earth"));
 		exitems[11] = exportExplorist = new MenuItem(MyLocale.getMsg(132,"to Explorist"));
@@ -435,6 +410,7 @@
 				loc.doIt();
 			}
 			if(mev.selectedItem == exportGPS){
+				String gpsBabelCommand;
 				Vm.showWait(true);
 				LocExporter loc = new LocExporter();
 				//String tmpFileName = FileBase.getProgramDirectory() + "/temp.loc";
@@ -444,21 +420,16 @@
 				loc.setTmpFileName(tmpFileName);
 				loc.doIt(LocExporter.MODE_AUTO);
 				ProgressBarForm.display(MyLocale.getMsg(950,"Transfer"),MyLocale.getMsg(951,"Sending to GPS"), null);
-				try{
-					String gpsBabelCommand = "";
-					if ( addExeToGpsbabel ) {
-						gpsBabelCommand = "gpsbabel.exe "+pref.garminGPSBabelOptions+" -i geo -f "+ tmpFileName +" -o garmin -F " + pref.garminConn +":";
-					} else {
-						gpsBabelCommand = "gpsbabel "+pref.garminGPSBabelOptions+" -i geo -f "+ tmpFileName +" -o garmin -F " + pref.garminConn +":";						
-					}
-					pref.log( gpsBabelCommand );
+				gpsBabelCommand = pref.gpsbabel+" "+pref.garminGPSBabelOptions+" -i geo -f "+ tmpFileName +" -o garmin -F " + pref.garminConn +":";
+				if (pref.debug)	pref.log( gpsBabelCommand );
+				try {
 					// this will *only* work with ewe.jar at the moment
 					ewe.sys.Process p = Vm.exec( gpsBabelCommand );
 					p.waitFor();
 				}catch(IOException ioex){
 					Vm.showWait(false);
 					(new MessageBox("Error", "Garmin export unsuccessful", FormBase.OKB)).execute();
-					pref.log("Error exporting to Garmin",ioex);
+					pref.log("Error exporting to Garmin",ioex,pref.debug);
 				};
 				ProgressBarForm.clear();
 				Vm.showWait(false);

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-29 17:39:58 UTC (rev 1964)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-29 17:42:30 UTC (rev 1965)
@@ -102,6 +102,8 @@
 			}
 		} else
 			fontSize = 11;
+		
+		setgpsbabel();
 	}
 
     //////////////////////////////////////////////////////////////////////////////////////
@@ -236,7 +238,7 @@
 
 	//////////////////////////////////////////////
 	/** The debug switch (Can be used to activate dormant code) by adding
-	 * the line: <pre><debug value="true"></pre>
+	 * the line: <pre><debug value="true" /></pre>
 	 * to the pref.xml file.
 	 */
 	public boolean debug = false;
@@ -913,4 +915,25 @@
 		}
 		return result;
 	}
+	
+	public String gpsbabel = null;
+	
+	public void setgpsbabel() {
+		try{
+			ewe.sys.Process p = Vm.exec("gpsbabel -V");
+			p.waitFor();
+			gpsbabel="gpsbabel";
+		}catch(IOException ioex){
+			// Most of the time there will be an exception, so don't complain
+		}
+		if ( gpsbabel == null ) {
+			try{
+				ewe.sys.Process p = Vm.exec("gpsbabel.exe -V");
+				p.waitFor();
+				gpsbabel = "gpsbabel.exe";
+			}catch(IOException ioex){
+				// Most of the time there will be an exception, so don't complain
+			}
+		}
+	}
 }



From greiol at mail.berlios.de  Mon Jun 29 19:47:11 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Mon, 29 Jun 2009 19:47:11 +0200
Subject: [Cachewolf-svn] r1966 - trunk/src/exp
Message-ID: <200906291747.n5THlB9Y002397@sheep.berlios.de>

Author: greiol
Date: 2009-06-29 19:47:10 +0200 (Mon, 29 Jun 2009)
New Revision: 1966

Modified:
   trunk/src/exp/TPLExporter.java
Log:
user decimal separator for terrain and difficulty

Modified: trunk/src/exp/TPLExporter.java
===================================================================
--- trunk/src/exp/TPLExporter.java	2009-06-29 17:42:30 UTC (rev 1965)
+++ trunk/src/exp/TPLExporter.java	2009-06-29 17:47:10 UTC (rev 1966)
@@ -197,8 +197,8 @@
 						varParams.put("SHORTSIZE", CacheSize.getExportShortId(ch.getCacheSize()));
 						varParams.put("WAYPOINT", ch.getWayPoint());
 						varParams.put("OWNER", ch.getCacheOwner());
-						varParams.put("DIFFICULTY", (ch.isAddiWpt() || CacheType.CW_TYPE_CUSTOM == ch.getType())?"":CacheTerrDiff.longDT(ch.getHard()));
-						varParams.put("TERRAIN", (ch.isAddiWpt() || CacheType.CW_TYPE_CUSTOM == ch.getType())?"":CacheTerrDiff.longDT(ch.getTerrain()));
+						varParams.put("DIFFICULTY", (ch.isAddiWpt() || CacheType.CW_TYPE_CUSTOM == ch.getType())?"":dec.replaceAll(CacheTerrDiff.longDT(ch.getHard())));
+						varParams.put("TERRAIN", (ch.isAddiWpt() || CacheType.CW_TYPE_CUSTOM == ch.getType())?"":dec.replaceAll(CacheTerrDiff.longDT(ch.getTerrain())));
 						varParams.put("DISTANCE", dec.replaceAll(ch.getDistance()));
 						varParams.put("BEARING", ch.bearing);
 						varParams.put("LATLON", ch.LatLon);



From greiol at mail.berlios.de  Mon Jun 29 21:39:23 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Mon, 29 Jun 2009 21:39:23 +0200
Subject: [Cachewolf-svn] r1967 - trunk/src/exp
Message-ID: <200906291939.n5TJdN71017571@sheep.berlios.de>

Author: greiol
Date: 2009-06-29 21:39:22 +0200 (Mon, 29 Jun 2009)
New Revision: 1967

Modified:
   trunk/src/exp/GpxExportNg.java
Log:
added support to send single gpx right to garmin

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-29 17:47:10 UTC (rev 1966)
+++ trunk/src/exp/GpxExportNg.java	2009-06-29 19:39:22 UTC (rev 1967)
@@ -26,6 +26,7 @@
 import ewe.sys.Convert;
 import ewe.sys.Date;
 import ewe.sys.Handle;
+import ewe.sys.Vm;
 import ewe.ui.CheckBoxGroup;
 import ewe.ui.Control;
 import ewe.ui.ControlEvent;
@@ -60,7 +61,7 @@
 	final static String expName = "GpxExportNG";
 	final static String TRUE = "True";
 	final static String FALSE = "False";
-	private static GarminMap gm;
+	private static GarminMap poiMapper;
 	private int maxLogs = ewe.math.Number.INTEGER_MAX_VALUE;
 	private int exportErrors = 0;
 
@@ -125,6 +126,10 @@
 	static int outType;
 
 	public GpxExportNg() {
+		// do nothing
+	}
+	
+	public void doit() {
 		GpxExportNgForm exportOptions;
 		int ret;
 
@@ -168,8 +173,8 @@
 			}
 			
 			if ((new File(baseDir+"/garminmap.xml")).exists()) {
-				gm=new GarminMap();
-				gm.readGarminMap();
+				poiMapper=new GarminMap();
+				poiMapper.readGarminMap();
 			} else {
 				//TODO: display warning
 				Global.getPref().log("unable to load garminmap.xml");
@@ -213,11 +218,11 @@
 								"skipping export of incomplete waypoint "
 										+ ch.getWayPoint());
 					} else {
-						String poiId = gm.getPoiId(ch);
+						String poiId = poiMapper.getPoiId(ch);
 						if (null == poiId) {
 							Global.getPref().log("unmatched POI ID for "+ch.getWayPoint());
+							exportErrors++;
 						} else {
-							File outFile;
 							PrintWriter writer;
 							if (fileHandles.containsKey(poiId)) {
 								writer = (PrintWriter) fileHandles.get(poiId);
@@ -265,8 +270,8 @@
 		} else {
 			if (customIcons) {
 				if ((new File(FileBase.getProgramDirectory()+"/garminmap.xml")).exists()) {
-					gm=new GarminMap();
-					gm.readGarminMap();
+					poiMapper=new GarminMap();
+					poiMapper.readGarminMap();
 				} else {
 					customIcons = false;
 					Global.getPref().log("unable to load garminmap.xml");
@@ -280,20 +285,22 @@
 					Global.getPref().dirty = true;
 				}
 			}
-			
-			final File file;
-			final FileChooser fc = new FileChooser(FileChooserBase.SAVE, 
+			final File file;	
+			if (! sendToGarmin) {
+				final FileChooser fc = new FileChooser(FileChooserBase.SAVE, 
 					Global.getPref().getExportPath(expName+"-GPX"));
 			
-			fc.setTitle("Select target GPX file:");
-			fc.addMask("*.gpx");
+				fc.setTitle("Select target GPX file:");
+				fc.addMask("*.gpx");
 			
-			if (fc.execute() == FormBase.IDCANCEL)
-				return;
+				if (fc.execute() == FormBase.IDCANCEL)
+					return;
 
-			file = fc.getChosenFile();
-			Global.getPref().setExportPath(expName+"-GPX", file.getPath());
-
+				file = fc.getChosenFile();
+				Global.getPref().setExportPath(expName+"-GPX", file.getPath());
+			} else {
+				file = new File("").createTempFile("gpxexport", null, null);
+			}
 			try {
 				ProgressBarForm pbf = new ProgressBarForm();
 				Handle h = new Handle();
@@ -337,6 +344,18 @@
 					Global.getPref().log("GPX Export: unable to write output to " + file.toString());
 				// TODO: give a message to the user
 			}
+			if (sendToGarmin) {
+				try {
+					String gpsBabelCommand;
+					gpsBabelCommand = Global.getPref().gpsbabel+" "+Global.getPref().garminGPSBabelOptions+" -i gpx -f "+ file.getCreationName() +" -o garmin -F " + Global.getPref().garminConn +":";
+					if (Global.getPref().debug) Global.getPref().log("GPX Export: gpsbabelcommand is "+ gpsBabelCommand);
+					ewe.sys.Process p = Vm.exec( gpsBabelCommand );
+					p.waitFor();
+				} catch (Exception ex) {
+					Global.getPref().log("GPX Export error :", ex, Global.getPref().debug);
+				}
+				file.delete();
+			}
 		}
 		if (exportErrors > 0) {
 			new MessageBox("Export Error", exportErrors+" errors during export. Check log for details.", FormBase.OKB).execute();
@@ -469,7 +488,7 @@
 		}
 
 		if (customIcons) {
-			trans.add(new Regex("@@WPSYMBOL@@", gm.getIcon(ch)));
+			trans.add(new Regex("@@WPSYMBOL@@", poiMapper.getIcon(ch)));
 		} else {
 			if (ch.isAddiWpt()) {
 				trans.add(new Regex("@@WPSYMBOL@@", CacheType.id2GpxString(
@@ -531,10 +550,6 @@
 		return ret.toString();
 	}
 
-	public void doit() {
-
-	}
-
 	public String formatTbs(CacheHolder ch) {
 		Transformer trans = new Transformer(true);
 		return "";
@@ -654,7 +669,7 @@
 			return "Needs Maintenance";
 		if (image.indexOf("coord_update.gif") > -1)
 			return "Update Coordinates";
-		Global.getPref().log("GPX Export: unknown logtype "+image);
+		Global.getPref().log("GPX Export: warning - unknown logtype "+image+" was changed to 'Write note'");
 		exportErrors++;
 		return "Write note";
 	}
@@ -703,7 +718,8 @@
 			cbSeperateFiles = new mCheckBox("one file per type");
 
 			cbSendToGarmin = new mCheckBox("send to Garmin GPSr");
-			cbSendToGarmin.modify(Control.Disabled, 0); // not yet
+			if (Global.getPref().gpsbabel == null)
+				cbSendToGarmin.modify(Control.Disabled, 0);
 
 			cbSmartId = new mCheckBox("use smart IDs");
 			
@@ -745,8 +761,9 @@
 							cbCustomIcons.repaint();
 						if (cbSeperateFiles.change(0, Control.Disabled))
 							cbSeperateFiles.repaint();
-						// if (cbSendToGarmin.change(0,Control.Disabled))
-						// cbSendToGarmin.repaint();
+						if (Global.getPref().gpsbabel != null)
+							if (cbSendToGarmin.change(0,Control.Disabled))
+								cbSendToGarmin.repaint();
 						if (cbSmartId.change(0, Control.Disabled))
 							cbSmartId.repaint();
 						if (ibMaxLogs.change(Control.Disabled, 0))
@@ -757,8 +774,9 @@
 							cbCustomIcons.repaint();
 						if (cbSeperateFiles.change(Control.Disabled, 0))
 							cbSeperateFiles.repaint();
-						// if (cbSendToGarmin.change(0,Control.Disabled))
-						// cbSendToGarmin.repaint();
+						if (Global.getPref().gpsbabel != null)
+							if (cbSendToGarmin.change(0,Control.Disabled))
+						 		cbSendToGarmin.repaint();
 						if (cbSmartId.change(0, Control.Disabled))
 							cbSmartId.repaint();
 						if (ibPrefix.change(Control.Disabled, 0))
@@ -774,8 +792,8 @@
 							cbCustomIcons.repaint();
 						if (cbSeperateFiles.change(Control.Disabled, 0))
 							cbSeperateFiles.repaint();
-						// if (cbSendToGarmin.change(Control.Disabled,0))
-						// cbSendToGarmin.repaint();
+						if (cbSendToGarmin.change(Control.Disabled,0))
+							cbSendToGarmin.repaint();
 						if (cbSmartId.change(Control.Disabled, 0))
 							cbSmartId.repaint();
 						if (ibPrefix.change(Control.Disabled, 0))
@@ -786,8 +804,13 @@
 				} else if (ev.target == cbSeperateFiles) {
 					if (cbSeperateFiles.state) {
 						if (ibPrefix.change(Control.Disabled, 1)) ibPrefix.repaint();
+						if (cbSendToGarmin.change(Control.Disabled, 0)) {
+							cbSendToGarmin.setState(false);
+							cbSendToGarmin.repaint();
+						}
 					} else {
 						if (ibPrefix.change(Control.Disabled, 0)) ibPrefix.repaint();
+						if (cbSendToGarmin.change(0, Control.Disabled)) cbSendToGarmin.repaint();
 					}
 				} else if (ev.target == btnOk) {
 					if (cbPqLike.state) {



From greiol at mail.berlios.de  Mon Jun 29 23:59:33 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Mon, 29 Jun 2009 23:59:33 +0200
Subject: [Cachewolf-svn] r1968 - trunk/res_noewe
Message-ID: <200906292159.n5TLxXY5001748@sheep.berlios.de>

Author: greiol
Date: 2009-06-29 23:59:31 +0200 (Mon, 29 Jun 2009)
New Revision: 1968

Modified:
   trunk/res_noewe/Garmin User Symbols.zip
Log:
added missing symbols. since enumerating them would exceed the capacity of some garmin devices they have generic names. user has to rename them to use with mapsource or handhelds

Modified: trunk/res_noewe/Garmin User Symbols.zip
===================================================================
(Binary files differ)



From araber95 at mail.berlios.de  Tue Jun 30 01:04:26 2009
From: araber95 at mail.berlios.de (araber95 at mail.berlios.de)
Date: Tue, 30 Jun 2009 01:04:26 +0200
Subject: [Cachewolf-svn] r1969 - trunk/res_noewe/webmapservices
Message-ID: <200906292304.n5TN4QWT030815@sheep.berlios.de>

Author: araber95
Date: 2009-06-30 01:04:22 +0200 (Tue, 30 Jun 2009)
New Revision: 1969

Added:
   trunk/res_noewe/webmapservices/us_p.wms
   trunk/res_noewe/webmapservices/us_t.wms
Log:
wms - for usa added

Added: trunk/res_noewe/webmapservices/us_p.wms
===================================================================
--- trunk/res_noewe/webmapservices/us_p.wms	2009-06-29 21:59:31 UTC (rev 1968)
+++ trunk/res_noewe/webmapservices/us_p.wms	2009-06-29 23:04:22 UTC (rev 1969)
@@ -0,0 +1,22 @@
+TakenFromUrl:       http://terraservice.net/
+GetCapabilitiesUrl: http://terraservice.net/ogccapabilities.ashx?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               USA photo
+MapType:                        photo
+MainUrl:            http://terraservice.net/ogcwms.aspx?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=DOQ|USGS Digital Ortho-Quadrangles||
+#LayersUrlPart:     LAYERS=DRG|USGS Raster Graphics (Topo Maps)||
+#LayersUrlPart:     LAYERS=UrbanArea|USGS Urban Areas Ortho-Imagery||
+LayersUrlPart:     LAYERS=DOQ
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 71.5500 W 168.6700
+BoundingBoxButtomRightWGS84: N 17.8400 W 65.1500
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   5
+ImageFileExtension: .jpg

Added: trunk/res_noewe/webmapservices/us_t.wms
===================================================================
--- trunk/res_noewe/webmapservices/us_t.wms	2009-06-29 21:59:31 UTC (rev 1968)
+++ trunk/res_noewe/webmapservices/us_t.wms	2009-06-29 23:04:22 UTC (rev 1969)
@@ -0,0 +1,22 @@
+TakenFromUrl:       http://terraservice.net/
+GetCapabilitiesUrl: http://terraservice.net/ogccapabilities.ashx?SERVICE=WMS&VERSION=1.1.1&REQUEST=GetCapabilities
+Name:               USA topo
+MapType:                        topo
+MainUrl:            http://terraservice.net/ogcwms.aspx?
+ServiceTypeUrlPart: SERVICE=WMS
+VersionUrlPart:     VERSION=1.1.1
+CoordinateReferenceSystemCacheWolf:  4326
+CoordinateReferenceSystemUrlPart: SRS=EPSG:4326 
+RequestUrlPart:     REQUEST=GetMap
+#LayersUrlPart:     LAYERS=DOQ|USGS Digital Ortho-Quadrangles||
+#LayersUrlPart:     LAYERS=DRG|USGS Raster Graphics (Topo Maps)||
+#LayersUrlPart:     LAYERS=UrbanArea|USGS Urban Areas Ortho-Imagery||
+LayersUrlPart:     LAYERS=DRG
+StylesUrlPart:     STYLES=
+ImageFormatUrlPart:FORMAT=image/jpeg
+BoundingBoxTopLeftWGS84: N 71.5500 W 168.6700
+BoundingBoxButtomRightWGS84: N 17.8400 W 65.1500
+MinScale:   0
+MaxScale:   45
+RecommendedScale:   5
+ImageFileExtension: .jpg



From greiol at mail.berlios.de  Tue Jun 30 07:59:43 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 30 Jun 2009 07:59:43 +0200
Subject: [Cachewolf-svn] r1970 - trunk/src/CacheWolf
Message-ID: <200906300559.n5U5xhrx005859@sheep.berlios.de>

Author: greiol
Date: 2009-06-30 07:59:41 +0200 (Tue, 30 Jun 2009)
New Revision: 1970

Modified:
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/Preferences.java
Log:
make windows exe work again

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2009-06-29 23:04:22 UTC (rev 1969)
+++ trunk/src/CacheWolf/MainMenu.java	2009-06-30 05:59:41 UTC (rev 1970)
@@ -69,6 +69,9 @@
 	private static boolean searchInLogs = false;
 
 	public MainMenu(Form f){
+		
+		Global.getPref().setgpsbabel();
+		
 		father = f;
 	
 		///////////////////////////////////////////////////////////////////////

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-06-29 23:04:22 UTC (rev 1969)
+++ trunk/src/CacheWolf/Preferences.java	2009-06-30 05:59:41 UTC (rev 1970)
@@ -102,8 +102,6 @@
 			}
 		} else
 			fontSize = 11;
-		
-		setgpsbabel();
 	}
 
     //////////////////////////////////////////////////////////////////////////////////////



From greiol at mail.berlios.de  Tue Jun 30 19:11:38 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 30 Jun 2009 19:11:38 +0200
Subject: [Cachewolf-svn] r1971 - in trunk: res_noewe src/CacheWolf
	src/CacheWolf/imp src/exp
Message-ID: <200906301711.n5UHBcGx031608@sheep.berlios.de>

Author: greiol
Date: 2009-06-30 19:11:28 +0200 (Tue, 30 Jun 2009)
New Revision: 1971

Added:
   trunk/res_noewe/icon_remove.gif
Modified:
   trunk/src/CacheWolf/CacheHolderDetail.java
   trunk/src/CacheWolf/imp/GPXImporter.java
   trunk/src/exp/GPXExporter.java
Log:
added icon_remove.gif for needs archived logs
extended logytpe <-> image translation

Added: trunk/res_noewe/icon_remove.gif
===================================================================
(Binary files differ)


Property changes on: trunk/res_noewe/icon_remove.gif
___________________________________________________________________
Name: svn:executable
   + *
Name: svn:mime-type
   + application/octet-stream

Modified: trunk/src/CacheWolf/CacheHolderDetail.java
===================================================================
--- trunk/src/CacheWolf/CacheHolderDetail.java	2009-06-30 05:59:41 UTC (rev 1970)
+++ trunk/src/CacheWolf/CacheHolderDetail.java	2009-06-30 17:11:28 UTC (rev 1971)
@@ -194,7 +194,7 @@
 				if (new FileBugfix(dir + getParent().getWayPoint() + ".xml").exists()) in = new FileReader(dir+getParent().getWayPoint() + ".xml");
 			}
 			if (in == null) throw new FileNotFoundException(dir+getParent().getWayPoint().toLowerCase()+".xml");
-			Global.getPref().log("Reading file "+getParent().getWayPoint() + ".xml");
+			if (Global.getPref().debug) Global.getPref().log("Reading file "+getParent().getWayPoint() + ".xml");
 			String text= in.readAll();
 			in.close();
 			Extractor ex = new Extractor(text, "<DETAILS><![CDATA[", "]]></DETAILS>", 0, true);		

Modified: trunk/src/CacheWolf/imp/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/imp/GPXImporter.java	2009-06-30 05:59:41 UTC (rev 1970)
+++ trunk/src/CacheWolf/imp/GPXImporter.java	2009-06-30 17:11:28 UTC (rev 1971)
@@ -72,7 +72,7 @@
 		inWpt = false;
 		inCache = false;
 		inLogs = false;
-		inBug =false;
+		inBug = false;
 	}
 /*	skg: This Constructor is not referenced, therefore commented out 
 	public GPXImporter(Vector DB, String[] f,String d, Preferences p)
@@ -294,7 +294,7 @@
 			//if (searchWpt(cacheDB, holder.wayPoint)== -1){
 			int index=cacheDB.getIndex(holder.getWayPoint());
 			//Vm.debug("here ?!?!?");
-			//Vm.debug("chould be new!!!!");
+			//Vm.debug("could be new!!!!");
 			if (index == -1){
 				holder.setNoFindLogs(holder.getFreshDetails().CacheLogs.countNotFoundLogs());
 				holder.setNew(true);
@@ -361,7 +361,6 @@
 		if (name.equals("groundspeak:name")&& inBug) {
 			Travelbug tb=new Travelbug(strData);
 			holder.getFreshDetails().Travelbugs.add(tb);
-			//holder.Bugs += "<b>Name:</b> " + strData + "<br><hr>";
 			holder.setHas_bugs(true);
 			return;
 		}
@@ -396,7 +395,7 @@
 			return;
 		}
 		//Vm.debug("Check: " + inWpt + " / " + fromOC);
-		//if (name.equals("desc") && inWpt && fromOC) {
+
 		// fill name with contents of <desc>, in case of gc.com the name is
 		// later replaced by the contents of <groundspeak:name> which is shorter
 		if (name.equals("desc")&& inWpt ) {
@@ -498,7 +497,7 @@
 		if (debugGPX) Vm.debug("Char: " + strBuf.toString());
 	}
 	
-
+	// if you change any of these make sure to check image2TypeText in the GPX exporters
 	public static String typeText2Image(String typeText){
 		if (typeText.equals("Found it")||typeText.equals("Found")||typeText.equals("find")) return "icon_smile.gif";
 		if (typeText.equals("Didn't find it")||typeText.equals("Not Found")||typeText.equals("no_find")) return "icon_sad.gif";
@@ -506,18 +505,19 @@
 			||typeText.equals("Not Attempted")||typeText.equals("Other")) return "icon_note.gif";
 		if (typeText.equals("Enable Listing")) return "icon_enabled.gif";
 		if (typeText.equals("Temporarily Disable Listing")) return "icon_disabled.gif";
-		if (typeText.equals("Webcam Photo Taken")) return "11.png";
+		if (typeText.equals("Webcam Photo Taken")) return "icon_camera.gif";
 		if (typeText.equals("Attended")) return "icon_attended.gif";
-		if (typeText.equals("Publish Listing")) return "green.png";
+		if (typeText.equals("Publish Listing")) return "icon_greenlight.gof";
 		if (typeText.equals("Will Attend")) return "icon_rsvp.gif";
 		if (typeText.equals("Post Reviewer Note")) return "big_smile.gif";
 		if (typeText.equals("Unarchive")) return "traffic_cone.gif";
-		if (typeText.equals("Archive (show)")) return "traffic_cone.gif";
+		if (typeText.equals("Archive")) return "traffic_cone.gif";
 		if (typeText.equals("Owner Maintenance")) return "icon_maint.gif";
 		if (typeText.equals("Needs Maintenance")) return "icon_needsmaint.gif";
+		if (typeText.equals("Needs Archived")) return "icon_remove.gif";
 		if (typeText.equals("Update Coordinates")) return "coord_update.gif";
-		//Vm.debug("Unknown Log Type:" + typeText);
-		return typeText;
+		Global.getPref().log("GPX Import: warning, unknown logtype "+typeText+" assuming Write note");
+		return "icon_note.gif";
 	}
 	
 	public static String TCSizetoText(String size){

Modified: trunk/src/exp/GPXExporter.java
===================================================================
--- trunk/src/exp/GPXExporter.java	2009-06-30 05:59:41 UTC (rev 1970)
+++ trunk/src/exp/GPXExporter.java	2009-06-30 17:11:28 UTC (rev 1971)
@@ -170,13 +170,14 @@
 		if (image.equals("icon_camera.gif")) return "Webcam Photo Taken";
 		if (image.equals("11.png")) return "Webcam Photo Taken";
 		if (image.equals("icon_attended.gif")) return "Attended";
-		if (image.equals("green.gif")) return "Publish Listing";
+		if (image.equals("icon_greenlight.gif")) return "Publish Listing";
 		if (image.equals("icon_rsvp.gif")) return "Will Attend";
 		if (image.equals("big_smile.gif")) return "Post Reviewer Note";
 		if (image.equals("traffic_cone.gif")) return "Archive (show)";
 		if (image.equals("icon_maint.gif")) return "Owner Maintenance";
 		if (image.equals("icon_needsmaint.gif")) return "Needs Maintenance";
 		if (image.equals("coord_update.gif")) return "Update Coordinates";
+		if (image.equals("icon_remove.gif")) return "Needs Archived";
 
 		return image;
 	}



From greiol at mail.berlios.de  Tue Jun 30 19:31:49 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 30 Jun 2009 19:31:49 +0200
Subject: [Cachewolf-svn] r1972 - trunk/src/exp
Message-ID: <200906301731.n5UHVnEj013396@sheep.berlios.de>

Author: greiol
Date: 2009-06-30 19:31:45 +0200 (Tue, 30 Jun 2009)
New Revision: 1972

Modified:
   trunk/src/exp/GpxExportNg.java
Log:
added Needs Archived
added support to extract poi icons from a zip file

Modified: trunk/src/exp/GpxExportNg.java
===================================================================
--- trunk/src/exp/GpxExportNg.java	2009-06-30 17:11:28 UTC (rev 1971)
+++ trunk/src/exp/GpxExportNg.java	2009-06-30 17:31:45 UTC (rev 1972)
@@ -21,7 +21,10 @@
 import ewe.io.BufferedWriter;
 import ewe.io.File;
 import ewe.io.FileBase;
+import ewe.io.FileOutputStream;
 import ewe.io.FileWriter;
+import ewe.io.IOException;
+import ewe.io.InputStream;
 import ewe.io.PrintWriter;
 import ewe.sys.Convert;
 import ewe.sys.Date;
@@ -42,6 +45,9 @@
 import ewe.util.Enumeration;
 import ewe.util.Hashtable;
 import ewe.util.Iterator;
+import ewe.util.zip.ZipEntry;
+import ewe.util.zip.ZipException;
+import ewe.util.zip.ZipFile;
 
 /**
  * experimental GPX exporter that should better handle the various tasks that
@@ -153,6 +159,7 @@
 			final String baseDir = FileBase.getProgramDirectory();
 			final String prefix = exportOptions.getPrefix();
 			final FileChooser fc;
+			ZipFile poiZip = null;
 			
 			if (sendToGarmin) { 
 				fc = new FileChooser(FileChooserBase.DIRECTORY_SELECT,Global.getPref().getExportPath(expName+"-GPI"));
@@ -188,12 +195,12 @@
 				tempDir = outDir;
 				String tmp[] = new FileBugfix(tempDir).list(prefix + "*.gpx", ewe.io.FileBase.LIST_FILES_ONLY);
 				for (int i=0; i < tmp.length;i++){
-					FileBugfix tmpFile = new FileBugfix(tempDir + tmp[i]);
+					FileBugfix tmpFile = new FileBugfix(tempDir + File.separator + tmp[i]);
 					tmpFile.delete();
 				}
 				tmp = new FileBugfix(tempDir).list(prefix + "*.bmp", ewe.io.FileBase.LIST_FILES_ONLY);
 				for (int i=0; i < tmp.length;i++){
-					FileBugfix tmpFile = new FileBugfix(tempDir + tmp[i]);
+					FileBugfix tmpFile = new FileBugfix(tempDir + File.separator + tmp[i]);
 					tmpFile.delete();
 				}
 			}
@@ -240,18 +247,28 @@
 					h.changed();
 				}
 				
+				try {
+					poiZip = new ZipFile (FileBase.getProgramDirectory() + File.separator + "GarminPOI.zip");
+				} catch (IOException e) {
+					Global.getPref().log("GPX Export: warning GarminPOI.zip not found", e, Global.getPref().debug);
+					exportErrors++;
+				}
+				
 				Enumeration keys = fileHandles.keys();
 				while (keys.hasMoreElements()) {
 					String key = (String) keys.nextElement();
 					PrintWriter writer = (PrintWriter) fileHandles.get(key);
 					writer.print("</gpx>\n");
 					writer.close();
+					if (poiZip != null)
+						if (!copyPoiIcon(outDir,key,prefix,poiZip)) 
+							exportErrors++;
 				}
 				
 				if (sendToGarmin) {
 					String tmp[] = new FileBugfix(outDir).list(prefix + "*.gpi", ewe.io.FileBase.LIST_FILES_ONLY);
 					for (int i=0; i < tmp.length;i++){
-						FileBugfix tmpFile = new FileBugfix(tempDir + tmp[i]);
+						FileBugfix tmpFile = new FileBugfix(tempDir + File.separator + tmp[i]);
 						tmpFile.delete();
 					}				
 
@@ -639,41 +656,31 @@
 	}
 
 	public String image2TypeText(String image) {
-		if (image.indexOf("icon_smile.gif") > -1)
-			return "Found it";
-		if (image.indexOf("icon_sad.gif") > -1)
-			return "Didn't find it";
-		if (image.indexOf("icon_note.gif") > -1)
-			return "Write note";
-		if (image.indexOf("icon_enabled.gif") > -1)
-			return "Enable Listing";
-		if (image.indexOf("icon_disabled.gif") > -1)
-			return "Temporarily Disable Listing";
-		if (image.indexOf("icon_camera.gif") > -1)
-			return "Webcam Photo Taken";
-		if (image.indexOf("11.png") > -1)
-			return "Webcam Photo Taken";
-		if (image.indexOf("icon_attended.gif") > -1)
-			return "Attended";
-		if (image.indexOf("green.gif") > -1)
-			return "Publish Listing";
-		if (image.indexOf("icon_rsvp.gif") > -1)
-			return "Will Attend";
-		if (image.indexOf("big_smile.gif") > -1)
-			return "Post Reviewer Note";
-		if (image.indexOf("traffic_cone.gif") > -1)
-			return "Archive (show)";
-		if (image.indexOf("icon_maint.gif") > -1)
-			return "Owner Maintenance";
-		if (image.indexOf("icon_needsmaint.gif") > -1)
-			return "Needs Maintenance";
-		if (image.indexOf("coord_update.gif") > -1)
-			return "Update Coordinates";
+		if (image.equals("icon_smile.gif")) return "Found it";
+		if (image.equals("icon_sad.gif")) return "Didn't find it";
+		if (image.equals("icon_note.gif")) return "Write note";
+		if (image.equals("icon_enabled.gif")) return "Enable Listing";
+		if (image.equals("icon_disabled.gif")) return "Temporarily Disable Listing";
+		if (image.equals("icon_camera.gif")) return "Webcam Photo Taken";
+		if (image.equals("icon_attended.gif")) return "Attended";
+		if (image.equals("icon_greenlight.gif")) return "Publish Listing";
+		if (image.equals("icon_rsvp.gif")) return "Will Attend";
+		if (image.equals("big_smile.gif")) return "Post Reviewer Note";
+		if (image.equals("traffic_cone.gif")) return "Archive";
+		if (image.equals("icon_maint.gif")) return "Owner Maintenance";
+		if (image.equals("icon_needsmaint.gif")) return "Needs Maintenance";
+		if (image.equals("coord_update.gif")) return "Update Coordinates";
+		if (image.equals("icon_remove.gif")) return "Needs Archived";
 		Global.getPref().log("GPX Export: warning - unknown logtype "+image+" was changed to 'Write note'");
 		exportErrors++;
 		return "Write note";
 	}
 
+	/**
+	 * create a position information suitable for a gc.com PQlike export
+	 * @param pos position
+	 * @return if position is valid return the cachewolf formatted position, otherwise return teh string used in PQs
+	 */
 	private String formatAddiLatLon(CWPoint pos) {
 		if (pos.isValid()) {
 			return pos.toString();
@@ -681,6 +688,32 @@
 			return "N/S  __ ? __ . ___ W/E ___ ? __ . ___";
 		}
 	}
+	
+	boolean copyPoiIcon(String outdir, String type, String prefix, ZipFile poiZip) {
+		ZipEntry icon;
+		byte[] buff;
+		int len;
+		
+		try {	
+			icon = poiZip.getEntry(type+".bmp");
+			if (icon == null) return false; // icon not found in archive
+			
+			buff = new byte[ icon.getSize() ];
+			InputStream  fis = poiZip.getInputStream(icon);
+			FileOutputStream fos = new FileOutputStream(outdir.concat(File.separator).concat(prefix).concat(type).concat(".bmp"));
+			while( 0 < (len = fis.read( buff )) ) fos.write( buff, 0, len );
+			fos.flush();
+			fos.close();
+			fis.close();
+		} catch (ZipException e) {
+			Global.getPref().log("failed to copy icon "+type+".bmp", e, Global.getPref().debug);
+			return false;
+		} catch (IOException e) {
+			Global.getPref().log("failed to copy icon "+type+".bmp", e, Global.getPref().debug);
+			return false;
+		}
+		return true;
+	}
 
 	/**
 	 * dialog to set the GPX exporter options



From greiol at mail.berlios.de  Tue Jun 30 20:59:33 2009
From: greiol at mail.berlios.de (greiol at mail.berlios.de)
Date: Tue, 30 Jun 2009 20:59:33 +0200
Subject: [Cachewolf-svn] r1973 - trunk
Message-ID: <200906301859.n5UIxXkK002888@sheep.berlios.de>

Author: greiol
Date: 2009-06-30 20:59:31 +0200 (Tue, 30 Jun 2009)
New Revision: 1973

Modified:
   trunk/build.xml
Log:
include changed images in build

Modified: trunk/build.xml
===================================================================
--- trunk/build.xml	2009-06-30 17:31:45 UTC (rev 1972)
+++ trunk/build.xml	2009-06-30 18:59:31 UTC (rev 1973)
@@ -57,8 +57,8 @@
 	<!-- lists of files to be packaged, this should become less confusing later on -->
 	<property name="template.files" value="*.tpl"/>
 	<property name="icons.gui.files" value="dnf.gif,bug.gif,red.png,yellow.png,blue.png"/>
-	<property name="icons.log.files" value="traffic_cone.gif,recommendedlog.gif,icon_smile.gif,icon_sad.gif,icon_rsvp.gif,icon_note.gif,icon_needsmaint.gif,icon_maint.gif,icon_enabled.gif,icon_disabled.gif,icon_camera.gif,icon_attended.gif,big_smile.gif,coord_update.gif,icon_greenlight.gif,icon_redlight.gif"/>
-	<property name="icons.cache.files" value="11.gif,8.gif,6.gif,5.gif,4.gif,3.gif,2.gif,1858.gif,13.gif,137.gif,12.gif"/>
+	<property name="icons.log.files" value="traffic_cone.gif,recommendedlog.gif,icon_smile.gif,icon_sad.gif,icon_rsvp.gif,icon_note.gif,icon_needsmaint.gif,icon_maint.gif,icon_enabled.gif,icon_disabled.gif,icon_camera.gif,icon_attended.gif,big_smile.gif,coord_update.gif,icon_greenlight.gif,icon_redlight.gif,icon_remove.gif"/>
+	<property name="icons.cache.files" value="11.gif,8.gif,6.gif,5.gif,4.gif,3.gif,2.gif,13.gif,12.gif,100.gif,101.gif,102.gif,103.gif,104.gif"/>
 	<property name="icons.browser.files" value="g.png,g2.png,y.png,y2.png"/>
 	<property name="doc.files" value="wolflang.html,GCTemplate.html,info.html,legende.html"/>
 



