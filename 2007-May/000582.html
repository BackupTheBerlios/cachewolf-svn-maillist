<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r711 - in trunk: resources src/CacheWolf
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2007-May/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r711%20-%20in%20trunk%3A%20resources%20src/CacheWolf&In-Reply-To=%3C200705272348.l4RNmjVU029289%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000581.html">
   <LINK REL="Next"  HREF="000583.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r711 - in trunk: resources src/CacheWolf</H1>
    <B>salzkammergut at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r711%20-%20in%20trunk%3A%20resources%20src/CacheWolf&In-Reply-To=%3C200705272348.l4RNmjVU029289%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r711 - in trunk: resources src/CacheWolf">salzkammergut at mail.berlios.de
       </A><BR>
    <I>Mon May 28 01:48:45 CEST 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000581.html">[Cachewolf-svn] r710 - trunk/src/CacheWolf
</A></li>
        <LI>Next message: <A HREF="000583.html">[Cachewolf-svn] r712 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#582">[ date ]</a>
              <a href="thread.html#582">[ thread ]</a>
              <a href="subject.html#582">[ subject ]</a>
              <a href="author.html#582">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: salzkammergut
Date: 2007-05-28 01:48:40 +0200 (Mon, 28 May 2007)
New Revision: 711

Added:
   trunk/resources/spider.def
Modified:
   trunk/src/CacheWolf/Profile.java
   trunk/src/CacheWolf/SpiderGC.java
   trunk/src/CacheWolf/myTableControl.java
Log:
Spider: Umbau auf Tabellensteuerung und Aufraeumen
Es gibt jetzt nur mehr eine Spider-routine, die sowohl von Spidersingle und doIt aufgerufen wird
Einbau einer Begrenzung der Logs auf 250 (Kann in Zukunft ueber Praeferenzen angepa?\195?\159t werden)
Merken des Passwortes (innerhalb eines Programmlaufes)
Noch zu machen: Vermeiden Bilder mehrfach zu laden

Added: trunk/resources/spider.def
===================================================================
--- trunk/resources/spider.def	2007-05-27 23:43:02 UTC (rev 710)
+++ trunk/resources/spider.def	2007-05-27 23:48:40 UTC (rev 711)
@@ -0,0 +1,107 @@
+#============================================================
+# spider.def - Definition file for reading caches from GC.COM
+# Version 1.0 - 20070526 skg
+#============================================================
+# A suffix of Rex indicates a regular expression
+# A suffix of ExStart indicates the start of an Extractor search pattern
+# A suffix of ExEnd indicates the end of an Extractor search pattern
+#
+# Important:
+# * When entering spaces into a string ensure to escape them or write them as \\u0020
+# * Be sure that you have no hidden spaces at the end of a line or the patterns will not match!
+#------------------------------------------------------------
+loginPage          = <A HREF="http://www.geocaching.com/login/Default.aspx">http://www.geocaching.com/login/Default.aspx</A>
+nextPage           = /login/default.aspx
+#--------------------------------------
+#Section1: First page with list of caches
+#--------------------------------------
+firstPage          = <A HREF="http://www.geocaching.com/seek/nearest.aspx?lat=">http://www.geocaching.com/seek/nearest.aspx?lat=</A>
+firstPage2         = &amp;lon=
+# Regex to search for cachenames 
+lineRex            = &lt;tr bgcolor=((?s).*?)&lt;/tr&gt;
+listBlockRex       = &lt;table id=&quot;dlResults&quot;((?s).*?)&lt;/table&gt;
+distRex            = &lt;br\ /&gt;(.*?)(km|mi)&lt;/td&gt;
+waypointRex        = &lt;/a&gt; \\((.*?)\\)&lt;br&gt;
+showOnlyFound      = &amp;f=1
+nextListPage       = /seek/nearest.aspx
+
+#--------------------------------------
+#Section2: Get cachepage by name
+#--------------------------------------
+getPageByName      = <A HREF="http://www.geocaching.com/seek/cache_details.aspx?wp=">http://www.geocaching.com/seek/cache_details.aspx?wp=</A>
+fetchAllLogs       = &amp;log=y
+cacheUnavailable   = This\ cache\ is\ temporarily\ unavailable
+cacheArchived      = This cache\ has\ been\ archived
+latLonRex          = &lt;span\ id=&quot;LatLon&quot;&gt;&lt;.*?&gt;((?s).*?)&lt;/STRONG&gt;
+shortDescRex       = &lt;span\ id=&quot;ShortDescription&quot;&gt;((?s).*?)&lt;/span&gt;
+longDescRex        = &lt;span\ id=&quot;LongDescription&quot;&gt;((?s).*?)&lt;strong&gt;Additional\ Hints
+cacheNameRex       = &lt;span\ id=&quot;CacheName&quot;&gt;((?s).*?)&lt;/span&gt;
+cacheOwnerRex      = &lt;span\ id=&quot;CacheOwner&quot;.*?by ((?s).*?)\\[&lt;A\ HREF=
+dateHiddenRex      = &lt;span\ id=&quot;DateHidden&quot;&gt;((?s).*?)&lt;/span&gt;
+hintsRex           = &lt;span\ id=&quot;Hints&quot;\ class=&quot;displayMe&quot;&gt;((?s).*?)&lt;/span&gt;
+sizeRex            = This\ is\ a\ &lt;strong&gt;((?s).*?)&lt;/strong&gt;\ cache
+difficultyRex      = &lt;span\ id=&quot;Difficulty&quot;&gt;.*?alt=&quot;(.*?)\ out\ of
+terrainRex         = &lt;span\ id=&quot;Terrain&quot;&gt;.*?alt=&quot;(.*?)\ out\ of
+cacheTypeRex       = &lt;img\ src=&quot;../images/WptTypes/(.*?)\\.gif
+
+#--------------------------------------
+#Section2a: Logs
+#--------------------------------------
+# blockRex extrahiert zun&#228;chst aus der gesamten Seite den Logbereich
+blockRex           = &lt;span\ id=&quot;CacheLogs&quot;&gt;((?s).*?)&lt;/span&gt;
+# singleLogEx extrahiert in einer Schleife alle Logs aus dem Logbereich
+singleLogExStart   = &lt;STRONG&gt;
+singleLogExEnd     = [&lt;A\ href=
+# iconEx, nameTempEx, dateEx, singleLogEx werden auf einen singleLog angewendet
+iconExStart        = <A HREF="http://www.geocaching.com/images/icons/">http://www.geocaching.com/images/icons/</A>
+iconExEnd          = '\ align='abs
+nameTempExStart    = &lt;A\ HREF=&quot;
+nameTempExEnd      = /A&gt;
+# Name extrahiert aus nameTemp
+nameExStart        = &gt;
+nameExEnd          = &lt;
+dateExStart        = align='absmiddle'&gt;&nbsp;
+dateExEnd          = \ by\ &lt;
+logExStart         = found)
+logExEnd           = &lt;br&gt;[
+# Die Icons, die einen erfolgreichen Fund signalisieren
+icon_smile         = icon_smile.gif
+icon_camera        = icon_camera.gif
+
+#--------------------------------------
+#Section2b: Bugs
+#--------------------------------------
+# blockEx extrahiert zun&#228;chst den Bugbereich aus der gesamten Seite
+blockExStart       = &gt;&nbsp;Inventory&lt;/td&gt;
+blockExEnd         = What\ is\ a\ Travel\ Bug?
+# bugEx extrahiert die Namen der einzelnen Bugs aus dem Bugbereich
+bugExStart         = &lt;a\ href='
+bugExEnd           = &lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;
+bugDetailsStart    = id=&quot;BugDetail_BugGoal&quot;&gt;
+bugDetailsEnd      = &lt;/span&gt;
+
+#--------------------------------------
+#Section2c: Images
+#--------------------------------------
+# imgBlockEx searches for images in the long description
+imgBlockExStart    = &lt;IMG
+imgBlockExEnd      = &gt;
+# imgSpanEx searches for images in the image section
+imgSpanExStart     = &lt;span\ id=&quot;Images&quot;
+imgSpanExEnd       = &lt;/span&gt;
+imgNameExStart     = align=absmiddle\ border=0&gt;
+imgNameExEnd       = &lt;/a&gt;&lt;br/&gt;
+imgSrcExStart      = &lt;A\ HREF='<A HREF="http://">http://</A>
+imgSrcExEnd        = '\ rel='lightbox'
+
+#--------------------------------------
+#Section2d: Additional waypoints
+#--------------------------------------
+wayBlockExStart    = &lt;strong&gt;Additional\ Waypoints&lt;/strong&gt;&lt;br&gt;
+wayBlockExEnd      = &lt;/table&gt;
+nameRex            = &amp;RefDS=1&quot;&gt;(.*)&lt;/a&gt;
+koordRex           = align=&quot;left&quot;&gt;([NSns]\ [0-9]{1,2}..[0-9]{1,2}.[0-9]{1,3}\ [EWew]\ [0-9]{1,3}..[0-9]{1,2}.[0-9]{1,3})&lt;/td&gt;
+descRex            = colspan=&quot;4&quot;&gt;(.*)&lt;/td&gt;
+typeRex            = &lt;/a&gt;\ \\((.*)\\)&lt;/td&gt;
+rowBlockExStart    = &lt;tr
+rowBlockExEnd      = &lt;/tr&gt;

Modified: trunk/src/CacheWolf/Profile.java
===================================================================
--- trunk/src/CacheWolf/Profile.java	2007-05-27 23:43:02 UTC (rev 710)
+++ trunk/src/CacheWolf/Profile.java	2007-05-27 23:48:40 UTC (rev 711)
@@ -100,97 +100,7 @@
 		saveIndex(pref,showprogress, Filter.filterActive,Filter.filterInverted);
 	}
 
-	/**
-	 * Method to write the header for the index file.
-	 * Should be used when memory becomes critical and storage
-	 * in the cachedb vector poses a problem (see spiderGC)
-	 *
-	 */
-	public void openIndex(Preferences pref){
-		boolean saveFilterActive = Filter.filterActive;
-		boolean saveFilterInverted = Filter.filterInverted;
-		PrintWriter detfile;
-		try{
-			detfile = new PrintWriter(new BufferedWriter(new FileWriter(dataDir + &quot;indextemp.xml&quot;)));
-		} catch (Exception e) {
-			Vm.debug(&quot;Problem creating index file &quot;+e.toString()+&quot;\nFilename=&quot;+dataDir + &quot;index.xml&quot;);
-			return;
-		}
-		CWPoint savedCentre=centre;
-		if (centre==null || !centre.isValid() || (savedCentre.latDec==0.0 &amp;&amp; savedCentre.lonDec==0.0)) savedCentre=pref.curCentrePt;
-		try{
-			detfile.print(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;ISO-8859-1\&quot;?&gt;\n&quot;);
-			detfile.print(&quot;&lt;CACHELIST format=\&quot;decimal\&quot;&gt;\n&quot;);
-			if (savedCentre.isValid())
-				detfile.print(&quot;    &lt;CENTRE lat=\&quot;&quot;+savedCentre.latDec+&quot;\&quot; lon=\&quot;&quot;+savedCentre.lonDec+&quot;\&quot;/&gt;\n&quot;);
-			if(last_sync_opencaching == null || last_sync_opencaching.endsWith(&quot;null&quot;) || last_sync_opencaching.equals(&quot;&quot;)){
-				last_sync_opencaching = &quot;20050801000000&quot;;
-			}
-			if(distOC == null || distOC.endsWith(&quot;null&quot;) || distOC.equals(&quot;&quot;)){
-				distOC = &quot;0&quot;;
-			}
-
-			detfile.print(&quot;    &lt;FILTER status = \&quot;&quot;+(saveFilterActive?&quot;T&quot;:&quot;F&quot;)+(saveFilterInverted?&quot;T&quot;:&quot;F&quot;)+ 
-					&quot;\&quot; rose = \&quot;&quot;+filterRose+&quot;\&quot; type = \&quot;&quot;+filterType+
-					&quot;\&quot; var = \&quot;&quot;+filterVar+&quot;\&quot; dist = \&quot;&quot;+filterDist.replace('&quot;',' ')+&quot;\&quot; diff = \&quot;&quot;+
-					filterDiff+&quot;\&quot; terr = \&quot;&quot;+filterTerr+&quot;\&quot; size = \&quot;&quot;+filterSize+&quot;\&quot; /&gt;\n&quot;);
-			detfile.print(&quot;    &lt;SYNCOC date = \&quot;&quot;+last_sync_opencaching+&quot;\&quot; dist = \&quot;&quot;+distOC+&quot;\&quot;/&gt;\n&quot;);
-			detfile.close();
-			byPassIndexActive = true;
-		}catch(Exception e){
-			Vm.debug(&quot;Problem writing to index file &quot;+e.toString());
-			detfile.close();
-		}
-	}
 	
-	/**
-	 * Method to appen a single line of cachedate to the index file
-	 * @param ch
-	 */
-	public void writeIndexLine(CacheHolder ch){
-		Stream strout = null;
-		//Vm.debug(&quot;Datadir:&quot; + dataDir);
-		File index = new File(dataDir + &quot;indextemp.xml&quot;);
-		String cachedata = &quot;    &lt;CACHE name = \&quot;&quot;+SafeXML.clean(ch.CacheName)+&quot;\&quot; owner = \&quot;&quot;+SafeXML.clean(ch.CacheOwner)+
-				&quot;\&quot; lat = \&quot;&quot;+ ch.pos.latDec + &quot;\&quot; lon = \&quot;&quot;+ch.pos.lonDec+
-				&quot;\&quot; hidden = \&quot;&quot;+ch.DateHidden+&quot;\&quot; wayp = \&quot;&quot;+SafeXML.clean(ch.wayPoint)+&quot;\&quot; status = \&quot;&quot;+ch.CacheStatus+&quot;\&quot; type = \&quot;&quot;+ch.type+&quot;\&quot; dif = \&quot;&quot;+ch.hard+&quot;\&quot; terrain = \&quot;&quot; + ch.terrain + &quot;\&quot; dirty = \&quot;&quot; + ch.dirty + &quot;\&quot; size = \&quot;&quot;+ch.CacheSize+&quot;\&quot; online = \&quot;&quot; + Convert.toString(ch.is_available) + &quot;\&quot; archived = \&quot;&quot; + Convert.toString(ch.is_archived) + &quot;\&quot; has_bug = \&quot;&quot; + Convert.toString(ch.has_bug) + &quot;\&quot; black = \&quot;&quot; + Convert.toString(ch.is_black) + &quot;\&quot; owned = \&quot;&quot; + Convert.toString(ch.is_owned) + &quot;\&quot; found = \&quot;&quot; + Convert.toString(ch.is_found) + &quot;\&quot; is_new = \&quot;&quot; + Convert.toString(ch.is_new) +&quot;\&quot; is_log_update = \&quot;&quot; + Convert.toString(ch.is_log_update) + &quot;\&quot; is_update = \&quot;&quot; + Convert.toString(ch.is_update) + &quot;\&quot; is_HTML = \&quot;&quot; + Convert.toString(ch.is_HTML) + &quot;\&quot; DNFLOGS = \&quot;&quot; + ch.noFindLogs + &quot;\&quot; ocCacheID = \&quot;&quot; + ch.ocCacheID + &quot;\&quot; is_INCOMPLETE = \&quot;&quot;+Convert.toString(ch.is_incomplete)+&quot;\&quot; /&gt;\n&quot;;
-		try{
-			//append data!
-			strout = index.toWritableStream(true);
-			byte[] data = cachedata.getBytes(); 
-			strout.write(data);
-			//Vm.debug(&quot;Line: &quot; + cachedata);
-		}catch(Exception ex){
-			Vm.debug(&quot;Problem writing to index&quot;);
-		}
-		finally{
-			strout.close();
-		}
-	}
-	
-	/**
-	 * Use this method to &quot;finalize&quot; the index file when using openIndex()
-	 * and writeIndexLine()
-	 *
-	 */
-	public void closeIndex(){
-		Stream strout = null;
-		File index = new File(dataDir + &quot;indextemp.xml&quot;);
-		try{
-			//append data!
-			strout = index.toWritableStream(true);
-			byte[] data = &quot;&lt;/CACHELIST&gt;\n&quot;.getBytes(); 
-			strout.write(data);
-			strout.close();
-			File old = new File(dataDir + &quot;index.xml&quot;);
-			old.delete();
-			index.rename(&quot;index.xml&quot;);
-			File indextemp = new File(dataDir + &quot;indextemp.xml&quot;);
-			indextemp.delete();
-			byPassIndexActive = false;
-		}catch(Exception ex){};
-	}
-	
 	/** Save index with filter settings given */ 
 	public void saveIndex(Preferences pref, boolean showprogress, boolean saveFilterActive, boolean saveFilterInverted){
 		ProgressBarForm pbf = new ProgressBarForm();

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-05-27 23:43:02 UTC (rev 710)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-05-27 23:48:40 UTC (rev 711)
@@ -33,11 +33,14 @@
 
 /**
 *	Class to spider caches from gc.com
-*	It uses a generic parse tree to parse the page and build a gpx file.
-*	ClassID (for cachewolf.languages.cfg = 5500
 */
 public class SpiderGC{
 	
+	/**
+	 * The maximum number of logs that will be stored
+	 */
+	public static int MAXLOGS=250;
+	
 	private static int ERR_LOGIN = -10;
 	private static Preferences pref;
 	private Profile profile;
@@ -49,9 +52,27 @@
 	Regex inRex = new Regex();
 	Vector cacheDB;
 	Vector cachesToLoad = new Vector();
-	Hashtable indexDB = new Hashtable();
+	Hashtable indexDB;
 	InfoBox infB;
+	private static Properties p=null; 
 	
+	public SpiderGC(Preferences prf, Profile profile, boolean bypass){
+		this.profile=profile;
+		this.cacheDB = profile.cacheDB;
+		pref = prf;
+		try {
+			if (p==null) {
+				p=new Properties();
+				p.load(new FileInputStream(&quot;spider.def&quot;));
+			}
+		} catch (Exception ex) {
+			p=null;
+			pref.log(&quot;Failed to load spider.def&quot;,ex);
+			// We don't display an error message box here, as the call to 
+			// spiderSingle or doIt will do this
+		}
+	}
+	
 	/**
 	 * Method to login the user to gc.com
 	 * It will request a password and use the alias defined in preferences
@@ -59,10 +80,10 @@
 	public int login(){
 		pref.logInit();
 		//Access the page once to get a viewstate
-		String start = &quot;&quot;;
-		String doc = &quot;&quot;;
+		String start,doc,loginPage;
 		//Get password
 		InfoBox infB = new InfoBox(&quot;Password&quot;, &quot;Enter password:&quot;, InfoBox.INPUT);
+		infB.feedback.setText(passwort); // Remember the PWD for next time
 		int code = infB.execute();
 		passwort = infB.getInput();
 		infB.close(0);
@@ -72,9 +93,10 @@
 		infB.exec();
 		try{
 			pref.log(&quot;Fetching login page&quot;);
-			start = fetch(&quot;<A HREF="http://www.geocaching.com/login/Default.aspx">http://www.geocaching.com/login/Default.aspx</A>&quot;);
+			start = fetch(loginPage=p.getProperty(&quot;loginPage&quot;));   //<A HREF="http://www.geocaching.com/login/Default.aspx">http://www.geocaching.com/login/Default.aspx</A>
 		}catch(Exception ex){
 			pref.log(&quot;Could not fetch: gc.com start page&quot;,ex);
+			passwort=&quot;&quot;;
 			return ERR_LOGIN;
 		}
 		if (!infB.isClosed) {
@@ -89,16 +111,16 @@
 			//Ok now login!
 			try{
 				pref.log(&quot;Logging in as &quot;+pref.myAlias);
-				doc = URL.encodeURL(&quot;__VIEWSTATE&quot;,false) +&quot;=&quot;+ URL.encodeURL(viewstate,false);
-				doc += &quot;&amp;&quot; + URL.encodeURL(&quot;myUsername&quot;,false) +&quot;=&quot;+ URL.encodeURL(pref.myAlias,false);
-				doc += &quot;&amp;&quot; + URL.encodeURL(&quot;myPassword&quot;,false) +&quot;=&quot;+ URL.encodeURL(passwort,false);
-				doc += &quot;&amp;&quot; + URL.encodeURL(&quot;cookie&quot;,false) +&quot;=&quot;+ URL.encodeURL(&quot;on&quot;,false);
-				doc += &quot;&amp;&quot; + URL.encodeURL(&quot;Button1&quot;,false) +&quot;=&quot;+ URL.encodeURL(&quot;Login&quot;,false);
-				start = fetch_post(&quot;<A HREF="http://www.geocaching.com/login/Default.aspx">http://www.geocaching.com/login/Default.aspx</A>&quot;, doc, &quot;/login/default.aspx&quot;);
+				doc = URL.encodeURL(&quot;__VIEWSTATE&quot;,false) +&quot;=&quot;+ URL.encodeURL(viewstate,false)
+					+ &quot;&amp;&quot; + URL.encodeURL(&quot;myUsername&quot;,false) +&quot;=&quot;+ URL.encodeURL(pref.myAlias,false)
+				    + &quot;&amp;&quot; + URL.encodeURL(&quot;myPassword&quot;,false) +&quot;=&quot;+ URL.encodeURL(passwort,false)
+				    + &quot;&amp;&quot; + URL.encodeURL(&quot;cookie&quot;,false) +&quot;=&quot;+ URL.encodeURL(&quot;on&quot;,false)
+				    + &quot;&amp;&quot; + URL.encodeURL(&quot;Button1&quot;,false) +&quot;=&quot;+ URL.encodeURL(&quot;Login&quot;,false);
+				start = fetch_post(loginPage, doc, p.getProperty(&quot;nextPage&quot;));  // /login/default.aspx
 				pref.log(&quot;Login successful&quot;);
 			}catch(Exception ex){
 				//Vm.debug(&quot;Could not login: gc.com start page&quot;);
-				pref.log(&quot;Login failed.&quot;);
+				pref.log(&quot;Login failed.&quot;, ex);
 				infB.close(0);
 				return ERR_LOGIN;
 			}
@@ -126,150 +148,58 @@
 	 * @return True if spider was successful, false if spider was cancelled by closing the infobox
 	 */
 	public boolean spiderSingle(int number, InfoBox infB){
+		boolean ret=false;
 		this.infB = infB;
+		if (p==null) {
+			(new MessageBox(MyLocale.getMsg(5500,&quot;Error&quot;), &quot;Could not load 'spider.def'&quot;, MessageBox.OKB)).execute();
+			return false;
+		}
 		CacheHolder ch = (CacheHolder)cacheDB.get(number);
-		if (ch.isAddiWpt()) return false;  // No point spidering an addi waypoint, comes with parent
-		//Vm.showWait(true); Already done in myTableControl
+		if (ch.isAddiWpt()) return false;  // No point re-spidering an addi waypoint, comes with parent
+
 		CacheHolderDetail chD=new CacheHolderDetail(ch);
-		String notes = &quot;&quot;;
-		String start = &quot;&quot;;
-		String origLong = &quot;&quot;;
 		try{
+			// Get all existing details of the cache
 			chD.readCache(profile.dataDir);
+			// Read the cache data from GC.COM and compare to old data
+			ret=getCacheByWaypointName(chD,true,true,false,true);
+			// Save the spidered data 
+			if (ret) {
+				pref.log(&quot;Saving to:&quot; + profile.dataDir);
+				chD.saveCacheDetails(profile.dataDir);
+				cacheDB.set(number, new CacheHolder(chD)); // TODO Could copy into existing object
+			}
 		}catch(IOException ioex){
 			pref.log(&quot;Could not load &quot; + chD.wayPoint + &quot;file in spiderSingle&quot;);
 		}
-		//notes = chD.CacheNotes;
-		
-		
-		String doc = &quot;<A HREF="http://www.geocaching.com/seek/cache_details.aspx?wp=">http://www.geocaching.com/seek/cache_details.aspx?wp=</A>&quot; + chD.wayPoint +&quot;&amp;log=y&quot;;
-		try{
-			pref.log(&quot;Fetching: &quot; + chD.wayPoint);
-			start = fetch(doc);
-		}catch(Exception ex){
-			pref.log(&quot;Could not fetch &quot; + chD.wayPoint);
-			chD.is_incomplete = true;
-			//Redundant: cacheDB.set(number, ch);
-			//Vm.debug(&quot;Couldn't get cache detail page&quot;);
-		}
-		if (!infB.isClosed) { // Only analyse the cache data if user has not closed the progress window
-			try{
-				chD.is_new = false;
-				chD.is_update = false;
-				chD.is_HTML = true;
-				chD.is_available = true;
-				chD.is_archived = false;
-				chD.is_incomplete = false;
-				chD.CacheLogs.clear();
-				chD.addiWpts.clear();
-				chD.Images.clear();
-				chD.ImagesText.clear();
-				//Vm.debug(chD.wayPoint);
-				
-				if(start.indexOf(&quot;This cache is temporarily unavailable&quot;) &gt;= 0) chD.is_available = false;
-				if(start.indexOf(&quot;This cache has been archived&quot;) &gt;= 0) chD.is_archived = true;
-				pref.log(&quot;Trying logs&quot;);
-				int logsz = chD.CacheLogs.size();
-				chD.CacheLogs = getLogs(start, chD);
-				int z = 0;
-				String loganal = &quot;&quot;;
-				while(z &lt; chD.CacheLogs.size() &amp;&amp; z &lt; 5){
-					loganal = (String)chD.CacheLogs.get(z);
-					if(loganal.indexOf(&quot;icon_sad&quot;)&gt;0) {
-						z++;
-					}else break;
-				}
-				chD.noFindLogs = z;
-				chD.is_log_update = false;
-				if(chD.CacheLogs.size()&gt;logsz) chD.is_log_update = true;
-				pref.log(&quot;Found logs&quot;);
-				chD.LatLon = getLatLon(start);
-				chD.pos.set(chD.LatLon);
-				//Vm.debug(&quot;LatLon: &quot; + chD.LatLon);
-				pref.log(&quot;Trying description&quot;);
-				origLong = chD.LongDescription;
-				chD.LongDescription = getLongDesc(start);
-				if(!chD.LongDescription.equals(origLong)) chD.is_update = true;
-				pref.log(&quot;Got description&quot;);
-				pref.log(&quot;Getting cache name&quot;);
-				chD.CacheName = SafeXML.cleanback(getName(start));
-				pref.log(&quot;Got cache name&quot;);
-				//Vm.debug(&quot;Name: &quot; + chD.CacheName);
-				pref.log(&quot;Trying owner&quot;);
-				chD.CacheOwner = SafeXML.cleanback(getOwner(start)).trim();
-				if(chD.CacheOwner.equals(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; chD.CacheOwner.equals(pref.myAlias2))) chD.is_owned = true;
-				pref.log(&quot;Got owner&quot;);
-				//Vm.debug(&quot;Owner: &quot; + chD.CacheOwner);
-				pref.log(&quot;Trying date hidden&quot;);
-				chD.DateHidden = DateFormat.MDY2YMD(getDateHidden(start));
-				pref.log(&quot;Got date hidden&quot;);
-				//Vm.debug(&quot;Hidden: &quot; + chD.DateHidden);
-				pref.log(&quot;Trying hints&quot;);
-				chD.Hints = getHints(start);
-				pref.log(&quot;Got hints&quot;);
-				//Vm.debug(&quot;Hints: &quot; + chD.Hints);
-				//Vm.debug(&quot;Got the hints&quot;);
-				pref.log(&quot;Trying size&quot;);
-				chD.CacheSize = getSize(start);
-				pref.log(&quot;Got size&quot;);
-				//Vm.debug(&quot;Size: &quot; + chD.CacheSize);
-				pref.log(&quot;Trying difficulty&quot;);
-				chD.hard = getDiff(start);
-				pref.log(&quot;Got difficulty&quot;);
-				//Vm.debug(&quot;Hard: &quot; + chD.hard);
-				pref.log(&quot;Trying terrain&quot;);
-				chD.terrain = getTerr(start);
-				pref.log(&quot;Got terrain&quot;);
-				if (!infB.isClosed) chD.Bugs = getBugs(start);
-				chD.has_bug = chD.Bugs.length()&gt;0;
-				//Vm.debug(&quot;Terr: &quot; + chD.terrain);
-				pref.log(&quot;Trying cache type&quot;);
-				chD.type = getType(start);
-				pref.log(&quot;Got cache type&quot;);
-				//Vm.debug(&quot;Type: &quot; + chD.type);
-				pref.log(&quot;Trying images&quot;);
-				getImages(start, chD);
-				pref.log(&quot;Got images&quot;);
-				//pref.log(&quot;Trying maps&quot;);
-				//getMaps(ch);
-				//pref.log(&quot;Got maps&quot;);
-				pref.log(&quot;Getting additional waypoints&quot;);
-				
-				getAddWaypoints(start, chD.wayPoint, chD.is_found);
-		
-				pref.log(&quot;Got additional waypoints&quot;);
-				//chD.CacheNotes = notes;
-				if (!infB.isClosed) {
-					chD.saveCacheDetails(profile.dataDir);
-					pref.log(&quot;Saving to:&quot; + profile.dataDir);
-					cacheDB.set(number, new CacheHolder(ch)); // TODO Could copy into existing object
-				}
-			}catch(Exception ex){
-				pref.log(&quot;Exception in spider: &quot; +ex.toString());
-			}
-			finally{}
-		}
-		boolean ret=!infB.isClosed; // If the infoBox was closed before getting here, we return false
-		//Vm.showWait(false); In myTableControl
 		return ret;
-	}
+	} // spiderSingle
 	
 	/**
 	*	Method to start the spider for a search around the center coordinates
 	*/
 	public void doIt(){
-		String postStr = new String();
-		String dummy = &quot;&quot;;
-		Regex rexLine;
-		String ln=null;
-		String wpt = &quot;&quot;;
-		String loganal;
+		String postStr, dummy, ln, wpt;
+		Regex lineRex;
 		CacheHolderDetail chD;
+		if (p==null) {
+			(new MessageBox(MyLocale.getMsg(5500,&quot;Error&quot;), &quot;Could not load 'spider.def'&quot;, MessageBox.OKB)).execute();
+			return;
+		}
 		CWPoint origin = pref.curCentrePt; // No need to copy curCentrePt as it is only read and not written
 		if (!origin.isValid()) {
 			(new MessageBox(&quot;Error&quot;, &quot;Coordinates for center must be set&quot;, MessageBox.OKB)).execute();
 			return;
 		}
+		// Prepare an index of caches for faster searching
+		indexDB = new Hashtable(cacheDB.size());
+		CacheHolder ch;
+		//index the database for faster searching!
+		for(int i = 0; i&lt;cacheDB.size();i++){
+			ch = (CacheHolder)cacheDB.get(i);
+			indexDB.put((String)ch.wayPoint, new Integer(i));
+			ch.is_new = false;
+		}
 		String start = &quot;&quot;;
 		Regex rex = new Regex(&quot;name=\&quot;__VIEWSTATE\&quot; value=\&quot;(.*)\&quot; /&gt;&quot;);
 		String doc = &quot;&quot;;
@@ -288,18 +218,19 @@
 		String dist = options.distanceInput.getText();
 		if (dist.length()== 0) return;
 		distance = Convert.toDouble(dist);
-		//boolean getMaps = options.mapsCheckBox.getState();
 		boolean doNotgetFound = options.foundCheckBox.getState();
-		//Vm.debug(&quot;Do not get found? &quot;+doNotgetFound);
 		boolean getImages = options.imagesCheckBox.getState();
 		options.close(0);
 		
+		//=======
+		// Prepare list of all caches that are to be spidered
+		//=======
 		Vm.showWait(true);
 		infB = new InfoBox(&quot;Status&quot;, MyLocale.getMsg(5502,&quot;Fetching first page...&quot;));
 		infB.exec();
 		//Get first page
 		try{
-			ln = &quot;<A HREF="http://www.geocaching.com/seek/nearest.aspx?lat=">http://www.geocaching.com/seek/nearest.aspx?lat=</A>&quot; + origin.getLatDeg(CWPoint.DD) + &quot;&amp;lon=&quot; +origin.getLonDeg(CWPoint.DD);
+			ln = p.getProperty(&quot;firstPage&quot;) + origin.getLatDeg(CWPoint.DD) + p.getProperty(&quot;firstPage2&quot;) +origin.getLonDeg(CWPoint.DD);
 			if(doNotgetFound) ln = ln + &quot;&amp;f=1&quot;;
 			pref.log(&quot;Getting first page: &quot;+ln);
 			start = fetch(ln);
@@ -307,15 +238,14 @@
 		}catch(Exception ex){
 			infB.close(0);
 			(new MessageBox(MyLocale.getMsg(5500,&quot;Error&quot;), MyLocale.getMsg(5503,&quot;Error fetching first list page.&quot;), MessageBox.OKB)).execute();
-			pref.log(&quot;Error fetching first list page&quot;);
-			//Vm.debug(&quot;Could not get list&quot;);
+			pref.log(&quot;Error fetching first list page&quot;,ex);
 			Vm.showWait(false);
 			return;
 		}
 		dummy = &quot;&quot;;
 		//String lineBlck = &quot;&quot;;
 		int page_number = 4;		
-		rexLine = new Regex(&quot;&lt;tr bgcolor=((?s).*?)&lt;/tr&gt;&quot;);
+		lineRex = new Regex(p.getProperty(&quot;lineRex&quot;)); //&quot;&lt;tr bgcolor=((?s).*?)&lt;/tr&gt;&quot;
 		int found_on_page = 0;
 		//Loop till maximum distance has been found or no more caches are in the list
 		while(distance &gt; 0){
@@ -323,52 +253,41 @@
 			rex.search(start);
 			viewstate = rex.stringMatched(1);
 			//Vm.debug(&quot;In loop&quot;);
-			dummy = getListBlock(start);
-			/*
+			Regex listBlockRex = new Regex(p.getProperty(&quot;listBlockRex&quot;)); // &quot;&lt;table id=\&quot;dlResults\&quot;((?s).*?)&lt;/table&gt;&quot;
+			listBlockRex.search(start);
+			dummy = listBlockRex.stringMatched(1);
 			try{
-				  PrintWriter detfile = new PrintWriter(new BufferedWriter(new FileWriter(&quot;debug.txt&quot;)));
-				  detfile.print(dummy);
-				  detfile.close();
-				} catch (Exception e) {
-					Vm.debug(&quot;Problem opening details file&quot;);
-				}
-			*/
-			try{
-				rexLine.search(dummy);
+				lineRex.search(dummy);
 			}catch(NullPointerException nex){}
-			
-			while(rexLine.didMatch()){
+			while(lineRex.didMatch()){
 				//Vm.debug(getDist(rexLine.stringMatched(1)) + &quot; / &quot; +getWP(rexLine.stringMatched(1)));
 				found_on_page++;
-				if(getDist(rexLine.stringMatched(1)) &lt;= distance){
-					if(indexDB.get((String)getWP(rexLine.stringMatched(1))) == null){
-						cachesToLoad.add(getWP(rexLine.stringMatched(1)));
-					} else pref.log(getWP(rexLine.stringMatched(1))+&quot; already in DB&quot;);
+				if(getDist(lineRex.stringMatched(1)) &lt;= distance){
+					if(indexDB.get((String)getWP(lineRex.stringMatched(1))) == null){
+						cachesToLoad.add(getWP(lineRex.stringMatched(1)));
+					} else pref.log(getWP(lineRex.stringMatched(1))+&quot; already in DB&quot;);
 				} else distance = 0;
-				rexLine.searchFrom(dummy, rexLine.matchedTo());
+				lineRex.searchFrom(dummy, lineRex.matchedTo());
 			}
 			infB.setInfo(&quot;Found &quot; + cachesToLoad.size() + &quot; caches&quot;);
 			if(found_on_page &lt; 20) distance = 0;
-			postStr = &quot;<A HREF="http://www.geocaching.com/seek/nearest.aspx?">http://www.geocaching.com/seek/nearest.aspx?</A>&quot; + origin.getLatDeg(CWPoint.DD) + &quot;&amp;&quot; + origin.getLonDeg(CWPoint.DD);
-			if(doNotgetFound) postStr = postStr + &quot;&amp;f=1&quot;;
+			postStr = p.getProperty(&quot;firstLine&quot;) + origin.getLatDeg(CWPoint.DD) + &quot;&amp;&quot; + origin.getLonDeg(CWPoint.DD);
+			if(doNotgetFound) postStr = postStr + p.getProperty(&quot;showOnlyFound&quot;);
 			if(distance &gt; 0){
 				page_number++;
 				if(page_number &gt;= 15) page_number = 5;
-				doc = URL.encodeURL(&quot;__VIEWSTATE&quot;,false) +&quot;=&quot;+ URL.encodeURL(viewstate,false);
-				//doc += &quot;&amp;&quot; + URL.encodeURL(&quot;lat&quot;,false) +&quot;=&quot;+ URL.encodeURL(origin.getLatDeg(CWPoint.DD),false);
-				//doc += &quot;&amp;&quot; + URL.encodeURL(&quot;lon&quot;,false) +&quot;=&quot;+ URL.encodeURL(origin.getLonDeg(CWPoint.DD),false);
+				doc = URL.encodeURL(&quot;__VIEWSTATE&quot;,false) +&quot;=&quot;+ URL.encodeURL(viewstate,false)
 				//if(doNotgetFound) doc += &quot;&amp;f=1&quot;;
-				doc += &quot;&amp;&quot; + URL.encodeURL(&quot;__EVENTTARGET&quot;,false) +&quot;=&quot;+ URL.encodeURL(&quot;ResultsPager:_ctl&quot;+page_number,false);
-				doc += &quot;&amp;&quot; + URL.encodeURL(&quot;__EVENTARGUMENT&quot;,false) +&quot;=&quot;+ URL.encodeURL(&quot;&quot;,false);
+				    + &quot;&amp;&quot; + URL.encodeURL(&quot;__EVENTTARGET&quot;,false) +&quot;=&quot;+ URL.encodeURL(&quot;ResultsPager:_ctl&quot;+page_number,false)
+				    + &quot;&amp;&quot; + URL.encodeURL(&quot;__EVENTARGUMENT&quot;,false) +&quot;=&quot;+ URL.encodeURL(&quot;&quot;,false);
 				try{
 					start = &quot;&quot;;
 					pref.log(&quot;Fetching next list page:&quot; + doc);
-					start = fetch_post(postStr, doc, &quot;/seek/nearest.aspx&quot;);
+					start = fetch_post(postStr, doc, p.getProperty(&quot;nextListPage&quot;));
 				}catch(Exception ex){
 					//Vm.debug(&quot;Couldn't get the next page&quot;);
 					pref.log(&quot;Error getting next page&quot;);
 				}finally{
-					
 				}
 			}
 			//Vm.debug(&quot;Distance is now: &quot; + distance);
@@ -377,10 +296,9 @@
 		
 		pref.log(&quot;Found &quot; + cachesToLoad.size() + &quot; caches&quot;);
 		if (!infB.isClosed) infB.setInfo(&quot;Found &quot; + cachesToLoad.size() + &quot; caches&quot;);
-		
-		// Now ready to spider each cache
-		
-		chD = new CacheHolderDetail();
+		//=======
+		// Now ready to spider each cache in the list
+		//=======
 		for(int i = 0; i&lt;cachesToLoad.size(); i++){
 			if (infB.isClosed) break;
 			
@@ -388,125 +306,177 @@
 			// Get only caches not already available in the DB
 			if(searchWpt(wpt) == -1){
 				infB.setInfo(&quot;Loading: &quot; + wpt +&quot;(&quot; + (i+1) + &quot; / &quot; + cachesToLoad.size() + &quot;)&quot;);
-				doc = &quot;<A HREF="http://www.geocaching.com/seek/cache_details.aspx?wp=">http://www.geocaching.com/seek/cache_details.aspx?wp=</A>&quot; + wpt +&quot;&amp;log=y&quot;;
-				start = &quot;&quot;;
-				try{
-					pref.log(&quot;Fetching: &quot; + wpt);
-					start = fetch(doc);
-				}catch(Exception ex){
-					pref.log(&quot;Could not fetch detail page for: &quot; + wpt);
-					//Vm.debug(&quot;Couldn't get cache detail page&quot;);
-				}finally{
-					//	just continue please!
-					pref.log(&quot;Trying for details.&quot;);
-				}
-				if(start != null &amp;&amp; start.length()!=0){
-					pref.log(&quot;Fetch doc ok... going into details.&quot;);
-					chD.is_new = true;
-					chD.is_HTML = true;
-					chD.is_available = true;
-					chD.is_archived = false;
-					chD.wayPoint = wpt;
-					if(start.indexOf(&quot;This cache is temporarily unavailable&quot;) &gt;= 0) chD.is_available = false;
-					if(start.indexOf(&quot;This cache has been archived&quot;) &gt;= 0) chD.is_archived = true;
-					//Vm.debug(chD.wayPoint);
-					try{
-						pref.log(&quot;Trying logs&quot;);
-						chD.CacheLogs = getLogs(start, chD);
-						int z = 0;
-						loganal = &quot;&quot;;
-						while(z &lt; chD.CacheLogs.size() &amp;&amp; z &lt; 5){
-							loganal = (String)chD.CacheLogs.get(z);
-							if(loganal.indexOf(&quot;icon_sad&quot;)&gt;0) {
-								z++;
-							}else break;
-						}
-						chD.noFindLogs = z;
-						pref.log(&quot;Found logs&quot;);
-						chD.LatLon = getLatLon(start);
-						chD.pos.set(chD.LatLon); // Slow parse no problem
-						//Vm.debug(&quot;LatLon: &quot; + chD.LatLon);
-						pref.log(&quot;Trying description&quot;);
-						chD.LongDescription = getLongDesc(start);
-						
-						pref.log(&quot;Got description&quot;);
-						pref.log(&quot;Getting cache name&quot;);
-						chD.CacheName = SafeXML.cleanback(getName(start));
-						pref.log(&quot;Got cache name&quot;);
-						//Vm.debug(&quot;Name: &quot; + chD.CacheName);
-						pref.log(&quot;Trying owner&quot;);
-						chD.CacheOwner = SafeXML.cleanback(getOwner(start)).trim();
-						if(chD.CacheOwner.equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; chD.CacheOwner.equalsIgnoreCase(pref.myAlias2))) chD.is_owned = true;
-						pref.log(&quot;Got owner&quot;);
-						//Vm.debug(&quot;Owner: &quot; + chD.CacheOwner);
-						pref.log(&quot;Trying date hidden&quot;);
-						chD.DateHidden = getDateHidden(start);
-						pref.log(&quot;Got date hidden&quot;);
-						//Vm.debug(&quot;Hidden: &quot; + chD.DateHidden);
-						pref.log(&quot;Trying hints&quot;);
-						chD.Hints = getHints(start);
-						pref.log(&quot;Got hints&quot;);
-						//Vm.debug(&quot;Hints: &quot; + chD.Hints);
-						//Vm.debug(&quot;Got the hints&quot;);
-						pref.log(&quot;Trying size&quot;);
-						chD.CacheSize = getSize(start);
-						pref.log(&quot;Got size&quot;);
-						//Vm.debug(&quot;Size: &quot; + chD.CacheSize);
-						pref.log(&quot;Trying difficulty&quot;);
-						chD.hard = getDiff(start);
-						pref.log(&quot;Got difficulty&quot;);
-						//Vm.debug(&quot;Hard: &quot; + chD.hard);
-						pref.log(&quot;Trying terrain&quot;);
-						chD.terrain = getTerr(start);
-						pref.log(&quot;Got terrain&quot;);
-						//Vm.debug(&quot;Terr: &quot; + chD.terrain);
-						pref.log(&quot;Trying cache type&quot;);
-						chD.type = getType(start);
-						pref.log(&quot;Got cache type&quot;);
-						//Vm.debug(&quot;Type: &quot; + chD.type);
-						if(getImages){
-							pref.log(&quot;Trying images&quot;);
-							getImages(start, chD);
-							pref.log(&quot;Got images&quot;);
-						}
-						if (infB.isClosed) {
-							
-							break;
-						}
-						chD.Bugs = getBugs(start);
-						if(chD.Bugs.length()&gt;0) chD.has_bug = true; else chD.has_bug = false;
-						pref.log(&quot;Getting additional waypoints&quot;);
-						getAddWaypoints(start, chD.wayPoint, chD.is_found);
-						pref.log(&quot;Got additional waypoints&quot;);
-						
-						if(doNotgetFound) {
-							if(!chD.is_found) profile.writeIndexLine(chD);
-						} else profile.writeIndexLine(chD);
-						
-						chD.saveCacheDetails(profile.dataDir);
-						
-						chD = new CacheHolderDetail();
-					}catch(Exception ex){
-						pref.log(&quot;There was an error in the last step:&quot;);
-						pref.log(&quot;Cache was: &quot; + wpt);
-						pref.log(&quot;Error was: &quot; + ex.toString());
-						chD.is_incomplete = true;
-						if(doNotgetFound) {
-							if(!chD.is_found) profile.writeIndexLine(chD);
-						} else profile.writeIndexLine(chD);
-						
-						chD = new CacheHolderDetail();
-					}finally{
-						//just continue please!
-						pref.log(&quot;Continuing with next cache.&quot;);
-					}
-				}
+				chD = new CacheHolderDetail();
+				chD.wayPoint=wpt;
+				if (!getCacheByWaypointName(chD,false,getImages,doNotgetFound,true)) break;
+				if (!chD.is_found || !doNotgetFound ) {
+					chD.saveCacheDetails(profile.dataDir);
+					cacheDB.add(new CacheHolder(chD)); // TODO Could copy into existing object
+				}					
 			}
 		}
-		profile.closeIndex();
 		infB.close(0);
 		Vm.showWait(false);
+		Global.getProfile().saveIndex(Global.getPref(),true);
 	}
+
+	/**
+	 * Read a complete cachepage from geocaching.com including all logs. This is used both when
+	 * updating already existing caches (via spiderSingle) and when spidering around a centre. It
+	 * is also used when reading a GPX file and fetching the images.
+	 * 
+	 * This is the workhorse function of the spider.
+	 * 
+	 * @param CacheHolderDetail chD The element wayPoint must be set to the name of a waypoint
+	 * @param boolean isUpdate True if an existing cache is being updated, false if it is a new cache
+	 * @param boolean fetchImages True if the pictures are to be fetched
+	 * @param boolean doNotGetFound True if the cache is not to be spidered if it has already been found
+	 * @param boolean fetchAllLogs True if all logs are to be fetched (by adding option '&amp;logs=y' to command line).
+	 *     This is normally false when spidering from GPXImport as the logs are part of the GPX file, and true otherwise
+	 * @return false if the infoBox was closed
+	 */
+	private boolean getCacheByWaypointName(CacheHolderDetail chD, boolean isUpdate, boolean fetchImages, boolean doNotGetFound, boolean fetchAllLogs) {
+		String completeWebPage,origLongDesc;
+		String doc = p.getProperty(&quot;getPageByName&quot;) + chD.wayPoint +(fetchAllLogs?p.getProperty(&quot;fetchAllLogs&quot;):&quot;&quot;);
+		try{
+			pref.log(&quot;Fetching: &quot; + chD.wayPoint);
+			completeWebPage = fetch(doc);
+		}catch(Exception ex){
+			pref.log(&quot;Could not fetch &quot; + chD.wayPoint,ex);
+			chD.is_incomplete = true;
+			return !infB.isClosed;
+		}
+		// Only analyse the cache data and fetch pictures if user has not closed the progress window
+		if (!infB.isClosed) { 
+			try{
+				chD.is_new = !isUpdate;
+				chD.is_update = false;
+				chD.is_HTML = true;
+				chD.is_available = true;
+				chD.is_archived = false;
+				chD.is_incomplete = false;
+				chD.CacheLogs.clear();
+				chD.addiWpts.clear();
+				chD.Images.clear();
+				chD.ImagesText.clear();
+				
+				if(completeWebPage.indexOf(p.getProperty(&quot;cacheUnavailable&quot;)) &gt;= 0) chD.is_available = false;
+				if(completeWebPage.indexOf(p.getProperty(&quot;cacheArchived&quot;)) &gt;= 0) chD.is_archived = true;
+				//==========
+				// General Cache Data
+				//==========
+				chD.LatLon = getLatLon(completeWebPage);
+				chD.pos.set(chD.LatLon);
+				if (pref.debug) pref.log(&quot;LatLon: &quot; + chD.LatLon);
+				
+				pref.log(&quot;Trying description&quot;);
+				origLongDesc = chD.LongDescription;
+				chD.LongDescription = getLongDesc(completeWebPage);
+				if(isUpdate &amp;&amp; !chD.LongDescription.equals(origLongDesc)) chD.is_update = true;
+				pref.log(&quot;Got description&quot;);
+				
+				pref.log(&quot;Getting cache name&quot;);
+				chD.CacheName = SafeXML.cleanback(getName(completeWebPage));
+				pref.log(&quot;Got cache name&quot;);
+				if (pref.debug) pref.log(&quot;Name: &quot; + chD.CacheName);
+
+				pref.log(&quot;Trying owner&quot;);
+				chD.CacheOwner = SafeXML.cleanback(getOwner(completeWebPage)).trim();
+				if(chD.CacheOwner.equals(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; chD.CacheOwner.equals(pref.myAlias2))) chD.is_owned = true;
+				pref.log(&quot;Got owner&quot;);
+				if (pref.debug) pref.log(&quot;Owner: &quot; + chD.CacheOwner +&quot;; is_owned = &quot;+chD.is_owned+&quot;;  alias1,2 = [&quot;+pref.myAlias+&quot;|&quot;+pref.myAlias2+&quot;]&quot;);
+				
+				pref.log(&quot;Trying date hidden&quot;);
+				chD.DateHidden = DateFormat.MDY2YMD(getDateHidden(completeWebPage));
+				pref.log(&quot;Got date hidden&quot;);
+				if (pref.debug) pref.log(&quot;Hidden: &quot; + chD.DateHidden);
+				
+				pref.log(&quot;Trying hints&quot;);
+				chD.Hints = getHints(completeWebPage);
+				pref.log(&quot;Got hints&quot;);
+				if (pref.debug) pref.log(&quot;Hints: &quot; + chD.Hints);
+
+				pref.log(&quot;Trying size&quot;);
+				chD.CacheSize = getSize(completeWebPage);
+				pref.log(&quot;Got size&quot;);
+				if (pref.debug) pref.log(&quot;Size: &quot; + chD.CacheSize);
+				
+				pref.log(&quot;Trying difficulty&quot;);
+				chD.hard = getDiff(completeWebPage);
+				pref.log(&quot;Got difficulty&quot;);
+				if (pref.debug) pref.log(&quot;Hard: &quot; + chD.hard);
+				
+				pref.log(&quot;Trying terrain&quot;);
+				chD.terrain = getTerr(completeWebPage);
+				pref.log(&quot;Got terrain&quot;);
+				if (pref.debug) pref.log(&quot;Terr: &quot; + chD.terrain);
+
+				pref.log(&quot;Trying cache type&quot;);
+				chD.type = getType(completeWebPage);
+				pref.log(&quot;Got cache type&quot;);
+				if (pref.debug) pref.log(&quot;Type: &quot; + chD.type);
+				
+				//==========
+				// Logs
+				//==========
+				pref.log(&quot;Trying logs&quot;);
+				int logsz = chD.CacheLogs.size();
+				chD.CacheLogs = getLogs(completeWebPage, chD);
+				// Count the number of not-found logs
+				int countNoFoundLogs = 0;
+				String loganal = &quot;&quot;;
+				while(countNoFoundLogs &lt; chD.CacheLogs.size() &amp;&amp; countNoFoundLogs &lt; 5){
+					loganal = (String)chD.CacheLogs.get(countNoFoundLogs);
+					if(loganal.indexOf(&quot;icon_sad&quot;)&gt;0) {
+						countNoFoundLogs++;
+					}else break;
+				}
+				chD.noFindLogs = countNoFoundLogs;
+				chD.is_log_update = false;
+				if(isUpdate &amp;&amp; chD.CacheLogs.size()&gt;logsz) chD.is_log_update = true;
+				pref.log(&quot;Found logs&quot;);
+				// If the switch is set to not store found caches and we found the cache =&gt; return
+				if (chD.is_found &amp;&amp; doNotGetFound) return !infB.isClosed; 
+				
+				//==========
+				// Bugs
+				//==========
+				// As there may be several bugs, we check whether the user has aborted
+				if (!infB.isClosed) chD.Bugs = getBugs(completeWebPage);
+				chD.has_bug = chD.Bugs.length()&gt;0;
+				
+				//==========
+				// Images
+				//==========
+				if(fetchImages){
+					pref.log(&quot;Trying images&quot;);
+					getImages(completeWebPage, chD);
+					pref.log(&quot;Got images&quot;);
+				}
+				//==========
+				// Addi waypoints
+				//==========
+				
+				pref.log(&quot;Getting additional waypoints&quot;);
+				getAddWaypoints(completeWebPage, chD.wayPoint, chD.is_found);
+				pref.log(&quot;Got additional waypoints&quot;);
+
+
+			}catch(Exception ex){
+				pref.log(&quot;Error reading cache: &quot;+chD.wayPoint);
+				pref.log(&quot;Exception in getCacheByWaypointName: &quot;,ex);
+			}
+			finally{}
+		}
+		boolean ret=!infB.isClosed; // If the infoBox was closed before getting here, we return false
+		return ret;
+	} // getCacheByWaypointName
+	
+	/**
+	 * Check whether a waypoint is in the database
+	 * @param wpt Name of waypoint to check
+	 * @return index of waypoint in database, -1 if it does not exist
+	 */
 	private int searchWpt(String wpt){
 		Integer INTR = (Integer)indexDB.get(wpt);
 		if(INTR != null){
@@ -514,11 +484,233 @@
 		} else return -1;
 	}
 	
+	/**
+	 * Get the Distance to the centre
+	 * @param doc A previously fetched cachepage
+	 * @return Distance
+	 */
+	private double getDist(String doc){
+		inRex = new Regex(p.getProperty(&quot;distRex&quot;));
+		inRex.search(doc);
+		if(doc.indexOf(&quot;Here&quot;) &gt; 0) return(0);
+		if(pref.digSeparator.equals(&quot;,&quot;)) return Convert.toDouble(inRex.stringMatched(1).replace('.',','));
+		return Convert.toDouble(inRex.stringMatched(1));
+	}
+
+	/**
+	 * Get the waypoint name
+	 * @param doc A previously fetched cachepage
+	 * @return Name of waypoint to add to list 
+	 */
+	private String getWP(String doc){
+		inRex = new Regex(p.getProperty(&quot;waypointRex&quot;));
+		inRex.search(doc);
+		return inRex.stringMatched(1);
+	}
+	
+	/**
+	 * Get the coordinates of the cache
+	 * @param doc A previously fetched cachepage
+	 * @return Cache coordinates
+	 */
+	private String getLatLon(String doc){
+		inRex = new Regex(p.getProperty(&quot;latLonRex&quot;));
+		inRex.search(doc);
+		return inRex.stringMatched(1);
+	}
+	
+	/**
+	 * Get the long description
+	 * @param doc A previously fetched cachepage
+	 * @return the long description
+	 */
+	private String getLongDesc(String doc){
+		String res = &quot;&quot;;
+		inRex = new Regex(p.getProperty(&quot;shortDescRex&quot;));
+		Regex rex2 = new Regex(p.getProperty(&quot;longDescRex&quot;));
+		inRex.search(doc);
+		rex2.search(doc);
+		res = inRex.stringMatched(1) + &quot;&lt;br&gt;&quot;;
+		res += rex2.stringMatched(1); 
+		return SafeXML.cleanback(res);
+	}
+	
+	/**
+	 * Get the cache name
+	 * @param doc A previously fetched cachepage
+	 * @return the name of the cache
+	 */
+	private String getName(String doc){
+		inRex = new Regex(p.getProperty(&quot;cacheNameRex&quot;));
+		inRex.search(doc);
+		return inRex.stringMatched(1);
+	}
+	
+	/**
+	 * Get the cache owner
+	 * @param doc A previously fetched cachepage
+	 * @return the cache owner
+	 */
+	private String getOwner(String doc){
+		inRex = new Regex(p.getProperty(&quot;cacheOwnerRex&quot;));
+		inRex.search(doc);
+		return inRex.stringMatched(1);
+	}
+	
+	/**
+	 * Get the date when the cache was hidden
+	 * @param doc A previously fetched cachepage
+	 * @return Hidden date
+	 */
+	private String getDateHidden(String doc){
+		inRex = new Regex(p.getProperty(&quot;dateHiddenRex&quot;));
+		inRex.search(doc);
+		return inRex.stringMatched(1);
+	}
+	
+	/**
+	 * Get the hints
+	 * @param doc A previously fetched cachepage
+	 * @return Cachehints
+	 */
+	private String getHints(String doc){
+		inRex = new Regex(p.getProperty(&quot;hintsRex&quot;));
+		inRex.search(doc);
+		return inRex.stringMatched(1);
+	}
+	
+	/**
+	 * Get the cache size
+	 * @param doc A previously fetched cachepage
+	 * @return Cache size
+	 */
+	private String getSize(String doc){
+		inRex = new Regex(p.getProperty(&quot;sizeRex&quot;));
+		inRex.search(doc);
+		if(inRex.didMatch()) return inRex.stringMatched(1);
+		else return &quot;None&quot;;
+	}
+	
+	/**
+	 * Get the Difficulty
+	 * @param doc A previously fetched cachepage
+	 * @return The cache difficulty 
+	 */
+	private String getDiff(String doc){
+		inRex = new Regex(p.getProperty(&quot;difficultyRex&quot;));
+		inRex.search(doc);
+		if(inRex.didMatch()) return inRex.stringMatched(1);
+		else return &quot;&quot;;
+	}
+	
+	/**
+	 * Get the terrain rating
+	 * @param doc A previously fetched cachepage
+	 * @return Terrain rating
+	 */
+	private String getTerr(String doc){
+		inRex = new Regex(p.getProperty(&quot;terrainRex&quot;));
+		inRex.search(doc);
+		if(inRex.didMatch()) return inRex.stringMatched(1);
+		else return &quot;&quot;;
+	}
+
+	/**
+	 * Get the waypoint type
+	 * @param doc A previously fetched cachepage
+	 * @return the waypoint type (Tradi, Multi, etc.)
+	 */
+	private String getType(String doc){
+		inRex = new Regex(p.getProperty(&quot;cacheTypeRex&quot;));
+		inRex.search(doc);
+		if(inRex.didMatch()) return inRex.stringMatched(1);
+		else return &quot;&quot;;
+	}
+
+	/**
+	 * Get the logs 
+	 * @param doc A previously fetched cachepage
+	 * @param chD Cache Details
+	 * @return A HTML string containing the logs
+	 */
+	private Vector getLogs(String doc, CacheHolderDetail chD){
+		String icon = &quot;&quot;;
+		String name = &quot;&quot;;
+		Vector reslts = new Vector();
+		Regex blockRex = new Regex(p.getProperty(&quot;blockRex&quot;));
+		blockRex.search(doc);
+		doc = blockRex.stringMatched(1);
+		//Vm.debug(&quot;Log Block: &quot; + doc);
+		/*
+		Vm.debug(&quot;Setting log regex&quot;);
+		inRex = new Regex(&quot;&lt;STRONG&gt;&lt;IMG SRC='<A HREF="http://www.geocaching.com/images/icons/((?s">http://www.geocaching.com/images/icons/((?s</A>).*?)'((?s).*?)&nbsp;((?s).*?)&lt;A NAME=\&quot;((?s).*?)'text-decoration: underline;'&gt;((?s).*?)&lt;A HREF=\&quot;((?s).*?)'text-decoration: underline;'&gt;((?s).*?)&lt;/A&gt;&lt;/strong&gt;((?s).*?)\\[&lt;A href=&quot;);
+		inRex.optimize();
+		inRex.search(doc);
+		Vm.debug(&quot;Log regex run...&quot;);
+		while(inRex.didMatch()){
+			Vm.debug(&quot;Logs:&quot; + inRex.stringMatched(1) + &quot; / &quot; + inRex.stringMatched(3)+ &quot; / &quot; + inRex.stringMatched(7)+ &quot; / &quot; + inRex.stringMatched(8));
+			//&lt;img src='icon_smile.gif'&gt;&nbsp;
+			reslts.add(&quot;&lt;img src='&quot;+ inRex.stringMatched(1) +&quot;'&gt;&nbsp;&quot; + inRex.stringMatched(3)+ inRex.stringMatched(7)+ inRex.stringMatched(8));
+			inRex.searchFrom(doc, inRex.matchedTo());
+		}
+		*/
+		String singleLog = &quot;&quot;;
+		Extractor exSingleLog = new Extractor(doc,p.getProperty(&quot;singleLogExStart&quot;), p.getProperty(&quot;singleLogExEnd&quot;), 0, false); // maybe here is some change neccessary because findnext now gives the whole endstring back??? 
+		singleLog = exSingleLog.findNext();
+		Extractor exIcon = new Extractor(singleLog,p.getProperty(&quot;iconExStart&quot;), p.getProperty(&quot;iconExEnd&quot;), 0, true);
+		Extractor exNameTemp = new Extractor(singleLog,p.getProperty(&quot;nameTempExStart&quot;), p.getProperty(&quot;nameTempExEnd&quot;), 0 , true);
+		String nameTemp = &quot;&quot;;
+		nameTemp = exNameTemp.findNext();
+		Extractor exName = new Extractor(nameTemp, p.getProperty(&quot;nameExStart&quot;), p.getProperty(&quot;nameExEnd&quot;), 0 , true);
+		Extractor exDate = new Extractor(singleLog,p.getProperty(&quot;dateExStart&quot;), p.getProperty(&quot;dateExEnd&quot;), 0 , true);
+		Extractor exLog = new Extractor(singleLog, p.getProperty(&quot;logExStart&quot;), p.getProperty(&quot;logExEnd&quot;), 0, true);
+		//Vm.debug(&quot;Log Block: &quot; + singleLog);
+		int nLogs=0;
+		while(exSingleLog.endOfSearch() == false){
+			nLogs++;
+			if (nLogs&gt;MAXLOGS) {
+				reslts.add(&quot;&lt;br\\&gt;More than &quot;+MAXLOGS+&quot; logs.&lt;br\\&gt;&quot;);
+				break;
+			}
+			//Vm.debug(&quot;--------------------------------------------&quot;);
+			//Vm.debug(&quot;Log Block: &quot; + singleLog);
+			//Vm.debug(&quot;Icon: &quot;+exIcon.findNext());
+			//Vm.debug(exName.findNext());
+			//Vm.debug(exDate.findNext());
+			//Vm.debug(exLog.findNext());
+			//Vm.debug(&quot;--------------------------------------------&quot;);
+			icon = exIcon.findNext();
+			name = exName.findNext();
+			String d=DateFormat.logdate2YMD(exDate.findNext());
+			if((icon.equals(p.getProperty(&quot;icon_smile&quot;)) || icon.equals(p.getProperty(&quot;icon_camera&quot;))) &amp;&amp; 
+				(name.equals(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; name.equals(pref.myAlias2))) )  {
+				chD.is_found = true;
+				chD.CacheStatus = d;
+			}
+			reslts.add(&quot;&lt;img src='&quot;+ icon +&quot;'&gt;&nbsp;&quot; + d + &quot; &quot; + name + exLog.findNext());
+			
+			singleLog = exSingleLog.findNext();
+			exIcon.setSource(singleLog);
+			exNameTemp.setSource(singleLog);
+			nameTemp = exNameTemp.findNext();
+			exName.setSource(nameTemp);
+			exDate.setSource(singleLog);
+			exLog.setSource(singleLog);
+		}
+		return reslts;
+	}
+	
+	/**
+	 * Read the travelbug names from a previously fetched Cache page and then
+	 * read the travelbug purpose for each travelbug
+	 * @param doc The previously fetched cachepage
+	 * @return A HTML formatted string with bug names and there purpose
+	 */
 	public String getBugs(String doc){	
-		Extractor exBlock = new Extractor(doc, &quot;&gt;&nbsp;Inventory&lt;/td&gt;&quot;,&quot;What is a Travel Bug?&quot;,0,Extractor.EXCLUDESTARTEND);
+		Extractor exBlock = new Extractor(doc,p.getProperty(&quot;blockExStart&quot;),p.getProperty(&quot;blockExEnd&quot;) ,0,Extractor.EXCLUDESTARTEND);
 		String bugBlock = exBlock.findNext();
 		//Vm.debug(&quot;Bugblock: &quot;+bugBlock);
-		Extractor exBug = new Extractor(bugBlock, &quot;&lt;a href='&quot;, &quot;&lt;/a&gt;&lt;/strong&gt;&lt;/td&gt;&quot;,0,Extractor.EXCLUDESTARTEND);
+		Extractor exBug = new Extractor(bugBlock,p.getProperty(&quot;bugExStart&quot;),p.getProperty(&quot;bugExEnd&quot;),0,Extractor.EXCLUDESTARTEND);
 		String link,bug,linkPlusBug,bugDetails;
 		String result = &quot;&quot;;
 		String oldInfoBox=infB.getInfo();
@@ -539,7 +731,7 @@
 					pref.log(&quot;Could not fetch bug details&quot;);
 					bugDetails=&quot;&quot;;
 				}
-				Extractor exDetails = new Extractor(bugDetails, &quot;&lt;span id=\&quot;BugDetail_BugGoal\&quot;&gt;&quot;, &quot;&lt;/span&gt;&quot;,0,Extractor.EXCLUDESTARTEND);
+				Extractor exDetails = new Extractor(bugDetails,p.getProperty(&quot;bugDetailsStart&quot;),p.getProperty(&quot;bugDetailsEnd&quot;),0,Extractor.EXCLUDESTARTEND);
 				result+=exDetails.findNext()+&quot;&lt;hr&gt;&quot;;
 			}
 			//Vm.debug(&quot;B: &quot; + bug);
@@ -549,76 +741,27 @@
 		return result;
 	}
 	
-	public void getAddWaypoints(String doc, String wayPoint, boolean is_found){
-		Extractor exWayBlock = new Extractor(doc, &quot;&lt;strong&gt;Additional Waypoints&lt;/strong&gt;&lt;br&gt;&quot;, &quot;&lt;/table&gt;&quot;, 0, false);
-		String wayBlock = &quot;&quot;;
-		String rowBlock = &quot;&quot;;
-		wayBlock = exWayBlock.findNext();
-		Regex nameRex = new Regex(&quot;&amp;RefDS=1\&quot;&gt;(.*)&lt;/a&gt;&quot;);
-		Regex koordRex = new Regex(&quot;align=\&quot;left\&quot;&gt;([NSns] [0-9]{1,2}..[0-9]{1,2}.[0-9]{1,3} [EWew] [0-9]{1,3}..[0-9]{1,2}.[0-9]{1,3})&lt;/td&gt;&quot;);
-		Regex descRex = new Regex(&quot;colspan=\&quot;4\&quot;&gt;(.*)&lt;/td&gt;&quot;);
-		Regex typeRex = new Regex(&quot;&lt;/a&gt; \\((.*)\\)&lt;/td&gt;&quot;);
-		int counter = 0;
-		if(exWayBlock.endOfSearch() == false &amp;&amp; wayBlock.indexOf(&quot;No additional waypoints to display.&quot;)&lt;0){
-			Extractor exRowBlock = new Extractor(wayBlock, &quot;&lt;tr&quot;, &quot;&lt;/tr&gt;&quot;, 0, false);
-			rowBlock = exRowBlock.findNext();
-			rowBlock = exRowBlock.findNext();
-			while(exRowBlock.endOfSearch()==false){
-				CacheHolderDetail cx = new CacheHolderDetail();
-				
-				nameRex.search(rowBlock);
-				koordRex.search(rowBlock);
-				typeRex.search(rowBlock);
-				cx.CacheName = nameRex.stringMatched(1);
-				//Vm.debug(&quot;Addi: &quot; + cx.CacheName);
-				if(koordRex.didMatch()) cx.pos.set(koordRex.stringMatched(1)); 
-				cx.LatLon = cx.pos.toString(); 
-				//cx.pos.set(cx.LatLon);
-				if(typeRex.didMatch()) cx.type = CacheType.typeText2Number(&quot;Waypoint|&quot;+typeRex.stringMatched(1));
-				rowBlock = exRowBlock.findNext();
-				descRex.search(rowBlock);
-				cx.wayPoint = MyLocale.formatLong(counter, &quot;00&quot;) + wayPoint.substring(2);
-				counter++;
-				cx.LongDescription = descRex.stringMatched(1); 
-				//Vm.debug(descRex.stringMatched(1));
-				int idx=profile.getCacheIndex(cx.wayPoint);
-				cx.is_found = is_found;
-				//Vm.debug(&quot;IDX: &quot; + idx);
-				if (idx&lt;0){
-					if(profile.byPassIndexActive) {
-						profile.writeIndexLine(cx);
-						//Vm.debug(&quot;Using index bypass&quot;);
-					}
-					else {
-						cacheDB.add(cx);
-						//Vm.debug(&quot;Adding to cachedb&quot;);
-					}
-				}else if (((CacheHolder) cacheDB.get(idx)).is_Checked &amp;&amp; // Only re-spider existing addi waypoints that are ticked
-						!((CacheHolder) cacheDB.get(idx)).is_filtered) // and are visible (i.e.  not filtered)
-					cacheDB.set(idx,new CacheHolder(
-					    new CacheHolderDetail(((CacheHolder) cacheDB.get(idx))).update(cx)));
-				cx.saveCacheDetails(profile.dataDir);
-				rowBlock = exRowBlock.findNext();
-			}
-		}
-	}
-	
-	public void getImages(String doc, CacheHolderDetail ch){
+	/**
+	 * Get the images for a previously fetched cache page. Images are extracted 
+	 * from two areas: The long description and the pictures section (including
+	 * the spoiler)
+	 * @param doc The previously fetched cachepage
+	 * @param chD The Cachedetails
+	 */
+	public void getImages(String doc, CacheHolderDetail chD){
 		int imgCounter = 0;
 		String imgName;
 		String imgType;
 		String imgUrl;
+		//========
 		//In the long description
+		//========
 		String longDesc = &quot;&quot;;
 		longDesc = getLongDesc(doc);
 		longDesc = STRreplace.replace(longDesc, &quot;img&quot;, &quot;IMG&quot;);
 		longDesc = STRreplace.replace(longDesc, &quot;src&quot;, &quot;SRC&quot;);
 		longDesc = STRreplace.replace(longDesc, &quot;'&quot;, &quot;\&quot;&quot;);
-		//longDesc = STRreplace.replace(longDesc, &quot;SRC =&quot;, &quot;SRC=&quot;);
-		//longDesc = STRreplace.replace(longDesc, &quot;SRC= \&quot;&quot;, &quot;SRC=\&quot;&quot;);
-		//longDesc = STRreplace.replace(longDesc, &quot;\n&quot;, &quot; &quot;);
-		//longDesc = STRreplace.replace(longDesc, &quot; &quot;, &quot;&quot;);
-		Extractor exImgBlock = new Extractor(longDesc, &quot;&lt;IMG&quot;, &quot;&gt;&quot;, 0, false);
+		Extractor exImgBlock = new Extractor(longDesc,p.getProperty(&quot;imgBlockExStart&quot;),p.getProperty(&quot;imgBlockExEnd&quot;), 0, false);
 		//Vm.debug(&quot;In getImages: Have longDesc&quot; + longDesc);
 		String tst;
 		tst = exImgBlock.findNext();
@@ -632,12 +775,12 @@
 				try{
 					imgType = imgUrl.substring(imgUrl.lastIndexOf(&quot;.&quot;)).toLowerCase();
 					if(!imgType.startsWith(&quot;com&quot;) &amp;&amp; !imgType.startsWith(&quot;php&quot;) &amp;&amp; !imgType.startsWith(&quot;exe&quot;)){
-						imgName = ch.wayPoint + &quot;_&quot; + Convert.toString(imgCounter);
+						imgName = chD.wayPoint + &quot;_&quot; + Convert.toString(imgCounter);
 						pref.log(&quot;Loading image: &quot; + imgUrl);
 						spiderImage(imgUrl, imgName+imgType);
 						imgCounter++;
-						ch.Images.add(imgName+imgType);
-						ch.ImagesText.add(imgName);
+						chD.Images.add(imgName+imgType);
+						chD.ImagesText.add(imgName);
 					}
 				} catch (IndexOutOfBoundsException e) { 
 					//Vm.debug(&quot;IndexOutOfBoundsException not in image span&quot;+e.toString()+&quot;imgURL:&quot;+imgUrl);
@@ -646,13 +789,13 @@
 				}
 			exImgSrc.setSource(exImgBlock.findNext());
 		}
-
+		//========
 		//In the image span
-
-		Extractor spanBlock = new Extractor(doc, &quot;&lt;span id=\&quot;Images\&quot;&quot;, &quot;&lt;/span&gt;&quot;, 0 , true);
+		//========
+		Extractor spanBlock = new Extractor(doc,p.getProperty(&quot;imgSpanExStart&quot;),p.getProperty(&quot;imgSpanExEnd&quot;), 0 , true);
 		tst = spanBlock.findNext();
-		Extractor exImgName = new Extractor(tst, &quot;align=absmiddle border=0&gt;&quot;, &quot;&lt;/a&gt;&lt;br/&gt;&quot;, 0 , true);
-		exImgSrc = new Extractor(tst, &quot;&lt;A HREF='<A HREF="http://">http://</A>&quot;, &quot;' rel='lightbox'&quot;, 0, true);
+		Extractor exImgName = new Extractor(tst,p.getProperty(&quot;imgNameExStart&quot;),p.getProperty(&quot;imgNameExEnd&quot;), 0 , true);
+		exImgSrc = new Extractor(tst,p.getProperty(&quot;imgSrcExStart&quot;),p.getProperty(&quot;imgSrcExEnd&quot;), 0, true);
 		while(exImgSrc.endOfSearch() == false){
 			imgUrl = exImgSrc.findNext();
 			//Vm.debug(&quot;Img Url: &quot; +imgUrl);
@@ -661,11 +804,11 @@
 				try{
 					imgType = imgUrl.substring(imgUrl.lastIndexOf(&quot;.&quot;)).toLowerCase();
 					if(!imgType.startsWith(&quot;com&quot;) &amp;&amp; !imgType.startsWith(&quot;php&quot;) &amp;&amp; !imgType.startsWith(&quot;exe&quot;)){
-						imgName = ch.wayPoint + &quot;_&quot; + Convert.toString(imgCounter);
+						imgName = chD.wayPoint + &quot;_&quot; + Convert.toString(imgCounter);
 						spiderImage(imgUrl, imgName+imgType);
 						imgCounter++;
-						ch.Images.add(imgName+imgType);
-						ch.ImagesText.add(exImgName.findNext());
+						chD.Images.add(imgName+imgType);
+						chD.ImagesText.add(exImgName.findNext());
 					}
 				} catch (IndexOutOfBoundsException e) { 
 					pref.log(&quot;IndexOutOfBoundsException in image span. imgURL:&quot;+imgUrl,e); 
@@ -674,7 +817,12 @@
 		}
 	}
 	
-	private void spiderImage(String quelle, String target){
+	/**
+	 * Read an image from the server
+	 * @param imgUrl The Url of the image
+	 * @param target The bytes of the image
+	 */
+	private void spiderImage(String imgUrl, String target){
 		HttpConnection connImg;
 		Socket sockImg;
 		//InputStream is;
@@ -685,13 +833,13 @@
 		String datei = &quot;&quot;;
 		datei = profile.dataDir + target;
 		if(pref.myproxy.length()&gt;0){
-			connImg = new HttpConnection(pref.myproxy, Convert.parseInt(pref.myproxyport), quelle);
+			connImg = new HttpConnection(pref.myproxy, Convert.parseInt(pref.myproxyport), imgUrl);
 		}else{
-			connImg = new HttpConnection(quelle);
+			connImg = new HttpConnection(imgUrl);
 		}
 		connImg.setRequestorProperty(&quot;Connection&quot;, &quot;close&quot;);
 		try{
-			pref.log(&quot;Trying to fetch image from: &quot; + quelle);
+			pref.log(&quot;Trying to fetch image from: &quot; + imgUrl);
 			sockImg = connImg.connect();
 			daten = connImg.readData(connImg.connect());
 			fos = new FileOutputStream(new File(datei));
@@ -700,187 +848,69 @@
 			sockImg.close();
 		} catch (UnknownHostException e) {
 			pref.log(&quot;Host not there...&quot;);
-			//Vm.debug(&quot;Host not there...&quot;);
 		}catch(IOException ioex){
 			pref.log(&quot;File not found!&quot;);
-			//Vm.debug(&quot;File not found!&quot;);
 		} catch (Exception ex){
-			pref.log(&quot;Some other problem while fetching image&quot;);
-			//Vm.debug(&quot;Some kind of problem!&quot;);
+			pref.log(&quot;Some other problem while fetching image&quot;,ex);
 		} finally {
 			//Continue with the spider
 		}
 	}		
-	
-	private String getType(String doc){
-		inRex = new Regex(&quot;&lt;img src=\&quot;../images/WptTypes/(.*?)\\.gif&quot;);
-		inRex.search(doc);
-		if(inRex.didMatch()) return inRex.stringMatched(1);
-		else return &quot;&quot;;
-	}
-	
-	private String getDiff(String doc){
-		inRex = new Regex(&quot;&lt;span id=\&quot;Difficulty\&quot;&gt;.*?alt=\&quot;(.*?) out of&quot;);
-		inRex.search(doc);
-		if(inRex.didMatch()) return inRex.stringMatched(1);
-		else return &quot;&quot;;
-	}
-	
-	private String getTerr(String doc){
-		inRex = new Regex(&quot;&lt;span id=\&quot;Terrain\&quot;&gt;.*?alt=\&quot;(.*?) out of&quot;);
-		inRex.search(doc);
-		if(inRex.didMatch()) return inRex.stringMatched(1);
-		else return &quot;&quot;;
-	}
-	
-	private String getSize(String doc){
-		inRex = new Regex(&quot;This is a &lt;strong&gt;((?s).*?)&lt;/strong&gt; cache&quot;);
-		inRex.search(doc);
-		if(inRex.didMatch()) return inRex.stringMatched(1);
-		else return &quot;None&quot;;
-	}
-	
-	private String getHints(String doc){
-		inRex = new Regex(&quot;&lt;span id=\&quot;Hints\&quot; class=\&quot;displayMe\&quot;&gt;((?s).*?)&lt;/span&gt;&quot;);
-		inRex.search(doc);
-		return inRex.stringMatched(1);
-	}
-	
-	private String getDateHidden(String doc){
-		inRex = new Regex(&quot;&lt;span id=\&quot;DateHidden\&quot;&gt;((?s).*?)&lt;/span&gt;&quot;);
-		inRex.search(doc);
-		return inRex.stringMatched(1);
-	}
-	
-	private String getLatLon(String doc){
-		inRex = new Regex(&quot;&lt;span id=\&quot;LatLon\&quot;&gt;&lt;.*?&gt;((?s).*?)&lt;/STRONG&gt;&quot;);
-		inRex.search(doc);
-		
-		//Vm.debug(&quot;LatLon: &quot; + inRex.stringMatched(1));
-		
-		return inRex.stringMatched(1);
-	}
-	
-	private String getOwner(String doc){
-		inRex = new Regex(&quot;&lt;span id=\&quot;CacheOwner\&quot;.*?by ((?s).*?)\\[&lt;A HREF=&quot;);
-		inRex.search(doc);
-		return inRex.stringMatched(1);
-	}
-	
-	private String getName(String doc){
-		inRex = new Regex(&quot;&lt;span id=\&quot;CacheName\&quot;&gt;((?s).*?)&lt;/span&gt;&quot;);
-		inRex.search(doc);
-		return inRex.stringMatched(1);
-	}
-	
-	private String getLongDesc(String doc){
-		String res = &quot;&quot;;
-		inRex = new Regex(&quot;&lt;span id=\&quot;ShortDescription\&quot;&gt;((?s).*?)&lt;/span&gt;&quot;);
-		Regex rex2 = new Regex(&quot;&lt;span id=\&quot;LongDescription\&quot;&gt;((?s).*?)&lt;strong&gt;Additional Hints&quot;);
-		inRex.search(doc);
-		rex2.search(doc);
-		res = inRex.stringMatched(1) + &quot;&lt;br&gt;&quot;;
-		res += rex2.stringMatched(1); 
-		return SafeXML.cleanback(res);
-	}
-	
-	private String getListBlock(String doc){
-		inRex = new Regex(&quot;&lt;table id=\&quot;dlResults\&quot;((?s).*?)&lt;/table&gt;&quot;);
-		inRex.search(doc);
-		return inRex.stringMatched(1);
-	}
-	
-	private String getWP(String doc){
-		inRex = new Regex(&quot;&lt;/a&gt; \\((.*?)\\)&lt;br&gt;&quot;);
-		inRex.search(doc);
-		return inRex.stringMatched(1);
-	}
-	private double getDist(String doc){
-		inRex = new Regex(&quot;&lt;br /&gt;(.*?)(km|mi)&lt;/td&gt;&quot;);
-		inRex.search(doc);
-		if(doc.indexOf(&quot;Here&quot;) &gt; 0) return(0);
-		if(pref.digSeparator.equals(&quot;,&quot;)) return Convert.toDouble(inRex.stringMatched(1).replace('.',','));
-		return Convert.toDouble(inRex.stringMatched(1));
-	}
-	
-	private Vector getLogs(String doc, CacheHolderDetail ch){
-		String icon = &quot;&quot;;
-		String name = &quot;&quot;;
-		Vector reslts = new Vector();
-		Regex block = new Regex(&quot;&lt;span id=\&quot;CacheLogs\&quot;&gt;((?s).*?)&lt;/span&gt;&quot;);
-		block.search(doc);
-		doc = block.stringMatched(1);
-		//Vm.debug(&quot;Log Block: &quot; + doc);
-		/*
-		Vm.debug(&quot;Setting log regex&quot;);
-		inRex = new Regex(&quot;&lt;STRONG&gt;&lt;IMG SRC='<A HREF="http://www.geocaching.com/images/icons/((?s">http://www.geocaching.com/images/icons/((?s</A>).*?)'((?s).*?)&nbsp;((?s).*?)&lt;A NAME=\&quot;((?s).*?)'text-decoration: underline;'&gt;((?s).*?)&lt;A HREF=\&quot;((?s).*?)'text-decoration: underline;'&gt;((?s).*?)&lt;/A&gt;&lt;/strong&gt;((?s).*?)\\[&lt;A href=&quot;);
-		inRex.optimize();
-		inRex.search(doc);
-		Vm.debug(&quot;Log regex run...&quot;);
-		while(inRex.didMatch()){
-			Vm.debug(&quot;Logs:&quot; + inRex.stringMatched(1) + &quot; / &quot; + inRex.stringMatched(3)+ &quot; / &quot; + inRex.stringMatched(7)+ &quot; / &quot; + inRex.stringMatched(8));
-			//&lt;img src='icon_smile.gif'&gt;&nbsp;
-			reslts.add(&quot;&lt;img src='&quot;+ inRex.stringMatched(1) +&quot;'&gt;&nbsp;&quot; + inRex.stringMatched(3)+ inRex.stringMatched(7)+ inRex.stringMatched(8));
-			inRex.searchFrom(doc, inRex.matchedTo());
-		}
-		*/
-		String singleLog = &quot;&quot;;
-		Extractor exSingleLog = new Extractor(doc, &quot;&lt;STRONG&gt;&quot;, &quot;[&lt;A href=&quot;, 0, false); // maybe here is some change neccessary because findnext now gives the whole endstring back??? 
-		singleLog = exSingleLog.findNext();
-		Extractor exIcon = new Extractor(singleLog, &quot;<A HREF="http://www.geocaching.com/images/icons/">http://www.geocaching.com/images/icons/</A>&quot;, &quot;' align='abs&quot;, 0, true);
-		Extractor exNameTemp = new Extractor(singleLog, &quot;&lt;A HREF=\&quot;&quot;, &quot;/A&gt;&quot;, 0 , true);
-		String nameTemp = &quot;&quot;;
-		nameTemp = exNameTemp.findNext();
-		Extractor exName = new Extractor(nameTemp, &quot;&gt;&quot;, &quot;&lt;&quot;, 0 , true);
-		Extractor exDate = new Extractor(singleLog, &quot;align='absmiddle'&gt;&nbsp;&quot;, &quot; by &lt;&quot;, 0 , true);
-		Extractor exLog = new Extractor(singleLog, &quot;found)&quot;, &quot;&lt;br&gt;[&quot;, 0, true);
-		//Vm.debug(&quot;Log Block: &quot; + singleLog);
-		while(exSingleLog.endOfSearch() == false){
-			//Vm.debug(&quot;--------------------------------------------&quot;);
-			//Vm.debug(&quot;Log Block: &quot; + singleLog);
-			//Vm.debug(&quot;Icon: &quot;+exIcon.findNext());
-			//Vm.debug(exName.findNext());
-			//Vm.debug(exDate.findNext());
-			//Vm.debug(exLog.findNext());
-			//Vm.debug(&quot;--------------------------------------------&quot;);
-			icon = exIcon.findNext();
-			name = exName.findNext();
-			String d=DateFormat.logdate2YMD(exDate.findNext());
-			if((icon.equals(&quot;icon_smile.gif&quot;) || icon.equals(&quot;icon_camera.gif&quot;)) &amp;&amp; 
-				(name.equals(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; name.equals(pref.myAlias2))) )  {
-				ch.is_found = true;
-				ch.CacheStatus = d;
+
+	/**
+	 * Read all additional waypoints from a previously fetched cachepage.
+	 * @param doc The previously fetched cachepage
+	 * @param wayPoint The name of the cache
+	 * @param is_found Found status of the cached (is inherited by the additional waypoints)
+	 */
+	public void getAddWaypoints(String doc, String wayPoint, boolean is_found){
+		Extractor exWayBlock = new Extractor(doc,p.getProperty(&quot;wayBlockExStart&quot;),p.getProperty(&quot;wayBlockExEnd&quot;), 0, false);
+		String wayBlock = &quot;&quot;;
+		String rowBlock = &quot;&quot;;
+		wayBlock = exWayBlock.findNext();
+		Regex nameRex = new Regex(p.getProperty(&quot;nameRex&quot;));
+		Regex koordRex = new Regex(p.getProperty(&quot;koordRex&quot;));
+		Regex descRex = new Regex(p.getProperty(&quot;descRex&quot;));
+		Regex typeRex = new Regex(p.getProperty(&quot;typeRex&quot;));
+		int counter = 0;
+		if(exWayBlock.endOfSearch() == false &amp;&amp; wayBlock.indexOf(&quot;No additional waypoints to display.&quot;)&lt;0){
+			Extractor exRowBlock = new Extractor(wayBlock,p.getProperty(&quot;rowBlockExStart&quot;),p.getProperty(&quot;rowBlockExEnd&quot;), 0, false);
+			rowBlock = exRowBlock.findNext();
+			rowBlock = exRowBlock.findNext();
+			while(exRowBlock.endOfSearch()==false){
+				CacheHolderDetail cx = new CacheHolderDetail();
+				
+				nameRex.search(rowBlock);
+				koordRex.search(rowBlock);
+				typeRex.search(rowBlock);
+				cx.CacheName = nameRex.stringMatched(1);
+				//Vm.debug(&quot;Addi: &quot; + cx.CacheName);
+				if(koordRex.didMatch()) cx.pos.set(koordRex.stringMatched(1)); 
+				cx.LatLon = cx.pos.toString(); 
+				//cx.pos.set(cx.LatLon);
+				if(typeRex.didMatch()) cx.type = CacheType.typeText2Number(&quot;Waypoint|&quot;+typeRex.stringMatched(1));
+				rowBlock = exRowBlock.findNext();
+				descRex.search(rowBlock);
+				cx.wayPoint = MyLocale.formatLong(counter, &quot;00&quot;) + wayPoint.substring(2);
+				counter++;
+				cx.LongDescription = descRex.stringMatched(1); 
+				//Vm.debug(descRex.stringMatched(1));
+				int idx=profile.getCacheIndex(cx.wayPoint);
+				cx.is_found = is_found;
+				//Vm.debug(&quot;IDX: &quot; + idx);
+				if (idx&lt;0){
+					cacheDB.add(new CacheHolder(cx));
+				}else if (((CacheHolder) cacheDB.get(idx)).is_Checked &amp;&amp; // Only re-spider existing addi waypoints that are ticked
+						!((CacheHolder) cacheDB.get(idx)).is_filtered) // and are visible (i.e.  not filtered)
+					cacheDB.set(idx,new CacheHolder(
+					    new CacheHolderDetail(((CacheHolder) cacheDB.get(idx))).update(cx)));
+				cx.saveCacheDetails(profile.dataDir);
+				rowBlock = exRowBlock.findNext();
 			}
-			reslts.add(&quot;&lt;img src='&quot;+ icon +&quot;'&gt;&nbsp;&quot; + d + &quot; &quot; + name + exLog.findNext());
-			
-			singleLog = exSingleLog.findNext();
-			exIcon.setSource(singleLog);
-			exNameTemp.setSource(singleLog);
-			nameTemp = exNameTemp.findNext();
-			exName.setSource(nameTemp);
-			exDate.setSource(singleLog);
-			exLog.setSource(singleLog);
 		}
-		return reslts;
 	}
 	
-	public SpiderGC(Preferences prf, Profile profile, boolean bypass){
-		this.profile=profile;
-		this.cacheDB = profile.cacheDB;
-		pref = prf;
-		indexDB = new Hashtable(cacheDB.size());
-		CacheHolder ch;
-		if(bypass) profile.openIndex(pref);
-		//index the database for faster searching!
-		for(int i = 0; i&lt;cacheDB.size();i++){
-			ch = (CacheHolder)cacheDB.get(i);
-			indexDB.put((String)ch.wayPoint, new Integer(i));
-			ch.is_new = false;
-			//cacheDB.set(i, ch);
-			profile.writeIndexLine(ch);
-		}
-	}
-	
+
 	/**
 	*	Performs an initial fetch to a given address. In this case
 	*	it will be a gc.com address. This method is used to obtain

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2007-05-27 23:43:02 UTC (rev 710)
+++ trunk/src/CacheWolf/myTableControl.java	2007-05-27 23:48:40 UTC (rev 711)
@@ -145,7 +145,6 @@
 				}
 				infB.close(0);
 				profile.hasUnsavedChanges=true;	
-				profile.closeIndex();
 				profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR);
 //				cacheDB.clear();
 //				profile.readIndex();


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000581.html">[Cachewolf-svn] r710 - trunk/src/CacheWolf
</A></li>
	<LI>Next message: <A HREF="000583.html">[Cachewolf-svn] r712 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#582">[ date ]</a>
              <a href="thread.html#582">[ thread ]</a>
              <a href="subject.html#582">[ subject ]</a>
              <a href="author.html#582">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
