From kalli at mail.berlios.de  Fri Aug  3 21:24:34 2007
From: kalli at mail.berlios.de (kalli at mail.berlios.de)
Date: Fri, 3 Aug 2007 21:24:34 +0200
Subject: [Cachewolf-svn] r803 - trunk/src/CacheWolf
Message-ID: <200708031924.l73JOYT8002867@sheep.berlios.de>

Author: kalli
Date: 2007-08-03 21:24:31 +0200 (Fri, 03 Aug 2007)
New Revision: 803

Modified:
   trunk/src/CacheWolf/CacheType.java
Log:
Bugfix bei addi wpts: Richtiger Text fuer Final und Reference 

Modified: trunk/src/CacheWolf/CacheType.java
===================================================================
--- trunk/src/CacheWolf/CacheType.java	2007-07-30 22:00:51 UTC (rev 802)
+++ trunk/src/CacheWolf/CacheType.java	2007-08-03 19:24:31 UTC (rev 803)
@@ -145,9 +145,9 @@
 		if(geoNum.equals("50")) geo = "Parking Area";
 		if(geoNum.equals("51")) geo = "Stages of a Multicache";
 		if(geoNum.equals("52")) geo = "Question to Answer";
-		if(geoNum.equals("53")) geo = "Final Coordinates";
+		if(geoNum.equals("53")) geo = "Final Location";
 		if(geoNum.equals("54")) geo = "Trailhead";
-		if(geoNum.equals("55")) geo = "Reference";
+		if(geoNum.equals("55")) geo = "Reference Point";
 		return geo;
 	}
 	



From pfeffer at mail.berlios.de  Fri Aug 10 20:10:28 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 10 Aug 2007 20:10:28 +0200
Subject: [Cachewolf-svn] r804 - trunk/src/CacheWolf
Message-ID: <200708101810.l7AIASmd012008@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-10 20:09:56 +0200 (Fri, 10 Aug 2007)
New Revision: 804

Modified:
   trunk/src/CacheWolf/Attribute.java
Log:
Bugfix: auf linux muss gross-klein-schreibung beachtet werden. Ausserdem funktioniert der backslash nicht als Verzeichnistrenner

Modified: trunk/src/CacheWolf/Attribute.java
===================================================================
--- trunk/src/CacheWolf/Attribute.java	2007-08-03 19:24:31 UTC (rev 803)
+++ trunk/src/CacheWolf/Attribute.java	2007-08-10 18:09:56 UTC (rev 804)
@@ -110,7 +110,7 @@
  	        "firstaid-yes.gif",     //87 needs maintenance
  	        "firstaid-no.gif"};     //88 does not need maintenance
 	private static mImage [] attributeImages=new mImage[89];
-	private static String IMAGEDIR=File.getProgramDirectory()+"\\Attributes\\";
+	private static String IMAGEDIR=File.getProgramDirectory()+"/attributes/";
 	
 	public static String getImageDir() {
 		return IMAGEDIR; 



From kalli at mail.berlios.de  Sat Aug 11 11:07:00 2007
From: kalli at mail.berlios.de (kalli at mail.berlios.de)
Date: Sat, 11 Aug 2007 11:07:00 +0200
Subject: [Cachewolf-svn] r805 - trunk/src/CacheWolf
Message-ID: <200708110907.l7B970W8024491@sheep.berlios.de>

Author: kalli
Date: 2007-08-11 11:06:57 +0200 (Sat, 11 Aug 2007)
New Revision: 805

Modified:
   trunk/src/CacheWolf/GPXImporter.java
   trunk/src/CacheWolf/ShowCacheInBrowser.java
Log:
Bugfix #28: CacheWolf beleibt beim Laden von Bildern h?\195?\164ngen

Modified: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2007-08-10 18:09:56 UTC (rev 804)
+++ trunk/src/CacheWolf/GPXImporter.java	2007-08-11 09:06:57 UTC (rev 805)
@@ -143,7 +143,7 @@
 			}
 				Vm.showWait(false);
 			}catch(Exception e){
-				//Vm.debug(e.toString());
+				e.printStackTrace();
 				Vm.showWait(false);
 			}
 	}
@@ -319,6 +319,7 @@
 							imgName = (String)holder.ImagesText.get(num);
 							holder.LongDescription = replace(holder.LongDescription, text, "[[Image: " + imgName + "]]");
 							num++;
+							if (num >= holder.ImagesText.getCount())break;
 							text = ex.findNext();
 						}
 					}

Modified: trunk/src/CacheWolf/ShowCacheInBrowser.java
===================================================================
--- trunk/src/CacheWolf/ShowCacheInBrowser.java	2007-08-10 18:09:56 UTC (rev 804)
+++ trunk/src/CacheWolf/ShowCacheInBrowser.java	2007-08-11 09:06:57 UTC (rev 805)
@@ -135,6 +135,7 @@
 								s.append("<img src=\"file://"+
 								   Global.getProfile().dataDir+chD.Images.get(imageNo)+"\">");
 								imageNo++;
+								if (imageNo >= chD.Images.getCount())break;
 							}
 						}
 						start=chD.LongDescription.indexOf(">",pos);



From salzkammergut at mail.berlios.de  Sat Aug 11 13:16:14 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sat, 11 Aug 2007 13:16:14 +0200
Subject: [Cachewolf-svn] r806 - trunk/src/CacheWolf
Message-ID: <200708111116.l7BBGEQn028127@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-11 13:16:12 +0200 (Sat, 11 Aug 2007)
New Revision: 806

Modified:
   trunk/src/CacheWolf/ShowCacheInBrowser.java
   trunk/src/CacheWolf/SpiderGC.java
Log:
SpiderGC: Bugfix (http://www.geoclub.de/ftopic17942.html)
Die imgURL wurde faelschlicherweise nach lowercase konvertiert wodurch das Holen von Bildern von externen Linux Servern nicht funktioniert.
 

Modified: trunk/src/CacheWolf/ShowCacheInBrowser.java
===================================================================
--- trunk/src/CacheWolf/ShowCacheInBrowser.java	2007-08-11 09:06:57 UTC (rev 805)
+++ trunk/src/CacheWolf/ShowCacheInBrowser.java	2007-08-11 11:16:12 UTC (rev 806)
@@ -128,7 +128,7 @@
 						imgRex.searchFrom(chD.LongDescription,pos);
 						String imgUrl=imgRex.stringMatched(1);
 						//Vm.debug("imgUrl "+imgUrl);
-						if (imgUrl.lastIndexOf('.')>0) {
+						if (imgUrl.lastIndexOf('.')>0 && imgUrl.toLowerCase().startsWith("http")) {
 							String imgType = (imgUrl.substring(imgUrl.lastIndexOf(".")).toLowerCase()+"    ").substring(0,4).trim();
 							// If we have an image which we stored when spidering, we can display it
 							if(!imgType.startsWith(".com") && !imgType.startsWith(".php") && !imgType.startsWith(".exe")){

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-11 09:06:57 UTC (rev 805)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-11 11:16:12 UTC (rev 806)
@@ -824,7 +824,7 @@
 		//Vm.debug("Test: \n" + tst);
 		Extractor exImgSrc = new Extractor(tst, "http://", "\"", 0, true);
 		while(exImgBlock.endOfSearch() == false){
-			imgUrl = exImgSrc.findNext().toLowerCase();
+			imgUrl = exImgSrc.findNext();
 			//Vm.debug("Img Url: " +imgUrl);
 			if(imgUrl.length()>0){
 				imgUrl = "http://" + imgUrl;
@@ -836,7 +836,7 @@
 						idxUrl=spideredUrls.find(imgUrl);
 						imgName = chD.wayPoint + "_" + Convert.toString(imgCounter);
 						if (idxUrl<0) { // New image
-							pref.log("Loading image: " + imgUrl);
+							pref.log("Loading image: " + imgUrl+" as "+imgName);
 							spiderImage(imgUrl, imgName+imgType);
 							chD.Images.add(imgName+imgType);
 							spideredUrls.add(imgUrl);
@@ -863,7 +863,7 @@
 		Extractor exImgName = new Extractor(tst,p.getProperty("imgNameExStart"),p.getProperty("imgNameExEnd"), 0 , true);
 		exImgSrc = new Extractor(tst,p.getProperty("imgSrcExStart"),p.getProperty("imgSrcExEnd"), 0, true);
 		while(exImgSrc.endOfSearch() == false){
-			imgUrl = exImgSrc.findNext().toLowerCase();
+			imgUrl = exImgSrc.findNext();
 			//Vm.debug("Img Url: " +imgUrl);
 			if(imgUrl.length()>0){
 				imgUrl = "http://" + imgUrl;
@@ -1175,5 +1175,4 @@
 		return new String(dest,0,d);
 	}
 	
-	
 }
\ No newline at end of file



From salzkammergut at mail.berlios.de  Sat Aug 11 14:22:48 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sat, 11 Aug 2007 14:22:48 +0200
Subject: [Cachewolf-svn] r807 - in trunk: resources src/CacheWolf
Message-ID: <200708111222.l7BCMmik017051@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-11 14:22:43 +0200 (Sat, 11 Aug 2007)
New Revision: 807

Modified:
   trunk/resources/spider.def
   trunk/src/CacheWolf/SpiderGC.java
Log:
SpiderGC: Bugfixes. Infobox schliessen wenn Login nicht erfolgreich.
Spidern von verschluesselten Logs.

Modified: trunk/resources/spider.def
===================================================================
--- trunk/resources/spider.def	2007-08-11 11:16:12 UTC (rev 806)
+++ trunk/resources/spider.def	2007-08-11 12:22:43 UTC (rev 807)
@@ -8,6 +8,7 @@
 # Version 2.4 - 20070616 neu: Attribute
 # Version 2.5 - 20070629 Anpassungen an Listen?nderung bei GC
 # Version 2.6 - 20070701 Bugfix: Wenn Zentrum exakt in Cachekoordinaten liegt wurde der Cache nicht gespidert
+# Version 2.7 - 20070811 Bugfix fuer verschluesselte Logs
 #============================================================
 # A suffix of Rex indicates a regular expression
 # A suffix of ExStart indicates the start of an Extractor search pattern
@@ -70,7 +71,7 @@
 nameExEnd          = <
 dateExStart        = align='absmiddle'>&nbsp;
 dateExEnd          = \ by\ <
-logExStart         = found)
+logExStart         = found)<br>
 logExEnd           = <br>[
 # Die Icons, die einen erfolgreichen Fund signalisieren
 icon_smile         = icon_smile.gif

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-11 11:16:12 UTC (rev 806)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-11 12:22:43 UTC (rev 807)
@@ -121,7 +121,8 @@
 				start = fetch_post(loginPage, doc, p.getProperty("nextPage"));  // /login/default.aspx
 				if(start.indexOf("You are logged in as") > 0) pref.log("Login successful");
 				else {
-					pref.log("Login failed.");
+					pref.log("Login failed. Wrong Account or Password?");
+					infB.close(0);
 					return ERR_LOGIN;
 				}
 			}catch(Exception ex){
@@ -742,7 +743,7 @@
 				chD.is_found = true;
 				chD.CacheStatus = d;
 			}
-			reslts.add("<img src='"+ icon +"'>&nbsp;" + d + " " + name + exLog.findNext());
+			reslts.add("<img src='"+ icon +"'>&nbsp;" + d + " " + name +"<br>"+ exLog.findNext());
 			
 			singleLog = exSingleLog.findNext();
 			exIcon.setSource(singleLog);
@@ -814,8 +815,8 @@
 		String longDesc = "";
 		if (chD.wayPoint.startsWith("TC")) longDesc = doc;
 		else longDesc = getLongDesc(doc);
-		longDesc = STRreplace.replace(longDesc, "img", "IMG");
-		longDesc = STRreplace.replace(longDesc, "src", "SRC");
+		longDesc = STRreplace.replace(longDesc, "<img", "<IMG");
+		longDesc = STRreplace.replace(longDesc, "src=", "SRC=");
 		longDesc = STRreplace.replace(longDesc, "'", "\"");
 		Extractor exImgBlock = new Extractor(longDesc,p.getProperty("imgBlockExStart"),p.getProperty("imgBlockExEnd"), 0, false);
 		//Vm.debug("In getImages: Have longDesc" + longDesc);
@@ -1174,5 +1175,6 @@
 		}
 		return new String(dest,0,d);
 	}
-	
+
+
 }
\ No newline at end of file



From pfeffer at mail.berlios.de  Tue Aug 14 02:14:03 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 02:14:03 +0200
Subject: [Cachewolf-svn] r808 - trunk/src/CacheWolf
Message-ID: <200708140014.l7E0E3SC001567@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 02:13:58 +0200 (Tue, 14 Aug 2007)
New Revision: 808

Modified:
   trunk/src/CacheWolf/DataMover.java
   trunk/src/CacheWolf/Map.java
   trunk/src/CacheWolf/MapsList.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/ProfilesForm.java
Log:
File.list has on some systems (linux, but also Windows Mobile 2003) a bug in ewe 1.49: 
when filenames contain more than one ".", then the mask matches on hese systems the first in spite of the last "." File.listmultiple doesn't have this bug. see http://www.geoclub.de/ftopic15291-0-asc-0.html

Modified: trunk/src/CacheWolf/DataMover.java
===================================================================
--- trunk/src/CacheWolf/DataMover.java	2007-08-11 12:22:43 UTC (rev 807)
+++ trunk/src/CacheWolf/DataMover.java	2007-08-14 00:13:58 UTC (rev 808)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import utils.FileBugfix;
 import ewe.filechooser.FileChooser;
 import ewe.io.*;
 import ewe.ui.*;
@@ -142,7 +143,7 @@
 
 	public void deleteCacheFiles(String wpt, String dir){
 		// delete files in dstDir to clean up trash
-		String tmp[] = new File(dir).list(wpt + "*.*", ewe.io.FileBase.LIST_FILES_ONLY);
+		String tmp[] = new FileBugfix(dir).list(wpt + "*.*", ewe.io.FileBase.LIST_FILES_ONLY);
 		for (int i=0; i < tmp.length;i++){
 			File tmpFile = new File(dir + tmp[i]);
 			tmpFile.delete();
@@ -150,7 +151,7 @@
 	}
 
 	public void moveCacheFiles(String wpt, String srcDir, String dstDir){
-		String srcFiles[] = new File(srcDir).list(wpt + "*.*", ewe.io.FileBase.LIST_FILES_ONLY);
+		String srcFiles[] = new FileBugfix(srcDir).list(wpt + "*.*", ewe.io.FileBase.LIST_FILES_ONLY);
 		for (int i=0; i < srcFiles.length;i++){
 			File srcFile = new File(srcDir + srcFiles[i]);
 			File dstFile = new File(dstDir + srcFiles[i]);
@@ -159,7 +160,7 @@
 	}
 
 	public void copyCacheFiles(String wpt, String srcDir, String dstDir){
-		String srcFiles[] = new File(srcDir).list(wpt + "*.*", ewe.io.FileBase.LIST_FILES_ONLY);
+		String srcFiles[] = new FileBugfix(srcDir).list(wpt + "*.*", ewe.io.FileBase.LIST_FILES_ONLY);
 		for (int i=0; i < srcFiles.length;i++){
 			copy(srcDir + srcFiles[i],dstDir + srcFiles[i]);
 		}

Modified: trunk/src/CacheWolf/Map.java
===================================================================
--- trunk/src/CacheWolf/Map.java	2007-08-11 12:22:43 UTC (rev 807)
+++ trunk/src/CacheWolf/Map.java	2007-08-14 00:13:58 UTC (rev 808)
@@ -210,8 +210,6 @@
 		//at the same time try to find associated .map files!
 		//These are georeference files targeted for OziExplorer.
 		//So lets check if we have more than 1 png file:
-		Vector files;
-		String [] filestemp;
 		String line = new String();
 		InputStream in = null;
 		OutputStream out = null;
@@ -219,21 +217,14 @@
 		byte[] buf;
 		int len;
 		String[] parts;
-		filestemp = inDir.list("*.png", File.LIST_FILES_ONLY); // TODO listmultiple verwenden
-		files = new Vector(filestemp);
-		filestemp = inDir.list("*.jpg", File.LIST_FILES_ONLY);
-		files.addAll(filestemp);
-		filestemp = inDir.list("*.gif", File.LIST_FILES_ONLY);
-		files.addAll(filestemp);
-		filestemp = inDir.list("*.bmp", File.LIST_FILES_ONLY);
-		files.addAll(filestemp);
+		String [] files = inDir.listMultiple("*.png,*.jpg,*.gif,*.bmp", File.LIST_FILES_ONLY);
 
 		String currfile = null;
 		String curInFullPath;
 		String curOutFullPath;
-		int num = files.size();
+		int num = files.length;
 		for(int i =  num -1 ; i >= 0;i--){
-			currfile = (String) files.get(i);
+			currfile = (String) files[i];
 			inf.setInfo(MyLocale.getMsg(4110,"Loading: ")+ "\n" + currfile + "\n("+(num-i)+"/"+num+")");
 			//Copy the file
 			//Vm.debug("Copy: " + inDir.getFullPath() + "/" +files[i]);

Modified: trunk/src/CacheWolf/MapsList.java
===================================================================
--- trunk/src/CacheWolf/MapsList.java	2007-08-11 12:22:43 UTC (rev 807)
+++ trunk/src/CacheWolf/MapsList.java	2007-08-14 00:13:58 UTC (rev 808)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import utils.FileBugfix;
 import ewe.io.File;
 import ewe.io.IOException;
 import ewe.sys.Double;
@@ -26,9 +27,9 @@
 		super(); // forget already loaded maps
 		//if (mmp.mapImage != null) 
 		String dateien[];
-		File files = new File(mapsPath);
+		File files = new FileBugfix(mapsPath);
 		String rawFileName = new String();
-		String[] dirstmp = files.list("*.wfl", File.LIST_ALWAYS_INCLUDE_DIRECTORIES | File.LIST_DIRECTORIES_ONLY);
+		String[] dirstmp = files.list(null, File.LIST_DIRECTORIES_ONLY);
 		Vector dirs;
 		if (dirstmp != null) dirs = new Vector(dirstmp);
 		else dirs = new Vector();
@@ -36,10 +37,11 @@
 		MapInfoObject tempMIO;
 		MessageBox f = null;
 		for (int j = dirs.size()-1; j >= 0; j--) {
-			files = new File(mapsPath+"/"+dirs.get(j));
+			files = new FileBugfix(mapsPath+"/"+dirs.get(j));
 			//ewe.sys.Vm.debug("mapd-Dirs:"+files);
-			dateien = files.list("*.wfl", File.LIST_FILES_ONLY);
+			dateien = files.listMultiple("*.wfl,892z3rihugkdfhgflhldghoeighoig8", File.LIST_FILES_ONLY); //"*.xyz" doesn't work on some systems and "*" doesn't on others -> use null (for all files) and filter yourself
 			for(int i = 0; i < dateien.length;i++){
+				// if (!dateien[i].endsWith(".wfl")) continue;
 				rawFileName = dateien[i].substring(0, dateien[i].lastIndexOf("."));
 				try {
 					tempMIO = new MapInfoObject();

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-08-11 12:22:43 UTC (rev 807)
+++ trunk/src/CacheWolf/Preferences.java	2007-08-14 00:13:58 UTC (rev 808)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import utils.FileBugfix;
 import ewe.io.*;
 import ewe.sys.*;
 import ewe.ui.*;
@@ -147,7 +148,7 @@
 	public String getMapLoadPath() {
 		// here could also a list of map-types displayed...
 		// standard dir
-		File t = new File(getMapManuallySavePath(false));
+		File t = new FileBugfix(getMapManuallySavePath(false));
 		String[] f = t.list("*.wfl", File.LIST_ALWAYS_INCLUDE_DIRECTORIES | File.LIST_FILES_ONLY);
 		if (f != null && f.length > 0) return  baseDir + mapsPath;
 		f = t.list("*.wfl", File.LIST_DIRECTORIES_ONLY | File.LIST_ALWAYS_INCLUDE_DIRECTORIES);

Modified: trunk/src/CacheWolf/ProfilesForm.java
===================================================================
--- trunk/src/CacheWolf/ProfilesForm.java	2007-08-11 12:22:43 UTC (rev 807)
+++ trunk/src/CacheWolf/ProfilesForm.java	2007-08-14 00:13:58 UTC (rev 808)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import utils.FileBugfix;
 import ewe.ui.*;
 import ewe.io.*;
 import ewesoft.xml.*;
@@ -71,7 +72,7 @@
 		
 		choice=new MyList();
 		// Get all subdirectories in the base directory
-		File fileBaseDir=new File(baseDir);
+		File fileBaseDir=new FileBugfix(baseDir);
 		String[] existingProfiles=fileBaseDir.list("*",FileBase.LIST_DIRECTORIES_ONLY);
         // Now add these subdirectories to the list of profiles but
         // exclude the "maps" directory which will contain the moving maps



From pfeffer at mail.berlios.de  Tue Aug 14 02:16:30 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 02:16:30 +0200
Subject: [Cachewolf-svn] r809 - trunk/src/utils
Message-ID: <200708140016.l7E0GUKL002192@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 02:16:25 +0200 (Tue, 14 Aug 2007)
New Revision: 809

Added:
   trunk/src/utils/FileBugfix.java
Log:
Class for bugfixing File.list (forgotten in last committ)

Added: trunk/src/utils/FileBugfix.java
===================================================================
--- trunk/src/utils/FileBugfix.java	2007-08-14 00:13:58 UTC (rev 808)
+++ trunk/src/utils/FileBugfix.java	2007-08-14 00:16:25 UTC (rev 809)
@@ -0,0 +1,29 @@
+/**
+ * 
+ */
+package utils;
+
+import ewe.io.*;
+
+/**
+ * @author pfeffer
+ * class to fix a bug in ewe.io.File, which occurs only on some systems (e.g. linux): the mask "*.xyz" doesn't work
+ * so I get all the files wich null in spite of the mask and filter afterwords 
+ */
+public class FileBugfix extends File{
+	public FileBugfix(String path) 
+		{super(path);}
+	
+	public String[] list(final String mask,final int listAndSortOptions)
+	{
+		return super.listMultiple(mask+",*xyzq3246wwee345rrtzih6ljbkoih", listAndSortOptions); // with only one "*" listmultiple calls list
+		/*
+		 * super.list has on some systems (linux, but also Windows Mobile 2003) a bug 
+		 * in ewe 1.49: 
+		 * when filenames contain more than one ".", 
+		 * then the mask matches on these systems the first in spite of the last "."
+		 * listmultiple doesn't have this bug 
+		 */
+	}
+
+}



From pfeffer at mail.berlios.de  Tue Aug 14 02:18:31 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 02:18:31 +0200
Subject: [Cachewolf-svn] r810 - trunk/src/utils
Message-ID: <200708140018.l7E0IViH002677@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 02:18:28 +0200 (Tue, 14 Aug 2007)
New Revision: 810

Modified:
   trunk/src/utils/CWWrapper.java
Log:
fix in CWWrapper (I couldn't compile it)

Modified: trunk/src/utils/CWWrapper.java
===================================================================
--- trunk/src/utils/CWWrapper.java	2007-08-14 00:16:25 UTC (rev 809)
+++ trunk/src/utils/CWWrapper.java	2007-08-14 00:18:28 UTC (rev 810)
@@ -11,7 +11,7 @@
  */
 public class CWWrapper {
 	
-	public static exec(String str) throws IOException{
+	public static void exec(String str) throws ewe.io.IOException{
 		String plattform = Vm.getPlatform();
 		if(plattform.equals("WinCE")){
 			Vm.exec(str, "", 0, true);



From pfeffer at mail.berlios.de  Tue Aug 14 02:30:33 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 02:30:33 +0200
Subject: [Cachewolf-svn] r811 - trunk/src/utils
Message-ID: <200708140030.l7E0UXCR003569@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 02:30:31 +0200 (Tue, 14 Aug 2007)
New Revision: 811

Modified:
   trunk/src/utils/FileBugfix.java
Log:
fix of last fix

Modified: trunk/src/utils/FileBugfix.java
===================================================================
--- trunk/src/utils/FileBugfix.java	2007-08-14 00:18:28 UTC (rev 810)
+++ trunk/src/utils/FileBugfix.java	2007-08-14 00:30:31 UTC (rev 811)
@@ -16,7 +16,7 @@
 	
 	public String[] list(final String mask,final int listAndSortOptions)
 	{
-		return super.listMultiple(mask+",*xyzq3246wwee345rrtzih6ljbkoih", listAndSortOptions); // with only one "*" listmultiple calls list
+		return super.listMultiple(mask+",*.xyzq3246wwee345rrtzih6ljbkoih", listAndSortOptions); // with only one "*" listmultiple calls list
 		/*
 		 * super.list has on some systems (linux, but also Windows Mobile 2003) a bug 
 		 * in ewe 1.49: 



From pfeffer at mail.berlios.de  Tue Aug 14 02:39:31 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 02:39:31 +0200
Subject: [Cachewolf-svn] r812 - trunk/src/utils
Message-ID: <200708140039.l7E0dVIt004293@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 02:39:28 +0200 (Tue, 14 Aug 2007)
New Revision: 812

Modified:
   trunk/src/utils/FileBugfix.java
Log:
so, now I hope the fix finally works...

Modified: trunk/src/utils/FileBugfix.java
===================================================================
--- trunk/src/utils/FileBugfix.java	2007-08-14 00:30:31 UTC (rev 811)
+++ trunk/src/utils/FileBugfix.java	2007-08-14 00:39:28 UTC (rev 812)
@@ -16,7 +16,9 @@
 	
 	public String[] list(final String mask,final int listAndSortOptions)
 	{
-		return super.listMultiple(mask+",*.xyzq3246wwee345rrtzih6ljbkoih", listAndSortOptions); // with only one "*" listmultiple calls list
+		if ((listAndSortOptions & FileBase.LIST_FILES_ONLY) > 0)
+		  return super.listMultiple(mask+",*.xyzq3246wwee345rrtzih6ljbkoih", listAndSortOptions); // with only one "*" listmultiple calls list
+		else return super.list(mask, listAndSortOptions);
 		/*
 		 * super.list has on some systems (linux, but also Windows Mobile 2003) a bug 
 		 * in ewe 1.49: 



From pfeffer at mail.berlios.de  Tue Aug 14 03:13:33 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 03:13:33 +0200
Subject: [Cachewolf-svn] r813 - trunk/src/utils
Message-ID: <200708140113.l7E1DXqm005819@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 03:13:30 +0200 (Tue, 14 Aug 2007)
New Revision: 813

Modified:
   trunk/src/utils/FileBugfix.java
Log:
es gab noch einen Fehler in meinem letzten Fix :-(

Modified: trunk/src/utils/FileBugfix.java
===================================================================
--- trunk/src/utils/FileBugfix.java	2007-08-14 00:39:28 UTC (rev 812)
+++ trunk/src/utils/FileBugfix.java	2007-08-14 01:13:30 UTC (rev 813)
@@ -16,9 +16,9 @@
 	
 	public String[] list(final String mask,final int listAndSortOptions)
 	{
-		if ((listAndSortOptions & FileBase.LIST_FILES_ONLY) > 0)
-		  return super.listMultiple(mask+",*.xyzq3246wwee345rrtzih6ljbkoih", listAndSortOptions); // with only one "*" listmultiple calls list
-		else return super.list(mask, listAndSortOptions);
+		if ( ((listAndSortOptions & FileBase.LIST_FILES_ONLY) == 0) || mask == null || mask == "*.*" ) // in case of dirs listmuliple calls list even if there are more than one "*" in the mask -> avoid endless recursion //TODO test if lis works on all systems when there are more than one dot in the dirname 
+			return super.list(mask, listAndSortOptions); 
+		return super.listMultiple(mask+",*.xyzq3246wwee345rrtzih6ljbkoih", listAndSortOptions); // with only one "*" listmultiple calls list
 		/*
 		 * super.list has on some systems (linux, but also Windows Mobile 2003) a bug 
 		 * in ewe 1.49: 



From pfeffer at mail.berlios.de  Tue Aug 14 03:19:34 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 03:19:34 +0200
Subject: [Cachewolf-svn] r814 - trunk/src/CacheWolf
Message-ID: <200708140119.l7E1JYAX006187@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 03:19:33 +0200 (Tue, 14 Aug 2007)
New Revision: 814

Modified:
   trunk/src/CacheWolf/DetailsPanel.java
   trunk/src/CacheWolf/Profile.java
Log:
addi-Wpts can be manually created also for Caches from Opencaching

Modified: trunk/src/CacheWolf/DetailsPanel.java
===================================================================
--- trunk/src/CacheWolf/DetailsPanel.java	2007-08-14 01:13:30 UTC (rev 813)
+++ trunk/src/CacheWolf/DetailsPanel.java	2007-08-14 01:19:33 UTC (rev 814)
@@ -467,13 +467,15 @@
 				  int idx;
 				  if (ch.wayPoint.length()<5)
 					  idx=-1;
-				  else
+				  else {
 					  idx=profile.getCacheIndex("GC"+ ch.wayPoint.substring(ch.wayPoint.length() == 5?1:2));
-				  if (idx<0) (new MessageBox(MyLocale.getMsg(144,"Warning"),
-						  MyLocale.getMsg(734,"No main cache found for addi waypoint ")+" "+ch.wayPoint+
-						  "\n"+MyLocale.getMsg(735,"Addi Waypoints must have the format xxYYYY, where xx are any 2 chars and YYYY are the main cache's chars after the GC"),FormBase.OKB)).execute();
+					  if (idx<0) idx=profile.getCacheIndex("OC"+ ch.wayPoint.substring(ch.wayPoint.length() == 5?1:2));
+					  if (idx<0) (new MessageBox(MyLocale.getMsg(144,"Warning"),
+							  MyLocale.getMsg(734,"No main cache found for addi waypoint ")+" "+ch.wayPoint+
+							  "\n"+MyLocale.getMsg(735,"Addi Waypoints must have the format xxYYYY, where xx are any 2 chars and YYYY are the main cache's chars after the GC"),FormBase.OKB)).execute();
+				  }
+				  profile.buildReferences();
 			  }
-			  profile.buildReferences();
 		  }
 		  // set status also on addi wpts
 		  ch.setAttributesToAddiWpts();

Modified: trunk/src/CacheWolf/Profile.java
===================================================================
--- trunk/src/CacheWolf/Profile.java	2007-08-14 01:13:30 UTC (rev 813)
+++ trunk/src/CacheWolf/Profile.java	2007-08-14 01:19:33 UTC (rev 814)
@@ -426,7 +426,7 @@
 			ch = (CacheHolder)cacheDB.get(i);
 			ch.addiWpts.clear();
 			ch.mainCache = null;
-			if (ch.wayPoint.startsWith("GC")) // Only put potential master caches into the index
+			// if (ch.wayPoint.startsWith("GC")) // Only put potential master caches into the index
 				dbIndex.put((String)ch.wayPoint, new Integer(i));
 		}
 		// Build references
@@ -441,6 +441,14 @@
 				else {
 					index = (Integer) dbIndex.get("GC"+ ch.wayPoint.substring(2));
 				}
+				if (index == null) { // TODO save the source (GC or OC or Custom) of the maincache somewhere else to avoid ambiguity of addi-wpt-names
+					if (ch.wayPoint.length() == 5){
+						index = (Integer) dbIndex.get("OC"+ ch.wayPoint.substring(1));
+					} 
+					else {
+						index = (Integer) dbIndex.get("OC"+ ch.wayPoint.substring(2));
+					}
+				}
 				if (index != null) {
 					mainCh = (CacheHolder) cacheDB.get(index.intValue());
 					mainCh.addiWpts.add(ch);



From pfeffer at mail.berlios.de  Tue Aug 14 03:57:19 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 03:57:19 +0200
Subject: [Cachewolf-svn] r815 - trunk/src/CacheWolf
Message-ID: <200708140157.l7E1vJ95008728@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 03:57:17 +0200 (Tue, 14 Aug 2007)
New Revision: 815

Modified:
   trunk/src/CacheWolf/MainForm.java
   trunk/src/CacheWolf/Preferences.java
Log:
* use von screens smaller than 400 px in height 16 px font as default (when no pref.xml exists)
* new TODO comments (I cannot test myself, because my PDA is in repair)

Modified: trunk/src/CacheWolf/MainForm.java
===================================================================
--- trunk/src/CacheWolf/MainForm.java	2007-08-14 01:19:33 UTC (rev 814)
+++ trunk/src/CacheWolf/MainForm.java	2007-08-14 01:57:17 UTC (rev 815)
@@ -52,10 +52,10 @@
 		this.resizable = true;
 		this.moveable = true;
 		if(Vm.isMobile() == true) {
-			this.windowFlagsToSet = Window.FLAG_FULL_SCREEN;
+			this.windowFlagsToSet = Window.FLAG_FULL_SCREEN; // TODO use FLAG_MAXIMIZE_ON_PDA ?
 			this.resizable = false;
 			this.moveable = false;
-			this.windowFlagsToClear=WindowConstants.FLAG_HAS_TITLE;
+			this.windowFlagsToClear=WindowConstants.FLAG_HAS_TITLE; //TODO don't clear this to use original windows haedline ?
 		} else 
 			this.setPreferredSize(800, 600);
 		this.resizeOnSIP = true;

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-08-14 01:19:33 UTC (rev 814)
+++ trunk/src/CacheWolf/Preferences.java	2007-08-14 01:57:17 UTC (rev 815)
@@ -115,6 +115,8 @@
 		mySPO.parity = SerialPort.NOPARITY;
 		mySPO.stopBits = 1;
 		mySPO.baudRate = 4800;
+		if ( ((ewe.fx.Rect) (Window.getGuiInfo(Window.INFO_SCREEN_RECT,null,new ewe.fx.Rect(),0))).height > 400) fontSize = 16;
+		else fontSize = 12;
 		// Ensure that logfile does not grow infinitely. Not really needed as every spider resets it
 		File logFile = new File(LOGFILENAME);
 		if (logFile.length()>60000) logInit();



From mik77 at mail.berlios.de  Tue Aug 14 08:58:35 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Tue, 14 Aug 2007 08:58:35 +0200
Subject: [Cachewolf-svn] r816 - trunk/resources
Message-ID: <200708140658.l7E6wZZb007577@sheep.berlios.de>

Author: mik77
Date: 2007-08-14 08:58:17 +0200 (Tue, 14 Aug 2007)
New Revision: 816

Modified:
   trunk/resources/spider.def
Log:
Spider findet jetzt auch Addi Wpts in eigenen Caches

Modified: trunk/resources/spider.def
===================================================================
--- trunk/resources/spider.def	2007-08-14 01:57:17 UTC (rev 815)
+++ trunk/resources/spider.def	2007-08-14 06:58:17 UTC (rev 816)
@@ -9,6 +9,7 @@
 # Version 2.5 - 20070629 Anpassungen an Listen?nderung bei GC
 # Version 2.6 - 20070701 Bugfix: Wenn Zentrum exakt in Cachekoordinaten liegt wurde der Cache nicht gespidert
 # Version 2.7 - 20070811 Bugfix fuer verschluesselte Logs
+# Version 2.8 - 20070814 Findet jetzt auch Addi Wpts in eigenen Caches
 #============================================================
 # A suffix of Rex indicates a regular expression
 # A suffix of ExStart indicates the start of an Extractor search pattern
@@ -106,7 +107,7 @@
 #--------------------------------------
 #Section2d: Additional waypoints
 #--------------------------------------
-wayBlockExStart    = <strong>Additional\ Waypoints</strong><br>
+wayBlockExStart    = <strong>Additional\ Waypoints</strong>
 wayBlockExEnd      = </table>
 nameRex            = &RefDS=1">(.*)</a>
 koordRex           = align="left">([NSns]\ [0-9]{1,2}..[0-9]{1,2}.[0-9]{1,3}\ [EWew]\ [0-9]{1,3}..[0-9]{1,2}.[0-9]{1,3})</td>



From pfeffer at mail.berlios.de  Tue Aug 14 13:20:59 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 13:20:59 +0200
Subject: [Cachewolf-svn] r817 - trunk
Message-ID: <200708141120.l7EBKxNY024862@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 13:20:56 +0200 (Tue, 14 Aug 2007)
New Revision: 817

Modified:
   trunk/compile.bat
   trunk/compile.sh
Log:
added utils to compile.bat and .sh 

Modified: trunk/compile.bat
===================================================================
--- trunk/compile.bat	2007-08-14 06:58:17 UTC (rev 816)
+++ trunk/compile.bat	2007-08-14 11:20:56 UTC (rev 817)
@@ -1,3 +1,3 @@
 if not exist bin\CacheWolf mkdir bin\CacheWolf
 if not exist bin\exp mkdir bin\exp
-javac -cp ./lib/CompileEwe.zip;./lib/ewesoft.zip;./lib/EwesoftRegex.zip;./lib/HTML.zip;./lib/openmap.jar  -d ./bin/ -deprecation ./src/CacheWolf/*.java ./src/exp/*.java 
\ No newline at end of file
+javac -cp ./lib/CompileEwe.zip;./lib/ewesoft.zip;./lib/EwesoftRegex.zip;./lib/HTML.zip;./lib/openmap.jar  -d ./bin/ -deprecation ./src/CacheWolf/*.java ./src/exp/*.java ./src/utils/*.java
\ No newline at end of file

Modified: trunk/compile.sh
===================================================================
--- trunk/compile.sh	2007-08-14 06:58:17 UTC (rev 816)
+++ trunk/compile.sh	2007-08-14 11:20:56 UTC (rev 817)
@@ -1,2 +1,2 @@
 #!/bin/bash
-javac -cp ./lib/CompileEwe.zip:./lib/ewesoft.zip:./lib/EwesoftRegex.zip:./lib/HTML.zip:./lib/openmap.jar  -d ./bin/ -deprecation -nowarn  ./src/CacheWolf/*.java ./src/exp/*.java
+javac -cp ./lib/CompileEwe.zip:./lib/ewesoft.zip:./lib/EwesoftRegex.zip:./lib/HTML.zip:./lib/openmap.jar  -d ./bin/ -deprecation -nowarn  ./src/CacheWolf/*.java ./src/exp/*.java ./src/utils/*.java



From mik77 at mail.berlios.de  Tue Aug 14 13:48:59 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Tue, 14 Aug 2007 13:48:59 +0200
Subject: [Cachewolf-svn] r818 - trunk
Message-ID: <200708141148.l7EBmxIr017881@sheep.berlios.de>

Author: mik77
Date: 2007-08-14 13:48:55 +0200 (Tue, 14 Aug 2007)
New Revision: 818

Modified:
   trunk/cwberlios.jnf
Log:
added utils to jnf

Modified: trunk/cwberlios.jnf
===================================================================
--- trunk/cwberlios.jnf	2007-08-14 11:20:56 UTC (rev 817)
+++ trunk/cwberlios.jnf	2007-08-14 11:48:55 UTC (rev 818)
@@ -1 +1 @@
-command=programName%3DCacheWolf%26width%3D0%26height%3D0%26startingClass%3DCacheWolf.CacheWolf%26windowTitle%3DWindow%2BTitle%26ewes%3D%26extra%3D%26pathToEwe%3D%26nativeStack%3D0%26vmStack%3D0%26appletWidth%3D0%26appletHeight%3D0%26appletInFrame%3Dfalse%26locale%3D%26useResources%3Dtrue%26noPopupWindows%3Dfalse%26vmOptions%3D/Xmx%2B12M&eweFiles=&targets=%253DTarget%3Dewe/data/MultiListSelect$SelectedItems%253D%25253DJar%25252B-%25252BJava%25252B1.2%252526%25253DPocketPC%25252B2003%252526%25253DPocketPC%25252B-%25252BARM/XScale%252526%25253DPocketPC%25252B-%25252BMIPS%252526%25253DPocketPC%25252B-%25252BSH3%252526%25253Dx86%25252B-%25252BWin32%25252B-%25252BStatic%25252BLinked&createWithPnf=true&eweInfo=outputFile%3D./work/CacheWolf.ewe%26entries%3Dewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./bin/CacheWolf/%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253DCacheWolf/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./bin/exp%252526ma!
 sk%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dexp/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./resources%252526mask%25253D*.gif;*.png;*.ico;*.tp;*.zip;*.html%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./resources/%252526mask%25253Dcachewolf.Languages.cfg%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D_config/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./lib%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253D%26addCommandLine%3Dtrue%26commandLine%3DprogramName%253DCacheWolf%2526width%253D0%2526height%253D0%2526startingClass%253DCacheWolf.CacheWolf%2526windowTitle%253DWindow%252BTitle%2526ewes%253D%2526extra%253D%2526pathToEwe%253D%2526nativeStack%253D0%2526vmStack%253D0%2526appletWidth%253D0%2526appletHeight%253D0%2526appletInFrame%253Dfalse%2526locale%253D%2526useResources%253Dtrue%2526noPopupWindows%253Dfals!
 e%2526vmOptions%253D/Xmx%252B12M%26install%3Dtitle%253D%2526ca!
 tegory%2
53DApplications%2526location%253D%2526icon%253D%2526args%253D%2526vmArgs%253D%26addInstallFile%3Dfalse%26usePool%3Dtrue%26useClassPool%3Dfalse&icon=(Default)
+command=programName%3DCacheWolf%26width%3D0%26height%3D0%26startingClass%3DCacheWolf.CacheWolf%26windowTitle%3DWindow%2BTitle%26ewes%3D%26extra%3D%26pathToEwe%3D%26nativeStack%3D0%26vmStack%3D0%26appletWidth%3D0%26appletHeight%3D0%26appletInFrame%3Dfalse%26locale%3D%26useResources%3Dtrue%26noPopupWindows%3Dfalse%26vmOptions%3D/Xmx%2B12M&eweFiles=&targets=%253DTarget%3Dewe/data/MultiListSelect$SelectedItems%253D%25253DJar%25252B-%25252BJava%25252B1.2%252526%25253DPocketPC%25252B2003%252526%25253DPocketPC%25252B-%25252BARM/XScale%252526%25253DPocketPC%25252B-%25252BMIPS%252526%25253DPocketPC%25252B-%25252BSH3%252526%25253Dx86%25252B-%25252BWin32%25252B-%25252BStatic%25252BLinked&createWithPnf=true&eweInfo=outputFile%3D./work/CacheWolf.ewe%26entries%3Dewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./bin/CacheWolf/%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253DCacheWolf/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./bin/exp%252526ma!
 sk%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dexp/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./resources%252526mask%25253D*.gif;*.png;*.ico;*.tp;*.zip;*.html%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./resources/%252526mask%25253Dcachewolf.Languages.cfg%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253D_config/%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./lib%252526mask%25253D*.class%252526includeSubdirectories%25253Dtrue%252526pathInEwe%25253D%2526ewesoft/apps/jewel/EweDirEntry%253Dpath%25253D./bin/utils%252526mask%25253D*.class%252526includeSubdirectories%25253Dfalse%252526pathInEwe%25253Dutils/%26addCommandLine%3Dtrue%26commandLine%3DprogramName%253DCacheWolf%2526width%253D0%2526height%253D0%2526startingClass%253DCacheWolf.CacheWolf%2526windowTitle%253DWindow%252BTitle%2526ewes%253D%2526extra%253D%2526pathToEwe%253D%2526nativeStack%253D0%2526!
 vmStack%253D0%2526appletWidth%253D0%2526appletHeight%253D0%252!
 6appletI
nFrame%253Dfalse%2526locale%253D%2526useResources%253Dtrue%2526noPopupWindows%253Dfalse%2526vmOptions%253D/Xmx%252B12M%26install%3Dtitle%253D%2526category%253DApplications%2526location%253D%2526icon%253D%2526args%253D%2526vmArgs%253D%26addInstallFile%3Dfalse%26usePool%3Dtrue%26useClassPool%3Dfalse&icon=(Default)



From pfeffer at mail.berlios.de  Tue Aug 14 19:50:36 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 14 Aug 2007 19:50:36 +0200
Subject: [Cachewolf-svn] r819 - trunk/src/utils
Message-ID: <200708141750.l7EHoa6E030943@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-14 19:50:30 +0200 (Tue, 14 Aug 2007)
New Revision: 819

Modified:
   trunk/src/utils/FileBugfix.java
Log:
fixed: on some systems a stack overflow occured in my fix from last night

Modified: trunk/src/utils/FileBugfix.java
===================================================================
--- trunk/src/utils/FileBugfix.java	2007-08-14 11:48:55 UTC (rev 818)
+++ trunk/src/utils/FileBugfix.java	2007-08-14 17:50:30 UTC (rev 819)
@@ -4,6 +4,8 @@
 package utils;
 
 import ewe.io.*;
+import ewe.util.FileComparer;
+import ewe.util.mString;
 
 /**
  * @author pfeffer
@@ -12,13 +14,11 @@
  */
 public class FileBugfix extends File{
 	public FileBugfix(String path) 
-		{super(path);}
-	
+	{super(path);}
+
 	public String[] list(final String mask,final int listAndSortOptions)
 	{
-		if ( ((listAndSortOptions & FileBase.LIST_FILES_ONLY) == 0) || mask == null || mask == "*.*" ) // in case of dirs listmuliple calls list even if there are more than one "*" in the mask -> avoid endless recursion //TODO test if lis works on all systems when there are more than one dot in the dirname 
-			return super.list(mask, listAndSortOptions); 
-		return super.listMultiple(mask+",*.xyzq3246wwee345rrtzih6ljbkoih", listAndSortOptions); // with only one "*" listmultiple calls list
+		return listBugFixed(mask, listAndSortOptions);
 		/*
 		 * super.list has on some systems (linux, but also Windows Mobile 2003) a bug 
 		 * in ewe 1.49: 
@@ -27,5 +27,43 @@
 		 * listmultiple doesn't have this bug 
 		 */
 	}
+	public String[] listBugFixed(final String compositeMask,final int listAndSortOptions) {
+		String mask = (compositeMask == null) ? "*.*" : compositeMask; 
+		String[] found; //the following code is mainly copoed from FileBase.listmultiple to avoid recursion it is not called
+		char c = mask.indexOf(',') == -1 ? ';' : ',';
+		String masks [] = mString.split(mask,c);
+		String dirs [] = new String[0];
+		if ((listAndSortOptions & LIST_FILES_ONLY) == 0)
+			dirs = super.list(null,LIST_DIRECTORIES_ONLY);
+		if ((listAndSortOptions & LIST_DIRECTORIES_ONLY) == 0)
+			found = super.list(null,File.LIST_FILES_ONLY|listAndSortOptions);
+		else
+			found = dirs;
 
+		ewe.util.FileComparer [] fcs = new ewe.util.FileComparer[masks.length];
+
+		for (int i = 0; i<masks.length; i++)
+			fcs[i] = new FileComparer((File)this,ewe.sys.Vm.getLocale(),listAndSortOptions,masks[i]);
+		int left = found.length;
+		for (int i = 0; i<found.length; i++){
+			boolean matched = false;
+			for (int f = 0; f<fcs.length; f++){
+				if (fcs[f].matches(found[i])){
+					matched = true;
+					break;
+				}
+			}
+			if (!matched) {
+				found[i] = null;
+				left--;
+			}
+		}
+		String [] isMatching = new String[dirs.length+left];
+		ewe.sys.Vm.copyArray(dirs,0,isMatching,0,dirs.length);
+		for (int i = 0, d = dirs.length; i<found.length; i++)
+			if (found[i] != null)
+				isMatching[d++] = found[i];
+		found = isMatching;
+		return found;
+	}
 }



From bilbowolf at mail.berlios.de  Wed Aug 15 12:22:22 2007
From: bilbowolf at mail.berlios.de (bilbowolf at mail.berlios.de)
Date: Wed, 15 Aug 2007 12:22:22 +0200
Subject: [Cachewolf-svn] r820 - trunk/src/CacheWolf
Message-ID: <200708151022.l7FAMMQ7023819@sheep.berlios.de>

Author: bilbowolf
Date: 2007-08-15 12:22:19 +0200 (Wed, 15 Aug 2007)
New Revision: 820

Modified:
   trunk/src/CacheWolf/CacheWolf.java
   trunk/src/CacheWolf/Global.java
   trunk/src/CacheWolf/MainForm.java
   trunk/src/CacheWolf/Version.java
Log:
MainForm auf extends Editor umgestellt. Form war definitiv falsch!
Ich hatte ein massives Problem mit dem SIP Knopf
und war daher gezwungen mich intensiver mit der Dokumentation
auseinanderzusetzen. SIP verhalten ist aber wahrscheinlich noch
nicht optimal, insbesonders auf WM5.
CW verdeckt auf die oberste Leiste nicht mehr. Ein umschalten
zwischen Anwendungen auf dem PDA ist somit einfach.

Modified: trunk/src/CacheWolf/CacheWolf.java
===================================================================
--- trunk/src/CacheWolf/CacheWolf.java	2007-08-14 17:50:30 UTC (rev 819)
+++ trunk/src/CacheWolf/CacheWolf.java	2007-08-15 10:22:19 UTC (rev 820)
@@ -217,8 +217,9 @@
 
 import ewe.sys.*;
 
-public class CacheWolf{
-
+public class CacheWolf extends Editor{
+	
+	
 	public static void main(String args[])
 	{
 		//start with parameters:
@@ -237,24 +238,23 @@
 			mApp.mainApp.font = newGuiFont;
 		}
 */		
-		//if (Gui.screenIs(Gui.PDA_SCREEN) && Vm.isMobile()) {
-		//	Vm.setSIP(Vm.SIP_LEAVE_BUTTON);
-		//}
+		if (Gui.screenIs(Gui.PDA_SCREEN) && Vm.isMobile()) {
+			Vm.setSIP(Vm.SIP_LEAVE_BUTTON);
+		}
+		
 		if(args.length > 0){
 			if(args[0].equals("test")){
 				Test t=new Test(); 
 				t.testAll();
 			}
 		}
-		Form mainF = new MainForm();
+		Editor mainF = new MainForm();
 		Device.preventIdleState(true);
 		mainF.execute();
 		Device.preventIdleState(false);
-		
-		//Form mainF = new MainForm();
-		//mainF.execute();
 		ewe.sys.Vm.exit(0);
 	}
+	
 }
 
 // for javadoc see: http://java.sun.com/j2se/javadoc/writingdoccomments/index.html#exampleresult

Modified: trunk/src/CacheWolf/Global.java
===================================================================
--- trunk/src/CacheWolf/Global.java	2007-08-14 17:50:30 UTC (rev 819)
+++ trunk/src/CacheWolf/Global.java	2007-08-15 10:22:19 UTC (rev 820)
@@ -1,4 +1,5 @@
 package CacheWolf;
+import ewe.*;
 
 /**
  * Global data: Preferences and Profile

Modified: trunk/src/CacheWolf/MainForm.java
===================================================================
--- trunk/src/CacheWolf/MainForm.java	2007-08-14 17:50:30 UTC (rev 819)
+++ trunk/src/CacheWolf/MainForm.java	2007-08-15 10:22:19 UTC (rev 820)
@@ -8,7 +8,7 @@
 *	Mainform is responsible for building the user interface.
 *	Class ID = 5000
 */
-public class MainForm extends Form {
+public class MainForm extends Editor {
 	// The next three declares are for the cachelist
 	boolean cacheListVisible=false;
     CacheList cacheList;
@@ -46,13 +46,15 @@
 	}
 	
 	public void doIt(){
+		CellPanel [] p = addToolbar();
 		Global.mainForm=this;
 		//this.title = "CacheWolf " + Version.getRelease();
 		this.exitSystemOnClose = true;
 		this.resizable = true;
 		this.moveable = true;
 		if(Vm.isMobile() == true) {
-			this.windowFlagsToSet = Window.FLAG_FULL_SCREEN; // TODO use FLAG_MAXIMIZE_ON_PDA ?
+
+			//this.windowFlagsToSet = Window.FLAG_FULL_SCREEN;
 			this.resizable = false;
 			this.moveable = false;
 			this.windowFlagsToClear=WindowConstants.FLAG_HAS_TITLE; //TODO don't clear this to use original windows haedline ?
@@ -62,7 +64,7 @@
 		// Load CacheList
 		InfoBox infB = new InfoBox("CacheWolf",MyLocale.getMsg(5000,"Loading Cache-List"));
 		infB.exec();
-		infB.waitUntilPainted(1000);
+		infB.waitUntilPainted(100);
 		try{
 			pref.readPrefFile();
 			addGuiFont();
@@ -78,6 +80,7 @@
 			if(pref.debug == true) Vm.debug("MainForm:: Exception:: " + e.toString());
 		}
 		
+		
 		if(pref.fixSIP == true){
 			if (Gui.screenIs(Gui.PDA_SCREEN) && Vm.isMobile()) {
 				//Vm.setSIP(Vm.SIP_LEAVE_BUTTON|Vm.SIP_ON);
@@ -85,8 +88,8 @@
 				Device.preventIdleState(true);
 			}
 		} else Vm.setSIP(0);
-		//Vm.setParameter(Vm.SET_ALWAYS_SHOW_SIP_BUTTON,1);
-		if (pref.showStatus) statBar = new StatusBar(pref, profile.cacheDB);
+		
+        if (pref.showStatus) statBar = new StatusBar(pref, profile.cacheDB);
 		mMenu = new MainMenu(this);
 		mTab = new MainTab(mMenu,statBar);
 		split=new SplittablePanel(PanelSplitter.HORIZONTAL);
@@ -96,7 +99,12 @@
 		split.setSplitter(PanelSplitter.MIN_SIZE|PanelSplitter.BEFORE,PanelSplitter.HIDDEN|PanelSplitter.BEFORE,PanelSplitter.CLOSED);
 		pnlCacheList.addLast(cacheList=new CacheList(),STRETCH,FILL);
 		pnlMainTab.addLast(mTab,STRETCH,FILL);
+		
 		mTab.dontAutoScroll=true;
+		p[0].addLast(mMenu);
+		//p[0].addLast(mMenu,CellConstants.DONTSTRETCH, CellConstants.FILL);
+		p[1].addLast(split,STRETCH,FILL);
+		/*
 		if (pref.menuAtTop) {
 			this.addLast(mMenu,CellConstants.DONTSTRETCH, CellConstants.FILL);
 			this.addLast(split,STRETCH,FILL);
@@ -104,6 +112,7 @@
 			this.addLast(split,STRETCH,FILL);
 			this.addLast(mMenu,CellConstants.DONTSTRETCH, CellConstants.FILL);
 		}
+		*/
 		mMenu.setTablePanel(mTab.getTablePanel());
 		infB.close(0);
 		mTab.tbP.selectFirstRow();

Modified: trunk/src/CacheWolf/Version.java
===================================================================
--- trunk/src/CacheWolf/Version.java	2007-08-14 17:50:30 UTC (rev 819)
+++ trunk/src/CacheWolf/Version.java	2007-08-15 10:22:19 UTC (rev 820)
@@ -10,7 +10,7 @@
 	static final String VER_MAJOR = "BE";
 	static final String VER_MINOR = "";
 	static final String VER_BUILD = " ";
-	static final String VER_SVN ="$LastChangedRevision$"; // the  number is automatically replaced by subversion to the latest versionnumer of this file (svn:keywords LastChangedRevision)
+	static final String VER_SVN ="$LastChangedRevision$"; // the number is automatically replaced by subversion to the latest versionnumer of this file (svn:keywords LastChangedRevision)
 	
 	/**
 	 * @return



From pfeffer at mail.berlios.de  Fri Aug 17 00:42:00 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 17 Aug 2007 00:42:00 +0200
Subject: [Cachewolf-svn] r821 - trunk/src/CacheWolf
Message-ID: <200708162242.l7GMg0jk003658@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-17 00:41:50 +0200 (Fri, 17 Aug 2007)
New Revision: 821

Modified:
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/Navigate.java
   trunk/src/CacheWolf/TablePanel.java
   trunk/src/CacheWolf/myTableControl.java
Log:
suchen mit ctrl-f
Handling des cursors in der Liste wie in ewe vorgesehen (bitte testen)
Vorbereitung f?\195?\188r Mond- und Sternenrichtungsanzeige

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2007-08-15 10:22:19 UTC (rev 820)
+++ trunk/src/CacheWolf/CacheHolder.java	2007-08-16 22:41:50 UTC (rev 821)
@@ -1,14 +1,5 @@
 package CacheWolf;
-import ewe.sys.Vm;
-import ewe.ui.InputBox;
-import ewe.util.*;
-import ewe.filechooser.FileChooser;
-import ewe.io.BufferedWriter;
-import ewe.io.File;
-import ewe.io.FileReader;
-import ewe.io.FileWriter;
-import ewe.io.IOException;
-import ewe.io.PrintWriter;
+import ewe.util.Vector;
 
 /**
 *	A class to hold information on a cache.<br>

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2007-08-15 10:22:19 UTC (rev 820)
+++ trunk/src/CacheWolf/MainMenu.java	2007-08-16 22:41:50 UTC (rev 821)
@@ -108,7 +108,7 @@
 		// Create the "Search" pulldown menu
 		///////////////////////////////////////////////////////////////////////
 		MenuItem[] searchMenuItems=new MenuItem[2];
-		searchMenuItems[0] = search = new MenuItem(MyLocale.getMsg(112,"Search")); 
+		searchMenuItems[0] = search = new MenuItem(MyLocale.getMsg(112,"Search$"+(char)6)); // char 6 = ctrl +f 
 		searchMenuItems[1] = searchClr = new MenuItem(MyLocale.getMsg(113,"Clear search"));
 		
 		///////////////////////////////////////////////////////////////////////
@@ -184,7 +184,15 @@
 			mnuOpenProfile.modifiers|=MenuItem.Disabled;
 		}
 	}
-	
+
+	public static void search() {
+		String srch = new InputBox(MyLocale.getMsg(119,"Search for:")).input("",10);
+		if (srch != null) {
+			SearchCache ssc = new SearchCache(Global.getProfile().cacheDB);
+			ssc.search(srch);
+			Global.mainTab.tbP.refreshTable();
+		}
+	}
 	public void onEvent(Event ev){
 		Preferences pref=Global.getPref();
 		Profile profile=Global.getProfile();
@@ -425,12 +433,7 @@
 			// "Search" pulldown menu
 			///////////////////////////////////////////////////////////////////////
 			if(mev.selectedItem == search){
-				String srch = new InputBox(MyLocale.getMsg(119,"Search for:")).input("",10);
-				if (srch != null) {
-					SearchCache ssc = new SearchCache(cacheDB);
-					ssc.search(srch);
-					tbp.refreshTable();
-				}
+				search();
 			}
 			if(mev.selectedItem == searchClr){
 				SearchCache ssc = new SearchCache(cacheDB);

Modified: trunk/src/CacheWolf/Navigate.java
===================================================================
--- trunk/src/CacheWolf/Navigate.java	2007-08-15 10:22:19 UTC (rev 820)
+++ trunk/src/CacheWolf/Navigate.java	2007-08-16 22:41:50 UTC (rev 821)
@@ -69,7 +69,7 @@
 	public void stopDisplayTimer(){
 		if (tickerThread != null) tickerThread.stop();
 	}
-	
+
 	public void stopGps() {
 		serThread.stop();
 		stopDisplayTimer();
@@ -78,7 +78,7 @@
 		if (gotoPanel != null) gotoPanel.gpsStoped();
 		if (movingMap != null) movingMap.gpsStoped();
 	}
-	
+
 	public boolean isGpsPosValid() {
 		return 	serThread != null && serThread.isAlive() && gpsPos.isValid() ; // && gpsPos.getfiex();
 
@@ -128,6 +128,7 @@
 	 * @param lon in degrees in WGS84
 	 * @return Azimut of the sun in degrees from north
 	 * @throws NumberFormatException when utc / datum could not be interpreted
+	 * this is prgrammed acording to the algorithmus described in http://de.wikipedia.org/wiki/Sonnenstand
 	 */
 	public static float getSunAzimut (String utc, String datum, double lat, double lon) {
 		//	(new MessageBox("test", "utc:"+utc+" datum: "+datum+", lat: "+lat+", len: "+lon, MessageBox.OKB)).exec();
@@ -158,7 +159,7 @@
 			if (alphaNenner<0) {alpha +=180;}
 			// Azimut
 			double t0 = (jd0 - 2451545.)/36525.; // schon in t0 bzw jd0 richtig berechnet?
-			double thetaHG = 6.697376 + 2400.05134 * t0 + 1.002738 * ((double)stunde + (double)minute/60.);
+			double thetaHG = 6.697376 + 2400.05134 * t0 + 1.002738 * ((double)stunde + (double)minute/60. + (double)sekunde/3600.);
 			double theta = thetaHG * 15. + lon;
 			double azimutNenner = java.lang.Math.cos((theta-alpha)/180*java.lang.Math.PI)*java.lang.Math.sin(lat/180*java.lang.Math.PI)-
 			java.lang.Math.tan(delta/180*java.lang.Math.PI)*java.lang.Math.cos(lat/180*java.lang.Math.PI);
@@ -169,6 +170,13 @@
 			// null = Sueden auf Null = Norden umrechnen
 			azimut +=180.;
 			if (azimut >360.) azimut -=360.;
+		/*	ewe.sys.Vm.debug("sunAzimut1: " + azimut);
+			ewe.sys.Vm.debug("sun Elevation: " +getSunAzimut2 (utc, datum, lat, lon).latDec);
+			CWPoint MoonDir = getMoonAzimut(jd, new CWPoint(lat, lon));
+			ewe.sys.Vm.debug("Moon Elevation: " + MoonDir.latDec + "Moon Azimut: " + MoonDir.lonDec);
+			CWPoint OrionDir = getOrionAzimut(jd, new CWPoint(lat, lon));
+			ewe.sys.Vm.debug("Alnilam (Orion) Elevation: " + OrionDir.latDec + "Alnilam (Orion) Azimut: " + OrionDir.lonDec );
+			*/
 			return azimut;
 		} catch (IndexOutOfBoundsException e) {
 			// wird von substring geworfen wenn datum / utc nicht genug Ziffern haben
@@ -177,101 +185,289 @@
 			throw new NumberFormatException();
 		}
 	}
-}
-/**
- * Thread for reading data from COM-port
- *
- */
-class SerialThread extends mThread{
-	SerialPort comSp;   
-	byte[] comBuff = new byte[1024*10]; // when some action takes a long time (eg. loading or zooming a map), a lot of data can be in the buffer, read that at once
-	int comLength = 0;
-	CWGPSPoint myGPS;
-	boolean run, tcpForward;
-	Socket tcpConn;
-	String lastError = new String();
 
-	public SerialThread(SerialPortOptions spo, CWGPSPoint GPSPoint, String forwardIP) throws IOException {
-		try{
-			comSp = new SerialPort(spo);
-		} catch (IOException e) {
-			throw new IOException(spo.portName);
-		} // catch (UnsatisfiedLinkError e) {} // TODO in original java-vm 
-		if (forwardIP.length()>0) { 
+	public static CWPoint getSunAzimut2 (String utc, String datum, double lat, double lon) {
+		double jd = utc2juliandate(utc, datum);
+		CWPoint eclCoos = getSunEclipticCoos(jd);
+		// calculate ecliptic coos
+		// convert coos
+		return ecliptic2AzimutCoos(new CWPoint(lat, lon), jd, eclCoos);
+	}
+	
+	public static CWPoint getMoonAzimut(double jd, CWPoint onEarth) {
+		CWPoint eclCoo = getMoonEclipticCoos(jd);
+		return ecliptic2AzimutCoos(onEarth, jd, eclCoo);
+	}
+	
+	public static CWPoint getOrionAzimut(double jd, CWPoint onEarth) {
+		// Koordinaten Alnilam (mittlerer G?rtelstern des Orion), Rektaszension 5h36m13s; Deklination -1?12'7 TODO ?quinoktium 2000
+		// Source: wikipedia
+		return equatorial2AzimutCoos(onEarth, jd, new CWPoint(-1. -12./60. -7./3600., (5. + 36./60. + 13./3600.)*15.) ); // (-1. -12./60. -7./3600., (5. + 36./60. + 13./3600.)*15.) <- wikipedia // -1.19748, 5.60978 * 15.) <- www.... // (-1. -11./60. -52./3600., (5. + 36./60. + 35./3600.)*15.)  <- Stellarium
+	}
+	
+	/**
+	 * get the ecliptic coordinates of the sun
+	 * @param juliandate
+	 * @return
+	 */
+	public static CWPoint getSunEclipticCoos(double juliandate) {
+		double n = juliandate - 2451545.0;
+		double l = 280.46 + 0.9856474 * n;
+		double g = 357.528 + 0.9856003 * n;
+		double lambda = l + 1.915*java.lang.Math.sin(g/180*java.lang.Math.PI) + 0.02 * java.lang.Math.sin(2*g/180*java.lang.Math.PI);
+		return new CWPoint(0, lambda);
+	}
+	
+	
+	// the following code is adopted from http://lexikon.astronomie.info/java/sunmoon/sunmoon.html
+	// ignores the time difference between juliandate and TDT, which is something like 1 minute
+	public static CWPoint getMoonEclipticCoos(double julianDate) {
+		final double DEG = Math.PI / 180;  
+		final double RAD = 1/DEG;
+		double sunAnomalyMean = 360*DEG/365.242191*(julianDate - 2447891.5) + 279.403303*DEG - 282.768422*DEG;
+		double D = julianDate-2447891.5;
+
+		// Mean Moon orbit elements as of 1990.0
+		double l0 = 318.351648*DEG;
+		double P0 =  36.340410*DEG;
+		double N0 = 318.510107*DEG;
+		double i  = 5.145396*DEG;
+
+		double l = 13.1763966*DEG*D+l0;
+		double MMoon = l-0.1114041*DEG*D-P0; // Moon's mean anomaly M
+		double N = N0-0.0529539*DEG*D;       // Moon's mean ascending node longitude
+		
+		double sunlon = getSunEclipticCoos(julianDate).lonDec; 
+		double C = l-sunlon;
+		double Ev = 1.2739*DEG*Math.sin(2*C-MMoon);
+		double Ae = 0.1858*DEG*Math.sin(sunAnomalyMean);
+		double A3 = 0.37*DEG*Math.sin(sunAnomalyMean);
+
+		double MMoon2 = MMoon+Ev-Ae-A3;  // corrected Moon anomaly
+		double Ec = 6.2886*DEG*Math.sin(MMoon2);  // equation of centre
+		double A4 = 0.214*DEG*Math.sin(2*MMoon2);
+		double l2 = l+Ev+Ec-Ae+A4; // corrected Moon's longitude
+		double V = 0.6583*DEG*Math.sin(2*(l2-sunlon));
+
+		double l3 = l2+V; // true orbital longitude;
+		double N2 = N-0.16*DEG*Math.sin(sunAnomalyMean);
+
+		CWPoint moonCoor = new CWPoint();  
+		moonCoor.lonDec = (( N2 + Math.atan2( Math.sin(l3-N2)*Math.cos(i), Math.cos(l3-N2) ) ) * RAD)% 360;
+		moonCoor.latDec = Math.asin( Math.sin(l3-N2)*Math.sin(i) ) * RAD;
+		//moonCoor.orbitLon = l3;
+		return moonCoor;
+		
+		/*
+		double e  = 0.054900;
+		double a  = 384401; // km
+		double diameter0 = 0.5181*DEG; // angular diameter of Moon at a distance
+		double parallax0 = 0.9507*DEG; // parallax at distance a
+
+		  // relative distance to semi mayor axis of lunar oribt
+		  moonCoor.distance = (1-sqr(e)) / (1+e*Math.cos(MMoon2+Ec) );
+		  moonCoor.diameter = diameter0/moonCoor.distance; // angular diameter in radians
+		  moonCoor.parallax = parallax0/moonCoor.distance; // horizontal parallax in radians
+		  moonCoor.distance *= a;	// distance in km
+
+		  // Age of Moon in radians since New Moon (0) - Full Moon (pi)
+		  moonCoor.moonAge = Mod2Pi(l3-sunCoor.lon);   
+		  moonCoor.phase   = 0.5*(1-Math.cos(moonCoor.moonAge)); // Moon phase, 0-1
+
+		  var phases = new Array("Neumond", "Zunehmende Sichel", "Erstes Viertel", "Zunnehmender Mond", 
+		  	"Vollmond", "Abnehmender Mond", "Letztes Viertel", "Abnehmende Sichel", "Neumond");
+		  var mainPhase = 1./29.53*360*DEG; // show 'Newmoon, 'Quarter' for +/-1 day arond the actual event
+		  var p = Mod(moonCoor.moonAge, 90.*DEG);
+		  if (p < mainPhase || p > 90*DEG-mainPhase) p = 2*Math.round(moonCoor.moonAge / (90.*DEG));
+		  else p = 2*Math.floor(moonCoor.moonAge / (90.*DEG))+1;
+		  moonCoor.moonPhase = phases[p];
+
+		  moonCoor.sign = Sign(moonCoor.lon);
+		  return (float) moonCoor.lonDec;
+		return 0;
+	}
+		 */
+	}
+
+		public static CWPoint ecliptic2AzimutCoos(CWPoint onEarth, double julianDate, CWPoint ecliptic) {
+			CWPoint equat = ecliptic2Equatorial(ecliptic, julianDate);
+			return equatorial2AzimutCoos(onEarth, julianDate, equat);
+		}
+		/**
+		 * convert rektaszension alpha and deklination delta to azimut
+		 * @param onEarth pos. on earth for which the azimut is wanted
+		 * @param julianDate
+		 * @param equatorial: lonDec = rektaszension (alpha), latDec = Deklination (delta)
+		 * @return lonDec: azimut in degrees from north, lat: elevation in degrees from horizont
+		 * alogithism from wikipedia sonnenbahn
+		 */
+		public static CWPoint equatorial2AzimutCoos(CWPoint onEarth, double julianDate, CWPoint equatorial) {
+			double stunde = ((julianDate + 0.5) % 1) * 24;
+			double jd0 = julianDate - stunde /24; // julian date at UTC 0:00
+			double t0 = (jd0 - 2451545.)/36525.; // schon in t0 bzw jd0 richtig berechnet?
+			double thetaHG = 6.697376 + 2400.05134 * t0 + 1.002738 * stunde; // + (double)minute/60.);
+			double theta = thetaHG * 15. + onEarth.lonDec;
+			double tau = (theta - equatorial.lonDec ) /180*Math.PI;
+			double phi = onEarth.latDec/180*Math.PI;
+			double azimutNenner = Math.cos(tau)*Math.sin(phi)-
+				Math.tan(equatorial.latDec/180*Math.PI)*Math.cos(onEarth.latDec/180*java.lang.Math.PI);
+			float azimut = (float) java.lang.Math.atan(java.lang.Math.sin((theta-equatorial.lonDec)/180*Math.PI)/
+					azimutNenner);
+			azimut = (float) (azimut * 180f / java.lang.Math.PI);
+			if (azimutNenner<0) azimut +=180.;
+			// null = Sueden auf Null = Norden umrechnen
+			azimut +=180.;
+			if (azimut >360.) azimut -=360.;
+			double h = 180 / Math.PI * Math.asin(Math.cos(equatorial.latDec/180*Math.PI) * Math.cos(tau)*Math.cos(phi) + Math.sin(equatorial.latDec/180 *Math.PI) * Math.sin(phi));
+			return new CWPoint(h, azimut);
+		}
+
+		/**
+		 * convert from eliptical to equatorial coordinates
+		 * @param juliandate
+		 * @param eklipCoo ecliptic coos in degrees  
+		 * @return lon: Deklination (delta), lat: Rektaszension (alpha) in degree
+		 * this is adopted from http://lexikon.astronomie.info/java/sunmoon/sunmoon.html 
+		 */
+		public static CWPoint ecliptic2Equatorial(CWPoint eklipCoo, double juliandate) {
+			double T = (juliandate - 2451545.0)/36525.; // Epoch 2000 January 1.5
+			double eps = (23.+(26+21.45/60)/60 + T*(-46.815 +T*(-0.0006 + T*0.00181) )/3600 ) / 180 * java.lang.Math.PI; // schiefe der Ekliptik
+			double coseps = Math.cos(eps);
+			double sineps = Math.sin(eps);
+
+			double sinlon = Math.sin(eklipCoo.lonDec / 180 * Math.PI);
+			CWPoint equatorial = new CWPoint();
+			equatorial.lonDec = (180 / Math.PI * Math.atan2( (sinlon*coseps-Math.tan(eklipCoo.latDec /180 * Math.PI)*sineps), Math.cos(eklipCoo.lonDec/180 * Math.PI) ) ) % 360; // rektaszension (alpha)
+			equatorial.latDec = 180 / Math.PI * Math.asin( Math.sin(eklipCoo.latDec/180 * Math.PI)*coseps + Math.cos(eklipCoo.latDec/180 * Math.PI)*sineps*sinlon ); // deklination (delta)
+
+			return equatorial;
+		}
+		
+		/**
+		 * @param utc in the format as it comes from gps DDMMYY
+		 * @param datum in the format as it comes from gps HHMMSS
+		 * @return juliandate
+		 * @throws NumberFormatException if utc / datum could not be parsed successfully
+		 */
+		public static double utc2juliandate(String utc, String datum) {
 			try {
-				tcpConn = new Socket(forwardIP, 23);
-				tcpForward = true;
-			} catch (ewe.net.UnknownHostException e) { tcpForward = false; lastError = e.getMessage();
-			} catch (IOException e) { tcpForward = false; lastError = e.getMessage(); 
+				int tag, monat, jahr, stunde, minute, sekunde;
+				tag     = Convert.parseInt(datum.substring(0, 2));
+				monat   = Convert.parseInt(datum.substring(2, 4));
+				jahr    = Convert.parseInt(datum.substring(4, 6)) + 2000;
+				stunde  = Convert.parseInt(utc.substring(0, 2));
+				minute  = Convert.parseInt(utc.substring(2, 4));
+				sekunde = Convert.parseInt(utc.substring(4, 6)); // Kommastellen werden abgeschnitten
+				// julianisches "Datum" jd berechnen (see http://de.wikipedia.org/wiki/Julianisches_Datum )
+				if (monat<2) {jahr--; monat+=12;} // verlegung des Jahres Endes auf Feb macht Berechnung von SChaltjahren einfacher
+				double a = (int)java.lang.Math.floor((double)jahr/100.); // Alle hundert Jahre kein Schlatjahr (abrunden)
+				double b = 2 - a + java.lang.Math.floor((double)a/4.);
+				double jd = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) + (double)tag + (double)stunde/24 + (double)minute/1440 + (double)sekunde/86400 + b - 1524.5;
+				return jd;
+				//double jd0 = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) +(double)tag + b - 1524.5;
+			} catch (IndexOutOfBoundsException e) {
+				// wird von substring geworfen wenn datum / utc nicht genug Ziffern haben
+				// NumberFormatException wird au?erdem von Convert.ParseInt direkt geworfen wenn
+				// nicht in Int konvertiert werden kann
+				throw new NumberFormatException();
 			}
 		}
-		myGPS = GPSPoint;
 	}
 
-	public void run() {
-		int noData = 0;
-		int notinterpreted = 0;
-		run = true;
-		while (run){
-			try {
-				sleep(1000);
-				//Vm.debug("Loop? " + noData);
-				noData++;
-				if (noData > 5) { myGPS.noDataError(); }
-			} catch (InterruptedException e) {}
-			if (comSp != null)	{
-				comLength = comSp.nonBlockingRead(comBuff, 0 ,comBuff.length);
-				//Vm.debug("Length: " + comBuff.length);
-				if (comLength > 0)	{
-					noData = 0;
-					String str = mString.fromAscii(comBuff, 0, comLength); 
-					if (tcpForward) {
-						try {
-							tcpConn.write(comBuff, 0, comLength);
-						} catch (IOException e) { tcpForward = false; }
-					}
-					//Vm.debug(str);
-					if (myGPS.examine(str)) notinterpreted = 0; else notinterpreted++;
-					if (notinterpreted > 22) myGPS.noInterpretableData();
+	/**
+	 * Thread for reading data from COM-port
+	 *
+	 */
+	class SerialThread extends mThread{
+		SerialPort comSp;   
+		byte[] comBuff = new byte[1024*10]; // when some action takes a long time (eg. loading or zooming a map), a lot of data can be in the buffer, read that at once
+		int comLength = 0;
+		CWGPSPoint myGPS;
+		boolean run, tcpForward;
+		Socket tcpConn;
+		String lastError = new String();
+
+		public SerialThread(SerialPortOptions spo, CWGPSPoint GPSPoint, String forwardIP) throws IOException {
+			try{
+				comSp = new SerialPort(spo);
+			} catch (IOException e) {
+				throw new IOException(spo.portName);
+			} // catch (UnsatisfiedLinkError e) {} // TODO in original java-vm 
+			if (forwardIP.length()>0) { 
+				try {
+					tcpConn = new Socket(forwardIP, 23);
+					tcpForward = true;
+				} catch (ewe.net.UnknownHostException e) { tcpForward = false; lastError = e.getMessage();
+				} catch (IOException e) { tcpForward = false; lastError = e.getMessage(); 
 				}
 			}
-		} // while
-		myGPS.noData();
-		tcpConn.close();
-	}
+			myGPS = GPSPoint;
+		}
 
-	public void stop() {
-		run = false;
-		if (comSp != null) comSp.close();
+		public void run() {
+			int noData = 0;
+			int notinterpreted = 0;
+			run = true;
+			while (run){
+				try {
+					sleep(1000);
+					//Vm.debug("Loop? " + noData);
+					noData++;
+					if (noData > 5) { myGPS.noDataError(); }
+				} catch (InterruptedException e) {}
+				if (comSp != null)	{
+					comLength = comSp.nonBlockingRead(comBuff, 0 ,comBuff.length);
+					//Vm.debug("Length: " + comBuff.length);
+					if (comLength > 0)	{
+						noData = 0;
+						String str = mString.fromAscii(comBuff, 0, comLength); 
+						if (tcpForward) {
+							try {
+								tcpConn.write(comBuff, 0, comLength);
+							} catch (IOException e) { tcpForward = false; }
+						}
+						//Vm.debug(str);
+						if (myGPS.examine(str)) notinterpreted = 0; else notinterpreted++;
+						if (notinterpreted > 22) myGPS.noInterpretableData();
+					}
+				}
+			} // while
+			myGPS.noData();
+			tcpConn.close();
+		}
+
+		public void stop() {
+			run = false;
+			if (comSp != null) comSp.close();
+		}
 	}
-}
 
-/** 
- * Class for creating a new mThread to create timer ticks to be able to do form.close in the ticked-thread. 
- * Using the Vm.requestTimer-Method causes "ewe.sys.EventDirectionException: This task cannot be done within 
- * a Timer Tick." in the ewe-vm when form.close is called.  
- */
+	/** 
+	 * Class for creating a new mThread to create timer ticks to be able to do form.close in the ticked-thread. 
+	 * Using the Vm.requestTimer-Method causes "ewe.sys.EventDirectionException: This task cannot be done within 
+	 * a Timer Tick." in the ewe-vm when form.close is called.  
+	 */
 
-class UpdateThread extends mThread {
-	public boolean run;
-	public int calldelay;
-	public Navigate ticked;
+	class UpdateThread extends mThread {
+		public boolean run;
+		public int calldelay;
+		public Navigate ticked;
 
-	public UpdateThread (Navigate gp, int cd) {
-		ticked = gp;
-		calldelay = cd;
-	}
+		public UpdateThread (Navigate gp, int cd) {
+			ticked = gp;
+			calldelay = cd;
+		}
 
-	public void run () {
-		run = true;
-		while (run) {
-			try { sleep (calldelay);} catch (InterruptedException e) {}
-			ticked.ticked();
+		public void run () {
+			run = true;
+			while (run) {
+				try { sleep (calldelay);} catch (InterruptedException e) {}
+				ticked.ticked();
+			}
 		}
-	}
 
-	public void stop() {
-		run = false;
+		public void stop() {
+			run = false;
+		}
 	}
-}
 

Modified: trunk/src/CacheWolf/TablePanel.java
===================================================================
--- trunk/src/CacheWolf/TablePanel.java	2007-08-15 10:22:19 UTC (rev 820)
+++ trunk/src/CacheWolf/TablePanel.java	2007-08-16 22:41:50 UTC (rev 821)
@@ -42,13 +42,13 @@
 	}
 	
 	public void setSelectedCache(int row){ 
-		selectedCh=null;
+	/*	selectedCh=null;
 		selectedIdx=-1;
 		if (row>=0 && row<cacheDB.size())  {
 			selectedCh=(CacheHolder) cacheDB.get(row);
 			selectedIdx=row;
 		} 		
-	
+	*/
 	}
 	
 	/** Mark the row as selected so that myTableModel can color it grey */
@@ -60,6 +60,18 @@
 		tc.scrollToVisible(row,0);
 		// Next line needed for key scrolling 
 		tc.cursorTo(row, tc.cursor.x+tc.listMode, true);
+// <<<<<<< .mine
+		//tc.scrollToVisible(row,0);
+		//tc.clearSelection(null);
+		//tc.addToSelection(row,0); 
+		//tc.addToSelection(row,myMod.MAXCOLUMNS-1); 
+		//tc.scrollToVisible(row,0);
+		/*tc.clearSelection(null);
+		tc.addToSelection(row,0); 
+		tc.addToSelection(row,myMod.MAXCOLUMNS-1);*/ 
+		//tc.paintSelectedCells();
+//=======
+//>>>>>>> .r820
 	}
 	
 	/** Highlight the first row in grey. It can be unhighlighted by clicking */
@@ -76,6 +88,8 @@
 	 * @return index of selected cache (-1 if not visible)
 	 */
 	public int getSelectedCache(){
+		return tc.cursor.y;
+		/*
 		// If cacheDB is empty return -1, cannot select a cache
 		if (cacheDB.size()==0) return -1;
 		// If cacheDB has entries, but all are filtered, return -1
@@ -88,7 +102,7 @@
 		// Check whether the order of the list has changed because of sort/filter/search operations
 		if (cacheDB.get(selectedIdx)==selectedCh) return selectedIdx;
 		// The position has changed, return the new position
-		return cacheDB.find(selectedCh);
+		return cacheDB.find(selectedCh); */
 	}
 	
 	public void saveColWidth(Preferences pref){

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2007-08-15 10:22:19 UTC (rev 820)
+++ trunk/src/CacheWolf/myTableControl.java	2007-08-16 22:41:50 UTC (rev 821)
@@ -64,7 +64,8 @@
 			else if (ev.key == IKeys.PAGE_UP) Global.mainTab.tbP.selectRow(java.lang.Math.max(cursor.y-getOnScreen(null).height+1, 0)); // cursorTo(java.lang.Math.max(cursor.y-getOnScreen(null).height+1, 0),cursor.x+listMode,true);
 			else if (ev.key == IKeys.ACTION || ev.key == IKeys.ENTER) Global.mainTab.select(Global.mainTab.descP);
 			else if (ev.key == IKeys.DOWN) Global.mainTab.tbP.selectRow(java.lang.Math.min(cursor.y+ 1, model.numRows-1)); 
-			else if (ev.key == IKeys.UP) Global.mainTab.tbP.selectRow(java.lang.Math.max(cursor.y-1, 0)); 
+			else if (ev.key == IKeys.UP) Global.mainTab.tbP.selectRow(java.lang.Math.max(cursor.y-1, 0));
+			else if (ev.key == 6 ) MainMenu.search(); // (char)6 == ctrl + f 
 			else super.onKeyEvent(ev);
 		}
 		else super.onKeyEvent(ev);



From pfeffer at mail.berlios.de  Fri Aug 17 02:57:26 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 17 Aug 2007 02:57:26 +0200
Subject: [Cachewolf-svn] r822 - trunk/src/CacheWolf
Message-ID: <200708170057.l7H0vQu8010340@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-17 02:57:22 +0200 (Fri, 17 Aug 2007)
New Revision: 822

Added:
   trunk/src/CacheWolf/TableForm.java
Modified:
   trunk/src/CacheWolf/MainForm.java
   trunk/src/CacheWolf/MainTab.java
   trunk/src/CacheWolf/Map.java
   trunk/src/CacheWolf/MapsList.java
   trunk/src/CacheWolf/TablePanel.java
Log:
* The menu bar is now only shown in the cache list to make more space in all other panels
* some clean up

Modified: trunk/src/CacheWolf/MainForm.java
===================================================================
--- trunk/src/CacheWolf/MainForm.java	2007-08-16 22:41:50 UTC (rev 821)
+++ trunk/src/CacheWolf/MainForm.java	2007-08-17 00:57:22 UTC (rev 822)
@@ -46,20 +46,21 @@
 	}
 	
 	public void doIt(){
-		CellPanel [] p = addToolbar();
+	//	CellPanel [] p = addToolbar();
 		Global.mainForm=this;
 		//this.title = "CacheWolf " + Version.getRelease();
 		this.exitSystemOnClose = true;
 		this.resizable = true;
 		this.moveable = true;
+		this.windowFlagsToSet = Window.FLAG_MAXIMIZE_ON_PDA;
 		if(Vm.isMobile() == true) {
-
 			//this.windowFlagsToSet = Window.FLAG_FULL_SCREEN;
 			this.resizable = false;
 			this.moveable = false;
-			this.windowFlagsToClear=WindowConstants.FLAG_HAS_TITLE; //TODO don't clear this to use original windows haedline ?
-		} else 
-			this.setPreferredSize(800, 600);
+			this.windowFlagsToClear = WindowConstants.FLAG_HAS_TITLE; //TODO don't clear this to use original windows haedline ?
+		}
+		Rect screen = ((ewe.fx.Rect) (Window.getGuiInfo(Window.INFO_SCREEN_RECT,null,new ewe.fx.Rect(),0)));
+		if ( screen.height >= 600 && screen.width >= 800) this.setPreferredSize(800, 600);
 		this.resizeOnSIP = true;
 		// Load CacheList
 		InfoBox infB = new InfoBox("CacheWolf",MyLocale.getMsg(5000,"Loading Cache-List"));
@@ -101,9 +102,10 @@
 		pnlMainTab.addLast(mTab,STRETCH,FILL);
 		
 		mTab.dontAutoScroll=true;
-		p[0].addLast(mMenu);
+		//p[0].addLast(mMenu);
 		//p[0].addLast(mMenu,CellConstants.DONTSTRETCH, CellConstants.FILL);
-		p[1].addLast(split,STRETCH,FILL);
+		//p[1].addLast(split,STRETCH,FILL);
+		this.addLast(split,STRETCH,FILL);
 		/*
 		if (pref.menuAtTop) {
 			this.addLast(mMenu,CellConstants.DONTSTRETCH, CellConstants.FILL);

Modified: trunk/src/CacheWolf/MainTab.java
===================================================================
--- trunk/src/CacheWolf/MainTab.java	2007-08-16 22:41:50 UTC (rev 821)
+++ trunk/src/CacheWolf/MainTab.java	2007-08-17 00:57:22 UTC (rev 822)
@@ -48,7 +48,8 @@
 		//Don't expand tabs if the screen is very narrow, i.e. HP IPAQ 65xx, 69xx
 		if (MyLocale.getScreenWidth() <= 240) this.dontExpandTabs=true;
 		calcP = new CalcPanel(); // Init here so that Global.MainT is already set
-		Card c = this.addCard(tbP = new TablePanel(pref, profile, statBar), MyLocale.getMsg(1200,"List"), null);
+		tbP = new TablePanel(pref, profile, statBar);
+		Card c = this.addCard(new TableForm(tbP), MyLocale.getMsg(1200,"List"), null);
 
 		c = this.addCard(detP, MyLocale.getMsg(1201,"Details"), null);
 		c.iconize(new Image("details.gif"),true);

Modified: trunk/src/CacheWolf/Map.java
===================================================================
--- trunk/src/CacheWolf/Map.java	2007-08-16 22:41:50 UTC (rev 821)
+++ trunk/src/CacheWolf/Map.java	2007-08-17 00:57:22 UTC (rev 822)
@@ -348,7 +348,7 @@
 							gcpG.bitMapX = gcp4.bitMapX;
 							gcpG.bitMapY = gcp4.bitMapY;
 							addGCP(gcpG);
-							
+							/* already read from image file itself
 							// get dimensions of image
 							while ( (line = inMap.readLine()) != null){
 								if (line.startsWith("IWH")){
@@ -357,7 +357,7 @@
 									imageHeight = Convert.toInt(parts[3]);
 								}
 							}
-
+							 */
 							evalGCP();
 							//Vm.debug("Saving .map file to: " + mapsPath + "/" + rawFileName + ".wfl");
 							wfl.saveWFL(mapsPath, rawFileName);

Modified: trunk/src/CacheWolf/MapsList.java
===================================================================
--- trunk/src/CacheWolf/MapsList.java	2007-08-16 22:41:50 UTC (rev 821)
+++ trunk/src/CacheWolf/MapsList.java	2007-08-17 00:57:22 UTC (rev 822)
@@ -27,7 +27,7 @@
 		super(); // forget already loaded maps
 		//if (mmp.mapImage != null) 
 		String dateien[];
-		File files = new FileBugfix(mapsPath);
+		FileBugfix files = new FileBugfix(mapsPath);
 		String rawFileName = new String();
 		String[] dirstmp = files.list(null, File.LIST_DIRECTORIES_ONLY);
 		Vector dirs;
@@ -39,7 +39,7 @@
 		for (int j = dirs.size()-1; j >= 0; j--) {
 			files = new FileBugfix(mapsPath+"/"+dirs.get(j));
 			//ewe.sys.Vm.debug("mapd-Dirs:"+files);
-			dateien = files.listMultiple("*.wfl,892z3rihugkdfhgflhldghoeighoig8", File.LIST_FILES_ONLY); //"*.xyz" doesn't work on some systems and "*" doesn't on others -> use null (for all files) and filter yourself
+			dateien = files.list("*.wfl", File.LIST_FILES_ONLY); //"*.xyz" doesn't work on some systems -> use FileBugFix
 			for(int i = 0; i < dateien.length;i++){
 				// if (!dateien[i].endsWith(".wfl")) continue;
 				rawFileName = dateien[i].substring(0, dateien[i].lastIndexOf("."));

Added: trunk/src/CacheWolf/TableForm.java
===================================================================
--- trunk/src/CacheWolf/TableForm.java	2007-08-16 22:41:50 UTC (rev 821)
+++ trunk/src/CacheWolf/TableForm.java	2007-08-17 00:57:22 UTC (rev 822)
@@ -0,0 +1,12 @@
+package CacheWolf;
+
+import ewe.ui.CellPanel;
+import ewe.ui.Editor;
+
+public class TableForm extends Editor {
+	public TableForm(TablePanel tp) {
+		CellPanel[] menuList = addToolbar();
+		menuList[0].addLast(Global.mainForm.mMenu);
+		menuList[1].addLast(tp); 
+	}
+}

Modified: trunk/src/CacheWolf/TablePanel.java
===================================================================
--- trunk/src/CacheWolf/TablePanel.java	2007-08-16 22:41:50 UTC (rev 821)
+++ trunk/src/CacheWolf/TablePanel.java	2007-08-17 00:57:22 UTC (rev 822)
@@ -54,8 +54,8 @@
 	/** Mark the row as selected so that myTableModel can color it grey */
 	public void selectRow(int row) {
 		setSelectedCache(row);
-		tc.addToSelection(row,0); 
-		tc.addToSelection(row,myMod.MAXCOLUMNS-1);
+//		tc.addToSelection(row,0); 
+//		tc.addToSelection(row,myMod.MAXCOLUMNS-1);
 		// Ensure that the highlighted row is visible (e.g. when coming from radar panel)
 		tc.scrollToVisible(row,0);
 		// Next line needed for key scrolling 
@@ -78,8 +78,9 @@
 	public void selectFirstRow() {
 		myMod.cursorSize=new Dimension(-1,1);
 		if (cacheDB.size()>0) {
-			tc.addToSelection(0,0); 
-			tc.addToSelection(0,myMod.MAXCOLUMNS-1);
+			tc.cursorTo(0, -1, true);
+//			tc.addToSelection(0,0); 
+//			tc.addToSelection(0,myMod.MAXCOLUMNS-1);
 		}
 	}
 	



From mik77 at mail.berlios.de  Fri Aug 17 13:08:22 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Fri, 17 Aug 2007 13:08:22 +0200
Subject: [Cachewolf-svn] r823 - trunk/src/CacheWolf
Message-ID: <200708171108.l7HB8McS011262@sheep.berlios.de>

Author: mik77
Date: 2007-08-17 13:08:19 +0200 (Fri, 17 Aug 2007)
New Revision: 823

Modified:
   trunk/src/CacheWolf/MainForm.java
Log:
unnecessary border on PDA removed

Modified: trunk/src/CacheWolf/MainForm.java
===================================================================
--- trunk/src/CacheWolf/MainForm.java	2007-08-17 00:57:22 UTC (rev 822)
+++ trunk/src/CacheWolf/MainForm.java	2007-08-17 11:08:19 UTC (rev 823)
@@ -54,10 +54,8 @@
 		this.moveable = true;
 		this.windowFlagsToSet = Window.FLAG_MAXIMIZE_ON_PDA;
 		if(Vm.isMobile() == true) {
-			//this.windowFlagsToSet = Window.FLAG_FULL_SCREEN;
 			this.resizable = false;
 			this.moveable = false;
-			this.windowFlagsToClear = WindowConstants.FLAG_HAS_TITLE; //TODO don't clear this to use original windows haedline ?
 		}
 		Rect screen = ((ewe.fx.Rect) (Window.getGuiInfo(Window.INFO_SCREEN_RECT,null,new ewe.fx.Rect(),0)));
 		if ( screen.height >= 600 && screen.width >= 800) this.setPreferredSize(800, 600);



From pfeffer at mail.berlios.de  Fri Aug 17 14:11:02 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 17 Aug 2007 14:11:02 +0200
Subject: [Cachewolf-svn] r824 - trunk/src/CacheWolf
Message-ID: <200708171211.l7HCB2Or022227@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-17 14:11:00 +0200 (Fri, 17 Aug 2007)
New Revision: 824

Modified:
   trunk/src/CacheWolf/GotoPanel.java
Log:
Koordinateneingabefenster nach oben auf dem Display, damit SIP es nicht verdeckt

Modified: trunk/src/CacheWolf/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/GotoPanel.java	2007-08-17 11:08:19 UTC (rev 823)
+++ trunk/src/CacheWolf/GotoPanel.java	2007-08-17 12:11:00 UTC (rev 824)
@@ -377,7 +377,7 @@
 				CoordsScreen cs = new CoordsScreen();
 				if (myNavigation.destination.isValid())	cs.setFields(myNavigation.destination, currFormat);
 				else cs.setFields(new CWPoint(0,0), currFormat);
-				if (cs.execute() == CoordsScreen.IDOK)
+				if (cs.execute(null, Gui.TOP) == CoordsScreen.IDOK)
 					setDestination(cs.getCoords());
 			}
 		}



From mik77 at mail.berlios.de  Fri Aug 17 18:50:09 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Fri, 17 Aug 2007 18:50:09 +0200
Subject: [Cachewolf-svn] r825 - trunk/resources
Message-ID: <200708171650.l7HGo9HZ009177@sheep.berlios.de>

Author: mik77
Date: 2007-08-17 18:49:57 +0200 (Fri, 17 Aug 2007)
New Revision: 825

Modified:
   trunk/resources/spider.def
Log:
better regex for cache line not depending on compass rose

Modified: trunk/resources/spider.def
===================================================================
--- trunk/resources/spider.def	2007-08-17 12:11:00 UTC (rev 824)
+++ trunk/resources/spider.def	2007-08-17 16:49:57 UTC (rev 825)
@@ -10,6 +10,7 @@
 # Version 2.6 - 20070701 Bugfix: Wenn Zentrum exakt in Cachekoordinaten liegt wurde der Cache nicht gespidert
 # Version 2.7 - 20070811 Bugfix fuer verschluesselte Logs
 # Version 2.8 - 20070814 Findet jetzt auch Addi Wpts in eigenen Caches
+# Version 2.9 - 20070817 Bessere Unterscheidung zwischen Werbung vs.normalen Caches + Caches ohne Richtung/Entfenung
 #============================================================
 # A suffix of Rex indicates a regular expression
 # A suffix of ExStart indicates the start of an Extractor search pattern
@@ -28,7 +29,7 @@
 firstPage2         = &lon=
 # Regex to search for cachenames 
 listBlockRex       = <table id="dlResults"((?s).*?)</table>
-lineRex            = (?:images/icons/compass|<td\ valign="top"\ align="left"><br\ />)((?s).*?)</tr>
+lineRex            = <tr\ bgcolor='#.{6}'>(?:(?s).*?)<td\ valign="top"\ align="left">((?s).*?)</tr>
 distRex            = <br\ />(.*?)(km|mi)</td>
 waypointRex        = </a> \\((.*?)\\)<br>
 showOnlyFound      = &f=1



From mik77 at mail.berlios.de  Sat Aug 18 12:53:33 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Sat, 18 Aug 2007 12:53:33 +0200
Subject: [Cachewolf-svn] r826 - branches/bugfix_09n/src/CacheWolf
Message-ID: <200708181053.l7IArX8Y025300@sheep.berlios.de>

Author: mik77
Date: 2007-08-18 12:53:29 +0200 (Sat, 18 Aug 2007)
New Revision: 826

Modified:
   branches/bugfix_09n/src/CacheWolf/SpiderGC.java
Log:
 - regex changes ported from trunk (r816 + r825)
 - small bugfix for spidering distance ported from trunk (r793)

Modified: branches/bugfix_09n/src/CacheWolf/SpiderGC.java
===================================================================
--- branches/bugfix_09n/src/CacheWolf/SpiderGC.java	2007-08-17 16:49:57 UTC (rev 825)
+++ branches/bugfix_09n/src/CacheWolf/SpiderGC.java	2007-08-18 10:53:29 UTC (rev 826)
@@ -314,7 +314,7 @@
 		dummy = "";
 		//String lineBlck = "";
 		int page_number = 4;		
-		rexLine = new Regex("images/icons/compass((?s).*?)</tr>");
+		rexLine = new Regex("<tr bgcolor='#.{6}'>(?:(?s).*?)<td valign="top" align="left">((?s).*?)</tr>");
 		int found_on_page = 0;
 		//Loop till maximum distance has been found or no more caches are in the list
 		while(distance > 0){
@@ -549,7 +549,7 @@
 	}
 	
 	public void getAddWaypoints(String doc, String wayPoint, boolean is_found){
-		Extractor exWayBlock = new Extractor(doc, "<strong>Additional Waypoints</strong><br>", "</table>", 0, false);
+		Extractor exWayBlock = new Extractor(doc, "<strong>Additional Waypoints</strong>", "</table>", 0, false);
 		String wayBlock = "";
 		String rowBlock = "";
 		wayBlock = exWayBlock.findNext();
@@ -794,6 +794,7 @@
 		inRex = new Regex("<br />(.*?)(km|mi)</td>");
 		inRex.search(doc);
 		if(doc.indexOf("Here") > 0) return(0);
+		if (!inRex.didMatch()) return 0;
 		if(pref.digSeparator.equals(",")) return Convert.toDouble(inRex.stringMatched(1).replace('.',','));
 		return Convert.toDouble(inRex.stringMatched(1));
 	}



From kalli at mail.berlios.de  Sat Aug 18 20:07:01 2007
From: kalli at mail.berlios.de (kalli at mail.berlios.de)
Date: Sat, 18 Aug 2007 20:07:01 +0200
Subject: [Cachewolf-svn] r827 - trunk/src/CacheWolf
Message-ID: <200708181807.l7II71nh006128@sheep.berlios.de>

Author: kalli
Date: 2007-08-18 20:06:54 +0200 (Sat, 18 Aug 2007)
New Revision: 827

Modified:
   trunk/src/CacheWolf/GPXImporter.java
Log:
Bugfix #28: CacheWolf beleibt beim Laden von Bildern h?\195?\164ngen

Modified: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2007-08-18 10:53:29 UTC (rev 826)
+++ trunk/src/CacheWolf/GPXImporter.java	2007-08-18 18:06:54 UTC (rev 827)
@@ -316,10 +316,10 @@
 						int num = 0;
 						while(ex.endOfSearch() == false && spiderOK == true){
 							//Vm.debug("Replacing: " + text);
+							if (num >= holder.ImagesText.getCount())break;
 							imgName = (String)holder.ImagesText.get(num);
 							holder.LongDescription = replace(holder.LongDescription, text, "[[Image: " + imgName + "]]");
 							num++;
-							if (num >= holder.ImagesText.getCount())break;
 							text = ex.findNext();
 						}
 					}



From salzkammergut at mail.berlios.de  Mon Aug 20 21:41:58 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Mon, 20 Aug 2007 21:41:58 +0200
Subject: [Cachewolf-svn] r828 - trunk/src/CacheWolf
Message-ID: <200708201941.l7KJfwJ9031855@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-20 21:41:53 +0200 (Mon, 20 Aug 2007)
New Revision: 828

Modified:
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/MainTab.java
Log:
Aufraeumen als Follow-up fuer Rev 822. Da das Hauptmenue nur mehr in der Listenasicht gezeigt wird, kann das Ein-/Ausblenden der Menueeintraege zum Laden von Profilen entfernt werden.

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2007-08-18 18:06:54 UTC (rev 827)
+++ trunk/src/CacheWolf/MainMenu.java	2007-08-20 19:41:53 UTC (rev 828)
@@ -28,7 +28,7 @@
 	private MenuItem exportOZI, exportKML, exportTPL;
 	private MenuItem filtCreate, filtClear, filtInvert, filtSelected, filtBlack, filtApply;
 	private MenuItem exportGPS, exportCacheMate,mnuSeparator;
-	private MenuItem orgCopy, orgMove, orgDelete;
+	private MenuItem orgCopy, orgMove, orgDelete, orgTravelbugs;
 	public MenuItem orgCacheTour;
 	private MenuItem mnuNewProfile, mnuOpenProfile, mnuEditCenter;
 	private Form father;
@@ -151,12 +151,13 @@
 		///////////////////////////////////////////////////////////////////////
 		// Create the "Organize" pulldown menu
 		///////////////////////////////////////////////////////////////////////
-		MenuItem[] organizeMenuItems=new MenuItem[5];
+		MenuItem[] organizeMenuItems=new MenuItem[6];
 		organizeMenuItems[0] = orgCopy  = new MenuItem(MyLocale.getMsg(141,"Copy")); 
 		organizeMenuItems[1] = orgMove  = new MenuItem(MyLocale.getMsg(142,"Move")); 
 		organizeMenuItems[2] = orgDelete   = new MenuItem(MyLocale.getMsg(143,"Delete"));
 		organizeMenuItems[3] = mnuSeparator;
 		organizeMenuItems[4] = orgCacheTour = new MenuItem(MyLocale.getMsg(198,"Cachetour"));
+		organizeMenuItems[5] = mnuSeparator;
 		this.addMenu(new PullDownMenu(MyLocale.getMsg(140,"Organize"),new Menu(organizeMenuItems,null)));
 
 		///////////////////////////////////////////////////////////////////////
@@ -175,16 +176,6 @@
 		tbp = t;
 	}
 	
-	public void allowProfileChange(boolean profileChangeAllowed) {
-		if (profileChangeAllowed) {
-			mnuNewProfile.modifiers&=~MenuItem.Disabled;
-			mnuOpenProfile.modifiers&=~MenuItem.Disabled;
-		} else {
-			mnuNewProfile.modifiers|=MenuItem.Disabled;
-			mnuOpenProfile.modifiers|=MenuItem.Disabled;
-		}
-	}
-
 	public static void search() {
 		String srch = new InputBox(MyLocale.getMsg(119,"Search for:")).input("",10);
 		if (srch != null) {

Modified: trunk/src/CacheWolf/MainTab.java
===================================================================
--- trunk/src/CacheWolf/MainTab.java	2007-08-18 18:06:54 UTC (rev 827)
+++ trunk/src/CacheWolf/MainTab.java	2007-08-20 19:41:53 UTC (rev 828)
@@ -77,7 +77,6 @@
 		c = this.addCard(radarP, "Radar", null);
 		radarP.setMainTab(this);
 		c.iconize(new Image("radar.gif"),true);
-		mnuMain.allowProfileChange(true);
 	}
 
 	public TablePanel getTablePanel(){
@@ -93,8 +92,6 @@
 	public void onEvent(Event ev)
 	{
 		if(ev instanceof MultiPanelEvent){
-			// Check whether a profile change is allowed, if not disable the relevant options
-			checkProfileChange();
 			// Perform clean up actions for the panel we are leaving
 			onLeavingPanel(oldCard);
 			// Prepare actions for the panel we are about to enter
@@ -362,14 +359,6 @@
 		if (saveIndex) profile.saveIndex(Global.getPref(),false);
 	}
 	
-	private void checkProfileChange() {
-		// A panel is selected. Could be the same panel twice
-		mnuMain.allowProfileChange(false);	  
-		if(this.getSelectedItem() == 0){// List view selected
-			mnuMain.allowProfileChange(true);	  
-			MyLocale.setSIPOff();
-		}
-	}
 }
 // 
 



From salzkammergut at mail.berlios.de  Fri Aug 24 20:23:34 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Fri, 24 Aug 2007 20:23:34 +0200
Subject: [Cachewolf-svn] r829 - trunk/src/CacheWolf
Message-ID: <200708241823.l7OINYO9001490@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-24 20:23:28 +0200 (Fri, 24 Aug 2007)
New Revision: 829

Modified:
   trunk/src/CacheWolf/CoordsScreen.java
Log:
CoordsScreen: Uppercase des Wegpunktnamens 
(http://www.geoclub.de/ftopic18262.html)

Modified: trunk/src/CacheWolf/CoordsScreen.java
===================================================================
--- trunk/src/CacheWolf/CoordsScreen.java	2007-08-20 19:41:53 UTC (rev 828)
+++ trunk/src/CacheWolf/CoordsScreen.java	2007-08-24 18:23:28 UTC (rev 829)
@@ -215,11 +215,12 @@
 			if (ev.target == btnParse){
 				// try to parse coords
 				CWPoint coord;
-				if (inpText.getText().trim().startsWith("GC")) {
+				String inp=inpText.getText().trim().toUpperCase();
+				if (inp.startsWith("GC")) {
 					SpiderGC spider = new SpiderGC(Global.getPref(), Global.getProfile(), false);
-					coord = new CWPoint(spider.getCacheCoordinates(inpText.getText().trim()));
+					coord = new CWPoint(spider.getCacheCoordinates(inp));
 				} else {	
-					coord = new CWPoint(inpText.getText());
+					coord = new CWPoint(inp);
 				}
 				if (coord.latDec == 0 && coord.lonDec == 0){
 					MessageBox tmpMB = new MessageBox(MyLocale.getMsg(312,"Error"), MyLocale.getMsg(4111,"Coordinates must be entered in the format N DD MM.MMM E DDD MM.MMM"), MessageBox.OKB);



From salzkammergut at mail.berlios.de  Fri Aug 24 20:47:26 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Fri, 24 Aug 2007 20:47:26 +0200
Subject: [Cachewolf-svn] r830 - trunk/src/CacheWolf
Message-ID: <200708241847.l7OIlQ19003441@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-24 20:47:20 +0200 (Fri, 24 Aug 2007)
New Revision: 830

Modified:
   trunk/src/CacheWolf/Profile.java
Log:
Profile: Die Datei index.xml wird beim Speichern umbenannt in index.bak. Wenn bereits ein index.bak existiert
wird dies zunaechst geloescht. Dadurch kann bei Problemen mit der index.xml auf das Backup zurueckgegriffen werden.

Modified: trunk/src/CacheWolf/Profile.java
===================================================================
--- trunk/src/CacheWolf/Profile.java	2007-08-24 18:23:28 UTC (rev 829)
+++ trunk/src/CacheWolf/Profile.java	2007-08-24 18:47:20 UTC (rev 830)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import HTML.Tmpl.Element.If;
 import ewe.io.BufferedWriter;
 import ewe.io.File;
 import ewe.io.FileNotFoundException;
@@ -12,8 +13,6 @@
 import ewe.sys.Handle;
 import ewe.sys.Vm;
 import ewe.ui.ProgressBarForm;
-import ewe.util.Hashtable;
-import ewe.util.Vector;
 import ewe.util.*;
 
 /**
@@ -113,6 +112,14 @@
 		}
 		PrintWriter detfile;
 		CacheHolder ch;
+		try {
+			File backup=new File(dataDir+"index.bak");
+			if (backup.exists()) backup.delete();
+			File index=new File(dataDir+"index.xml");
+			index.rename("index.bak");
+		} catch (Exception ex) {
+			pref.log("Error deleting backup or renaming index.xml");
+		}
 		try{
 			detfile = new PrintWriter(new BufferedWriter(new FileWriter(dataDir + "index.xml")));
 		} catch (Exception e) {



From kalli at mail.berlios.de  Sun Aug 26 11:11:46 2007
From: kalli at mail.berlios.de (kalli at mail.berlios.de)
Date: Sun, 26 Aug 2007 11:11:46 +0200
Subject: [Cachewolf-svn] r831 - trunk/src/exp
Message-ID: <200708260911.l7Q9Bk3u011543@sheep.berlios.de>

Author: kalli
Date: 2007-08-26 11:11:42 +0200 (Sun, 26 Aug 2007)
New Revision: 831

Modified:
   trunk/src/exp/GPXExporter.java
Log:
GPX-Export fuer addi wpts angepasst.

Modified: trunk/src/exp/GPXExporter.java
===================================================================
--- trunk/src/exp/GPXExporter.java	2007-08-24 18:47:20 UTC (rev 830)
+++ trunk/src/exp/GPXExporter.java	2007-08-26 09:11:42 UTC (rev 831)
@@ -61,27 +61,34 @@
 			strBuf.append("    <desc>"+SafeXML.cleanGPX(ch.CacheName)+" by "+SafeXML.cleanGPX(ch.CacheOwner)+"</desc>\r\n");
 			strBuf.append("    <url>http://www.geocaching.com/seek/cache_details.aspx?wp="+ch.wayPoint+"&amp;Submit6=Find</url>\r\n");
 			strBuf.append("    <urlname>"+SafeXML.cleanGPX(ch.CacheName)+" by "+SafeXML.cleanGPX(ch.CacheOwner)+"</urlname>\r\n");
-			strBuf.append("    <sym>Geocache</sym>\r\n");
-			strBuf.append("    <type>Geocache|"+CacheType.transType(ch.type)+"</type>\r\n");
-			String dummyAvailable = ch.is_available ? "True":"False";
-			String dummyArchived = ch.is_archived ? "True":"False";
-			strBuf.append("    <groundspeak:cache available=\""+ dummyAvailable + "\" archived=\"" + dummyArchived+ "\" xmlns:groundspeak=\"http://www.groundspeak.com/cache/1/0\">\r\n");
-			strBuf.append("      <groundspeak:name>"+SafeXML.cleanGPX(ch.CacheName)+"</groundspeak:name>\r\n");
-			strBuf.append("      <groundspeak:placed_by>"+SafeXML.cleanGPX(ch.CacheOwner)+"</groundspeak:placed_by>\r\n");
-			strBuf.append("      <groundspeak:owner>"+SafeXML.cleanGPX(ch.CacheOwner)+"</groundspeak:owner>\r\n");
-			strBuf.append("      <groundspeak:type>"+CacheType.transType(ch.type)+"</groundspeak:type>\r\n");
-			strBuf.append("      <groundspeak:container>"+ch.CacheSize+"</groundspeak:container>\r\n");
-			strBuf.append("      <groundspeak:difficulty>"+ch.hard.replace(',','.')+"</groundspeak:difficulty>\r\n");
-			strBuf.append("      <groundspeak:terrain>"+ch.terrain.replace(',','.')+"</groundspeak:terrain>\r\n");
-			String dummyHTML = ch.is_HTML ? "True":"False";
-			strBuf.append("      <groundspeak:long_description html=\"" + dummyHTML + "\">\r\n");
-			strBuf.append("      "+SafeXML.cleanGPX(ch.LongDescription));
-			strBuf.append("      \n</groundspeak:long_description>\r\n");
-			strBuf.append("	  <groundspeak:encoded_hints>"+SafeXML.cleanGPX(Common.rot13(ch.Hints))+"</groundspeak:encoded_hints>\r\n");
-			strBuf.append("      <groundspeak:logs>\r\n");
-			strBuf.append("      </groundspeak:logs>\r\n");
-			strBuf.append("      <groundspeak:travelbugs />\r\n");
-			strBuf.append("    </groundspeak:cache>\r\n");
+			if (!ch.isAddiWpt()){
+				strBuf.append("    <sym>Geocache</sym>\r\n");
+				strBuf.append("    <type>Geocache|"+CacheType.transType(ch.type)+"</type>\r\n");
+				String dummyAvailable = ch.is_available ? "True":"False";
+				String dummyArchived = ch.is_archived ? "True":"False";
+				strBuf.append("    <groundspeak:cache available=\""+ dummyAvailable + "\" archived=\"" + dummyArchived+ "\" xmlns:groundspeak=\"http://www.groundspeak.com/cache/1/0\">\r\n");
+				strBuf.append("      <groundspeak:name>"+SafeXML.cleanGPX(ch.CacheName)+"</groundspeak:name>\r\n");
+				strBuf.append("      <groundspeak:placed_by>"+SafeXML.cleanGPX(ch.CacheOwner)+"</groundspeak:placed_by>\r\n");
+				strBuf.append("      <groundspeak:owner>"+SafeXML.cleanGPX(ch.CacheOwner)+"</groundspeak:owner>\r\n");
+				strBuf.append("      <groundspeak:type>"+CacheType.transType(ch.type)+"</groundspeak:type>\r\n");
+				strBuf.append("      <groundspeak:container>"+ch.CacheSize+"</groundspeak:container>\r\n");
+				strBuf.append("      <groundspeak:difficulty>"+ch.hard.replace(',','.')+"</groundspeak:difficulty>\r\n");
+				strBuf.append("      <groundspeak:terrain>"+ch.terrain.replace(',','.')+"</groundspeak:terrain>\r\n");
+				String dummyHTML = ch.is_HTML ? "True":"False";
+				strBuf.append("      <groundspeak:long_description html=\"" + dummyHTML + "\">\r\n");
+				strBuf.append("      "+SafeXML.cleanGPX(ch.LongDescription));
+				strBuf.append("      \n</groundspeak:long_description>\r\n");
+				strBuf.append("	  <groundspeak:encoded_hints>"+SafeXML.cleanGPX(Common.rot13(ch.Hints))+"</groundspeak:encoded_hints>\r\n");
+				strBuf.append("      <groundspeak:logs>\r\n");
+				strBuf.append("      </groundspeak:logs>\r\n");
+				strBuf.append("      <groundspeak:travelbugs />\r\n");
+				strBuf.append("    </groundspeak:cache>\r\n");
+			}else {
+				// there is no HTML in the description of addi wpts
+				strBuf.append("    <cmt>"+ch.LongDescription+"</cmt>\r\n");
+				strBuf.append("    <sym>"+CacheType.transType(ch.type)+"</sym>\r\n");
+				strBuf.append("    <type>Waypoint|"+CacheType.transType(ch.type)+"</type>\r\n");
+			}
 			strBuf.append("  </wpt>\r\n");
 		}catch(Exception e){
 			e.printStackTrace();



From salzkammergut at mail.berlios.de  Sun Aug 26 13:16:58 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 26 Aug 2007 13:16:58 +0200
Subject: [Cachewolf-svn] r832 - in trunk: resources src/CacheWolf
Message-ID: <200708261116.l7QBGwhE015666@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-26 13:16:50 +0200 (Sun, 26 Aug 2007)
New Revision: 832

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/resources/spider.def
   trunk/src/CacheWolf/SpiderGC.java
Log:
SpiderGC: Diverse Bugfixe und Vorbereitung fuer Travelbugverwaltung.
Beim Spidern vom PDA z.B. http://www.geoclub.de/ftopic18117.html hat ein fehlendes Cookie eine NullPointerException
ausgeloest. Alle Fehlermeldungen fuer Loginprobleme werden jetzt in login() durchgefuehrt. Bei manchen Fehlern wurden 
nicht alle infB Formulare geschlossen.

Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-08-26 09:11:42 UTC (rev 831)
+++ trunk/resources/cachewolf.Languages.cfg	2007-08-26 11:16:50 UTC (rev 832)
@@ -33,6 +33,7 @@
 		129=Importiere GPX
 		130=Download von opencaching.de
 		131=Spider von geocaching.com
+		139=Travelbugs verwalten
 		140=Verwalten 
 		141=Kopieren 
 		142=Verschieben 
@@ -59,7 +60,7 @@
 		170=Basisverzeichnis f%fcr die Profile w%e4hlen
 		171=Profil existiert nicht:+
 		172=Kann das Kartenverzeichnis nicht erstellen:%0a
-		173=Garmin: PC Port:
+		173=GPSBabel:
 		174=Kurznamen
 		175=Import
 		176=Neue Version
@@ -164,7 +165,7 @@
 		625=Ansicht (braucht Neustart):
 		626=Men%fc oben
 		627=Tabs oben
-		628=Status zeigen
+		628=Status
 		629=Profil auto. laden
 		630=Hinweise/Logs:  Logs pro Seite
 		631=PDA hat Schliessen Button 
@@ -460,6 +461,65 @@
 		4501=Gez:
 		4502=Gef:
 		5000=Lade Cacheliste
+		5498=Login nicht m%f6glich. Fehler beim Laden der Seite nach Login.
+		5499=Fehler beim Laden der Login Seite
+		5500=Fehler
+		5501=Login nicht m%f6glich. Falscher Name oder Passwort?
+		5502=Lade erste Seite ...
+		5503=Fehler beim Laden der ersten Seite.
+		5504=Fehler beim Laden der Datei 'spider.def'
+		5505=Passwort eingeben
+		5506=Passwort
+		5507=Status
+		5508=Einloggen ...
+		5509=Zentrumskoordinaten nicht gesetzt
+		5510=Spider Optionen
+		5511=Gefunen
+		5512=+Caches
+		5513=Laden von:+
+		5514=%0aTravelbug:+ 
+		6000=Guid
+		6001=Name
+		6002=Track#
+		6003=Ziel
+		6004=Von Prof
+		6005=Von Wegpt
+		6006=Von Datum
+		6007=Von Log
+		6008=Nach Prof
+	    6009=Nach Wegpt
+		6010=Nach Datum
+		6011=Nach Log
+		6015=*** ANDERER ***
+		6016=Travelbug entnehmen
+		6017=Travelbug ablegen
+		6018=Travelbugname
+		6019=Tracking Nummer
+		6020=Travelbug nicht gefunden.
+		6021=Mehr als einen Travelbug gefunden. Bitte den Namen genauer angeben.
+		6022=: Aktueller Cache:+
+		6025=Name:
+		6026=Tracking #:
+		6027=Id/Guid:
+		6028=Name
+		6029=Profil/Cache:
+		6030=Datum aufgenommen:
+		6031=Geloggt
+		6032=Von
+		6033=Datum abgelegt:
+		6034=Nach
+		6035=Ziel:
+		6036=Ziel
+		6040=Nimm TB aus aktuellem Cache
+		6041=Lege TB in aktuellen Cache
+		6042=Neuer Travelbug
+		6043=Travelbug l%f6schen
+		6044=Ziel von GC holen
+		6045=On-line %d6ffnen
+		6046=Nur nicht geloggte zeigen
+		6047=Ausgew%e4hlte Zeilen l%f6schen
+		6050=Spalten zeigen
+		6051=Spalten verbergen
 		{..}
 		{en}
 		100=to HTML
@@ -494,6 +554,7 @@
 		129=Import GPX
 		130=Download from opencaching.de
 		131=Spider from geocaching.com
+		139=Manage Travelbugs
 		140=Organise            
 		141=Copy 
 		142=Move 
@@ -519,7 +580,7 @@
 		170=Select base directory for cache data
 		171=Profile does not exist:+
 		172=Error: cannot create maps directory:%0a
-		173=Garmin: PC Port:
+		173=GPSBabel:
 		174=Short Names
 		175=Import
 		176=New version
@@ -622,10 +683,10 @@
 		622=Screen
 		623=Images:
 		624=Show deleted images
-		625=Screen layout (needs restart):
+		625=Screen (needs restart):
 		626=Menu top
 		627=Tabs top
-		628=Show status
+		628=Status
 		629=Autoload last profile
 		630=HintLogPanel:  Logs per page 
 		631=PDA has close Button
@@ -918,11 +979,66 @@
 		4500=Tot:
 		4501=Vis:
 		4502=Fnd:
+		5498=Login failed. Error loading page after login. 
+		5499=Error loading login page
 		5000=Load Cachelist
-		5500=Fehler
-		5501=Login nicht m%f6glich
-		5502=Lade erste Seite
-		5502=Konnte erste Seite nicht laden
+		5500=Error
+		5501=Login failed! Wrong account or password?
+		5502=Fetching first page...
+		5503=Error fetching first list page.
+		5504=Could not load 'spider.def'
+		5505=Enter Password
+		5506=Password
+		5507=Status
+		5508=Logging in...
+		5509=Coordinates for center must be set
+		5510=Spider Options
+		5511=Found
+		5512=+caches
+		5513=Loading:+
+		5514=%0aGetting bug:+
+		6000=Guid
+		6001=Name
+		6002=track#
+		6003=Mission
+		6004=From Prof
+		6005=From Wpt
+		6006=From Date
+		6007=From Log
+		6008=To Prof
+	    6009=To Wpt
+		6010=To Date
+		6011=To Log
+		6015=*** OTHER ***
+		6016=Pick up travelbug
+		6017=Drop travelbug
+		6018=Travelbug name
+		6019=Tracking number
+		6020=Travelbug not found.
+		6021=More than one travelbug found. Specify name more precisely.
+		6022=: Current cache:+
+		6025=Name:
+		6026=Tracking #:
+		6027=Id/Guid:
+		6028=Name
+		6029=Profile/Cache:
+		6030=Date found:
+		6031=Logged
+		6032=From
+		6033=Date dropped:
+		6034=To
+		6035=Mission:
+		6036=Mission
+		6040=Pick up TB from current cache
+		6041=Drop TB in cache
+		6042=New Travelbug
+		6043=Delete Travelbug
+		6044=Get Mission
+		6045=Open on-line
+		6046=Show only not logged
+		6047=Delete selected Travelbugs
+		6050=Show column
+		6051=Don't show column
 		{..}
 	{..}
 {..}

Modified: trunk/resources/spider.def
===================================================================
--- trunk/resources/spider.def	2007-08-26 09:11:42 UTC (rev 831)
+++ trunk/resources/spider.def	2007-08-26 11:16:50 UTC (rev 832)
@@ -11,6 +11,7 @@
 # Version 2.7 - 20070811 Bugfix fuer verschluesselte Logs
 # Version 2.8 - 20070814 Findet jetzt auch Addi Wpts in eigenen Caches
 # Version 2.9 - 20070817 Bessere Unterscheidung zwischen Werbung vs.normalen Caches + Caches ohne Richtung/Entfenung
+# Version 1.10 - 20070825 Travelbug support
 #============================================================
 # A suffix of Rex indicates a regular expression
 # A suffix of ExStart indicates the start of an Extractor search pattern
@@ -21,7 +22,9 @@
 # * Be sure that you have no hidden spaces at the end of a line or the patterns will not match!
 #------------------------------------------------------------
 loginPage          = http://www.geocaching.com/login/Default.aspx
+loginSuccess       = You\ are\ logged\ in\ as
 nextPage           = /login/default.aspx
+waypoint           = http://www.geocaching.com/seek/cache_details.aspx?wp=
 #--------------------------------------
 #Section1: First page with list of caches
 #--------------------------------------
@@ -90,6 +93,13 @@
 bugExEnd           = </a></strong></td>
 bugDetailsStart    = id="BugDetail_BugGoal">
 bugDetailsEnd      = </span>
+getBugByName       = http://www.geocaching.com/track/search.aspx?k=
+getBugByGuid       = http://www.geocaching.com/track/details.aspx?guid=
+getBugById         = http://www.geocaching.com/track/details.aspx?id=
+bugGuidExStart     = www.geocaching.com/track/details.aspx?id=
+bugGuidExEnd       = "
+bugNotFound        = No\ results\ were\ found\ for\ your\ search
+bugTotalRecords    = Total\ Records:\ <b>1</b>
 
 #--------------------------------------
 #Section2c: Images

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-26 09:11:42 UTC (rev 831)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-26 11:16:50 UTC (rev 832)
@@ -74,9 +74,18 @@
 		}
 	}
 	
+	private boolean existsSpiderDef() {
+		if (p==null) {
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5504,"Could not load 'spider.def'"), MessageBox.OKB)).execute();
+			return false;
+		}
+		return true;
+	}
 	/**
 	 * Method to login the user to gc.com
 	 * It will request a password and use the alias defined in preferences
+	 * If the login page cannot be fetched, the password is cleared.
+	 * If the login fails, an appropriate message is displayed.
 	 */
 	public int login(){
 		pref.logInit();
@@ -84,24 +93,27 @@
 		//Access the page once to get a viewstate
 		String start,doc,loginPage;
 		//Get password
-		InfoBox infB = new InfoBox("Password", "Enter password:", InfoBox.INPUT);
+		InfoBox infB = new InfoBox(MyLocale.getMsg(5506,"Password"), MyLocale.getMsg(5505,"Enter Password"), InfoBox.INPUT);
 		infB.feedback.setText(passwort); // Remember the PWD for next time
 		int code = infB.execute();
 		passwort = infB.getInput();
 		infB.close(0);
-		if(code != Form.IDOK)
-			return code;
-		infB = new InfoBox("Status", "Logging in...");
+		if(code != Form.IDOK) return code;
+		
+		// Now start the login proper
+		infB = new InfoBox(MyLocale.getMsg(5507,"Status"), MyLocale.getMsg(5508,"Logging in..."));
 		infB.exec();
 		try{
 			pref.log("Fetching login page");
 			start = fetch(loginPage=p.getProperty("loginPage"));   //http://www.geocaching.com/login/Default.aspx
 		}catch(Exception ex){
-			pref.log("Could not fetch: gc.com start page",ex);
+			infB.close(0);
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5499,"Error loading login page"), MessageBox.OKB)).execute();
+			pref.log("Could not fetch: gc.com login page",ex);
 			passwort="";
 			return ERR_LOGIN;
 		}
-		if (!infB.isClosed) {
+		if (!infB.isClosed) { // If user has not aborted, we continue
 			Regex rexCookieID = new Regex("Set-Cookie: userid=(.*?);.*");
 			Regex rex = new Regex("name=\"__VIEWSTATE\" value=\"(.*)\" />");
 			Regex rexCookieSession = new Regex("Set-Cookie: ASP.NET_SessionId=(.*?);.*");
@@ -109,7 +121,8 @@
 			if(rex.didMatch()){
 				viewstate = rex.stringMatched(1);
 				//Vm.debug("ViewState: " + viewstate);
-			}
+			} else
+				pref.log("Viewstate not found before login");
 			//Ok now login!
 			try{
 				pref.log("Logging in as "+pref.myAlias);
@@ -119,26 +132,37 @@
 				    + "&" + URL.encodeURL("cookie",false) +"="+ URL.encodeURL("on",false)
 				    + "&" + URL.encodeURL("Button1",false) +"="+ URL.encodeURL("Login",false);
 				start = fetch_post(loginPage, doc, p.getProperty("nextPage"));  // /login/default.aspx
-				if(start.indexOf("You are logged in as") > 0) pref.log("Login successful");
+				if(start.indexOf(p.getProperty("loginSuccess")) > 0) pref.log("Login successful");
 				else {
 					pref.log("Login failed. Wrong Account or Password?");
 					infB.close(0);
+				    (new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed! Wrong account or password?"), MessageBox.OKB)).execute();
 					return ERR_LOGIN;
 				}
 			}catch(Exception ex){
-				//Vm.debug("Could not login: gc.com start page");
 				pref.log("Login failed.", ex);
 				infB.close(0);
+			    (new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed. Error loading page after login."), MessageBox.OKB)).execute();
 				return ERR_LOGIN;
 			}
 			
 			rex.search(start);
+			if (!rex.didMatch()) {
+				pref.log("Viewstate not found");
+			}
 			viewstate = rex.stringMatched(1);
 			rexCookieID.search(start);
+			if (!rexCookieID.didMatch()) {
+				pref.log("CookieID not found");
+			} 
 			cookieID = rexCookieID.stringMatched(1);
 			//Vm.debug(cookieID);
 			rexCookieSession.search(start);
-			cookieSession = rexCookieSession.stringMatched(1);
+			if (!rexCookieSession.didMatch()) {
+				pref.log("CookieSession not found");
+				cookieSession="";
+			} else
+				cookieSession = rexCookieSession.stringMatched(1);
 			//Vm.debug(cookieSession);
 		}
 		boolean loginAborted=infB.isClosed;
@@ -159,17 +183,14 @@
 	public boolean spiderSingle(int number, InfoBox infB){
 		boolean ret=false;
 		this.infB = infB;
-		if (p==null) {
-			(new MessageBox(MyLocale.getMsg(5500,"Error"), "Could not load 'spider.def'", MessageBox.OKB)).execute();
-			return false;
-		}
+		if (!existsSpiderDef()) return false;
 		CacheHolder ch = (CacheHolder)cacheDB.get(number);
 		if (ch.isAddiWpt()) return false;  // No point re-spidering an addi waypoint, comes with parent
 
 		// check if we need to login
 		if (!loggedIn){
-			if (this.login()==Form.IDOK) loggedIn = true;
-			else return false;
+			if (this.login()!=Form.IDOK) return false;
+			// loggedIn is already set by this.login()
 		}
 		CacheHolderDetail chD=new CacheHolderDetail(ch);
 		try{
@@ -202,17 +223,16 @@
 		String completeWebPage;
 		InfoBox infB = new InfoBox("Info", "Loading", InfoBox.PROGRESS_WITH_WARNINGS);
 		infB.exec();
-		if (p==null) {
-			infB.close(0);
-			(new MessageBox(MyLocale.getMsg(5500,"Error"), "Could not load 'spider.def'", MessageBox.OKB)).execute();
-			return "";
-		}
+		// Check whether spider definitions could be loaded, if not issue appropriate message and terminate
+		if (!existsSpiderDef()) return "";
+		// Try to login. If login fails, issue appropriate message and terminate
 		if (login()!=Form.IDOK) return "";
-		String doc = "http://www.geocaching.com/seek/cache_details.aspx?wp=" + wayPoint;
+		String doc = p.getProperty("waypoint") + wayPoint;
 		try{
 			pref.log("Fetching: " + wayPoint);
 			completeWebPage = fetch(doc);
 		}catch(Exception ex){
+			infB.close(0);
 			pref.log("Could not fetch " + wayPoint,ex);
 			return "";
 		}
@@ -227,13 +247,10 @@
 		String postStr, dummy, ln, wpt;
 		Regex lineRex;
 		CacheHolderDetail chD;
-		if (p==null) {
-			(new MessageBox(MyLocale.getMsg(5500,"Error"), "Could not load 'spider.def'", MessageBox.OKB)).execute();
-			return;
-		}
+		if (!existsSpiderDef()) return;
 		CWPoint origin = pref.curCentrePt; // No need to copy curCentrePt as it is only read and not written
 		if (!origin.isValid()) {
-			(new MessageBox("Error", "Coordinates for center must be set", MessageBox.OKB)).execute();
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5509,"Coordinates for center must be set"), MessageBox.OKB)).execute();
 			return;
 		}
 		// Prepare an index of caches for faster searching
@@ -249,15 +266,9 @@
 		Regex rex = new Regex("name=\"__VIEWSTATE\" value=\"(.*)\" />");
 		String doc = "";
 		
-		int ok = login();
-		if(ok == Form.IDCANCEL) {
-			return;
-		}
-		if(ok == ERR_LOGIN){
-			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed!"), MessageBox.OKB)).execute();
-			return;
-		}
-		OCXMLImporterScreen options = new OCXMLImporterScreen("Spider Options",	OCXMLImporterScreen.INCLUDEFOUND | OCXMLImporterScreen.DIST| OCXMLImporterScreen.IMAGES);
+		if(login() != Form.IDOK) return;
+	
+		OCXMLImporterScreen options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"),	OCXMLImporterScreen.INCLUDEFOUND | OCXMLImporterScreen.DIST| OCXMLImporterScreen.IMAGES);
 		options.distanceInput.setText("");
 		if (options.execute() == OCXMLImporterScreen.IDCANCEL) {return; }
 		String dist = options.distanceInput.getText();
@@ -281,10 +292,10 @@
 			start = fetch(ln);
 			pref.log("Got first page");
 		}catch(Exception ex){
+			pref.log("Error fetching first list page",ex,true);
+			Vm.showWait(false);
 			infB.close(0);
 			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5503,"Error fetching first list page."), MessageBox.OKB)).execute();
-			pref.log("Error fetching first list page",ex);
-			Vm.showWait(false);
 			return;
 		}
 		dummy = "";
@@ -314,7 +325,7 @@
 				} else distance = 0;
 				lineRex.searchFrom(dummy, lineRex.matchedTo());
 			}
-			infB.setInfo("Found " + cachesToLoad.size() + " caches");
+			infB.setInfo(MyLocale.getMsg(5511,"Found ") + cachesToLoad.size() + MyLocale.getMsg(5512," caches"));
 			if(found_on_page < 20) distance = 0;
 			postStr = p.getProperty("firstLine") + origin.getLatDeg(CWPoint.DD) + "&" + origin.getLonDeg(CWPoint.DD);
 			if(doNotgetFound) postStr = postStr + p.getProperty("showOnlyFound");
@@ -340,7 +351,8 @@
 		}
 		
 		pref.log("Found " + cachesToLoad.size() + " caches");
-		if (!infB.isClosed) infB.setInfo("Found " + cachesToLoad.size() + " caches");
+		if (!infB.isClosed) infB.setInfo(MyLocale.getMsg(5511,"Found ") + cachesToLoad.size() + MyLocale.getMsg(5512," caches"));
+
 		//=======
 		// Now ready to spider each cache in the list
 		//=======
@@ -350,7 +362,7 @@
 			wpt = (String)cachesToLoad.get(i);
 			// Get only caches not already available in the DB
 			if(searchWpt(wpt) == -1){
-				infB.setInfo("Loading: " + wpt +"(" + (i+1) + " / " + cachesToLoad.size() + ")");
+				infB.setInfo(MyLocale.getMsg(5513,"Loading: ") + wpt +"(" + (i+1) + " / " + cachesToLoad.size() + ")");
 				chD = new CacheHolderDetail();
 				chD.wayPoint=wpt;
 				if (!getCacheByWaypointName(chD,false,getImages,doNotgetFound,true)) break;
@@ -389,7 +401,7 @@
 		}catch(Exception ex){
 			pref.log("Could not fetch " + chD.wayPoint,ex);
 			chD.is_incomplete = true;
-			return !infB.isClosed;
+			return !infB.isClosed; // Only return false (which terminates the loop over all caches) if infB is closed
 		}
 		// Only analyse the cache data and fetch pictures if user has not closed the progress window
 		if (!infB.isClosed) { 
@@ -488,8 +500,8 @@
 				// Bugs
 				//==========
 				// As there may be several bugs, we check whether the user has aborted
-				if (!infB.isClosed) chD.Bugs = getBugs(completeWebPage);
-				chD.has_bug = chD.Bugs.length()>0;
+				if (!infB.isClosed) getBugs(chD,completeWebPage);
+				chD.has_bug = chD.Travelbugs.size()>0;
 				
 				//==========
 				// Images
@@ -560,6 +572,7 @@
 	private String getWP(String doc){
 		inRex = new Regex(p.getProperty("waypointRex"));
 		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
 	
@@ -571,7 +584,7 @@
 	private String getLatLon(String doc){
 		inRex = new Regex(p.getProperty("latLonRex"));
 		inRex.search(doc);
-		if (!inRex.didMatch()) return "";
+		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
 	
@@ -599,6 +612,7 @@
 	private String getName(String doc){
 		inRex = new Regex(p.getProperty("cacheNameRex"));
 		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
 	
@@ -610,6 +624,7 @@
 	private String getOwner(String doc){
 		inRex = new Regex(p.getProperty("cacheOwnerRex"));
 		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
 	
@@ -621,6 +636,7 @@
 	private String getDateHidden(String doc){
 		inRex = new Regex(p.getProperty("dateHiddenRex"));
 		inRex.search(doc);
+		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
 	
@@ -632,6 +648,7 @@
 	private String getHints(String doc){
 		inRex = new Regex(p.getProperty("hintsRex"));
 		inRex.search(doc);
+		if (!inRex.didMatch()) return "";
 		return inRex.stringMatched(1);
 	}
 	
@@ -723,11 +740,11 @@
 		//Vm.debug("Log Block: " + singleLog);
 		int nLogs=0;
 		while(exSingleLog.endOfSearch() == false){
-			nLogs++;
-			if (nLogs>MAXLOGS) {
+			if (nLogs>=MAXLOGS) {
 				reslts.add("<br\\>More than "+MAXLOGS+" logs.<br\\>");
 				break;
 			}
+			nLogs++;
 			//Vm.debug("--------------------------------------------");
 			//Vm.debug("Log Block: " + singleLog);
 			//Vm.debug("Icon: "+exIcon.findNext());
@@ -762,14 +779,14 @@
 	 * @param doc The previously fetched cachepage
 	 * @return A HTML formatted string with bug names and there purpose
 	 */
-	public String getBugs(String doc){	
+	public void getBugs(CacheHolderDetail chD, String doc){	
 		Extractor exBlock = new Extractor(doc,p.getProperty("blockExStart"),p.getProperty("blockExEnd") ,0,Extractor.EXCLUDESTARTEND);
 		String bugBlock = exBlock.findNext();
 		//Vm.debug("Bugblock: "+bugBlock);
 		Extractor exBug = new Extractor(bugBlock,p.getProperty("bugExStart"),p.getProperty("bugExEnd"),0,Extractor.EXCLUDESTARTEND);
 		String link,bug,linkPlusBug,bugDetails;
-		String result = "";
 		String oldInfoBox=infB.getInfo();
+		chD.Travelbugs.clear();
 		while(exBug.endOfSearch() == false){
 			if (infB.isClosed) break; // Allow user to cancel by closing progress form
 			linkPlusBug= exBug.findNext();
@@ -778,23 +795,24 @@
 			link=linkPlusBug.substring(0,idx);
 			bug=linkPlusBug.substring(idx+2);
 			if(bug.length()>0) { // Found a bug, get its details
-				result = result + "<b>Name:</b> "+ bug + "<br>";
+				Travelbug tb=new Travelbug(bug);
 				try{
-					infB.setInfo(oldInfoBox+"\nGetting bug: "+bug);
+					infB.setInfo(oldInfoBox+MyLocale.getMsg(5514,"\nGetting bug: ")+bug);
 					pref.log("Fetching bug details: "+bug);
 					bugDetails = fetch(link);
+					Extractor exDetails = new Extractor(bugDetails,p.getProperty("bugDetailsStart"),p.getProperty("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
+					tb.setMission(exDetails.findNext());
+					Extractor exGuid = new Extractor(bugDetails,"details.aspx?guid=","\" id=\"Form1",0,Extractor.EXCLUDESTARTEND); // TODO Replace with spider.def see also further down
+					tb.setGuid(exGuid.findNext());
+					chD.Travelbugs.add(tb);
 				}catch(Exception ex){
 					pref.log("Could not fetch bug details");
-					bugDetails="";
 				}
-				Extractor exDetails = new Extractor(bugDetails,p.getProperty("bugDetailsStart"),p.getProperty("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
-				result+=exDetails.findNext()+"<hr>";
 			}
 			//Vm.debug("B: " + bug);
 			//Vm.debug("End? " + exBug.endOfSearch());
 		}
 		infB.setInfo(oldInfoBox);
-		return result;
 	}
 	
 	/**
@@ -1010,7 +1028,7 @@
 	public static String fetch(String address)
 	   	{	
 			CharArray c_data;
-			String data = new String();
+			String data="";
 			try{
 				//Vm.debug(address);
 				HttpConnection conn;
@@ -1101,7 +1119,7 @@
 					conn.setPostData(codec.encodeText(document.toCharArray(),0,document.length(),true,null));
 					conn.setRequestorProperty("Content-Type", "application/x-www-form-urlencoded");
 					if(cookieSession.length()>0){
-						conn.setRequestorProperty("Cookie: ", "ASP.NET_SessionId="+cookieSession+"; userid="+cookieID);
+						if (cookieSession!=null) conn.setRequestorProperty("Cookie: ", "ASP.NET_SessionId="+cookieSession+"; userid="+cookieID);
 					}
 					conn.setRequestorProperty("Connection", "close");
 					Socket sock = conn.connect();
@@ -1175,6 +1193,67 @@
 		}
 		return new String(dest,0,d);
 	}
+	
+	/**
+	 * Load the bug id for a given name. This method is not ideal, as there are
+	 * sometimes several bugs with identical names but different IDs. Normally
+	 * the bug GUID is used which can be obtained from the cache page.<br>
+	 * Note that each bug has both an ID and a GUID.
+	 * @param name The name (or partial name) of a travelbug
+	 * @return the id of the bug
+	 */
+	public String getBugId(String name) {
+		String bugList;
+		if (!existsSpiderDef()) return "";
+		try{
+			//infB.setInfo(oldInfoBox+"\nGetting bug: "+bug);
+			pref.log("Fetching bugId: "+name);
+			bugList = fetch(p.getProperty("getBugByName")+STRreplace.replace(SafeXML.clean(name)," ","+"));
+		}catch(Exception ex){
+			pref.log("Could not fetch bug list");
+			bugList="";
+		}
+		if (bugList.equals("") || bugList.indexOf(p.getProperty("bugNotFound"))>=0) {
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), MessageBox.OKB)).execute();
+			return "";
+		}
+		if (bugList.indexOf(p.getProperty("bugTotalRecords"))<0) {
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6021,"More than one travelbug found. Specify name more precisely."), MessageBox.OKB)).execute();
+			return "";
+		}
+		Extractor exGuid = new Extractor(bugList,p.getProperty("bugGuidExStart"),p.getProperty("bugGuidExEnd"),0,Extractor.EXCLUDESTARTEND); // TODO Replace with spider.def
+		return exGuid.findNext();
+	}
 
+	/**
+	 * Fetch a bug's mission for a given GUID or ID. If the guid String is longer 
+	 * than 10 characters it is assumed to be a GUID, otherwise it is an ID.
+	 * @param guid the guid or id of the travelbug
+	 * @return The mission
+	 */
+	public String getBugMissionByGuid(String guid) {
+		String bugDetails;
+		if (!existsSpiderDef()) return "";
+		try{
+			//infB.setInfo(oldInfoBox+"\nGetting bug: "+bug);
+			pref.log("Fetching bug detailsById: "+guid);
+			if (guid.length()>10)
+				bugDetails = fetch(p.getProperty("getBugByGuid")+guid);
+			else
+				bugDetails = fetch(p.getProperty("getBugById")+guid);
+		}catch(Exception ex){
+			pref.log("Could not fetch bug details");
+			bugDetails="";
+		}
+		if (bugDetails.indexOf(p.getProperty("bugNotFound"))>=0) {
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(6020,"Travelbug not found."), MessageBox.OKB)).execute();
+			return "";
+		}
+		Extractor exDetails = new Extractor(bugDetails,p.getProperty("bugDetailsStart"),p.getProperty("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
+		return exDetails.findNext();
+	}
 
+
+
+
 }
\ No newline at end of file



From salzkammergut at mail.berlios.de  Sun Aug 26 14:22:09 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 26 Aug 2007 14:22:09 +0200
Subject: [Cachewolf-svn] r833 - trunk/src/CacheWolf
Message-ID: <200708261222.l7QCM9M8005812@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-26 14:22:01 +0200 (Sun, 26 Aug 2007)
New Revision: 833

Modified:
   trunk/src/CacheWolf/CacheHolderDetail.java
   trunk/src/CacheWolf/Common.java
   trunk/src/CacheWolf/DetailsPanel.java
   trunk/src/CacheWolf/GPXImporter.java
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/ShowCacheInBrowser.java
Log:
Feature: Travelbugverwaltung

Travelbugs koennen ueber das Hauptmenue (Verwalten->Travelbugs verwalten) oder DetailsPanel (Travelbugs)
verwaltet werden. In beiden Faellen gibt es Kontextmenues, die das Entnehmen aus dem Cache, das Ablegen 
im Cache usw. ermoeglichen. Die ueber das Hauptmenue zugaengliche Listenansicht kann auch Sortieren nach
beliebigen Spalten, Markieren (und Loeschen) von mehreren Zeilen mit Shift-Click. Die in der Listenansicht
dargestellten Spalten koennen ueber die Praeferenzen beliebig konfiguriert werden. Travelbugs, die noch bei
GC geloggt werden muessen, werden farbig hervorgehoben.

Die Speicherung von Travelbugs in CacheHolderDetail wurde von HTML auf eine TravelbugList Datenstruktur umgestellt,
damit auch die Travelbug-ID gespeichert wird um eine eindeutige Identifikation von TBs zu ermoeglichen.
 
Da es sich um eine groessere Aenderung handelt bitte um Feedback.


Modified: trunk/src/CacheWolf/CacheHolderDetail.java
===================================================================
--- trunk/src/CacheWolf/CacheHolderDetail.java	2007-08-26 11:16:50 UTC (rev 832)
+++ trunk/src/CacheWolf/CacheHolderDetail.java	2007-08-26 12:22:01 UTC (rev 833)
@@ -25,7 +25,8 @@
 	  public Vector UserImagesText = new Vector();
 	  public Attributes attributes=new Attributes();
 	  public Vector CacheIcons = new Vector();
-	  public String Bugs = EMPTY;
+	  public TravelbugList Travelbugs=new TravelbugList();
+	  //public String Bugs = EMPTY; Superceded by Travelbugs
 	  public String URL = EMPTY;
 	  public String Solver = EMPTY;
 	  
@@ -69,7 +70,7 @@
 		  
 		  //travelbugs: overriding is OK, since GPX-File contains all actual travelbugs
 		  this.has_bug = newCh.has_bug;
-		  this.Bugs = newCh.Bugs;
+		  this.Travelbugs = newCh.Travelbugs;
 		  
 		  // URL
 		  this.URL = newCh.URL;
@@ -282,9 +283,14 @@
 				dummy = ex.findNext();
 			}
 
-
-			ex = new Extractor(text, "<BUGS><![CDATA[", "]]></BUGS>", 0, true);
-			Bugs = ex.findNext();
+			ex = new Extractor(text, "<TRAVELBUGS>", "</TRAVELBUGS>", 0, false);
+			dummy=ex.findNext();
+			if (ex.endOfSearch()) {
+				ex = new Extractor(text, "<BUGS><![CDATA[", "]]></BUGS>", 0, true);
+				String Bugs = ex.findNext();
+				Travelbugs.addFromHTML(Bugs);
+			} else
+				Travelbugs.addFromXML(dummy);
 			
 			ex = new Extractor(text, "<URL><![CDATA[", "]]></URL>", 0, true);
 			// if no URL is stored, set default URL (at this time only possible for gc.com)
@@ -374,9 +380,10 @@
 
 
 				  detfile.print("</IMAGES>\n");
-				  detfile.print("<BUGS><![CDATA[\n");
-				  detfile.print(Bugs+"\n");
-				  detfile.print("]]></BUGS>\n");
+				  //detfile.print("<BUGS><![CDATA[\n");
+				  //detfile.print(Bugs+"\n");
+				  //detfile.print("]]></BUGS>\n");
+				  detfile.print(Travelbugs.toXML());
 				  detfile.print("<URL><![CDATA["+URL+"]]></URL>\r\n");
 				  detfile.print("<SOLVER><![CDATA["+Solver+"]]></SOLVER>\r\n");
 				  detfile.print("</CACHEDETAILS>\n");

Modified: trunk/src/CacheWolf/Common.java
===================================================================
--- trunk/src/CacheWolf/Common.java	2007-08-26 11:16:50 UTC (rev 832)
+++ trunk/src/CacheWolf/Common.java	2007-08-26 12:22:01 UTC (rev 833)
@@ -42,6 +42,15 @@
 			return 0.0;
 		}
 	}
+	
+	public static int parseInt(String value){
+		try {
+			return java.lang.Integer.parseInt(value);
+		} catch (Exception e) {
+			return 0;
+		}
+	}
+
 	public static String rot13 (String text) {
 		String dummy = new String();
 		for(int i = 0; i < text.length(); i++){

Modified: trunk/src/CacheWolf/DetailsPanel.java
===================================================================
--- trunk/src/CacheWolf/DetailsPanel.java	2007-08-26 11:16:50 UTC (rev 832)
+++ trunk/src/CacheWolf/DetailsPanel.java	2007-08-26 12:22:01 UTC (rev 833)
@@ -62,7 +62,7 @@
 		imgShowBug = new mImage("bug.gif");
 		imgShowBugNo = new mImage("bug_no.gif");
 		pnlTools.addNext(btnShowBug = new mButton(imgShowBugNo)); 
-		btnShowBug.modify(Control.Disabled,0);
+		//btnShowBug.modify(Control.Disabled,0);
 		btnShowBug.setToolTip(MyLocale.getMsg(346,"Show travelbugs"));
 		// Button 4: Show Map
 		pnlTools.addNext(btnShowMap = new mButton(imgShowMaps = new mImage("globe_small.gif"))); 
@@ -175,10 +175,10 @@
 		blackStatusChanged=false;
 		btnBlack.repaintNow();
 		if(chD.has_bug == true) {
-			btnShowBug.modify(Control.Disabled,1);
+			//btnShowBug.modify(Control.Disabled,1);
 			btnShowBug.image = imgShowBug;
 		} else {
-			btnShowBug.modify(Control.Disabled,0);
+			//btnShowBug.modify(Control.Disabled,0);
 			btnShowBug.image = imgShowBugNo;
 		}
 		btnShowBug.repaintNow();
@@ -303,8 +303,10 @@
 				}
 	*/		}
 			else if(ev.target == btnShowBug){
-				InfoScreen is = new InfoScreen(thisCache.Bugs, "Travelbugs", false, pref);
-				is.execute();
+				//InfoScreen is = new InfoScreen(thisCache.Travelbugs.toHtml(), "Travelbugs", false, pref);
+				//is.execute();
+				TravelbugInCacheScreen ts = new TravelbugInCacheScreen(thisCache.Travelbugs.toHtml(), "Travelbugs");
+				ts.execute(this.getFrame(), Gui.CENTER_FRAME);
 			}
 			else if (ev.target == btnCenter){
 				CWPoint cp=new CWPoint(thisCache.LatLon);
@@ -458,6 +460,7 @@
 		  ch.LatLon=thisCache.LatLon;
 		  ch.DateHidden=thisCache.DateHidden;
 		  ch.CacheOwner=thisCache.CacheOwner;
+		  ch.has_bug=thisCache.has_bug;
 		  String oldType=ch.type;
 		  ch.type=thisCache.type;
 		  // If the type has changed from/to an addi waypoint, rebuild the references
@@ -485,4 +488,88 @@
 		  Global.mainTab.tbP.refreshTable();
 		  ////Vm.debug("New status updated!");
 	}
+
+	private class TravelbugInCacheScreen extends Form {
+		
+		private DispPanel disp = new DispPanel();
+		private mButton btCancel;
+		private TravelbugJourneyList tbjList;
+		
+		TravelbugInCacheScreen(String text, String title) {
+			this.setTitle(title);
+			this.setPreferredSize(pref.myAppWidth, pref.myAppHeight);
+			disp.setHtml(text);
+			ScrollBarPanel sbp = new ScrollBarPanel(disp, ScrollBarPanel.NeverShowHorizontalScrollers);
+			this.addLast(sbp);
+			this.addLast(btCancel = new mButton(MyLocale.getMsg(3000,"Close")),CellConstants.DONTSTRETCH, CellConstants.FILL);
+		}
+
+		public void onEvent(Event ev){
+			if(ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED){
+				if (ev.target == btCancel){
+					this.close(0);
+				}
+			}
+		}
+
+		// Subclassed HtmlDisplay with Pop-up menu
+		private class DispPanel extends HtmlDisplay {
+			MenuItem mnuPickupTB, mnuDropTB;
+			MenuItem[] TBMenuItems=new MenuItem[2];
+			Menu mnuPopup;
+			DispPanel() {
+				TBMenuItems[0]= mnuPickupTB = new MenuItem(MyLocale.getMsg(6016,"Pick up Travelbug"));
+				TBMenuItems[1]= mnuDropTB = new MenuItem(MyLocale.getMsg(6017,"Drop Travelbug"));
+				mnuPopup=new Menu(TBMenuItems,"");
+			} 
+			public void penRightReleased(Point p){
+				setMenu(mnuPopup);
+				doShowMenu(p); // direct call (not through doMenu) is neccesary because it will exclude the whole table
+			}
+			public void penHeld(Point p){
+				setMenu(mnuPopup);
+				doShowMenu(p);
+			}
+			public void popupMenuEvent(Object selectedItem){
+				if (selectedItem==mnuPickupTB) { 
+					Travelbug tb=TravelbugPickup.pickupTravelbug(thisCache.Travelbugs);	
+					if (tb!=null) {
+						dirty_details=true;
+						// Get the list of my travelbugs
+						tbjList=new TravelbugJourneyList();
+						tbjList.readTravelbugsFile();
+						// Add the tb to this list
+						tbjList.addTbPickup(tb,Global.getProfile().name,thisCache.wayPoint);
+						tbjList.saveTravelbugsFile();
+						tbjList=null;
+						setHtml(thisCache.Travelbugs.toHtml());
+						repaint();
+						thisCache.has_bug=thisCache.Travelbugs.size()>0;						
+					}
+				} else if (selectedItem==mnuDropTB) {
+					tbjList=new TravelbugJourneyList();
+					tbjList.readTravelbugsFile();
+					TravelbugList tbl=tbjList.getMyTravelbugs();
+					TravelbugScreen tbs=new TravelbugScreen(tbl,MyLocale.getMsg(6017,"Drop a travelbug"),false);
+					tbs.execute();
+					if (tbs.selectedItem>=0) {
+						Travelbug tb=tbl.getTB(tbs.selectedItem);
+						thisCache.Travelbugs.add(tb);
+						tbjList.addTbDrop(tb,Global.getProfile().name,thisCache.wayPoint);
+					}
+					tbjList.saveTravelbugsFile();
+					tbjList=null;
+					thisCache.has_bug=thisCache.Travelbugs.size()>0;
+					setHtml(thisCache.Travelbugs.toHtml());
+					repaint();
+					dirty_details=true;
+				} else 
+					super.popupMenuEvent(selectedItem);
+			}
+		}
+
+	
+	}
+
+
 }

Modified: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2007-08-26 11:16:50 UTC (rev 832)
+++ trunk/src/CacheWolf/GPXImporter.java	2007-08-26 12:22:01 UTC (rev 833)
@@ -358,7 +358,9 @@
 		}
 
 		if (name.equals("groundspeak:name")&& inBug) {
-			holder.Bugs += "<b>Name:</b> " + strData + "<br><hr>";
+			Travelbug tb=new Travelbug(strData);
+			holder.Travelbugs.add(tb);
+			//holder.Bugs += "<b>Name:</b> " + strData + "<br><hr>";
 			holder.has_bug = true;
 			return;
 		}

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2007-08-26 11:16:50 UTC (rev 832)
+++ trunk/src/CacheWolf/MainMenu.java	2007-08-26 12:22:01 UTC (rev 833)
@@ -28,8 +28,8 @@
 	private MenuItem exportOZI, exportKML, exportTPL;
 	private MenuItem filtCreate, filtClear, filtInvert, filtSelected, filtBlack, filtApply;
 	private MenuItem exportGPS, exportCacheMate,mnuSeparator;
-	private MenuItem orgCopy, orgMove, orgDelete, orgTravelbugs;
-	public MenuItem orgCacheTour;
+	private MenuItem orgCopy, orgMove, orgDelete;
+	public MenuItem orgCacheTour,orgTravelbugs;
 	private MenuItem mnuNewProfile, mnuOpenProfile, mnuEditCenter;
 	private Form father;
 	private TablePanel tbp;
@@ -151,13 +151,14 @@
 		///////////////////////////////////////////////////////////////////////
 		// Create the "Organize" pulldown menu
 		///////////////////////////////////////////////////////////////////////
-		MenuItem[] organizeMenuItems=new MenuItem[6];
+		MenuItem[] organizeMenuItems=new MenuItem[7];
 		organizeMenuItems[0] = orgCopy  = new MenuItem(MyLocale.getMsg(141,"Copy")); 
 		organizeMenuItems[1] = orgMove  = new MenuItem(MyLocale.getMsg(142,"Move")); 
 		organizeMenuItems[2] = orgDelete   = new MenuItem(MyLocale.getMsg(143,"Delete"));
 		organizeMenuItems[3] = mnuSeparator;
 		organizeMenuItems[4] = orgCacheTour = new MenuItem(MyLocale.getMsg(198,"Cachetour"));
 		organizeMenuItems[5] = mnuSeparator;
+		organizeMenuItems[6] = orgTravelbugs = new MenuItem(MyLocale.getMsg(139,"Manage travelbugs"));
 		this.addMenu(new PullDownMenu(MyLocale.getMsg(140,"Organize"),new Menu(organizeMenuItems,null)));
 
 		///////////////////////////////////////////////////////////////////////
@@ -176,6 +177,16 @@
 		tbp = t;
 	}
 	
+	public void allowProfileChange(boolean profileChangeAllowed) {
+		if (profileChangeAllowed) {
+			mnuNewProfile.modifiers&=~MenuItem.Disabled;
+			mnuOpenProfile.modifiers&=~MenuItem.Disabled;
+		} else {
+			mnuNewProfile.modifiers|=MenuItem.Disabled;
+			mnuOpenProfile.modifiers|=MenuItem.Disabled;
+		}
+	}
+
 	public static void search() {
 		String srch = new InputBox(MyLocale.getMsg(119,"Search for:")).input("",10);
 		if (srch != null) {
@@ -499,6 +510,12 @@
 				orgCacheTour.modifiers^=MenuItem.Checked;
 				Global.mainForm.toggleCacheListVisible();			
 			}
+			if(mev.selectedItem == orgTravelbugs){
+				TravelbugJourneyScreen tbs=new TravelbugJourneyScreen();
+				tbs.setPreferredSize(800,600);
+				tbs.execute(); //getFrame(), Gui.CENTER_FRAME);
+				tbs.close(0);
+			}
 			///////////////////////////////////////////////////////////////////////
 			// "About" pulldown menu
 			///////////////////////////////////////////////////////////////////////

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-08-26 11:16:50 UTC (rev 832)
+++ trunk/src/CacheWolf/Preferences.java	2007-08-26 12:22:01 UTC (rev 833)
@@ -1,5 +1,5 @@
 package CacheWolf;
-
+//TODO Option to generate backup when saving index.xml
 import utils.FileBugfix;
 import ewe.io.*;
 import ewe.sys.*;
@@ -18,7 +18,7 @@
 public class Preferences extends MinML{
 
 	public int tablePrefs[] = {1,1,1,1,1,1,1,1,1,1,1,1};
-	public int tableWidth[] = {20,20,20,20,65,135,135,100,60,50,50,50};
+	public int tableWidth[] = {20,20,20,25,92,177,144,83,60,105,50,104,50};
 
 	static protected final int PROFILE_SELECTOR_FORCED_ON=0;
 	static protected final int PROFILE_SELECTOR_FORCED_OFF=1;
@@ -69,13 +69,22 @@
 	public boolean downloadmissingOC = false;
 	public boolean fixSIP = false;
 
-	public String digSeparator = new String();
+	public String digSeparator = "";
 	public boolean debug = false;
 	public SerialPortOptions mySPO = new SerialPortOptions();
 	public boolean forwardGPS = false;
-	public String forwardGpsHost = new String();
+	public String forwardGpsHost = "";
 	public int fontSize = 12;
-
+	
+	public String listColMap="0,1,2,3,4,5,6,7,8,9,10,11";
+	public String listColWidth="15,20,20,25,92,177,144,83,60,105,50,104";
+	/** The columns which are to be displayed in TravelbugsJourneyScreen. See also TravelbugJourney */
+	public String travelbugColMap="1,4,5,6,8,9,10,7";
+	/** The column widths for the travelbug journeys. */
+	public String travelbugColWidth="212,136,62,90,50,56,90,38,50,50,94,50";
+	/** If this flag is true, only non-logged travelbug journeys will be shown */
+	public boolean travelbugShowOnlyNonLogged=false;
+	
 	public String mapsPath = "maps/standard";
 	// Helper variables for XML parser 
 	private StringBuffer collectElement=null; 
@@ -428,6 +437,11 @@
 		if (name.equals("expPath")){
 			exporterPaths.put(atts.getValue("key"),atts.getValue("value"));
 		}
+		if (name.equals("travelbugs")) {
+			travelbugColMap=atts.getValue("colmap");
+			travelbugColWidth=atts.getValue("colwidths");	
+			travelbugShowOnlyNonLogged=Boolean.valueOf(atts.getValue("shownonlogged")).booleanValue();
+		}
 	}
 
 	public void characters( char ch[], int start, int length )
@@ -507,6 +521,7 @@
 				entry = (MapEntry) itPath.next();
 				outp.print("    <expPath key = \"" + entry.getKey().toString() + "\" value = \"" + entry.getValue().toString().replace('\\', '/') + "\"/>\n");
 			}
+			outp.print("  <travelbugs colmap=\""+travelbugColMap+"\" colwidths=\""+travelbugColWidth+"\" shownonlogged=\""+travelbugShowOnlyNonLogged+"\" />\n");
 			outp.print("</preferences>");
 			outp.close();
 		} catch (Exception e) {

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-08-26 11:16:50 UTC (rev 832)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-08-26 12:22:01 UTC (rev 833)
@@ -21,19 +21,21 @@
 	mTabbedPanel mTab;
 	mChoice chcGarminPort;
 	mLabel lblGarmin;
+	TableColumnChooser tccBugs,tccList;
 	
 	Preferences pref;
 	
 	CellPanel pnlGeneral = new CellPanel();
 	CellPanel pnlDisplay = new CellPanel();
 	CellPanel pnlMore = new CellPanel();
+	CellPanel pnlTB = new CellPanel();
 	Frame frmGarmin = new Frame();
 	ScrollBarPanel scp;
 	String [] garminPorts= new String[]{"com1","com2","com3","com4","com5","com6","com7","usb"};
 	
 	public PreferencesScreen (Preferences p){
 		mTab=new mTabbedPanel();
-		
+		setPreferredSize(240,240);
 		//scp = new ScrollBarPanel(pnlGeneral);
 		pref = p;
 		this.title = MyLocale.getMsg(600,"Preferences");
@@ -44,38 +46,40 @@
 		/////////////////////////////////////////////////////////
 		// First panel - General
 		/////////////////////////////////////////////////////////
-		pnlGeneral.addNext(new mLabel(MyLocale.getMsg(601,"Your Alias:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		pnlGeneral.addNext(new mLabel("Browser:"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		pnlGeneral.addLast(gpsB = new mButton("GPS"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		Frame frmDataDir=new Frame();
+		frmDataDir.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
+		frmDataDir.addNext(new mLabel(MyLocale.getMsg(603,"Data Directory:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		//frmDataDir.setTag(INSETS,new Insets(10,10,10,10));
+		frmDataDir.addLast(brwBt = new mButton(MyLocale.getMsg(604,"Browse")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.EAST));
+		DataDir = new mInput();
+		DataDir.setText(pref.baseDir);
+		frmDataDir.addLast(DataDir.setTag(Control.SPAN, new Dimension(3,1)),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.EAST));
+		frmDataDir.addLast(chkAutoLoad = new mCheckBox(MyLocale.getMsg(629,"Autoload last profile")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		if (pref.autoReloadLastProfile) chkAutoLoad.setState(true);
+		chkAutoLoad.setTag(INSETS,new Insets(0,0,2,0));
+		pnlGeneral.addLast(frmDataDir,HSTRETCH,HFILL);
+		
+		CellPanel pnlBrowser=new CellPanel();
+		pnlBrowser.setTag(INSETS,new Insets(2,0,0,0));
+		pnlBrowser.addNext(new mLabel("Browser:"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		Browser = new mInput();
+		Browser.setText(pref.browser);
+		pnlBrowser.addLast(Browser,CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
 
+		pnlBrowser.addNext(new mLabel(MyLocale.getMsg(601,"Your Alias:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		Alias = new mInput();
-		Browser = new mInput();
 		Alias.setText(pref.myAlias);
-		Browser.setText(pref.browser);
-		pnlGeneral.addNext(Alias,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		pnlBrowser.addNext(Alias,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		pnlBrowser.addLast(new mLabel("")).setTag(SPAN,new Dimension(2,1));
+		
+		pnlGeneral.addLast(pnlBrowser,HSTRETCH,HFILL);
+		
+		pnlGeneral.addNext(gpsB = new mButton("GPS"),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
 		//content.addNext(Alias.setTag(Control.SPAN, new Dimension(3,1)),content.DONTSTRETCH, (content.HFILL|content.WEST));
-		pnlGeneral.addNext(Browser,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		pnlGeneral.addLast(inpGPS=new mInput(""));
 		inpGPS.modify(ControlConstants.Disabled|ControlConstants.NoFocus,0);
 		inpGPS.setText(pref.mySPO.portName+"/"+pref.mySPO.baudRate);
 		
-		pnlGeneral.addNext(new mLabel(MyLocale.getMsg(603,"Data Directory:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		pnlGeneral.addLast(brwBt = new mButton(MyLocale.getMsg(604,"Browse")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.EAST));
-		DataDir = new mInput();
-		DataDir.setText(pref.baseDir);
-		pnlGeneral.addLast(DataDir.setTag(Control.SPAN, new Dimension(3,1)),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.EAST));
-		pnlGeneral.addLast(chkAutoLoad = new mCheckBox(MyLocale.getMsg(629,"Autoload last profile")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if (pref.autoReloadLastProfile) chkAutoLoad.setState(true);
-			
-		pnlGeneral.addNext(new mLabel("Proxy"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		pnlGeneral.addNext(new mLabel("Port"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		pnlGeneral.addLast(new mLabel("Font"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		pnlGeneral.addNext(Proxy = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
-		Proxy.setText(pref.myproxy);
-		pnlGeneral.addNext(ProxyPort = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
-		pnlGeneral.addLast(fontSize = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
-		ProxyPort.setText(pref.myproxyport);
-		fontSize.setText(Convert.toString(pref.fontSize));
 		// Garmin and GPSBabel
 		frmGarmin.addNext(lblGarmin=new mLabel(MyLocale.getMsg(173,"Garmin:  PC Port:")),DONTSTRETCH,LEFT);
 		lblGarmin.setTag(INSETS,new Insets(4,0,0,0));
@@ -93,6 +97,72 @@
 		/////////////////////////////////////////////////////////
 		// Second panel - Screen
 		/////////////////////////////////////////////////////////
+		
+/*		CellPanel pnlFont=new CellPanel();
+		pnlFont.addNext(new mLabel("Font"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		pnlFont.addLast(fontSize = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
+		fontSize.setText(Convert.toString(pref.fontSize));
+		pnlDisplay.addLast(pnlFont);
+*/		
+		Frame frmScreen=new Frame();
+		frmScreen.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER;
+		mLabel lblTitle;
+		CellPanel pnlScreen=new CellPanel();
+		pnlScreen.addNext(lblTitle=new mLabel(MyLocale.getMsg(625,"Screen (needs restart):")));
+		pnlScreen.addNext(new mLabel("Font"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		pnlScreen.addLast(fontSize = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
+		fontSize.maxLength=2;
+		fontSize.setPreferredSize(40,-1);
+		frmScreen.addLast(pnlScreen,HSTRETCH,HFILL);
+		fontSize.setText(Convert.toString(pref.fontSize));
+		
+		frmScreen.addLast(chkHasCloseButton=new mCheckBox(MyLocale.getMsg(631,"PDA has close Button")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));	
+    	//lblTitle.setTag(INSETS,new Insets(2,0,0,0));
+        chkHasCloseButton.setState(pref.hasCloseButton);
+		frmScreen.addNext(chkMenuAtTop = new mCheckBox(MyLocale.getMsg(626,"Menu top")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		chkMenuAtTop.setTag(INSETS,new Insets(0,0,2,0));
+		chkMenuAtTop.setState(pref.menuAtTop);
+		frmScreen.addNext(chkTabsAtTop = new mCheckBox(MyLocale.getMsg(627,"Tabs top")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		chkTabsAtTop.setState(pref.tabsAtTop);
+		chkTabsAtTop.setTag(INSETS,new Insets(0,0,2,0));
+		frmScreen.addLast(chkShowStatus = new mCheckBox(MyLocale.getMsg(628,"Status")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		chkShowStatus.setState(pref.showStatus);
+		chkShowStatus.setTag(INSETS,new Insets(0,0,2,0));
+		pnlDisplay.addLast(frmScreen,CellConstants.HSTRETCH,CellConstants.FILL);
+		
+		Frame frmImages=new Frame();
+		frmImages.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_TOP|CellPanel.BF_BOTTOM;
+		frmImages.addNext(new mLabel(MyLocale.getMsg(623,"Images:")),CellConstants.VSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		frmImages.addLast(chkShowDeletedImg = new mCheckBox(MyLocale.getMsg(624,"Show deleted images")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.EAST));
+		chkShowDeletedImg.setTag(INSETS,new Insets(0,0,2,0));
+		if (pref.showDeletedImages) chkShowDeletedImg.setState(true);
+		pnlDisplay.addLast(frmImages,CellConstants.STRETCH,CellConstants.FILL);
+
+		Frame frmHintLog=new Frame();
+		frmHintLog.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
+        mLabel lblHlP;
+		frmHintLog.addNext(lblHlP=new mLabel(MyLocale.getMsg(630,"HintLogPanel:  Logs per page ")));	
+		frmHintLog.addLast(inpLogsPerPage=new mInput(),CellConstants.DONTSTRETCH,CellConstants.DONTFILL|CellConstants.WEST);
+		inpLogsPerPage.setText(Convert.toString(pref.logsPerPage));
+		inpLogsPerPage.setPreferredSize(40,-1);
+		inpLogsPerPage.setTag(INSETS,new Insets(0,0,2,0));
+		lblHlP.setTag(INSETS,new Insets(6,0,2,0));
+		pnlDisplay.addLast(frmHintLog,CellConstants.STRETCH,CellConstants.FILL);
+
+		pnlDisplay.addLast(new mLabel(""));
+		/////////////////////////////////////////////////////////
+		// Third panel - More
+		/////////////////////////////////////////////////////////
+		CellPanel pnlProxy=new CellPanel();
+		pnlProxy.addNext(new mLabel("Proxy"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		pnlProxy.addLast(Proxy = new mInput(),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
+		Proxy.setText(pref.myproxy);
+		pnlProxy.addNext(new mLabel("Port"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		pnlProxy.addNext(ProxyPort = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		pnlProxy.addLast(new mLabel("")).setTag(SPAN,new Dimension(2,1));
+		pnlMore.addLast(pnlProxy,HSTRETCH,HFILL);
+		
+		ProxyPort.setText(pref.myproxyport);
 		Frame frmDisplay=new Frame();
 		frmDisplay.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
 		frmDisplay.addLast(new mLabel(MyLocale.getMsg(605,"Display Preferences")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
@@ -114,46 +184,35 @@
 		if(pref.tablePrefs[11] == 1) bear.setState(true);
 		dist.setTag(INSETS,new Insets(0,0,2,0));
 		bear.setTag(INSETS,new Insets(0,0,2,0));
-		pnlDisplay.addLast(frmDisplay,CellConstants.STRETCH,CellConstants.FILL);
-		
-		Frame frmImages=new Frame();
-		frmImages.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
-		frmImages.addNext(new mLabel(MyLocale.getMsg(623,"Images:")),CellConstants.VSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		frmImages.addLast(chkShowDeletedImg = new mCheckBox(MyLocale.getMsg(624,"Show deleted images")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.EAST));
-		chkShowDeletedImg.setTag(INSETS,new Insets(0,0,2,0));
-		if (pref.showDeletedImages) chkShowDeletedImg.setState(true);
-		pnlDisplay.addLast(frmImages,CellConstants.STRETCH,CellConstants.FILL);
-				
-		Frame frmScreen=new Frame();
-		frmScreen.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
-		frmScreen.addLast(new mLabel(MyLocale.getMsg(625,"Screen layout (needs restart):")));
-		frmScreen.addNext(chkMenuAtTop = new mCheckBox(MyLocale.getMsg(626,"Menu top")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		chkMenuAtTop.setTag(INSETS,new Insets(0,0,2,0));
-		chkMenuAtTop.setState(pref.menuAtTop);
-		frmScreen.addNext(chkTabsAtTop = new mCheckBox(MyLocale.getMsg(627,"Tabs top")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		chkTabsAtTop.setState(pref.tabsAtTop);
-		chkTabsAtTop.setTag(INSETS,new Insets(0,0,2,0));
-		frmScreen.addLast(chkShowStatus = new mCheckBox(MyLocale.getMsg(628,"Show status")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		chkShowStatus.setState(pref.showStatus);
-		chkShowStatus.setTag(INSETS,new Insets(0,0,2,0));
-		pnlDisplay.addLast(frmScreen,CellConstants.STRETCH,CellConstants.FILL);
-		
-		Frame frmHintLog=new Frame();
-		//frmHintLog.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
-        frmHintLog.addNext(new mLabel(MyLocale.getMsg(630,"HintLogPanel:  Logs per page ")));	
-		frmHintLog.addNext(inpLogsPerPage=new mInput(),CellConstants.DONTSTRETCH,CellConstants.DONTFILL|CellConstants.WEST);
-		inpLogsPerPage.setText(Convert.toString(pref.logsPerPage));
-		pnlDisplay.addLast(frmHintLog,CellConstants.STRETCH,CellConstants.FILL);
+		pnlMore.addLast(frmDisplay,CellConstants.STRETCH,CellConstants.FILL);
 
 		/////////////////////////////////////////////////////////
-		// Third panel - More
+		// Fourth panel - Travelbugs
 		/////////////////////////////////////////////////////////
-        pnlMore.addLast(chkHasCloseButton=new mCheckBox(MyLocale.getMsg(631,"PDA has close Button")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));	
-        chkHasCloseButton.setState(pref.hasCloseButton);
 
-		mTab.addCard(pnlGeneral,MyLocale.getMsg(621,"General"),null);
+		
+        mTab.addCard(pnlGeneral,MyLocale.getMsg(621,"General"),null);
 		mTab.addCard(pnlDisplay,MyLocale.getMsg(622,"Screen"),null);
 		mTab.addCard(pnlMore,MyLocale.getMsg(632,"More"),null);
+		/*mTab.addCard(tccList=new TableColumnChooser(new String[] {
+				"checkbox","type","difficulty","terrain",
+				"waypoint","name","coords","owner",
+				"date hidden","status","distance","bearing"},pref.listColMap),"List",null);
+		*/
+		Card c=mTab.addCard(tccBugs=new TableColumnChooser(new String[] {
+				MyLocale.getMsg(6000,"Guid"),
+				MyLocale.getMsg(6001,"Name"),
+				MyLocale.getMsg(6002,"track#"),
+				MyLocale.getMsg(6003,"Mission"),
+				MyLocale.getMsg(6004,"From Prof"),
+				MyLocale.getMsg(6005,"From Wpt"),
+				MyLocale.getMsg(6006,"From Date"),
+				MyLocale.getMsg(6007,"From Log"),
+				MyLocale.getMsg(6008,"To Prof"),
+				MyLocale.getMsg(6009,"To Wpt"),
+				MyLocale.getMsg(6010,"To Date"),
+				MyLocale.getMsg(6011,"To Log")},pref.travelbugColMap),"T-bugs",null);
+		//c.iconize(new Image("bug.gif"));
 		//this.addLast(scp.getScrollablePanel(), CellConstants.STRETCH, CellConstants.FILL);
 		
 		this.addLast(mTab);
@@ -204,6 +263,7 @@
 				pref.tabsAtTop=chkTabsAtTop.getState();
 				pref.showStatus=chkShowStatus.getState();
 				pref.hasCloseButton=chkHasCloseButton.getState();
+				pref.travelbugColMap=tccBugs.getSelectedCols();
 				pref.savePreferences();
 				pref.dirty = true; // Need to update table in case columns were enabled/disabled
 				this.close(0);

Modified: trunk/src/CacheWolf/ShowCacheInBrowser.java
===================================================================
--- trunk/src/CacheWolf/ShowCacheInBrowser.java	2007-08-26 11:16:50 UTC (rev 832)
+++ trunk/src/CacheWolf/ShowCacheInBrowser.java	2007-08-26 12:22:01 UTC (rev 833)
@@ -113,7 +113,7 @@
 					
 					tpl.setParam("DATE", chD.DateHidden);
 //					tpl.setParam("URL", ch.URL);
-					if (chD.Bugs!=null && chD.Bugs.trim().length()>0) tpl.setParam("BUGS",chD.Bugs);
+					if (chD.Travelbugs.size()>0) tpl.setParam("BUGS",chD.Travelbugs.toHtml());
 					if (chD.CacheNotes!=null && chD.CacheNotes.trim().length()>0) tpl.setParam("NOTES", STRreplace.replace(chD.CacheNotes,"\n","<br/>\n"));
 					if (chD.Solver!=null && chD.Solver.trim().length()>0) tpl.setParam("SOLVER", STRreplace.replace(chD.Solver,"\n","<br/>\n"));
 					// Look for images



From salzkammergut at mail.berlios.de  Sun Aug 26 14:43:56 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 26 Aug 2007 14:43:56 +0200
Subject: [Cachewolf-svn] r834 - trunk/src/CacheWolf
Message-ID: <200708261243.l7QChuF0006926@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-26 14:43:34 +0200 (Sun, 26 Aug 2007)
New Revision: 834

Added:
   trunk/src/CacheWolf/TableColumnChooser.java
   trunk/src/CacheWolf/Travelbug.java
   trunk/src/CacheWolf/TravelbugJourney.java
   trunk/src/CacheWolf/TravelbugJourneyList.java
   trunk/src/CacheWolf/TravelbugJourneyScreen.java
   trunk/src/CacheWolf/TravelbugList.java
   trunk/src/CacheWolf/TravelbugPickup.java
   trunk/src/CacheWolf/TravelbugScreen.java
Log:
Nachtrag zum vorherigen Commit. Aus mir unklaren Gruenden wurden diese Dateien nicht eingecheckt.

Added: trunk/src/CacheWolf/TableColumnChooser.java
===================================================================
--- trunk/src/CacheWolf/TableColumnChooser.java	2007-08-26 12:22:01 UTC (rev 833)
+++ trunk/src/CacheWolf/TableColumnChooser.java	2007-08-26 12:43:34 UTC (rev 834)
@@ -0,0 +1,204 @@
+package CacheWolf;
+
+import ewe.fx.*;
+import ewe.sys.Convert;
+import ewe.sys.VMApp;
+import ewe.sys.VMApps;
+import ewe.sys.Vm;
+import ewe.ui.*;
+import ewe.util.*;
+
+public class TableColumnChooser extends CellPanel {
+
+	String [] colNames;
+	Vector shownCols=new Vector(13);
+	Vector hiddenCols=new Vector(13);
+	private mButton btnDown,btnUp,btnLeft,btnRight;
+	private myList lstShown,lstHidden;
+	
+	/**
+	 * 
+	 * @param colNames String array of ALL column names
+	 * @param selectedCols The selected columns separated by ,
+	 */
+	public TableColumnChooser(String [] colNames, String selectedCols) {
+        this.colNames=colNames;
+		addNext(new mLabel(MyLocale.getMsg(6050,"Show column")));
+        addNext(new mLabel(""));
+        addLast(new mLabel(MyLocale.getMsg(6051,"Don't show column")));
+        
+        addNext(new ScrollBarPanel(lstShown=new myList(6,shownCols),ScrollBarPanel.AlwaysShowVerticalScrollers));
+        CellPanel cpMid=new CellPanel();
+        cpMid.addLast(new mLabel(""));
+        mImage imgRight=new mImage("ewe/rightarrowsmall.bmp");imgRight.transparentColor=Color.White;
+        mImage imgLeft=new mImage("ewe/leftarrowsmall.bmp");imgLeft.transparentColor=Color.White;
+        cpMid.addLast(btnRight=new mButton(imgRight));
+        cpMid.addLast(new mLabel(""));
+        cpMid.addLast(btnLeft=new mButton(imgLeft));
+        cpMid.addLast(new mLabel(""));
+        addNext(cpMid,VSTRETCH,VFILL);
+        addLast(new ScrollBarPanel(lstHidden=new myList(6,hiddenCols),ScrollBarPanel.AlwaysShowVerticalScrollers));
+        
+        CellPanel pnlButtons=new CellPanel();
+		mImage imgDown=new mImage("ewe/downarrowsmall.bmp"); imgDown.transparentColor=Color.White;
+		mImage imgUp=new mImage("ewe/uparrowsmall.bmp"); imgUp.transparentColor=Color.White;
+        pnlButtons.addNext(btnDown=new mButton(imgDown),HSTRETCH,HFILL); btnDown.modify(Disabled,0);
+		pnlButtons.addLast(btnUp=new mButton(imgUp),HSTRETCH,HFILL); btnUp.modify(Disabled,0);
+        addNext(pnlButtons);
+        addNext(new mLabel(""));
+        addLast(new mLabel(""));
+        
+        // Set up
+        for (int i=0; i<colNames.length; i++) hiddenCols.add(colNames[i]);
+        StringTokenizer st=new StringTokenizer(selectedCols,",");
+        int iCol;
+        while (st.hasMoreTokens()) {
+        	iCol=Common.parseInt(st.nextToken());
+        	if (iCol>=0 && iCol<colNames.length) {
+        		shownCols.add(colNames[iCol]);
+        		hiddenCols.remove(colNames[iCol]);
+        	}
+        }
+        changeUpDownButtonStatus();
+	}
+
+	public String getSelectedCols() {
+		StringBuffer sb=new StringBuffer(40);
+		for (int i=0; i<lstShown.items.size(); i++) {
+			String colName=(String)lstShown.items.elementAt(i);
+			for (int j=0; j<colNames.length; j++) {
+				if (colName.equals(colNames[j])) {
+					if (sb.length()!=0) sb.append(',');
+					sb.append(j);
+					break;
+				}
+			}
+		}
+		return sb.toString();
+	}
+	
+	/** Enable the up/down buttons only if at least 2 caches are in the list */
+	private void changeUpDownButtonStatus() {
+		btnUp.modify(0,Disabled);
+		if (lstShown.items.size()<2 || lstShown.getSelectedIndex(0)==0) btnUp.modify(Disabled,0);
+		btnDown.modify(0,Disabled);
+		if (lstShown.items.size()<2 || lstShown.getSelectedIndex(0)==lstShown.items.size()-1) btnDown.modify(Disabled,0);
+		btnUp.repaintNow();
+		btnDown.repaintNow();
+	}
+
+	
+	public void onEvent(Event ev) {
+		if (ev instanceof ControlEvent && ev.type==ControlEvent.PRESSED) {
+			if (ev.target==btnUp) {
+				lstShown.moveUp();
+			} else if (ev.target==btnDown) {
+				lstShown.moveDown();
+			} else if (ev.target==btnRight) {
+				// Need to leave at least one item in shown list
+				if (lstShown.items.size()>1)
+					lstShown.moveItem(lstHidden,lstShown.getSelectedIndex(0));
+			} else if (ev.target==btnLeft) {
+				lstHidden.moveItem(lstShown,lstHidden.getSelectedIndex(0));
+			}
+			changeUpDownButtonStatus();
+		} else if (ev instanceof ListEvent && ev.target==lstShown)
+			changeUpDownButtonStatus();
+		super.onEvent(ev);
+	}
+	
+	private class myList extends mList {
+
+		//public Vector items;
+		int idx;
+		
+		myList(int rows, Vector elements) {
+			super(rows,1,false);
+			//this.items=elements;
+			items=elements;
+		}
+
+		// Move selected element down by one
+    	public void moveDown() {
+			idx=getSelectedIndex(0);
+    		if (idx>=0) {
+	    		String s=(String) items.elementAt(idx);
+				items.del(idx);
+	    		items.insertElementAt(s,idx+1);
+	    		select(idx+1);
+	    		repaint();
+    		}
+    	}
+    	
+    	// Move selected element up by one
+    	public void moveUp() {
+			idx=getSelectedIndex(0);
+    		if (idx>=0) {
+				String s=(String) items.elementAt(idx);
+				items.del(idx);
+	    		items.insertElementAt(s,idx-1);
+	    		select(idx-1);
+	    		repaint();
+    		}
+    	}
+    	
+    	
+		public void startDragging(DragContext dc) {
+			 idx=getSelectedIndex(0);
+			 // Can only drag if we have a valid index (at least on element in list)
+			 // Also if we drag from lstShown, we must leave at least one item in list
+			 if (idx>=0 && idx<items.size() && (this!=lstShown || items.size()>1)) {
+				 IconAndText imgDrag=new IconAndText();
+				 imgDrag.addColumn(items.elementAt(idx));
+				 dc.dragData=dc.startImageDrag(imgDrag,new Point(8,8),this);
+			 }
+		}
+	
+		public void dragged(DragContext dc) {
+			if (dc.dragData!=null) dc.imageDrag();
+		}
+		 
+		public void stopDragging(DragContext dc) {
+			 if (dc.dragData==null) return;
+			 dc.stopImageDrag(true);
+			 Point p = Gui.getPosInParent(this,getWindow());
+			 p.x += dc.curPoint.x;
+			 p.y += dc.curPoint.y;
+			 Control dest = getWindow().findChild(p.x,p.y);
+		     if (dest instanceof myList) { 
+		    	 moveItem((myList)dest,idx);
+		    	 changeUpDownButtonStatus();
+		     }
+		 }
+		
+		public void moveItem(myList dst, int srcIdx) {
+			 if(srcIdx<0) return;
+	    	 String colToMove=(String) items.elementAt(srcIdx);
+	    	 items.del(srcIdx);
+	    	 ((myList)dst).items.add(colToMove);
+	    	 repaint();
+	    	 dst.repaint();
+	    	 if (srcIdx>=items.size()) select(items.size()-1);
+		}
+	
+	} // myList
+	
+	/**
+	 * Converts a comma delimited string into an integer array.
+	 * Each value is checked and has to be between min and max, If not it is
+	 * replaced with default
+	 */ 
+	public static int[] str2Array(String configString, int min, int max, int def) {
+		Vector strConfigVector=new Vector(14);
+		SubString.split(configString,',',strConfigVector);
+		int i;
+		int nElem=strConfigVector.size();
+		int []res=new int[nElem];
+		for (i=0; i<nElem; i++) {
+			res[i]=Common.parseInt((String)strConfigVector.elementAt(i));
+			if (res[i]<min || res[i]>max) res[i]=def;
+		}
+		return res;
+	}
+	
+}

Added: trunk/src/CacheWolf/Travelbug.java
===================================================================
--- trunk/src/CacheWolf/Travelbug.java	2007-08-26 12:22:01 UTC (rev 833)
+++ trunk/src/CacheWolf/Travelbug.java	2007-08-26 12:43:34 UTC (rev 834)
@@ -0,0 +1,88 @@
+package CacheWolf;
+/**
+ * This contains the basic information of a GC travelbug.
+ * @author salzkammergut
+ *
+ */
+public class Travelbug {
+	/** GC unique id or guid (both are used depending on how the TB is picked up).
+	 * Travelbugs retrieved from a cache use the guid, travelbugs entered manually
+	 * use the id */
+	private String guid;       //0
+	/** GC Name i.e. "First Roman Geocoin" */
+	private String name;       //1
+	/** GC tracking no i.e. 652345, needed for logging */
+	private String trackingNo; //2 
+	/** GC Mission */
+	private String mission;    //3
+
+	/** Construct a travelbug with a given name */
+	public Travelbug(String name) {
+		this("",name,"");
+	}
+
+	/** Construct a travelbug with id, name and mission */
+	public Travelbug(String guid, String name, String mission) {
+		this.guid = guid;
+		this.name = name;
+		this.mission = mission;
+		this.trackingNo="";
+	}
+	
+	public String getGuid() {
+		return guid;
+	}
+
+	public void setGuid(String guid) {
+		this.guid = guid;
+	}
+
+	public String getName() {
+		return name;
+	}
+
+	public void setName(String name) {
+		this.name = name;
+	}
+
+	public String getTrackingNo() {
+		return trackingNo;
+	}
+
+	public void setTrackingNo(String trackingNo) {
+		this.trackingNo = trackingNo;
+	}
+
+	public void setMission(String mission) {
+		this.mission = mission;
+	}
+
+	public String getMission() {
+		return this.mission;
+	}
+	
+	/** Return XML representation of travelbug for storing in cache.xml */
+	public String toXML(){
+		StringBuffer s=new StringBuffer(300);
+		s.append("  <tb guid=\"");
+		s.append(guid);
+		s.append("\"><name><![CDATA[");
+		s.append(name);
+		s.append("]]></name><![CDATA[");
+		s.append(mission);
+		s.append("]]></tb>\n");
+		return s.toString();
+	}
+	
+	/** Return HTML representation of travelbug for display on screen */
+	public String toHtml(){
+		StringBuffer s=new StringBuffer(300);
+		s.append("<b>Name:</b> ");
+		s.append(name);
+		s.append("<br>");
+		s.append(mission);
+		s.append("<hr>");
+		return s.toString();
+	}
+
+}

Added: trunk/src/CacheWolf/TravelbugJourney.java
===================================================================
--- trunk/src/CacheWolf/TravelbugJourney.java	2007-08-26 12:22:01 UTC (rev 833)
+++ trunk/src/CacheWolf/TravelbugJourney.java	2007-08-26 12:43:34 UTC (rev 834)
@@ -0,0 +1,320 @@
+package CacheWolf;
+
+/**
+ * A travelbug journey starts in a cache (from....) where the tb is picked up and 
+ * ends in another cache (to...) where the travelbug is dropped. For both transfers
+ * the date/time is recorded and a flag (...Logged) is kept, indicating whether the
+ * transfer has been logged to GC.
+ * @author salzkammergut
+ */
+import ewe.fx.Image;
+import ewe.sys.*;
+
+public class TravelbugJourney  {
+	/** 
+	 * The travelbug concerned @see Travelbug 
+	 */
+	private Travelbug tb;
+	/** 
+	 * The profile from where the travelbug was picked up 
+	 */
+	private String fromProfile;//4:
+	/** 
+	 * The waypoint within the profile where the travelbug was picked up 
+	 */
+	private String fromWaypoint;//5:
+	/** 
+	 * The date and time when the travelbug was picked up 
+	 */
+	private String fromDate;   //6: 
+	/** 
+	 * Flag that indicates whether the pick-up was logged with GC 
+	 */
+	private boolean fromLogged;//7:
+	/** 
+	 * The profile where the travelbug was dropped 
+	 */
+	private String toProfile;  //8:
+	/** 
+	 * The waypoint within the profile where the travelbug was dropped 
+	 */
+	private String toWaypoint; //9:
+	/** 
+	 * The date and time when the travelbug was dropped 
+	 */
+	private String toDate;     //10:
+	/** 
+	 * Flag that indicates whether the drop was logged with GC 
+	 */
+	private boolean toLogged;  //11:
+	/**
+	 * When retrieving the elements of a travelbug journey by number, this
+	 * virtual column is used to retrieve the AND of fromLogged and toLogged. 
+	 * It thus returns true only if bith transactions have been logged.
+	 */
+	public static final int BOTHLOGGED=12;
+	
+	public TravelbugJourney(String id, String name, String trackingNo, String fromProfile, 
+			String fromWaypoint, String fromDate, String fromLogged,
+			String toProfile, String toWaypoint, String toDate, String toLogged,
+			String mission) {
+		tb=new Travelbug(id,name,mission);
+		tb.setTrackingNo(trackingNo);
+		this.fromProfile = fromProfile;
+		this.fromWaypoint = fromWaypoint;
+		this.fromDate = fromDate;
+		this.fromLogged = Convert.toBoolean(fromLogged);
+		this.toProfile = toProfile;
+		this.toWaypoint = toWaypoint;
+		this.toDate = toDate;
+		this.toLogged = Convert.toBoolean(toLogged);
+	}
+
+	public TravelbugJourney(String name) {
+		tb=new Travelbug("",name,"");
+		tb.setTrackingNo("");
+		setFromProfile("");
+		setFromWaypoint("");
+		setFromDate("");    
+		setFromLogged("");
+		setToProfile("");
+		setToWaypoint("");
+		setToDate("");   
+		setToLogged(""); 
+	}
+
+	public TravelbugJourney(Travelbug tb, String profile, String waypoint) {
+		this.tb=tb;
+		setFromProfile(profile);
+		setFromWaypoint(waypoint);
+		setFromDate(getDateTime());    
+		setToProfile("");
+		setToWaypoint("");
+		setToDate("");   
+		setFromLogged("");
+		setToLogged(""); 
+	}
+	
+	/** Drop a travelbug in a profile/waypoint and set the current date-time as
+	 * the drop date-time.
+	 * @param profile The profile where the tb is dropped
+	 * @param waypoint the waypoint where the tb is dropped
+	 */
+	public void dropTravelbug(String profile, String waypoint) {
+		setToProfile(profile);
+		setToWaypoint(waypoint);
+		setToDate(getDateTime());    
+	}
+	
+	private static Image checkboxTicked = new Image("checkboxTicked.png");
+	private static Image checkboxUnticked= new Image("checkboxUnticked.png");
+	
+	/** Get an element of a TravelbugJourney by number. This is used when
+	 * displaying the journey in list format.
+	 * @param elementNo The element (=column) to get
+	 * @return The requested element as a String or Image
+	 */
+	public Object getElementByNumber(int elementNo) {
+		switch(elementNo) {
+	    	//--- Travelbug ---
+		    case 0: return tb.getGuid();
+		   	case 1:	return tb.getName();
+			case 2: return tb.getTrackingNo();
+			case 3: return tb.getMission();
+		    //--- TravelbugJourney ---
+			case 4: return getFromProfile();
+			case 5: return getFromWaypoint();
+			case 6: return getFromDate();
+			case 7: if (getFromLogged())
+						return checkboxTicked;
+					else
+						return checkboxUnticked;
+			case 8: return getToProfile();
+			case 9: return getToWaypoint();
+			case 10: return getToDate();
+			case 11: if(getToLogged())
+						return checkboxTicked;
+					else
+						return checkboxUnticked;
+			/* Special case 12: Return Z if both moves have been logged, blank otherwise
+			 This allows the not logged tbJourneys to be sorted to the top.*/
+			case 12: return bothLogsDone() ? "Z": " ";
+			default: return "?";
+		}
+	}
+
+	/** Return the name of the journey element by number, i.e. the title column
+	 * of a list.
+	 * @param elementNo The element (=column) to get
+	 * @return The name as a String
+	 */
+	public static String getElementNameByNumber(int elementNo) {
+		switch (elementNo) {
+		    //--- Travelbug ---
+			case 0: return MyLocale.getMsg(6000,"Guid");
+		   	case 1:	return MyLocale.getMsg(6001,"Name");
+			case 2: return MyLocale.getMsg(6002,"track#");
+			case 3: return MyLocale.getMsg(6003,"Mission");
+		    //--- TravelbugJourney ---
+			case 4: return MyLocale.getMsg(6004,"From Prof");
+			case 5: return MyLocale.getMsg(6005,"From Wpt");
+			case 6: return MyLocale.getMsg(6006,"From Date");
+			case 7: return MyLocale.getMsg(6007,"From Log");
+			case 8: return MyLocale.getMsg(6008,"To Prof");
+			case 9: return MyLocale.getMsg(6009,"To Wpt");
+			case 10: return MyLocale.getMsg(6010,"To Date");
+			case 11: return MyLocale.getMsg(6011,"To Log");
+			default: return "?";
+		}
+	}
+	
+	/** Return the travelbug that defines the journey */
+	public Travelbug getTb() {
+		if (tb==null) tb=new Travelbug("");
+		return tb;
+	}
+	
+	/** The date when the travelbug was picked up */
+	public String getFromDate() {
+		return fromDate;
+	}
+
+	/** The date when the travelbug was picked up */
+	public void setFromDate(String fromDate) {
+		this.fromDate = fromDate;
+	}
+
+	/** The profile where the travelbug was picked up */
+	public String getFromProfile() {
+		return fromProfile;
+	}
+
+	/** The profile where the travelbug was picked up */
+	public void setFromProfile(String fromProfile) {
+		this.fromProfile = fromProfile;
+	}
+
+	/** The waypoint where the travelbug was picked up */
+	public String getFromWaypoint() {
+		return fromWaypoint;
+	}
+
+	/** The waypoint where the travelbug was picked up */
+	public void setFromWaypoint(String fromWaypoint) {
+		this.fromWaypoint = fromWaypoint;
+	}
+
+	/** The log status of the travelbug pick-up transaction */
+	public void setFromLogged(String fromLogged) {
+		this.fromLogged = Convert.toBoolean(fromLogged);
+	}
+
+	/** The log status of the travelbug pick-up transaction */
+	public void setFromLogged(boolean fromLogged) {
+		this.fromLogged = fromLogged;
+	}
+
+	/** The log status of the travelbug pick-up transaction */
+	public boolean getFromLogged() {
+		return this.fromLogged;
+	}
+
+	/** The date when the travelbug was dropped */
+	public String getToDate() {
+		return toDate;
+	}
+
+	/** The date when the travelbug was dropped */
+	public void setToDate(String toDate) {
+		this.toDate = toDate;
+	}
+
+	/** The profile where the travelbug was dropped */
+	public String getToProfile() {
+		return toProfile;
+	}
+
+	/** The profile where the travelbug was dropped */
+	public void setToProfile(String toProfile) {
+		this.toProfile = toProfile;
+	}
+
+	/** The waypoint where the travelbug was dropped */
+	public String getToWaypoint() {
+		return toWaypoint;
+	}
+
+	/** The waypoint where the travelbug was dropped */
+	public void setToWaypoint(String toWaypoint) {
+		this.toWaypoint = toWaypoint;
+	}
+
+	/** The log status of the travelbug drop transaction */
+	public void setToLogged(String toLogged) {
+		this.toLogged = Convert.toBoolean(toLogged);
+	}
+
+	/** The log status of the travelbug drop transaction */
+	public void setToLogged(boolean toLogged) {
+		this.toLogged = toLogged;
+	}
+
+	/** The log status of the travelbug drop transaction */
+	public boolean getToLogged() {
+		return this.toLogged;
+	}
+	
+	/** True if both transactions (pick-up and drop) have been logged with GC. */
+	public boolean bothLogsDone() {
+		return this.toLogged && this.fromLogged;
+	}
+	
+	/**
+	 * Returns true if the travelbug is currently in my posession, i.e. it has
+	 * a pick-up date but no drop date.
+	 * @return The status to the travelbug
+	 */public boolean inMyPosession() {
+		return !fromDate.equals("") && toDate.equals("");
+	}
+
+	/** Returns an XML representation of a TravelbugJourney for storing in a file */
+	public String toXML(){
+		StringBuffer s=new StringBuffer(200);
+		s.append("  <tbj");
+		appendElem(s,"id",tb.getGuid(),false);
+		appendElem(s,"trackingNo",tb.getTrackingNo(),false);
+		appendElem(s,"fromProfile",fromProfile,true);
+		appendElem(s,"fromWaypoint",fromWaypoint,false);
+		appendElem(s,"fromDate",fromDate,false);
+		appendElem(s,"fromLogged",(new Boolean(fromLogged)).toString(),false);
+		appendElem(s,"toProfile",toProfile,true);
+		appendElem(s,"toWaypoint",toWaypoint,false);
+		appendElem(s,"toDate",toDate,false);
+		appendElem(s,"toLogged",(new Boolean(toLogged)).toString(),false);
+		s.append("><name><![CDATA[");
+		s.append(tb.getName());
+		s.append("]]></name><![CDATA[");
+		s.append(tb.getMission());
+		s.append("]]></tbj>\n");
+		return s.toString();
+	}
+	
+	private void appendElem(StringBuffer s,String name,String value,boolean clean) {
+		s.append(" ");
+		s.append(name);
+		s.append("=\"");
+		if (clean)
+			s.append(SafeXML.clean(value));
+		else
+			s.append(value);
+		s.append("\"");
+	}
+	
+	/** Returns the current date-time in format YYYY-MM-DD HH:MM */
+	private String getDateTime() {
+		Time t=new Time();
+		return MyLocale.formatLong(t.year,"0000")+"-"+MyLocale.formatLong(t.month,"00")+"-"+
+		       MyLocale.formatLong(t.day,"00")+" "+MyLocale.formatLong(t.hour,"00")+":"+MyLocale.formatLong(t.minute,"00");
+	}
+	
+}

Added: trunk/src/CacheWolf/TravelbugJourneyList.java
===================================================================
--- trunk/src/CacheWolf/TravelbugJourneyList.java	2007-08-26 12:22:01 UTC (rev 833)
+++ trunk/src/CacheWolf/TravelbugJourneyList.java	2007-08-26 12:43:34 UTC (rev 834)
@@ -0,0 +1,217 @@
+package CacheWolf;
+
+/**
+ * A list of @see TravelbugJourney s.
+ */
+import ewe.io.BufferedWriter;
+import ewe.io.File;
+import ewe.io.FileWriter;
+import ewe.io.PrintWriter;
+import ewe.util.*;
+import ewesoft.xml.*;
+import ewesoft.xml.sax.*;
+
+public class TravelbugJourneyList extends MinML {
+
+	/** The Vector holdin the travelbug journeys */
+	private Vector tbJourneyList=new Vector(10);
+	
+	/** Return a TravelbugJourney */
+	public TravelbugJourney getTBJourney(int i) {
+		return (TravelbugJourney) tbJourneyList.elementAt(i);
+	}
+	
+	/** Number of TravelbugJourneys in list */
+	public int size() {
+		return tbJourneyList.size();
+	}
+	
+	/** Clear the list */
+	public void clear() {
+		tbJourneyList.clear();
+	}
+
+	/** Add a TravelbugJourney to the list */
+	public void add(TravelbugJourney tb) {
+		tbJourneyList.add(tb);
+	}
+	
+	/** Remove an element of the list */
+	public void remove(int i) {
+		tbJourneyList.removeElementAt(i);
+	}
+
+	/** Add e Travelbug pick-up to the list (creating a new Journey) */
+	public void addTbPickup(Travelbug tb, String profile, String waypoint) {
+		tbJourneyList.add(new TravelbugJourney(tb,profile,waypoint));
+	}
+	
+	
+	/** Add a Travelbug drop to the list for a given Travelbug which must be in the
+	 * list
+	 */
+	public void addTbDrop(Travelbug tb,String profile, String waypoint) {
+		int i=findTB(tb);
+		if (i>=0) {
+			getTBJourney(i).dropTravelbug(profile,waypoint);
+		}
+	}
+	
+	/** Find a travelbug in the list */
+	private int findTB(Travelbug tb) {
+		for (int i=size()-1; i>=0; i--) {
+			if (tb.getName().equals(getTBJourney(i).getTb().getName())) return i;
+		}
+		return -1;
+	}
+	
+	/** Count the number of journeys where at least one log still needs to be done
+	 */
+	public int countNonLogged() {
+		int count=0;
+		for (int i=size()-1; i>=0; i--)
+			if (!getTBJourney(i).bothLogsDone()) count++;
+		return count;
+	}
+	
+	TravelbugJourneyList() {}
+	
+	/**
+	 * Return a list of the travelbugs still in my possession
+	 * @return 
+	 */
+	public TravelbugList getMyTravelbugs() {
+		TravelbugList tbl=new TravelbugList();
+		int size=size();
+		for (int i=0; i<size; i++) {
+			TravelbugJourney tbj=getTBJourney(i);
+			if (tbj.inMyPosession()) tbl.add(tbj.getTb());
+		}
+		return tbl;
+	}
+	
+	// Variables needed for reading the TB list
+	private String lastName;
+	private StringBuffer xmlElement=new StringBuffer(200);
+	private TravelbugJourney tbJ;
+	/**
+	 * Method to open and parse the travelbugs.xml file which contains the tavelbugs
+	 * which were picked up and dropped by us. 
+	 */
+	public boolean readTravelbugsFile(){
+		try{
+			String datei = Global.getPref().baseDir + "/" + "travelbugs.xml";
+			datei = datei.replace('\\', '/');
+			ewe.io.Reader r = new ewe.io.InputStreamReader(new ewe.io.FileInputStream(datei));
+			parse(r);
+			r.close();
+		}catch(Exception e){
+			if (e instanceof NullPointerException)
+				Global.getPref().log("Error reading travelbugs.xml: NullPointerException in Element "+lastName +". Wrong attribute?",e,true);
+			else 
+				Global.getPref().log("Error reading travelbugs.xml: ", e);
+			return false;
+		}
+		return true;
+	}
+	
+	/**
+	 * Method that gets called when a new element has been identified in travelbugs.xml
+	 */
+	public void startElement(String name, AttributeList atts){
+		//Vm.debug("name = "+name);
+		lastName=name;
+		if (name.equals("tbj")) {
+			tbJ=new TravelbugJourney(
+				atts.getValue("id"),
+				"",
+				atts.getValue("trackingNo"),
+				SafeXML.cleanback(atts.getValue("fromProfile")),
+				atts.getValue("fromWaypoint"),
+				atts.getValue("fromDate"),
+				atts.getValue("fromLogged"),
+				SafeXML.cleanback(atts.getValue("toProfile")),
+				atts.getValue("toWaypoint"),
+				atts.getValue("toDate"),
+				atts.getValue("toLogged"),
+				"");
+		}
+	}
+
+	public void characters( char ch[], int start, int length ) {
+			xmlElement.append(ch,start,length); // Collect the mission
+	}	
+
+	public void endElement(String tag){
+		if (tag.equals("tbj")) {
+			tbJ.getTb().setMission(xmlElement.toString());
+			tbJourneyList.add(tbJ);
+			xmlElement.delete(0,xmlElement.length());
+		}
+		if (tag.equals("name")) {
+			tbJ.getTb().setName(xmlElement.toString());
+			xmlElement.delete(0,xmlElement.length());
+		}
+	}
+	
+	/**
+	 * Method to save current travelbugs in the travelbugs.xml file
+	 */
+	public void saveTravelbugsFile(){
+		String baseDir=Global.getPref().baseDir;
+		try {
+			File backup=new File(baseDir+"travelbugs.bak");
+			if (backup.exists()) backup.delete();
+			File travelbugs=new File(baseDir+"travelbugs.xml");
+			travelbugs.rename("travelbugs.bak");
+		} catch (Exception ex) {
+			Global.getPref().log("Error deleting backup or renaming travelbugs.xml");
+		}
+		String datei = baseDir + "travelbugs.xml";
+		try{
+			PrintWriter outp = new PrintWriter(new BufferedWriter(new FileWriter(datei)));
+			outp.print("<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n");
+			outp.print("<travelbugJourneys>\n");	
+			int size=tbJourneyList.size();
+			for (int i=0; i<size; i++) outp.print(((TravelbugJourney)tbJourneyList.elementAt(i)).toXML());
+			outp.print("</travelbugJourneys>\n");	
+			outp.close();
+		} catch (Exception e) {
+			Global.getPref().log("Problem saving: " +datei,e,true);
+		}
+	}
+
+	/** Sort the list of travelbug journeys by any column */
+	public void sort(int column, boolean ascending) {
+		tbJourneyList.sort(new tbjComparer(column),ascending);
+	}
+
+	/** Sort only part of the travelbug journey list. This is used to sort the
+	 * non-logged journeys, which are at the start of the list
+	 * @param column Column to sort by @see TravelbugJourney
+	 * @param ascending Sort order
+	 * @param nElem Number of elements to sort
+	 */
+	public void sortFirstHalf(int column, boolean ascending,int nElem) {
+		Object[] no = new Object[nElem];
+		for (int i=0; i<nElem; i++) no[i]=tbJourneyList.elementAt(i);
+		Utils.sort(null,no,new tbjComparer(column),ascending);
+		for (int i=0; i<nElem; i++) tbJourneyList.set(i,no[i]);
+	}
+	
+	private class tbjComparer implements Comparer {
+		private int col;
+		tbjComparer(int column) {
+			col=column;
+		}
+		
+		public int compare(Object o1, Object o2){
+			Object oo1=((TravelbugJourney) o1).getElementByNumber(col);
+			Object oo2=((TravelbugJourney) o2).getElementByNumber(col);
+			return oo1.toString().compareTo(oo2.toString());
+		}
+	}
+
+	
+	
+}

Added: trunk/src/CacheWolf/TravelbugJourneyScreen.java
===================================================================
--- trunk/src/CacheWolf/TravelbugJourneyScreen.java	2007-08-26 12:22:01 UTC (rev 833)
+++ trunk/src/CacheWolf/TravelbugJourneyScreen.java	2007-08-26 12:43:34 UTC (rev 834)
@@ -0,0 +1,602 @@
+package CacheWolf;
+
+/**
+ * A list to manage the travelbugs. Each row represents one @see TravelbugJourney.
+ * The lower half of the screen which is separated from the top by a splitter bar,
+ * contains four tabs: One for the travelbug, one for the source (where the travelbug 
+ * was picked up), one for the destination (where the travelbug was dropped) and one
+ * for the mission. These tabs are used for inputting data about the travelbug journey.
+ * The travelbugs are read from file travelbugs.xml which is stored in the base directory.
+ * When the screen is closed, all data is written back to the file.
+ * @author salzkammergut
+ */
+
+import ewe.sys.Convert;
+import ewe.sys.Time;
+import ewe.sys.Vm;
+import ewe.ui.*;
+import ewe.util.*;
+import ewe.fx.*;
+
+public class TravelbugJourneyScreen extends Form  {
+	
+	/** The list control */
+	private tbListControl tcTbJourneyList;
+	/** The list model */
+	private tbListTableModel modTbJourneyList;
+	/** The actual journeys */
+	private TravelbugJourneyList tblMyTravelbugJourneys;
+	/** The panel for the lower half of the screen */
+	private CellPanel lowerpane;
+	private mInput inpName,inpTrackingNo, 
+		   inpFromDate, inpFromProfile, inpFromWaypoint, 
+	       inpToDate, inpToProfile, inpToWaypoint;
+	private mLabel lblId;
+	private mButton btnFromDate,btnToDate;
+	private mCheckBox chkFromLogged, chkToLogged;
+	private HtmlDisplay txtMission;
+	private mTabbedPanel pnlTab;
+    /**	 List of TBs in the current cache */
+	private TravelbugList tblSrcCache; 
+	/** The currently selected row */
+	private int selectedRow=-1;
+	/** A label which holds the number of currently displayed travelbug journeys*/
+	private mLabel lblNumVisibleJourneys;
+	private final Color RED=new Color(255,0,0);
+	private int exitKeys[]={75009};
+	/** A flag to track whether the current cache has to be saved because a travelbug
+	 * was added to or taken from it.
+	 */
+	private boolean chDmodified=false;
+	
+	/** The current cache */
+	private CacheHolderDetail chD;
+	/** The base data of the current cache */
+	private CacheHolder ch;
+	/** The name of the current waypoint */
+	private String waypoint="";
+	
+	public TravelbugJourneyScreen() {
+		Vector cacheDB=Global.getProfile().cacheDB;
+		SplittablePanel split = new SplittablePanel(PanelSplitter.VERTICAL);
+		CellPanel tablepane = split.getNextPanel();
+		int curCacheNo=Global.mainTab.tbP.getSelectedCache();
+		String cache="";
+		if (curCacheNo<cacheDB.size()) {
+			ch=(CacheHolder)cacheDB.elementAt(curCacheNo);
+			cache=MyLocale.getMsg(6022,": Current cache: ")+ch.wayPoint+" - "+ch.CacheName;
+			waypoint=ch.wayPoint;
+			chD=new CacheHolderDetail(ch);
+			try {
+				chD.readCache(Global.getProfile().dataDir);
+			}catch (Exception ex) {
+				Global.getPref().log("Failed to read cache "+ch.wayPoint);
+			};
+			tblSrcCache=chD.Travelbugs;
+		}
+		title="Travelbugs"+cache;
+		tcTbJourneyList=new tbListControl();
+		tcTbJourneyList.setTableModel(modTbJourneyList=new tbListTableModel());
+		tablepane.addLast(new ScrollBarPanel(tcTbJourneyList,ScrollBarPanel.AlwaysShowVerticalScrollers),STRETCH,FILL);
+	
+		lowerpane = split.getNextPanel();
+		
+		pnlTab=new mTabbedPanel();
+		pnlTab.extraControlsRight=lblNumVisibleJourneys=new mLabel("  0");
+		//------------------------------------------------
+		// First Tab - Name & Tracking #
+		//------------------------------------------------
+		CellPanel pnlName=new CellPanel();
+		pnlName.addNext(new mLabel(MyLocale.getMsg(6025,"Name:")),DONTSTRETCH,DONTFILL);
+		pnlName.addLast(inpName=new mInput(),HSTRETCH,HFILL);
+		pnlName.addNext(new mLabel(MyLocale.getMsg(6026,"Tracking #:")),DONTSTRETCH,DONTFILL);
+		pnlName.addLast(inpTrackingNo=new mInput(),HSTRETCH,HFILL);
+		pnlName.addNext(new mLabel(MyLocale.getMsg(6027,"ID/GUID:")),DONTSTRETCH,DONTFILL);
+		pnlName.addLast(lblId=new mLabel(""),HSTRETCH,HFILL);
+		pnlTab.addCard(pnlName,MyLocale.getMsg(6028,"Name"),"Name");
+		
+		//------------------------------------------------
+		// Second Tab - Where was the TB picked up from
+		//------------------------------------------------
+		CellPanel pnlFrom=new CellPanel();
+		pnlFrom.addNext(new mLabel(MyLocale.getMsg(6029,"Profile/Cache:")),DONTSTRETCH,DONTFILL|WEST);
+		pnlFrom.addNext(inpFromProfile=new mInput(),HSTRETCH,HFILL);
+		pnlFrom.addLast(inpFromWaypoint=new mInput(),HSTRETCH,HFILL);
+		
+		pnlFrom.addNext(new mLabel(MyLocale.getMsg(6030,"Date found:")),DONTSTRETCH,DONTFILL|WEST);
+		pnlFrom.addNext(inpFromDate=new mInput(),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
+		pnlFrom.addLast(btnFromDate=new mButton(new mImage("calendar.png")),DONTSTRETCH,DONTFILL|WEST);
+		btnFromDate.modify(0,ControlConstants.TakesKeyFocus);
+		
+		pnlFrom.addNext(new mLabel(MyLocale.getMsg(6031,"Logged:")),DONTSTRETCH,DONTFILL|WEST);
+		pnlFrom.addLast(chkFromLogged=new mCheckBox(""),DONTSTRETCH,DONTFILL|WEST);
+		chkFromLogged.exitKeys=exitKeys;
+		pnlFrom.addLast(new mLabel(""));
+		
+		pnlTab.addCard(pnlFrom,MyLocale.getMsg(6032,"From"),"From");
+
+		//------------------------------------------------
+		// Third Tab - Where was the TB dropped
+		//------------------------------------------------
+		CellPanel pnlTo=new CellPanel();
+		pnlTo.addNext(new mLabel(MyLocale.getMsg(6029,"Profile/Cache:")),DONTSTRETCH,DONTFILL|WEST);
+		pnlTo.addNext(inpToProfile=new mInput(),HSTRETCH,HFILL);
+		pnlTo.addLast(inpToWaypoint=new mInput(),HSTRETCH,HFILL);
+		
+		pnlTo.addNext(new mLabel(MyLocale.getMsg(6033,"Date dropped:")),DONTSTRETCH,DONTFILL|WEST);
+		pnlTo.addNext(inpToDate=new mInput(),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
+		//inpToDate.modifyAll(DisplayOnly,0);
+		pnlTo.addLast(btnToDate=new mButton(new mImage("calendar.png")),DONTSTRETCH,DONTFILL|WEST);
+		btnToDate.modify(0,ControlConstants.TakesKeyFocus);
+		//pnlTo.addLast(new mLabel(""));
+		
+		pnlTo.addNext(new mLabel(MyLocale.getMsg(6031,"Logged:")),DONTSTRETCH,DONTFILL|WEST);
+		pnlTo.addLast(chkToLogged=new mCheckBox(""),DONTSTRETCH,DONTFILL|WEST);
+		chkToLogged.exitKeys=exitKeys;
+		pnlTo.addLast(new mLabel(""));
+		
+		pnlTab.addCard(pnlTo,MyLocale.getMsg(6034,"To"),"To");
+		
+		//------------------------------------------------
+		// Last Panel - TB Mission
+		//------------------------------------------------
+		CellPanel pnlDest=new CellPanel();
+		pnlDest.addLast(new mLabel(MyLocale.getMsg(6035,"Mission:")));
+		pnlDest.addLast(txtMission=new HtmlDisplay(),STRETCH,FILL);
+		txtMission.rows=3;
+		pnlTab.addCard(pnlDest,MyLocale.getMsg(6036,"Mission"),"Mission");
+
+		
+		lowerpane.addLast(pnlTab,STRETCH,FILL);
+		
+		
+		split.setSplitter(PanelSplitter.AFTER|PanelSplitter.HIDDEN,PanelSplitter.BEFORE|PanelSplitter.HIDDEN,0);
+		addLast(split,STRETCH,FILL);
+		//setPreferredSize(MyLocale.getScreenWidth()<=240?240:MyLocale.getScreenWidth()*2/3,240);
+		
+		tblMyTravelbugJourneys=new TravelbugJourneyList();
+		tblMyTravelbugJourneys.readTravelbugsFile();
+		modTbJourneyList.numRows=tblMyTravelbugJourneys.size();
+		// Get the columns to display and their widths from preferences
+		modTbJourneyList.columnMap=
+			TableColumnChooser.str2Array(Global.getPref().travelbugColMap,0,11,0);
+		modTbJourneyList.colWidth=
+			TableColumnChooser.str2Array(Global.getPref().travelbugColWidth,10,1024,50);
+		modTbJourneyList.numCols=modTbJourneyList.columnMap.length;
+		
+		modTbJourneyList.select(0,12,true);
+		/* Restore the saved setting about showing only non-logged bugs */
+		if (Global.getPref().travelbugShowOnlyNonLogged) {
+			tcTbJourneyList.toggleNonLogged();
+		}
+		updateNumBugs();
+	}
+	
+	/** Indicate the number of journeys currently displayed */
+	private void updateNumBugs() {
+		lblNumVisibleJourneys.setText(""+modTbJourneyList.numRows);
+		lblNumVisibleJourneys.repaint();
+	}
+	
+	/** The control which had the last focus */
+	private Control currentControl;
+	
+	public void onEvent(Event ev){
+		// Update the table from the input form  
+		if ((ev instanceof MultiPanelEvent || ev instanceof ControlEvent || ev instanceof DataChangeEvent) && selectedRow!=-1 &&
+				selectedRow<tblMyTravelbugJourneys.size()){
+			TravelbugJourney tbj=tblMyTravelbugJourneys.getTBJourney(selectedRow);
+			if (currentControl==inpName) 			tbj.getTb().setName(inpName.getText());
+			else if (currentControl==inpTrackingNo)  tbj.getTb().setTrackingNo(inpTrackingNo.getText());
+			else if (currentControl==inpFromProfile) tbj.setFromProfile(inpFromProfile.getText());
+			else if (currentControl==inpFromWaypoint)tbj.setFromWaypoint(inpFromWaypoint.getText());
+			else if (currentControl==inpFromDate)    tbj.setFromDate(inpFromDate.getText());
+			else if (currentControl==chkFromLogged)  tbj.setFromLogged(chkFromLogged.state);
+			else if (currentControl==inpToProfile)   tbj.setToProfile(inpToProfile.getText());
+			else if (currentControl==inpToWaypoint)  tbj.setToWaypoint(inpToWaypoint.getText());
+			else if (currentControl==inpToDate)      tbj.setToDate(inpToDate.getText());
+			else if (currentControl==chkToLogged)    tbj.setToLogged(chkToLogged.state);
+			//else if (ev.target==txtMission)     tb.setMission(txtMission.getText());
+			tcTbJourneyList.repaint();
+		}
+		if (ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED && selectedRow!=-1){
+			if (ev.target==inpTrackingNo) {pnlTab.selectNextTab(true,true); Gui.takeFocus(inpFromProfile,Control.ByKeyboard);pnlTab.repaint(); }
+			if (ev.target==inpFromDate) Gui.takeFocus(chkFromLogged,Control.ByKeyboard);
+			if (ev.target==inpToDate) Gui.takeFocus(chkToLogged,Control.ByKeyboard);
+			if (ev.target==btnFromDate || ev.target==btnToDate) {
+				mInput inpDate=ev.target==btnFromDate ? inpFromDate : inpToDate;
+				DateTimeChooser dc=new DateTimeChooser(Vm.getLocale());
+				dc.title=MyLocale.getMsg(328,"Date found"); 
+				dc.setPreferredSize(240,240);
+				String foundDate=inpDate.getText();
+				Time t=new Time();
+				try {
+					t.parse(foundDate,"y-M-d H:m");
+				} catch(IllegalArgumentException e) {
+					try {
+						t.parse(foundDate,"y-M-d");
+					} catch(IllegalArgumentException e1) {}
+				};
+				dc.reset(t);
+				if (dc.execute()==ewe.ui.FormBase.IDOK) {
+				  inpDate.setText(Convert.toString(dc.year)+"-"+MyLocale.formatLong(dc.month,"00")+"-"+MyLocale.formatLong(dc.day,"00")+" "+dc.time);
+				  if (ev.target==btnFromDate){ 
+					  tblMyTravelbugJourneys.getTBJourney(selectedRow).setFromDate(inpDate.getText());
+					  Gui.takeFocus(chkFromLogged,Control.ByKeyboard);
+				  } else {
+					  tblMyTravelbugJourneys.getTBJourney(selectedRow).setToDate(inpDate.getText());
+					  Gui.takeFocus(chkToLogged,Control.ByKeyboard);
+				  } tcTbJourneyList.repaint();
+				}				
+			}
+		}
+		if(ev instanceof ControlEvent && ev.type == ControlEvent.EXITED){
+			pnlTab.selectNextTab(true,true); 
+			if (ev.target==chkFromLogged) Gui.takeFocus(inpToProfile,Control.ByKeyboard);
+			if (ev.target==chkToLogged) Gui.takeFocus(txtMission,Control.ByKeyboard);
+		}
+		// The user closed the travelbugs screen
+		if (ev instanceof FormEvent && ev.type==FormEvent.CLOSED  && chD!=null) {
+			tblMyTravelbugJourneys.saveTravelbugsFile();
+			tblMyTravelbugJourneys.clear();
+			// Save the flag about showing non-logged journeys only
+			boolean old=Global.getPref().travelbugShowOnlyNonLogged;
+			Global.getPref().travelbugShowOnlyNonLogged=(tcTbJourneyList.mnuToggleList.modifiers & MenuItem.Checked) == MenuItem.Checked;
+			String travelbugColWidth=modTbJourneyList.getColWidths();
+			// If the preferences changed, save the pref.xml file
+			Vm.showWait(true);
+			if (!Global.getPref().travelbugColWidth.equals(travelbugColWidth) ||
+				old!=Global.getPref().travelbugShowOnlyNonLogged) {
+				Global.getPref().travelbugColWidth=travelbugColWidth;
+				Global.getPref().savePreferences();
+			}
+			// If the list of travelbugs in the cache was modified, we need to save the cache too
+			if (chDmodified) {
+				chD.saveCacheDetails(Global.getProfile().dataDir);
+				ch.has_bug=chD.Travelbugs.size()>0;
+			}
+			Vm.showWait(false);
+			chD=null;
+		}
+		updateNumBugs();
+		currentControl=Gui.focusedControl();
+	}
+	
+	
+//==============================================================
+// tbListTableModel
+//==============================================================
+class tbListTableModel extends TableModel {
+	private FontMetrics fm;
+	private Image imgRed;
+	tbListTableModel() {
+		
+		fillToEqualHeights=true;
+		allRowsSameSize=true;
+		hasRowHeaders=false;
+		//shadeAlternateRows=true;
+		cursorSize=new Dimension(12,1);
+		clipData=true;
+		fm=this.fm;
+		// A red dot indicates that the journey has not been completely logged
+		imgRed = new Image("red.png");
+	}
+    private int colWidth[];
+	private int columnMap[];
+	
+	public Object getCellText(int row, int col) {
+		return null;
+	}
+
+	public Object getCellData(int row, int col){
+		if(row == -1){
+			return TravelbugJourney.getElementNameByNumber(columnMap[col]);
+		} else {
+			int map=columnMap[col];
+			// If we have not yet logged the from or the to, a red dot is placed in front of the first item
+			if (col==0 && (!tblMyTravelbugJourneys.getTBJourney(row).getFromLogged() ||
+				!tblMyTravelbugJourneys.getTBJourney(row).getToLogged())) { 
+				// Is it a column with a checkbox?
+				if (map!=7 && map!=11) 
+					return new IconAndText((IImage)imgRed,(String) tblMyTravelbugJourneys.getTBJourney(row).getElementByNumber(map),fm);
+				else { // Checkbox - special treatment
+					IconAndText iat=new IconAndText((IImage)imgRed,"",fm);
+					iat.addColumn(tblMyTravelbugJourneys.getTBJourney(row).getElementByNumber(map));
+					return iat;
+				}
+			} else 
+				return tblMyTravelbugJourneys.getTBJourney(row).getElementByNumber(map);
+		}	
+	}
+	public int calculateRowHeight(int row) {
+		return charHeight+2;
+	}
+	
+	public int calculateColWidth(int col){
+		if(col == -1) 
+        	return 0;
+        else if (col<numCols)
+        	return colWidth[columnMap[col]];
+        else return 0;
+	}
+	
+	public TableCellAttributes getCellAttributes(int row,int col,boolean isSelected,TableCellAttributes ta) {
+		ta=super.getCellAttributes(row,col,isSelected,ta);
+		ta.alignment = ta.LEFT;
+		ta.anchor = ta.LEFT;
+		// Color the elements red, if we have not yet logged
+		if (row>=0)
+		switch (columnMap[col]) {
+		case 6: // fromDate
+				if (!tblMyTravelbugJourneys.getTBJourney(row).getFromLogged()) ta.foreground=RED;
+				break;
+		case 10: // toDate
+				if (!tblMyTravelbugJourneys.getTBJourney(row).getToLogged()) ta.foreground=RED;
+				break;
+		}
+		return ta;
+	}
+
+	private void showFields(TravelbugJourney tbj) {
+	   	inpName.setText(tbj.getTb().getName());
+		inpTrackingNo.setText(tbj.getTb().getTrackingNo());
+		lblId.setText(tbj.getTb().getGuid());
+		inpFromProfile.setText(tbj.getFromProfile());
+		inpFromWaypoint.setText(tbj.getFromWaypoint());
+		inpFromDate.setText(tbj.getFromDate());
+		chkFromLogged.setState(tbj.getFromLogged());
+		inpToProfile.setText(tbj.getToProfile());
+		inpToWaypoint.setText(tbj.getToWaypoint());
+		inpToDate.setText(tbj.getToDate());
+		chkToLogged.setState(tbj.getToLogged());
+		txtMission.setHtml(tbj.getTb().getMission());
+	}
+	
+	private boolean sortAsc=false;
+	private int sortedBy = -1;
+	private int lastRow=-1;
+	public int penEventModifiers; 
+
+	public boolean penPressed(Point onTable,Point cell){
+		boolean retval=false;
+		if(cell!=null && cell.y == -1){ // Hit a header => sort the table accordingly
+			Vm.showWait(true);
+			if (cell.x == sortedBy) sortAsc=!sortAsc;
+			else sortAsc = false;
+			sortedBy = cell.x;
+			// Check whether the list only shows non-logged journeys. If so, a subset
+			// of the table must be sorted
+			if ((tcTbJourneyList.mnuToggleList.modifiers & MenuItem.Checked) == MenuItem.Checked) {
+				tblMyTravelbugJourneys.sortFirstHalf(columnMap[cell.x], sortAsc,modTbJourneyList.numRows);
+			} else { // Showing all journeys - sort the full table
+				tblMyTravelbugJourneys.sort(columnMap[cell.x], sortAsc);
+			}
+			tcTbJourneyList.repaint();
+			Vm.showWait(false);
+			retval = true;
+		} else if (cell!=null && cell.y>=0 && (penEventModifiers & IKeys.SHIFT)>0) {
+			// A range of rows can be marked by shift-click on the first and last row
+			if (lastRow!=-1) { // Second row being marked with shift key pressed
+				if (lastRow<cell.y)
+					toggleSelect(lastRow,cell.y);
+				else
+					toggleSelect(cell.y,lastRow);
+				lastRow=-1;
+				retval=true;
+			} else { // Remember this row as start of range, but don't toggle yet
+				lastRow=cell.y;
+			}
+		} else { // Single row marked
+			lastRow=-1;
+		}
+		return retval;
+	}
+
+	/** Select a range of rows */
+	private void toggleSelect(int fromRow, int toRow) {
+		tcTbJourneyList.clearSelection(null);
+		tcTbJourneyList.addToSelection(new Rect(0,fromRow,numCols,toRow-fromRow+1),false,true);
+	}
+	
+	/**
+	 * Return the column widths as a comma delimited string for storing in the preferences
+	 * @return
+	 */
+	private String getColWidths() {
+		// Update the list with the current widths
+		for (int col=0; col<numCols; col++) {
+			colWidth[columnMap[col]]=getColWidth(col);
+		}
+		// Convert to string
+		StringBuffer sb=new StringBuffer(40);
+		for (int i=0; i<colWidth.length; i++) {
+			if (sb.length()!=0) sb.append(',');
+			sb.append(colWidth[i]);
+		}
+		return sb.toString();
+	}
+}
+
+//==============================================================
+//tbListControl
+//==============================================================
+class tbListControl extends TableControl {
+	private MenuItem mnuNewTB, mnuDeleteTB,mnuGetMission,mnuOpenOnline,mnuDropTB,mnuPickupTB,mnuDeleteTBs;
+	public MenuItem mnuToggleList;
+	private Menu mnuFullMenu,mnuDeleteMenu;
+	
+	tbListControl() {
+		MenuItem[] TBMenuItems=new MenuItem[10];
+		TBMenuItems[0]= mnuPickupTB = new MenuItem(MyLocale.getMsg(6040,"Pick up TB from current cache"));
+		TBMenuItems[1]= mnuDropTB = new MenuItem(MyLocale.getMsg(6041,"Drop TB in cache"));
+		TBMenuItems[2]= new MenuItem("-");
+		TBMenuItems[3]= mnuNewTB = new MenuItem(MyLocale.getMsg(6042,"New Travelbug"));
+		TBMenuItems[4]= mnuDeleteTB = new MenuItem(MyLocale.getMsg(6043,"Delete Travelbug"));
+		TBMenuItems[5]= new MenuItem("-");
+		TBMenuItems[6]= mnuGetMission = new MenuItem(MyLocale.getMsg(6044,"Get Mission"));
+		TBMenuItems[7]= mnuOpenOnline = new MenuItem(MyLocale.getMsg(6045,"Open on-line"));
+		TBMenuItems[8]= new MenuItem("-");
+		TBMenuItems[9]= mnuToggleList = new MenuItem(MyLocale.getMsg(6046,"Show only not logged"));
+		mnuFullMenu=new Menu(TBMenuItems,"");
+		// A second pop-up menu with only one entry, if a range of rows is selected
+		MenuItem[] TBMenuItemsDel=new MenuItem[1];
+		TBMenuItemsDel[0]=mnuDeleteTBs=new MenuItem(MyLocale.getMsg(6047,"Delete selected Travelbugs"));
+		mnuDeleteMenu=new Menu(TBMenuItemsDel,"");
+		mnuDropTB.modifiers|=MenuItem.Disabled;
+		mnuDeleteTB.modifiers|=MenuItem.Disabled;
+		mnuGetMission.modifiers|=MenuItem.Disabled;
+		mnuOpenOnline.modifiers|=MenuItem.Disabled;
+	}
+	
+	public void onEvent(Event ev) {
+		Rect sel=getSelection(null);
+		if (sel.y<tblMyTravelbugJourneys.size()) {
+			mnuDeleteTB.modifiers&=~MenuItem.Disabled;
+			mnuGetMission.modifiers&=~MenuItem.Disabled;
+			mnuOpenOnline.modifiers&=~MenuItem.Disabled;
+			if (tblMyTravelbugJourneys.getTBJourney(sel.y).inMyPosession()) 
+				mnuDropTB.modifiers&=~MenuItem.Disabled;
+			else
+				mnuDropTB.modifiers|=MenuItem.Disabled;
+		} else {
+			mnuDeleteTB.modifiers|=MenuItem.Disabled;
+			mnuGetMission.modifiers|=MenuItem.Disabled;
+			mnuOpenOnline.modifiers|=MenuItem.Disabled;
+		}
+		// If more than one row is selected, show the limited pop-up menu
+		if (sel.height>1)
+			setMenu(mnuDeleteMenu);
+		else
+			setMenu(mnuFullMenu);
+	    if (ev instanceof PenEvent) modTbJourneyList.penEventModifiers=((PenEvent)ev).modifiers;
+		super.onEvent(ev);
+	}
+
+	public void penRightReleased(Point p){
+		menuState.doShowMenu(p,true,null); // direct call (not through doMenu) is neccesary because it will exclude the whole table
+	}
+
+	public void penHeld(Point p){
+		menuState.doShowMenu(p,true,null); 
+	}
+
+	public void popupMenuEvent(Object selectedItem){
+		if (selectedItem==mnuPickupTB) {
+			Travelbug tb=TravelbugPickup.pickupTravelbug(tblSrcCache);	
+			if (tb!=null) {
+				chDmodified=true;
+				tblMyTravelbugJourneys.addTbPickup(tb,Global.getProfile().name,waypoint);
+				modTbJourneyList.numRows=tblMyTravelbugJourneys.size();
+				tcTbJourneyList.repaint();
+			}
+		}
+		if (selectedItem==mnuDropTB) {
+			if (selectedRow>=0 && selectedRow<modTbJourneyList.numRows) {
+				Travelbug tb=tblMyTravelbugJourneys.getTBJourney(selectedRow).getTb();
+				chD.Travelbugs.add(tb);
+				tblMyTravelbugJourneys.addTbDrop(tb,Global.getProfile().name,waypoint);
+				chDmodified=true;
+				ch.has_bug=true;
+			}
+			repaint();
+		}
+		if (selectedItem==mnuNewTB) {
+			TravelbugJourney tbj=new TravelbugJourney("New");
+			tbj.setFromProfile(Global.getProfile().name);
+			tbj.setFromWaypoint(waypoint);
+			tblMyTravelbugJourneys.add(tbj);
+			modTbJourneyList.numRows=tblMyTravelbugJourneys.size();
+			cursorTo(tblMyTravelbugJourneys.size()-1,1,true);
+			tcTbJourneyList.repaint();
+		}
+		if (selectedItem==mnuDeleteTB && selectedRow>=0) {
+			tblMyTravelbugJourneys.remove(selectedRow);
+			modTbJourneyList.numRows=tblMyTravelbugJourneys.size();
+			if (selectedRow>0) 
+				cursorTo(selectedRow-1,0,true);
+			else
+				modTbJourneyList.showFields(new TravelbugJourney(""));
+			tcTbJourneyList.repaint();
+		}
+		/* Delete a group of travelbugs which have been marked with Shift-Click */
+		if (selectedItem==mnuDeleteTBs) {  
+			Rect sel=getSelection(null);
+			for (int i=0; i<sel.height; i++)
+				tblMyTravelbugJourneys.remove(sel.y);
+			modTbJourneyList.numRows=tblMyTravelbugJourneys.size();
+			if (sel.y<modTbJourneyList.numRows) 
+				cursorTo(sel.y,0,true);
+			else
+				modTbJourneyList.showFields(new TravelbugJourney(""));
+			tcTbJourneyList.repaint();
+		}
+		if (selectedItem==mnuGetMission && selectedRow>-1) {
+			TravelbugJourney tbj=tblMyTravelbugJourneys.getTBJourney(selectedRow);
+			SpiderGC spider=new SpiderGC(Global.getPref(),Global.getProfile(),false);
+			Vm.showWait(true);
+			// First check whether ID is set, if not get it
+			if (tbj.getTb().getGuid().length()==0) tbj.getTb().setGuid(spider.getBugId(tbj.getTb().getName().trim()));
+			// If we have an ID, we can get the mission
+			if (tbj.getTb().getGuid().length()!=0) 
+				tbj.getTb().setMission(spider.getBugMissionByGuid(tbj.getTb().getGuid()));
+			Vm.showWait(false);
+			tcTbJourneyList.repaint();
+			txtMission.setHtml(tbj.getTb().getMission());
+			lblId.setText(tbj.getTb().getGuid());
+			lowerpane.repaint();
+		}
+		if (selectedItem==mnuOpenOnline && selectedRow>=0) {
+			TravelbugJourney tbj=tblMyTravelbugJourneys.getTBJourney(selectedRow);
+			SpiderGC spider=new SpiderGC(Global.getPref(),Global.getProfile(),false);
+			Vm.showWait(true);
+			// First check whether ID is set, if not get it
+			if (tbj.getTb().getGuid().length()==0) tbj.getTb().setGuid(spider.getBugId(tbj.getTb().getName()));
+			if (tbj.getTb().getGuid().length()!=0) {
+				Vm.showWait(false);
+				try {
+					String s;
+					if (tbj.getTb().getGuid().length()>10)
+						s = "\""+Global.getPref().browser+"\" \"http://www.geocaching.com/track/details.aspx?guid="+tbj.getTb().getGuid()+"\"";
+					else
+						s = "\""+Global.getPref().browser+"\" \"http://www.geocaching.com/track/details.aspx?id="+tbj.getTb().getGuid()+"\"";
+									
+					Vm.exec(s);
+					Global.getPref().log("Executing: "+s); 
+				} catch (Exception ioex) {
+				}
+			}
+		}
+		if (selectedItem==mnuToggleList) {
+			toggleNonLogged();
+		}
+		updateNumBugs();
+	}
+	
+	/** Toggle between displaying all journeys or just those which still need to be logged */
+	public void toggleNonLogged() {
+		mnuToggleList.modifiers^=MenuItem.Checked;
+		if ((mnuToggleList.modifiers & MenuItem.Checked) == MenuItem.Checked) {
+			// First sort the non-logged items to the top
+			tblMyTravelbugJourneys.sort(TravelbugJourney.BOTHLOGGED, false);
+			// 		modListTable.numRows=tblMyTravelbugJourneys.size();
+			modTbJourneyList.numRows=tblMyTravelbugJourneys.countNonLogged();
+		} else {
+			modTbJourneyList.numRows=tblMyTravelbugJourneys.size();
+		}
+		tcTbJourneyList.repaint();
+	}
+	
+	
+	public void cursorTo(int row,int col,boolean selectNew) {
+		TravelbugJourney tbj;
+		super.cursorTo(row,col,selectNew);
+		selectedRow=row;
+		if (row>=0) { 
+			modTbJourneyList.showFields(tbj=tblMyTravelbugJourneys.getTBJourney(row));
+		} else {
+			modTbJourneyList.showFields(new TravelbugJourney(""));
+		}
+	}
+}
+
+}

Added: trunk/src/CacheWolf/TravelbugList.java
===================================================================
--- trunk/src/CacheWolf/TravelbugList.java	2007-08-26 12:22:01 UTC (rev 833)
+++ trunk/src/CacheWolf/TravelbugList.java	2007-08-26 12:43:34 UTC (rev 834)
@@ -0,0 +1,143 @@
+package CacheWolf;
+/**
+ * A list of GC travelbugs
+ * @author salzkammergut
+ */
+import ewe.util.Vector;
+import ewe.io.*;
+import ewesoft.xml.*;
+import ewesoft.xml.sax.*;
+
+public class TravelbugList extends MinML{
+
+	/** The Vector containing the Travelbug objects */
+	private Vector tbList=new Vector(10);
+	
+	/** Get the travelbug at a certain position in the list */
+	public Travelbug getTB(int i) {
+		return (Travelbug) tbList.elementAt(i);
+	}
+	
+	/** Return the size of the list */
+	public int size() {
+		return tbList.size();
+	}
+	
+	/** Clear the travelbug list */
+	public void clear() {
+		tbList.clear();
+	}
+
+	/** Add a travelbug to the list */
+	public void add(Travelbug tb) {
+		tbList.add(tb);
+	}
+	
+	/** Trmove a travelbug from the list */
+	public void remove(int i) {
+		tbList.removeElementAt(i);
+	}
+	
+	/** Construct an empty travelbug list */
+	public TravelbugList() {
+	}
+	
+	/** Convert the old representation to a new one. In the old representation,
+	 * all travelbugs were stored as one HTML string within the cache.xml file.
+	 * This representation does not include the id or guid and does not allow for
+	 * unique identification of the travelbug (Several travelbugs with identical
+	 * names may exist, so the id/guid must be stored to uniquely identify the travelbug. 
+	 * All TBs are stored as one HTML string <b>Name:</b>name_of_tb<br>mission<hr>
+	 */
+	public void addFromHTML(String htmlList) {
+		int fnd;
+		fnd=htmlList.indexOf("<b>Name:</b>");
+		while(fnd>=0) {
+			int fnd2=htmlList.indexOf("<br>",fnd+12);
+			int fnd3=htmlList.indexOf("<b>Name:</b>",fnd2+4);
+			Travelbug tb=new Travelbug(htmlList.substring(fnd+12,fnd2));
+			String mission;
+			if (fnd3>0) {
+				mission=htmlList.substring(fnd2+4,fnd3);
+			} else {
+				mission=htmlList.substring(fnd2+4);
+			}
+			if (mission.endsWith("<hr>")) mission=mission.substring(0,mission.length()-4);
+			tb.setMission(mission);
+			tbList.add(tb);
+			fnd=fnd3;
+		}
+	}
+	
+	/** Return list of travelbugs in HTML representation */
+	public String toHtml() {
+		int size=tbList.size();
+		StringBuffer s=new StringBuffer(size*300);
+		for (int i=0; i<size; i++) {
+			s.append(getTB(i).toHtml());
+		}
+		return s.toString();
+	}
+
+	/** Return list of travelbugs in XML representation */
+	public String toXML() {
+		int size=tbList.size();
+		StringBuffer s=new StringBuffer(size*300);
+		s.append("<TRAVELBUGS>\n");
+		for (int i=0; i<size; i++) {
+			s.append(getTB(i).toXML());
+		}
+		s.append("</TRAVELBUGS>\n");
+		return s.toString();
+	}
+	
+	/*=====================================================================
+	 * The following section implements the XML parser for a travelbug list
+       as contained in the cache.xml file 
+      =====================================================================*/ 	    
+	private String lastName="";
+	private Travelbug tb;
+	private StringBuffer xmlElement=new StringBuffer(200);
+	
+	/** 
+	 * Parse the travelbug part of a cache. The XML String passed as an argument
+	 * must contain the enclosing <TRAVELBUGS> ... </TRAVELBUGS> XML tags. 
+	 */
+	public void addFromXML(String XMLString) {
+		try {
+			parse(new StringReader(XMLString));
+		} catch (Exception e) {
+			if (e instanceof NullPointerException)
+				Global.getPref().log("Error reading cache-travelbug list: NullPointerException in Element "+lastName +". Wrong attribute?",e,true);
+			else 
+				Global.getPref().log("Error reading cache-travelbug list: ", e);
+		};
+	}
+	
+	/**
+	 * Method that gets called when a new element has been identified
+	 */
+	public void startElement(String name, AttributeList atts){
+		lastName=name;
+		if (name.equals("tb")) {
+			tb=new Travelbug(atts.getValue("guid"),"","");
+		}
+	}
+
+	public void characters( char ch[], int start, int length ) {
+			xmlElement.append(ch,start,length); // Collect the mission or the name
+	}	
+
+	public void endElement(String tag){
+		if (tag.equals("tb")) {
+			tb.setMission(xmlElement.toString());
+			tbList.add(tb);
+			xmlElement.delete(0,xmlElement.length());
+		}
+		if (tag.equals("name")) {
+			tb.setName(xmlElement.toString());
+			xmlElement.delete(0,xmlElement.length());
+		}
+	}
+
+}

Added: trunk/src/CacheWolf/TravelbugPickup.java
===================================================================
--- trunk/src/CacheWolf/TravelbugPickup.java	2007-08-26 12:22:01 UTC (rev 833)
+++ trunk/src/CacheWolf/TravelbugPickup.java	2007-08-26 12:43:34 UTC (rev 834)
@@ -0,0 +1,36 @@
+package CacheWolf;
+
+import ewe.ui.InputBox;
+
+public class TravelbugPickup {
+
+	/**
+	 * Choose a travelbug from those listed in the travelbug list and delete it, if
+	 * the operation was not cancelled.
+	 * @param tbl List of travelbugs from where a bug is picked up
+	 */
+	public static Travelbug pickupTravelbug(TravelbugList tbl) {
+		Travelbug tb=null;
+		TravelbugScreen tbs=new TravelbugScreen(tbl,MyLocale.getMsg(6016,"Pick up travelbug"),true);
+		tbs.execute(); // Select TB to pick up
+		if (tbs.selectedItem>=0) { // Was a TB selected ?
+			// If the returned item is bigger than number of bugs in cache
+			// we have found a new unlisted bug. 
+			if (tbs.selectedItem==tbl.size()) {
+				InputBox ibox=new InputBox(MyLocale.getMsg(6018,"Travelbug name"));
+				String name=ibox.input("",240);
+				if (name==null) return null; // No name given
+				tb=new Travelbug(name);
+			} else { // A bug in the list was chosen
+				tb=tbl.getTB(tbs.selectedItem);
+				// Remove the tb from the list
+				tbl.remove(tbs.selectedItem);
+			}
+			InputBox ibox=new InputBox(MyLocale.getMsg(6019,"Tracking number"));
+			String trackingNo=ibox.input("",240);
+			if (trackingNo==null) trackingNo="";
+			tb.setTrackingNo(trackingNo);
+		}
+		return tb;
+	}
+}

Added: trunk/src/CacheWolf/TravelbugScreen.java
===================================================================
--- trunk/src/CacheWolf/TravelbugScreen.java	2007-08-26 12:22:01 UTC (rev 833)
+++ trunk/src/CacheWolf/TravelbugScreen.java	2007-08-26 12:43:34 UTC (rev 834)
@@ -0,0 +1,76 @@
+package CacheWolf;
+
+import ewe.ui.*;
+
+/**
+ * Choose a travelbug to pick up or drop
+ * @author salzkammergut
+ */ 
+public class TravelbugScreen extends Form {
+	private myList disp;
+	private mButton btCancel,btAccept;
+	/** The index into the list of travelbugs indicating the selected bug */
+	public int selectedItem=-1;
+	
+	/**
+	 * A screen to choose a travelbug from a list of bugs
+	 * @param tbl The list of travelbugs from which to choose
+	 * @param title The title of the screen
+	 * @param allowNew True if a travelbug not on the list can be selected
+	 */
+	TravelbugScreen(TravelbugList tbl, String title,boolean allowNew) {
+		this.setTitle(title);
+		this.setPreferredSize(240, -1);
+		disp=new myList(tbl,allowNew);
+		ScrollBarPanel sbp = new ScrollBarPanel(disp, ScrollBarPanel.NeverShowHorizontalScrollers);
+		this.addLast(sbp);
+		this.addNext(btCancel = new mButton(MyLocale.getMsg(614,"Cancel")),CellConstants.DONTSTRETCH, CellConstants.FILL);
+		this.addLast(btAccept = new mButton("OK"),CellConstants.DONTSTRETCH, CellConstants.FILL);
+		btAccept.modify(Disabled,0);
+	}
+
+	public void onEvent(Event ev){
+        if (ev instanceof ListEvent && ev.type==ListEvent.SELECTED) {
+        	btAccept.modify(0,Disabled);
+        	btAccept.repaint();
+        }
+		if(ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED){
+			if (ev.target == btCancel){
+				this.close(0);
+			}
+			if (ev.target == btAccept){
+				this.close(0);
+				selectedItem=disp.getSelectedIndex(0);
+			}
+		}
+	}
+
+	private class myList extends SimpleList {
+		private TravelbugList tbl;
+		private boolean allowNew;
+		private int size; 
+		myList(TravelbugList tbl,boolean allowNew) {
+			this.tbl=tbl;
+			this.size=tbl.size();
+			this.allowNew=allowNew;
+		}
+		
+		public Object getObjectAt(int idx) {
+			return getDisplayItem(idx);		
+		}
+		public int getItemCount() {
+			return tbl.size()+ (allowNew?1:0);
+		}
+		public String getDisplayItem(int idx) {
+			if (idx==size)
+				return MyLocale.getMsg(6015,"*** OTHER ***");
+			else if (tbl.getTB(idx).getName().indexOf("&#")<0)
+				return tbl.getTB(idx).getName();
+			else // If the name contains HTML entities, we need to convert it back
+				return SafeXML.cleanback(tbl.getTB(idx).getName());
+		}
+	}
+
+
+
+}



From salzkammergut at mail.berlios.de  Sun Aug 26 17:10:09 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 26 Aug 2007 17:10:09 +0200
Subject: [Cachewolf-svn] r835 - in trunk: resources src/CacheWolf
Message-ID: <200708261510.l7QFA9O7016584@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-26 17:09:56 +0200 (Sun, 26 Aug 2007)
New Revision: 835

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/MainMenu.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/SpiderGC.java
   trunk/src/CacheWolf/TablePanel.java
   trunk/src/CacheWolf/myTableControl.java
   trunk/src/CacheWolf/myTableModel.java
Log:
Feature: Die Spalten der Listenansicht koennen beliebig ein-/ausgeblendet werden und auch in beliebiger
Reihenfolge angeordnet werden. Bein Verlassen der Praeferenzen mittels Button Anwenden, werden die Aenderungen
sofort wirksam. Der PraeferenzenScreen wurde neu strukturiert (schon in vorigem Release begonnen).

Achtung: Wenn die Auswahlbox in der Listenansicht ausgeblendet wird, verschwinden auch einige Optionen aus dem Kontextmenue


Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-08-26 12:43:34 UTC (rev 834)
+++ trunk/resources/cachewolf.Languages.cfg	2007-08-26 15:09:56 UTC (rev 835)
@@ -137,6 +137,11 @@
 		351=Notizen hinzuf%fcgen/%e4ndern
 		400=Dekodieren
 		500=Umschalten
+		595=Liste
+		596=Name
+		597=Wegpunkt
+		598=Type
+		599=Auswahlbox
 		600=Pr%e4ferenzen
 		601=Dein Alias:
 		602=Heimatkoordinaten:
@@ -170,6 +175,7 @@
 		630=Hinweise/Logs:  Logs pro Seite
 		631=PDA hat Schliessen Button 
 		632=Mehr
+		633=Max. logs spidern
 		700=Filter setzen
 		701=Entfernung
 		702=Schwierigkeit
@@ -658,6 +664,11 @@
 		351=Add/Edit notes
 		400=Dekode
 		500=Switch
+		595=List
+		596=Name
+		597=Waypoint
+		598=Type
+		599=Checkbox
 		600=Preferences
 		601=Your alias:
 		602=Home coordinates:
@@ -691,6 +702,7 @@
 		630=HintLogPanel:  Logs per page 
 		631=PDA has close Button
 		632=More
+		633=Max. logs to spider
 		700=Set filter
 		701=Distance
 		702=Difficulty

Modified: trunk/src/CacheWolf/MainMenu.java
===================================================================
--- trunk/src/CacheWolf/MainMenu.java	2007-08-26 12:43:34 UTC (rev 834)
+++ trunk/src/CacheWolf/MainMenu.java	2007-08-26 15:09:56 UTC (rev 835)
@@ -428,6 +428,7 @@
 			}
 			if(mev.selectedItem == exit){
 				Global.mainTab.saveUnsavedChanges(true);
+				tbp.saveColWidth(pref);
 				ewe.sys.Vm.exit(0);
 			}
 

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-08-26 12:43:34 UTC (rev 834)
+++ trunk/src/CacheWolf/Preferences.java	2007-08-26 15:09:56 UTC (rev 835)
@@ -17,9 +17,6 @@
  */
 public class Preferences extends MinML{
 
-	public int tablePrefs[] = {1,1,1,1,1,1,1,1,1,1,1,1};
-	public int tableWidth[] = {20,20,20,25,92,177,144,83,60,105,50,104,50};
-
 	static protected final int PROFILE_SELECTOR_FORCED_ON=0;
 	static protected final int PROFILE_SELECTOR_FORCED_OFF=1;
 	static protected final int PROFILE_SELECTOR_ONOROFF=2;
@@ -48,7 +45,8 @@
 
 	public int myAppHeight = 0;
 	public int myAppWidth = 0;
-	//public int nLogs = 5;
+	public final int DEFAULT_MAX_LOGS_TO_SPIDER=250;
+	public int maxLogsToSpider = DEFAULT_MAX_LOGS_TO_SPIDER;
 	public boolean dirty = false;
 
 	public String garminConn="com1";  // The type of connection which GPSBABEL uses: com1 OR usb.
@@ -334,10 +332,6 @@
 			if (atts.getValue("autoreload").equals("true")) autoReloadLastProfile=true;
 		}
 
-		//if(name.equals("datadir")) {
-		//mydatadir = atts.getValue("dir");
-		//profile.dataDir=mydatadir;
-		//}
 		if(name.equals("basedir")) {
 			baseDir = atts.getValue("dir");
 		}
@@ -347,6 +341,10 @@
 			downloadmissingOC = Boolean.valueOf(atts.getValue("downloadmissing")).booleanValue();
 
 		}
+		if (name.equals("listview")) {
+			listColMap=atts.getValue("colmap");
+			listColWidth=atts.getValue("colwidths");	
+		}
 		if(name.equals("proxy")) {
 			myproxy = atts.getValue("prx");
 			myproxyport = atts.getValue("prt");
@@ -356,61 +354,6 @@
 			tmp = atts.getValue("GPSBabelOptions");
 			if (tmp != null) garminGPSBabelOptions=tmp;
 		}
-		if(name.equals("tableType")){ 
-			tablePrefs[1] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[1] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableD")){
-			tablePrefs[2] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[2] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableT")){
-			tablePrefs[3] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[3] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableWay")) {
-			tablePrefs[4] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[4] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableName")){
-			tablePrefs[5] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[5] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableLoc")){
-			tablePrefs[6] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[6] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableOwn")){
-			tablePrefs[7] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[7] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableHide")){
-			tablePrefs[8] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[8] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableStat")){
-			tablePrefs[9] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[9] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableDist")){
-			tablePrefs[10] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[10] = Convert.parseInt(tmp);
-		}
-		if(name.equals("tableBear")){
-			tablePrefs[11] = Convert.parseInt(atts.getValue("active"));
-			tmp = atts.getValue("width");
-			if (tmp != null) tableWidth[11] = Convert.parseInt(tmp);
-		}
 		if (name.equals("imagepanel")) {
 			showDeletedImages = Boolean.valueOf(atts.getValue("showdeletedimages")).booleanValue();
 		}
@@ -425,6 +368,8 @@
 			logsPerPage = Convert.parseInt(atts.getValue("logsperpage"));
 			String strInitialHintHeight=atts.getValue("initialhintheight");
 			if (strInitialHintHeight!=null) initialHintHeight=Convert.parseInt(strInitialHintHeight);
+			String strMaxLogsToSpider=atts.getValue("maxspiderlogs");
+			if (strMaxLogsToSpider!=null) maxLogsToSpider=Convert.parseInt(strInitialHintHeight);
 		}
 		if (name.equals("solver")) {
 			solverIgnoreCase=Boolean.valueOf(atts.getValue("ignorevariablecase")).booleanValue();
@@ -444,8 +389,7 @@
 		}
 	}
 
-	public void characters( char ch[], int start, int length )
-	{
+	public void characters( char ch[], int start, int length ) {
 		if (collectElement!=null) {
 			collectElement.append(ch,start,length); // Collect the name of the last profile
 		}
@@ -473,44 +417,24 @@
 			PrintWriter outp =  new PrintWriter(new BufferedWriter(new FileWriter(datei)));
 			outp.print("<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?>\n");
 			outp.print("<preferences>\n");
+			outp.print("	<basedir dir = \""+ baseDir +"\"/>\n");
+			outp.print("    <lastprofile autoreload=\""+autoReloadLastProfile+"\">"+lastProfile+"</lastprofile>\n"); //RB
 			outp.print("	<alias name =\""+ SafeXML.clean(myAlias) +"\"/>\n");
 			outp.print("	<alias2 name =\""+ SafeXML.clean(myAlias2) +"\"/>\n");
-			outp.print("	<basedir dir = \""+ baseDir +"\"/>\n");
+			outp.print("	<browser name = \""+browser+"\"/>\n");
 			outp.print("	<proxy prx = \""+ myproxy+"\" prt = \""+ myproxyport + "\"/>\n");
 			outp.print("	<port portname = \""+ mySPO.portName +"\" baud = \""+ mySPO.baudRate+"\"/>\n");
 			outp.print("	<portforward active= \""+ Convert.toString(forwardGPS)+"\" destinationHost = \""+ forwardGpsHost+"\"/>\n");
-			outp.print("	<tableType active = \"1\" width = \""+Convert.toString(tableWidth[1])+"\"/>\n");
-			outp.print("	<tableD active = \""+Convert.toString(tablePrefs[2])+ "\"" +
-					" width = \""+Convert.toString(tableWidth[2])+"\"/>\n");
-			outp.print("	<tableT active = \""+Convert.toString(tablePrefs[3])+ "\"" +
-					" width = \""+Convert.toString(tableWidth[3])+"\"/>\n");
-			outp.print("	<tableWay active = \"1\" width = \""+Convert.toString(tableWidth[4])+"\"/>\n");
-			outp.print("	<tableName active = \"1\" width = \""+Convert.toString(tableWidth[5])+"\"/>\n");
-			outp.print("	<tableLoc active = \""+Convert.toString(tablePrefs[6])+ "\"" +
-					" width = \""+Convert.toString(tableWidth[6])+"\"/>\n");
-			outp.print("	<tableOwn active = \""+Convert.toString(tablePrefs[7])+ "\"" +
-					" width = \""+Convert.toString(tableWidth[7])+"\"/>\n");
-			outp.print("	<tableHide active = \""+Convert.toString(tablePrefs[8])+ "\"" +
-					" width = \""+Convert.toString(tableWidth[8])+"\"/>\n");
-			outp.print("	<tableStat active = \""+Convert.toString(tablePrefs[9])+ "\"" +
-					" width = \""+Convert.toString(tableWidth[9])+"\"/>\n");
-			outp.print("	<tableDist active = \""+Convert.toString(tablePrefs[10])+ "\"" +
-					" width = \""+Convert.toString(tableWidth[10])+"\"/>\n");
-			outp.print("	<tableBear active = \""+Convert.toString(tablePrefs[11])+ "\"" +
-					" width = \""+Convert.toString(tableWidth[11])+"\"/>\n");
 			outp.print("    <font size =\""+fontSize+"\"/>\n");
-			outp.print("	<browser name = \""+browser+"\"/>\n");
-			outp.print("    <fixedsip state = \""+fixSIP+"\"/>\n");
-			outp.print("    <garmin connection = \""+garminConn+"\" GPSBabelOptions = \""+garminGPSBabelOptions+"\" />\n");
-			outp.print("    <lastprofile autoreload=\""+autoReloadLastProfile+"\">"+lastProfile+"</lastprofile>\n"); //RB
 			outp.print("    <screen menuattop=\""+menuAtTop+"\" tabsattop=\""+tabsAtTop+"\" showstatus=\""+showStatus+"\" hasclosebutton=\""+hasCloseButton+"\"/>\n");
+			outp.print("    <fixedsip state = \""+fixSIP+"\"/>\n");
+			outp.print("    <listview colmap=\""+listColMap+"\" colwidths=\""+listColWidth+"\" />\n");
+			outp.print("    <travelbugs colmap=\""+travelbugColMap+"\" colwidths=\""+travelbugColWidth+"\" shownonlogged=\""+travelbugShowOnlyNonLogged+"\" />\n");
 			outp.print("    <imagepanel showdeletedimages=\""+showDeletedImages+"\"/>\n");
-			outp.print("    <hintlogpanel logsperpage=\""+logsPerPage+"\" initialhintheight=\""+initialHintHeight+"\"/>\n");
+			outp.print("    <hintlogpanel logsperpage=\""+logsPerPage+"\" initialhintheight=\""+initialHintHeight+"\"  maxspiderlogs=\""+maxLogsToSpider+"\" />\n");
 			outp.print("    <solver ignorevariablecase=\""+solverIgnoreCase+"\"/>\n");
-			//outp.print("    <maps ")
+			outp.print("    <garmin connection = \""+garminConn+"\" GPSBabelOptions = \""+garminGPSBabelOptions+"\" />\n");
 			outp.print("    <opencaching downloadPicsOC=\""+downloadPicsOC+"\" downloadMaps=\""+downloadMapsOC+"\" downloadMissing=\""+downloadmissingOC+"\"/>\n");
-			// Obsolete data kept for backward compatibility
-			//outp.print("	<syncOC date = \"" + last_sync_opencaching + "\" dist = \"" + distOC +  "\"/>\n");
 			outp.print("	<location lat = \""+curCentrePt.getLatDeg(CWPoint.DD)+"\" long = \""+curCentrePt.getLonDeg(CWPoint.DD)+"\"/>\n");
 			if (customMapsPath!=null) outp.print("	<mapspath dir = \""+ customMapsPath +"\"/>\n");
 			if (debug) outp.print("    <debug value=\"true\" />\n"); // Keep the debug switch if it is set
@@ -521,7 +445,6 @@
 				entry = (MapEntry) itPath.next();
 				outp.print("    <expPath key = \"" + entry.getKey().toString() + "\" value = \"" + entry.getValue().toString().replace('\\', '/') + "\"/>\n");
 			}
-			outp.print("  <travelbugs colmap=\""+travelbugColMap+"\" colwidths=\""+travelbugColWidth+"\" shownonlogged=\""+travelbugShowOnlyNonLogged+"\" />\n");
 			outp.print("</preferences>");
 			outp.close();
 		} catch (Exception e) {

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-08-26 12:43:34 UTC (rev 834)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-08-26 15:09:56 UTC (rev 835)
@@ -15,7 +15,8 @@
 public class PreferencesScreen extends Form {
 	mButton cancelB, applyB, brwBt, gpsB,btnCentre;
 	mChoice NS, EW;
-	mInput NSDeg, NSm, EWDeg, EWm, DataDir, Proxy, ProxyPort, Alias, nLogs, Browser, fontSize, inpGPS, inpLogsPerPage;
+	mInput NSDeg, NSm, EWDeg, EWm, DataDir, Proxy, ProxyPort, Alias, nLogs, Browser, fontSize, inpGPS, 
+	       inpLogsPerPage,inpMaxLogsToSpider;
 	mCheckBox dif, ter, loc, own, hid, stat, dist, bear, chkAutoLoad, chkShowDeletedImg, chkMenuAtTop, 
 	          chkTabsAtTop, chkShowStatus,chkHasCloseButton,chkSynthShort;
 	mTabbedPanel mTab;
@@ -98,12 +99,6 @@
 		// Second panel - Screen
 		/////////////////////////////////////////////////////////
 		
-/*		CellPanel pnlFont=new CellPanel();
-		pnlFont.addNext(new mLabel("Font"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		pnlFont.addLast(fontSize = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
-		fontSize.setText(Convert.toString(pref.fontSize));
-		pnlDisplay.addLast(pnlFont);
-*/		
 		Frame frmScreen=new Frame();
 		frmScreen.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER;
 		mLabel lblTitle;
@@ -139,17 +134,19 @@
 		pnlDisplay.addLast(frmImages,CellConstants.STRETCH,CellConstants.FILL);
 
 		Frame frmHintLog=new Frame();
-		frmHintLog.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
-        mLabel lblHlP;
-		frmHintLog.addNext(lblHlP=new mLabel(MyLocale.getMsg(630,"HintLogPanel:  Logs per page ")));	
-		frmHintLog.addLast(inpLogsPerPage=new mInput(),CellConstants.DONTSTRETCH,CellConstants.DONTFILL|CellConstants.WEST);
+		//frmHintLog.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
+		frmHintLog.addNext(new mLabel(MyLocale.getMsg(630,"HintLogPanel:  Logs per page ")),CellConstants.DONTSTRETCH,CellConstants.DONTFILL);	
+		frmHintLog.addLast(inpLogsPerPage=new mInput(),CellConstants.DONTSTRETCH,CellConstants.DONTFILL|CellConstants.EAST);
 		inpLogsPerPage.setText(Convert.toString(pref.logsPerPage));
 		inpLogsPerPage.setPreferredSize(40,-1);
-		inpLogsPerPage.setTag(INSETS,new Insets(0,0,2,0));
-		lblHlP.setTag(INSETS,new Insets(6,0,2,0));
+		//inpLogsPerPage.setTag(INSETS,new Insets(0,0,2,0));
+		//lblHlP.setTag(INSETS,new Insets(6,0,2,0));
+		frmHintLog.addNext(new mLabel(MyLocale.getMsg(633,"Max. logs to spider")),CellConstants.DONTSTRETCH,CellConstants.DONTFILL);	
+		frmHintLog.addLast(inpMaxLogsToSpider=new mInput(),CellConstants.DONTSTRETCH,CellConstants.DONTFILL|CellConstants.EAST);
+		inpMaxLogsToSpider.setText(Convert.toString(pref.maxLogsToSpider));
+		inpMaxLogsToSpider.setPreferredSize(40,-1);
 		pnlDisplay.addLast(frmHintLog,CellConstants.STRETCH,CellConstants.FILL);
 
-		pnlDisplay.addLast(new mLabel(""));
 		/////////////////////////////////////////////////////////
 		// Third panel - More
 		/////////////////////////////////////////////////////////
@@ -159,46 +156,31 @@
 		Proxy.setText(pref.myproxy);
 		pnlProxy.addNext(new mLabel("Port"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		pnlProxy.addNext(ProxyPort = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		ProxyPort.setText(pref.myproxyport);
 		pnlProxy.addLast(new mLabel("")).setTag(SPAN,new Dimension(2,1));
 		pnlMore.addLast(pnlProxy,HSTRETCH,HFILL);
 		
-		ProxyPort.setText(pref.myproxyport);
-		Frame frmDisplay=new Frame();
-		frmDisplay.borderStyle=CellPanel.BDR_RAISEDOUTER|CellPanel.BDR_SUNKENINNER|CellPanel.BF_BOTTOM;
-		frmDisplay.addLast(new mLabel(MyLocale.getMsg(605,"Display Preferences")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		frmDisplay.addNext(dif = new mCheckBox(MyLocale.getMsg(606,"Difficulty")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if(pref.tablePrefs[2] == 1) dif.setState(true);
-		frmDisplay.addNext(ter = new mCheckBox(MyLocale.getMsg(607,"Terrain")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if(pref.tablePrefs[3] == 1) ter.setState(true);
-		frmDisplay.addLast(loc = new mCheckBox(MyLocale.getMsg(608,"Location")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if(pref.tablePrefs[6] == 1) loc.setState(true);
-		frmDisplay.addNext(own = new mCheckBox(MyLocale.getMsg(609,"Owner")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if(pref.tablePrefs[7] == 1) own.setState(true); 
-		frmDisplay.addNext(hid = new mCheckBox(MyLocale.getMsg(610,"Hidden")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if(pref.tablePrefs[8] == 1) hid.setState(true);
-		frmDisplay.addLast(stat = new mCheckBox(MyLocale.getMsg(611,"Status")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if(pref.tablePrefs[9] == 1) stat.setState(true);
-		frmDisplay.addNext(dist = new mCheckBox(MyLocale.getMsg(612,"Distance")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if(pref.tablePrefs[10] == 1) dist.setState(true);
-		frmDisplay.addLast(bear = new mCheckBox(MyLocale.getMsg(613,"Bearing")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		if(pref.tablePrefs[11] == 1) bear.setState(true);
-		dist.setTag(INSETS,new Insets(0,0,2,0));
-		bear.setTag(INSETS,new Insets(0,0,2,0));
-		pnlMore.addLast(frmDisplay,CellConstants.STRETCH,CellConstants.FILL);
-
 		/////////////////////////////////////////////////////////
-		// Fourth panel - Travelbugs
+		// Fourth/Fifth panel - Listview and Travelbugs
 		/////////////////////////////////////////////////////////
 
-		
         mTab.addCard(pnlGeneral,MyLocale.getMsg(621,"General"),null);
 		mTab.addCard(pnlDisplay,MyLocale.getMsg(622,"Screen"),null);
 		mTab.addCard(pnlMore,MyLocale.getMsg(632,"More"),null);
-		/*mTab.addCard(tccList=new TableColumnChooser(new String[] {
-				"checkbox","type","difficulty","terrain",
-				"waypoint","name","coords","owner",
-				"date hidden","status","distance","bearing"},pref.listColMap),"List",null);
-		*/
+		mTab.addCard(tccList=new TableColumnChooser(new String[] {
+				MyLocale.getMsg(599,"checkbox"),
+				MyLocale.getMsg(598,"type"),
+				MyLocale.getMsg(606,"Difficulty"),
+				MyLocale.getMsg(607,"Terrain"),
+				MyLocale.getMsg(597,"waypoint"),
+				MyLocale.getMsg(596,"name"),
+				MyLocale.getMsg(608,"Location"),
+				MyLocale.getMsg(609,"Owner"),
+				MyLocale.getMsg(610,"Hidden"),
+				MyLocale.getMsg(611,"Status"),
+				MyLocale.getMsg(612,"Distance"),
+				MyLocale.getMsg(613,"Bearing")},pref.listColMap),MyLocale.getMsg(595,"List"),null);
+
 		Card c=mTab.addCard(tccBugs=new TableColumnChooser(new String[] {
 				MyLocale.getMsg(6000,"Guid"),
 				MyLocale.getMsg(6001,"Name"),
@@ -232,8 +214,11 @@
 				//}
 				pref.fontSize = Convert.toInt(fontSize.getText());
 				if (pref.fontSize<6) pref.fontSize=12;
-				pref.logsPerPage=Convert.toInt(inpLogsPerPage.getText());
+				pref.logsPerPage=Common.parseInt(inpLogsPerPage.getText());
 				if (pref.logsPerPage==0) pref.logsPerPage=pref.DEFAULT_LOGS_PER_PAGE;
+				pref.maxLogsToSpider=Common.parseInt(inpMaxLogsToSpider.getText());
+				if (pref.maxLogsToSpider==0) pref.maxLogsToSpider=pref.DEFAULT_MAX_LOGS_TO_SPIDER;
+				
 				Font defaultGuiFont = mApp.findFont("gui");
 				int sz = (pref.fontSize);
 				Font newGuiFont = new Font(defaultGuiFont.getName(), defaultGuiFont.getStyle(), sz); 
@@ -247,14 +232,6 @@
 				pref.myproxy = Proxy.getText();
 				pref.myproxyport = ProxyPort.getText();
 				//myPreferences.nLogs = Convert.parseInt(nLogs.getText());
-				pref.tablePrefs[2] = (dif.getState()==true ? 1 : 0);
-				pref.tablePrefs[3] = (ter.getState()==true ? 1 : 0);
-				pref.tablePrefs[6] = (loc.getState()==true ? 1 : 0);
-				pref.tablePrefs[7] = (own.getState()==true ? 1 : 0);
-				pref.tablePrefs[8] = (hid.getState()==true ? 1 : 0);
-				pref.tablePrefs[9] = (stat.getState()==true ? 1 : 0);
-				pref.tablePrefs[10] = (dist.getState()==true ? 1 : 0);
-				pref.tablePrefs[11] = (bear.getState()==true ? 1 : 0);
 				pref.autoReloadLastProfile=chkAutoLoad.getState();
 				pref.showDeletedImages=chkShowDeletedImg.getState();
 				pref.garminConn=chcGarminPort.getSelectedItem().toString();
@@ -264,6 +241,8 @@
 				pref.showStatus=chkShowStatus.getState();
 				pref.hasCloseButton=chkHasCloseButton.getState();
 				pref.travelbugColMap=tccBugs.getSelectedCols();
+				pref.listColMap=tccList.getSelectedCols();
+				Global.mainTab.tbP.myMod.setColumnNamesAndWidths();
 				pref.savePreferences();
 				pref.dirty = true; // Need to update table in case columns were enabled/disabled
 				this.close(0);

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-26 12:43:34 UTC (rev 834)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-26 15:09:56 UTC (rev 835)
@@ -72,6 +72,7 @@
 			// We don't display an error message box here, as the call to 
 			// spiderSingle or doIt will do this
 		}
+		MAXLOGS=pref.maxLogsToSpider;
 	}
 	
 	private boolean existsSpiderDef() {

Modified: trunk/src/CacheWolf/TablePanel.java
===================================================================
--- trunk/src/CacheWolf/TablePanel.java	2007-08-26 12:43:34 UTC (rev 834)
+++ trunk/src/CacheWolf/TablePanel.java	2007-08-26 15:09:56 UTC (rev 835)
@@ -107,13 +107,11 @@
 	}
 	
 	public void saveColWidth(Preferences pref){
-		int j=0;
-		for (int i = 0; i<myMod.MAXCOLUMNS; i++){
-			if(pref.tablePrefs[i] == 1){
-				pref.tableWidth[i] = myMod.getColWidth(j++);
-			}
+		String colWidths=myMod.getColWidths();
+		if (!colWidths.equals(pref.listColWidth)) {
+			pref.listColWidth=colWidths;
+			pref.savePreferences();
 		}
-		pref.savePreferences();
 	}
 	
 	/*

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2007-08-26 12:43:34 UTC (rev 834)
+++ trunk/src/CacheWolf/myTableControl.java	2007-08-26 15:09:56 UTC (rev 835)
@@ -15,26 +15,31 @@
 	public Profile profile;
 	public Vector cacheDB;
 	public TablePanel tbp;
+	private Menu mFull = new Menu(new String[]{
+			MyLocale.getMsg(1021,"Open description"),
+			MyLocale.getMsg(1010,"Goto"),
+			MyLocale.getMsg(1019,"Enter"),
+			"-",
+			MyLocale.getMsg(1020,"Open in $browser online"),
+			MyLocale.getMsg(1018,"Open in browser offline"),
+			"-",
+			MyLocale.getMsg(1011,"Filter"),
+			MyLocale.getMsg(1012,"Delete"),
+			MyLocale.getMsg(1014,"Update"),
+			"-",
+			MyLocale.getMsg(1015,"Select all"),
+			MyLocale.getMsg(1016,"De-select all")},
+			MyLocale.getMsg(1013,"With selection"));
+	private Menu mSmall = new Menu(new String[]{
+			MyLocale.getMsg(1021,"Open description"),
+			MyLocale.getMsg(1010,"Goto"),
+			MyLocale.getMsg(1019,"Enter"),
+			"-",
+			MyLocale.getMsg(1020,"Open in $browser online"),
+			MyLocale.getMsg(1018,"Open in browser offline")},
+			MyLocale.getMsg(1013,"With selection"));
 
 	myTableControl(TablePanel tablePanel) {
-		Menu m = new Menu(new String[]{
-				MyLocale.getMsg(1021,"Open description"),
-				MyLocale.getMsg(1010,"Goto"),
-				MyLocale.getMsg(1019,"Enter"),
-				"-",
-				MyLocale.getMsg(1020,"Open in $browser online"),
-				MyLocale.getMsg(1018,"Open in browser offline"),
-				"-",
-				MyLocale.getMsg(1011,"Filter"),
-				MyLocale.getMsg(1012,"Delete"),
-				MyLocale.getMsg(1014,"Update"),
-				"-",
-				MyLocale.getMsg(1015,"Select all"),
-				MyLocale.getMsg(1016,"De-select all")},
-				MyLocale.getMsg(1013,"With selection"));
-		setMenu(m);
-		if (!Vm.getPlatform().equals("Win32") && !Vm.getPlatform().equals("Java"))
-		   ((MenuItem)m.items.get(5)).modifiers|=MenuItem.Disabled;
 		profile=Global.getProfile();
 		cacheDB = profile.cacheDB;
 		pref = Global.getPref();
@@ -42,6 +47,20 @@
 		allowDragSelection = false; // allow only one row to be selected at one time
 	}
 
+	/** Full menu when listview includes checkbox */
+	public void setMenuFull() {
+		setMenu(mFull);
+		if (!Vm.getPlatform().equals("Win32") && !Vm.getPlatform().equals("Java"))
+		   ((MenuItem)mFull.items.get(5)).modifiers|=MenuItem.Disabled;
+	}
+	
+	/** Small menu when listview does not include checkbox */
+	public void setMenuSmall() {
+		setMenu(mSmall);
+		if (!Vm.getPlatform().equals("Win32") && !Vm.getPlatform().equals("Java"))
+			   ((MenuItem)mSmall.items.get(5)).modifiers|=MenuItem.Disabled;
+	}
+	
 	public void penRightReleased(Point p){
 		if (cacheDB.size()>0) // No context menu when DB is empty
 			menuState.doShowMenu(p,true,null); // direct call (not through doMenu) is neccesary because it will exclude the whole table

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2007-08-26 12:43:34 UTC (rev 834)
+++ trunk/src/CacheWolf/myTableModel.java	2007-08-26 15:09:56 UTC (rev 835)
@@ -26,25 +26,32 @@
 	private static final Color COLOR_SELECTED	= new Color(198,198,198);
 	private static final Color COLOR_ARCHFND_FG	= new Color(255,0,0); // Archived && Found
 	private static final Color COLOR_ARCHFND_BG	= new Color(152,251,152);	
-	Vector cacheDB;
-	String[] colName;
-	int[] colWidth;
-	int [] colID; // The number of the column in the original sequence in the prefs file
-	int usedColumns; // Columns actually used (<=MAXCOLUMNS)
-	static Image cacheImages[] = new Image[454];
-	static Image noFindLogs[] = new Image[4];
-	Image red, blue, green, yellow, skull;
-	mImage bug;
-	myTableControl tcControl;
-	boolean sortAsc = false;
-	int sortedBy = -1;
-	FontMetrics fm;
-	Image checkboxTicked,checkboxUnticked;
+	private Vector cacheDB;
+	/** How the columns are mapped onto the list view. If colMap[i]=j, it means that
+	 * the element j (as per the list below) is visible in column i. 
+	 * [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates, 
+	 * [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing
+	 */
+	private int[] colMap;
+	/** The column widths corresponding to the list of columns above */
+	private int[] colWidth;
+	private String [] colName = {" ","?",MyLocale.getMsg(1000,"D"),MyLocale.getMsg(1001,"T"),MyLocale.getMsg(1002,"Waypoint"),"Name",MyLocale.getMsg(1004,"Location"),MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear")};
+	
+	public static Image cacheImages[] = new Image[454]; // Images are used by TableControl
+	private static Image noFindLogs[] = new Image[4];
+	private Image red, blue, green, yellow, skull;
+	private Image checkboxTicked,checkboxUnticked;
+	private mImage bug;
+	private boolean sortAsc = false;
+	private int sortedBy = -1;
+	private FontMetrics fm;
 	/** This is the modifier (Shift & Control key status) for Pen Events
 	 * it is set in myTableControl.onEvent */
 	public int penEventModifiers; 
 	/** The row of the last click where the shift key was pressed */
 	private int lastRow=-1;
+	private myTableControl tcControl;
+	
 	public myTableModel(myTableControl tc, FontMetrics fm){
 		super();
 		cacheDB = Global.getProfile().cacheDB;
@@ -100,27 +107,34 @@
 	 *
 	 */
 	public void setColumnNamesAndWidths() {
-		String [] spName = {" ","?",MyLocale.getMsg(1000,"D"),MyLocale.getMsg(1001,"T"),MyLocale.getMsg(1002,"Waypoint"),"Name",MyLocale.getMsg(1004,"Location"),MyLocale.getMsg(1005,"Owner"),MyLocale.getMsg(1006,"Hidden"),MyLocale.getMsg(1007,"Status"),MyLocale.getMsg(1008,"Dist"),MyLocale.getMsg(1009,"Bear")};
-		// [0]TickBox, [1]Type, [2]Distance, [3]Terrain, [4]waypoint, [5]name, [6]coordinates, 
-		// [7]owner, [8]datehidden, [9]status, [10]distance, [11]bearing
-		Preferences pref=Global.getPref();
-		colName=new String[MAXCOLUMNS]; // Always dimension to max columns, a few columns could be wasted
-		colWidth=new int[MAXCOLUMNS];
-		colID=new int[MAXCOLUMNS];
-		
-		usedColumns = 0;
-		for(int i = 0; i<MAXCOLUMNS;i++){
-			if(pref.tablePrefs[i] == 1){
-				colName[usedColumns] = spName[i];
-				colWidth[usedColumns] = pref.tableWidth[i];
-				colID[usedColumns]=i;
-				usedColumns++;
-			}
-		}
-		this.numCols = usedColumns;
+		colMap=TableColumnChooser.str2Array(Global.getPref().listColMap,0,11,0);
+		colWidth=TableColumnChooser.str2Array(Global.getPref().listColWidth,10,1024,50);
+		numCols=colMap.length;
 		clearCellAdjustments();
+		// If the displayed columns include the checkbox, we use the full menu
+		if ((","+Global.getPref().listColMap+",").indexOf(",0,")>=0)
+			tcControl.setMenuFull();
+		else
+			tcControl.setMenuSmall();
 	}
 	
+	/**
+	 * Return the column widths as a comma delimited string for storing in the preferences
+	 * @return
+	 */
+	public String getColWidths() {
+		// Update the list with the current widths
+		for (int col=0; col<numCols; col++) {
+			colWidth[colMap[col]]=getColWidth(col);
+		}
+		// Convert to string
+		StringBuffer sb=new StringBuffer(40);
+		for (int i=0; i<colWidth.length; i++) {
+			if (sb.length()!=0) sb.append(',');
+			sb.append(colWidth[i]);
+		}
+		return sb.toString();
+	}
 	public void updateRows(){
 		Vector sortDB = new Vector();
 		Vector filteredDB = new Vector();
@@ -194,8 +208,8 @@
 	public int calculateColWidth(int col){
 		if(col == -1) 
         	return 0;
-        else if (col<usedColumns)
-        	return colWidth[col];
+        else if (col<numCols)
+        	return colWidth[colMap[col]];
         else return 0;
 	}
 	
@@ -211,12 +225,12 @@
 
 	public Object getCellData(int row, int col){
 		if(row == -1) {
-			return (String)colName[col];
+			return (String)colName[colMap[col]];
 		} else {
 			try { // Access to row can fail if many caches are deleted
 				CacheHolder ch = (CacheHolder)cacheDB.get(row);
 				if(ch.is_filtered == false){
-					switch(colID[col]) { // Faster than using column names
+					switch(colMap[col]) { // Faster than using column names
 						case 0: // Checkbox
 							if (ch.is_Checked) 
 								return checkboxTicked; 
@@ -348,4 +362,5 @@
 			}
 		}		
 	}
+	
 }



From salzkammergut at mail.berlios.de  Sun Aug 26 17:41:23 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 26 Aug 2007 17:41:23 +0200
Subject: [Cachewolf-svn] r836 - in trunk: resources src/CacheWolf
Message-ID: <200708261541.l7QFfN8Y017879@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-26 17:41:15 +0200 (Sun, 26 Aug 2007)
New Revision: 836

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
Log:
Feature: PraeferenzenScreen: Passworteingabe
Die Eingabe eines optionalen Passwortes fuer den Spider welches in der pref.xml gespeichert wird ist moeglich.
Wenn kein Passwort angegeben wird, kann es beim Login nachgeliefert werden (wird dann aber nicht in pref.xml gespeichert). 

Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-08-26 15:09:56 UTC (rev 835)
+++ trunk/resources/cachewolf.Languages.cfg	2007-08-26 15:41:15 UTC (rev 836)
@@ -137,6 +137,8 @@
 		351=Notizen hinzuf%fcgen/%e4ndern
 		400=Dekodieren
 		500=Umschalten
+		593=Password ist hier optional.%0aNur eingeben wenn es in pref.xml%0agespeichert werden soll.
+		594=Passwt
 		595=Liste
 		596=Name
 		597=Wegpunkt
@@ -664,6 +666,8 @@
 		351=Add/Edit notes
 		400=Dekode
 		500=Switch
+		593=Password is optional here.%0aEnter only if you want to store it in pref.xml
+		594=Passwd
 		595=List
 		596=Name
 		597=Waypoint

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-08-26 15:09:56 UTC (rev 835)
+++ trunk/src/CacheWolf/Preferences.java	2007-08-26 15:41:15 UTC (rev 836)
@@ -35,6 +35,8 @@
 	public String myproxyport = "";
 	/** This is the login alias for geocaching.com and opencaching.de */
 	public String myAlias = "";
+	/** Optional password */
+	public String password="";
 	/** This is an alternative alias used to identify found caches (i.e. if using multiple IDs) 
 	 *  It is currently not used yet */
 	public String myAlias2 = "";
@@ -314,8 +316,13 @@
 			}
 		}
 		if(name.equals("font")) fontSize = Convert.toInt(atts.getValue("size"));
-		if(name.equals("alias")) myAlias = atts.getValue("name");
-		if(name.equals("alias2")) myAlias2 = atts.getValue("name");
+		if(name.equals("alias")) {
+			myAlias = SafeXML.cleanback(atts.getValue("name"));
+			tmp = SafeXML.cleanback(atts.getValue("password"));
+			if (tmp != null) password=tmp;
+			SpiderGC.passwort=password;
+		}
+		if(name.equals("alias2")) SafeXML.cleanback(myAlias2 = atts.getValue("name"));
 		if(name.equals("location")){
 			curCentrePt.set(atts.getValue("lat")+" "+atts.getValue("long"));
 		}
@@ -419,7 +426,7 @@
 			outp.print("<preferences>\n");
 			outp.print("	<basedir dir = \""+ baseDir +"\"/>\n");
 			outp.print("    <lastprofile autoreload=\""+autoReloadLastProfile+"\">"+lastProfile+"</lastprofile>\n"); //RB
-			outp.print("	<alias name =\""+ SafeXML.clean(myAlias) +"\"/>\n");
+			outp.print("	<alias name =\""+ SafeXML.clean(myAlias) +"\" password=\""+SafeXML.clean(password)+"\" />\n");
 			outp.print("	<alias2 name =\""+ SafeXML.clean(myAlias2) +"\"/>\n");
 			outp.print("	<browser name = \""+browser+"\"/>\n");
 			outp.print("	<proxy prx = \""+ myproxy+"\" prt = \""+ myproxyport + "\"/>\n");

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-08-26 15:09:56 UTC (rev 835)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-08-26 15:41:15 UTC (rev 836)
@@ -16,7 +16,7 @@
 	mButton cancelB, applyB, brwBt, gpsB,btnCentre;
 	mChoice NS, EW;
 	mInput NSDeg, NSm, EWDeg, EWm, DataDir, Proxy, ProxyPort, Alias, nLogs, Browser, fontSize, inpGPS, 
-	       inpLogsPerPage,inpMaxLogsToSpider;
+	       inpLogsPerPage,inpMaxLogsToSpider,inpPassword;
 	mCheckBox dif, ter, loc, own, hid, stat, dist, bear, chkAutoLoad, chkShowDeletedImg, chkMenuAtTop, 
 	          chkTabsAtTop, chkShowStatus,chkHasCloseButton,chkSynthShort;
 	mTabbedPanel mTab;
@@ -71,8 +71,9 @@
 		Alias = new mInput();
 		Alias.setText(pref.myAlias);
 		pnlBrowser.addNext(Alias,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		pnlBrowser.addLast(new mLabel("")).setTag(SPAN,new Dimension(2,1));
-		
+		pnlBrowser.addNext(new mLabel(MyLocale.getMsg(594,"Pwd")));
+		pnlBrowser.addLast(inpPassword=new mInput(pref.password),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		inpPassword.setToolTip(MyLocale.getMsg(593,"Password is optional here.\nEnter only if you want to store it in pref.xml"));
 		pnlGeneral.addLast(pnlBrowser,HSTRETCH,HFILL);
 		
 		pnlGeneral.addNext(gpsB = new mButton("GPS"),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
@@ -227,6 +228,7 @@
 				mApp.mainApp.font = newGuiFont;
 				
 				pref.myAlias = Alias.getText().trim();
+				SpiderGC.passwort=pref.password= inpPassword.getText().trim();
 				pref.browser = Browser.getText();
 				//Vm.debug(myPreferences.browser);
 				pref.myproxy = Proxy.getText();



From salzkammergut at mail.berlios.de  Sun Aug 26 21:02:01 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 26 Aug 2007 21:02:01 +0200
Subject: [Cachewolf-svn] r837 - in trunk: resources src/CacheWolf
Message-ID: <200708261902.l7QJ21SX010184@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-26 21:01:54 +0200 (Sun, 26 Aug 2007)
New Revision: 837

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/MyLocale.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
Log:
Feature: Sprache aendern
http://www.geoclub.de/ftopic18248.html

Die Umsetzung ist derzeit nicht besonders elegant, besser waere Verwendung von Kommandozeilen Parametern.
Wie geht das am PDA?

Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-08-26 15:41:15 UTC (rev 836)
+++ trunk/resources/cachewolf.Languages.cfg	2007-08-26 19:01:54 UTC (rev 837)
@@ -137,6 +137,8 @@
 		351=Notizen hinzuf%fcgen/%e4ndern
 		400=Dekodieren
 		500=Umschalten
+		591=Leer f%fcr Sprache des Betriebssystems%0aoder 2 Zeichen f%fcr andere Sprache , z.B. DE, EN
+		592=Sprache (braucht Neustart)
 		593=Password ist hier optional.%0aNur eingeben wenn es in pref.xml%0agespeichert werden soll.
 		594=Passwt
 		595=Liste
@@ -666,6 +668,8 @@
 		351=Add/Edit notes
 		400=Dekode
 		500=Switch
+		591=Leave empty for default language or%0aadd 2 character language, e.g. DE, EN
+		592=Language (needs restart)
 		593=Password is optional here.%0aEnter only if you want to store it in pref.xml
 		594=Passwd
 		595=List

Modified: trunk/src/CacheWolf/MyLocale.java
===================================================================
--- trunk/src/CacheWolf/MyLocale.java	2007-08-26 15:41:15 UTC (rev 836)
+++ trunk/src/CacheWolf/MyLocale.java	2007-08-26 19:01:54 UTC (rev 837)
@@ -4,6 +4,11 @@
  * 
  */
 import ewe.fx.Rect;
+import ewe.io.BufferedReader;
+import ewe.io.BufferedWriter;
+import ewe.io.File;
+import ewe.io.FileReader;
+import ewe.io.FileWriter;
 import ewe.sys.*;
 import ewe.sys.Double;
 import ewe.sys.Long;
@@ -25,9 +30,17 @@
 	private static LocalResource lr=null;
 	private static Rect s = (Rect)Window.getGuiInfo(Window.INFO_SCREEN_RECT,null,new Rect(),0);
 	private static String digSeparator=null;
+	/** Read a non-standard language from the file language. If it is empty,
+	 * the default language is used.
+	 */
+	public static String language=getLanguage();
 	
 	private static void init() {
-		 l = Vm.getLocale();
+		 if ( language.length()==0) // Was a non-standard language specified
+			 l = Vm.getLocale();
+		 else {
+			 l=new Locale(Locale.createID(language,"",0));
+		 }
 		 lr = l.getLocalResource("cachewolf.Languages",true);
 
 		 double testA = Convert.toDouble("1,50") + Convert.toDouble("3,00");
@@ -188,5 +201,43 @@
 			Vm.setSIP(Vm.SIP_LEAVE_BUTTON);
 		}
 	}
+	
+	/*=================================================================
+	 * During initialisation the file "language" in the program directory
+	 * is read to check whether the user wishes to ovverride the default
+	 * language. This language cannot be stored in the pref.xml file, due
+	 * to an initialisation conflict (pref.xml needs MyLocale). A better
+	 * solution may be to read the override language from the command line,
+	 * but I do not know how to specify command line parameters on a PDA
+	 ==================================================================*/
+	/**
+	 * Read the language file and return the specified language (or empty
+	 * string if none specified).
+	 * @return Language (e.g. DE, EN etc.) or ""
+	 */
+	private static String getLanguage() {
+		try {
+			BufferedReader bufread=new BufferedReader(new FileReader(File.getProgramDirectory() + "/" + "language"));
+			language=bufread.readLine();
+			bufread.close();
+		} catch (Exception ex) {
+			language="";
+		}
+		if (language==null) language="";
+		return language;
+	}
+	
+	/**
+	 * Write the override language 
+	 * @param language The language to write
+	 */
+	public static void saveLanguage(String language) {
+		try{
+			BufferedWriter out = new BufferedWriter(new FileWriter(File.getProgramDirectory() + "/" + "language"));
+			out.write(language);
+			out.close();
+		}catch (Exception e){ Vm.debug("Exception "+e);}
+	}
+	
 }
 

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-08-26 15:41:15 UTC (rev 836)
+++ trunk/src/CacheWolf/Preferences.java	2007-08-26 19:01:54 UTC (rev 837)
@@ -45,6 +45,11 @@
 	public boolean showDeletedImages=true; /* Used in ImagePanel */
 	public boolean solverIgnoreCase=false;
 
+	/**
+	 * Forced language. If specified it overrides the default language.
+	 * Example: To run CW in English language on a German PC specify "EN" here.
+	 */
+	public String language="";
 	public int myAppHeight = 0;
 	public int myAppWidth = 0;
 	public final int DEFAULT_MAX_LOGS_TO_SPIDER=250;

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2007-08-26 15:41:15 UTC (rev 836)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2007-08-26 19:01:54 UTC (rev 837)
@@ -16,7 +16,7 @@
 	mButton cancelB, applyB, brwBt, gpsB,btnCentre;
 	mChoice NS, EW;
 	mInput NSDeg, NSm, EWDeg, EWm, DataDir, Proxy, ProxyPort, Alias, nLogs, Browser, fontSize, inpGPS, 
-	       inpLogsPerPage,inpMaxLogsToSpider,inpPassword;
+	       inpLogsPerPage,inpMaxLogsToSpider,inpPassword,inpLanguage;
 	mCheckBox dif, ter, loc, own, hid, stat, dist, bear, chkAutoLoad, chkShowDeletedImg, chkMenuAtTop, 
 	          chkTabsAtTop, chkShowStatus,chkHasCloseButton,chkSynthShort;
 	mTabbedPanel mTab;
@@ -160,6 +160,10 @@
 		ProxyPort.setText(pref.myproxyport);
 		pnlProxy.addLast(new mLabel("")).setTag(SPAN,new Dimension(2,1));
 		pnlMore.addLast(pnlProxy,HSTRETCH,HFILL);
+		pnlMore.addNext(new mLabel(MyLocale.getMsg(592,"Language (needs restart)")),DONTSTRETCH,DONTFILL|WEST);
+		pnlMore.addLast(inpLanguage=new mInput(MyLocale.language),DONTSTRETCH,DONTFILL|WEST);
+		inpLanguage.setPreferredSize(20,-1);
+		inpLanguage.setToolTip(MyLocale.getMsg(591,""));
 		
 		/////////////////////////////////////////////////////////
 		// Fourth/Fifth panel - Listview and Travelbugs
@@ -229,6 +233,7 @@
 				
 				pref.myAlias = Alias.getText().trim();
 				SpiderGC.passwort=pref.password= inpPassword.getText().trim();
+				MyLocale.saveLanguage(MyLocale.language=inpLanguage.getText().toUpperCase().trim());
 				pref.browser = Browser.getText();
 				//Vm.debug(myPreferences.browser);
 				pref.myproxy = Proxy.getText();



From salzkammergut at mail.berlios.de  Sun Aug 26 21:26:07 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 26 Aug 2007 21:26:07 +0200
Subject: [Cachewolf-svn] r838 - trunk/src/CacheWolf
Message-ID: <200708261926.l7QJQ7oX011703@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-26 21:26:04 +0200 (Sun, 26 Aug 2007)
New Revision: 838

Modified:
   trunk/src/CacheWolf/SpiderGC.java
Log:
SpiderGC: Bugfix

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-26 19:01:54 UTC (rev 837)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-26 19:26:04 UTC (rev 838)
@@ -741,10 +741,6 @@
 		//Vm.debug("Log Block: " + singleLog);
 		int nLogs=0;
 		while(exSingleLog.endOfSearch() == false){
-			if (nLogs>=MAXLOGS) {
-				reslts.add("<br\\>More than "+MAXLOGS+" logs.<br\\>");
-				break;
-			}
 			nLogs++;
 			//Vm.debug("--------------------------------------------");
 			//Vm.debug("Log Block: " + singleLog);
@@ -761,7 +757,7 @@
 				chD.is_found = true;
 				chD.CacheStatus = d;
 			}
-			reslts.add("<img src='"+ icon +"'>&nbsp;" + d + " " + name +"<br>"+ exLog.findNext());
+			if (nLogs<=MAXLOGS) reslts.add("<img src='"+ icon +"'>&nbsp;" + d + " " + name +"<br>"+ exLog.findNext());
 			
 			singleLog = exSingleLog.findNext();
 			exIcon.setSource(singleLog);
@@ -770,7 +766,13 @@
 			exName.setSource(nameTemp);
 			exDate.setSource(singleLog);
 			exLog.setSource(singleLog);
+			// We cannot simply stop if we have reached MAXLOGS just in case we are waiting for
+			// a log by our alias that happened earlier. 
+			if (nLogs>=MAXLOGS && chD.is_found) break;
 		}
+		if (nLogs>MAXLOGS) {
+			reslts.add("<br>More than "+MAXLOGS+" logs.<br>");
+		}
 		return reslts;
 	}
 	



From salzkammergut at mail.berlios.de  Sun Aug 26 21:32:29 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Sun, 26 Aug 2007 21:32:29 +0200
Subject: [Cachewolf-svn] r839 - trunk/src/CacheWolf
Message-ID: <200708261932.l7QJWTwA012057@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-26 21:32:27 +0200 (Sun, 26 Aug 2007)
New Revision: 839

Modified:
   trunk/src/CacheWolf/Preferences.java
Log:
Preferences: Bugfix maxLogsToSpider wurden falsch initialisiert

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-08-26 19:26:04 UTC (rev 838)
+++ trunk/src/CacheWolf/Preferences.java	2007-08-26 19:32:27 UTC (rev 839)
@@ -381,7 +381,7 @@
 			String strInitialHintHeight=atts.getValue("initialhintheight");
 			if (strInitialHintHeight!=null) initialHintHeight=Convert.parseInt(strInitialHintHeight);
 			String strMaxLogsToSpider=atts.getValue("maxspiderlogs");
-			if (strMaxLogsToSpider!=null) maxLogsToSpider=Convert.parseInt(strInitialHintHeight);
+			if (strMaxLogsToSpider!=null) maxLogsToSpider=Convert.parseInt(strMaxLogsToSpider);
 		}
 		if (name.equals("solver")) {
 			solverIgnoreCase=Boolean.valueOf(atts.getValue("ignorevariablecase")).booleanValue();



From pfeffer at mail.berlios.de  Mon Aug 27 14:44:37 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Mon, 27 Aug 2007 14:44:37 +0200
Subject: [Cachewolf-svn] r840 - in trunk/src: CacheWolf utils
Message-ID: <200708271244.l7RCibhp013829@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-27 14:44:33 +0200 (Mon, 27 Aug 2007)
New Revision: 840

Modified:
   trunk/src/CacheWolf/ProfilesForm.java
   trunk/src/utils/FileBugfix.java
Log:
Dirs not doubled anymore when using FileBugfix.list with the option Dirs_only (see http://www.geoclub.de/ftopic15291-20.html )

Modified: trunk/src/CacheWolf/ProfilesForm.java
===================================================================
--- trunk/src/CacheWolf/ProfilesForm.java	2007-08-26 19:32:27 UTC (rev 839)
+++ trunk/src/CacheWolf/ProfilesForm.java	2007-08-27 12:44:33 UTC (rev 840)
@@ -73,7 +73,7 @@
 		choice=new MyList();
 		// Get all subdirectories in the base directory
 		File fileBaseDir=new FileBugfix(baseDir);
-		String[] existingProfiles=fileBaseDir.list("*",FileBase.LIST_DIRECTORIES_ONLY);
+		String[] existingProfiles=fileBaseDir.list("*.*",FileBase.LIST_DIRECTORIES_ONLY);
         // Now add these subdirectories to the list of profiles but
         // exclude the "maps" directory which will contain the moving maps
         for (int i=0; i<existingProfiles.length; i++) 

Modified: trunk/src/utils/FileBugfix.java
===================================================================
--- trunk/src/utils/FileBugfix.java	2007-08-26 19:32:27 UTC (rev 839)
+++ trunk/src/utils/FileBugfix.java	2007-08-27 12:44:33 UTC (rev 840)
@@ -34,11 +34,13 @@
 		String masks [] = mString.split(mask,c);
 		String dirs [] = new String[0];
 		if ((listAndSortOptions & LIST_FILES_ONLY) == 0)
-			dirs = super.list(null,LIST_DIRECTORIES_ONLY);
+			dirs = super.list(null,LIST_DIRECTORIES_ONLY); // add dirs if not only asked for files
 		if ((listAndSortOptions & LIST_DIRECTORIES_ONLY) == 0)
-			found = super.list(null,File.LIST_FILES_ONLY|listAndSortOptions);
-		else
-			found = dirs;
+			found = super.list(null,File.LIST_FILES_ONLY|listAndSortOptions); // add files if not dirs only
+		else {
+			found = dirs; // if dirs only -> aplpy masks to the dirs
+			dirs = new String[0];
+		}
 
 		ewe.util.FileComparer [] fcs = new ewe.util.FileComparer[masks.length];
 



From pfeffer at mail.berlios.de  Tue Aug 28 00:43:19 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 28 Aug 2007 00:43:19 +0200
Subject: [Cachewolf-svn] r841 - in trunk: resources src/CacheWolf
Message-ID: <200708272243.l7RMhJuH022480@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-28 00:43:06 +0200 (Tue, 28 Aug 2007)
New Revision: 841

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/SpiderGC.java
Log:
CW complains now if some tags in spider.def are missing instead of NullPointerException

Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-08-27 12:44:33 UTC (rev 840)
+++ trunk/resources/cachewolf.Languages.cfg	2007-08-27 22:43:06 UTC (rev 841)
@@ -471,6 +471,7 @@
 		4501=Gez:
 		4502=Gef:
 		5000=Lade Cacheliste
+		5497=Fehler: Ein Tag in spider.def fehlt
 		5498=Login nicht m%f6glich. Fehler beim Laden der Seite nach Login.
 		5499=Fehler beim Laden der Login Seite
 		5500=Fehler
@@ -1002,6 +1003,7 @@
 		5498=Login failed. Error loading page after login. 
 		5499=Error loading login page
 		5000=Load Cachelist
+		5497=Error missing tag in spider.def
 		5500=Error
 		5501=Login failed! Wrong account or password?
 		5502=Fetching first page...

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-27 12:44:33 UTC (rev 840)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-27 22:43:06 UTC (rev 841)
@@ -107,6 +107,10 @@
 		try{
 			pref.log("Fetching login page");
 			start = fetch(loginPage=p.getProperty("loginPage"));   //http://www.geocaching.com/login/Default.aspx
+		}catch (NullPointerException ex) {
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def: "+"loginPage"), MessageBox.OKB)).execute();
+			pref.log("Error missing tag in spider.def: "+"loginPage",ex);
+			return ERR_LOGIN;
 		}catch(Exception ex){
 			infB.close(0);
 			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5499,"Error loading login page"), MessageBox.OKB)).execute();
@@ -140,6 +144,10 @@
 				    (new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed! Wrong account or password?"), MessageBox.OKB)).execute();
 					return ERR_LOGIN;
 				}
+			}catch (NullPointerException ex) {
+				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def: "+ "loginSuccess"), MessageBox.OKB)).execute();
+				pref.log("Error missing tag in spider.def: loginSuccess",ex);
+				return ERR_LOGIN;
 			}catch(Exception ex){
 				pref.log("Login failed.", ex);
 				infB.close(0);



From tg at mirbsd.de  Tue Aug 28 00:54:28 2007
From: tg at mirbsd.de (Thorsten Glaser)
Date: Mon, 27 Aug 2007 22:54:28 +0000 (UTC)
Subject: [Cachewolf-svn] r841 - in trunk: resources src/CacheWolf
In-Reply-To: <200708272243.l7RMhJuH022480@sheep.berlios.de>
References: <200708272243.l7RMhJuH022480@sheep.berlios.de>
Message-ID: <Pine.BSM.4.64L.0708272253340.10667@odem.66h.42h.de>

pfeffer at mail.berlios.de dixit:

>+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def: "+"loginPage"), MessageBox.OKB)).execute();

Do you mean:

>+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def") + ": loginPage", MessageBox.OKB)).execute();

//mirabilos
-- 
I believe no one can invent an algorithm. One just happens to hit upon it
when God enlightens him. Or only God invents algorithms, we merely copy them.
If you don't believe in God, just consider God as Nature if you won't deny
existence.		-- Coywolf Qi Hunt


From mirabilos at mail.berlios.de  Tue Aug 28 14:14:40 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 14:14:40 +0200
Subject: [Cachewolf-svn] r842 - trunk
Message-ID: <200708281214.l7SCEeME025919@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 14:14:40 +0200 (Tue, 28 Aug 2007)
New Revision: 842

Modified:
   trunk/buildexe.sh
   trunk/compile.sh
   trunk/runewe.sh
   trunk/runjewel.sh
   trunk/runwolf.sh
Log:
first commit, just something simple so I see that it works:
?\226?\128?\162 change the shebang line from /bin/bash to /bin/sh on all shell scripts
  to improve portability
?\226?\128?\162 whitespace cleanup
?\226?\128?\162 set the svn:executable property on the scripts


Modified: trunk/buildexe.sh
===================================================================
--- trunk/buildexe.sh	2007-08-27 22:43:06 UTC (rev 841)
+++ trunk/buildexe.sh	2007-08-28 12:14:40 UTC (rev 842)
@@ -1,2 +1,2 @@
-#!/bin/bash
+#!/bin/sh
 java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cwberlios.jnf


Property changes on: trunk/buildexe.sh
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/compile.sh
===================================================================
--- trunk/compile.sh	2007-08-27 22:43:06 UTC (rev 841)
+++ trunk/compile.sh	2007-08-28 12:14:40 UTC (rev 842)
@@ -1,2 +1,2 @@
-#!/bin/bash
+#!/bin/sh
 javac -cp ./lib/CompileEwe.zip:./lib/ewesoft.zip:./lib/EwesoftRegex.zip:./lib/HTML.zip:./lib/openmap.jar  -d ./bin/ -deprecation -nowarn  ./src/CacheWolf/*.java ./src/exp/*.java ./src/utils/*.java

Modified: trunk/runewe.sh
===================================================================
--- trunk/runewe.sh	2007-08-27 22:43:06 UTC (rev 841)
+++ trunk/runewe.sh	2007-08-28 12:14:40 UTC (rev 842)
@@ -1,5 +1,4 @@
-#!/bin/bash
-cd  work
+#!/bin/sh
+cd work
 java -cp ../lib/ewe.jar Ewe CacheWolf.ewe
 cd ..
-


Property changes on: trunk/runewe.sh
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/runjewel.sh
===================================================================
--- trunk/runjewel.sh	2007-08-27 22:43:06 UTC (rev 841)
+++ trunk/runjewel.sh	2007-08-28 12:14:40 UTC (rev 842)
@@ -1,2 +1,2 @@
-#!/bin/bash
+#!/bin/sh
 java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe cwberlios.jnf


Property changes on: trunk/runjewel.sh
___________________________________________________________________
Name: svn:executable
   + *

Modified: trunk/runwolf.sh
===================================================================
--- trunk/runwolf.sh	2007-08-27 22:43:06 UTC (rev 841)
+++ trunk/runwolf.sh	2007-08-28 12:14:40 UTC (rev 842)
@@ -1,5 +1,4 @@
-#!/bin/bash
-cd  work
+#!/bin/sh
+cd work
 java -cp ../lib/ewe.jar:../lib/ewesoft.zip:../lib/EwesoftRegex.zip:../lib/HTML.zip:../lib/openmap.jar:../bin Ewe CacheWolf.CacheWolf
 cd ..
-



From mirabilos at mail.berlios.de  Tue Aug 28 14:24:38 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 14:24:38 +0200
Subject: [Cachewolf-svn] r843 - trunk/src/CacheWolf
Message-ID: <200708281224.l7SCOckj026373@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 14:24:38 +0200 (Tue, 28 Aug 2007)
New Revision: 843

Modified:
   trunk/src/CacheWolf/SpiderGC.java
Log:
ok, this time a commit message in pure ISO_646.irv:1991 instead of UTF-8:
NLS message id #5497 includes neither a colon+space nor what exactly is
missing, append that after calling MyLocale.getMsg()

ok pfeffer@


Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-28 12:14:40 UTC (rev 842)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-28 12:24:38 UTC (rev 843)
@@ -108,7 +108,7 @@
 			pref.log("Fetching login page");
 			start = fetch(loginPage=p.getProperty("loginPage"));   //http://www.geocaching.com/login/Default.aspx
 		}catch (NullPointerException ex) {
-			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def: "+"loginPage"), MessageBox.OKB)).execute();
+			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def") + ": loginPage", MessageBox.OKB)).execute();
 			pref.log("Error missing tag in spider.def: "+"loginPage",ex);
 			return ERR_LOGIN;
 		}catch(Exception ex){
@@ -145,7 +145,7 @@
 					return ERR_LOGIN;
 				}
 			}catch (NullPointerException ex) {
-				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def: "+ "loginSuccess"), MessageBox.OKB)).execute();
+				(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def") + ": loginSuccess", MessageBox.OKB)).execute();
 				pref.log("Error missing tag in spider.def: loginSuccess",ex);
 				return ERR_LOGIN;
 			}catch(Exception ex){



From mirabilos at mail.berlios.de  Tue Aug 28 14:26:06 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 14:26:06 +0200
Subject: [Cachewolf-svn] r844 - trunk
Message-ID: <200708281226.l7SCQ6ev026511@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 14:26:05 +0200 (Tue, 28 Aug 2007)
New Revision: 844

Modified:
   trunk/getRes.sh
Log:
missed this in r842, I wonder why

Modified: trunk/getRes.sh
===================================================================
--- trunk/getRes.sh	2007-08-28 12:24:38 UTC (rev 843)
+++ trunk/getRes.sh	2007-08-28 12:26:05 UTC (rev 844)
@@ -9,5 +9,3 @@
 cp resources/*.* work
 cp resources/attributes/*.* work/attributes
 mv work/cachewolf.Languages.cfg work/_config/cachewolf.Languages.cfg
-
-



From mirabilos at mail.berlios.de  Tue Aug 28 14:33:11 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 14:33:11 +0200
Subject: [Cachewolf-svn] r845 - trunk/docs
Message-ID: <200708281233.l7SCXBH2026850@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 14:33:01 +0200 (Tue, 28 Aug 2007)
New Revision: 845

Modified:
   trunk/docs/GPL.txt
   trunk/docs/GPL_inclusion_per_source_file.txt
   trunk/docs/NotizenFuerEntwickler.txt
   trunk/docs/Readme.txt
   trunk/docs/Sonderzeichen_in_languages.cfg.txt
   trunk/docs/TemplateExport.txt
Log:
set the ???svn:eol-style??? property to ???native???, so that these files
will have CR-LF (MS-DOS) line endings if checked out on a Win/DOS
box and LF (UNIX) line endings if checked out on a Unix/Linux box

If this works, we can do that to all the other files affected too


Modified: trunk/docs/GPL.txt
===================================================================
--- trunk/docs/GPL.txt	2007-08-28 12:26:05 UTC (rev 844)
+++ trunk/docs/GPL.txt	2007-08-28 12:33:01 UTC (rev 845)
@@ -1,278 +1,278 @@
-GNU GENERAL PUBLIC LICENSE
-		       Version 2, June 1991
-
- Copyright (C) 1989, 1991 Free Software Foundation, Inc.
-                       51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
- Everyone is permitted to copy and distribute verbatim copies
- of this license document, but changing it is not allowed.
-
-			    Preamble
-
-  The licenses for most software are designed to take away your
-freedom to share and change it.  By contrast, the GNU General Public
-License is intended to guarantee your freedom to share and change free
-software--to make sure the software is free for all its users.  This
-General Public License applies to most of the Free Software
-Foundation's software and to any other program whose authors commit to
-using it.  (Some other Free Software Foundation software is covered by
-the GNU Library General Public License instead.)  You can apply it to
-your programs, too.
-
-  When we speak of free software, we are referring to freedom, not
-price.  Our General Public Licenses are designed to make sure that you
-have the freedom to distribute copies of free software (and charge for
-this service if you wish), that you receive source code or can get it
-if you want it, that you can change the software or use pieces of it
-in new free programs; and that you know you can do these things.
-
-  To protect your rights, we need to make restrictions that forbid
-anyone to deny you these rights or to ask you to surrender the rights.
-These restrictions translate to certain responsibilities for you if you
-distribute copies of the software, or if you modify it.
-
-  For example, if you distribute copies of such a program, whether
-gratis or for a fee, you must give the recipients all the rights that
-you have.  You must make sure that they, too, receive or can get the
-source code.  And you must show them these terms so they know their
-rights.
-
-  We protect your rights with two steps: (1) copyright the software, and
-(2) offer you this license which gives you legal permission to copy,
-distribute and/or modify the software.
-
-  Also, for each author's protection and ours, we want to make certain
-that everyone understands that there is no warranty for this free
-software.  If the software is modified by someone else and passed on, we
-want its recipients to know that what they have is not the original, so
-that any problems introduced by others will not reflect on the original
-authors' reputations.
-
-  Finally, any free program is threatened constantly by software
-patents.  We wish to avoid the danger that redistributors of a free
-program will individually obtain patent licenses, in effect making the
-program proprietary.  To prevent this, we have made it clear that any
-patent must be licensed for everyone's free use or not licensed at all.
-
-  The precise terms and conditions for copying, distribution and
-modification follow.
-
-		    GNU GENERAL PUBLIC LICENSE
-   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
-
-  0. This License applies to any program or other work which contains
-a notice placed by the copyright holder saying it may be distributed
-under the terms of this General Public License.  The "Program", below,
-refers to any such program or work, and a "work based on the Program"
-means either the Program or any derivative work under copyright law:
-that is to say, a work containing the Program or a portion of it,
-either verbatim or with modifications and/or translated into another
-language.  (Hereinafter, translation is included without limitation in
-the term "modification".)  Each licensee is addressed as "you".
-
-Activities other than copying, distribution and modification are not
-covered by this License; they are outside its scope.  The act of
-running the Program is not restricted, and the output from the Program
-is covered only if its contents constitute a work based on the
-Program (independent of having been made by running the Program).
-Whether that is true depends on what the Program does.
-
-  1. You may copy and distribute verbatim copies of the Program's
-source code as you receive it, in any medium, provided that you
-conspicuously and appropriately publish on each copy an appropriate
-copyright notice and disclaimer of warranty; keep intact all the
-notices that refer to this License and to the absence of any warranty;
-and give any other recipients of the Program a copy of this License
-along with the Program.
-
-You may charge a fee for the physical act of transferring a copy, and
-you may at your option offer warranty protection in exchange for a fee.
-
-  2. You may modify your copy or copies of the Program or any portion
-of it, thus forming a work based on the Program, and copy and
-distribute such modifications or work under the terms of Section 1
-above, provided that you also meet all of these conditions:
-
-    a) You must cause the modified files to carry prominent notices
-    stating that you changed the files and the date of any change.
-
-    b) You must cause any work that you distribute or publish, that in
-    whole or in part contains or is derived from the Program or any
-    part thereof, to be licensed as a whole at no charge to all third
-    parties under the terms of this License.
-
-    c) If the modified program normally reads commands interactively
-    when run, you must cause it, when started running for such
-    interactive use in the most ordinary way, to print or display an
-    announcement including an appropriate copyright notice and a
-    notice that there is no warranty (or else, saying that you provide
-    a warranty) and that users may redistribute the program under
-    these conditions, and telling the user how to view a copy of this
-    License.  (Exception: if the Program itself is interactive but
-    does not normally print such an announcement, your work based on
-    the Program is not required to print an announcement.)
-
-These requirements apply to the modified work as a whole.  If
-identifiable sections of that work are not derived from the Program,
-and can be reasonably considered independent and separate works in
-themselves, then this License, and its terms, do not apply to those
-sections when you distribute them as separate works.  But when you
-distribute the same sections as part of a whole which is a work based
-on the Program, the distribution of the whole must be on the terms of
-this License, whose permissions for other licensees extend to the
-entire whole, and thus to each and every part regardless of who wrote it.
-
-Thus, it is not the intent of this section to claim rights or contest
-your rights to work written entirely by you; rather, the intent is to
-exercise the right to control the distribution of derivative or
-collective works based on the Program.
-
-In addition, mere aggregation of another work not based on the Program
-with the Program (or with a work based on the Program) on a volume of
-a storage or distribution medium does not bring the other work under
-the scope of this License.
-
-  3. You may copy and distribute the Program (or a work based on it,
-under Section 2) in object code or executable form under the terms of
-Sections 1 and 2 above provided that you also do one of the following:
-
-    a) Accompany it with the complete corresponding machine-readable
-    source code, which must be distributed under the terms of Sections
-    1 and 2 above on a medium customarily used for software interchange; or,
-
-    b) Accompany it with a written offer, valid for at least three
-    years, to give any third party, for a charge no more than your
-    cost of physically performing source distribution, a complete
-    machine-readable copy of the corresponding source code, to be
-    distributed under the terms of Sections 1 and 2 above on a medium
-    customarily used for software interchange; or,
-
-    c) Accompany it with the information you received as to the offer
-    to distribute corresponding source code.  (This alternative is
-    allowed only for noncommercial distribution and only if you
-    received the program in object code or executable form with such
-    an offer, in accord with Subsection b above.)
-
-The source code for a work means the preferred form of the work for
-making modifications to it.  For an executable work, complete source
-code means all the source code for all modules it contains, plus any
-associated interface definition files, plus the scripts used to
-control compilation and installation of the executable.  However, as a
-special exception, the source code distributed need not include
-anything that is normally distributed (in either source or binary
-form) with the major components (compiler, kernel, and so on) of the
-operating system on which the executable runs, unless that component
-itself accompanies the executable.
-
-If distribution of executable or object code is made by offering
-access to copy from a designated place, then offering equivalent
-access to copy the source code from the same place counts as
-distribution of the source code, even though third parties are not
-compelled to copy the source along with the object code.
-
-  4. You may not copy, modify, sublicense, or distribute the Program
-except as expressly provided under this License.  Any attempt
-otherwise to copy, modify, sublicense or distribute the Program is
-void, and will automatically terminate your rights under this License.
-However, parties who have received copies, or rights, from you under
-this License will not have their licenses terminated so long as such
-parties remain in full compliance.
-
-  5. You are not required to accept this License, since you have not
-signed it.  However, nothing else grants you permission to modify or
-distribute the Program or its derivative works.  These actions are
-prohibited by law if you do not accept this License.  Therefore, by
-modifying or distributing the Program (or any work based on the
-Program), you indicate your acceptance of this License to do so, and
-all its terms and conditions for copying, distributing or modifying
-the Program or works based on it.
-
-  6. Each time you redistribute the Program (or any work based on the
-Program), the recipient automatically receives a license from the
-original licensor to copy, distribute or modify the Program subject to
-these terms and conditions.  You may not impose any further
-restrictions on the recipients' exercise of the rights granted herein.
-You are not responsible for enforcing compliance by third parties to
-this License.
-
-  7. If, as a consequence of a court judgment or allegation of patent
-infringement or for any other reason (not limited to patent issues),
-conditions are imposed on you (whether by court order, agreement or
-otherwise) that contradict the conditions of this License, they do not
-excuse you from the conditions of this License.  If you cannot
-distribute so as to satisfy simultaneously your obligations under this
-License and any other pertinent obligations, then as a consequence you
-may not distribute the Program at all.  For example, if a patent
-license would not permit royalty-free redistribution of the Program by
-all those who receive copies directly or indirectly through you, then
-the only way you could satisfy both it and this License would be to
-refrain entirely from distribution of the Program.
-
-If any portion of this section is held invalid or unenforceable under
-any particular circumstance, the balance of the section is intended to
-apply and the section as a whole is intended to apply in other
-circumstances.
-
-It is not the purpose of this section to induce you to infringe any
-patents or other property right claims or to contest validity of any
-such claims; this section has the sole purpose of protecting the
-integrity of the free software distribution system, which is
-implemented by public license practices.  Many people have made
-generous contributions to the wide range of software distributed
-through that system in reliance on consistent application of that
-system; it is up to the author/donor to decide if he or she is willing
-to distribute software through any other system and a licensee cannot
-impose that choice.
-
-This section is intended to make thoroughly clear what is believed to
-be a consequence of the rest of this License.
-
-  8. If the distribution and/or use of the Program is restricted in
-certain countries either by patents or by copyrighted interfaces, the
-original copyright holder who places the Program under this License
-may add an explicit geographical distribution limitation excluding
-those countries, so that distribution is permitted only in or among
-countries not thus excluded.  In such case, this License incorporates
-the limitation as if written in the body of this License.
-
-  9. The Free Software Foundation may publish revised and/or new versions
-of the General Public License from time to time.  Such new versions will
-be similar in spirit to the present version, but may differ in detail to
-address new problems or concerns.
-
-Each version is given a distinguishing version number.  If the Program
-specifies a version number of this License which applies to it and "any
-later version", you have the option of following the terms and conditions
-either of that version or of any later version published by the Free
-Software Foundation.  If the Program does not specify a version number of
-this License, you may choose any version ever published by the Free Software
-Foundation.
-
-  10. If you wish to incorporate parts of the Program into other free
-programs whose distribution conditions are different, write to the author
-to ask for permission.  For software which is copyrighted by the Free
-Software Foundation, write to the Free Software Foundation; we sometimes
-make exceptions for this.  Our decision will be guided by the two goals
-of preserving the free status of all derivatives of our free software and
-of promoting the sharing and reuse of software generally.
-
-			    NO WARRANTY
-
-  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
-FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
-OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
-PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
-OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
-MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
-TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
-PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
-REPAIR OR CORRECTION.
-
-  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
-WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
-REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
-INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
-OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
-TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
-YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
-PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
-POSSIBILITY OF SUCH DAMAGES.
+GNU GENERAL PUBLIC LICENSE
+		       Version 2, June 1991
+
+ Copyright (C) 1989, 1991 Free Software Foundation, Inc.
+                       51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
+ Everyone is permitted to copy and distribute verbatim copies
+ of this license document, but changing it is not allowed.
+
+			    Preamble
+
+  The licenses for most software are designed to take away your
+freedom to share and change it.  By contrast, the GNU General Public
+License is intended to guarantee your freedom to share and change free
+software--to make sure the software is free for all its users.  This
+General Public License applies to most of the Free Software
+Foundation's software and to any other program whose authors commit to
+using it.  (Some other Free Software Foundation software is covered by
+the GNU Library General Public License instead.)  You can apply it to
+your programs, too.
+
+  When we speak of free software, we are referring to freedom, not
+price.  Our General Public Licenses are designed to make sure that you
+have the freedom to distribute copies of free software (and charge for
+this service if you wish), that you receive source code or can get it
+if you want it, that you can change the software or use pieces of it
+in new free programs; and that you know you can do these things.
+
+  To protect your rights, we need to make restrictions that forbid
+anyone to deny you these rights or to ask you to surrender the rights.
+These restrictions translate to certain responsibilities for you if you
+distribute copies of the software, or if you modify it.
+
+  For example, if you distribute copies of such a program, whether
+gratis or for a fee, you must give the recipients all the rights that
+you have.  You must make sure that they, too, receive or can get the
+source code.  And you must show them these terms so they know their
+rights.
+
+  We protect your rights with two steps: (1) copyright the software, and
+(2) offer you this license which gives you legal permission to copy,
+distribute and/or modify the software.
+
+  Also, for each author's protection and ours, we want to make certain
+that everyone understands that there is no warranty for this free
+software.  If the software is modified by someone else and passed on, we
+want its recipients to know that what they have is not the original, so
+that any problems introduced by others will not reflect on the original
+authors' reputations.
+
+  Finally, any free program is threatened constantly by software
+patents.  We wish to avoid the danger that redistributors of a free
+program will individually obtain patent licenses, in effect making the
+program proprietary.  To prevent this, we have made it clear that any
+patent must be licensed for everyone's free use or not licensed at all.
+
+  The precise terms and conditions for copying, distribution and
+modification follow.
+
+		    GNU GENERAL PUBLIC LICENSE
+   TERMS AND CONDITIONS FOR COPYING, DISTRIBUTION AND MODIFICATION
+
+  0. This License applies to any program or other work which contains
+a notice placed by the copyright holder saying it may be distributed
+under the terms of this General Public License.  The "Program", below,
+refers to any such program or work, and a "work based on the Program"
+means either the Program or any derivative work under copyright law:
+that is to say, a work containing the Program or a portion of it,
+either verbatim or with modifications and/or translated into another
+language.  (Hereinafter, translation is included without limitation in
+the term "modification".)  Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not
+covered by this License; they are outside its scope.  The act of
+running the Program is not restricted, and the output from the Program
+is covered only if its contents constitute a work based on the
+Program (independent of having been made by running the Program).
+Whether that is true depends on what the Program does.
+
+  1. You may copy and distribute verbatim copies of the Program's
+source code as you receive it, in any medium, provided that you
+conspicuously and appropriately publish on each copy an appropriate
+copyright notice and disclaimer of warranty; keep intact all the
+notices that refer to this License and to the absence of any warranty;
+and give any other recipients of the Program a copy of this License
+along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and
+you may at your option offer warranty protection in exchange for a fee.
+
+  2. You may modify your copy or copies of the Program or any portion
+of it, thus forming a work based on the Program, and copy and
+distribute such modifications or work under the terms of Section 1
+above, provided that you also meet all of these conditions:
+
+    a) You must cause the modified files to carry prominent notices
+    stating that you changed the files and the date of any change.
+
+    b) You must cause any work that you distribute or publish, that in
+    whole or in part contains or is derived from the Program or any
+    part thereof, to be licensed as a whole at no charge to all third
+    parties under the terms of this License.
+
+    c) If the modified program normally reads commands interactively
+    when run, you must cause it, when started running for such
+    interactive use in the most ordinary way, to print or display an
+    announcement including an appropriate copyright notice and a
+    notice that there is no warranty (or else, saying that you provide
+    a warranty) and that users may redistribute the program under
+    these conditions, and telling the user how to view a copy of this
+    License.  (Exception: if the Program itself is interactive but
+    does not normally print such an announcement, your work based on
+    the Program is not required to print an announcement.)
+
+These requirements apply to the modified work as a whole.  If
+identifiable sections of that work are not derived from the Program,
+and can be reasonably considered independent and separate works in
+themselves, then this License, and its terms, do not apply to those
+sections when you distribute them as separate works.  But when you
+distribute the same sections as part of a whole which is a work based
+on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the
+entire whole, and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest
+your rights to work written entirely by you; rather, the intent is to
+exercise the right to control the distribution of derivative or
+collective works based on the Program.
+
+In addition, mere aggregation of another work not based on the Program
+with the Program (or with a work based on the Program) on a volume of
+a storage or distribution medium does not bring the other work under
+the scope of this License.
+
+  3. You may copy and distribute the Program (or a work based on it,
+under Section 2) in object code or executable form under the terms of
+Sections 1 and 2 above provided that you also do one of the following:
+
+    a) Accompany it with the complete corresponding machine-readable
+    source code, which must be distributed under the terms of Sections
+    1 and 2 above on a medium customarily used for software interchange; or,
+
+    b) Accompany it with a written offer, valid for at least three
+    years, to give any third party, for a charge no more than your
+    cost of physically performing source distribution, a complete
+    machine-readable copy of the corresponding source code, to be
+    distributed under the terms of Sections 1 and 2 above on a medium
+    customarily used for software interchange; or,
+
+    c) Accompany it with the information you received as to the offer
+    to distribute corresponding source code.  (This alternative is
+    allowed only for noncommercial distribution and only if you
+    received the program in object code or executable form with such
+    an offer, in accord with Subsection b above.)
+
+The source code for a work means the preferred form of the work for
+making modifications to it.  For an executable work, complete source
+code means all the source code for all modules it contains, plus any
+associated interface definition files, plus the scripts used to
+control compilation and installation of the executable.  However, as a
+special exception, the source code distributed need not include
+anything that is normally distributed (in either source or binary
+form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component
+itself accompanies the executable.
+
+If distribution of executable or object code is made by offering
+access to copy from a designated place, then offering equivalent
+access to copy the source code from the same place counts as
+distribution of the source code, even though third parties are not
+compelled to copy the source along with the object code.
+
+  4. You may not copy, modify, sublicense, or distribute the Program
+except as expressly provided under this License.  Any attempt
+otherwise to copy, modify, sublicense or distribute the Program is
+void, and will automatically terminate your rights under this License.
+However, parties who have received copies, or rights, from you under
+this License will not have their licenses terminated so long as such
+parties remain in full compliance.
+
+  5. You are not required to accept this License, since you have not
+signed it.  However, nothing else grants you permission to modify or
+distribute the Program or its derivative works.  These actions are
+prohibited by law if you do not accept this License.  Therefore, by
+modifying or distributing the Program (or any work based on the
+Program), you indicate your acceptance of this License to do so, and
+all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+  6. Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the
+original licensor to copy, distribute or modify the Program subject to
+these terms and conditions.  You may not impose any further
+restrictions on the recipients' exercise of the rights granted herein.
+You are not responsible for enforcing compliance by third parties to
+this License.
+
+  7. If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues),
+conditions are imposed on you (whether by court order, agreement or
+otherwise) that contradict the conditions of this License, they do not
+excuse you from the conditions of this License.  If you cannot
+distribute so as to satisfy simultaneously your obligations under this
+License and any other pertinent obligations, then as a consequence you
+may not distribute the Program at all.  For example, if a patent
+license would not permit royalty-free redistribution of the Program by
+all those who receive copies directly or indirectly through you, then
+the only way you could satisfy both it and this License would be to
+refrain entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under
+any particular circumstance, the balance of the section is intended to
+apply and the section as a whole is intended to apply in other
+circumstances.
+
+It is not the purpose of this section to induce you to infringe any
+patents or other property right claims or to contest validity of any
+such claims; this section has the sole purpose of protecting the
+integrity of the free software distribution system, which is
+implemented by public license practices.  Many people have made
+generous contributions to the wide range of software distributed
+through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing
+to distribute software through any other system and a licensee cannot
+impose that choice.
+
+This section is intended to make thoroughly clear what is believed to
+be a consequence of the rest of this License.
+
+  8. If the distribution and/or use of the Program is restricted in
+certain countries either by patents or by copyrighted interfaces, the
+original copyright holder who places the Program under this License
+may add an explicit geographical distribution limitation excluding
+those countries, so that distribution is permitted only in or among
+countries not thus excluded.  In such case, this License incorporates
+the limitation as if written in the body of this License.
+
+  9. The Free Software Foundation may publish revised and/or new versions
+of the General Public License from time to time.  Such new versions will
+be similar in spirit to the present version, but may differ in detail to
+address new problems or concerns.
+
+Each version is given a distinguishing version number.  If the Program
+specifies a version number of this License which applies to it and "any
+later version", you have the option of following the terms and conditions
+either of that version or of any later version published by the Free
+Software Foundation.  If the Program does not specify a version number of
+this License, you may choose any version ever published by the Free Software
+Foundation.
+
+  10. If you wish to incorporate parts of the Program into other free
+programs whose distribution conditions are different, write to the author
+to ask for permission.  For software which is copyrighted by the Free
+Software Foundation, write to the Free Software Foundation; we sometimes
+make exceptions for this.  Our decision will be guided by the two goals
+of preserving the free status of all derivatives of our free software and
+of promoting the sharing and reuse of software generally.
+
+			    NO WARRANTY
+
+  11. BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY
+FOR THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW.  EXCEPT WHEN
+OTHERWISE STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES
+PROVIDE THE PROGRAM "AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED
+OR IMPLIED, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE.  THE ENTIRE RISK AS
+TO THE QUALITY AND PERFORMANCE OF THE PROGRAM IS WITH YOU.  SHOULD THE
+PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF ALL NECESSARY SERVICING,
+REPAIR OR CORRECTION.
+
+  12. IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR
+REDISTRIBUTE THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES,
+INCLUDING ANY GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING
+OUT OF THE USE OR INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED
+TO LOSS OF DATA OR DATA BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY
+YOU OR THIRD PARTIES OR A FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER
+PROGRAMS), EVEN IF SUCH HOLDER OR OTHER PARTY HAS BEEN ADVISED OF THE
+POSSIBILITY OF SUCH DAMAGES.


Property changes on: trunk/docs/GPL.txt
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/docs/GPL_inclusion_per_source_file.txt
===================================================================
--- trunk/docs/GPL_inclusion_per_source_file.txt	2007-08-28 12:26:05 UTC (rev 844)
+++ trunk/docs/GPL_inclusion_per_source_file.txt	2007-08-28 12:33:01 UTC (rev 845)
@@ -1,24 +1,24 @@
-    /*
-    CacheWolf is a software for PocketPC, Win and Linux that 
-    enables paperless caching. 
-    It supports the sites geocaching.com and opencaching.de
-    
-    Copyright (C) 2006  CacheWolf development team
-    See http://developer.berlios.de/projects/cachewolf/
-    for more information.
-    Contact: 	bilbowolf at users.berlios.de
-    			kalli at users.berlios.de
-
-    This program is free software; you can redistribute it and/or modify
-    it under the terms of the GNU General Public License as published by
-    the Free Software Foundation; version 2 of the License.
-
-    This program is distributed in the hope that it will be useful,
-    but WITHOUT ANY WARRANTY; without even the implied warranty of
-    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
-    GNU General Public License for more details.
-
-    You should have received a copy of the GNU General Public License
-    along with this program; if not, write to the Free Software
-    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
-    */
+    /*
+    CacheWolf is a software for PocketPC, Win and Linux that 
+    enables paperless caching. 
+    It supports the sites geocaching.com and opencaching.de
+    
+    Copyright (C) 2006  CacheWolf development team
+    See http://developer.berlios.de/projects/cachewolf/
+    for more information.
+    Contact: 	bilbowolf at users.berlios.de
+    			kalli at users.berlios.de
+
+    This program is free software; you can redistribute it and/or modify
+    it under the terms of the GNU General Public License as published by
+    the Free Software Foundation; version 2 of the License.
+
+    This program is distributed in the hope that it will be useful,
+    but WITHOUT ANY WARRANTY; without even the implied warranty of
+    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
+    GNU General Public License for more details.
+
+    You should have received a copy of the GNU General Public License
+    along with this program; if not, write to the Free Software
+    Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA  02110-1301  USA
+    */


Property changes on: trunk/docs/GPL_inclusion_per_source_file.txt
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/docs/NotizenFuerEntwickler.txt
===================================================================
--- trunk/docs/NotizenFuerEntwickler.txt	2007-08-28 12:26:05 UTC (rev 844)
+++ trunk/docs/NotizenFuerEntwickler.txt	2007-08-28 12:33:01 UTC (rev 845)
@@ -1,33 +1,33 @@
-Notizen f?r Entwickler:
-
-1. Zugriff auf globale Objekte:
-	Preferences pref = Global.getPref();	// Pr?ferenzen
-	Profile profile=Global.getProfile();	// Das aktuelle Profil
-	MainTab mainTab;						// Das mainTab Objekt (Enth?lt alle Ansichten)
-	
-2. Aufzeichnung von internen Fehlern in der log.txt:
-	Die Datei log.txt wird bei jedem Spidervorgang neu generiert.
-	F?r die Aufzeichnung von Fehlern (oder auch nur Ablaufverfolgungen wie z.B. in SpiderGC)
-	stehen folgende Routinen zur Verf?gung (alle in Preferences.java)
-	
-	public void log(String text)					// Beliebige Fehlermeldung mit Zeitstempel
-	public void log(String message,Exception e) 	// Exception mit Zeitstempel (nutzt obige Funktion)
-	public void log(String text,Throwable e, 		// Exception mit Zeitstempel und Stacktrace
-		boolean withStackTrace) 
-	
-	Beispiel:
-	Global.getPref().log("Fehler bei xxx");
-	
-3. Debug-Schalter:
-	Es besteht die M?glichkeit ?ber einen undokumentierten Schalter in der pref.xml 
-	"schlafenden" Debug-Code bei Probleme selektiv zu aktivieren. Dazu ist in der pref.xml
-	die Zeile 
-		<debug value="true">
-	einzuf?gen.
-	Der Wert der debug Variablen kann dann wie folgt abgefragt werden:
-		if(Global.getPref().debug) {
-			// Code der nur ausgef?hrt wird wenn debug Schalter gesetzt
-			// z.B. ausf?hrlichere Fehlermeldung
-		}
-
-
+Notizen f?r Entwickler:
+
+1. Zugriff auf globale Objekte:
+	Preferences pref = Global.getPref();	// Pr?ferenzen
+	Profile profile=Global.getProfile();	// Das aktuelle Profil
+	MainTab mainTab;						// Das mainTab Objekt (Enth?lt alle Ansichten)
+	
+2. Aufzeichnung von internen Fehlern in der log.txt:
+	Die Datei log.txt wird bei jedem Spidervorgang neu generiert.
+	F?r die Aufzeichnung von Fehlern (oder auch nur Ablaufverfolgungen wie z.B. in SpiderGC)
+	stehen folgende Routinen zur Verf?gung (alle in Preferences.java)
+	
+	public void log(String text)					// Beliebige Fehlermeldung mit Zeitstempel
+	public void log(String message,Exception e) 	// Exception mit Zeitstempel (nutzt obige Funktion)
+	public void log(String text,Throwable e, 		// Exception mit Zeitstempel und Stacktrace
+		boolean withStackTrace) 
+	
+	Beispiel:
+	Global.getPref().log("Fehler bei xxx");
+	
+3. Debug-Schalter:
+	Es besteht die M?glichkeit ?ber einen undokumentierten Schalter in der pref.xml 
+	"schlafenden" Debug-Code bei Probleme selektiv zu aktivieren. Dazu ist in der pref.xml
+	die Zeile 
+		<debug value="true">
+	einzuf?gen.
+	Der Wert der debug Variablen kann dann wie folgt abgefragt werden:
+		if(Global.getPref().debug) {
+			// Code der nur ausgef?hrt wird wenn debug Schalter gesetzt
+			// z.B. ausf?hrlichere Fehlermeldung
+		}
+
+


Property changes on: trunk/docs/NotizenFuerEntwickler.txt
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/docs/Readme.txt
===================================================================
--- trunk/docs/Readme.txt	2007-08-28 12:26:05 UTC (rev 844)
+++ trunk/docs/Readme.txt	2007-08-28 12:33:01 UTC (rev 845)
@@ -1,40 +1,40 @@
-???Wie bekomme ich eine brandaktuelle Version des CacheWolf? 
-
-Die Sourcen von CacheWolf sind in einem Subversion-Repository bei www.berlios.de (Details siehe https://developer.berlios.de/svn/?group_id=2211) vorhanden, hierauf kann jeder lesend zugreifen. Schreibrechte werden auf Anfrage erteilt. Nachfolgend ist beschrieben, wie man sich die aktuelle Entwicklerversion besorgen kann und zum Laufen benommt. 
-
-CacheWolf wurde f??r und mit Ewe (http://www.ewesoft.com/) in Java programmiert. Ewe bietet f??r viele Plattformen sogenannte virtuelle Maschienen an, au??erdem k??nnen f??r Ewe geschriebene Programme auf allen Plattformen laufen, die eine Java-Laufzeitumgebung haben (nicht zu verwechseln mit dem "Handy-Java" J2ME).
-
-Ben??tigte Programme
-- JDK von Sun (http://java.sun.com/javase/downloads/index.jsp), enth??lt auch die Java Laufzeitumgebung
-- Ein Subversion (SVN) Client, z.B. Tortoise f??r WinXP (http://tortoisesvn.tigris.org/), kdesvn f??r Linux (KDE) oder das subclipse-Plugin f??r eclipse
-- Das Ewe-Developer-SDK (z.B. http://www.ewesoft.com/Downloads/Ewe149-Developer-SDK.zip)
-
-Java-Version
-- Checkout der aktuellen Sourcen aus dem Repository (z.B. http://svn.berlios.de/svnroot/repos/cachewolf/trunk)
-- Das Verzeichnis kann lokal umbenannt werden, z.B. in CacheWolf
-- Es sollte bereits ein Verzeichnis bin/CacheWolf geben, falls nicht, bitte anlegen
-- Die Linux-Scripte mit einem chmod 755 *.sh ausf??hrbar machen
-- Script compile.bat (WinXP) bzw. ./compile.sh (Linux) ausf??hren. Es gibt etwa 10 Warnings.
-- Script getRes.bat bzw. ./getRes.sh ausf??hren. Damit werden u.a. die Image-Dateien in das Work-Verzeichnis kopiert
-- Script runwolf.bat bzw. ./runwolf.sh ausf??hren. Damit wird der CacheWolf im Work-Verzeichnis gestartet. Das Datenverzeichnis sollte man irgendwo anders hinlegen, z.B. parallel zum CacheWolf-Verzeichnis.
-
-Ausf??hrbare Versionen erzeugen, z.B. f??r WinXP oder PPC
-- Parallel zum CacheWolf-Verzeichnis ein Verzeichnis Ewe/programs anlegen, die Dateien finden sich im Ewe-Developer-SDK. Da dieses Verzeichnis von den Scripten relativ (also per ../Ewe/programs) angesprochen wird, auf genaue Einhaltung der Namen achten.
-Der Inhalt des Verziechnisses ist bei mir unter Linux wie folgt:
--rw-r--r-- 1 kalle kalle      29 2006-07-28 20:43 Ewesoft-Jewel.cfg
--rw-r--r-- 1 kalle kalle 3830895 2005-12-19 19:27 JavaEwe.zip
--rw-r--r-- 1 kalle kalle 2748046 2005-12-19 16:52 JewelData.jar
--rw-r--r-- 1 kalle kalle  254444 2005-11-26 23:53 Jewel.ewe
--rw-r--r-- 1 kalle kalle      47 2005-01-20 18:44 RunJewel.bat
--rwxr-xr-x 1 kalle kalle      47 2006-07-24 21:30 runjewel.sh
-runjewel.sh habe ich mir selbst aus runJewel.bat erzeugt.
-
-- In dem Verzeichnis lib die folgenden Dateien rekursiv auspacken (.jar-Files sind zip-Dateien, falls der Entpacker muckt, einfach tempor??r in .zip umbenennen)
- - ewesoft.zip
- - EwesoftRegex.zip
- - HTML.zip
- - openmap.jar
- Es gibt dann die Unterverzeichnisse com, ewesoft und HTML
-- Script buildexe.bat bzw. ./buildexe.sh aufrufen, es wird ein Verzeichnis CacheWolf erzeugt mit Unterverzeichnissen f??r die unterschiedlichen Plattformen.
-- mit dem Script runjewel k??nnen ??nderungen an der Datei cwberlios.jnf vorgenommen werden.
-
+???Wie bekomme ich eine brandaktuelle Version des CacheWolf? 
+
+Die Sourcen von CacheWolf sind in einem Subversion-Repository bei www.berlios.de (Details siehe https://developer.berlios.de/svn/?group_id=2211) vorhanden, hierauf kann jeder lesend zugreifen. Schreibrechte werden auf Anfrage erteilt. Nachfolgend ist beschrieben, wie man sich die aktuelle Entwicklerversion besorgen kann und zum Laufen benommt. 
+
+CacheWolf wurde f??r und mit Ewe (http://www.ewesoft.com/) in Java programmiert. Ewe bietet f??r viele Plattformen sogenannte virtuelle Maschienen an, au??erdem k??nnen f??r Ewe geschriebene Programme auf allen Plattformen laufen, die eine Java-Laufzeitumgebung haben (nicht zu verwechseln mit dem "Handy-Java" J2ME).
+
+Ben??tigte Programme
+- JDK von Sun (http://java.sun.com/javase/downloads/index.jsp), enth??lt auch die Java Laufzeitumgebung
+- Ein Subversion (SVN) Client, z.B. Tortoise f??r WinXP (http://tortoisesvn.tigris.org/), kdesvn f??r Linux (KDE) oder das subclipse-Plugin f??r eclipse
+- Das Ewe-Developer-SDK (z.B. http://www.ewesoft.com/Downloads/Ewe149-Developer-SDK.zip)
+
+Java-Version
+- Checkout der aktuellen Sourcen aus dem Repository (z.B. http://svn.berlios.de/svnroot/repos/cachewolf/trunk)
+- Das Verzeichnis kann lokal umbenannt werden, z.B. in CacheWolf
+- Es sollte bereits ein Verzeichnis bin/CacheWolf geben, falls nicht, bitte anlegen
+- Die Linux-Scripte mit einem chmod 755 *.sh ausf??hrbar machen
+- Script compile.bat (WinXP) bzw. ./compile.sh (Linux) ausf??hren. Es gibt etwa 10 Warnings.
+- Script getRes.bat bzw. ./getRes.sh ausf??hren. Damit werden u.a. die Image-Dateien in das Work-Verzeichnis kopiert
+- Script runwolf.bat bzw. ./runwolf.sh ausf??hren. Damit wird der CacheWolf im Work-Verzeichnis gestartet. Das Datenverzeichnis sollte man irgendwo anders hinlegen, z.B. parallel zum CacheWolf-Verzeichnis.
+
+Ausf??hrbare Versionen erzeugen, z.B. f??r WinXP oder PPC
+- Parallel zum CacheWolf-Verzeichnis ein Verzeichnis Ewe/programs anlegen, die Dateien finden sich im Ewe-Developer-SDK. Da dieses Verzeichnis von den Scripten relativ (also per ../Ewe/programs) angesprochen wird, auf genaue Einhaltung der Namen achten.
+Der Inhalt des Verziechnisses ist bei mir unter Linux wie folgt:
+-rw-r--r-- 1 kalle kalle      29 2006-07-28 20:43 Ewesoft-Jewel.cfg
+-rw-r--r-- 1 kalle kalle 3830895 2005-12-19 19:27 JavaEwe.zip
+-rw-r--r-- 1 kalle kalle 2748046 2005-12-19 16:52 JewelData.jar
+-rw-r--r-- 1 kalle kalle  254444 2005-11-26 23:53 Jewel.ewe
+-rw-r--r-- 1 kalle kalle      47 2005-01-20 18:44 RunJewel.bat
+-rwxr-xr-x 1 kalle kalle      47 2006-07-24 21:30 runjewel.sh
+runjewel.sh habe ich mir selbst aus runJewel.bat erzeugt.
+
+- In dem Verzeichnis lib die folgenden Dateien rekursiv auspacken (.jar-Files sind zip-Dateien, falls der Entpacker muckt, einfach tempor??r in .zip umbenennen)
+ - ewesoft.zip
+ - EwesoftRegex.zip
+ - HTML.zip
+ - openmap.jar
+ Es gibt dann die Unterverzeichnisse com, ewesoft und HTML
+- Script buildexe.bat bzw. ./buildexe.sh aufrufen, es wird ein Verzeichnis CacheWolf erzeugt mit Unterverzeichnissen f??r die unterschiedlichen Plattformen.
+- mit dem Script runjewel k??nnen ??nderungen an der Datei cwberlios.jnf vorgenommen werden.
+


Property changes on: trunk/docs/Readme.txt
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/docs/Sonderzeichen_in_languages.cfg.txt
===================================================================
--- trunk/docs/Sonderzeichen_in_languages.cfg.txt	2007-08-28 12:26:05 UTC (rev 844)
+++ trunk/docs/Sonderzeichen_in_languages.cfg.txt	2007-08-28 12:33:01 UTC (rev 845)
@@ -1,13 +1,13 @@
-Zeichen sind als "Quoted printable" kodiert mit einem % Zeichen
-Siehe auch http://de.wikipedia.org/wiki/Quoted-printable
-und http://www.cs.tut.fi/~jkorpela/chars.html
-
-Leertaste: +
-? %e4
-? %f6 
-? %fc 
-? %df
-? %c4
-? %d6
-? %dc
+Zeichen sind als "Quoted printable" kodiert mit einem % Zeichen
+Siehe auch http://de.wikipedia.org/wiki/Quoted-printable
+und http://www.cs.tut.fi/~jkorpela/chars.html
+
+Leertaste: +
+? %e4
+? %f6 
+? %fc 
+? %df
+? %c4
+? %d6
+? %dc
 \n %0a
\ No newline at end of file


Property changes on: trunk/docs/Sonderzeichen_in_languages.cfg.txt
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/docs/TemplateExport.txt
===================================================================
--- trunk/docs/TemplateExport.txt	2007-08-28 12:26:05 UTC (rev 844)
+++ trunk/docs/TemplateExport.txt	2007-08-28 12:33:01 UTC (rev 845)
@@ -1,57 +1,57 @@
-Short documentation for the export via templates
-
-Comment 
-<#-- TomTom ASC or POI -->
-Anything between "<#--" and "-->" is handled as a comment
-
-Configuration section
-Charsets: <tmpl_par name="charset" value="ASCII">, values ASCII or UTF8
-
-Bad Chars:
-These chars are removed from the cachename, for example the ',' if ',' is used as a separator.
-<tmpl_par name="badchars" value=",">
-
-Newline:
-These defines, what should be used for replacing <br />
-<tmpl_par name="newline" value="CRLF">, values are CR, LF or CRLF
-
-Decimal separator:
-Defines, which decimal separator is used
-<tmpl_par name="decsep" value=",">, values "." or ','
-
-Output section
-Anything (except comments and variables) is written to the output file. The cachedata ist placed between <tmpl_loop cache_index> and </tmpl_loop>. Variables defined like this: <tmpl_var name=LON>. At the end of the line <br /> has to be placed, this ist replaced by CR.
-
-Variables:
-TYPE: Type of cache, e.g. Regular, Multi
-SHORTTYPE: First Letter of sype
-SIZE: Size of Cache, e.g. Regular, Micro
-SHORTSIZE: First letter of size
-WAYPOINT: GCXXXX, OCXXXX
-NAME: Name of cache
-OWNER
-DIFFICULTY
-TERRAIN
-DISTANCE: Distance calculated in cachelist
-BEARING: Bearing calculated in cachelist
-LATON: Coordinates in long format, e.g. N 50? 31.234 E 008? 45.267
-LAT: Latitude in decimal format, e.g. 50.20147
-LON: Longitude in decimal format, e.g. 008.58132
-STATUS
-DATE: date hidden
-URL
-
-Example:
-<#-- Microsoft AutoRoute -->
-<#-- Codecs: ASCII, UTF8 -->
-<tmpl_par name="charset" value="ASCII">
-<#-- somme chars should not appear in the cachename -->
-<tmpl_par name="badchars" value=";"">
-<#-- newline: CR, LF, CRLF -->
-<tmpl_par name="newline" value="CRLF">
-<#-- decimal seperator: . or , -->
-<tmpl_par name="decsep" value=",">
-Name;Breitengrad;L?ngengrad;Typ1;Typ2;Waypoint;Datum;Hyperlink<br />
-<tmpl_loop cache_index>
-"<tmpl_var name=SHORTTYPE>-<tmpl_var name=SHORTSIZE>-<tmpl_var name=DIFFICULTY>-<tmpl_var name=TERRAIN> <tmpl_var name=NAME>";<tmpl_var name=LAT>;<tmpl_var name=LON>;"<tmpl_var name=TYPE>";"<tmpl_var name=SIZE>";"<tmpl_var name=WAYPOINT>";"<tmpl_var name=DATE>";"<tmpl_var name=URL>"<br />
-</tmpl_loop>
+Short documentation for the export via templates
+
+Comment 
+<#-- TomTom ASC or POI -->
+Anything between "<#--" and "-->" is handled as a comment
+
+Configuration section
+Charsets: <tmpl_par name="charset" value="ASCII">, values ASCII or UTF8
+
+Bad Chars:
+These chars are removed from the cachename, for example the ',' if ',' is used as a separator.
+<tmpl_par name="badchars" value=",">
+
+Newline:
+These defines, what should be used for replacing <br />
+<tmpl_par name="newline" value="CRLF">, values are CR, LF or CRLF
+
+Decimal separator:
+Defines, which decimal separator is used
+<tmpl_par name="decsep" value=",">, values "." or ','
+
+Output section
+Anything (except comments and variables) is written to the output file. The cachedata ist placed between <tmpl_loop cache_index> and </tmpl_loop>. Variables defined like this: <tmpl_var name=LON>. At the end of the line <br /> has to be placed, this ist replaced by CR.
+
+Variables:
+TYPE: Type of cache, e.g. Regular, Multi
+SHORTTYPE: First Letter of sype
+SIZE: Size of Cache, e.g. Regular, Micro
+SHORTSIZE: First letter of size
+WAYPOINT: GCXXXX, OCXXXX
+NAME: Name of cache
+OWNER
+DIFFICULTY
+TERRAIN
+DISTANCE: Distance calculated in cachelist
+BEARING: Bearing calculated in cachelist
+LATON: Coordinates in long format, e.g. N 50? 31.234 E 008? 45.267
+LAT: Latitude in decimal format, e.g. 50.20147
+LON: Longitude in decimal format, e.g. 008.58132
+STATUS
+DATE: date hidden
+URL
+
+Example:
+<#-- Microsoft AutoRoute -->
+<#-- Codecs: ASCII, UTF8 -->
+<tmpl_par name="charset" value="ASCII">
+<#-- somme chars should not appear in the cachename -->
+<tmpl_par name="badchars" value=";"">
+<#-- newline: CR, LF, CRLF -->
+<tmpl_par name="newline" value="CRLF">
+<#-- decimal seperator: . or , -->
+<tmpl_par name="decsep" value=",">
+Name;Breitengrad;L?ngengrad;Typ1;Typ2;Waypoint;Datum;Hyperlink<br />
+<tmpl_loop cache_index>
+"<tmpl_var name=SHORTTYPE>-<tmpl_var name=SHORTSIZE>-<tmpl_var name=DIFFICULTY>-<tmpl_var name=TERRAIN> <tmpl_var name=NAME>";<tmpl_var name=LAT>;<tmpl_var name=LON>;"<tmpl_var name=TYPE>";"<tmpl_var name=SIZE>";"<tmpl_var name=WAYPOINT>";"<tmpl_var name=DATE>";"<tmpl_var name=URL>"<br />
+</tmpl_loop>


Property changes on: trunk/docs/TemplateExport.txt
___________________________________________________________________
Name: svn:eol-style
   + native



From pfeffer at mail.berlios.de  Tue Aug 28 14:37:20 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Tue, 28 Aug 2007 14:37:20 +0200
Subject: [Cachewolf-svn] r846 - in trunk/src: CacheWolf utils
Message-ID: <200708281237.l7SCbKBR027091@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-28 14:37:16 +0200 (Tue, 28 Aug 2007)
New Revision: 846

Modified:
   trunk/src/CacheWolf/SelectMap.java
   trunk/src/utils/FileBugfix.java
Log:
fix another small bug in ewe, (which didn't have any impact till now, but to avoid future problems)

Modified: trunk/src/CacheWolf/SelectMap.java
===================================================================
--- trunk/src/CacheWolf/SelectMap.java	2007-08-28 12:33:01 UTC (rev 845)
+++ trunk/src/CacheWolf/SelectMap.java	2007-08-28 12:37:16 UTC (rev 846)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import utils.FileBugfix;
 import ewe.util.*;
 import ewe.io.*;
 import ewe.filechooser.*;
@@ -37,7 +38,7 @@
 		InfoBox inf = new InfoBox("Info", (String)lr.get(4109,"Loading maps...")); 
 		inf.show();
 		try{
-			File files = new File(mapsPath);
+			File files = new FileBugfix(mapsPath);
 			File checkWFL;
 			String rawFileName = new String();
 			dateien = files.listMultiple("*.png,*.jpg,*.gif,*.bmp", File.LIST_FILES_ONLY);

Modified: trunk/src/utils/FileBugfix.java
===================================================================
--- trunk/src/utils/FileBugfix.java	2007-08-28 12:33:01 UTC (rev 845)
+++ trunk/src/utils/FileBugfix.java	2007-08-28 12:37:16 UTC (rev 846)
@@ -27,6 +27,14 @@
 		 * listmultiple doesn't have this bug 
 		 */
 	}
+	public String [] listMultiple(final String compositeMask,final int listAndSortOptions) {
+		/* super.listMultiple in ewe 1.49
+		 * usually works correct, but when called with Option Dirs_Only, it gives the dirs 
+		 * twice (once filtered by mask, once all)
+		 */
+		return listBugFixed (compositeMask, listAndSortOptions);
+	}
+	
 	public String[] listBugFixed(final String compositeMask,final int listAndSortOptions) {
 		String mask = (compositeMask == null) ? "*.*" : compositeMask; 
 		String[] found; //the following code is mainly copoed from FileBase.listmultiple to avoid recursion it is not called
@@ -39,7 +47,7 @@
 			found = super.list(null,File.LIST_FILES_ONLY|listAndSortOptions); // add files if not dirs only
 		else {
 			found = dirs; // if dirs only -> aplpy masks to the dirs
-			dirs = new String[0];
+			dirs = new String[0]; // this line is missing in ewe FileBase.listmultiple -> doubled dirs when using listmultiple with the option dirs_only
 		}
 
 		ewe.util.FileComparer [] fcs = new ewe.util.FileComparer[masks.length];



From mirabilos at mail.berlios.de  Tue Aug 28 14:37:30 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 14:37:30 +0200
Subject: [Cachewolf-svn] r847 - trunk/docs
Message-ID: <200708281237.l7SCbUba027104@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 14:37:29 +0200 (Tue, 28 Aug 2007)
New Revision: 847

Modified:
   trunk/docs/GPL_inclusion_per_source_file.txt
   trunk/docs/NotizenFuerEntwickler.txt
   trunk/docs/Readme.txt
   trunk/docs/Sonderzeichen_in_languages.cfg.txt
   trunk/docs/TemplateExport.txt
   trunk/docs/xml11.htm
Log:
while here: convert from windows-1252 to utf-8 and add the Byte
Order Mark (BOM) so that Windows editors such as Notepad will
correctly recognise the charset and display umlauts in these files


Modified: trunk/docs/GPL_inclusion_per_source_file.txt
===================================================================
--- trunk/docs/GPL_inclusion_per_source_file.txt	2007-08-28 12:37:16 UTC (rev 846)
+++ trunk/docs/GPL_inclusion_per_source_file.txt	2007-08-28 12:37:29 UTC (rev 847)
@@ -1,8 +1,8 @@
     /*
-    CacheWolf is a software for PocketPC, Win and Linux that 
-    enables paperless caching. 
+    CacheWolf is a software for PocketPC, Win and Linux that
+    enables paperless caching.
     It supports the sites geocaching.com and opencaching.de
-    
+
     Copyright (C) 2006  CacheWolf development team
     See http://developer.berlios.de/projects/cachewolf/
     for more information.

Modified: trunk/docs/NotizenFuerEntwickler.txt
===================================================================
--- trunk/docs/NotizenFuerEntwickler.txt	2007-08-28 12:37:16 UTC (rev 846)
+++ trunk/docs/NotizenFuerEntwickler.txt	2007-08-28 12:37:29 UTC (rev 847)
@@ -1,33 +1,31 @@
-Notizen f?r Entwickler:
+???Notizen f??r Entwickler:
 
 1. Zugriff auf globale Objekte:
-	Preferences pref = Global.getPref();	// Pr?ferenzen
+	Preferences pref = Global.getPref();	// Pr??ferenzen
 	Profile profile=Global.getProfile();	// Das aktuelle Profil
-	MainTab mainTab;						// Das mainTab Objekt (Enth?lt alle Ansichten)
-	
+	MainTab mainTab;						// Das mainTab Objekt (Enth??lt alle Ansichten)
+
 2. Aufzeichnung von internen Fehlern in der log.txt:
 	Die Datei log.txt wird bei jedem Spidervorgang neu generiert.
-	F?r die Aufzeichnung von Fehlern (oder auch nur Ablaufverfolgungen wie z.B. in SpiderGC)
-	stehen folgende Routinen zur Verf?gung (alle in Preferences.java)
-	
+	F??r die Aufzeichnung von Fehlern (oder auch nur Ablaufverfolgungen wie z.B. in SpiderGC)
+	stehen folgende Routinen zur Verf??gung (alle in Preferences.java)
+
 	public void log(String text)					// Beliebige Fehlermeldung mit Zeitstempel
 	public void log(String message,Exception e) 	// Exception mit Zeitstempel (nutzt obige Funktion)
 	public void log(String text,Throwable e, 		// Exception mit Zeitstempel und Stacktrace
-		boolean withStackTrace) 
-	
+		boolean withStackTrace)
+
 	Beispiel:
 	Global.getPref().log("Fehler bei xxx");
-	
+
 3. Debug-Schalter:
-	Es besteht die M?glichkeit ?ber einen undokumentierten Schalter in der pref.xml 
+	Es besteht die M??glichkeit ??ber einen undokumentierten Schalter in der pref.xml
 	"schlafenden" Debug-Code bei Probleme selektiv zu aktivieren. Dazu ist in der pref.xml
-	die Zeile 
+	die Zeile
 		<debug value="true">
-	einzuf?gen.
+	einzuf??gen.
 	Der Wert der debug Variablen kann dann wie folgt abgefragt werden:
 		if(Global.getPref().debug) {
-			// Code der nur ausgef?hrt wird wenn debug Schalter gesetzt
-			// z.B. ausf?hrlichere Fehlermeldung
+			// Code der nur ausgef??hrt wird wenn debug Schalter gesetzt
+			// z.B. ausf??hrlichere Fehlermeldung
 		}
-
-

Modified: trunk/docs/Readme.txt
===================================================================
--- trunk/docs/Readme.txt	2007-08-28 12:37:16 UTC (rev 846)
+++ trunk/docs/Readme.txt	2007-08-28 12:37:29 UTC (rev 847)
@@ -1,6 +1,6 @@
-???Wie bekomme ich eine brandaktuelle Version des CacheWolf? 
+???Wie bekomme ich eine brandaktuelle Version des CacheWolf?
 
-Die Sourcen von CacheWolf sind in einem Subversion-Repository bei www.berlios.de (Details siehe https://developer.berlios.de/svn/?group_id=2211) vorhanden, hierauf kann jeder lesend zugreifen. Schreibrechte werden auf Anfrage erteilt. Nachfolgend ist beschrieben, wie man sich die aktuelle Entwicklerversion besorgen kann und zum Laufen benommt. 
+Die Sourcen von CacheWolf sind in einem Subversion-Repository bei www.berlios.de (Details siehe https://developer.berlios.de/svn/?group_id=2211) vorhanden, hierauf kann jeder lesend zugreifen. Schreibrechte werden auf Anfrage erteilt. Nachfolgend ist beschrieben, wie man sich die aktuelle Entwicklerversion besorgen kann und zum Laufen benommt.
 
 CacheWolf wurde f??r und mit Ewe (http://www.ewesoft.com/) in Java programmiert. Ewe bietet f??r viele Plattformen sogenannte virtuelle Maschienen an, au??erdem k??nnen f??r Ewe geschriebene Programme auf allen Plattformen laufen, die eine Java-Laufzeitumgebung haben (nicht zu verwechseln mit dem "Handy-Java" J2ME).
 
@@ -37,4 +37,3 @@
  Es gibt dann die Unterverzeichnisse com, ewesoft und HTML
 - Script buildexe.bat bzw. ./buildexe.sh aufrufen, es wird ein Verzeichnis CacheWolf erzeugt mit Unterverzeichnissen f??r die unterschiedlichen Plattformen.
 - mit dem Script runjewel k??nnen ??nderungen an der Datei cwberlios.jnf vorgenommen werden.
-

Modified: trunk/docs/Sonderzeichen_in_languages.cfg.txt
===================================================================
--- trunk/docs/Sonderzeichen_in_languages.cfg.txt	2007-08-28 12:37:16 UTC (rev 846)
+++ trunk/docs/Sonderzeichen_in_languages.cfg.txt	2007-08-28 12:37:29 UTC (rev 847)
@@ -1,13 +1,13 @@
-Zeichen sind als "Quoted printable" kodiert mit einem % Zeichen
+???Zeichen sind als "Quoted printable" kodiert mit einem % Zeichen
 Siehe auch http://de.wikipedia.org/wiki/Quoted-printable
 und http://www.cs.tut.fi/~jkorpela/chars.html
 
 Leertaste: +
-? %e4
-? %f6 
-? %fc 
-? %df
-? %c4
-? %d6
-? %dc
-\n %0a
\ No newline at end of file
+?? %e4
+?? %f6
+?? %fc
+?? %df
+?? %c4
+?? %d6
+?? %dc
+\n %0a

Modified: trunk/docs/TemplateExport.txt
===================================================================
--- trunk/docs/TemplateExport.txt	2007-08-28 12:37:16 UTC (rev 846)
+++ trunk/docs/TemplateExport.txt	2007-08-28 12:37:29 UTC (rev 847)
@@ -1,6 +1,6 @@
-Short documentation for the export via templates
+???Short documentation for the export via templates
 
-Comment 
+Comment
 <#-- TomTom ASC or POI -->
 Anything between "<#--" and "-->" is handled as a comment
 
@@ -34,7 +34,7 @@
 TERRAIN
 DISTANCE: Distance calculated in cachelist
 BEARING: Bearing calculated in cachelist
-LATON: Coordinates in long format, e.g. N 50? 31.234 E 008? 45.267
+LATON: Coordinates in long format, e.g. N 50?? 31.234 E 008?? 45.267
 LAT: Latitude in decimal format, e.g. 50.20147
 LON: Longitude in decimal format, e.g. 008.58132
 STATUS
@@ -51,7 +51,7 @@
 <tmpl_par name="newline" value="CRLF">
 <#-- decimal seperator: . or , -->
 <tmpl_par name="decsep" value=",">
-Name;Breitengrad;L?ngengrad;Typ1;Typ2;Waypoint;Datum;Hyperlink<br />
+Name;Breitengrad;L??ngengrad;Typ1;Typ2;Waypoint;Datum;Hyperlink<br />
 <tmpl_loop cache_index>
 "<tmpl_var name=SHORTTYPE>-<tmpl_var name=SHORTSIZE>-<tmpl_var name=DIFFICULTY>-<tmpl_var name=TERRAIN> <tmpl_var name=NAME>";<tmpl_var name=LAT>;<tmpl_var name=LON>;"<tmpl_var name=TYPE>";"<tmpl_var name=SIZE>";"<tmpl_var name=WAYPOINT>";"<tmpl_var name=DATE>";"<tmpl_var name=URL>"<br />
 </tmpl_loop>

Modified: trunk/docs/xml11.htm
===================================================================
--- trunk/docs/xml11.htm	2007-08-28 12:37:16 UTC (rev 846)
+++ trunk/docs/xml11.htm	2007-08-28 12:37:29 UTC (rev 847)
@@ -1,21 +1,22 @@
-<html>
+???<html>
 	<head>
 		<title>Dokumentation Opencaching XML-Interface Version 1.1</title>
 		<meta name="vs_showGrid" content="True">
+		<meta http-equiv="content-type" content="text/html; charset=utf-8">
 	</head>
 	<body>
 		<h1>Dokumentation Opencaching XML-Interface Version 1.1</h1>
 		<p>
-			Das XML-Interface dient zum automatisierten abfragen aller Caches, Logeintr?ge, 
-			Benutzer und/oder Bilder. Dieses Interface ist nicht f?r Endbenutzer gedacht, 
-			sondern prim?r f?r Website-Entwickler.
+			Das XML-Interface dient zum automatisierten abfragen aller Caches, Logeintr??ge,
+			Benutzer und/oder Bilder. Dieses Interface ist nicht f??r Endbenutzer gedacht,
+			sondern prim??r f??r Website-Entwickler.
 		</p>
 		<h2>Ausgabeformat</h2>
 		<p>
-		Die Ausgabe ist eine oder mehrere xml,zip,gz&nbsp;oder bz2-Dateien. Es stehen 2 
-		?bertragungsmodi bereit: in Paketen zu&nbsp;je 500 Datens?tzen&nbsp;oder in 
+		Die Ausgabe ist eine oder mehrere xml,zip,gz&nbsp;oder bz2-Dateien. Es stehen 2
+		??bertragungsmodi bereit: in Paketen zu&nbsp;je 500 Datens??tzen&nbsp;oder in
 		einer Datei.
-		<P>Die folgenden XML-Abschnitte stehen zur Verf?gung. Sie werden immer in dieser 
+		<P>Die folgenden XML-Abschnitte stehen zur Verf??gung. Sie werden immer in dieser
 			Reihenfolge ausgegeben:
 			<ol>
 				<li>
@@ -25,28 +26,28 @@
 				<li>
 				cachedesc (Cachebeschreibungen)
 				<li>
-				cachelog (Logeintr?ge)
+				cachelog (Logeintr??ge)
 				<li>
 				picture (Bilder)
 				<li>
-					removedobject (gel?schte Objekte)</li>
+					removedobject (gel??schte Objekte)</li>
 			</ol>
 		<P></P>
 		<h3>Allgemeine XML-Elemente</h3>
 		<h4>lastmodified</h4>
-		<p>Datum an dem dieser Datensatz zuletzt ge?ndert wurde. Es werden keine 
-			Abh?ngigkeiten ber?cksichtigt. D.h. Wenn eine Cachebeschreibung ge?ndert wird, 
-			?ndert sich nur deren lastmodified, nicht jedoch das des Caches. Datumsangaben 
+		<p>Datum an dem dieser Datensatz zuletzt ge??ndert wurde. Es werden keine
+			Abh??ngigkeiten ber??cksichtigt. D.h. Wenn eine Cachebeschreibung ge??ndert wird,
+			??ndert sich nur deren lastmodified, nicht jedoch das des Caches. Datumsangaben
 			sind immer in der Form "yyyy-mm-dd hh:mm:ss" oder "yyyy-mm-dd"</p>
 		<h4>datecreated</h4>
 		<p>Datum an dem dieser Datensatz angelegt wurde.</p>
 		<h4>id</h4>
-		<p>Zu unterscheiden ist die id (identifier) und die uuid (universal unique 
-			identifier). Die id (Zahl) ist ein nur auf der jeweiligen Webseite g?ltiger 
-			identifier, w?hrend die uuid (alphanumerische Folge) auf jeder Seite die 
-			Opencaching-Daten verwendet g?ltig sein sollte. Beispiel: bei dem Datenabgleich 
-			von www.opencaching.de und devel.opencaching.de wird auf devel.opencaching.de 
-			eine neue id f?r den Datensatz erzeugt und die uuid beibhalten.</p>
+		<p>Zu unterscheiden ist die id (identifier) und die uuid (universal unique
+			identifier). Die id (Zahl) ist ein nur auf der jeweiligen Webseite g??ltiger
+			identifier, w??hrend die uuid (alphanumerische Folge) auf jeder Seite die
+			Opencaching-Daten verwendet g??ltig sein sollte. Beispiel: bei dem Datenabgleich
+			von www.opencaching.de und devel.opencaching.de wird auf devel.opencaching.de
+			eine neue id f??r den Datensatz erzeugt und die uuid beibhalten.</p>
 		<h3>user (Benutzerdaten)</h3>
 		<p>&lt;user&gt;<br>
 			&nbsp; &lt;id id="12345"&gt;4CE405E5-C110-CE00-9E88-8907F2212C73&lt;/id&gt;<br>
@@ -58,21 +59,21 @@
 		<h4>username</h4>
 		<p>Benutzername</p>
 		<h4>pmr</h4>
-		<p>1: Der Benutzer hat angegeben ein PMR-Funkger?t auf Kanal 2 mit auf Tour zu 
+		<p>1: Der Benutzer hat angegeben ein PMR-Funkger??t auf Kanal 2 mit auf Tour zu
 			nehmen.<br>
 			0: Keine Angabe</p>
 		<h3>cache (Caches)</h3>
 		<P>&lt;cache&gt;<BR>
 			&nbsp; &lt;id id="270"&gt;D455C916-7737-8210-F7FF-C6872E561CEB&lt;/id&gt;<br>
-			&nbsp; &lt;user id="113" uuid= 
+			&nbsp; &lt;user id="113" uuid=
 			"CAA9E3C5-50DF-4E9E-191F-CECABA6A8A19"&gt;&lt;![CDATA[TeamSchnitzeljagd]]&gt;&lt;/user&gt;<br>
 			&nbsp; &lt;name&gt;&lt;![CDATA[Pegeluhr]]&gt;&lt;/name&gt;<br>
 			&nbsp; &lt;longitude&gt;8.45058&lt;/longitude&gt;<br>
 			&nbsp; &lt;latitude&gt;49.46393&lt;/latitude&gt;<br>
-			&nbsp; &lt;type id="2" short="Trad."&gt;&lt;![CDATA[normaler 
+			&nbsp; &lt;type id="2" short="Trad."&gt;&lt;![CDATA[normaler
 			Cache]]&gt;&lt;/type&gt;<br>
-			&nbsp; &lt;status id="2"&gt;&lt;![CDATA[Momentan nicht 
-			verf?gbar]]&gt;&lt;/status&gt;<br>
+			&nbsp; &lt;status id="2"&gt;&lt;![CDATA[Momentan nicht
+			verf??gbar]]&gt;&lt;/status&gt;<br>
 			&nbsp; &lt;country id="DE"&gt;&lt;![CDATA[Deutschland]]&gt;&lt;/country&gt;<br>
 			&nbsp; &lt;size id="2"&gt;&lt;![CDATA[mikro]]&gt;&lt;/size&gt;<br>
 			&nbsp; &lt;desclanguages&gt;DE&lt;/desclanguages&gt;<br>
@@ -88,32 +89,32 @@
 		<p>
 			&lt;cachedesc&gt;<br>
 			&nbsp; &lt;id id="5697"&gt;9BA489ED-AC62-B26D-6EC8-4D52DF3CD008&amp;&lt;/id&gt;<br>
-			&nbsp; &lt;cacheid 
+			&nbsp; &lt;cacheid
 			id="4927"&gt;AB551E31-8633-0CD1-26AD-324355D4E920&lt;/cacheid&gt;<br>
 			&nbsp; &lt;language id="EN"&gt;&lt;![CDATA[Englisch]]&gt;&lt;/language&gt;<br>
-			&nbsp; &lt;shortdesc&gt;&lt;![CDATA[Drive-In-Cache especially for 
+			&nbsp; &lt;shortdesc&gt;&lt;![CDATA[Drive-In-Cache especially for
 			motorcyclists]]&gt;&lt;/shortdesc&gt;<br>
-			&nbsp; &lt;desc html="1"&gt;&lt;![CDATA[This MoCache is intended to connect the 
+			&nbsp; &lt;desc html="1"&gt;&lt;![CDATA[This MoCache is intended to connect the
 			MoCache series to other<br>
 			motorcycle-friendly caches on The Alb. Furthermore this great road<br>
 			between Erpfingen and Undingen was really worth it... &amp;lt;br /&amp;gt;<br>
 			&nbsp; &amp;lt;br /&amp;gt;<br>
-			&nbsp; &amp;lt;a 
-			href=&amp;quot;http://people.freenet.de/6x7/mocaches.html&amp;quot;&amp;gt;Other 
+			&nbsp; &amp;lt;a
+			href=&amp;quot;http://people.freenet.de/6x7/mocaches.html&amp;quot;&amp;gt;Other
 			MoCaches&lt;/a&amp;gt;<br>
 			&nbsp; ]]&gt;&lt;/desc&gt;<br>
 			&nbsp; &lt;hint&gt;&lt;![CDATA[guard rail pole]]&gt;&lt;/hint&gt;<br>
 			&nbsp; &lt;lastmodified&gt;2005-12-24 14:38:13&lt;/lastmodified&gt;<br>
 			&lt;/cachedesc&gt;
 		</p>
-		<h3>cachelog (Logeintr?ge)</h3>
+		<h3>cachelog (Logeintr??ge)</h3>
 		<p>
 			&lt;cachelog&gt;<br>
 			&nbsp; &lt;id id="13037"&gt;F0DAC335-0FA6-3479-45AF-03E2F6BC28B9&lt;/id&gt;<br>
-			&nbsp; &lt;cacheid 
+			&nbsp; &lt;cacheid
 			id="3439"&gt;048A8BF3-AA75-0741-CF60-6FBAE239EE11&lt;/cacheid&gt;<br>
-			&nbsp; &lt;user id="113" 
-			uuid="CAA9E3C5-50DF-4E9E-191F-CECABA6A8A19"&gt;&lt;![CDATA[Team 
+			&nbsp; &lt;user id="113"
+			uuid="CAA9E3C5-50DF-4E9E-191F-CECABA6A8A19"&gt;&lt;![CDATA[Team
 			Schnitzeljagd]]&gt;&lt;/user&gt;<BR>
 			&nbsp; &lt;type id="1"&gt;&lt;![CDATA[Gefunden]]&gt;&lt;/type&gt;<br>
 			&nbsp; &lt;date&gt;2005-05-18&lt;/date&gt;<br>
@@ -128,37 +129,37 @@
 		<p>
 			&lt;picture&gt;<br>
 			&nbsp; &lt;id id="4619"&gt;558990D1-4DE2-50AF-B53A-135E87704D70&lt;/id&gt;<br>
-			&nbsp; 
+			&nbsp;
 			&lt;url&gt;http://www.opencaching.de/images/uploads/558990D1-4DE2-50AF-B53A-135E87704D70.jpg&lt;/url&gt;<br>
 			&nbsp; &lt;title&gt;&lt;![CDATA[Schlurfende Gestalten]]&gt;&lt;/title&gt;<br>
 			&nbsp; &lt;desc html="0"&gt;&lt;/desc&gt;<br>
-			&nbsp; &lt;object id="73240" type="1" typename= 
+			&nbsp; &lt;object id="73240" type="1" typename=
 			"cachelog"&gt;4FE4B999-315D-43C1-11C2-2B81E68168CD&lt;/object&gt;<BR>
 			<SPAN class="m">&nbsp; &lt;</SPAN><SPAN class="t">attributes</SPAN>
-			<SPAN class="t">spoiler</SPAN><SPAN class="m">="</SPAN>0<SPAN class="m">"</SPAN><SPAN class="t"> display</SPAN><SPAN class="m">="</SPAN>1<SPAN class="m">"</SPAN><SPAN class="m"> /&gt;&lt; /SPAN&gt; 
+			<SPAN class="t">spoiler</SPAN><SPAN class="m">="</SPAN>0<SPAN class="m">"</SPAN><SPAN class="t"> display</SPAN><SPAN class="m">="</SPAN>1<SPAN class="m">"</SPAN><SPAN class="m"> /&gt;&lt; /SPAN&gt;
 			<br>
 			&nbsp; &lt;datecreated&gt;2005-12-24 01:01:38&lt;/datecreated&gt;<br>
 			&nbsp; &lt;lastmodified&gt;2005-12-24 01:01:38&lt;/lastmodified&gt;<br>
 			&lt;/picture&gt;
 		</p>
-		<h3>removedobject (gel?schte Objekte)</h3>
+		<h3>removedobject (gel??schte Objekte)</h3>
 		<p>
 			&lt;removedobject&gt;<br>
 			&nbsp; &lt;id id="748" /&gt;<br>
-			&nbsp; &lt;object id="2388" type="6" 
+			&nbsp; &lt;object id="2388" type="6"
 			typename="picture"&gt;3C5A2147-BC21-CC96-B240-E3BEA829D936&lt;/object&gt;<br>
 			&nbsp; &lt;removeddate&gt;2005-12-24 15:11:23&lt;/removeddate&gt;<br>
 			&lt;/removedobject&gt;
 		</p>
 		<h2>Datenauswahl</h2>
-		<p>Die Auswahl erfolgt zum einen durch den Paramter modifiedsince, mit dem 
-			inkrementelle Updates gesteuert werden, zum anderen ?ber eine Gebietsauswahl.</p>
-		<h3>Zu ?bertragende Daten ausw?hlen</h3>
-		<P>Folgende Parameter stehen zur Verf?gung um die zu ?bertragenden Daten 
-			auszuw?hlen.</P>
-		<P>Die Werte d?rfen 1 oder 0 sein, Default ist 0.<BR>
-			0=Datens?tze nicht ?bertragen<BR>
-			1=Datens?tze ?bertragen</P>
+		<p>Die Auswahl erfolgt zum einen durch den Paramter modifiedsince, mit dem
+			inkrementelle Updates gesteuert werden, zum anderen ??ber eine Gebietsauswahl.</p>
+		<h3>Zu ??bertragende Daten ausw??hlen</h3>
+		<P>Folgende Parameter stehen zur Verf??gung um die zu ??bertragenden Daten
+			auszuw??hlen.</P>
+		<P>Die Werte d??rfen 1 oder 0 sein, Default ist 0.<BR>
+			0=Datens??tze nicht ??bertragen<BR>
+			1=Datens??tze ??bertragen</P>
 		<UL>
 			<LI>
 			user
@@ -173,25 +174,25 @@
 			<LI>
 				removedobject</LI></UL>
 		<h3>modifiedsince</h3>
-		<p>Alle Datens?tz ?bertragen, die nach diesem Datum angelegt oder modifiziert 
+		<p>Alle Datens??tz ??bertragen, die nach diesem Datum angelegt oder modifiziert
 			wurden. Das Datumsformat ist yyyymmddhhnnss</p>
 		<h3>Gebietsauswahl</h3>
-		<p>Es muss keine Gebietsauswahl getroffen werden. Eine Kombination von Land und 
-			Koordinaten ist nicht m?glich.</p>
+		<p>Es muss keine Gebietsauswahl getroffen werden. Eine Kombination von Land und
+			Koordinaten ist nicht m??glich.</p>
 		<h4>Nach Land</h4>
-		<p>Parameter country ... wird dieser Parameter angegeben, werden nur Datens?tz 
-			?bertragen, die mit Caches in Zusammenhang stehen, die in diesem Land versteckt 
-			wurden. User-Records werden nicht ?bertragen, removedobjects werden alle 
-			?betragen.</p>
-		<P>F?r Bilder muss dabei angegeben werden, ob nur Bilder ?bertragen werden die 
+		<p>Parameter country ... wird dieser Parameter angegeben, werden nur Datens??tz
+			??bertragen, die mit Caches in Zusammenhang stehen, die in diesem Land versteckt
+			wurden. User-Records werden nicht ??bertragen, removedobjects werden alle
+			??betragen.</p>
+		<P>F??r Bilder muss dabei angegeben werden, ob nur Bilder ??bertragen werden die
 			von Caches stammen oder auch von Cachelogs:<BR>
 			Paramter: picturefromcachelog = 0/1, default 0</P>
 		<h4>Nach Koordinaten</h4>
-		<P>Parameter&nbsp;lat, lon, distance&nbsp;... werden diese Parameter angegeben, 
-			werden nur Datens?tz ?bertragen, die mit Caches in Zusammenhang stehen, die in 
-			diesem&nbsp;Gebiet versteckt wurden. User-Records werden nicht ?bertragen, 
-			removedobjects werden alle ?betragen.</P>
-		<P>F?r Bilder muss dabei angegeben werden, ob nur Bilder ?bertragen werden die 
+		<P>Parameter&nbsp;lat, lon, distance&nbsp;... werden diese Parameter angegeben,
+			werden nur Datens??tz ??bertragen, die mit Caches in Zusammenhang stehen, die in
+			diesem&nbsp;Gebiet versteckt wurden. User-Records werden nicht ??bertragen,
+			removedobjects werden alle ??betragen.</P>
+		<P>F??r Bilder muss dabei angegeben werden, ob nur Bilder ??bertragen werden die
 			von Caches stammen oder auch von Cachelogs:<BR>
 			Paramter: picturefromcachelog = 0/1, default 0</P>
 		<h3>Beispiele</h3>
@@ -207,41 +208,41 @@
 			<A>http://www.opencaching.de/xml/ocxml11.php?modifiedsince=&lt;date&gt;&amp;picture=1</A></P>
 		<P>6. Alle Bilder von Caches abrufen die in Deutschland versteckt sind<BR>
 			<A>http://www.opencaching.de/xml/ocxml11.php?modifiedsince=&lt;date&gt;&amp;picture=1&amp;country=DE</A></P>
-		<P>7. Alle Bilder von Caches und deren Logs abrufen die in Deutschland versteckt 
+		<P>7. Alle Bilder von Caches und deren Logs abrufen die in Deutschland versteckt
 			sind<BR>
 			<A>http://www.opencaching.de/xml/ocxml11.php?modifiedsince=&lt;date&gt;&amp;picture=1&amp;country=DE</A>&amp;picturefromcachelog=1</P>
-		<P>Diese Anfragen werden mit einem kurzen XML-Stream beantwortet, der die 
-			XML-Session-Id zur?ckgibt. Mit dieser Id k?nnen dann die Daten abgerufen 
+		<P>Diese Anfragen werden mit einem kurzen XML-Stream beantwortet, der die
+			XML-Session-Id zur??ckgibt. Mit dieser Id k??nnen dann die Daten abgerufen
 			werden.</P>
 		<P>&lt;?xml version="1.0"?&gt;<BR>
 			&lt;ocxmlsession&gt;<BR>
 			&nbsp; &lt;sessionid&gt;12345&lt;/sessionid&gt;<BR>
-			&nbsp; &lt;records user="193" cache="211" cachedesc="235" cachelog="439" 
+			&nbsp; &lt;records user="193" cache="211" cachedesc="235" cachelog="439"
 			picture="108" removeobject="19" /&gt;<BR>
 			&lt;/ocxmlsession&gt;</P>
-		<P>Die Sessionid ist 24h g?ltig, danach muss eine neue sessionid angefordert 
-			werden. Die Anzahl der Datens?tz muss nicht exakt mit den ?bertragenen 
-			?bereinstimmen - mehr Datens?tze werden jedoch auf keinen Fall ?bertragen. Die 
-			Summe der Datens?tze ist in diesem Beispiel 1205 - es werden also 3 Aufrufe 
-			ben?tigt (500, 500, 205 Datens?tze).</P>
-		<P>Die Daten k?nnen dann mit folgender Anfrage abgerufen werden:<BR>
+		<P>Die Sessionid ist 24h g??ltig, danach muss eine neue sessionid angefordert
+			werden. Die Anzahl der Datens??tz muss nicht exakt mit den ??bertragenen
+			??bereinstimmen - mehr Datens??tze werden jedoch auf keinen Fall ??bertragen. Die
+			Summe der Datens??tze ist in diesem Beispiel 1205 - es werden also 3 Aufrufe
+			ben??tigt (500, 500, 205 Datens??tze).</P>
+		<P>Die Daten k??nnen dann mit folgender Anfrage abgerufen werden:<BR>
 			<A>http://www.opencaching.de/xml/ocxml11.php?sessionid=12345&amp;file=1</A><BR>
 			<A>http://www.opencaching.de/xml/ocxml11.php?sessionid=12345&amp;file=2</A><BR>
 			<A>http://www.opencaching.de/xml/ocxml11.php?sessionid=12345&amp;file=3</A></P>
 		<H3>Alle Ergebnisse mit einem Aufruf abfragen</H3>
-		<P>Um alle Ergebnisse in einer Datei abzurufen muss bei dem Aufruf der Paramter 
+		<P>Um alle Ergebnisse in einer Datei abzurufen muss bei dem Aufruf der Paramter
 			session auf 0 gesetzt werden.</P>
 		<P>Beispeil:<BR>
 			<A>http://www.opencaching.de/xml/ocxml11.php?modifiedsince=&lt;date&gt;&amp;user=1&amp;cache=1&amp;cachedesc=1&amp;cachelog=1&amp;picture=1&amp;removedobject=1&amp;session=0</A></P>
 		<H3>Dateikomprimierung einstellen</H3>
-		<P>Dei Dateikomprimierung kann mit dem Paramter zip eingestellt weren. M?gliche 
-			Werte sind 0, zip, bzip2, gzip. Null bedeutet hier keine Kompression. Wird 
+		<P>Dei Dateikomprimierung kann mit dem Paramter zip eingestellt weren. M??gliche
+			Werte sind 0, zip, bzip2, gzip. Null bedeutet hier keine Kompression. Wird
 			keine Kompression angegeben, wird zip verwendet.</P>
 		<P>Beispeil:<BR>
 			<A>http://www.opencaching.de/xml/ocxml11.php?modifiedsince=&lt;date&gt;&amp;user=1&amp;cache=1&amp;cachedesc=1&amp;cachelog=1&amp;picture=1&amp;removedobject=1&amp;session=0&amp;zip=bzip2</A><BR>
 			<A>http://www.opencaching.de/xml/ocxml11.php?sessionid=12345&amp;file=1&amp;zip=gzip</A></P>
             <H3>XML-Optionen</H3>
-            <P>Die folgenden XML-Optionen m?ssen bei jedem Aufruf ?bergeben
+            <P>Die folgenden XML-Optionen m??ssen bei jedem Aufruf ??bergeben
             werden.</P>
             <P><a>xmldecl ... 0 = keine Xml-Deklaration / (Default) 1=Xml-Deklaration<br>
             doctype</a><a> ... 0 = keine Xml-Document-Type-Definition /
@@ -257,32 +258,32 @@
 		<H3>Sonstige Bemerkungen</H3>
 		<UL>
 			<LI>
-			F?r den ersten Aufruf des Interface muss als modifiedsince das Datum 1.8.2005 
-			um 00:00:00 Uhr angegeben werden. Es gibt keine Datens?tze die vor diesem Datum 
+			F??r den ersten Aufruf des Interface muss als modifiedsince das Datum 1.8.2005
+			um 00:00:00 Uhr angegeben werden. Es gibt keine Datens??tze die vor diesem Datum
 			angelegt wurden.
 			<LI>
-				Um Probleme wegen Differenzen der Uhrzeit zwischen Client und Server zu 
-				umgehen, muss f?r den n?chsten Inkrementellen Abruf der Daten das Datum um Kopf 
+				Um Probleme wegen Differenzen der Uhrzeit zwischen Client und Server zu
+				umgehen, muss f??r den n??chsten Inkrementellen Abruf der Daten das Datum um Kopf
 				der XML-Datei minus 1 Sekunde angeben werden:<BR>
-				<SPAN class="m"><BR>&lt;?</SPAN><SPAN class="pi">xml version="1.0" encoding="iso-8859-1" 
+				<SPAN class="m"><BR>&lt;?</SPAN><SPAN class="pi">xml version="1.0" encoding="iso-8859-1"
   standalone="no" </SPAN><SPAN class="m">?&gt;</SPAN>
 				<BR>
 				<SPAN><SPAN class="d">&lt;!DOCTYPE oc11xml<I>...</I>&gt;</SPAN>&nbsp;<BR></SPAN>&nbsp;
-				<SPAN class="m">&lt;</SPAN><SPAN class="t">oc11xml</SPAN><SPAN class="t"> 
-  version</SPAN><SPAN class="m">="</SPAN>1.1<SPAN class="m">"</SPAN><SPAN class="t"> 
-  date</SPAN><SPAN class="m">="</SPAN><STRONG>2006-03-10 18:37:34</STRONG><SPAN class="m">"</SPAN><SPAN class="t"> since</SPAN><SPAN class="m">="</SPAN>2006-03-08 
+				<SPAN class="m">&lt;</SPAN><SPAN class="t">oc11xml</SPAN><SPAN class="t">
+  version</SPAN><SPAN class="m">="</SPAN>1.1<SPAN class="m">"</SPAN><SPAN class="t">
+  date</SPAN><SPAN class="m">="</SPAN><STRONG>2006-03-10 18:37:34</STRONG><SPAN class="m">"</SPAN><SPAN class="t"> since</SPAN><SPAN class="m">="</SPAN>2006-03-08
 				22:02:42<SPAN class="m">"</SPAN><SPAN class="m">&gt;</SPAN>
 			<LI>
-			Zeitverschiebungen / unterschiedliche Zeitzonen zwischen Client und Server 
-			werden nicht unterst?tzt.
+			Zeitverschiebungen / unterschiedliche Zeitzonen zwischen Client und Server
+			werden nicht unterst??tzt.
 			<LI>
-			Das XML-Dokument enth?lt folgende DTD (Document Type Definition): 
+			Das XML-Dokument enth??lt folgende DTD (Document Type Definition):
 			http://www.opencaching.de/xml/ocxml11.dtd
 			<LI>
-			?nderungen werden des XML-Interface werden im Entwicklerforum bekanntgegeben: 
+			??nderungen werden des XML-Interface werden im Entwicklerforum bekanntgegeben:
 			http://develforum.opencaching.de/viewforum.php?f=2
 			<LI>
-				Fragen zum Interface k?nnen ebenfalls im Entwicklerforum&nbsp;gestellt werden: <A href="http://develforum.opencaching.de/viewforum.php?f=2">
+				Fragen zum Interface k??nnen ebenfalls im Entwicklerforum&nbsp;gestellt werden: <A href="http://develforum.opencaching.de/viewforum.php?f=2">
 					http://develforum.opencaching.de/viewforum.php?f=2</A>
 			<LI>
 				Der Quellcode des Interface kann hier downgeloadet werden: <A href="http://devel.opencaching.de/viewcvs/viewcvs.cgi/html/xml/ocxml11.php?rev=1.2&amp;content-type=text/vnd.viewcvs-markup">
@@ -295,7 +296,7 @@
 			<LI>
 			der Quellcode steht unter der GNU Gerneral Public Licenses
 			<LI>
-				f?r Daten die ?ber das XML-Interface downgeloadet werden, gelten die 
+				f??r Daten die ??ber das XML-Interface downgeloadet werden, gelten die
 				Nutzungsbedingungen von Opencaching.de <A href="http://www.opencaching.de/articles.php?page=impressum#tos">
 					http://www.opencaching.de/articles.php?page=impressum#tos</A></LI></UL>
 		<P>&nbsp;</P>



From tg at mirbsd.de  Tue Aug 28 14:39:01 2007
From: tg at mirbsd.de (Thorsten Glaser)
Date: Tue, 28 Aug 2007 12:39:01 +0000 (UTC)
Subject: [Cachewolf-svn] r845 - trunk/docs
In-Reply-To: <200708281233.l7SCXBH2026850@sheep.berlios.de>
References: <200708281233.l7SCXBH2026850@sheep.berlios.de>
Message-ID: <Pine.BSM.4.64L.0708281237590.30009@odem.66h.42h.de>

mirabilos at BerliOS dixit:

>Log:
>set the =E2=80=9Csvn:eol-style=E2=80=9D property to =E2=80=9Cnative=E2=80=
>=9D, so that these files

Ups. Ich werde mich wohl mal an den BerliOS Support wenden m?ssen oder
selber mir die entsprechenden Skripte ansehen, damit Umlaute und so in
Commitmessages richtig funktionieren.

Dieser Commit hatte ?brigens keine textuelle ?nderung, nur die Zeilen-
enden wurden angepa?t.

//mirabilos
-- 
I believe no one can invent an algorithm. One just happens to hit upon it
when God enlightens him. Or only God invents algorithms, we merely copy them.
If you don't believe in God, just consider God as Nature if you won't deny
existence.		-- Coywolf Qi Hunt


From mirabilos at mail.berlios.de  Tue Aug 28 14:48:02 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 14:48:02 +0200
Subject: [Cachewolf-svn] r848 - trunk/src/CacheWolf
Message-ID: <200708281248.l7SCm2QU027694@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 14:48:02 +0200 (Tue, 28 Aug 2007)
New Revision: 848

Modified:
   trunk/src/CacheWolf/AreaList.java
Log:
a totally empty file does not compile properly (in gcj), we need
at least the public class blah { line and the closing brace.


Modified: trunk/src/CacheWolf/AreaList.java
===================================================================
--- trunk/src/CacheWolf/AreaList.java	2007-08-28 12:37:29 UTC (rev 847)
+++ trunk/src/CacheWolf/AreaList.java	2007-08-28 12:48:02 UTC (rev 848)
@@ -5,9 +5,10 @@
  * Class for handling a list of areas covered by a list of maps.
  * this is needed to determine if a new map should be downloaded or
  * if a map for the requested area already exists
- * 
+ *
  * @author pfeffer
  *
+ */
  public class AreaList extends ewe.util.LinkedListElement { // in java since v1.2 I would use java.util.TreeSet
 /*
 	 public AreaList(int s) {super(s);}
@@ -63,10 +64,10 @@
 		 Area ret;
 		 for (int i=size()-1; i>=0; i--) {
 			 ret = ((Area)get(i));
-			 if(ret.isInBound(p)) return ret; 
+			 if(ret.isInBound(p)) return ret;
 		 }
 		 return null;
 	 }
 
+*/
  }
-*/



From mirabilos at mail.berlios.de  Tue Aug 28 14:57:49 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 14:57:49 +0200
Subject: [Cachewolf-svn] r849 - trunk
Message-ID: <200708281257.l7SCvn5P028614@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 14:57:48 +0200 (Tue, 28 Aug 2007)
New Revision: 849

Modified:
   trunk/buildexe.bat
   trunk/buildexe.sh
   trunk/compile.bat
   trunk/compile.sh
   trunk/getRes.bat
   trunk/getRes.sh
   trunk/runconsole.bat
   trunk/runewe.sh
   trunk/runjewel.bat
   trunk/runjewel.sh
   trunk/runwolf.bat
   trunk/runwolf.sh
Log:
more line endings, to make sure that windows users always have DOS CR-LF
line endings (which was not the case in runjewel.bat btw) and unix users
always have unix LF line endings


Modified: trunk/buildexe.bat
===================================================================
--- trunk/buildexe.bat	2007-08-28 12:48:02 UTC (rev 848)
+++ trunk/buildexe.bat	2007-08-28 12:57:48 UTC (rev 849)
@@ -1,3 +1,3 @@
-call getres.bat
-java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cwberlios.jnf
-pause
+call getres.bat
+java -cp lib/ewe.jar Ewe ../Ewe/programs/Jewel.ewe -c cwberlios.jnf
+pause


Property changes on: trunk/buildexe.bat
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/buildexe.sh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/compile.bat
===================================================================
--- trunk/compile.bat	2007-08-28 12:48:02 UTC (rev 848)
+++ trunk/compile.bat	2007-08-28 12:57:48 UTC (rev 849)
@@ -1,3 +1,3 @@
-if not exist bin\CacheWolf mkdir bin\CacheWolf
-if not exist bin\exp mkdir bin\exp
-javac -cp ./lib/CompileEwe.zip;./lib/ewesoft.zip;./lib/EwesoftRegex.zip;./lib/HTML.zip;./lib/openmap.jar  -d ./bin/ -deprecation ./src/CacheWolf/*.java ./src/exp/*.java ./src/utils/*.java
\ No newline at end of file
+if not exist bin\CacheWolf mkdir bin\CacheWolf
+if not exist bin\exp mkdir bin\exp
+javac -cp ./lib/CompileEwe.zip;./lib/ewesoft.zip;./lib/EwesoftRegex.zip;./lib/HTML.zip;./lib/openmap.jar  -d ./bin/ -deprecation ./src/CacheWolf/*.java ./src/exp/*.java ./src/utils/*.java


Property changes on: trunk/compile.bat
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/compile.sh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/getRes.bat
===================================================================
--- trunk/getRes.bat	2007-08-28 12:48:02 UTC (rev 848)
+++ trunk/getRes.bat	2007-08-28 12:57:48 UTC (rev 849)
@@ -1,13 +1,11 @@
-REM clean up
-del .\work\*.png
-del .\work\*.gif
-del .\work\*.html
-del .\work\*.tpl
-del .\work\*.ico
-REM get ressources
-copy .\resources\*.* .\work\*.*
-copy .\resources\attributes\*.* .\work\attributes\*.*
-copy .\lib\*.dll .\work\
-move .\work\cachewolf.Languages.cfg .\work\_config\
-
-
+REM clean up
+del .\work\*.png
+del .\work\*.gif
+del .\work\*.html
+del .\work\*.tpl
+del .\work\*.ico
+REM get ressources
+copy .\resources\*.* .\work\*.*
+copy .\resources\attributes\*.* .\work\attributes\*.*
+copy .\lib\*.dll .\work\
+move .\work\cachewolf.Languages.cfg .\work\_config\


Property changes on: trunk/getRes.bat
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/getRes.sh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/runconsole.bat
===================================================================
--- trunk/runconsole.bat	2007-08-28 12:48:02 UTC (rev 848)
+++ trunk/runconsole.bat	2007-08-28 12:57:48 UTC (rev 849)
@@ -1,4 +1,3 @@
-cd work
-java -Dcom.sun.management.jmxremote -cp ../lib/ewe.jar;../lib/ewesoft.zip;../lib/EwesoftRegex.zip;../lib/HTML.zip;../lib/openmap.jar;../bin Ewe CacheWolf.CacheWolf
-cd ..
-
+cd work
+java -Dcom.sun.management.jmxremote -cp ../lib/ewe.jar;../lib/ewesoft.zip;../lib/EwesoftRegex.zip;../lib/HTML.zip;../lib/openmap.jar;../bin Ewe CacheWolf.CacheWolf
+cd ..


Property changes on: trunk/runconsole.bat
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/runewe.sh
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/runjewel.bat
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/runjewel.sh
___________________________________________________________________
Name: svn:eol-style
   + native

Modified: trunk/runwolf.bat
===================================================================
--- trunk/runwolf.bat	2007-08-28 12:48:02 UTC (rev 848)
+++ trunk/runwolf.bat	2007-08-28 12:57:48 UTC (rev 849)
@@ -1,4 +1,3 @@
-cd work
-java -cp ../lib/ewe.jar;../lib/ewesoft.zip;../lib/EwesoftRegex.zip;../lib/HTML.zip;../lib/openmap.jar;../bin Ewe CacheWolf.CacheWolf
-cd ..
-
+cd work
+java -cp ../lib/ewe.jar;../lib/ewesoft.zip;../lib/EwesoftRegex.zip;../lib/HTML.zip;../lib/openmap.jar;../bin Ewe CacheWolf.CacheWolf
+cd ..


Property changes on: trunk/runwolf.bat
___________________________________________________________________
Name: svn:eol-style
   + native


Property changes on: trunk/runwolf.sh
___________________________________________________________________
Name: svn:eol-style
   + native



From mirabilos at mail.berlios.de  Tue Aug 28 20:56:59 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 20:56:59 +0200
Subject: [Cachewolf-svn] r850 - in trunk: resources src/CacheWolf
Message-ID: <200708281856.l7SIuxED000697@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 20:56:58 +0200 (Tue, 28 Aug 2007)
New Revision: 850

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/SpiderGC.java
Log:
- fix all uses of conn.setRequestorProperty() to use correct first argument:
  + it's "Cookie" not "Cookie: "
  + it's "User-Agent" not "USER_AGENT"
- fix logging and some (commented out) debugging
- fix a message


Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-08-28 12:57:48 UTC (rev 849)
+++ trunk/resources/cachewolf.Languages.cfg	2007-08-28 18:56:58 UTC (rev 850)
@@ -1015,7 +1015,7 @@
 		5508=Logging in...
 		5509=Coordinates for center must be set
 		5510=Spider Options
-		5511=Found
+		5511=Found+
 		5512=+caches
 		5513=Loading:+
 		5514=%0aGetting bug:+

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-28 12:57:48 UTC (rev 849)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-28 18:56:58 UTC (rev 850)
@@ -109,7 +109,7 @@
 			start = fetch(loginPage=p.getProperty("loginPage"));   //http://www.geocaching.com/login/Default.aspx
 		}catch (NullPointerException ex) {
 			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5497,"Error missing tag in spider.def") + ": loginPage", MessageBox.OKB)).execute();
-			pref.log("Error missing tag in spider.def: "+"loginPage",ex);
+			pref.log("Error missing tag in spider.def: loginPage",ex);
 			return ERR_LOGIN;
 		}catch(Exception ex){
 			infB.close(0);
@@ -172,7 +172,7 @@
 				cookieSession="";
 			} else
 				cookieSession = rexCookieSession.stringMatched(1);
-			//Vm.debug(cookieSession);
+			//Vm.debug("cookieSession = " + cookieSession);
 		}
 		boolean loginAborted=infB.isClosed;
 		infB.close(0);
@@ -1050,9 +1050,9 @@
 				} else {
 					conn = new HttpConnection(address);
 				}
-				conn.setRequestorProperty("USER_AGENT", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
+				conn.setRequestorProperty("User-Agent", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
 				if(cookieSession.length()>0){
-					conn.setRequestorProperty("Cookie: ", "ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
+					conn.setRequestorProperty("Cookie", "ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
 					pref.log("Cookie Zeug: " + "Cookie: ASP.NET_SessionId="+cookieSession +"; userid="+cookieID);
 				}
 				conn.setRequestorProperty("Connection", "close");
@@ -1064,8 +1064,8 @@
 				pref.log("Read socket ok");
 				JavaUtf8Codec codec = new JavaUtf8Codec();
 				c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
-				data = c_data.toString();
-				////Vm.debug(c_data.toString());
+				data += c_data.toString();
+				//Vm.debug("SpiderGC.fetch() result = " + data);
 				sock.close();
 			}catch(IOException ioex){
 				pref.log("IOException in fetch", ioex);
@@ -1126,11 +1126,11 @@
 					//Vm.debug(address + " / " + document);
 					//document = document + "\r\n";
 					//conn.setPostData(document.toCharArray());
-					conn.setRequestorProperty("USER_AGENT", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
+					conn.setRequestorProperty("User-Agent", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
 					conn.setPostData(codec.encodeText(document.toCharArray(),0,document.length(),true,null));
 					conn.setRequestorProperty("Content-Type", "application/x-www-form-urlencoded");
 					if(cookieSession.length()>0){
-						if (cookieSession!=null) conn.setRequestorProperty("Cookie: ", "ASP.NET_SessionId="+cookieSession+"; userid="+cookieID);
+						if (cookieSession!=null) conn.setRequestorProperty("Cookie", "ASP.NET_SessionId="+cookieSession+"; userid="+cookieID);
 					}
 					conn.setRequestorProperty("Connection", "close");
 					Socket sock = conn.connect();
@@ -1152,11 +1152,11 @@
 				//Vm.debug(address + " / " + document);
 				//document = document + "\r\n";
 				//conn.setPostData(document.toCharArray());
-				conn.setRequestorProperty("USER_AGENT", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
+				conn.setRequestorProperty("User-Agent", "Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0");
 				conn.setPostData(codec.encodeText(document.toCharArray(),0,document.length(),true,null));
 				conn.setRequestorProperty("Content-Type", "application/x-www-form-urlencoded");
 				if(cookieSession.length()>0){
-					conn.setRequestorProperty("Cookie: ", "ASP.NET_SessionId="+cookieSession+"; userid="+cookieID);
+					conn.setRequestorProperty("Cookie", "ASP.NET_SessionId="+cookieSession+"; userid="+cookieID);
 				}
 				conn.setRequestorProperty("Connection", "close");
 				Socket sock = conn.connect();



From mirabilos at mail.berlios.de  Tue Aug 28 21:17:41 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 21:17:41 +0200
Subject: [Cachewolf-svn] r851 - trunk/src/CacheWolf
Message-ID: <200708281917.l7SJHfGT002476@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 21:17:40 +0200 (Tue, 28 Aug 2007)
New Revision: 851

Modified:
   trunk/src/CacheWolf/SpiderGC.java
Log:
quick hack to unbreak spidering for lunix ewe:
prepend the HTTP reply headers to the received data,
so that the regexen can find it

found by pfeffer and myself; fix (workaround) by myself

someone (maybe I) should create a real fix later: the
regexen that look for the Set-Cookie: header should
directly use the conn.documentProperties instead


Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2007-08-28 18:56:58 UTC (rev 850)
+++ trunk/src/CacheWolf/SpiderGC.java	2007-08-28 19:17:40 UTC (rev 851)
@@ -1,8 +1,8 @@
 /*
-    CacheWolf is a software for PocketPC, Win and Linux that 
-    enables paperless caching. 
+    CacheWolf is a software for PocketPC, Win and Linux that
+    enables paperless caching.
     It supports the sites geocaching.com and opencaching.de
-    
+
     Copyright (C) 2006  CacheWolf development team
     See http://developer.berlios.de/projects/cachewolf/
     for more information.
@@ -30,17 +30,19 @@
 import ewe.util.*;
 import com.stevesoft.ewe_pat.*;
 import ewe.ui.*;
+import ewe.data.Property;
+import ewe.data.PropertyList;
 
 /**
 *	Class to spider caches from gc.com
 */
 public class SpiderGC{
-	
+
 	/**
 	 * The maximum number of logs that will be stored
 	 */
 	public static int MAXLOGS=250;
-	
+
 	private static int ERR_LOGIN = -10;
 	private static Preferences pref;
 	private Profile profile;
@@ -55,8 +57,8 @@
 	Hashtable indexDB;
 	InfoBox infB;
 	private boolean loggedIn = false;
-	private static Properties p=null; 
-	
+	private static Properties p=null;
+
 	public SpiderGC(Preferences prf, Profile profile, boolean bypass){
 		this.profile=profile;
 		this.cacheDB = profile.cacheDB;
@@ -69,12 +71,12 @@
 		} catch (Exception ex) {
 			p=null;
 			pref.log("Failed to load spider.def",ex);
-			// We don't display an error message box here, as the call to 
+			// We don't display an error message box here, as the call to
 			// spiderSingle or doIt will do this
 		}
 		MAXLOGS=pref.maxLogsToSpider;
 	}
-	
+
 	private boolean existsSpiderDef() {
 		if (p==null) {
 			(new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5504,"Could not load 'spider.def'"), MessageBox.OKB)).execute();
@@ -100,7 +102,7 @@
 		passwort = infB.getInput();
 		infB.close(0);
 		if(code != Form.IDOK) return code;
-		
+
 		// Now start the login proper
 		infB = new InfoBox(MyLocale.getMsg(5507,"Status"), MyLocale.getMsg(5508,"Logging in..."));
 		infB.exec();
@@ -154,7 +156,7 @@
 			    (new MessageBox(MyLocale.getMsg(5500,"Error"), MyLocale.getMsg(5501,"Login failed. Error loading page after login."), MessageBox.OKB)).execute();
 				return ERR_LOGIN;
 			}
-			
+
 			rex.search(start);
 			if (!rex.didMatch()) {
 				pref.log("Viewstate not found");
@@ -163,7 +165,7 @@
 			rexCookieID.search(start);
 			if (!rexCookieID.didMatch()) {
 				pref.log("CookieID not found");
-			} 
+			}
 			cookieID = rexCookieID.stringMatched(1);
 			//Vm.debug(cookieID);
 			rexCookieSession.search(start);
@@ -183,7 +185,7 @@
 			return Form.IDOK;
 		}
 	}
-	
+
 	/**
 	 * Method to spider a single cache.
 	 * It assumes a login has already been performed!
@@ -211,7 +213,7 @@
 			};
 			// Read the cache data from GC.COM and compare to old data
 			ret=getCacheByWaypointName(chD,true,true,false,true);
-			// Save the spidered data 
+			// Save the spidered data
 			if (ret) {
 				pref.log("Saving to:" + profile.dataDir);
 				chD.saveCacheDetails(profile.dataDir);
@@ -222,7 +224,7 @@
 		}
 		return ret;
 	} // spiderSingle
-	
+
 	/**
 	 * Fetch the coordinates of a waypoint from GC
 	 * @param wayPoint the name of the waypoint
@@ -246,9 +248,9 @@
 			return "";
 		}
 		infB.close(0);
-		return getLatLon(completeWebPage);	
+		return getLatLon(completeWebPage);
 	}
-	
+
 	/**
 	*	Method to start the spider for a search around the center coordinates
 	*/
@@ -274,9 +276,9 @@
 		String start = "";
 		Regex rex = new Regex("name=\"__VIEWSTATE\" value=\"(.*)\" />");
 		String doc = "";
-		
+
 		if(login() != Form.IDOK) return;
-	
+
 		OCXMLImporterScreen options = new OCXMLImporterScreen(MyLocale.getMsg(5510,"Spider Options"),	OCXMLImporterScreen.INCLUDEFOUND | OCXMLImporterScreen.DIST| OCXMLImporterScreen.IMAGES);
 		options.distanceInput.setText("");
 		if (options.execute() == OCXMLImporterScreen.IDCANCEL) {return; }
@@ -286,7 +288,7 @@
 		boolean doNotgetFound = options.foundCheckBox.getState();
 		boolean getImages = options.imagesCheckBox.getState();
 		options.close(0);
-		
+
 		//=======
 		// Prepare list of all caches that are to be spidered
 		//=======
@@ -309,7 +311,7 @@
 		}
 		dummy = "";
 		//String lineBlck = "";
-		int page_number = 4;		
+		int page_number = 4;
 		lineRex = new Regex(p.getProperty("lineRex")); //"<tr bgcolor=((?s).*?)</tr>"
 		int found_on_page = 0;
 		//Loop till maximum distance has been found or no more caches are in the list
@@ -358,7 +360,7 @@
 			//Vm.debug("Distance is now: " + distance);
 			found_on_page = 0;
 		}
-		
+
 		pref.log("Found " + cachesToLoad.size() + " caches");
 		if (!infB.isClosed) infB.setInfo(MyLocale.getMsg(5511,"Found ") + cachesToLoad.size() + MyLocale.getMsg(5512," caches"));
 
@@ -367,18 +369,18 @@
 		//=======
 		for(int i = 0; i<cachesToLoad.size(); i++){
 			if (infB.isClosed) break;
-			
+
 			wpt = (String)cachesToLoad.get(i);
 			// Get only caches not already available in the DB
 			if(searchWpt(wpt) == -1){
-				infB.setInfo(MyLocale.getMsg(5513,"Loading: ") + wpt +"(" + (i+1) + " / " + cachesToLoad.size() + ")");
+				infB.setInfo(MyLocale.getMsg(5513,"Loading: ") + wpt +" (" + (i+1) + " / " + cachesToLoad.size() + ")");
 				chD = new CacheHolderDetail();
 				chD.wayPoint=wpt;
 				if (!getCacheByWaypointName(chD,false,getImages,doNotgetFound,true)) break;
 				if (!chD.is_found || !doNotgetFound ) {
 					chD.saveCacheDetails(profile.dataDir);
 					cacheDB.add(new CacheHolder(chD)); // TODO Could copy into existing object
-				}					
+				}
 			}
 		}
 		infB.close(0);
@@ -390,9 +392,9 @@
 	 * Read a complete cachepage from geocaching.com including all logs. This is used both when
 	 * updating already existing caches (via spiderSingle) and when spidering around a centre. It
 	 * is also used when reading a GPX file and fetching the images.
-	 * 
+	 *
 	 * This is the workhorse function of the spider.
-	 * 
+	 *
 	 * @param CacheHolderDetail chD The element wayPoint must be set to the name of a waypoint
 	 * @param boolean isUpdate True if an existing cache is being updated, false if it is a new cache
 	 * @param boolean fetchImages True if the pictures are to be fetched
@@ -413,7 +415,7 @@
 			return !infB.isClosed; // Only return false (which terminates the loop over all caches) if infB is closed
 		}
 		// Only analyse the cache data and fetch pictures if user has not closed the progress window
-		if (!infB.isClosed) { 
+		if (!infB.isClosed) {
 			try{
 				chD.is_new = !isUpdate;
 				chD.is_update = false;
@@ -427,7 +429,7 @@
 				chD.addiWpts.clear();
 				chD.Images.clear();
 				chD.ImagesText.clear();
-				
+
 				if(completeWebPage.indexOf(p.getProperty("cacheUnavailable")) >= 0) chD.is_available = false;
 				if(completeWebPage.indexOf(p.getProperty("cacheArchived")) >= 0) chD.is_archived = true;
 				//==========
@@ -436,13 +438,13 @@
 				chD.LatLon = getLatLon(completeWebPage);
 				chD.pos.set(chD.LatLon);
 				if (pref.debug) pref.log("LatLon: " + chD.LatLon);
-				
+
 				pref.log("Trying description");
 				origLongDesc = chD.LongDescription;
 				chD.LongDescription = getLongDesc(completeWebPage);
 				if(isUpdate && !chD.LongDescription.equals(origLongDesc)) chD.is_update = true;
 				pref.log("Got description");
-				
+
 				pref.log("Getting cache name");
 				chD.CacheName = SafeXML.cleanback(getName(completeWebPage));
 				pref.log("Got cache name");
@@ -453,12 +455,12 @@
 				if(chD.CacheOwner.equals(pref.myAlias) || (pref.myAlias2.length()>0 && chD.CacheOwner.equals(pref.myAlias2))) chD.is_owned = true;
 				pref.log("Got owner");
 				if (pref.debug) pref.log("Owner: " + chD.CacheOwner +"; is_owned = "+chD.is_owned+";  alias1,2 = ["+pref.myAlias+"|"+pref.myAlias2+"]");
-				
+
 				pref.log("Trying date hidden");
 				chD.DateHidden = DateFormat.MDY2YMD(getDateHidden(completeWebPage));
 				pref.log("Got date hidden");
 				if (pref.debug) pref.log("Hidden: " + chD.DateHidden);
-				
+
 				pref.log("Trying hints");
 				chD.Hints = getHints(completeWebPage);
 				pref.log("Got hints");
@@ -468,12 +470,12 @@
 				chD.CacheSize = getSize(completeWebPage);
 				pref.log("Got size");
 				if (pref.debug) pref.log("Size: " + chD.CacheSize);
-				
+
 				pref.log("Trying difficulty");
 				chD.hard = getDiff(completeWebPage);
 				pref.log("Got difficulty");
 				if (pref.debug) pref.log("Hard: " + chD.hard);
-				
+
 				pref.log("Trying terrain");
 				chD.terrain = getTerr(completeWebPage);
 				pref.log("Got terrain");
@@ -483,7 +485,7 @@
 				chD.type = getType(completeWebPage);
 				pref.log("Got cache type");
 				if (pref.debug) pref.log("Type: " + chD.type);
-				
+
 				//==========
 				// Logs
 				//==========
@@ -503,15 +505,15 @@
 				if(isUpdate && chD.CacheLogs.size()>logsz) chD.is_log_update = true;
 				pref.log("Found logs");
 				// If the switch is set to not store found caches and we found the cache => return
-				if (chD.is_found && doNotGetFound) return !infB.isClosed; 
-				
+				if (chD.is_found && doNotGetFound) return !infB.isClosed;
+
 				//==========
 				// Bugs
 				//==========
 				// As there may be several bugs, we check whether the user has aborted
 				if (!infB.isClosed) getBugs(chD,completeWebPage);
 				chD.has_bug = chD.Travelbugs.size()>0;
-				
+
 				//==========
 				// Images
 				//==========
@@ -523,7 +525,7 @@
 				//==========
 				// Addi waypoints
 				//==========
-				
+
 				pref.log("Getting additional waypoints");
 				getAddWaypoints(completeWebPage, chD.wayPoint, chD.is_found);
 				pref.log("Got additional waypoints");
@@ -546,7 +548,7 @@
 		boolean ret=!infB.isClosed; // If the infoBox was closed before getting here, we return false
 		return ret;
 	} // getCacheByWaypointName
-	
+
 	/**
 	 * Check whether a waypoint is in the database
 	 * @param wpt Name of waypoint to check
@@ -558,7 +560,7 @@
 			return INTR.intValue();
 		} else return -1;
 	}
-	
+
 	/**
 	 * Get the Distance to the centre
 	 * @param doc A previously fetched cachepage
@@ -576,7 +578,7 @@
 	/**
 	 * Get the waypoint name
 	 * @param doc A previously fetched cachepage
-	 * @return Name of waypoint to add to list 
+	 * @return Name of waypoint to add to list
 	 */
 	private String getWP(String doc){
 		inRex = new Regex(p.getProperty("waypointRex"));
@@ -584,7 +586,7 @@
 		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
-	
+
 	/**
 	 * Get the coordinates of the cache
 	 * @param doc A previously fetched cachepage
@@ -596,7 +598,7 @@
 		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
-	
+
 	/**
 	 * Get the long description
 	 * @param doc A previously fetched cachepage
@@ -609,10 +611,10 @@
 		inRex.search(doc);
 		rex2.search(doc);
 		res = ((inRex.stringMatched(1)==null)?"":inRex.stringMatched(1)) + "<br>";
-		res += rex2.stringMatched(1); 
+		res += rex2.stringMatched(1);
 		return res; // SafeXML.cleanback(res);
 	}
-	
+
 	/**
 	 * Get the cache name
 	 * @param doc A previously fetched cachepage
@@ -624,7 +626,7 @@
 		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
-	
+
 	/**
 	 * Get the cache owner
 	 * @param doc A previously fetched cachepage
@@ -636,7 +638,7 @@
 		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
-	
+
 	/**
 	 * Get the date when the cache was hidden
 	 * @param doc A previously fetched cachepage
@@ -648,7 +650,7 @@
 		if (!inRex.didMatch()) return "???";
 		return inRex.stringMatched(1);
 	}
-	
+
 	/**
 	 * Get the hints
 	 * @param doc A previously fetched cachepage
@@ -660,7 +662,7 @@
 		if (!inRex.didMatch()) return "";
 		return inRex.stringMatched(1);
 	}
-	
+
 	/**
 	 * Get the cache size
 	 * @param doc A previously fetched cachepage
@@ -672,11 +674,11 @@
 		if(inRex.didMatch()) return inRex.stringMatched(1);
 		else return "None";
 	}
-	
+
 	/**
 	 * Get the Difficulty
 	 * @param doc A previously fetched cachepage
-	 * @return The cache difficulty 
+	 * @return The cache difficulty
 	 */
 	private String getDiff(String doc){
 		inRex = new Regex(p.getProperty("difficultyRex"));
@@ -684,7 +686,7 @@
 		if(inRex.didMatch()) return inRex.stringMatched(1);
 		else return "";
 	}
-	
+
 	/**
 	 * Get the terrain rating
 	 * @param doc A previously fetched cachepage
@@ -710,7 +712,7 @@
 	}
 
 	/**
-	 * Get the logs 
+	 * Get the logs
 	 * @param doc A previously fetched cachepage
 	 * @param chD Cache Details
 	 * @return A HTML string containing the logs
@@ -737,7 +739,7 @@
 		}
 		*/
 		String singleLog = "";
-		Extractor exSingleLog = new Extractor(doc,p.getProperty("singleLogExStart"), p.getProperty("singleLogExEnd"), 0, false); // maybe here is some change neccessary because findnext now gives the whole endstring back??? 
+		Extractor exSingleLog = new Extractor(doc,p.getProperty("singleLogExStart"), p.getProperty("singleLogExEnd"), 0, false); // maybe here is some change neccessary because findnext now gives the whole endstring back???
 		singleLog = exSingleLog.findNext();
 		Extractor exIcon = new Extractor(singleLog,p.getProperty("iconExStart"), p.getProperty("iconExEnd"), 0, true);
 		Extractor exNameTemp = new Extractor(singleLog,p.getProperty("nameTempExStart"), p.getProperty("nameTempExEnd"), 0 , true);
@@ -760,13 +762,13 @@
 			icon = exIcon.findNext();
 			name = exName.findNext();
 			String d=DateFormat.logdate2YMD(exDate.findNext());
-			if((icon.equals(p.getProperty("icon_smile")) || icon.equals(p.getProperty("icon_camera"))) && 
+			if((icon.equals(p.getProperty("icon_smile")) || icon.equals(p.getProperty("icon_camera"))) &&
 				(name.equals(pref.myAlias) || (pref.myAlias2.length()>0 && name.equals(pref.myAlias2))) )  {
 				chD.is_found = true;
 				chD.CacheStatus = d;
 			}
 			if (nLogs<=MAXLOGS) reslts.add("<img src='"+ icon +"'>&nbsp;" + d + " " + name +"<br>"+ exLog.findNext());
-			
+
 			singleLog = exSingleLog.findNext();
 			exIcon.setSource(singleLog);
 			exNameTemp.setSource(singleLog);
@@ -775,7 +777,7 @@
 			exDate.setSource(singleLog);
 			exLog.setSource(singleLog);
 			// We cannot simply stop if we have reached MAXLOGS just in case we are waiting for
-			// a log by our alias that happened earlier. 
+			// a log by our alias that happened earlier.
 			if (nLogs>=MAXLOGS && chD.is_found) break;
 		}
 		if (nLogs>MAXLOGS) {
@@ -783,14 +785,14 @@
 		}
 		return reslts;
 	}
-	
+
 	/**
 	 * Read the travelbug names from a previously fetched Cache page and then
 	 * read the travelbug purpose for each travelbug
 	 * @param doc The previously fetched cachepage
 	 * @return A HTML formatted string with bug names and there purpose
 	 */
-	public void getBugs(CacheHolderDetail chD, String doc){	
+	public void getBugs(CacheHolderDetail chD, String doc){
 		Extractor exBlock = new Extractor(doc,p.getProperty("blockExStart"),p.getProperty("blockExEnd") ,0,Extractor.EXCLUDESTARTEND);
 		String bugBlock = exBlock.findNext();
 		//Vm.debug("Bugblock: "+bugBlock);
@@ -825,9 +827,9 @@
 		}
 		infB.setInfo(oldInfoBox);
 	}
-	
+
 	/**
-	 * Get the images for a previously fetched cache page. Images are extracted 
+	 * Get the images for a previously fetched cache page. Images are extracted
 	 * from two areas: The long description and the pictures section (including
 	 * the spoiler)
 	 * @param doc The previously fetched cachepage
@@ -878,7 +880,7 @@
 						chD.ImagesText.add(imgName); // Keep the image name
 						imgCounter++;
 					}
-				} catch (IndexOutOfBoundsException e) { 
+				} catch (IndexOutOfBoundsException e) {
 					//Vm.debug("IndexOutOfBoundsException not in image span"+e.toString()+"imgURL:"+imgUrl);
 					pref.log("Problem loading image. imgURL:"+imgUrl);
 				}
@@ -916,13 +918,13 @@
 						chD.ImagesText.add(exImgName.findNext()); // Keep the image description
 						imgCounter++;
 					}
-				} catch (IndexOutOfBoundsException e) { 
-					pref.log("IndexOutOfBoundsException in image span. imgURL:"+imgUrl,e); 
+				} catch (IndexOutOfBoundsException e) {
+					pref.log("IndexOutOfBoundsException in image span. imgURL:"+imgUrl,e);
 				}
 			}
 		}
 	}
-	
+
 	/**
 	 * Read an image from the server
 	 * @param imgUrl The Url of the image
@@ -961,7 +963,7 @@
 		} finally {
 			//Continue with the spider
 		}
-	}		
+	}
 
 	/**
 	 * Read all additional waypoints from a previously fetched cachepage.
@@ -989,19 +991,19 @@
 				counter++;
 				try{ // If addi exists, try to read it to preserve the notes
 					cx.readCache(profile.dataDir);
-				} catch (Exception ex) {};	
+				} catch (Exception ex) {};
 				nameRex.search(rowBlock);
 				koordRex.search(rowBlock);
 				typeRex.search(rowBlock);
 				cx.CacheName = nameRex.stringMatched(1);
 				//Vm.debug("Addi: " + cx.CacheName);
-				if(koordRex.didMatch()) cx.pos.set(koordRex.stringMatched(1)); 
-				cx.LatLon = cx.pos.toString(); 
+				if(koordRex.didMatch()) cx.pos.set(koordRex.stringMatched(1));
+				cx.LatLon = cx.pos.toString();
 				//cx.pos.set(cx.LatLon);
 				if(typeRex.didMatch()) cx.type = CacheType.typeText2Number("Waypoint|"+typeRex.stringMatched(1));
 				rowBlock = exRowBlock.findNext();
 				descRex.search(rowBlock);
-				cx.LongDescription = descRex.stringMatched(1); 
+				cx.LongDescription = descRex.stringMatched(1);
 				//Vm.debug(descRex.stringMatched(1));
 				int idx=profile.getCacheIndex(cx.wayPoint);
 				cx.is_found = is_found;
@@ -1017,7 +1019,7 @@
 			}
 		}
 	}
-	
+
 	private void getAttributes(String doc, CacheHolderDetail chD) {
 		Extractor attBlock = new Extractor(doc,p.getProperty("attBlockExStart"),p.getProperty("attBlockExEnd"), 0 , true);
 		String atts = attBlock.findNext();
@@ -1029,15 +1031,15 @@
 			attribute=attEx.findNext();
 		}
 	}
-	
-	
+
+
 	/**
 	*	Performs an initial fetch to a given address. In this case
 	*	it will be a gc.com address. This method is used to obtain
 	*	the result of a search for caches screen.
 	*/
 	public static String fetch(String address)
-	   	{	
+	   	{
 			CharArray c_data;
 			String data="";
 			try{
@@ -1064,6 +1066,29 @@
 				pref.log("Read socket ok");
 				JavaUtf8Codec codec = new JavaUtf8Codec();
 				c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
+
+				/*
+				 * prepend the response headers to the document
+				 * like non-linux Ewe does
+				 *
+				 * @TODO directly use the properties in the
+				 * code which calls this method instead
+				 */
+				PropertyList pl = conn.documentProperties;
+				if (pl != null) {
+					StringBuffer sb = new StringBuffer();
+					boolean gotany = false;
+
+					for (int i = 0; i < pl.size(); i++) {
+						Property p = (Property)pl.get(i);
+						if (p.value != null) {
+							sb.append(p.name + ": " + p.value + "\r\n");
+							gotany = true;
+						}
+					}
+					if (gotany)
+						data += sb.toString() + "\r\n";
+				}
 				data += c_data.toString();
 				//Vm.debug("SpiderGC.fetch() result = " + data);
 				sock.close();
@@ -1074,15 +1099,15 @@
 			}
 			return data;
 		}
-	
+
 	/**
 	*	After a fetch to gc.com the next fetches have to use the post method.
 	*	This method does exactly that. Actually this method is generic in the sense
 	*	that it can be used to post to a URL using http post.
 	*/
-	private static String fetch_post(String address, String document, String path) throws IOException 
+	private static String fetch_post(String address, String document, String path) throws IOException
 	   	{
-			
+
 			//String line = "";
 			String totline = "";
 			if(pref.myproxy.length()==0){
@@ -1134,14 +1159,38 @@
 					}
 					conn.setRequestorProperty("Connection", "close");
 					Socket sock = conn.connect();
-					
+
 					//Vm.debug("getting stuff!");
 					ByteArray daten = conn.readData(sock);
 					//Vm.debug("coming back!");
 					CharArray c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
 					sock.close();
 					//Vm.debug(c_data.toString());
-					totline =  c_data.toString();
+					totline = "";
+
+					/*
+					 * prepend the response headers to the document
+					 * like non-linux Ewe does
+					 *
+					 * @TODO directly use the properties in the
+					 * code which calls this method instead
+					 */
+					PropertyList pl = conn.documentProperties;
+					if (pl != null) {
+						StringBuffer sb = new StringBuffer();
+						boolean gotany = false;
+
+						for (int i = 0; i < pl.size(); i++) {
+							Property p = (Property)pl.get(i);
+							if (p.value != null) {
+								sb.append(p.name + ": " + p.value + "\r\n");
+								gotany = true;
+							}
+						}
+						if (gotany)
+							totline += sb.toString() + "\r\n";
+					}
+					totline += c_data.toString();
 				} catch (Exception e) {
 				}
 			} else {
@@ -1160,20 +1209,44 @@
 				}
 				conn.setRequestorProperty("Connection", "close");
 				Socket sock = conn.connect();
-				
+
 				//Vm.debug("getting stuff!");
 				ByteArray daten = conn.readData(sock);
 				//Vm.debug("coming back!");
 				CharArray c_data = codec.decodeText(daten.data, 0, daten.length, true, null);
 				sock.close();
 				//Vm.debug(c_data.toString());
-				totline =  c_data.toString();
+				totline = "";
+
+				/*
+				 * prepend the response headers to the document
+				 * like non-linux Ewe does
+				 *
+				 * @TODO directly use the properties in the
+				 * code which calls this method instead
+				 */
+				PropertyList pl = conn.documentProperties;
+				if (pl != null) {
+					StringBuffer sb = new StringBuffer();
+					boolean gotany = false;
+
+					for (int i = 0; i < pl.size(); i++) {
+						Property p = (Property)pl.get(i);
+						if (p.value != null) {
+							sb.append(p.name + ": " + p.value + "\r\n");
+							gotany = true;
+						}
+					}
+					if (gotany)
+						totline += sb.toString() + "\r\n";
+				}
+				totline += c_data.toString();
 			}
 			return totline;
 		}
-	
+
 	final static String hex = ewe.util.TextEncoder.hex;
-	
+
 	public String encodeUTF8(String username) {
 		char [] what = ewe.sys.Vm.getStringChars(username);
 		int max = what.length;
@@ -1182,15 +1255,15 @@
 		for (int i = 0; i<max; i++){
 			char c = what[i];
 			if (c == ' ') c = '+';
-			else if (c<='\u00FF') { 
-				if(c <= ' ' || c == '+' || c == '&' || c == '%' || c == '=' || 
+			else if (c<='\u00FF') {
+				if(c <= ' ' || c == '+' || c == '&' || c == '%' || c == '=' ||
 				   c == '|' || c == '{' || c == '}' || c>'\u007F'){
 					dest[d++] = '%';
 					dest[d++] = hex.charAt((c >> 4) & 0xf);
 					dest[d++] = hex.charAt(c & 0xf);
 					continue;
 				}
-			
+
 			} else {
 				dest[d++] = '%';
 				dest[d++] = hex.charAt((c >> 12) & 0xf);
@@ -1204,7 +1277,7 @@
 		}
 		return new String(dest,0,d);
 	}
-	
+
 	/**
 	 * Load the bug id for a given name. This method is not ideal, as there are
 	 * sometimes several bugs with identical names but different IDs. Normally
@@ -1237,7 +1310,7 @@
 	}
 
 	/**
-	 * Fetch a bug's mission for a given GUID or ID. If the guid String is longer 
+	 * Fetch a bug's mission for a given GUID or ID. If the guid String is longer
 	 * than 10 characters it is assumed to be a GUID, otherwise it is an ID.
 	 * @param guid the guid or id of the travelbug
 	 * @return The mission
@@ -1263,8 +1336,4 @@
 		Extractor exDetails = new Extractor(bugDetails,p.getProperty("bugDetailsStart"),p.getProperty("bugDetailsEnd"),0,Extractor.EXCLUDESTARTEND);
 		return exDetails.findNext();
 	}
-
-
-
-
-}
\ No newline at end of file
+}



From mirabilos at mail.berlios.de  Tue Aug 28 21:19:25 2007
From: mirabilos at mail.berlios.de (mirabilos at BerliOS)
Date: Tue, 28 Aug 2007 21:19:25 +0200
Subject: [Cachewolf-svn] r852 - trunk/resources
Message-ID: <200708281919.l7SJJPC5002548@sheep.berlios.de>

Author: mirabilos
Date: 2007-08-28 21:19:24 +0200 (Tue, 28 Aug 2007)
New Revision: 852

Modified:
   trunk/resources/info.html
Log:
I guess I can add myself here now ;)


Modified: trunk/resources/info.html
===================================================================
--- trunk/resources/info.html	2007-08-28 19:17:40 UTC (rev 851)
+++ trunk/resources/info.html	2007-08-28 19:19:24 UTC (rev 852)
@@ -3,12 +3,12 @@
 <font face="Tahoma" size = "3">
 <strong>A geocaching programm</strong><br>
 <font face="Tahoma" size = "2"><em>
-from Bilbowolf, Kalli, Pfeffer, Reini, MiK, Blackeye501<br>
+from Bilbowolf, Kalli, Pfeffer, Reini, MiK, Blackeye501, mirabilos<br>
 for Windows, Linux and Pocket PC</em><br>
 <br>
 CacheWolf was created sometime 2003 to enable paperless caching with a Sharp Zaurus.
-As it was written in Java it was natural that after a while requests originated 
-asking if it was possible to run the Wolf on Pocket PCs. But the existing Java 
+As it was written in Java it was natural that after a while requests originated
+asking if it was possible to run the Wolf on Pocket PCs. But the existing Java
 Virtual Machines just did not deliver the required performance.<br>
 CacheWolf was then reprogrammed using EWE, a Java like virtual machine.<BR><BR>
 If you want to help us developing CacheWolf you are welcome!<BR><BR>
@@ -16,4 +16,4 @@
 CacheWolf Homepage: www.cachewolf.de<br>
 Discussions may be joined at: www.geoclub.de<br><br>
 <STRONG>Cache On 'n Cache hard!</STRONG>
-</font>
\ No newline at end of file
+</font>



From mik77 at mail.berlios.de  Tue Aug 28 23:27:31 2007
From: mik77 at mail.berlios.de (mik77 at mail.berlios.de)
Date: Tue, 28 Aug 2007 23:27:31 +0200
Subject: [Cachewolf-svn] r853 - trunk/src/CacheWolf
Message-ID: <200708282127.l7SLRV8p012098@sheep.berlios.de>

Author: mik77
Date: 2007-08-28 23:27:21 +0200 (Tue, 28 Aug 2007)
New Revision: 853

Modified:
   trunk/src/CacheWolf/GotoPanel.java
Log:
Coordinate format change now via context menu instead of radio buttons

Modified: trunk/src/CacheWolf/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/GotoPanel.java	2007-08-28 19:19:24 UTC (rev 852)
+++ trunk/src/CacheWolf/GotoPanel.java	2007-08-28 21:27:21 UTC (rev 853)
@@ -29,8 +29,6 @@
 	public Navigate myNavigation;
 	mButton btnGPS, btnCenter,btnSave;
 	mButton btnGoto, btnMap;
-	mCheckBox chkDMM, chkDMS, chkDD, chkUTM;
-	CheckBoxGroup chkFormat = new CheckBoxGroup();
 	int currFormat;
 
 	mLabel lblPosition, lblSats, lblSpeed, lblBearMov, lblBearWayP, lblDist, lblHDOP;
@@ -47,7 +45,6 @@
 	Preferences pref;
 	Profile profile;
 	// different panels to avoid spanning
-	CellPanel FormatP = new CellPanel();
 	CellPanel ButtonP = new CellPanel();
 	CellPanel CoordsP = new CellPanel();
 	CellPanel roseP = new CellPanel();
@@ -66,6 +63,9 @@
 
 	GotoRose rose;
 	int ticker = 0;
+	
+	Menu mnuContext;
+	MenuItem miDMM, miDMS, miDD, miUTM;
 
 	/**
 	 * Create GotoPanel 
@@ -88,25 +88,31 @@
 		ButtonP.addNext(btnSave = new mButton(MyLocale.getMsg(311,"Create Waypoint")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		ButtonP.addLast(btnMap = new mButton("Map"),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 
-		//Format selection for coords
-		FormatP.addNext(chkDD =new mCheckBox("d.d?"),CellConstants.DONTSTRETCH, CellConstants.WEST);
-		FormatP.addNext(chkDMM =new mCheckBox("d?m.m\'"),CellConstants.DONTSTRETCH, CellConstants.WEST);
-		FormatP.addNext(chkDMS =new mCheckBox("d?m\'s\""),CellConstants.DONTSTRETCH,CellConstants.WEST);
-		FormatP.addLast(chkUTM =new mCheckBox("UTM"),CellConstants.DONTSTRETCH, CellConstants.WEST);
-
-		chkDD.setGroup(chkFormat);
-		chkDMM.setGroup(chkFormat);
-		chkDMS.setGroup(chkFormat);
-		chkUTM.setGroup(chkFormat);
+		//Format selection for coords		
+		//context menu
+		mnuContext = new Menu();
+		mnuContext.addItem(miDD = new MenuItem("d.d?"));
+		miDD.modifiers &= ~MenuItem.Checked;
+		mnuContext.addItem(miDMM = new MenuItem("d?m.m\'"));
+		miDMM.modifiers |= MenuItem.Checked;
+		mnuContext.addItem(miDMS = new MenuItem("d?m\'s\""));
+		miDMS.modifiers &= ~MenuItem.Checked;
+		mnuContext.addItem(miUTM = new MenuItem("UTM"));
+		miUTM.modifiers &= ~MenuItem.Checked;
 		currFormat = CWPoint.DMM;
-		chkFormat.selectIndex(currFormat);
 
 		//Coords
 		CoordsP.addNext(lblGPS = new mLabel("GPS: "),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		lblGPS.backGround = RED;
+		lblGPS.setMenu(mnuContext);
+		lblGPS.modifyAll(Control.WantHoldDown, 0);
 		CoordsP.addLast(lblPosition = new mLabel(myNavigation.gpsPos.toString(currFormat)),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
+		lblPosition.setMenu(mnuContext);
+		lblPosition.modifyAll(Control.WantHoldDown, 0);
 		CoordsP.addNext(lblDST = new mLabel(MyLocale.getMsg(1500,"DST:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		lblDST.backGround = new Color(0,0,255);
+		lblDST.setMenu(mnuContext);
+		lblDST.modifyAll(Control.WantHoldDown, 0);
 		CoordsP.addLast(btnGoto = new mButton(getGotoBtnText()),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
 
 		//Rose for bearing
@@ -165,7 +171,6 @@
 
 		//add Panels
 		this.addLast(ButtonP,CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST).setTag(SPAN,new Dimension(2,1));
-		this.addLast(FormatP,CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST).setTag(SPAN,new Dimension(2,1));
 		this.addLast(CoordsP,CellConstants.HSTRETCH, CellConstants.HFILL|CellConstants.NORTH).setTag(SPAN,new Dimension(2,1));
 		this.addNext(roseP,CellConstants.DONTSTRETCH, CellConstants.DONTFILL|CellConstants.WEST).setTag(SPAN,new Dimension(1,1));
 		this.addLast(GotoP,CellConstants.HSTRETCH, CellConstants.HFILL|CellConstants.NORTHWEST).setTag(SPAN,new Dimension(1,2));
@@ -339,15 +344,44 @@
 	 */
 
 	public void onEvent(Event ev){
+		if (ev instanceof MenuEvent) { 
+			if (ev.type == MenuEvent.SELECTED ) {
+				MenuItem action = (MenuItem) mnuContext.getSelectedItem(); 
+				if (mnuContext.getSelectedItem() != null) {
+					if (action == miDD) {
+						mnuContext.close();
+						currFormat = CWPoint.DD;
+					}
+					if (action == miDMM) {
+						mnuContext.close();
+						currFormat = CWPoint.DMM;
+					}
+					if (action == miDMS) {
+						mnuContext.close();
+						currFormat = CWPoint.DMS;
+					}
+					if (action == miUTM) {
+						mnuContext.close();
+						currFormat = CWPoint.UTM;
+					}
+					miDD.modifiers &= ~MenuItem.Checked;
+					miDMM.modifiers &= ~MenuItem.Checked;
+					miDMS.modifiers &= ~MenuItem.Checked;
+					miUTM.modifiers &= ~MenuItem.Checked;
+					switch (currFormat) {
+					case CWPoint.DD: miDD.modifiers |= MenuItem.Checked; break;   
+					case CWPoint.DMM: miDMM.modifiers |= MenuItem.Checked; break;   
+					case CWPoint.DMS: miDMS.modifiers |= MenuItem.Checked; break;   
+					case CWPoint.UTM: miUTM.modifiers |= MenuItem.Checked; break;
+					}
 
-		if(ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED){
-			// display coords in another format
-			if (ev.target == chkFormat){
-				currFormat = chkFormat.getSelectedIndex();
-				lblPosition.setText(myNavigation.gpsPos.toString(currFormat));
-				btnGoto.setText(getGotoBtnText());
+					lblPosition.setText(myNavigation.gpsPos.toString(currFormat));
+					btnGoto.setText(getGotoBtnText());
+				}
 			}
+		}
 
+		if(ev instanceof ControlEvent && ev.type == ControlEvent.PRESSED){
 			// start/stop GPS connection
 			if (ev.target == btnGPS){
 				if (btnGPS.getText().equals("Start")) startGps();



From salzkammergut at mail.berlios.de  Thu Aug 30 22:49:30 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Thu, 30 Aug 2007 22:49:30 +0200
Subject: [Cachewolf-svn] r854 - trunk/src/CacheWolf
Message-ID: <200708302049.l7UKnUl1024761@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-30 22:49:28 +0200 (Thu, 30 Aug 2007)
New Revision: 854

Modified:
   trunk/src/CacheWolf/myTableModel.java
Log:
MyTableModel: Bugfix. Es wurde nach den falschen Spalten sortiert wenn Spalten anders angeordnet wurden.

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2007-08-28 21:27:21 UTC (rev 853)
+++ trunk/src/CacheWolf/myTableModel.java	2007-08-30 20:49:28 UTC (rev 854)
@@ -307,13 +307,16 @@
 			}
 			if(cell.y == -1){ // Hit a header => sort the table accordingly
 				CacheHolder ch=null;
+				// cell.x is the physical column but we have to sort by the
+				// column it is mapped into
+				int mappedCol=colMap[cell.x];
 				Vm.showWait(true);
 				Point a = tcControl.getSelectedCell(null);
 				if(a != null) ch = (CacheHolder)cacheDB.get(a.y);
-				if (cell.x == sortedBy) sortAsc=!sortAsc;
+				if (mappedCol == sortedBy) sortAsc=!sortAsc;
 				else sortAsc = false;
-				sortedBy = cell.x;
-				cacheDB.sort(new MyComparer(cacheDB, colName[cell.x],numRows), sortAsc);
+				sortedBy = mappedCol;
+				cacheDB.sort(new MyComparer(cacheDB, colName[mappedCol],numRows), sortAsc);
 				updateRows();
 				if(a != null){
 					int rownum = Global.getProfile().getCacheIndex(ch.wayPoint);



From salzkammergut at mail.berlios.de  Thu Aug 30 23:01:19 2007
From: salzkammergut at mail.berlios.de (salzkammergut at mail.berlios.de)
Date: Thu, 30 Aug 2007 23:01:19 +0200
Subject: [Cachewolf-svn] r855 - trunk/src/CacheWolf
Message-ID: <200708302101.l7UL1JWO027120@sheep.berlios.de>

Author: salzkammergut
Date: 2007-08-30 23:01:15 +0200 (Thu, 30 Aug 2007)
New Revision: 855

Modified:
   trunk/src/CacheWolf/Preferences.java
Log:
Preferences: Beim Erstellen von log.txt wird die Version von CW eingefuegt (um unnoetige Fragen bei geposteten Logs 
im Forum zum vermeiden)

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-08-30 20:49:28 UTC (rev 854)
+++ trunk/src/CacheWolf/Preferences.java	2007-08-30 21:01:15 UTC (rev 855)
@@ -471,6 +471,7 @@
 	public void logInit(){
 		File logFile = new File(LOGFILENAME);
 		logFile.delete();
+		log("CW Version "+Version.getRelease());
 	}
 	
 	/**



From pfeffer at mail.berlios.de  Thu Aug 30 23:18:40 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Thu, 30 Aug 2007 23:18:40 +0200
Subject: [Cachewolf-svn] r856 - trunk/src/CacheWolf
Message-ID: <200708302118.l7ULIeGQ028184@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-30 23:18:25 +0200 (Thu, 30 Aug 2007)
New Revision: 856

Added:
   trunk/src/CacheWolf/SkyOrientation.java
Modified:
   trunk/src/CacheWolf/GotoPanel.java
   trunk/src/CacheWolf/MovingMap.java
   trunk/src/CacheWolf/Navigate.java
Log:
Mond und Sterne k??nnen jetzt ausgew??hlt werden als Nachtnavigationshilfe im Kontextmen?? der Goto-Rose

Modified: trunk/src/CacheWolf/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/GotoPanel.java	2007-08-30 21:01:15 UTC (rev 855)
+++ trunk/src/CacheWolf/GotoPanel.java	2007-08-30 21:18:25 UTC (rev 856)
@@ -33,7 +33,7 @@
 
 	mLabel lblPosition, lblSats, lblSpeed, lblBearMov, lblBearWayP, lblDist, lblHDOP;
 	mLabel lblSatsText, lblSpeedText, lblDirText, lblDistText, lblSunAzimut;
-	mLabel lblGPS, lblDST, lblCurr, lblWayP;
+	mLabel lblGPS, lblDST, lblCurr, lblWayP, lblLuminary;
 	mLabel lblLog;
 	mCheckBox chkLog;
 	mInput inpLogSeconds;
@@ -64,9 +64,11 @@
 	GotoRose rose;
 	int ticker = 0;
 	
-	Menu mnuContext;
+	Menu mnuContextFormt;
 	MenuItem miDMM, miDMS, miDD, miUTM;
-
+	
+	Menu mnuContextRose;
+	MenuItem miLuminary[] = new MenuItem[SkyOrientation.LUMINARY_NAMES.length];
 	/**
 	 * Create GotoPanel 
 	 * @param Preferences 	global preferences
@@ -90,34 +92,44 @@
 
 		//Format selection for coords		
 		//context menu
-		mnuContext = new Menu();
-		mnuContext.addItem(miDD = new MenuItem("d.d?"));
+		mnuContextFormt = new Menu();
+		mnuContextFormt.addItem(miDD = new MenuItem("d.d?"));
 		miDD.modifiers &= ~MenuItem.Checked;
-		mnuContext.addItem(miDMM = new MenuItem("d?m.m\'"));
+		mnuContextFormt.addItem(miDMM = new MenuItem("d?m.m\'"));
 		miDMM.modifiers |= MenuItem.Checked;
-		mnuContext.addItem(miDMS = new MenuItem("d?m\'s\""));
+		mnuContextFormt.addItem(miDMS = new MenuItem("d?m\'s\""));
 		miDMS.modifiers &= ~MenuItem.Checked;
-		mnuContext.addItem(miUTM = new MenuItem("UTM"));
+		mnuContextFormt.addItem(miUTM = new MenuItem("UTM"));
 		miUTM.modifiers &= ~MenuItem.Checked;
 		currFormat = CWPoint.DMM;
 
+		// Create context menu for compass rose: select luminary for orientation
+		mnuContextRose = new Menu();
+		for (int i=0; i<SkyOrientation.LUMINARY_NAMES.length; i++) {
+			mnuContextRose.addItem(miLuminary[i] = new MenuItem(SkyOrientation.getLuminaryName(i)));
+			if (i == myNavigation.luminary) miLuminary[i].modifiers |= MenuItem.Checked;
+			else miLuminary[i].modifiers &= MenuItem.Checked;
+		}
+
 		//Coords
 		CoordsP.addNext(lblGPS = new mLabel("GPS: "),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		lblGPS.backGround = RED;
-		lblGPS.setMenu(mnuContext);
+		lblGPS.setMenu(mnuContextFormt);
 		lblGPS.modifyAll(Control.WantHoldDown, 0);
 		CoordsP.addLast(lblPosition = new mLabel(myNavigation.gpsPos.toString(currFormat)),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
-		lblPosition.setMenu(mnuContext);
+		lblPosition.setMenu(mnuContextFormt);
 		lblPosition.modifyAll(Control.WantHoldDown, 0);
 		CoordsP.addNext(lblDST = new mLabel(MyLocale.getMsg(1500,"DST:")),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		lblDST.backGround = new Color(0,0,255);
-		lblDST.setMenu(mnuContext);
+		lblDST.setMenu(mnuContextFormt);
 		lblDST.modifyAll(Control.WantHoldDown, 0);
 		CoordsP.addLast(btnGoto = new mButton(getGotoBtnText()),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.WEST));
 
 		//Rose for bearing
 		compassRose = new GotoRose("rose.png");
 		icRose = new ImageControl(compassRose);
+		icRose.setMenu(mnuContextRose);
+		icRose.modifyAll(Control.WantHoldDown, 0); // this is necessary in order to make PenHold on a PDA work as right click
 		roseP.addLast(icRose,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.NORTH));
 
 		//Goto
@@ -160,9 +172,9 @@
 		chkLog.setState(false);
 		inpLogSeconds.columns = 5;
 
-		LogP.addNext(lblGPS = new mLabel("Sonne: "),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-		lblGPS.backGround = YELLOW;
-		lblGPS.setTag(SPAN, new Dimension(2,1));
+		LogP.addNext(lblLuminary = new mLabel(SkyOrientation.getLuminaryName(myNavigation.luminary)),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+		lblLuminary.backGround = YELLOW;
+		lblLuminary.setTag(SPAN, new Dimension(2,1));
 
 		LogP.addLast(lblSunAzimut = new mLabel("---"),CellConstants.HSTRETCH, (CellConstants.HFILL|CellConstants.NORTH));
 		lblSunAzimut.setText("---");
@@ -275,7 +287,7 @@
 			lblPosition.setText(myNavigation.gpsPos.toString(currFormat));
 			speed.set(myNavigation.gpsPos.getSpeed());
 			lblSpeed.setText(MyLocale.formatDouble(speed,"0.0") + " km/h");
-			sunAzimut.set((double)myNavigation.sunAzimut);
+			sunAzimut.set(myNavigation.skyOrientationDir.lonDec);
 			if (sunAzimut.value >= -360) lblSunAzimut.setText(MyLocale.formatDouble(sunAzimut,"0.0") + " Grad");
 			else lblSunAzimut.setText("--- Grad");
 			bearMov.set(myNavigation.gpsPos.getBear());
@@ -346,22 +358,22 @@
 	public void onEvent(Event ev){
 		if (ev instanceof MenuEvent) { 
 			if (ev.type == MenuEvent.SELECTED ) {
-				MenuItem action = (MenuItem) mnuContext.getSelectedItem(); 
-				if (mnuContext.getSelectedItem() != null) {
+				MenuItem action = (MenuItem) mnuContextFormt.getSelectedItem(); 
+				if (action != null) {
 					if (action == miDD) {
-						mnuContext.close();
+						mnuContextFormt.close();
 						currFormat = CWPoint.DD;
 					}
 					if (action == miDMM) {
-						mnuContext.close();
+						mnuContextFormt.close();
 						currFormat = CWPoint.DMM;
 					}
 					if (action == miDMS) {
-						mnuContext.close();
+						mnuContextFormt.close();
 						currFormat = CWPoint.DMS;
 					}
 					if (action == miUTM) {
-						mnuContext.close();
+						mnuContextFormt.close();
 						currFormat = CWPoint.UTM;
 					}
 					miDD.modifiers &= ~MenuItem.Checked;
@@ -377,6 +389,16 @@
 
 					lblPosition.setText(myNavigation.gpsPos.toString(currFormat));
 					btnGoto.setText(getGotoBtnText());
+				} // end lat-lon-format context menu
+				action = (MenuItem) mnuContextRose.getSelectedItem();
+				if (action != null) {
+					for (int i=0; i<miLuminary.length; i++) {
+						if (action == miLuminary[i]) {
+							myNavigation.setLuminary(i);
+							miLuminary[i].modifiers |= MenuItem.Checked;
+							lblLuminary.setText(SkyOrientation.getLuminaryName(myNavigation.luminary));
+						} else miLuminary[i].modifiers &= ~MenuItem.Checked;
+					}
 				}
 			}
 		}

Modified: trunk/src/CacheWolf/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/MovingMap.java	2007-08-30 21:01:15 UTC (rev 855)
+++ trunk/src/CacheWolf/MovingMap.java	2007-08-30 21:18:25 UTC (rev 856)
@@ -855,7 +855,7 @@
 		// runMovingMap neccessary in case of multi-threaded Java-VM: ticked could be called during load of mmp 
 		if ((fix > 0) && (myNavigation.gpsPos.getSats()>= 0)) { // TODO is getSats really necessary?
 			directionArrows.setDirections((float)myNavigation.gpsPos.getBearing(myNavigation.destination),
-					myNavigation.sunAzimut, (float)myNavigation.gpsPos.getBear());
+					(float)myNavigation.skyOrientationDir.lonDec, (float)myNavigation.gpsPos.getBear());
 			setGpsStatus(MovingMap.gotFix);
 			updatePosition(myNavigation.gpsPos.latDec, myNavigation.gpsPos.lonDec);
 			ShowLastAddedPoint(myNavigation.curTrack);

Modified: trunk/src/CacheWolf/Navigate.java
===================================================================
--- trunk/src/CacheWolf/Navigate.java	2007-08-30 21:01:15 UTC (rev 855)
+++ trunk/src/CacheWolf/Navigate.java	2007-08-30 21:18:25 UTC (rev 856)
@@ -15,7 +15,8 @@
 	public CWGPSPoint gpsPos = new CWGPSPoint();
 	public Track curTrack = null;
 	Color trackColor = new Color(255,0,0); // red
-	public float sunAzimut = -361;
+	CWPoint skyOrientationDir = new CWPoint();
+	int luminary = SkyOrientation.SUN;
 
 	public GotoPanel gotoPanel = null;
 	public MovingMap movingMap = null;
@@ -95,6 +96,13 @@
 		if (gotoPanel != null) gotoPanel.destChanged(destination);
 		if (movingMap != null) movingMap.destChanged(destination);
 	}
+	/**
+	 * use the constants SkyOrientation.SUN, SkyOrientation.MOON etc.
+	 * @param lu
+	 */
+	public void setLuminary(int lu) {
+		luminary = lu;
+	}
 	public void ticked() {
 		int fix = gpsPos.getFix();
 		if (fix > 0 && (gpsPos.getSats()>= 0)) {
@@ -109,365 +117,116 @@
 				if (movingMap != null) movingMap.addTrack(curTrack); // TODO maybe gotoPanel should also hold a list of Tracks, because otherwise they will be destroyed if not saved in mmp before
 			}
 			try {
-				sunAzimut = getSunAzimut(gpsPos.Time, gpsPos.Date, gpsPos.latDec, gpsPos.lonDec);
+				SkyOrientation.getSunAzimut(gpsPos.Time, gpsPos.Date, gpsPos.latDec, gpsPos.lonDec);
+				double jd = SkyOrientation.utc2juliandate(gpsPos.Time, gpsPos.Date);
+				skyOrientationDir = SkyOrientation.getLuminaryDir(luminary, jd, gpsPos);
+				ewe.sys.Vm.debug("neu: "+ skyOrientationDir.lonDec+ "jd: " + jd);
 			} catch (NumberFormatException e) { // irgendeine Info zu Berechnung des Sonnenaziumt fehlt (insbesondere Datum und Uhrzeit sind nicht unbedingt gleichzeitig verf?gbar wenn es einen Fix gibt)
-				sunAzimut = -361; // any value out of range (bigger than 360) will prevent drawArrows from drawing it 
+				skyOrientationDir.set(-361, -361); // any value out of range (bigger than 360) will prevent drawArrows from drawing it 
 			}
 
 		} else {
-			sunAzimut = -361;
+			skyOrientationDir.set(-361, -361); // any value out of range (bigger than 360) will prevent drawArrows from drawing it		
 		}
 		gotoPanel.updateGps(fix);
 		if (movingMap != null) movingMap.updateGps(fix);
 	}
+}
 
-	/**
-	 * @param utc in the format as it comes from gps DDMMYY
-	 * @param datum in the format as it comes from gps HHMMSS
-	 * @param lat in degrees in WGS84
-	 * @param lon in degrees in WGS84
-	 * @return Azimut of the sun in degrees from north
-	 * @throws NumberFormatException when utc / datum could not be interpreted
-	 * this is prgrammed acording to the algorithmus described in http://de.wikipedia.org/wiki/Sonnenstand
-	 */
-	public static float getSunAzimut (String utc, String datum, double lat, double lon) {
-		//	(new MessageBox("test", "utc:"+utc+" datum: "+datum+", lat: "+lat+", len: "+lon, MessageBox.OKB)).exec();
-		try {
-			int tag, monat, jahr, stunde, minute, sekunde;
-			tag = Convert.parseInt(datum.substring(0, 2));
-			monat = Convert.parseInt(datum.substring(2, 4));
-			jahr = Convert.parseInt(datum.substring(4, 6)) + 2000;
-			stunde=Convert.parseInt(utc.substring(0, 2));
-			minute=Convert.parseInt(utc.substring(2, 4));
-			sekunde=Convert.parseInt(utc.substring(4, 6)); // Kommastellen werden abgeschnitten
-			// julianisches "Datum" jd berechnen (see http://de.wikipedia.org/wiki/Julianisches_Datum )
-			if (monat<2) {jahr--; monat+=12;} // verlegung des Jahres Endes auf Feb macht Berechnung von SChaltjahren einfacher
-			double a = (int)java.lang.Math.floor((double)jahr/100.); // Alle hundert Jahre kein Schlatjahr (abrunden)
-			double b = 2 - a + java.lang.Math.floor((double)a/4.);
-			double jd = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) + (double)tag + (double)stunde/24 + (double)minute/1440 + (double)sekunde/86400 + b - 1524.5;
-			double jd0 = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) +(double)tag + b - 1524.5;
-			// Ekliptikalkoordinaten der Sonne berechnen (see http://de.wikipedia.org/wiki/Sonnenstand )
-			double n = jd - 2451545.0;
-			double l = 280.46 + 0.9856474 * n;
-			double g = 357.528 + 0.9856003 * n;
-			double d = l + 1.915*java.lang.Math.sin(g/180*java.lang.Math.PI) + 0.02 * java.lang.Math.sin(2*g/180*java.lang.Math.PI);
-			// Rektaszension alpha und Deklination delta der Sonne berechnen
-			double e = 23.439 -0.0000004 * n;
-			double alphaNenner = java.lang.Math.cos(d/180*java.lang.Math.PI);
-			double alpha = 180/java.lang.Math.PI*java.lang.Math.atan(java.lang.Math.cos(e/180*java.lang.Math.PI)*java.lang.Math.sin(d/180*java.lang.Math.PI)/alphaNenner);
-			double delta = 180/java.lang.Math.PI*java.lang.Math.asin(java.lang.Math.sin(e/180*java.lang.Math.PI)*java.lang.Math.sin(d/180*java.lang.Math.PI) );
-			if (alphaNenner<0) {alpha +=180;}
-			// Azimut
-			double t0 = (jd0 - 2451545.)/36525.; // schon in t0 bzw jd0 richtig berechnet?
-			double thetaHG = 6.697376 + 2400.05134 * t0 + 1.002738 * ((double)stunde + (double)minute/60. + (double)sekunde/3600.);
-			double theta = thetaHG * 15. + lon;
-			double azimutNenner = java.lang.Math.cos((theta-alpha)/180*java.lang.Math.PI)*java.lang.Math.sin(lat/180*java.lang.Math.PI)-
-			java.lang.Math.tan(delta/180*java.lang.Math.PI)*java.lang.Math.cos(lat/180*java.lang.Math.PI);
-			float azimut = (float) java.lang.Math.atan(java.lang.Math.sin((theta-alpha)/180*java.lang.Math.PI)/
-					azimutNenner);
-			azimut = (float) (azimut * 180f / java.lang.Math.PI);
-			if (azimutNenner<0) azimut +=180.;
-			// null = Sueden auf Null = Norden umrechnen
-			azimut +=180.;
-			if (azimut >360.) azimut -=360.;
-		/*	ewe.sys.Vm.debug("sunAzimut1: " + azimut);
-			ewe.sys.Vm.debug("sun Elevation: " +getSunAzimut2 (utc, datum, lat, lon).latDec);
-			CWPoint MoonDir = getMoonAzimut(jd, new CWPoint(lat, lon));
-			ewe.sys.Vm.debug("Moon Elevation: " + MoonDir.latDec + "Moon Azimut: " + MoonDir.lonDec);
-			CWPoint OrionDir = getOrionAzimut(jd, new CWPoint(lat, lon));
-			ewe.sys.Vm.debug("Alnilam (Orion) Elevation: " + OrionDir.latDec + "Alnilam (Orion) Azimut: " + OrionDir.lonDec );
-			*/
-			return azimut;
-		} catch (IndexOutOfBoundsException e) {
-			// wird von substring geworfen wenn datum / utc nicht genug Ziffern haben
-			// NumberFormatException wird au?erdem von Convert.ParseInt direkt geworfen wenn
-			// nicht in Int konvertiert werden kann
-			throw new NumberFormatException();
-		}
-	}
+/**
+ * Thread for reading data from COM-port
+ *
+ */
+class SerialThread extends mThread{
+	SerialPort comSp;   
+	byte[] comBuff = new byte[1024*10]; // when some action takes a long time (eg. loading or zooming a map), a lot of data can be in the buffer, read that at once
+	int comLength = 0;
+	CWGPSPoint myGPS;
+	boolean run, tcpForward;
+	Socket tcpConn;
+	String lastError = new String();
 
-	public static CWPoint getSunAzimut2 (String utc, String datum, double lat, double lon) {
-		double jd = utc2juliandate(utc, datum);
-		CWPoint eclCoos = getSunEclipticCoos(jd);
-		// calculate ecliptic coos
-		// convert coos
-		return ecliptic2AzimutCoos(new CWPoint(lat, lon), jd, eclCoos);
-	}
-	
-	public static CWPoint getMoonAzimut(double jd, CWPoint onEarth) {
-		CWPoint eclCoo = getMoonEclipticCoos(jd);
-		return ecliptic2AzimutCoos(onEarth, jd, eclCoo);
-	}
-	
-	public static CWPoint getOrionAzimut(double jd, CWPoint onEarth) {
-		// Koordinaten Alnilam (mittlerer G?rtelstern des Orion), Rektaszension 5h36m13s; Deklination -1?12'7 TODO ?quinoktium 2000
-		// Source: wikipedia
-		return equatorial2AzimutCoos(onEarth, jd, new CWPoint(-1. -12./60. -7./3600., (5. + 36./60. + 13./3600.)*15.) ); // (-1. -12./60. -7./3600., (5. + 36./60. + 13./3600.)*15.) <- wikipedia // -1.19748, 5.60978 * 15.) <- www.... // (-1. -11./60. -52./3600., (5. + 36./60. + 35./3600.)*15.)  <- Stellarium
-	}
-	
-	/**
-	 * get the ecliptic coordinates of the sun
-	 * @param juliandate
-	 * @return
-	 */
-	public static CWPoint getSunEclipticCoos(double juliandate) {
-		double n = juliandate - 2451545.0;
-		double l = 280.46 + 0.9856474 * n;
-		double g = 357.528 + 0.9856003 * n;
-		double lambda = l + 1.915*java.lang.Math.sin(g/180*java.lang.Math.PI) + 0.02 * java.lang.Math.sin(2*g/180*java.lang.Math.PI);
-		return new CWPoint(0, lambda);
-	}
-	
-	
-	// the following code is adopted from http://lexikon.astronomie.info/java/sunmoon/sunmoon.html
-	// ignores the time difference between juliandate and TDT, which is something like 1 minute
-	public static CWPoint getMoonEclipticCoos(double julianDate) {
-		final double DEG = Math.PI / 180;  
-		final double RAD = 1/DEG;
-		double sunAnomalyMean = 360*DEG/365.242191*(julianDate - 2447891.5) + 279.403303*DEG - 282.768422*DEG;
-		double D = julianDate-2447891.5;
-
-		// Mean Moon orbit elements as of 1990.0
-		double l0 = 318.351648*DEG;
-		double P0 =  36.340410*DEG;
-		double N0 = 318.510107*DEG;
-		double i  = 5.145396*DEG;
-
-		double l = 13.1763966*DEG*D+l0;
-		double MMoon = l-0.1114041*DEG*D-P0; // Moon's mean anomaly M
-		double N = N0-0.0529539*DEG*D;       // Moon's mean ascending node longitude
-		
-		double sunlon = getSunEclipticCoos(julianDate).lonDec; 
-		double C = l-sunlon;
-		double Ev = 1.2739*DEG*Math.sin(2*C-MMoon);
-		double Ae = 0.1858*DEG*Math.sin(sunAnomalyMean);
-		double A3 = 0.37*DEG*Math.sin(sunAnomalyMean);
-
-		double MMoon2 = MMoon+Ev-Ae-A3;  // corrected Moon anomaly
-		double Ec = 6.2886*DEG*Math.sin(MMoon2);  // equation of centre
-		double A4 = 0.214*DEG*Math.sin(2*MMoon2);
-		double l2 = l+Ev+Ec-Ae+A4; // corrected Moon's longitude
-		double V = 0.6583*DEG*Math.sin(2*(l2-sunlon));
-
-		double l3 = l2+V; // true orbital longitude;
-		double N2 = N-0.16*DEG*Math.sin(sunAnomalyMean);
-
-		CWPoint moonCoor = new CWPoint();  
-		moonCoor.lonDec = (( N2 + Math.atan2( Math.sin(l3-N2)*Math.cos(i), Math.cos(l3-N2) ) ) * RAD)% 360;
-		moonCoor.latDec = Math.asin( Math.sin(l3-N2)*Math.sin(i) ) * RAD;
-		//moonCoor.orbitLon = l3;
-		return moonCoor;
-		
-		/*
-		double e  = 0.054900;
-		double a  = 384401; // km
-		double diameter0 = 0.5181*DEG; // angular diameter of Moon at a distance
-		double parallax0 = 0.9507*DEG; // parallax at distance a
-
-		  // relative distance to semi mayor axis of lunar oribt
-		  moonCoor.distance = (1-sqr(e)) / (1+e*Math.cos(MMoon2+Ec) );
-		  moonCoor.diameter = diameter0/moonCoor.distance; // angular diameter in radians
-		  moonCoor.parallax = parallax0/moonCoor.distance; // horizontal parallax in radians
-		  moonCoor.distance *= a;	// distance in km
-
-		  // Age of Moon in radians since New Moon (0) - Full Moon (pi)
-		  moonCoor.moonAge = Mod2Pi(l3-sunCoor.lon);   
-		  moonCoor.phase   = 0.5*(1-Math.cos(moonCoor.moonAge)); // Moon phase, 0-1
-
-		  var phases = new Array("Neumond", "Zunehmende Sichel", "Erstes Viertel", "Zunnehmender Mond", 
-		  	"Vollmond", "Abnehmender Mond", "Letztes Viertel", "Abnehmende Sichel", "Neumond");
-		  var mainPhase = 1./29.53*360*DEG; // show 'Newmoon, 'Quarter' for +/-1 day arond the actual event
-		  var p = Mod(moonCoor.moonAge, 90.*DEG);
-		  if (p < mainPhase || p > 90*DEG-mainPhase) p = 2*Math.round(moonCoor.moonAge / (90.*DEG));
-		  else p = 2*Math.floor(moonCoor.moonAge / (90.*DEG))+1;
-		  moonCoor.moonPhase = phases[p];
-
-		  moonCoor.sign = Sign(moonCoor.lon);
-		  return (float) moonCoor.lonDec;
-		return 0;
-	}
-		 */
-	}
-
-		public static CWPoint ecliptic2AzimutCoos(CWPoint onEarth, double julianDate, CWPoint ecliptic) {
-			CWPoint equat = ecliptic2Equatorial(ecliptic, julianDate);
-			return equatorial2AzimutCoos(onEarth, julianDate, equat);
-		}
-		/**
-		 * convert rektaszension alpha and deklination delta to azimut
-		 * @param onEarth pos. on earth for which the azimut is wanted
-		 * @param julianDate
-		 * @param equatorial: lonDec = rektaszension (alpha), latDec = Deklination (delta)
-		 * @return lonDec: azimut in degrees from north, lat: elevation in degrees from horizont
-		 * alogithism from wikipedia sonnenbahn
-		 */
-		public static CWPoint equatorial2AzimutCoos(CWPoint onEarth, double julianDate, CWPoint equatorial) {
-			double stunde = ((julianDate + 0.5) % 1) * 24;
-			double jd0 = julianDate - stunde /24; // julian date at UTC 0:00
-			double t0 = (jd0 - 2451545.)/36525.; // schon in t0 bzw jd0 richtig berechnet?
-			double thetaHG = 6.697376 + 2400.05134 * t0 + 1.002738 * stunde; // + (double)minute/60.);
-			double theta = thetaHG * 15. + onEarth.lonDec;
-			double tau = (theta - equatorial.lonDec ) /180*Math.PI;
-			double phi = onEarth.latDec/180*Math.PI;
-			double azimutNenner = Math.cos(tau)*Math.sin(phi)-
-				Math.tan(equatorial.latDec/180*Math.PI)*Math.cos(onEarth.latDec/180*java.lang.Math.PI);
-			float azimut = (float) java.lang.Math.atan(java.lang.Math.sin((theta-equatorial.lonDec)/180*Math.PI)/
-					azimutNenner);
-			azimut = (float) (azimut * 180f / java.lang.Math.PI);
-			if (azimutNenner<0) azimut +=180.;
-			// null = Sueden auf Null = Norden umrechnen
-			azimut +=180.;
-			if (azimut >360.) azimut -=360.;
-			double h = 180 / Math.PI * Math.asin(Math.cos(equatorial.latDec/180*Math.PI) * Math.cos(tau)*Math.cos(phi) + Math.sin(equatorial.latDec/180 *Math.PI) * Math.sin(phi));
-			return new CWPoint(h, azimut);
-		}
-
-		/**
-		 * convert from eliptical to equatorial coordinates
-		 * @param juliandate
-		 * @param eklipCoo ecliptic coos in degrees  
-		 * @return lon: Deklination (delta), lat: Rektaszension (alpha) in degree
-		 * this is adopted from http://lexikon.astronomie.info/java/sunmoon/sunmoon.html 
-		 */
-		public static CWPoint ecliptic2Equatorial(CWPoint eklipCoo, double juliandate) {
-			double T = (juliandate - 2451545.0)/36525.; // Epoch 2000 January 1.5
-			double eps = (23.+(26+21.45/60)/60 + T*(-46.815 +T*(-0.0006 + T*0.00181) )/3600 ) / 180 * java.lang.Math.PI; // schiefe der Ekliptik
-			double coseps = Math.cos(eps);
-			double sineps = Math.sin(eps);
-
-			double sinlon = Math.sin(eklipCoo.lonDec / 180 * Math.PI);
-			CWPoint equatorial = new CWPoint();
-			equatorial.lonDec = (180 / Math.PI * Math.atan2( (sinlon*coseps-Math.tan(eklipCoo.latDec /180 * Math.PI)*sineps), Math.cos(eklipCoo.lonDec/180 * Math.PI) ) ) % 360; // rektaszension (alpha)
-			equatorial.latDec = 180 / Math.PI * Math.asin( Math.sin(eklipCoo.latDec/180 * Math.PI)*coseps + Math.cos(eklipCoo.latDec/180 * Math.PI)*sineps*sinlon ); // deklination (delta)
-
-			return equatorial;
-		}
-		
-		/**
-		 * @param utc in the format as it comes from gps DDMMYY
-		 * @param datum in the format as it comes from gps HHMMSS
-		 * @return juliandate
-		 * @throws NumberFormatException if utc / datum could not be parsed successfully
-		 */
-		public static double utc2juliandate(String utc, String datum) {
+	public SerialThread(SerialPortOptions spo, CWGPSPoint GPSPoint, String forwardIP) throws IOException {
+		try{
+			comSp = new SerialPort(spo);
+		} catch (IOException e) {
+			throw new IOException(spo.portName);
+		} // catch (UnsatisfiedLinkError e) {} // TODO in original java-vm 
+		if (forwardIP.length()>0) { 
 			try {
-				int tag, monat, jahr, stunde, minute, sekunde;
-				tag     = Convert.parseInt(datum.substring(0, 2));
-				monat   = Convert.parseInt(datum.substring(2, 4));
-				jahr    = Convert.parseInt(datum.substring(4, 6)) + 2000;
-				stunde  = Convert.parseInt(utc.substring(0, 2));
-				minute  = Convert.parseInt(utc.substring(2, 4));
-				sekunde = Convert.parseInt(utc.substring(4, 6)); // Kommastellen werden abgeschnitten
-				// julianisches "Datum" jd berechnen (see http://de.wikipedia.org/wiki/Julianisches_Datum )
-				if (monat<2) {jahr--; monat+=12;} // verlegung des Jahres Endes auf Feb macht Berechnung von SChaltjahren einfacher
-				double a = (int)java.lang.Math.floor((double)jahr/100.); // Alle hundert Jahre kein Schlatjahr (abrunden)
-				double b = 2 - a + java.lang.Math.floor((double)a/4.);
-				double jd = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) + (double)tag + (double)stunde/24 + (double)minute/1440 + (double)sekunde/86400 + b - 1524.5;
-				return jd;
-				//double jd0 = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) +(double)tag + b - 1524.5;
-			} catch (IndexOutOfBoundsException e) {
-				// wird von substring geworfen wenn datum / utc nicht genug Ziffern haben
-				// NumberFormatException wird au?erdem von Convert.ParseInt direkt geworfen wenn
-				// nicht in Int konvertiert werden kann
-				throw new NumberFormatException();
+				tcpConn = new Socket(forwardIP, 23);
+				tcpForward = true;
+			} catch (ewe.net.UnknownHostException e) { tcpForward = false; lastError = e.getMessage();
+			} catch (IOException e) { tcpForward = false; lastError = e.getMessage(); 
 			}
 		}
+		myGPS = GPSPoint;
 	}
 
-	/**
-	 * Thread for reading data from COM-port
-	 *
-	 */
-	class SerialThread extends mThread{
-		SerialPort comSp;   
-		byte[] comBuff = new byte[1024*10]; // when some action takes a long time (eg. loading or zooming a map), a lot of data can be in the buffer, read that at once
-		int comLength = 0;
-		CWGPSPoint myGPS;
-		boolean run, tcpForward;
-		Socket tcpConn;
-		String lastError = new String();
-
-		public SerialThread(SerialPortOptions spo, CWGPSPoint GPSPoint, String forwardIP) throws IOException {
-			try{
-				comSp = new SerialPort(spo);
-			} catch (IOException e) {
-				throw new IOException(spo.portName);
-			} // catch (UnsatisfiedLinkError e) {} // TODO in original java-vm 
-			if (forwardIP.length()>0) { 
-				try {
-					tcpConn = new Socket(forwardIP, 23);
-					tcpForward = true;
-				} catch (ewe.net.UnknownHostException e) { tcpForward = false; lastError = e.getMessage();
-				} catch (IOException e) { tcpForward = false; lastError = e.getMessage(); 
+	public void run() {
+		int noData = 0;
+		int notinterpreted = 0;
+		run = true;
+		while (run){
+			try {
+				sleep(1000);
+				//Vm.debug("Loop? " + noData);
+				noData++;
+				if (noData > 5) { myGPS.noDataError(); }
+			} catch (InterruptedException e) {}
+			if (comSp != null)	{
+				comLength = comSp.nonBlockingRead(comBuff, 0 ,comBuff.length);
+				//Vm.debug("Length: " + comBuff.length);
+				if (comLength > 0)	{
+					noData = 0;
+					String str = mString.fromAscii(comBuff, 0, comLength); 
+					if (tcpForward) {
+						try {
+							tcpConn.write(comBuff, 0, comLength);
+						} catch (IOException e) { tcpForward = false; }
+					}
+					//Vm.debug(str);
+					if (myGPS.examine(str)) notinterpreted = 0; else notinterpreted++;
+					if (notinterpreted > 22) myGPS.noInterpretableData();
 				}
 			}
-			myGPS = GPSPoint;
-		}
+		} // while
+		myGPS.noData();
+		tcpConn.close();
+	}
 
-		public void run() {
-			int noData = 0;
-			int notinterpreted = 0;
-			run = true;
-			while (run){
-				try {
-					sleep(1000);
-					//Vm.debug("Loop? " + noData);
-					noData++;
-					if (noData > 5) { myGPS.noDataError(); }
-				} catch (InterruptedException e) {}
-				if (comSp != null)	{
-					comLength = comSp.nonBlockingRead(comBuff, 0 ,comBuff.length);
-					//Vm.debug("Length: " + comBuff.length);
-					if (comLength > 0)	{
-						noData = 0;
-						String str = mString.fromAscii(comBuff, 0, comLength); 
-						if (tcpForward) {
-							try {
-								tcpConn.write(comBuff, 0, comLength);
-							} catch (IOException e) { tcpForward = false; }
-						}
-						//Vm.debug(str);
-						if (myGPS.examine(str)) notinterpreted = 0; else notinterpreted++;
-						if (notinterpreted > 22) myGPS.noInterpretableData();
-					}
-				}
-			} // while
-			myGPS.noData();
-			tcpConn.close();
-		}
-
-		public void stop() {
-			run = false;
-			if (comSp != null) comSp.close();
-		}
+	public void stop() {
+		run = false;
+		if (comSp != null) comSp.close();
 	}
+}
 
-	/** 
-	 * Class for creating a new mThread to create timer ticks to be able to do form.close in the ticked-thread. 
-	 * Using the Vm.requestTimer-Method causes "ewe.sys.EventDirectionException: This task cannot be done within 
-	 * a Timer Tick." in the ewe-vm when form.close is called.  
-	 */
+/** 
+ * Class for creating a new mThread to create timer ticks to be able to do form.close in the ticked-thread. 
+ * Using the Vm.requestTimer-Method causes "ewe.sys.EventDirectionException: This task cannot be done within 
+ * a Timer Tick." in the ewe-vm when form.close is called.  
+ */
 
-	class UpdateThread extends mThread {
-		public boolean run;
-		public int calldelay;
-		public Navigate ticked;
+class UpdateThread extends mThread {
+	public boolean run;
+	public int calldelay;
+	public Navigate ticked;
 
-		public UpdateThread (Navigate gp, int cd) {
-			ticked = gp;
-			calldelay = cd;
-		}
+	public UpdateThread (Navigate gp, int cd) {
+		ticked = gp;
+		calldelay = cd;
+	}
 
-		public void run () {
-			run = true;
-			while (run) {
-				try { sleep (calldelay);} catch (InterruptedException e) {}
-				ticked.ticked();
-			}
+	public void run () {
+		run = true;
+		while (run) {
+			try { sleep (calldelay);} catch (InterruptedException e) {}
+			ticked.ticked();
 		}
+	}
 
-		public void stop() {
-			run = false;
-		}
+	public void stop() {
+		run = false;
 	}
+}
 

Added: trunk/src/CacheWolf/SkyOrientation.java
===================================================================
--- trunk/src/CacheWolf/SkyOrientation.java	2007-08-30 21:01:15 UTC (rev 855)
+++ trunk/src/CacheWolf/SkyOrientation.java	2007-08-30 21:18:25 UTC (rev 856)
@@ -0,0 +1,321 @@
+package CacheWolf;
+
+import ewe.sys.Convert;
+
+public class SkyOrientation {
+
+	public final static int SUN = 0;
+	public final static int MOON = 1;
+	public static final int ALIOTH = 2; // brightest star in Grater Bear (Grosser Wagen) Rektaszension 12 h 54 m 2 s Deklination +55 Grad 57' 36"
+	public static final int GREATER_BEAR = ALIOTH;
+	public static final int ALNILAM = 3; //Orion = Alnilam = mittlerer Guertelstern Aequinoktium 2000): Rektaszension 5h36m13s; Deklination -1 Grad 12'7"
+	public static final int ORION = ALNILAM; 
+	public static final int CASSIOPEIA_GAMMA = 4; // Kassiopeia Gamma: 00h 56m 42.50s	+60 Grad 43' 00.3"
+	public static final int CASSIOPEIA = CASSIOPEIA_GAMMA;
+	public static final int DENEB = 5;
+	public static final int CYGNUS = DENEB; // Cygnus = Schwan
+	
+	public static final CWPoint[] STARS = {
+		// (Deklination, Rektaszension)
+		/*ALIOTH*/		new CWPoint(55. +57./60. + 36./3600., (12. + 54./60. + 2./3600.)*15.), // ALIOTH: Rektaszension 12 h 54 m 2 s Deklination +55 Grad 57' 36"
+		/*ALNILAM*/		new CWPoint(-1. -12./60. -7./3600., (5.+36./60. + 13./3600.)*15.), // (-1. -12./60. -7./3600., (5. + 36./60. + 13./3600.)*15.) <- wikipedia // -1.19748, 5.60978 * 15.) <- www.... // (-1. -11./60. -52./3600., (5. + 36./60. + 35./3600.)*15.)  <- Stellarium 
+		/*Cassiopeia*/	new CWPoint(60. + 43./60. + 0.3/3600., (0 + 56./60. +42.5/3600.)*15.), // CASSIOPALA_GAMMA 00h 56m 42.50s, 60 Grad 43' 00.3" <-- wikipedia, Stellarium: 57m 11s, 60 Grad 45' 29"
+		/*Deneb*/		new CWPoint(45. + 16./60. + 49.2/3600., (20 + 41./60. +25.6/3600.)*15.) // im Schwan (Sommerdreieck) Quelle: Stellarium
+		// Krez des S?dens
+		// Sirius
+	};
+	
+	public static String [] LUMINARY_NAMES = { // TODO MyLocale.getMsg(xxx, "Sun"),
+		MyLocale.getMsg(6100, "Sun"), 
+		MyLocale.getMsg(6101, "Moon"), 
+		MyLocale.getMsg(6102, "Grater Bear"),
+		MyLocale.getMsg(6103, "Orion"),
+		MyLocale.getMsg(6104, "Cassiopeia"), 
+		MyLocale.getMsg(6105, "Cygnus")
+	};
+
+	public static String [] LUMINARY_DESC = { // TODO MyLocale.getMsg(xxx, "Sun"),
+		MyLocale.getMsg(6100, "Sun"), 
+		MyLocale.getMsg(6101, "Moon"), 
+		MyLocale.getMsg(6122, "Alioth in Greater Bear"),
+		MyLocale.getMsg(6123, "Alnilam in Orion"),
+		MyLocale.getMsg(6124, "Cassiopeia Gamma"), 
+		MyLocale.getMsg(6125, "Deneb in Cygnus")
+	};
+
+	public static String getLuminaryName(int luminary) {
+		return LUMINARY_NAMES[luminary]; 
+	}
+	
+	public static String getLuminaryDesc(int lu) {
+		return LUMINARY_DESC[lu];
+	}
+
+	/**
+	 * get azimuth from north and elevation for horizont for a given 
+	 * Luminary (planet or star) 
+	 * @param luminary one of SUN, MOON, ALIOTH, GRAETER_BEAR, ALNILAM, ORION, CASSIOPEIA_GAMMA, CASSIOPEIA
+	 * @param jd julian date must be calculated in advance e.g. from utc2julian
+	 * @param onEarth place on earth of the observer
+	 * @return lon = azimuth from north, lat = elevation from horizont
+	 */
+	public static CWPoint getLuminaryDir(int luminary, double jd, CWPoint onEarth) {
+		switch (luminary) {
+		case SUN: return getSunDir(jd, onEarth);
+		case MOON: return getMoonDir(jd, onEarth);
+		default: 
+			return equatorial2AzimutCoos(onEarth, jd, STARS[luminary-MOON-1]);
+		}
+	}
+
+	/**
+	 * @param utc in the format as it comes from gps DDMMYY
+	 * @param datum in the format as it comes from gps HHMMSS
+	 * @return juliandate
+	 * @throws NumberFormatException if utc / datum could not be parsed successfully
+	 */
+	public static double utc2juliandate(String utc, String datum) {
+		try {
+			int tag, monat, jahr, stunde, minute, sekunde;
+			tag     = Convert.parseInt(datum.substring(0, 2));
+			monat   = Convert.parseInt(datum.substring(2, 4));
+			jahr    = Convert.parseInt(datum.substring(4, 6)) + 2000;
+			stunde  = Convert.parseInt(utc.substring(0, 2));
+			minute  = Convert.parseInt(utc.substring(2, 4));
+			sekunde = Convert.parseInt(utc.substring(4, 6)); // Kommastellen werden abgeschnitten
+			// julianisches "Datum" jd berechnen (see http://de.wikipedia.org/wiki/Julianisches_Datum )
+			if (monat<2) {jahr--; monat+=12;} // verlegung des Jahres Endes auf Feb macht Berechnung von SChaltjahren einfacher
+			double a = (int)java.lang.Math.floor((double)jahr/100.); // Alle hundert Jahre kein Schlatjahr (abrunden)
+			double b = 2 - a + java.lang.Math.floor((double)a/4.);
+			double jd = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) + (double)tag + (double)stunde/24 + (double)minute/1440 + (double)sekunde/86400 + b - 1524.5;
+			return jd;
+			//double jd0 = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) +(double)tag + b - 1524.5;
+		} catch (IndexOutOfBoundsException e) {
+			// wird von substring geworfen wenn datum / utc nicht genug Ziffern haben
+			// NumberFormatException wird au?erdem von Convert.ParseInt direkt geworfen wenn
+			// nicht in Int konvertiert werden kann
+			throw new NumberFormatException();
+		}
+	}
+
+	public static float getSunAzimut (String utc, String datum, double lat, double lon) {
+		//	(new MessageBox("test", "utc:"+utc+" datum: "+datum+", lat: "+lat+", len: "+lon, MessageBox.OKB)).exec();
+		try {
+			int tag, monat, jahr, stunde, minute, sekunde;
+			tag = Convert.parseInt(datum.substring(0, 2));
+			monat = Convert.parseInt(datum.substring(2, 4));
+			jahr = Convert.parseInt(datum.substring(4, 6)) + 2000;
+			stunde=Convert.parseInt(utc.substring(0, 2));
+			minute=Convert.parseInt(utc.substring(2, 4));
+			sekunde=Convert.parseInt(utc.substring(4, 6)); // Kommastellen werden abgeschnitten
+			// julianisches "Datum" jd berechnen (see http://de.wikipedia.org/wiki/Julianisches_Datum )
+			if (monat<2) {jahr--; monat+=12;} // verlegung des Jahres Endes auf Feb macht Berechnung von SChaltjahren einfacher
+			double a = (int)java.lang.Math.floor((double)jahr/100.); // Alle hundert Jahre kein Schlatjahr (abrunden)
+			double b = 2 - a + java.lang.Math.floor((double)a/4.);
+			double jd = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) + (double)tag + (double)stunde/24 + (double)minute/1440 + (double)sekunde/86400 + b - 1524.5;
+			double jd0 = java.lang.Math.floor(365.25*(jahr + 4716.)) + java.lang.Math.floor(30.6001*((double)monat+1.)) +(double)tag + b - 1524.5;
+			// Ekliptikalkoordinaten der Sonne berechnen (see http://de.wikipedia.org/wiki/Sonnenstand )
+			double n = jd - 2451545.0;
+			double l = 280.46 + 0.9856474 * n;
+			double g = 357.528 + 0.9856003 * n;
+			double d = l + 1.915*java.lang.Math.sin(g/180*java.lang.Math.PI) + 0.02 * java.lang.Math.sin(2*g/180*java.lang.Math.PI);
+			// Rektaszension alpha und Deklination delta der Sonne berechnen
+			double e = 23.439 -0.0000004 * n;
+			double alphaNenner = java.lang.Math.cos(d/180*java.lang.Math.PI);
+			double alpha = 180/java.lang.Math.PI*java.lang.Math.atan(java.lang.Math.cos(e/180*java.lang.Math.PI)*java.lang.Math.sin(d/180*java.lang.Math.PI)/alphaNenner);
+			double delta = 180/java.lang.Math.PI*java.lang.Math.asin(java.lang.Math.sin(e/180*java.lang.Math.PI)*java.lang.Math.sin(d/180*java.lang.Math.PI) );
+			if (alphaNenner<0) {alpha +=180;}
+			// Azimut
+			double t0 = (jd0 - 2451545.)/36525.; // schon in t0 bzw jd0 richtig berechnet?
+			double thetaHG = 6.697376 + 2400.05134 * t0 + 1.002738 * ((double)stunde + (double)minute/60. + (double)sekunde/3600.);
+			double theta = thetaHG * 15. + lon;
+			double azimutNenner = java.lang.Math.cos((theta-alpha)/180*java.lang.Math.PI)*java.lang.Math.sin(lat/180*java.lang.Math.PI)-
+			java.lang.Math.tan(delta/180*java.lang.Math.PI)*java.lang.Math.cos(lat/180*java.lang.Math.PI);
+			float azimut = (float) java.lang.Math.atan(java.lang.Math.sin((theta-alpha)/180*java.lang.Math.PI)/
+					azimutNenner);
+			azimut = (float) (azimut * 180f / java.lang.Math.PI);
+			if (azimutNenner<0) azimut +=180.;
+			// null = Sueden auf Null = Norden umrechnen
+			azimut +=180.;
+			if (azimut >360.) azimut -=360.;
+			ewe.sys.Vm.debug("sunAzimut1: " + azimut);
+			ewe.sys.Vm.debug("sun Elevation: " +getSunAzimut2 (utc, datum, lat, lon).latDec);
+			CWPoint MoonDir = getMoonDir(jd, new CWPoint(lat, lon));
+			ewe.sys.Vm.debug("Moon Elevation: " + MoonDir.latDec + "Moon Azimut: " + MoonDir.lonDec);
+			CWPoint OrionDir = getAlnilamDir(jd, new CWPoint(lat, lon));
+			ewe.sys.Vm.debug("Alnilam (Orion) Elevation: " + OrionDir.latDec + "Alnilam (Orion) Azimut: " + OrionDir.lonDec );
+			
+			return azimut;
+		} catch (IndexOutOfBoundsException e) {
+			// wird von substring geworfen wenn datum / utc nicht genug Ziffern haben
+			// NumberFormatException wird ausserdem von Convert.ParseInt direkt geworfen wenn
+			// nicht in Int konvertiert werden kann
+			throw new NumberFormatException();
+		}
+	}
+
+	public static CWPoint getSunAzimut2 (String utc, String datum, double lat, double lon) {
+		double jd = utc2juliandate(utc, datum);
+		CWPoint eclCoos = getSunEclipticCoos(jd);
+		// calculate ecliptic coos
+		// convert coos
+		return ecliptic2AzimutCoos(new CWPoint(lat, lon), jd, eclCoos);
+	}
+
+	public static CWPoint getSunDir (double jd, CWPoint onEarth) {
+		CWPoint eclCoos = getSunEclipticCoos(jd);
+		// calculate ecliptic coos
+		// convert coos
+		return ecliptic2AzimutCoos(onEarth, jd, eclCoos);
+	}
+
+	public static CWPoint getMoonDir(double jd, CWPoint onEarth) {
+		CWPoint eclCoo = getMoonEclipticCoos(jd);
+		return ecliptic2AzimutCoos(onEarth, jd, eclCoo);
+	}
+
+	public static CWPoint getAlnilamDir(double jd, CWPoint onEarth) {
+		// Koordinaten Alnilam (mittlerer Guertelstern des Orion), Rektaszension 5h36m13s; Deklination -1?12'7 TODO Aequinoktium 2000
+		// Source: wikipedia
+		return equatorial2AzimutCoos(onEarth, jd, new CWPoint(-1. -12./60. -7./3600., (5. + 36./60. + 13./3600.)*15.) ); // (-1. -12./60. -7./3600., (5. + 36./60. + 13./3600.)*15.) <- wikipedia // -1.19748, 5.60978 * 15.) <- www.... // (-1. -11./60. -52./3600., (5. + 36./60. + 35./3600.)*15.)  <- Stellarium
+	}
+
+	/**
+	 * get the ecliptic coordinates of the sun
+	 * @param juliandate
+	 * @return
+	 */
+	public static CWPoint getSunEclipticCoos(double juliandate) {
+		double n = juliandate - 2451545.0;
+		double l = 280.46 + 0.9856474 * n;
+		double g = 357.528 + 0.9856003 * n;
+		double lambda = l + 1.915*java.lang.Math.sin(g/180*java.lang.Math.PI) + 0.02 * java.lang.Math.sin(2*g/180*java.lang.Math.PI);
+		return new CWPoint(0, lambda);
+	}
+
+
+	// the following code is adopted from http://lexikon.astronomie.info/java/sunmoon/sunmoon.html
+	// ignores the time difference between juliandate and TDT, which is something like 1 minute
+	public static CWPoint getMoonEclipticCoos(double julianDate) {
+		final double DEG = Math.PI / 180;  
+		final double RAD = 1/DEG;
+		double sunAnomalyMean = 360*DEG/365.242191*(julianDate - 2447891.5) + 279.403303*DEG - 282.768422*DEG;
+		double D = julianDate-2447891.5;
+
+		// Mean Moon orbit elements as of 1990.0
+		double l0 = 318.351648*DEG;
+		double P0 =  36.340410*DEG;
+		double N0 = 318.510107*DEG;
+		double i  = 5.145396*DEG;
+
+		double l = 13.1763966*DEG*D+l0;
+		double MMoon = l-0.1114041*DEG*D-P0; // Moon's mean anomaly M
+		double N = N0-0.0529539*DEG*D;       // Moon's mean ascending node longitude
+
+		double sunlon = getSunEclipticCoos(julianDate).lonDec; 
+		double C = l-sunlon;
+		double Ev = 1.2739*DEG*Math.sin(2*C-MMoon);
+		double Ae = 0.1858*DEG*Math.sin(sunAnomalyMean);
+		double A3 = 0.37*DEG*Math.sin(sunAnomalyMean);
+
+		double MMoon2 = MMoon+Ev-Ae-A3;  // corrected Moon anomaly
+		double Ec = 6.2886*DEG*Math.sin(MMoon2);  // equation of centre
+		double A4 = 0.214*DEG*Math.sin(2*MMoon2);
+		double l2 = l+Ev+Ec-Ae+A4; // corrected Moon's longitude
+		double V = 0.6583*DEG*Math.sin(2*(l2-sunlon));
+
+		double l3 = l2+V; // true orbital longitude;
+		double N2 = N-0.16*DEG*Math.sin(sunAnomalyMean);
+
+		CWPoint moonCoor = new CWPoint();  
+		moonCoor.lonDec = (( N2 + Math.atan2( Math.sin(l3-N2)*Math.cos(i), Math.cos(l3-N2) ) ) * RAD)% 360;
+		moonCoor.latDec = Math.asin( Math.sin(l3-N2)*Math.sin(i) ) * RAD;
+		//moonCoor.orbitLon = l3;
+		return moonCoor;
+
+		/*
+		double e  = 0.054900;
+		double a  = 384401; // km
+		double diameter0 = 0.5181*DEG; // angular diameter of Moon at a distance
+		double parallax0 = 0.9507*DEG; // parallax at distance a
+
+		  // relative distance to semi mayor axis of lunar oribt
+		  moonCoor.distance = (1-sqr(e)) / (1+e*Math.cos(MMoon2+Ec) );
+		  moonCoor.diameter = diameter0/moonCoor.distance; // angular diameter in radians
+		  moonCoor.parallax = parallax0/moonCoor.distance; // horizontal parallax in radians
+		  moonCoor.distance *= a;	// distance in km
+
+		  // Age of Moon in radians since New Moon (0) - Full Moon (pi)
+		  moonCoor.moonAge = Mod2Pi(l3-sunCoor.lon);   
+		  moonCoor.phase   = 0.5*(1-Math.cos(moonCoor.moonAge)); // Moon phase, 0-1
+
+		  var phases = new Array("Neumond", "Zunehmende Sichel", "Erstes Viertel", "Zunnehmender Mond", 
+		  	"Vollmond", "Abnehmender Mond", "Letztes Viertel", "Abnehmende Sichel", "Neumond");
+		  var mainPhase = 1./29.53*360*DEG; // show 'Newmoon, 'Quarter' for +/-1 day arond the actual event
+		  var p = Mod(moonCoor.moonAge, 90.*DEG);
+		  if (p < mainPhase || p > 90*DEG-mainPhase) p = 2*Math.round(moonCoor.moonAge / (90.*DEG));
+		  else p = 2*Math.floor(moonCoor.moonAge / (90.*DEG))+1;
+		  moonCoor.moonPhase = phases[p];
+
+		  moonCoor.sign = Sign(moonCoor.lon);
+		  return (float) moonCoor.lonDec;
+		return 0;
+	}
+		 */
+	}
+
+	public static CWPoint ecliptic2AzimutCoos(CWPoint onEarth, double julianDate, CWPoint ecliptic) {
+		CWPoint equat = ecliptic2Equatorial(ecliptic, julianDate);
+		return equatorial2AzimutCoos(onEarth, julianDate, equat);
+	}
+	/**
+	 * convert rektaszension alpha and deklination delta to azimuth / elevation
+	 * @param onEarth pos. on earth for which the azimut is wanted
+	 * @param julianDate
+	 * @param equatorial: lonDec = rektaszension (alpha), latDec = Deklination (delta)
+	 * @return lonDec: azimuth in degrees from north, lat: elevation in degrees from horizont
+	 * alogithism from wikipedia sonnenbahn
+	 */
+	public static CWPoint equatorial2AzimutCoos(CWPoint onEarth, double julianDate, CWPoint equatorial) {
+		double stunde = ((julianDate + 0.5) % 1) * 24;
+		double jd0 = julianDate - stunde /24; // julian date at UTC 0:00
+		double t0 = (jd0 - 2451545.)/36525.; // schon in t0 bzw jd0 richtig berechnet?
+		double thetaHG = 6.697376 + 2400.05134 * t0 + 1.002738 * stunde; // + (double)minute/60.);
+		double theta = thetaHG * 15. + onEarth.lonDec;
+		double tau = (theta - equatorial.lonDec ) /180*Math.PI;
+		double phi = onEarth.latDec/180*Math.PI;
+		double azimutNenner = Math.cos(tau)*Math.sin(phi)-
+		Math.tan(equatorial.latDec/180*Math.PI)*Math.cos(onEarth.latDec/180*java.lang.Math.PI);
+		float azimut = (float) java.lang.Math.atan(java.lang.Math.sin((theta-equatorial.lonDec)/180*Math.PI)/
+				azimutNenner);
+		azimut = (float) (azimut * 180f / java.lang.Math.PI);
+		if (azimutNenner<0) azimut +=180.;
+		double h = 180 / Math.PI * Math.asin(Math.cos(equatorial.latDec/180*Math.PI) * Math.cos(tau)*Math.cos(phi) + Math.sin(equatorial.latDec/180 *Math.PI) * Math.sin(phi));
+		// null = Sueden auf Null = Norden umrechnen
+		azimut +=180.;
+		if (azimut >360.) azimut -=360.;
+		return new CWPoint(h, azimut);
+	}
+
+	/**
+	 * convert from eliptical to equatorial coordinates
+	 * @param juliandate
+	 * @param eklipCoo ecliptic coos in degrees  
+	 * @return lon: Deklination (delta), lat: Rektaszension (alpha) in degree
+	 * this is adopted from http://lexikon.astronomie.info/java/sunmoon/sunmoon.html 
+	 */
+	public static CWPoint ecliptic2Equatorial(CWPoint eklipCoo, double juliandate) {
+		double T = (juliandate - 2451545.0)/36525.; // Epoch 2000 January 1.5
+		double eps = (23.+(26+21.45/60)/60 + T*(-46.815 +T*(-0.0006 + T*0.00181) )/3600 ) / 180 * java.lang.Math.PI; // schiefe der Ekliptik
+		double coseps = Math.cos(eps);
+		double sineps = Math.sin(eps);
+
+		double sinlon = Math.sin(eklipCoo.lonDec / 180 * Math.PI);
+		CWPoint equatorial = new CWPoint();
+		equatorial.lonDec = (180 / Math.PI * Math.atan2( (sinlon*coseps-Math.tan(eklipCoo.latDec /180 * Math.PI)*sineps), Math.cos(eklipCoo.lonDec/180 * Math.PI) ) ) % 360; // rektaszension (alpha)
+		equatorial.latDec = 180 / Math.PI * Math.asin( Math.sin(eklipCoo.latDec/180 * Math.PI)*coseps + Math.cos(eklipCoo.latDec/180 * Math.PI)*sineps*sinlon ); // deklination (delta)
+
+		return equatorial;
+	}
+}
+



From pfeffer at mail.berlios.de  Fri Aug 31 00:11:49 2007
From: pfeffer at mail.berlios.de (pfeffer at mail.berlios.de)
Date: Fri, 31 Aug 2007 00:11:49 +0200
Subject: [Cachewolf-svn] r857 - in trunk: resources src/CacheWolf
Message-ID: <200708302211.l7UMBnV3030861@sheep.berlios.de>

Author: pfeffer
Date: 2007-08-31 00:11:44 +0200 (Fri, 31 Aug 2007)
New Revision: 857

Modified:
   trunk/resources/cachewolf.Languages.cfg
   trunk/src/CacheWolf/SkyOrientation.java
Log:
Southern Cross added, forgotten langugues in last commit, more comments in code

Modified: trunk/resources/cachewolf.Languages.cfg
===================================================================
--- trunk/resources/cachewolf.Languages.cfg	2007-08-30 21:18:25 UTC (rev 856)
+++ trunk/resources/cachewolf.Languages.cfg	2007-08-30 22:11:44 UTC (rev 857)
@@ -531,6 +531,19 @@
 		6047=Ausgew%e4hlte Zeilen l%f6schen
 		6050=Spalten zeigen
 		6051=Spalten verbergen
+		6100=Sonne
+		6101=Mond
+		6102=Gro%dfer Wagen
+		6103=Orion
+		6104=Himmels-W
+		6105=Schwan
+		6106=Kreuz des S%fcdens
+		6122=Altioth im Gro%dfen Wagen
+		6123=Alnilam im Orion
+		6124=Kassiopeia Gamma
+		6125=Deneb im Schwan
+		6126=Mimosa im Kreuz des S%fcdens
+		
 		{..}
 		{en}
 		100=to HTML
@@ -1061,6 +1074,13 @@
 		6047=Delete selected Travelbugs
 		6050=Show column
 		6051=Don't show column
+		6100=Sun
+		6101=Moon
+		6102=Greater Bear
+		6103=Orion
+		6104=Cassiopeia
+		6105=Cygnus
+		6106=Mimosa in Southern Cross
 		{..}
 	{..}
 {..}

Modified: trunk/src/CacheWolf/SkyOrientation.java
===================================================================
--- trunk/src/CacheWolf/SkyOrientation.java	2007-08-30 21:18:25 UTC (rev 856)
+++ trunk/src/CacheWolf/SkyOrientation.java	2007-08-30 22:11:44 UTC (rev 857)
@@ -2,6 +2,15 @@
 
 import ewe.sys.Convert;
 
+/** Class to caculate positions of luminaries
+ * all methods are static
+ * usage:
+ * call utc2juliandate and then getLuminaryDir
+ * in ressources/cachewolf.languages messege numbers from 6100
+ * 
+ * @author Pfeffer
+ *
+ */
 public class SkyOrientation {
 
 	public final static int SUN = 0;
@@ -14,14 +23,16 @@
 	public static final int CASSIOPEIA = CASSIOPEIA_GAMMA;
 	public static final int DENEB = 5;
 	public static final int CYGNUS = DENEB; // Cygnus = Schwan
+	public static final int MIMOSA = 6; // second brightest star in Southern Cross
+	public static final int SOUTHERN_CROSS = MIMOSA; // SOUTHERN_CROSS = Kreus des S?dens = Crux australia
 	
 	public static final CWPoint[] STARS = {
 		// (Deklination, Rektaszension)
 		/*ALIOTH*/		new CWPoint(55. +57./60. + 36./3600., (12. + 54./60. + 2./3600.)*15.), // ALIOTH: Rektaszension 12 h 54 m 2 s Deklination +55 Grad 57' 36"
 		/*ALNILAM*/		new CWPoint(-1. -12./60. -7./3600., (5.+36./60. + 13./3600.)*15.), // (-1. -12./60. -7./3600., (5. + 36./60. + 13./3600.)*15.) <- wikipedia // -1.19748, 5.60978 * 15.) <- www.... // (-1. -11./60. -52./3600., (5. + 36./60. + 35./3600.)*15.)  <- Stellarium 
 		/*Cassiopeia*/	new CWPoint(60. + 43./60. + 0.3/3600., (0 + 56./60. +42.5/3600.)*15.), // CASSIOPALA_GAMMA 00h 56m 42.50s, 60 Grad 43' 00.3" <-- wikipedia, Stellarium: 57m 11s, 60 Grad 45' 29"
-		/*Deneb*/		new CWPoint(45. + 16./60. + 49.2/3600., (20 + 41./60. +25.6/3600.)*15.) // im Schwan (Sommerdreieck) Quelle: Stellarium
-		// Krez des S?dens
+		/*Deneb*/		new CWPoint(45. + 16./60. + 49.2/3600., (20 + 41./60. +25.6/3600.)*15.), // im Schwan (Sommerdreieck) Quelle: Stellarium
+		/*Mimosa*/		new CWPoint(-59. - 41./60. - 19./3600., (12 + 47./60. +43.2/3600.)*15.) // im Schwan (Sommerdreieck) Quelle: Stellarium
 		// Sirius
 	};
 	
@@ -31,7 +42,8 @@
 		MyLocale.getMsg(6102, "Grater Bear"),
 		MyLocale.getMsg(6103, "Orion"),
 		MyLocale.getMsg(6104, "Cassiopeia"), 
-		MyLocale.getMsg(6105, "Cygnus")
+		MyLocale.getMsg(6105, "Cygnus"),
+		MyLocale.getMsg(6106, "Southern Cross")
 	};
 
 	public static String [] LUMINARY_DESC = { // TODO MyLocale.getMsg(xxx, "Sun"),
@@ -40,13 +52,24 @@
 		MyLocale.getMsg(6122, "Alioth in Greater Bear"),
 		MyLocale.getMsg(6123, "Alnilam in Orion"),
 		MyLocale.getMsg(6124, "Cassiopeia Gamma"), 
-		MyLocale.getMsg(6125, "Deneb in Cygnus")
+		MyLocale.getMsg(6125, "Deneb in Cygnus"),
+		MyLocale.getMsg(6126, "Becrux in Southern Cross")
 	};
 
+	/**
+	 * Get the friendly name of the luminary
+	 * @param luminary
+	 * @return
+	 */
 	public static String getLuminaryName(int luminary) {
 		return LUMINARY_NAMES[luminary]; 
 	}
 	
+	/**
+	 * Get a more exact description of the luminary 
+	 * @param lu
+	 * @return
+	 */
 	public static String getLuminaryDesc(int lu) {
 		return LUMINARY_DESC[lu];
 	}
@@ -98,6 +121,14 @@
 		}
 	}
 
+	/**
+	 * old version, gives the same as the new one
+	 * @param utc
+	 * @param datum
+	 * @param lat
+	 * @param lon
+	 * @return
+	 */
 	public static float getSunAzimut (String utc, String datum, double lat, double lon) {
 		//	(new MessageBox("test", "utc:"+utc+" datum: "+datum+", lat: "+lat+", len: "+lon, MessageBox.OKB)).exec();
 		try {



