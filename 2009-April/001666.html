<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r1748 - in trunk/src: CacheWolf CacheWolf/navi exp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2009-April/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r1748%20-%20in%20trunk/src%3A%20CacheWolf%20CacheWolf/navi%20exp&In-Reply-To=%3C200904171641.n3HGffQc014214%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001665.html">
   <LINK REL="Next"  HREF="001667.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r1748 - in trunk/src: CacheWolf CacheWolf/navi exp</H1>
    <B>engywuck at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r1748%20-%20in%20trunk/src%3A%20CacheWolf%20CacheWolf/navi%20exp&In-Reply-To=%3C200904171641.n3HGffQc014214%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r1748 - in trunk/src: CacheWolf CacheWolf/navi exp">engywuck at mail.berlios.de
       </A><BR>
    <I>Fri Apr 17 18:41:41 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001665.html">[Cachewolf-svn] r1747 - trunk/src/CacheWolf
</A></li>
        <LI>Next message: <A HREF="001667.html">[Cachewolf-svn] r1749 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1666">[ date ]</a>
              <a href="thread.html#1666">[ thread ]</a>
              <a href="subject.html#1666">[ subject ]</a>
              <a href="author.html#1666">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: engywuck
Date: 2009-04-17 18:41:09 +0200 (Fri, 17 Apr 2009)
New Revision: 1748

Modified:
   trunk/src/CacheWolf/Attributes.java
   trunk/src/CacheWolf/CacheDB.java
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/CacheHolderDetail.java
   trunk/src/CacheWolf/DataMover.java
   trunk/src/CacheWolf/DescriptionPanel.java
   trunk/src/CacheWolf/DetailsPanel.java
   trunk/src/CacheWolf/GPXImporter.java
   trunk/src/CacheWolf/LOCXMLImporter.java
   trunk/src/CacheWolf/MainTab.java
   trunk/src/CacheWolf/NewProfileWizard.java
   trunk/src/CacheWolf/NotesScreen.java
   trunk/src/CacheWolf/OCXMLImporter.java
   trunk/src/CacheWolf/Parser.java
   trunk/src/CacheWolf/Profile.java
   trunk/src/CacheWolf/SearchCache.java
   trunk/src/CacheWolf/ShowCacheInBrowser.java
   trunk/src/CacheWolf/SpiderGC.java
   trunk/src/CacheWolf/TravelbugJourneyScreen.java
   trunk/src/CacheWolf/myTableControl.java
   trunk/src/CacheWolf/myTableModel.java
   trunk/src/CacheWolf/navi/CWGPSPoint.java
   trunk/src/exp/ASCExporter.java
   trunk/src/exp/ExploristExporter.java
   trunk/src/exp/Exporter.java
   trunk/src/exp/GPXExporter.java
   trunk/src/exp/HTMLExporter.java
   trunk/src/exp/KMLExporter.java
   trunk/src/exp/LocExporter.java
   trunk/src/exp/MSARCSVExporter.java
   trunk/src/exp/OVLExporter.java
   trunk/src/exp/OziExporter.java
   trunk/src/exp/PCX5Exporter.java
   trunk/src/exp/TPLExporter.java
Log:
Introducing new data model for CacheHolder/CacheHolderDetails. For most important changes see <A HREF="http://www.geoclub.de/viewtopic.php?f=40&amp;t=33289.">http://www.geoclub.de/viewtopic.php?f=40&amp;t=33289.</A>

Modified: trunk/src/CacheWolf/Attributes.java
===================================================================
--- trunk/src/CacheWolf/Attributes.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/Attributes.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -16,7 +16,7 @@
 	public long attributesYes;
 	public long attributesNo;
 
-	public Attributes(){ 
+	public Attributes(){ // Just a public constructor
 	}
 	
 	/**
@@ -40,7 +40,8 @@
     // Attribute set functions
     ////////////////////////////////////////////////
 	
-	public void XmlAttributesStart() {}
+	public void XmlAttributesStart() { // Any reason for this?		
+	}  
 	public void XmlAttributesEnd(String elem){
 		clear();
 		Extractor ex=new Extractor(elem,&quot;&lt;ATT&gt;&quot;,&quot;&lt;/ATT&gt;&quot;,0,true);
@@ -51,7 +52,8 @@
 		}
 	}
 
-	public void XmlAttributeStart(){}
+	public void XmlAttributeStart(){  // Any reason for this?
+	}
 	public void XmlAttributeEnd(String elem){
 		add(elem);
 	}

Modified: trunk/src/CacheWolf/CacheDB.java
===================================================================
--- trunk/src/CacheWolf/CacheDB.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/CacheDB.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -126,11 +126,13 @@
     }
 
 	/** Removes a CacheHolder object at the specified position in the cache list. The following
-	 * elements are renumbered.
+	 * elements are renumbered.&lt;br&gt;
+	 * Additionally the cache details are unloaded and saved to file, if necessary.
 	 * @param index The index of element to remove
 	 */
 	public void removeElementAt(int index) {
 		CacheHolder ch = this.get(index);
+		ch.releaseCacheDetails();
 	    vectorDB.removeElementAt(index);
 	    hashDB.remove(ch.getWayPoint());
 	    // When one element has been removed, we have to update the index

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/CacheHolder.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -1,13 +1,23 @@
 package CacheWolf;
 
+import utils.FileBugfix;
 import CacheWolf.navi.Metrics;
 
 import com.stevesoft.ewe_pat.Regex;
 
+import ewe.filechooser.FileChooser;
+import ewe.filechooser.FileChooserBase;
+import ewe.io.BufferedWriter;
+import ewe.io.File;
+import ewe.io.FileNotFoundException;
+import ewe.io.FileReader;
+import ewe.io.FileWriter;
 import ewe.io.IOException;
+import ewe.io.PrintWriter;
 import ewe.sys.Convert;
 import ewe.sys.Vm;
 import ewe.ui.FormBase;
+import ewe.ui.InputBox;
 import ewe.ui.MessageBox;
 import ewe.util.Vector;
 
@@ -114,129 +124,162 @@
 	private long attributesYes = 0;
 	private long attributesNo  = 0;
 
-	
-//	static int nObjects=0;
-	public CacheHolder() {//nObjects++;Vm.debug(&quot;CacheHolder() nO=&quot;+nObjects);
-	}
-
-	public CacheHolder(CacheHolder ch) {//nObjects++;Vm.debug(&quot;CacheHolder(ch) nO=&quot;+nObjects);
-		update(ch);
-	}
-
-	static char decSep,notDecSep;
+		static char decSep,notDecSep;
 	static {
 		decSep=MyLocale.getDigSeparator().charAt(0);
 		notDecSep=decSep=='.'?',':'.';
 	}
 
+	public CacheHolder() {  // Just a public constructor
+	}
+	
 	public CacheHolder(String xmlString) {
 		int start,end;
-		try {
-			start=xmlString.indexOf('&quot;'); end=xmlString.indexOf('&quot;',start+1);
-			setCacheName(SafeXML.cleanback(xmlString.substring(start+1,end)));
-			
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-            setCacheOwner(SafeXML.cleanback(xmlString.substring(start+1,end)));
-			// Assume coordinates are in decimal format
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			double lat=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
+		if (xmlString.length() &lt;= 10) {
+			this.wayPoint = xmlString;
+		} else	
+	        try {
+		        start = xmlString.indexOf('&quot;');
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setCacheName(SafeXML.cleanback(xmlString.substring(start + 1, end)));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			double lon=Convert.parseDouble(xmlString.substring(start+1,end).replace(notDecSep,decSep));
-			pos=new CWPoint(lat,lon);
-			LatLon=pos.toString();
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setCacheOwner(SafeXML.cleanback(xmlString.substring(start + 1, end)));
+		        // Assume coordinates are in decimal format
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        double lat = Convert.parseDouble(xmlString.substring(start + 1, end).replace(
+		                notDecSep, decSep));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setDateHidden(xmlString.substring(start+1,end)); 
-			// Convert the US format to YYYY-MM-DD if necessary
-			if (getDateHidden().indexOf('/')&gt;-1) setDateHidden(DateFormat.MDY2YMD(getDateHidden()));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        double lon = Convert.parseDouble(xmlString.substring(start + 1, end).replace(
+		                notDecSep, decSep));
+		        pos = new CWPoint(lat, lon);
+		        LatLon = pos.toString();
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setWayPoint(SafeXML.cleanback(xmlString.substring(start+1,end)));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setDateHidden(xmlString.substring(start + 1, end));
+		        // Convert the US format to YYYY-MM-DD if necessary
+		        if (getDateHidden().indexOf('/') &gt; -1)
+			        setDateHidden(DateFormat.MDY2YMD(getDateHidden()));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setCacheStatus(xmlString.substring(start+1,end));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setWayPoint(SafeXML.cleanback(xmlString.substring(start + 1, end)));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setType(new Integer(xmlString.substring(start+1,end)).intValue());
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setCacheStatus(xmlString.substring(start + 1, end));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setHard(xmlString.substring(start+1,end));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setType(new Integer(xmlString.substring(start + 1, end)).intValue());
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setTerrain(xmlString.substring(start+1,end));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setHard(xmlString.substring(start + 1, end));
 
-			// The next item was 'dirty' but this is no longer used.
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setFiltered(xmlString.substring(start+1,end).equals(&quot;true&quot;)); 
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setTerrain(xmlString.substring(start + 1, end));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setCacheSize(xmlString.substring(start+1,end));
+		        // The next item was 'dirty' but this is no longer used.
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setFiltered(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setAvailable(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setCacheSize(xmlString.substring(start + 1, end));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setArchived(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setAvailable(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setHas_bugs(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setArchived(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setBlack(xmlString.substring(start+1,end).equals(&quot;true&quot;));
-			if(is_black()!=Global.getProfile().showBlacklisted()) setFiltered(true);
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setHas_bugs(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setOwned(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setBlack(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
+		        if (is_black() != Global.getProfile().showBlacklisted())
+			        setFiltered(true);
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setFound(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setOwned(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setNew(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setFound(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setLog_updated(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setNew(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setUpdated(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setLog_updated(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			// for backwards compatibility set value to true, if it is not in the file
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setHTML(!xmlString.substring(start+1,end).equals(&quot;false&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setUpdated(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setNoFindLogs(Convert.toInt(xmlString.substring(start+1,end)));
+		        // for backwards compatibility set value to true, if it is not in the file
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setHTML(!xmlString.substring(start + 1, end).equals(&quot;false&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setOcCacheID(xmlString.substring(start+1,end));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setNoFindLogs(Convert.toInt(xmlString.substring(start + 1, end)));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setIncomplete(xmlString.substring(start+1,end).equals(&quot;true&quot;));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setOcCacheID(xmlString.substring(start + 1, end));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setLastSyncOC(xmlString.substring(start+1,end));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setIncomplete(xmlString.substring(start + 1, end).equals(&quot;true&quot;));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setNumRecommended(Convert.toInt(xmlString.substring(start+1,end)));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setLastSyncOC(xmlString.substring(start + 1, end));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			setNumFoundsSinceRecommendation(Convert.toInt(xmlString.substring(start+1,end)));
-			recommendationScore = LogList.getScore(getNumRecommended(), getNumFoundsSinceRecommendation());
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setNumRecommended(Convert.toInt(xmlString.substring(start + 1, end)));
 
-			start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-			if (start &gt; -1 &amp;&amp; end &gt; -1) {
-				setAttributesYes(Convert.parseLong(xmlString.substring(start+1,end)));
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        setNumFoundsSinceRecommendation(Convert.toInt(xmlString.substring(start + 1, end)));
+		        recommendationScore = LogList.getScore(getNumRecommended(),
+		                getNumFoundsSinceRecommendation());
 
-				start=xmlString.indexOf('&quot;',end+1); end=xmlString.indexOf('&quot;',start+1);
-				if (start &gt; -1 &amp;&amp; end &gt; -1)
-					setAttributesNo(Convert.parseLong(xmlString.substring(start+1,end)));
-			}
-		} catch (Exception ex) {
+		        start = xmlString.indexOf('&quot;', end + 1);
+		        end = xmlString.indexOf('&quot;', start + 1);
+		        if (start &gt; -1 &amp;&amp; end &gt; -1) {
+			        setAttributesYes(Convert.parseLong(xmlString.substring(start + 1, end)));
 
-		}
-	}
+			        start = xmlString.indexOf('&quot;', end + 1);
+			        end = xmlString.indexOf('&quot;', start + 1);
+			        if (start &gt; -1 &amp;&amp; end &gt; -1)
+				        setAttributesNo(Convert.parseLong(xmlString.substring(start + 1, end)));
+		        }
+	        } catch (Exception ex) {
 
+	        }
+        }
+	
+
 	/**
 	 * Returns the distance in formatted output. Using kilometers when metric system is active,
 	 * using miles when imperial system is active.
@@ -279,6 +322,15 @@
 	public void update(CacheHolder ch) {
 		update(ch, false);
 	}
+	/** 
+	 * Updates Cache information with information provided by cache given as argument. This is used
+	 * to update the cache with the information retrieved from files or web: The argument cache
+	 * is the one that is filled with the read information, &lt;code&gt;this&lt;/code&gt; is the cache that
+	 * is already in the database and subject to update. 
+	 * @param ch The cache who's information is updating the current one
+	 * @param overwrite If &lt;code&gt;true&lt;/code&gt;, then &lt;i&gt;status&lt;/i&gt;, &lt;i&gt;is_found&lt;/i&gt; and &lt;i&gt;position&lt;/i&gt;
+	 * is updated, otherwise not.
+	 */
 	public void update(CacheHolder ch, boolean overwrite) {
 		this.recommendationScore = ch.recommendationScore;
 		this.setNumFoundsSinceRecommendation(ch.getNumFoundsSinceRecommendation());
@@ -342,41 +394,41 @@
 
 		this.setAttributesYes(ch.getAttributesYes());
 		this.setAttributesNo(ch.getAttributesNo());
+		if (ch.detailsLoaded()) {
+			this.getFreshDetails().update(ch.getFreshDetails());
+		}	
 	}
 	/**
 	 * Call it only when necessary, it takes time, because all logs must be parsed
-	 *
 	 */
 	public void calcRecommendationScore() {
-		if (getWayPoint().toLowerCase().startsWith(&quot;oc&quot;) ) {
-			CacheHolderDetail chD;
-			if (this instanceof CacheHolderDetail)	chD = (CacheHolderDetail)this;
-			else chD = getCacheDetails(true, false);
-			if (chD != null) {
-				chD.CacheLogs.calcRecommendations();
-				recommendationScore = chD.CacheLogs.recommendationRating;
-				setNumFoundsSinceRecommendation(chD.CacheLogs.foundsSinceRecommendation);
-				setNumRecommended(chD.CacheLogs.numRecommended);
-			} else { // cache doesn't have details
-				recommendationScore = -1;
-				setNumFoundsSinceRecommendation(-1);
-				setNumRecommended(-1);
+		if (getWayPoint().toLowerCase().startsWith(&quot;oc&quot;)) {
+			// Calculate recommendation score only when details
+			// are already loaded. When they aren't loaded, then we assume
+			// that there is no change, so nothing to do.
+			if (this.detailsLoaded()) {
+				CacheHolderDetail chD = getCacheDetails(true, false);
+				if (chD != null) {
+					chD.CacheLogs.calcRecommendations();
+					recommendationScore = chD.CacheLogs.recommendationRating;
+					setNumFoundsSinceRecommendation(chD.CacheLogs.foundsSinceRecommendation);
+					setNumRecommended(chD.CacheLogs.numRecommended);
+				} else { // cache doesn't have details
+					recommendationScore = -1;
+					setNumFoundsSinceRecommendation(-1);
+					setNumRecommended(-1);
+				}
 			}
 		} else {
 			recommendationScore = -1;
 			setNumFoundsSinceRecommendation(-1);
 			setNumRecommended(-1);
 		}
-		if (details != null) {
-		details.recommendationScore = recommendationScore;
-		details.setNumFoundsSinceRecommendation(getNumFoundsSinceRecommendation());
-		details.setNumRecommended(getNumRecommended());
-		}
 	}
 	
 	/** Return a XML string containing all the cache data for storing in index.xml */
 	public String toXML() {
-		if (this instanceof CacheHolderDetail || (details != null &amp;&amp; details.hasUnsavedChanges)) calcRecommendationScore(); 
+		calcRecommendationScore(); 
 		sb.delete(0,sb.length());
 		sb.append(&quot;    &lt;CACHE &quot;);
 		sb.append(&quot; name = \&quot;&quot;);        sb.append(SafeXML.clean(getCacheName()));
@@ -440,7 +492,8 @@
 			bearing = NOBEARING;
 		}
 	}
-	public void setAttributesFromMainCache(CacheHolder mainCh){
+	public void setAttributesFromMainCache(){
+		CacheHolder mainCh = this.mainCache;
 		this.setCacheOwner(mainCh.getCacheOwner());
 		this.setCacheStatus(mainCh.getCacheStatus());
 		this.setArchived(mainCh.is_archived());
@@ -456,7 +509,7 @@
 			CacheHolder addiWpt;
 			for (int i= this.addiWpts.getCount() - 1;  i&gt;=0; i--){
 				addiWpt = (CacheHolder) this.addiWpts.get(i);
-				addiWpt.setAttributesFromMainCache(this);
+				addiWpt.setAttributesFromMainCache();
 			}
 		}
 	}
@@ -472,17 +525,17 @@
 		if ((!this.isAddiWpt()) &amp;&amp; (!ch.isAddiWpt())) return false;
 		CacheHolder main1, main2;
 		if (this.isAddiWpt()) main1 = this.mainCache;  else main1 = this;
-		if (ch instanceof CacheHolderDetail) {
-			if (ch.isAddiWpt()) 
-				main2=ch.mainCache;
-			else 
-				return main1.getWayPoint().equals(ch.getWayPoint());
-		} else { // ch instanceof CacheHolder 
-			if (ch.isAddiWpt()) main2 = ch.mainCache; else main2 = ch; 
-		}
+		if (ch.isAddiWpt()) main2 = ch.mainCache; else main2 = ch; 
 		return main1 == main2;
 	}
 
+	/** Find out of detail object of Cache is loaded. Returns &lt;code&gt;true&lt;/code&gt; if this is the case.
+	 * @return True when details object is present
+	 */
+	public boolean detailsLoaded() {
+		return details!=null;
+	}
+	
 	/** 
 	 * Call this method to get the long-description and so on.
 	 * If the according .xml-file is already read, it will return
@@ -495,93 +548,122 @@
 		return getCacheDetails(maybenew, true);
 	}
 	
-	/** 
-	 * Call this method to get the long-description and so on.
-	 * If the according .xml-file is already read, it will return
-	 * that one, otherwise it will be loaded.
-	 * To avoid memory problems this routine loads not for more caches than maxDetails
-	 * the details. If maxdetails is reached, it will remove from RAM the details 
-	 * of the 5 caches that were loaded most long ago.
+	/**
+	 * Gets the detail object of a cache. The detail object stores information which is not needed
+	 * for every cache instantaneously, but can be loaded if the user decides to look at this cache.
+	 * If the cache object is already existing, the method will return this object, otherwise it 
+	 * will create it and try to read it from the corresponding &lt;waypoint&gt;.xml file.
+	 * Depending on the parameters it is allowed that the &lt;waypoint&gt;.xml file does not yet exist,
+	 * or the user is warned that the file doesn't exist.
+	 * If more than &lt;code&gt;maxdetails&lt;/code&gt; details are loaded, then the 5 last recently loaded 
+	 * caches are unloaded (to save ram). 
 	 * 
-	 * @param alarmuser if true an error message will be displayed to the user, if the details could not be read
-	 * @return the respective CacheHolderDetail, null if according xml-file could not be read
+	 * @param maybenew
+	 * 			  If true and the cache file could not be read, then an empty detail object is 
+	 *            returned.
+	 * @param alarmuser
+	 *            If true an error message will be displayed to the user, if the details could not
+	 *            be read, and the method returns null 
+	 * @return The respective CacheHolderDetail, or null
 	 */
-		
+
 	public CacheHolderDetail getCacheDetails(boolean maybenew, boolean alarmuser) {
-		if (details != null) {
-			if (details.hasUnsavedChanges) this.update(details);
-			else details.update(this);
-			return details;
+		if (details == null) {
+
+			details = new CacheHolderDetail(this);
+			try {
+				details.readCache(Global.getProfile().dataDir);
+			} catch (IOException e) {
+				if (alarmuser &amp;&amp; !maybenew) {
+					(new MessageBox(&quot;Error&quot;, &quot;Could not read cache details for cache: &quot;
+					        + this.getWayPoint(), FormBase.OKB)).execute();
+				}
+				if (!maybenew) details = null;
+			}
+			if (details != null
+					  // for importing/spidering reasons helper objects with same waypoint are created
+					&amp;&amp; !cachesWithLoadedDetails.contains(this.getWayPoint())
+					  // helper objects may have empty waypoint
+					&amp;&amp; !this.getWayPoint().equals(CacheHolder.EMPTY)) {
+				cachesWithLoadedDetails.add(this.getWayPoint());
+				if (cachesWithLoadedDetails.size() &gt;= Global.getPref().maxDetails) removeOldestDetails();
+			}
 		}
-		// FIXME Problem: Hier wird ein neues Detail-Objekt erzeugt, welches nat&#252;rlich noch
-		//       Default-Werte in den Feldern stehen hat. 
-		//       Das Zur&#252;cksetzen von UnsavedChanges ist erstmal ein Hack.
-		boolean hasUnsavedChanges = Global.getProfile().hasUnsavedChanges();
-		details = new CacheHolderDetail(this);
-		try {
-			details.readCache(Global.getProfile().dataDir);
-		} catch (IOException e) {
-			if (maybenew) details.update(this);
-			else {
-				if (alarmuser) (new MessageBox(&quot;Error&quot;, &quot;Could not read cache details for cache: &quot;+this.getWayPoint(), FormBase.OKB)).execute();
-				return null;
-			} 
-		}
-		if (! hasUnsavedChanges) Global.getProfile().resetUnsavedChanges();
-		detailsAdded();
 		return details;
 	}
+	
+	/**
+	 * Gets a detail object for the cache. If the object is already created, then this object is
+	 * returned, otherwise it's created from the cache.xml file. If no such file is found, an empty
+	 * object is returned.
+	 * @return The object representing the cache details
+	 */
+	public CacheHolderDetail getFreshDetails() {
+		return this.getCacheDetails(true, false);
+	}
+	/**
+	 * Gets a detail object for the cache. If the object is already created, then this object is
+	 * returned, otherwise it's created from the cache.xml file. If no such file is found, an error
+	 * message is displayed and &lt;code&gt;null&lt;/code&gt; is returned.
+	 * @return The object representing the cache details, or &lt;code&gt;null&lt;/code&gt;.
+	 */
+	public CacheHolderDetail getExistingDetails() {
+		return this.getCacheDetails(false, true);
+	}
 
 	/**
-	 * Call this after you added the cache with details to the 
-	 * cacheDB &lt;br&gt; It is assumed that that details is set
-	 * for an example see OCXMLImporter.endCache()
-	 *
+	 * Saves the cache to the corresponding &lt;waypoint&gt;.xml file, located in the profiles
+	 * directory. The waypoint of the 
+	 * cache should be set to do so.
 	 */
-	public void detailsAdded() {
-		cachesWithLoadedDetails.add(this);
-		if (cachesWithLoadedDetails.size() &gt;= Global.getPref().maxDetails) removeOldestDetails();
+	public void save() {
+		this.getFreshDetails().saveCacheDetails(Global.getProfile().dataDir);
 	}
-
-	public void releaseCacheDetails() {
+	
+	void releaseCacheDetails() {
 		if (details != null &amp;&amp; details.hasUnsavedChanges){
-			//calcRecommendationScore();
 			details.saveCacheDetails(Global.getProfile().dataDir);
-			this.update(details);
 		}
 		details = null;
-		cachesWithLoadedDetails.remove(this);
+		cachesWithLoadedDetails.remove(this.getWayPoint());
 	}
 
 	//final static int maxDetails = 50; 
 	static Vector cachesWithLoadedDetails = new Vector(Global.getPref().maxDetails);
 
 	public static void removeOldestDetails() {
-		for (int i=0; i&lt;Global.getPref().deleteDetails; i++)
-			((CacheHolder)(cachesWithLoadedDetails.get(0))).releaseCacheDetails();
+		for (int i=0; i&lt;Global.getPref().deleteDetails; i++) {
+			String wp = (String) cachesWithLoadedDetails.get(i);
+			CacheHolder ch = Global.getProfile().cacheDB.get(wp);
+			if (ch!=null) ch.releaseCacheDetails();
+		}	
 	}
 
 	public static void removeAllDetails() {
-		for (int i=cachesWithLoadedDetails.size()-1; i&gt;=0; i--)
-			((CacheHolder)(cachesWithLoadedDetails.get(0))).releaseCacheDetails();
+		for (int i=cachesWithLoadedDetails.size()-1; i&gt;=0; i--) {
+			String wp = (String) cachesWithLoadedDetails.get(i);
+			CacheHolder ch = Global.getProfile().cacheDB.get(wp);
+			if (ch!=null &amp;&amp; ch.detailsLoaded()) ch.releaseCacheDetails();
+		}
 	}
 
 	/**
 	 * when importing caches you can set details.saveChanges = true
-	 * when the import ist finished call this method to save the pending changes
-	 *
+	 * when the import is finished call this method to save the pending changes
 	 */
 	public static void saveAllModifiedDetails() {
 		CacheHolder ch;
 		CacheHolderDetail chD;
 		for (int i=cachesWithLoadedDetails.size()-1; i&gt;=0; i--) {
-			ch = (CacheHolder)(cachesWithLoadedDetails.get(i));
-			chD = ch.getCacheDetails(false);
-			if (chD.hasUnsavedChanges) {
-				//ch.calcRecommendationScore();
-				chD.saveCacheDetails(Global.getProfile().dataDir);
-				ch.update(chD);
-			}
+			String wp = (String) cachesWithLoadedDetails.get(i);
+			ch = Global.getProfile().cacheDB.get(wp);
+			if (ch != null) {
+	            chD = ch.getCacheDetails(false);
+	            if (chD.hasUnsavedChanges) {
+		            //ch.calcRecommendationScore();
+		            chD.saveCacheDetails(Global.getProfile().dataDir);
+	            }
+            }
 		}
 	}
 
@@ -642,9 +724,9 @@
 				base = 16;
 			}
 			
-			for ( int pos = 0; pos &lt; rightPart.length(); pos++ ) {
+			for ( int p = 0; p &lt; rightPart.length(); p++ ) {
 				gcId *= base;
-				gcId += sequence.indexOf(rightPart.charAt(pos));
+				gcId += sequence.indexOf(rightPart.charAt(p));
 			}
 			
 	        if ( base == 31 ) {

Modified: trunk/src/CacheWolf/CacheHolderDetail.java
===================================================================
--- trunk/src/CacheWolf/CacheHolderDetail.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/CacheHolderDetail.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -14,12 +14,16 @@
 import ewe.ui.InputBox;
 import ewe.util.Vector;
 
-public class CacheHolderDetail extends CacheHolder {
-	  public String LongDescription = EMPTY;
-	  public String LastUpdate = EMPTY;
-	  public String Hints = EMPTY;
+public class CacheHolderDetail {
+	  
+	  
+	 /** CacheHolder which holds the detail. &lt;b&gt;Only&lt;/b&gt; set by CacheHolder when creating detail! **/
+	  private CacheHolder parent = null;
+	  public String LongDescription = CacheHolder.EMPTY;
+	  public String LastUpdate = CacheHolder.EMPTY;
+	  public String Hints = CacheHolder.EMPTY;
 	  public LogList CacheLogs=new LogList();
-	  public String CacheNotes = EMPTY;
+	  public String CacheNotes = CacheHolder.EMPTY;
 	  public Vector Images = new Vector();
 	  public Vector ImagesText = new Vector();
 	  public Vector ImagesInfo = new Vector();
@@ -31,26 +35,26 @@
 	  public Vector CacheIcons = new Vector();
 	  public TravelbugList Travelbugs=new TravelbugList();
 	  //public String Bugs = EMPTY; Superceded by Travelbugs
-	  public String URL = EMPTY;
-	  public String Solver = EMPTY;
-	  public String OwnLogId = EMPTY;
+	  public String URL = CacheHolder.EMPTY;
+	  public String Solver = CacheHolder.EMPTY;
+	  public String OwnLogId = CacheHolder.EMPTY;
 	  public Log OwnLog = null;
-	  public String Country = EMPTY;
-	  public String State = EMPTY;
+	  public String Country = CacheHolder.EMPTY;
+	  public String State = CacheHolder.EMPTY;
 	  /** For faster cache import (from opencaching) changes are only written when the details are freed from memory 
 	   * If you want to save the changes automatically when the details are unloaded, set this to true */ 
 	  public boolean hasUnsavedChanges = false;
 	  
-	 public CacheHolderDetail() {
-	 }
-	 //public CacheHolderDetail(String wpt) {super(wpt); }
 	 public CacheHolderDetail(CacheHolder ch) {
-		 super(ch);
+		 parent = ch;
 	 }
 
+	 public CacheHolder getParent() {
+		 return parent;
+	 }
 	 public void setLongDescription(String longDescription) {
-	 	if (LongDescription.equals(&quot;&quot;)) setNew(true);
-	 	else if (!stripControlChars(LongDescription).equals(stripControlChars(longDescription))) setUpdated(true);
+	 	if (LongDescription.equals(&quot;&quot;)) getParent().setNew(true);
+	 	else if (!stripControlChars(LongDescription).equals(stripControlChars(longDescription))) getParent().setUpdated(true);
 	 	LongDescription = longDescription;
 	 }
 	 
@@ -64,17 +68,17 @@
 	 }
 	 
 	 public void setHints(String hints) {
-	 	if (!Hints.equals(hints)) setUpdated(true);
+	 	if (!Hints.equals(hints)) getParent().setUpdated(true);
 	 	Hints = hints;
 	 }
 	 
 	 public void setCacheLogs(LogList newLogs) {
 		 int size=newLogs.size();
 		 for (int i=size-1; i&gt;=0; i--) { // Loop over all new logs, must start with oldest log
-			 if (CacheLogs.merge(newLogs.getLog(i))&gt;=0) this.setLog_updated(true);
+			 if (CacheLogs.merge(newLogs.getLog(i))&gt;=0) getParent().setLog_updated(true);
 		 }
 		 //CacheLogs=logs;
-		 setNoFindLogs(CacheLogs.countNotFoundLogs());
+		 getParent().setNoFindLogs(CacheLogs.countNotFoundLogs());
 	 }
 
 	 
@@ -85,13 +89,12 @@
 	 * @return CacheHolder with updated data
 	 */
 	public CacheHolderDetail update(CacheHolderDetail newCh){
-		  super.update(newCh);
 		  // flags
-		  if (this.is_found() &amp;&amp; this.getCacheStatus().equals(&quot;&quot;)) this.setCacheStatus(MyLocale.getMsg(318,&quot;Found&quot;));
+		  if (getParent().is_found() &amp;&amp; getParent().getCacheStatus().equals(&quot;&quot;)) getParent().setCacheStatus(MyLocale.getMsg(318,&quot;Found&quot;));
 
 		  //travelbugs:GPX-File contains all actual travelbugs but not the missions
 		  //  we need to check whether the travelbug is already in the existing list
-		  this.setHas_bugs(newCh.Travelbugs.size()&gt;0);
+		  getParent().setHas_bugs(newCh.Travelbugs.size()&gt;0);
 		  for (int i=newCh.Travelbugs.size()-1; i&gt;=0; i--) {
 			 Travelbug tb=newCh.Travelbugs.getTB(i);  
 		     Travelbug oldTB=this.Travelbugs.find(tb.getName());
@@ -105,6 +108,11 @@
 		  // URL
 		  this.URL = newCh.URL;
 		  
+		  // Images
+		  this.Images = newCh.Images;
+		  this.ImagesInfo = newCh.ImagesInfo;
+		  this.ImagesText = newCh.ImagesText;
+		  
 		  setLongDescription(newCh.LongDescription);
 		  setHints(newCh.Hints);
 		  setCacheLogs(newCh.CacheLogs);
@@ -135,7 +143,7 @@
 				imgDesc = new InputBox(&quot;Description&quot;).input(&quot;&quot;,10);
 				//Create Destination Filename
 				String ext = imgFile.getFileExt().substring(imgFile.getFileExt().lastIndexOf(&quot;.&quot;));
-				imgDestName = this.getWayPoint() + &quot;_U_&quot; + (this.UserImages.size()+1) + ext;
+				imgDestName = getParent().getWayPoint() + &quot;_U_&quot; + (this.UserImages.size()+1) + ext;
 				
 				this.UserImages.add(imgDestName);
 				this.UserImagesText.add(imgDesc);
@@ -152,14 +160,19 @@
 		*	It fills information on cache details, hints, logs, notes and
 		*	images.
 		*/
-		public void readCache(String dir) throws IOException{
+		void readCache(String dir) throws IOException{
 			String dummy;
 			FileReader in = null;
-			if (new FileBugfix(dir + getWayPoint().toLowerCase() + &quot;.xml&quot;).exists()) in = new FileReader(dir+getWayPoint().toLowerCase() + &quot;.xml&quot;);
+			// If parent cache has empty waypoint then don't do anything. This might happen
+			// when a cache object is freshly created to serve as container for imported data
+			if (this.getParent().getWayPoint().equals(CacheHolder.EMPTY)) return;
+			
+			if (new FileBugfix(dir + getParent().getWayPoint().toLowerCase() + &quot;.xml&quot;).exists()) in = new FileReader(dir+getParent().getWayPoint().toLowerCase() + &quot;.xml&quot;);
 			if (in == null) {
-				if (new FileBugfix(dir + getWayPoint() + &quot;.xml&quot;).exists()) in = new FileReader(dir+getWayPoint() + &quot;.xml&quot;);
+				if (new FileBugfix(dir + getParent().getWayPoint() + &quot;.xml&quot;).exists()) in = new FileReader(dir+getParent().getWayPoint() + &quot;.xml&quot;);
 			}
-			if (in == null) throw new FileNotFoundException(dir+getWayPoint().toLowerCase()+&quot;.xml&quot;);
+			if (in == null) throw new FileNotFoundException(dir+getParent().getWayPoint().toLowerCase()+&quot;.xml&quot;);
+			Global.getPref().log(&quot;Reading file &quot;+getParent().getWayPoint() + &quot;.xml&quot;);
 			String text= in.readAll();
 			in.close();
 			Extractor ex = new Extractor(text, &quot;&lt;DETAILS&gt;&lt;![CDATA[&quot;, &quot;]]&gt;&lt;/DETAILS&gt;&quot;, 0, true);		
@@ -267,8 +280,8 @@
 				URL = dummy;
 			}
 			else {
-				if (getWayPoint().startsWith(&quot;GC&quot;)) {
-					URL = &quot;<A HREF="http://www.geocaching.com/seek/cache_details.aspx?wp=">http://www.geocaching.com/seek/cache_details.aspx?wp=</A>&quot;+ getWayPoint() + &quot;&amp;Submit6=Find&amp;log=y&quot;;
+				if (getParent().getWayPoint().startsWith(&quot;GC&quot;)) {
+					URL = &quot;<A HREF="http://www.geocaching.com/seek/cache_details.aspx?wp=">http://www.geocaching.com/seek/cache_details.aspx?wp=</A>&quot;+ getParent().getWayPoint() + &quot;&amp;Submit6=Find&amp;log=y&quot;;
 				}
 			}
 			ex = new Extractor(text, &quot;&lt;SOLVER&gt;&lt;![CDATA[&quot;, &quot;]]&gt;&lt;/SOLVER&gt;&quot;, 0, true);
@@ -280,28 +293,29 @@
 		*/
 		public void saveCacheDetails(String dir){
 			PrintWriter detfile;
+			
 			//File exists?
-			boolean exists = (new File(dir + getWayPoint() + &quot;.xml&quot;)).exists();
+			boolean exists = (new File(dir + getParent().getWayPoint() + &quot;.xml&quot;)).exists();
 			//yes: then delete
 			if (exists) {
-				boolean ok = (new File(dir + getWayPoint() + &quot;.xml&quot;)).delete();
+				boolean ok = (new File(dir + getParent().getWayPoint() + &quot;.xml&quot;)).delete();
 				if(ok) ok = true;
 			}
-			boolean exists2 = (new File(dir + getWayPoint().toLowerCase() + &quot;.xml&quot;)).exists();
+			boolean exists2 = (new File(dir + getParent().getWayPoint().toLowerCase() + &quot;.xml&quot;)).exists();
 			//yes: delete
 			if (exists2) {
-				boolean ok2 = (new File(dir + getWayPoint().toLowerCase() + &quot;.xml&quot;)).delete();
+				boolean ok2 = (new File(dir + getParent().getWayPoint().toLowerCase() + &quot;.xml&quot;)).delete();
 				if(ok2) ok2=true;
 			}
 			//Vm.debug(&quot;Writing to: &quot; +dir + &quot;for: &quot; + wayPoint);
 			try{
-			  detfile = new PrintWriter(new BufferedWriter(new FileWriter(dir + getWayPoint().toLowerCase() + &quot;.xml&quot;)));
+			  detfile = new PrintWriter(new BufferedWriter(new FileWriter(dir + getParent().getWayPoint().toLowerCase() + &quot;.xml&quot;)));
 			} catch (Exception e) {
 				Global.getPref().log(&quot;Problem creating details file&quot;,e,true);
 				return;
 			}
 			try{
-				if(getWayPoint().length()&gt;0){
+				if(getParent().getWayPoint().length()&gt;0){
 				  detfile.print(&quot;&lt;?xml version=\&quot;1.0\&quot; encoding=\&quot;ISO-8859-1\&quot;?&gt;\r\n&quot;);
 				  detfile.print(&quot;&lt;CACHEDETAILS&gt;\r\n&quot;);
 				  detfile.print(&quot;&lt;DETAILS&gt;&lt;![CDATA[&quot;+LongDescription+&quot;]]&gt;&lt;/DETAILS&gt;\r\n&quot;);
@@ -362,37 +376,22 @@
 				  detfile.print(Travelbugs.toXML());
 				  detfile.print(&quot;&lt;URL&gt;&lt;![CDATA[&quot;+URL+&quot;]]&gt;&lt;/URL&gt;\r\n&quot;);
 				  detfile.print(&quot;&lt;SOLVER&gt;&lt;![CDATA[&quot;+Solver+&quot;]]&gt;&lt;/SOLVER&gt;\r\n&quot;);
-				  detfile.print(toXML()); // This will allow restoration of index.xml
+				  detfile.print(getParent().toXML()); // This will allow restoration of index.xml
 				  detfile.print(&quot;&lt;/CACHEDETAILS&gt;\n&quot;);
+				  Global.getPref().log(&quot;Writing file: &quot;+getParent().getWayPoint().toLowerCase() + &quot;.xml&quot;);
 				} // if length
 			} catch (Exception e){
-				Global.getPref().log(&quot;Problem waypoint &quot; + getWayPoint() + &quot; writing to a details file: &quot; + e.getMessage());
+				Global.getPref().log(&quot;Problem waypoint &quot; + getParent().getWayPoint() + &quot; writing to a details file: &quot; + e.getMessage());
 			}
 			try{
 			  detfile.close();
 			} catch (Exception e){
-				Global.getPref().log(&quot;Problem waypoint &quot; + getWayPoint() + &quot; writing to a details file: &quot; + e.getMessage());
+				Global.getPref().log(&quot;Problem waypoint &quot; + getParent().getWayPoint() + &quot; writing to a details file: &quot; + e.getMessage());
 			}
 			hasUnsavedChanges = false;
 		}
-		
+				
 		/**
-		 * Method for checking if to caches belongs to each other, e.g.
-		 * an additional waypoint belongs to the main cache.
-		 * Works currently only, if the last 4 or 5 chars of the waypoint are
-		 * the same, this is the gc.com way. 
-		 * @param ch cache to check
-		 * @return true if there is a relation, false otherwise
-		 */
-		public boolean belongsTo (CacheHolder ch) {
-			
-			// avoid self referencing
-			if (this.getWayPoint().equals(ch.getWayPoint())) return false;
-
-			return this.getWayPoint().endsWith(ch.getWayPoint().substring(2));
-		}
-		
-		/**
 		 * Return true if this cache has additional info for some pictures
 		 * @return true if cache has additional info, false otherwise
 		 */
@@ -408,3 +407,5 @@
 //	   }
 
 }
+
+

Modified: trunk/src/CacheWolf/DataMover.java
===================================================================
--- trunk/src/CacheWolf/DataMover.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/DataMover.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -194,9 +194,8 @@
 			 this.title=title;
 		 }
 		 public void doIt(int i,CacheHolder srcHolder) {
-			srcHolder.releaseCacheDetails();
-			deleteCacheFiles(srcHolder.getWayPoint(),profile.dataDir);
-			srcDB.removeElementAt(i);
+			 srcDB.removeElementAt(i);
+			 deleteCacheFiles(srcHolder.getWayPoint(),profile.dataDir);
 		 }
 	}
 	 
@@ -206,19 +205,16 @@
 			 this.dstProfile=dstProfile;
 		 }
 		 public void doIt(int i,CacheHolder srcHolder) {
-				srcHolder.releaseCacheDetails();
+				srcHolder.save();
+				deleteCacheFiles(srcHolder.getWayPoint(), dstProfile.dataDir);
+				copyCacheFiles(srcHolder.getWayPoint(),profile.dataDir, dstProfile.dataDir);
 				// does cache exists in destDB ?
+				// Update database
 				int dstPos = dstProfile.getCacheIndex(srcHolder.getWayPoint());
 				if (dstPos &gt;= 0){
-					deleteCacheFiles(srcHolder.getWayPoint(), dstProfile.dataDir);
-					copyCacheFiles(srcHolder.getWayPoint(),profile.dataDir, dstProfile.dataDir);
-					// Update database
 					dstProfile.cacheDB.set(dstPos,srcHolder);
 				}
 				else {
-					deleteCacheFiles(srcHolder.getWayPoint(), dstProfile.dataDir);
-					copyCacheFiles(srcHolder.getWayPoint(),profile.dataDir, dstProfile.dataDir);
-					// Update database
 					dstProfile.cacheDB.add(srcHolder);
 				}
 			 }		 
@@ -230,25 +226,20 @@
 				 this.dstProfile=dstProfile;
 			 }
 			 public void doIt(int i,CacheHolder srcHolder) {
+				 srcDB.removeElementAt(i);
+				 deleteCacheFiles(srcHolder.getWayPoint(), dstProfile.dataDir);
+				 moveCacheFiles(srcHolder.getWayPoint(),profile.dataDir, dstProfile.dataDir);
 				// does cache exists in destDB ?
-				srcHolder.releaseCacheDetails();
+				 // Update database
 				int dstPos = dstProfile.getCacheIndex(srcHolder.getWayPoint());
 				if (dstPos &gt;= 0){
-					deleteCacheFiles(srcHolder.getWayPoint(), dstProfile.dataDir);
-					moveCacheFiles(srcHolder.getWayPoint(),profile.dataDir, dstProfile.dataDir);
-					// Update database
 					dstProfile.cacheDB.set(dstPos,srcHolder);
-					srcDB.removeElementAt(i);
-					i--;
 				}
 				else {
-					deleteCacheFiles(srcHolder.getWayPoint(), dstProfile.dataDir);
-					moveCacheFiles(srcHolder.getWayPoint(),profile.dataDir, dstProfile.dataDir);
 					// Update database
 					dstProfile.cacheDB.add(srcHolder);
-					srcDB.removeElementAt(i);
-					i--;
 				}
+				i--;
 			 }		 
 		}
 	}

Modified: trunk/src/CacheWolf/DescriptionPanel.java
===================================================================
--- trunk/src/CacheWolf/DescriptionPanel.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/DescriptionPanel.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -15,7 +15,7 @@
 public class DescriptionPanel extends CellPanel{
 	HtmlDisplay disp = new HtmlDisplay();
 	mButton btnPlus, btnMinus;
-	CacheHolderDetail currCache;
+	CacheHolder currCache;
 	
 	CellPanel buttonP = new CellPanel();
 	CellPanel descP = new CellPanel();
@@ -37,7 +37,7 @@
          * Set the text to display. Text should be HTML formated.
          */
     // String description = null;
-    public void setText(CacheHolderDetail cache) {
+    public void setText(CacheHolder cache) {
         boolean isHtml;
         if (currCache == cache) return;
         int scrollto = 0;
@@ -49,16 +49,15 @@
                 scrollto = disp.getTopLine();
             isHtml = cache.is_HTML();
             if (cache.isAddiWpt()) {
-                CacheHolderDetail mainCache = cache.mainCache.getCacheDetails(true);
-                isHtml = mainCache.is_HTML();
-                if (cache.LongDescription != null &amp;&amp; cache.LongDescription.length() &gt; 0)
-                    desc = cache.LongDescription + (isHtml ? &quot;&lt;hr&gt;\n&quot; : &quot;\n&quot;)
-                            + mainCache.LongDescription;
+                isHtml = cache.mainCache.is_HTML();
+                if (cache.getExistingDetails().LongDescription != null &amp;&amp; cache.getExistingDetails().LongDescription.length() &gt; 0)
+                    desc = cache.getExistingDetails().LongDescription + (isHtml ? &quot;&lt;hr&gt;\n&quot; : &quot;\n&quot;)
+                            + cache.mainCache.getExistingDetails().LongDescription;
                 else
-                    desc = mainCache.LongDescription;
+                    desc = cache.mainCache.getExistingDetails().LongDescription;
             } else
                 // not an addi-wpt
-                desc = cache.LongDescription;
+                desc = cache.getExistingDetails().LongDescription;
         }
         // HtmlDisplay does not show the &lt;sup&gt; tag correctly, so we need to replace with ^
         if (desc.indexOf(&quot;&lt;sup&gt;&quot;)&gt;=0) {
@@ -70,13 +69,13 @@
             int imageNo = 0;
             if (Global.getPref().descShowImg) {
                 Vector Images;
-                CacheHolderDetail chDimages; // cache which supplies the images (could be main cache)
+                CacheHolder chImages; // cache which supplies the images (could be main cache)
                 if (cache.isAddiWpt()) {
-                    chDimages=cache.mainCache.getCacheDetails(true);
+                    chImages=cache.mainCache;
                 } else {
-                    chDimages=cache;
+                    chImages=cache;
                 }
-            	Images = chDimages.Images;
+            	Images = chImages.getExistingDetails().Images;
                 StringBuffer s = new StringBuffer(desc.length() + Images.size() * 100);
                 int start = 0;
                 int pos;
@@ -110,7 +109,7 @@
                     s.append(desc.substring(start));
                 desc = s.toString();
                 if (imageNo&lt;Images.getCount()) {
-                    desc += getPicDesc(imageNo, chDimages);
+                    desc += getPicDesc(imageNo, chImages.getExistingDetails());
                 }
             }
             //disp.setHtml(desc);
@@ -156,18 +155,6 @@
 		currCache = null;
 	}
 	
-	// Probably not needed anymore (Change in Rev. 1395)
-	private void redraw() {
-		int currLine;
-
-		Vm.showWait(true);
-		currLine = disp.getTopLine();
-		if (currCache.is_HTML())	disp.setHtml(desc);
-		else				disp.setPlainText(currCache.LongDescription);
-		disp.scrollTo(currLine,false);
-		Vm.showWait(false);
-	}
-	
 	/**
 	 * Eventhandler
 	 */

Modified: trunk/src/CacheWolf/DetailsPanel.java
===================================================================
--- trunk/src/CacheWolf/DetailsPanel.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/DetailsPanel.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -221,7 +221,7 @@
 		lblTerr.setText((ch.getTerrain().length()&gt;0) ? (MyLocale.getMsg(1001,&quot;T&quot;)+&quot;: &quot;+ch.getTerrain()) : &quot;&quot;);
 		lblDiff.setText((ch.getHard().length()&gt;0)    ? (MyLocale.getMsg(1000,&quot;D&quot;)+&quot;: &quot;+ch.getHard()) : &quot;&quot;); 
 
-		if(isBigScreen)	mNotes.setText(ch.details.CacheNotes);
+		if(isBigScreen)	mNotes.setText(ch.getExistingDetails().CacheNotes);
 	}
 	
 	
@@ -377,7 +377,7 @@
 				else 	note = note + dtm.toString();
 				note = note + &quot;\n&quot;;
 				thisCache.getCacheDetails(true).CacheNotes = note;
-				thisCache.getCacheDetails(true).saveCacheDetails( Global.getProfile().dataDir);
+				thisCache.save();
 			}
 			else if (ev.target == btnAddPicture){
 				thisCache.getCacheDetails(true).addUserImage(profile);
@@ -536,14 +536,9 @@
 		  // set status also on addi wpts
 		  ch.setAttributesToAddiWpts();
 		  dirty_notes=false;
-		  // if (dirty_details) { Global.getProfile().hasUnsavedChanges=true;}
 		  dirty_details=false;
 		  setNeedsTableUpdate(false);
-		  if (thisCache.details != null) thisCache.details.hasUnsavedChanges = false;
-		  thisCache.getCacheDetails(true).hasUnsavedChanges = true;
-		  
-		  // Global.mainTab.tbP.refreshTable(); this is done in mainTab.onLeavingPanel
-		  ////Vm.debug(&quot;New status updated!&quot;);
+		  thisCache.getFreshDetails().hasUnsavedChanges = true;
 	}
 
 	private class TravelbugInCacheScreen extends Form {

Modified: trunk/src/CacheWolf/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/GPXImporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/GPXImporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -18,7 +18,7 @@
 	static Preferences pref;
 	Profile profile;
 	CacheDB cacheDB;
-	CacheHolderDetail chD;
+	CacheHolder holder;
 	String strData, saveDir, logData, logIcon, logDate, logFinder, logId;
 	boolean inWpt, inCache, inLogs, inBug;
 	public XMLElement document;
@@ -156,9 +156,9 @@
 			zaehlerGel = 0;
 		}
 		if (name.equals(&quot;wpt&quot;)) {
-			chD = new CacheHolderDetail();
-			chD.pos.set(Common.parseDouble(atts.getValue(&quot;lat&quot;)),Common.parseDouble(atts.getValue(&quot;lon&quot;)));
-			chD.LatLon=chD.pos.toString();
+			holder = new CacheHolder();
+			holder.pos.set(Common.parseDouble(atts.getValue(&quot;lat&quot;)),Common.parseDouble(atts.getValue(&quot;lon&quot;)));
+			holder.LatLon=holder.pos.toString();
 			inWpt = true;
 			inLogs = false;
 			inBug = false;
@@ -169,14 +169,14 @@
 		}
 		
 		if (name.equals(&quot;link&quot;)&amp;&amp; inWpt){
-			chD.URL = atts.getValue(&quot;href&quot;);
+			holder.getFreshDetails().URL = atts.getValue(&quot;href&quot;);
 			return;
 		}
 
 		if (name.equals(&quot;groundspeak:cache&quot;)) {
 			inCache = true;
-			chD.setAvailable(atts.getValue(&quot;available&quot;).equals(&quot;True&quot;));
-			chD.setArchived(atts.getValue(&quot;archived&quot;).equals(&quot;True&quot;));
+			holder.setAvailable(atts.getValue(&quot;available&quot;).equals(&quot;True&quot;));
+			holder.setArchived(atts.getValue(&quot;archived&quot;).equals(&quot;True&quot;));
 			return;
 		}
 
@@ -190,8 +190,8 @@
 			else if (status.equals(&quot;Unavailable&quot;)) available = false;
 			else if (status.equals(&quot;Draft&quot;)) available = false;
 			else if (status.equals(&quot;Archived&quot;)) archived = true;
-			chD.setArchived(archived);
-			chD.setAvailable(available);
+			holder.setArchived(archived);
+			holder.setAvailable(available);
 			return;
 		}
 		
@@ -201,11 +201,11 @@
 
 		
 		if (name.equals(&quot;groundspeak:long_description&quot;)) {
-			chD.setHTML(atts.getValue(&quot;html&quot;).toLowerCase().equals(&quot;true&quot;));
+			holder.setHTML(atts.getValue(&quot;html&quot;).toLowerCase().equals(&quot;true&quot;));
 		}
 		if (name.equals(&quot;description&quot;) || name.equals(&quot;terra:description&quot;) ) {
 			//set HTML always to true if from oc.de or TC
-			chD.setHTML(true);
+			holder.setHTML(true);
 		}
 
 		if (name.equals(&quot;groundspeak:logs&quot;) || name.equals(&quot;logs&quot;) || name.equals(&quot;terra:logs&quot;)) {
@@ -251,13 +251,13 @@
 				return;
 			}
 			if (name.equals(&quot;groundspeak:log&quot;) || name.equals(&quot;log&quot;) || name.equals(&quot;terra:log&quot;) ) {
-				chD.CacheLogs.add(new Log(logIcon,logDate,logFinder,logData));
+				holder.getFreshDetails().CacheLogs.add(new Log(logIcon,logDate,logFinder,logData));
 				if((logIcon.equals(&quot;icon_smile.gif&quot;) || logIcon.equals(&quot;11.png&quot;) || logIcon.equals(&quot;icon_attended.gif&quot;)) &amp;&amp; 
 						  (logFinder.equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; logFinder.equalsIgnoreCase(pref.myAlias2)))) {
-							chD.setCacheStatus(logDate);
-							chD.setFound(true);
-							chD.OwnLogId = logId;
-							chD.OwnLog = new Log(logIcon,logDate,logFinder,logData);
+							holder.setCacheStatus(logDate);
+							holder.setFound(true);
+							holder.getFreshDetails().OwnLogId = logId;
+							holder.getFreshDetails().OwnLog = new Log(logIcon,logDate,logFinder,logData);
 				}
 				return;
 			}
@@ -266,42 +266,42 @@
 		if (name.equals(&quot;wpt&quot;)){
 			// Add cache Data only, if waypoint not already in database
 			//if (searchWpt(cacheDB, holder.wayPoint)== -1){
-			int index=cacheDB.getIndex(chD.getWayPoint());
+			int index=cacheDB.getIndex(holder.getWayPoint());
 			//Vm.debug(&quot;here ?!?!?&quot;);
 			//Vm.debug(&quot;chould be new!!!!&quot;);
 			if (index == -1){
-				chD.setNoFindLogs(chD.CacheLogs.countNotFoundLogs());
-				chD.setNew(true);
-				cacheDB.add(new CacheHolder(chD));
+				holder.setNoFindLogs(holder.getFreshDetails().CacheLogs.countNotFoundLogs());
+				holder.setNew(true);
+				cacheDB.add(holder);
 				// don't spider additional waypoints, so check
 				// if waypoint starts with &quot;GC&quot;
 				if(doSpider == true) {
-					if(spiderOK == true &amp;&amp; chD.is_archived() == false){
-							if(chD.LatLon.length() &gt; 1){
+					if(spiderOK == true &amp;&amp; holder.is_archived() == false){
+							if(holder.LatLon.length() &gt; 1){
 							if(getMaps){
-								ParseLatLon pll = new ParseLatLon(chD.LatLon,&quot;.&quot;);
+								ParseLatLon pll = new ParseLatLon(holder.LatLon,&quot;.&quot;);
 								pll.parse();
 								//MapLoader mpl = new MapLoader(pref.myproxy, pref.myproxyport);
 								//mpl.loadTo(profile.dataDir + &quot;/&quot; + holder.wayPoint + &quot;_map.gif&quot;, &quot;3&quot;);
 								//mpl.loadTo(profile.dataDir + &quot;/&quot; + holder.wayPoint + &quot;_map_2.gif&quot;, &quot;10&quot;);
 							}
 						}
-					if(chD.getWayPoint().startsWith(&quot;GC&quot;)|| fromTC) {
+					if(holder.getWayPoint().startsWith(&quot;GC&quot;)|| fromTC) {
 						//spiderImages();
 						spiderImagesUsingSpider();
 						//Rename image sources
 						String text;
 						String orig;
 						String imgName;
-						orig = chD.LongDescription;
+						orig = holder.getFreshDetails().LongDescription;
 						Extractor ex = new Extractor(orig, &quot;&lt;img src=\&quot;&quot;, &quot;&gt;&quot;, 0, false);
 						text = ex.findNext();
 						int num = 0;
 						while(ex.endOfSearch() == false &amp;&amp; spiderOK == true){
 							//Vm.debug(&quot;Replacing: &quot; + text);
-							if (num &gt;= chD.ImagesText.getCount())break;
-							imgName = (String)chD.ImagesText.get(num);
-							chD.LongDescription = replace(chD.LongDescription, text, &quot;[[Image: &quot; + imgName + &quot;]]&quot;);
+							if (num &gt;= holder.getFreshDetails().ImagesText.getCount())break;
+							imgName = (String)holder.getFreshDetails().ImagesText.get(num);
+							holder.getFreshDetails().LongDescription = replace(holder.getFreshDetails().LongDescription, text, &quot;[[Image: &quot; + imgName + &quot;]]&quot;);
 							num++;
 							text = ex.findNext();
 						}
@@ -309,30 +309,22 @@
 						
 					}
 				}
-				chD.saveCacheDetails(saveDir);
+				holder.save();
 				//crw.saveIndex(cacheDB,saveDir);
 			}
 			//Update cache data
 			else {
-				//Vm.debug(&quot;it is not new!&quot;);
-				CacheHolderDetail oldCh= new CacheHolderDetail(cacheDB.get(index));
-				try {
-					//Vm.debug(&quot;Try to load&quot;);
-					oldCh.readCache(saveDir);
-					//Vm.debug(&quot;Done loading&quot;);
-				} catch (Exception e) {Vm.debug(&quot;Could not open file: &quot; + e.toString());};
-				oldCh.update(chD);
-				oldCh.saveCacheDetails(saveDir);
-				cacheDB.set(index, new CacheHolder(oldCh));
-				//crw.saveIndex(cacheDB,saveDir);
+				CacheHolder oldCh= cacheDB.get(index);
+				oldCh.update(holder);
+				oldCh.save();
 			}
 			
 			inWpt = false;
 			return;
 		}
 		if (name.equals(&quot;sym&quot;)&amp;&amp; strData.endsWith(&quot;Found&quot;)) {
-			chD.setFound(true);
-			chD.setCacheStatus(MyLocale.getMsg(318,&quot;Found&quot;));
+			holder.setFound(true);
+			holder.setCacheStatus(MyLocale.getMsg(318,&quot;Found&quot;));
 			return;
 		}
 		if (name.equals(&quot;groundspeak:travelbugs&quot;)) {
@@ -342,9 +334,9 @@
 
 		if (name.equals(&quot;groundspeak:name&quot;)&amp;&amp; inBug) {
 			Travelbug tb=new Travelbug(strData);
-			chD.Travelbugs.add(tb);
+			holder.getFreshDetails().Travelbugs.add(tb);
 			//holder.Bugs += &quot;&lt;b&gt;Name:&lt;/b&gt; &quot; + strData + &quot;&lt;br&gt;&lt;hr&gt;&quot;;
-			chD.setHas_bugs(true);
+			holder.setHas_bugs(true);
 			return;
 		}
 		
@@ -353,7 +345,7 @@
 			//Date = strData.substring(5,7); // month
 			//Date += &quot;/&quot; + strData.substring(8,10); // day
 			//Date += &quot;/&quot; + strData.substring(0,4); // year
-			chD.setDateHidden(strData.substring(0,10)); //Date;
+			holder.setDateHidden(strData.substring(0,10)); //Date;
 			return;
 		}
 		// cache information
@@ -362,7 +354,7 @@
 		}
 		
 		if (name.equals(&quot;name&quot;) &amp;&amp; inWpt &amp;&amp; !inCache) {
-			chD.setWayPoint(strData);
+			holder.setWayPoint(strData);
 			//msgA.setText(&quot;import &quot; + strData);
 			return;
 		}
@@ -371,87 +363,87 @@
 		// fill name with contents of &lt;desc&gt;, in case of gc.com the name is
 		// later replaced by the contents of &lt;groundspeak:name&gt; which is shorter
 		if (name.equals(&quot;desc&quot;)&amp;&amp; inWpt ) {
-			chD.setCacheName(strData);
+			holder.setCacheName(strData);
 			//Vm.debug(&quot;CacheName: &quot; + strData);
 			//msgA.setText(&quot;import &quot; + strData);
 			return;
 		}
 		if (name.equals(&quot;url&quot;)&amp;&amp; inWpt){
-			chD.URL = strData;
+			holder.getFreshDetails().URL = strData;
 			return;
 		}
 		
 		// Text for additional waypoints, no HTML
 		if (name.equals(&quot;cmt&quot;)&amp;&amp; inWpt){
-			chD.LongDescription = strData;
-			chD.setHTML(false);
+			holder.getFreshDetails().LongDescription = strData;
+			holder.setHTML(false);
 			return;
 		}
 		
 		// aditional wapypoint
 		if (name.equals(&quot;type&quot;)&amp;&amp; inWpt &amp;&amp; !inCache &amp;&amp; strData.startsWith(&quot;Waypoint&quot;)){
-			chD.setType(CacheType.typeText2Number(strData));
-			chD.setCacheSize(&quot;None&quot;);
+			holder.setType(CacheType.typeText2Number(strData));
+			holder.setCacheSize(&quot;None&quot;);
 		}
 
 		
 		if ((name.equals(&quot;groundspeak:name&quot;)|| name.equals(&quot;terra:name&quot;)) &amp;&amp; inCache) {
-			chD.setCacheName(strData);
+			holder.setCacheName(strData);
 			return;
 		}
 		if (name.equals(&quot;groundspeak:owner&quot;) || name.equals(&quot;owner&quot;)||name.equals(&quot;terra:owner&quot;)) {
-			chD.setCacheOwner(strData);
-			if(pref.myAlias.equals(strData)) chD.setOwned(true);
+			holder.setCacheOwner(strData);
+			if(pref.myAlias.equals(strData)) holder.setOwned(true);
 			return;
 		}
 		if (name.equals(&quot;groundspeak:difficulty&quot;) || name.equals(&quot;difficulty&quot;) || name.equals(&quot;terra:mental_challenge&quot;)) {
-			chD.setHard(strData.replace('.',','));
+			holder.setHard(strData.replace('.',','));
 			return;
 		}
 		if (name.equals(&quot;groundspeak:terrain&quot;)|| name.equals(&quot;terrain&quot;)|| name.equals(&quot;terra:physical_challenge&quot;)) {
-			chD.setTerrain(strData.replace('.',','));
+			holder.setTerrain(strData.replace('.',','));
 			return;
 		}
 		if ((name.equals(&quot;groundspeak:type&quot;) || name.equals(&quot;type&quot;)|| name.equals(&quot;terra:style&quot;))&amp;&amp; inCache){
-			chD.setType(CacheType.typeText2Number(strData));
+			holder.setType(CacheType.typeText2Number(strData));
 			return;
 		}
 		if (name.equals(&quot;groundspeak:container&quot;)|| name.equals(&quot;container&quot;)){
-			chD.setCacheSize(strData);
+			holder.setCacheSize(strData);
 			return;
 		}
 		if (name.equals(&quot;groundspeak:country&quot;)|| name.equals(&quot;country&quot;)){
-			chD.Country = strData;
+			holder.getFreshDetails().Country = strData;
 			return;
 		}
 		if (name.equals(&quot;groundspeak:state&quot;)|| name.equals(&quot;state&quot;)){
-			chD.State = strData;
+			holder.getFreshDetails().State = strData;
 			return;
 		}
 		if (name.equals(&quot;terra:size&quot;)){
-			chD.setCacheSize(TCSizetoText(strData));
+			holder.setCacheSize(TCSizetoText(strData));
 		}
 
 		if (name.equals(&quot;groundspeak:short_description&quot;)|| name.equals(&quot;summary&quot;)) {
-			if (chD.is_HTML())	chD.LongDescription =SafeXML.cleanback(strData)+&quot;&lt;br&gt;&quot;; // &lt;br&gt; needed because we also use a &lt;br&gt; in SpiderGC. Without it the comparison in ch.update fails
-			else chD.LongDescription =strData+&quot;\n&quot;;
+			if (holder.is_HTML())	holder.getFreshDetails().LongDescription =SafeXML.cleanback(strData)+&quot;&lt;br&gt;&quot;; // &lt;br&gt; needed because we also use a &lt;br&gt; in SpiderGC. Without it the comparison in ch.update fails
+			else holder.getFreshDetails().LongDescription =strData+&quot;\n&quot;;
 			return;
 		}
 
 		if (name.equals(&quot;groundspeak:long_description&quot;)|| name.equals(&quot;description&quot;)|| name.equals(&quot;terra:description&quot;)) {
-			if (chD.is_HTML())	chD.LongDescription +=SafeXML.cleanback(strData);
-			else chD.LongDescription +=strData;
+			if (holder.is_HTML())	holder.getFreshDetails().LongDescription +=SafeXML.cleanback(strData);
+			else holder.getFreshDetails().LongDescription +=strData;
 			return;
 		}
 		if (name.equals(&quot;groundspeak:encoded_hints&quot;) || name.equals(&quot;hints&quot;)) {
-			chD.Hints = Common.rot13(strData);
+			holder.getFreshDetails().Hints = Common.rot13(strData);
 			return;
 		}
 		
 		if (name.equals(&quot;terra:hint&quot;)) {
 			// remove &quot;&lt;br&gt;&lt;br&gt;&quot; from the end
 			int indexTrash = strData.indexOf(&quot;&lt;br&gt;&lt;br&gt;&quot;);
-			if (indexTrash &gt; 0)	chD.Hints = Common.rot13(strData.substring(0,indexTrash));
+			if (indexTrash &gt; 0)	holder.getFreshDetails().Hints = Common.rot13(strData.substring(0,indexTrash));
 			return;
 		}
 
@@ -523,13 +515,13 @@
 		if (imgSpider == null) imgSpider = new SpiderGC(pref, profile, false);
 		
 		if (fromTC) {
-				imgSpider.getImages(chD.LongDescription, chD);
+				imgSpider.getImages(holder.getFreshDetails().LongDescription, holder.getFreshDetails());
 		}
 		else {
-			addr = &quot;<A HREF="http://www.geocaching.com/seek/cache_details.aspx?wp=">http://www.geocaching.com/seek/cache_details.aspx?wp=</A>&quot; + chD.getWayPoint() ;
+			addr = &quot;<A HREF="http://www.geocaching.com/seek/cache_details.aspx?wp=">http://www.geocaching.com/seek/cache_details.aspx?wp=</A>&quot; + holder.getWayPoint() ;
 			//Vm.debug(addr + &quot;|&quot;);
 			cacheText = SpiderGC.fetch(addr);
-			imgSpider.getImages(cacheText, chD);
+			imgSpider.getImages(cacheText, holder.getFreshDetails());
 		}
 	}
 	

Modified: trunk/src/CacheWolf/LOCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/LOCXMLImporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/LOCXMLImporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -42,7 +42,7 @@
 	Preferences pref;
 	Profile profile;
 	String file;
-	CacheHolderDetail holder;
+	CacheHolder holder;
 
 	String strData = new String();
 
@@ -102,21 +102,20 @@
 			index = cacheDB.getIndex(holder.getWayPoint());
 			if (index == -1){
 				holder.setNew(true);
-				cacheDB.add(new CacheHolder(holder));
+				cacheDB.add(holder);
 			}
 			// update (overwrite) data
 			else {
 				holder.setNew(false);
-				cacheDB.set(index, new CacheHolder(holder));
 			}
 			// save all  (after each cache???)
-			holder.saveCacheDetails(profile.dataDir);
+			holder.save();
 			profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR);
 			return;
 		}
 
 		if (name.equals(&quot;link&quot;)){
-			holder.URL = strData;
+			holder.getFreshDetails().URL = strData;
 			return;
 		}
 
@@ -131,20 +130,14 @@
 		if (debugXML) Vm.debug(strData);
 	}
 
-	private CacheHolderDetail getHolder(String wpt){// See also OCXMLImporter
-		int index;
-		CacheHolderDetail ch;
+	private CacheHolder getHolder(String wpt){// See also OCXMLImporter
+		CacheHolder ch;
 		
-		index = cacheDB.getIndex(wpt);
-		if (index == -1){
-			ch = new CacheHolderDetail();
+		ch = cacheDB.get(wpt);
+		if (ch == null) {
+			ch = new CacheHolder();
 			ch.setWayPoint(wpt);
-			return ch;
 		}
-		ch = new CacheHolderDetail(cacheDB.get(index));
-		try {
-			ch.readCache(profile.dataDir);
-		} catch (Exception e) {Vm.debug(&quot;Could not open file: &quot; + e.toString());};
 		return ch;
 	}
 

Modified: trunk/src/CacheWolf/MainTab.java
===================================================================
--- trunk/src/CacheWolf/MainTab.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/MainTab.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -30,8 +30,8 @@
 	ImagePanel imageP;
 	SolverPanel solverP;
 	String lastselected = &quot;&quot;;
-	public CacheHolder ch=null;
-	CacheHolderDetail chD =null, chMain=null;
+	public CacheHolder ch=null, chMain=null;
+	CacheHolderDetail chD =null;
 	MainMenu mnuMain;
 	StatusBar statBar;
 	public MovingMap mm;
@@ -137,18 +137,13 @@
 			chMain=null;
 			cacheDirty=false;
 			if (tbP.getSelectedCache()&gt;=Global.mainTab.tbP.myMod.numRows || tbP.getSelectedCache()&lt;0) {
-				ch=null; chD=null; 
+				ch=null;
+				chD=null; 
 				lastselected=&quot;&quot;;
 			} else {
 				ch = cacheDB.get(tbP.getSelectedCache());
 				lastselected=ch.getWayPoint();  // Used in Parser.Skeleton
-				try {
-					chD = ch.getCacheDetails(true);
-					//chD=new CacheHolderDetail(ch);
-					//chD.readCache(profile.dataDir);//Vm.debug(&quot;MainTab:readCache &quot;+chD.wayPoint+&quot;/S:&quot;+chD.Solver);
-				} catch(Exception e){
-					//Vm.debug(&quot;Error loading: &quot;+ch.wayPoint);
-				}
+				chD = ch.getCacheDetails(true);
 			}
 		}
 		if (panelNo==1) { // Leaving the Details Panel
@@ -174,8 +169,8 @@
 				if (chMain==null) {
 					chD.Solver=solverP.getInstructions();
 				} else {
-					chMain.Solver=solverP.getInstructions();
-					chMain.saveCacheDetails(Global.getProfile().dataDir);//Vm.debug(&quot;mainT:SaveCache &quot;+chMain.wayPoint+&quot;/S:&quot;+chMain.Solver);
+					chMain.getExistingDetails().Solver=solverP.getInstructions();
+					chMain.save();//Vm.debug(&quot;mainT:SaveCache &quot;+chMain.wayPoint+&quot;/S:&quot;+chMain.Solver);
 					chMain=null;
 				}
 			}
@@ -207,55 +202,42 @@
 			break;
 		case 2: // Description Panel
 			MyLocale.setSIPOff();
-			descP.setText(chD);
+			descP.setText(ch);
 			break;
 		case 3: // Picture Panel
-			if (chD!=null) {
-				MyLocale.setSIPOff();
-				if (chD.isAddiWpt()) { 
-					imageP.setImages(chD.mainCache.getCacheDetails(true));
-				} else {
-					imageP.setImages(chD);
-				}
+			MyLocale.setSIPOff();
+			if (ch.isAddiWpt()) { 
+				imageP.setImages(ch.mainCache.getCacheDetails(true));
+			} else {
+				imageP.setImages(chD);
 			}
 			break;
 		case 4:  // Log Hint Panel
-			if (chD!=null) {
-				MyLocale.setSIPOff();
-				if (chD.isAddiWpt()) { 
-					hintLP.setText(chD.mainCache.getCacheDetails(true));
-				} else {
-					hintLP.setText(chD);
-				}
+			MyLocale.setSIPOff();
+			if (ch.isAddiWpt()) { 
+				hintLP.setText(ch.mainCache.getCacheDetails(true));
+			} else {
+				hintLP.setText(chD);
 			}
 			break;
 		case 5:  // Solver Panel
 			MyLocale.setSIPOff();
-			if (chD!=null) {
-				if (chD.isAddiWpt()) { 
-					chMain=chD.mainCache.getCacheDetails(true);//new CacheHolderDetail(chD.mainCache);
-/*					try {
-						chMain.readCache(profile.dataDir); //Vm.debug(&quot;mainT:readCache &quot;+chD.wayPoint+&quot;=&gt;Main=&gt;&quot;+chMain.wayPoint+&quot;/S:&quot;+chMain.Solver);
-					} catch(Exception e){pref.log(&quot;Error reading cache .xml&quot;,e);}
-*/					solverP.setInstructions(chMain.Solver);
-				} else {
-					//Vm.debug(&quot;mainT: Waypoint:&quot;+chD.wayPoint);
-					solverP.setInstructions(chD.Solver);
-				}
+			if (ch.isAddiWpt()) { 
+				solverP.setInstructions(ch.mainCache.getFreshDetails().Solver);
+			} else {
+				solverP.setInstructions(chD.Solver);
 			}
 			break;
 		case 6:  // CalcPanel
-			if (chD!=null) {
-				MyLocale.setSIPOff();
-				calcP.setFields(chD);
-			}
+			MyLocale.setSIPOff();
+			calcP.setFields(ch);
 			break;
 		case 7: // GotoPanel
 			MyLocale.setSIPOff();
 			break;
 		case 8:  // Cache Radar Panel
 			MyLocale.setSIPOff();
-			radarP.setParam(pref, cacheDB, chD==null?&quot;&quot;:chD.getWayPoint());
+			radarP.setParam(pref, cacheDB, ch.getWayPoint());
 			radarP.drawThePanel();
 			break;
 		}
@@ -316,7 +298,6 @@
 				mainCache = selectedCache.mainCache.getWayPoint();
 			}			
 		}
-		detP.setNeedsTableUpdate(true);
 		if (CacheType.isAddiWpt(ch.getType()) &amp;&amp; mainCache!=null &amp;&amp; mainCache.length()&gt;2) {
 			ch.setWayPoint(profile.getNewAddiWayPointName(mainCache));
 			profile.setAddiRef(ch);
@@ -335,6 +316,7 @@
 		oldCard=1;
 		if (this.cardPanel.selectedItem != 1) select(detP);
 		solverP.setInstructions(&quot;&quot;);
+		detP.setNeedsTableUpdate(true);
 		//tbP.refreshTable(); // moved this instruction to onLeavingPanel
 
 	}
@@ -385,7 +367,7 @@
 	void updatePendingChanges() {
 		if (cacheDirty) {
 			if (chD != null)
-				chD.saveCacheDetails(Global.getProfile().dataDir);
+				chD.getParent().save();
 			cacheDirty = false;
 		}
 	}

Modified: trunk/src/CacheWolf/NewProfileWizard.java
===================================================================
--- trunk/src/CacheWolf/NewProfileWizard.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/NewProfileWizard.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -23,6 +23,7 @@
 				profile.setCenterCoords(cs.getCoords());
 			}
 			Global.mainForm.setTitle(&quot;Cachewolf &quot;+Version.getRelease()+&quot; - &quot;+profile.name);
+			profile.notifyUnsavedChanges(true);
 		}
 		f.close(0);
 		return (code == 0);

Modified: trunk/src/CacheWolf/NotesScreen.java
===================================================================
--- trunk/src/CacheWolf/NotesScreen.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/NotesScreen.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -9,7 +9,7 @@
 */
 public class NotesScreen extends Form{
 	mTextPad wayNotes = new mTextPad();
-	CacheHolderDetail thisCache = null;
+	CacheHolderDetail chD = null;
 	mButton addDateTime;
 	mButton btSave = new mButton(MyLocale.getMsg(127,&quot;Save&quot;));
 	mButton cancelBtn = new mButton(&quot;Cancel&quot;);
@@ -24,8 +24,8 @@
 		this.title = &quot;Notes&quot;;
 		setPreferredSize(Global.getPref().myAppWidth, Global.getPref().myAppHeight);
 		this.resizeOnSIP = true;
-		thisCache = ch;
-		wayNotes.setText(thisCache.CacheNotes);
+		chD = ch;
+		wayNotes.setText(chD.CacheNotes);
 		addLast(sbp.setTag(CellConstants.SPAN, new Dimension(3,1)),CellConstants.STRETCH, (CellConstants.FILL|CellConstants.WEST));
 		titleControls=new CellPanel();
 		titleControls.addNext(addDateTime,CellConstants.HSTRETCH,CellConstants.HFILL);
@@ -46,12 +46,12 @@
 				wayNotes.setText(note);
 			}
 			if(ev.target == btSave){
-				thisCache.CacheNotes = wayNotes.getText();
-				thisCache.saveCacheDetails( Global.getProfile().dataDir);
+				chD.CacheNotes = wayNotes.getText();
+				chD.getParent().save();
 				this.close(0);
 			}
 			if(ev.target == cancelBtn){
-				if ( (!thisCache.CacheNotes.equals(wayNotes.getText())) ) {
+				if ( (!chD.CacheNotes.equals(wayNotes.getText())) ) {
 					if ( (new MessageBox(&quot;Warning&quot;, &quot;You will loose any changes made to the notes. Do you want to continue?&quot;
 							, FormBase.YESB|FormBase.NOB)).execute() == FormBase.IDYES) {
 						this.close(0);
@@ -59,11 +59,11 @@
 				} else this.close(0); // no changes -&gt; exit without asking
 			} 
 			if(ev.target == titleOK){
-				if ( (!thisCache.CacheNotes.equals(wayNotes.getText())) ) {
+				if ( (!chD.CacheNotes.equals(wayNotes.getText())) ) {
 					if ( (new MessageBox(&quot;Warning&quot;, &quot;Save changes made to the notes?&quot;
 							, FormBase.YESB|FormBase.NOB)).execute() == FormBase.IDYES) {
-						thisCache.CacheNotes = wayNotes.getText();
-						thisCache.saveCacheDetails( Global.getProfile().dataDir);
+						chD.CacheNotes = wayNotes.getText();
+						chD.getParent().save();
 					}
 				}
 			}

Modified: trunk/src/CacheWolf/OCXMLImporter.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/OCXMLImporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -37,7 +37,7 @@
 	CacheDB cacheDB;
 	InfoBox inf;
 	CacheHolder ch;
-	CacheHolderDetail chD;
+	CacheHolder holder;
 	Preferences pref;
 	Profile profile;
 	Time dateOfthisSync;
@@ -91,7 +91,7 @@
 	 */
 	public boolean syncSingle(int number, InfoBox infB) {
 		ch = cacheDB.get(number);
-		chD= null; //new CacheHolderDetail(ch); //TODO is this still correct? use getDetails ?
+		holder= null; //new CacheHolderDetail(ch); //TODO is this still correct? use getDetails ?
 
 		if (infB.isClosed) {
 			if (askForOptions) return false; 
@@ -226,7 +226,7 @@
 		
 		picCnt = 0;
 		try{
-			chD = null;
+			holder = null;
 			file = fetch(url, &quot;dummy&quot;);
 
 			//parse
@@ -263,15 +263,15 @@
 				success = false;
 			}
 		}catch (IllegalArgumentException e) {
-			finalMessage = MyLocale.getMsg(1621,&quot;Error parsing update file\n this is likely a bug in opencaching.de\nplease try again later\n, state:&quot;)+&quot; &quot;+state+&quot;, waypoint: &quot;+ chD.getWayPoint();
+			finalMessage = MyLocale.getMsg(1621,&quot;Error parsing update file\n this is likely a bug in opencaching.de\nplease try again later\n, state:&quot;)+&quot; &quot;+state+&quot;, waypoint: &quot;+ holder.getWayPoint();
 			success = false;
-			Vm.debug(&quot;Parse error: &quot; + state + &quot; &quot; + chD.getWayPoint());
+			Vm.debug(&quot;Parse error: &quot; + state + &quot; &quot; + holder.getWayPoint());
 			e.printStackTrace();
 		}catch (Exception e){ // here should be used the correct exception
-			if (chD != null)	finalMessage = MyLocale.getMsg(1615,&quot;Error parsing update file, state:&quot;)+&quot; &quot;+state+&quot;, waypoint: &quot;+ chD.getWayPoint();
+			if (holder != null)	finalMessage = MyLocale.getMsg(1615,&quot;Error parsing update file, state:&quot;)+&quot; &quot;+state+&quot;, waypoint: &quot;+ holder.getWayPoint();
 			else finalMessage = MyLocale.getMsg(1615,&quot;Error parsing update file, state:&quot;)+&quot; &quot;+state+&quot;, waypoint: &lt;unkown&gt;&quot;;
 			success = false;
-			Vm.debug(&quot;Parse error: &quot; + state + &quot; Exception:&quot; + e.toString()+&quot;   &quot;+chD.getOcCacheID());
+			Vm.debug(&quot;Parse error: &quot; + state + &quot; Exception:&quot; + e.toString()+&quot;   &quot;+holder.getOcCacheID());
 			e.printStackTrace();
 		} finally {
 			if (tmpFile != null) tmpFile.delete();
@@ -354,27 +354,27 @@
 			cacheID = atts.getValue(&quot;id&quot;);
 		}
 		if(name.equals(&quot;type&quot;)){
-			chD.setType(CacheType.transOCType(new Integer(atts.getValue(&quot;id&quot;)).intValue())); 
+			holder.setType(CacheType.transOCType(new Integer(atts.getValue(&quot;id&quot;)).intValue())); 
 			return;
 		}
 		if(name.equals(&quot;status&quot;)){
-			if(atts.getValue(&quot;id&quot;).equals(&quot;1&quot;)) chD.setAvailable(true);
-			if(atts.getValue(&quot;id&quot;).equals(&quot;2&quot;)) chD.setAvailable(false);
+			if(atts.getValue(&quot;id&quot;).equals(&quot;1&quot;)) holder.setAvailable(true);
+			if(atts.getValue(&quot;id&quot;).equals(&quot;2&quot;)) holder.setAvailable(false);
 			if(atts.getValue(&quot;id&quot;).equals(&quot;3&quot;)) {
-				chD.setArchived(true);
-				chD.setAvailable(false);
+				holder.setArchived(true);
+				holder.setAvailable(false);
 			}
-			if(atts.getValue(&quot;id&quot;).equals(&quot;4&quot;)) chD.setAvailable(false);
+			if(atts.getValue(&quot;id&quot;).equals(&quot;4&quot;)) holder.setAvailable(false);
 			return;
 		}
 		if(name.equals(&quot;size&quot;)){
-			chD.setCacheSize(transSize(atts.getValue(&quot;id&quot;)));
+			holder.setCacheSize(transSize(atts.getValue(&quot;id&quot;)));
 			return;
 		}
 
 		if(name.equals(&quot;waypoints&quot;)){
-			chD.setWayPoint(atts.getValue(&quot;oc&quot;));
-			if (chD.getWayPoint().length()==0) throw new IllegalArgumentException(&quot;empty waypointname&quot;); // this should not happen - it is likey a bug in opencaching.de / it happens on 27-12-2006 on cache OC143E
+			holder.setWayPoint(atts.getValue(&quot;oc&quot;));
+			if (holder.getWayPoint().length()==0) throw new IllegalArgumentException(&quot;empty waypointname&quot;); // this should not happen - it is likey a bug in opencaching.de / it happens on 27-12-2006 on cache OC143E
 			return;
 		}
 
@@ -386,11 +386,11 @@
 		}
 
 		if (name.equals(&quot;desc&quot;)){
-			chD.setHTML(atts.getValue(&quot;html&quot;).equals(&quot;1&quot;)?true:false);
+			holder.setHTML(atts.getValue(&quot;html&quot;).equals(&quot;1&quot;)?true:false);
 		}
 
 		if (name.equals(&quot;language&quot;) &amp;&amp; !atts.getValue(&quot;id&quot;).equals(&quot;DE&quot;)){
-			if (chD.LongDescription.length()&gt; 0) ignoreDesc = true; // TODO &quot;DE&quot; in preferences adjustable
+			if (holder.getFreshDetails().LongDescription.length()&gt; 0) ignoreDesc = true; // TODO &quot;DE&quot; in preferences adjustable
 			else ignoreDesc = false;
 		}
 	}
@@ -410,7 +410,7 @@
 				logIcon = GPXImporter.typeText2Image(&quot;Found&quot;);
 				break;
 			case 2:	logIcon = GPXImporter.typeText2Image(&quot;Not Found&quot;); 
-			chD.setNoFindLogs(chD.getNoFindLogs()+1);
+			holder.setNoFindLogs(holder.getNoFindLogs()+1);
 			break;
 			case 3: logIcon = GPXImporter.typeText2Image(&quot;Note&quot;);
 			}
@@ -423,55 +423,53 @@
 		}
 	}
 
+	// TODO Do we have to release the &quot;holder&quot; cache details ?
 	private void endCache(String name){
 		if (name.equals(&quot;cache&quot;)){
-			chD.setLastSyncOC(dateOfthisSync.format(&quot;yyyyMMddHHmmss&quot;));
+			holder.setLastSyncOC(dateOfthisSync.format(&quot;yyyyMMddHHmmss&quot;));
 			int index;
-			index = cacheDB.getIndex(chD.getWayPoint());
+			index = cacheDB.getIndex(holder.getWayPoint());
 			if (index == -1){
-				chD.setNew(true);
-				CacheHolder ch = new CacheHolder(chD);
-				ch.details = chD;
-				cacheDB.add(ch);
-				ch.detailsAdded();
+				holder.setNew(true);
+				cacheDB.add(holder);
 				Integer indexInt = new Integer(cacheDB.size()-1);
-				DBindexID.put(chD.getOcCacheID(), indexInt);
+				DBindexID.put(holder.getOcCacheID(), indexInt);
 			}
 			// update (overwrite) data
 			else {
-				chD.setNew(false);
-				cacheDB.set(index, new CacheHolder(chD));
+				holder.setNew(false);
+				cacheDB.get(index).update(holder);
 				// save ocCacheID, in case, the previous data is from GPX
-				DBindexID.put(chD.getOcCacheID(), new Integer(index));
+				DBindexID.put(holder.getOcCacheID(), new Integer(index));
 			}
 			// clear data (picture, logs) if we do a complete Update
 			if (incUpdate == false){
-				chD.CacheLogs.clear();
-				chD.Images.clear();
-				chD.ImagesText.clear();
-				chD.ImagesInfo.clear();
+				holder.getFreshDetails().CacheLogs.clear();
+				holder.getFreshDetails().Images.clear();
+				holder.getFreshDetails().ImagesText.clear();
+				holder.getFreshDetails().ImagesInfo.clear();
 			}
 
 			// save all
-			chD.hasUnsavedChanges = true; // this makes CachHolder save the details in case that they are unloaded from memory
+			holder.getFreshDetails().hasUnsavedChanges = true; // this makes CachHolder save the details in case that they are unloaded from memory
 			// chD.saveCacheDetails(profile.dataDir); 
 			// profile.saveIndex(pref,Profile.NO_SHOW_PROGRESS_BAR); // this is done after .xml is completly processed
 			return;
 		}
 		if(name.equals(&quot;id&quot;)){ // &lt;/id&gt;
-			chD = getHolder(strData); // Allocate a new CacheHolder object
-			chD.setOcCacheID(strData);
-			chD.URL = ocSeekUrl + cacheID;
+			holder = getHolder(strData); // Allocate a new CacheHolder object
+			holder.setOcCacheID(strData);
+			holder.getFreshDetails().URL = ocSeekUrl + cacheID;
 			return;
 		}
 
 		if(name.equals(&quot;name&quot;)){
-			chD.setCacheName(strData);
+			holder.setCacheName(strData);
 			return;
 		}
 		if(name.equals(&quot;userid&quot;)) {
-			chD.setCacheOwner(strData);
-			if(chD.getCacheOwner().equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; chD.getCacheOwner().equalsIgnoreCase(pref.myAlias2))) chD.setOwned(true);
+			holder.setCacheOwner(strData);
+			if(holder.getCacheOwner().equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; holder.getCacheOwner().equalsIgnoreCase(pref.myAlias2))) holder.setOwned(true);
 			return;
 		}
 
@@ -480,24 +478,24 @@
 			return;
 		}
 		if(name.equals(&quot;latitude&quot;)) {
-			chD.pos.set(Common.parseDouble(strData),longitude);
-			chD.LatLon = chD.pos.toString();
+			holder.pos.set(Common.parseDouble(strData),longitude);
+			holder.LatLon = holder.pos.toString();
 			return;
 		}
 		if(name.equals(&quot;difficulty&quot;)) {
-			chD.setHard(strData);
+			holder.setHard(strData);
 			return;
 		}
 		if(name.equals(&quot;terrain&quot;)) {
-			chD.setTerrain(strData);
+			holder.setTerrain(strData);
 			return;
 		}
 		if(name.equals(&quot;datehidden&quot;)) {
-			chD.setDateHidden(strData.substring(0,10)); //Date;
+			holder.setDateHidden(strData.substring(0,10)); //Date;
 			return;
 		}
 		if (name.equals(&quot;country&quot;)){
-			chD.Country = strData;
+			holder.getFreshDetails().Country = strData;
 			return;
 		}
 	}
@@ -506,7 +504,7 @@
 
 		if (!ignoreDesc){
 			if (name.equals(&quot;cachedesc&quot;)){
-				if (pref.downloadPicsOC &amp;&amp; chD.is_HTML()) {
+				if (pref.downloadPicsOC &amp;&amp; holder.is_HTML()) {
 					String fetchUrl, imgTag, imgAltText;
 					Regex imgRegexUrl = new Regex(&quot;(&lt;img[^&gt;]*src=[\&quot;\']([^&gt;^\&quot;^\']*)[^&gt;]*&gt;|&lt;img[^&gt;]*src=([^&gt;^\&quot;^\'^ ]*)[^&gt;]*&gt;)&quot;); //  Ergebnis enth&#228;lt keine Anf&#252;hrungszeichen
 					Regex imgRegexAlt = new Regex(&quot;(?:alt=[\&quot;\']([^&gt;^\&quot;^\']*)|alt=([^&gt;^\&quot;^\'^ ]*))&quot;); // get alternative text for Pic
@@ -514,12 +512,12 @@
 					imgRegexUrl.setIgnoreCase(true);
 					int descIndex=0;
 					int numDownloaded=1;
-					while (imgRegexUrl.searchFrom(chD.LongDescription, descIndex)) { // &quot;img&quot; found
+					while (imgRegexUrl.searchFrom(holder.getFreshDetails().LongDescription, descIndex)) { // &quot;img&quot; found
 						imgTag=imgRegexUrl.stringMatched(1); // (1) enth&#228;lt das gesamte &lt;img ...&gt;-tag
 						fetchUrl=imgRegexUrl.stringMatched(2); // URL in Anf&#252;hrungszeichen in (2) falls ohne in (3) Ergebnis ist auf jeden Fall ohne Anf&#252;hrungszeichen 
 						if (fetchUrl==null) { fetchUrl=imgRegexUrl.stringMatched(3); }
 						if (fetchUrl==null) { // TODO Fehler ausgeben: nicht abgedeckt ist der Fall, dass in einem Cache Links auf Bilder mit unterschiedlichen URL, aber gleichem Dateinamen sind.
-							inf.addWarning(MyLocale.getMsg(1617, &quot;Ignoriere Fehler in html-Cache-Description: \&quot;&lt;img\&quot; without \&quot;src=\&quot; in cache &quot;+chD.getWayPoint()));
+							inf.addWarning(MyLocale.getMsg(1617, &quot;Ignoriere Fehler in html-Cache-Description: \&quot;&lt;img\&quot; without \&quot;src=\&quot; in cache &quot;+holder.getWayPoint()));
 							continue;
 						}
 						inf.setInfo(MyLocale.getMsg(1611,&quot;Importing cache description:&quot;)+&quot; &quot; + numDescImported + &quot;\n&quot;+MyLocale.getMsg(1620, &quot;downloading embedded images: &quot;) + numDownloaded++);
@@ -536,37 +534,37 @@
 						getPic(fetchUrl, imgAltText);
 					}
 				}
-				chD.hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
+				holder.getFreshDetails().hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
 				return;
 			}
 
 
 			if (name.equals(&quot;cacheid&quot;)){
 				// load cachedata
-				chD = getHolder(strData);
-				chD.setUpdated(true);
+				holder = getHolder(strData);
+				holder.setUpdated(true);
 				return;
 			}
 
 			if (name.equals(&quot;shortdesc&quot;)){
-				chD.LongDescription = strData;
+				holder.getFreshDetails().LongDescription = strData;
 				return;
 			}
 
 			if (name.equals(&quot;desc&quot;)){ // &lt;/desc&gt;
-				if (chD.is_HTML())	chD.LongDescription +=SafeXML.cleanback(strData);
-				else chD.LongDescription +=strData;
+				if (holder.is_HTML())	holder.getFreshDetails().LongDescription +=SafeXML.cleanback(strData);
+				else holder.getFreshDetails().LongDescription +=strData;
 				return;
 			}
 			if (name.equals(&quot;hint&quot;)){
-				chD.Hints = Common.rot13(strData);
+				holder.getFreshDetails().Hints = Common.rot13(strData);
 				return;
 			}
 		}
 	}
 
 	private String createPicFilename(String fetchURL) {
-		String fileName = chD.getWayPoint() + &quot;_&quot; + fetchURL.substring(fetchURL.lastIndexOf(&quot;/&quot;)+1);
+		String fileName = holder.getWayPoint() + &quot;_&quot; + fetchURL.substring(fetchURL.lastIndexOf(&quot;/&quot;)+1);
 		return Common.ClearForFileName(fileName);
 	}
 	
@@ -575,23 +573,23 @@
 			if (!fetchURL.startsWith(&quot;<A HREF="http://">http://</A>&quot;)) fetchURL = new URL(new URL(&quot;<A HREF="http://">http://</A>&quot; + OPENCACHING_HOST+&quot;/&quot;), fetchURL).toString(); // TODO this is not quite correct: actually the &quot;base&quot; URL must be known... but anyway a different baseURL should not happen very often  - it doesn't in my area
 			String fileName = createPicFilename(fetchURL);
 			// add title
-			chD.ImagesText.add(picDesc);
-			chD.ImagesInfo.add(null); // need to stay in sync with ImagesText
+			holder.getFreshDetails().ImagesText.add(picDesc);
+			holder.getFreshDetails().ImagesInfo.add(null); // need to stay in sync with ImagesText
 			try {
 				File ftest = new File(profile.dataDir + fileName);
 				if (ftest.exists()){
-					chD.Images.add(fileName);
+					holder.getFreshDetails().Images.add(fileName);
 				}
 				else {
 					if (pref.downloadPicsOC) {
-						chD.Images.add(fetch(fetchURL, fileName));
+						holder.getFreshDetails().Images.add(fetch(fetchURL, fileName));
 					}
 				}
 			} catch (IOException e) {
-				String ErrMessage = new String (MyLocale.getMsg(1618,&quot;Ignoring error in cache: &quot;) + chD.getWayPoint() + &quot;: ignoring IOException: &quot;+e.getMessage()+ &quot; while downloading picture:&quot;+fileName+&quot; from URL:&quot;+fetchURL); 
+				String ErrMessage = new String (MyLocale.getMsg(1618,&quot;Ignoring error in cache: &quot;) + holder.getWayPoint() + &quot;: ignoring IOException: &quot;+e.getMessage()+ &quot; while downloading picture:&quot;+fileName+&quot; from URL:&quot;+fetchURL); 
 				if (e.getMessage().toLowerCase().equalsIgnoreCase(&quot;could not connect&quot;) ||
 						e.getMessage().equalsIgnoreCase(&quot;unkown host&quot;)) { // is there a better way to find out what happened?
-					ErrMessage = MyLocale.getMsg(1618,&quot;Ignoring error in cache: &quot;)+chD.getCacheName() + &quot; (&quot;+chD.getWayPoint()+&quot;)&quot;+MyLocale.getMsg(1619,&quot;: could not download image from URL: &quot;)+fetchURL;
+					ErrMessage = MyLocale.getMsg(1618,&quot;Ignoring error in cache: &quot;)+holder.getCacheName() + &quot; (&quot;+holder.getWayPoint()+&quot;)&quot;+MyLocale.getMsg(1619,&quot;: could not download image from URL: &quot;)+fetchURL;
 				} 
 				inf.addWarning(&quot;\n&quot;+ErrMessage);
 				//(new MessageBox(MyLocale.getMsg(144, &quot;Warning&quot;), ErrMessage, MessageBox.OKB)).exec();
@@ -599,7 +597,7 @@
 				e.printStackTrace();
 			}
 		} catch (MalformedURLException e) {
-			String ErrMessage = new String (MyLocale.getMsg(1618,&quot;Ignoring error in cache: &quot;) + chD.getWayPoint() + &quot;: ignoring MalformedUrlException: &quot; + e.getMessage()+ &quot; while downloading from URL:&quot; + fetchURL); 
+			String ErrMessage = new String (MyLocale.getMsg(1618,&quot;Ignoring error in cache: &quot;) + holder.getWayPoint() + &quot;: ignoring MalformedUrlException: &quot; + e.getMessage()+ &quot; while downloading from URL:&quot; + fetchURL); 
 			inf.addWarning(&quot;\n&quot;+ErrMessage);
 			pref.log(ErrMessage);
 		}
@@ -624,33 +622,33 @@
 		}
 		if(name.equals(&quot;object&quot;)){
 			// get cachedata
-			chD = getHolder(strData);
+			holder = getHolder(strData);
 			return;
 		}
 		if(name.equals(&quot;picture&quot;)){ 
 			//String fileName = holder.wayPoint + &quot;_&quot; + picUrl.substring(picUrl.lastIndexOf(&quot;/&quot;)+1);
 			getPic(picUrl,picTitle);
-			chD.hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
+			holder.getFreshDetails().hasUnsavedChanges = true; //saveCacheDetails(profile.dataDir);
 			return;
 		}
 	}
 
 	private void endCacheLog(String name){
 		if (name.equals(&quot;cachelog&quot;)){ // &lt;/cachelog&gt;
-			chD.CacheLogs.merge(new Log(logIcon, logDate, logFinder, logData, loggerRecommended));
+			holder.getFreshDetails().CacheLogs.merge(new Log(logIcon, logDate, logFinder, logData, loggerRecommended));
 			if((logFinder.toLowerCase().compareTo(user) == 0 || logFinder.equalsIgnoreCase(pref.myAlias2)) &amp;&amp; logtype == 1) {
-						chD.setCacheStatus(logDate);
-						chD.setFound(true);
-						chD.OwnLogId = logId;
-						chD.OwnLog = new Log(logIcon, logDate, logFinder, logData, loggerRecommended);
+						holder.setCacheStatus(logDate);
+						holder.setFound(true);
+						holder.getFreshDetails().OwnLogId = logId;
+						holder.getFreshDetails().OwnLog = new Log(logIcon, logDate, logFinder, logData, loggerRecommended);
 			}
-			chD.hasUnsavedChanges = true; //chD.saveCacheDetails(profile.dataDir);
+			holder.getFreshDetails().hasUnsavedChanges = true; //chD.saveCacheDetails(profile.dataDir);
 			return;
 		}
 
 		if (name.equals(&quot;cacheid&quot;)){ // &lt;/cacheid&gt;
 			// load cachedata
-			chD = getHolder(strData);
+			holder = getHolder(strData);
 			return;
 		}
 
@@ -675,7 +673,7 @@
 		CharArray realurl = new CharArray();
 		ByteArray daten = UrlFetcher.fetchByteArray(addr, realurl);
 		String address = realurl.toString();
-		if (chD != null) fileName = chD.getWayPoint() + &quot;_&quot; + Common.ClearForFileName(address.substring(address.lastIndexOf(&quot;/&quot;)+1));
+		if (holder != null) fileName = holder.getWayPoint() + &quot;_&quot; + Common.ClearForFileName(address.substring(address.lastIndexOf(&quot;/&quot;)+1));
 		// else fileName = Common.ClearForFileName(address.substring(address.lastIndexOf(&quot;/&quot;)+1));
 
 		//save file
@@ -723,21 +721,18 @@
 	}
 
 
-	private CacheHolderDetail getHolder(String wpt){// See also LOCXMLImporter
+	private CacheHolder getHolder(String wpt){// See also LOCXMLImporter
+		CacheHolder chx;
 		int index;
 		
 		index = cacheDB.getIndex(wpt);
-		if (index ==-1) index = searchID(wpt);
+		if (index == -1) index = searchID(wpt);
 		if (index == -1) {
-			chD = new CacheHolderDetail();
-			return chD;
+			chx = new CacheHolder();
+		} else {
+			chx = cacheDB.get(index);
 		}
-		chD = cacheDB.get(index).getCacheDetails(true);
-/*		try {
-			chD.readCache(profile.dataDir);
-		} catch (Exception e) {Vm.debug(&quot;Could not open file: &quot; + e.toString());};
-	*/	return chD;
+		return chx;
 	}
 
-
 }

Modified: trunk/src/CacheWolf/Parser.java
===================================================================
--- trunk/src/CacheWolf/Parser.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/Parser.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -730,12 +730,8 @@
 					op.append(addiWpt.getCacheName());
 					op.append(&quot;] = \&quot; $&quot;);
 					op.append(addiWpt.getWayPoint());
-					CacheHolderDetail chD=new CacheHolderDetail(addiWpt);
-					try {
-						chD.readCache(Global.getProfile().dataDir);
-					} catch( Exception ex) {};
-					if (chD.LongDescription.trim().length()&gt;0)
-						op.append(&quot;\n   \&quot;&quot;+STRreplace.replace(chD.LongDescription,&quot;\&quot;&quot;,&quot;\&quot;\&quot;&quot;)+&quot;\&quot;&quot;);
+					if (addiWpt.getExistingDetails().LongDescription.trim().length()&gt;0)
+						op.append(&quot;\n   \&quot;&quot;+STRreplace.replace(addiWpt.getExistingDetails().LongDescription,&quot;\&quot;&quot;,&quot;\&quot;\&quot;&quot;)+&quot;\&quot;&quot;);
 					op.append(&quot;\n   goto($&quot;);
 					op.append(addiWpt.getWayPoint());
 					op.append(&quot;); STOP\nENDIF\n\n&quot;);

Modified: trunk/src/CacheWolf/Profile.java
===================================================================
--- trunk/src/CacheWolf/Profile.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/Profile.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -519,7 +519,7 @@
 				if (mainCh != null) {
 					mainCh.addiWpts.add(ch);
 					ch.mainCache = mainCh;
-					ch.setAttributesFromMainCache(mainCh);
+					ch.setAttributesFromMainCache();
 				}// if
 			}// if
 		}// for

Modified: trunk/src/CacheWolf/SearchCache.java
===================================================================
--- trunk/src/CacheWolf/SearchCache.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/SearchCache.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -35,7 +35,8 @@
 				if (ch.is_filtered()) break; // Reached end of visible records
 				if(ch.getWayPoint().toUpperCase().indexOf(searchStr) &lt;0 &amp;&amp; 
 				   ch.getCacheName().toUpperCase().indexOf(searchStr) &lt;0 &amp;&amp; 
-				   ch.getCacheStatus().toUpperCase().indexOf(searchStr)&lt;0){
+				   ch.getCacheStatus().toUpperCase().indexOf(searchStr)&lt;0 /*&amp;&amp;
+				   ch.getExistingDetails().LongDescription.toUpperCase().indexOf(searchStr)&lt;0*/){
 					ch.is_flaged = false;
 					ch.setFiltered(true);
 				} else

Modified: trunk/src/CacheWolf/ShowCacheInBrowser.java
===================================================================
--- trunk/src/CacheWolf/ShowCacheInBrowser.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/ShowCacheInBrowser.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -59,7 +59,7 @@
 		}
 	}
 	
-	public void showCache(CacheHolderDetail chD) {
+	public void showCache(CacheHolder chD) {
 		if (chD == null) return;
 		try {
 			Template tpl = new Template(args);
@@ -92,39 +92,39 @@
 						tpl.setParam(&quot;STATUS&quot;, chD.getCacheStatus());
 					
 					// Cache attributes
-					if (chD.attributes.getCount()&gt;0) {
-						Vector attVect=new Vector(chD.attributes.getCount()+1);
-						for (int i=0; i&lt;chD.attributes.getCount(); i++) {
+					if (chD.getExistingDetails().attributes.getCount()&gt;0) {
+						Vector attVect=new Vector(chD.getExistingDetails().attributes.getCount()+1);
+						for (int i=0; i&lt;chD.getExistingDetails().attributes.getCount(); i++) {
 							Hashtable atts=new Hashtable();
 							atts.put(&quot;IMAGE&quot;,&quot;&lt;img src=\&quot;<A HREF="file://">file://</A>&quot;+
-									   Attribute.getImageDir()+chD.attributes.getName(i)+
-									   &quot;\&quot; border=0 alt=\&quot;&quot;+chD.attributes.getInfo(i)+&quot;\&quot;&gt;&quot;);
+									   Attribute.getImageDir()+chD.getExistingDetails().attributes.getName(i)+
+									   &quot;\&quot; border=0 alt=\&quot;&quot;+chD.getExistingDetails().attributes.getInfo(i)+&quot;\&quot;&gt;&quot;);
 							if (i % 5 ==4) 
 								atts.put(&quot;BR&quot;,&quot;&lt;br/&gt;&quot;);
 							else
 								atts.put(&quot;BR&quot;,&quot;&quot;);
-							atts.put(&quot;INFO&quot;,chD.attributes.getInfo(i));
+							atts.put(&quot;INFO&quot;,chD.getExistingDetails().attributes.getInfo(i));
 							attVect.add(atts);
 						}
 						tpl.setParam(&quot;ATTRIBUTES&quot;,attVect);
 					}
 					
 					tpl.setParam(&quot;DATE&quot;, chD.getDateHidden());
-					tpl.setParam(&quot;URL&quot;, chD.URL);
-					if (chD.Travelbugs.size()&gt;0) tpl.setParam(&quot;BUGS&quot;,chD.Travelbugs.toHtml());
-					if (chD.CacheNotes!=null &amp;&amp; chD.CacheNotes.trim().length()&gt;0) tpl.setParam(&quot;NOTES&quot;, STRreplace.replace(chD.CacheNotes,&quot;\n&quot;,&quot;&lt;br/&gt;\n&quot;));
-					if (chD.Solver!=null &amp;&amp; chD.Solver.trim().length()&gt;0) tpl.setParam(&quot;SOLVER&quot;, STRreplace.replace(chD.Solver,&quot;\n&quot;,&quot;&lt;br/&gt;\n&quot;));
+					tpl.setParam(&quot;URL&quot;, chD.getExistingDetails().URL);
+					if (chD.getExistingDetails().Travelbugs.size()&gt;0) tpl.setParam(&quot;BUGS&quot;,chD.getExistingDetails().Travelbugs.toHtml());
+					if (chD.getExistingDetails().CacheNotes!=null &amp;&amp; chD.getExistingDetails().CacheNotes.trim().length()&gt;0) tpl.setParam(&quot;NOTES&quot;, STRreplace.replace(chD.getExistingDetails().CacheNotes,&quot;\n&quot;,&quot;&lt;br/&gt;\n&quot;));
+					if (chD.getExistingDetails().Solver!=null &amp;&amp; chD.getExistingDetails().Solver.trim().length()&gt;0) tpl.setParam(&quot;SOLVER&quot;, STRreplace.replace(chD.getExistingDetails().Solver,&quot;\n&quot;,&quot;&lt;br/&gt;\n&quot;));
 					// Look for images
 					
-					StringBuffer s=new StringBuffer(chD.LongDescription.length());
+					StringBuffer s=new StringBuffer(chD.getExistingDetails().LongDescription.length());
 					int start=0;
 					int pos;
 					int imageNo=0;
 					Regex imgRex = new Regex(&quot;src=(?:\\s*[^\&quot;|']*?)(?:\&quot;|')(.*?)(?:\&quot;|')&quot;);
-					while (start&gt;=0 &amp;&amp; (pos=chD.LongDescription.indexOf(&quot;&lt;img&quot;,start))&gt;0) {
-						if (imageNo &gt;= chD.Images.getCount())break;
-						s.append(chD.LongDescription.substring(start,pos));
-						imgRex.searchFrom(chD.LongDescription,pos);
+					while (start&gt;=0 &amp;&amp; (pos=chD.getExistingDetails().LongDescription.indexOf(&quot;&lt;img&quot;,start))&gt;0) {
+						if (imageNo &gt;= chD.getExistingDetails().Images.getCount())break;
+						s.append(chD.getExistingDetails().LongDescription.substring(start,pos));
+						imgRex.searchFrom(chD.getExistingDetails().LongDescription,pos);
 						String imgUrl=imgRex.stringMatched(1);
 						//Vm.debug(&quot;imgUrl &quot;+imgUrl);
 						if (imgUrl.lastIndexOf('.')&gt;0 &amp;&amp; imgUrl.toLowerCase().startsWith(&quot;http&quot;)) {
@@ -132,27 +132,27 @@
 							// If we have an image which we stored when spidering, we can display it
         					if(imgType.startsWith(&quot;.png&quot;) || imgType.startsWith(&quot;.jpg&quot;) || imgType.startsWith(&quot;.gif&quot;)){
 								s.append(&quot;&lt;img src=\&quot;<A HREF="file://">file://</A>&quot;+
-								   Global.getProfile().dataDir+chD.Images.get(imageNo)+&quot;\&quot;&gt;&quot;);
+								   Global.getProfile().dataDir+chD.getExistingDetails().Images.get(imageNo)+&quot;\&quot;&gt;&quot;);
 								imageNo++;
 							}
 						}
-						start=chD.LongDescription.indexOf(&quot;&gt;&quot;,pos);
+						start=chD.getExistingDetails().LongDescription.indexOf(&quot;&gt;&quot;,pos);
 						if (start&gt;=0) start++;
 					}
-					if (start&gt;=0) s.append(chD.LongDescription.substring(start));
+					if (start&gt;=0) s.append(chD.getExistingDetails().LongDescription.substring(start));
 					tpl.setParam(&quot;DESCRIPTION&quot;, s.toString());
 					
 					// Do the remaining pictures which are not included in main body of text
 					// They will be hidden initially and can be displayed by clicking on a link
-					if (imageNo&lt;chD.Images.size()) {
-						Vector imageVect=new Vector(chD.Images.size()-imageNo);
-						for (; imageNo&lt;chD.Images.size(); imageNo++) {
+					if (imageNo&lt;chD.getExistingDetails().Images.size()) {
+						Vector imageVect=new Vector(chD.getExistingDetails().Images.size()-imageNo);
+						for (; imageNo&lt;chD.getExistingDetails().Images.size(); imageNo++) {
 							Hashtable imgs=new Hashtable();
 							imgs.put(&quot;IMAGE&quot;,&quot;&lt;img src=\&quot;<A HREF="file://">file://</A>&quot;+
-									   Global.getProfile().dataDir+chD.Images.get(imageNo)+&quot;\&quot; border=0&gt;&quot;);
-							imgs.put(&quot;IMAGETEXT&quot;,chD.ImagesText.get(imageNo));
-							if (imageNo&lt;chD.ImagesInfo.size() &amp;&amp; chD.ImagesInfo.get(imageNo)!=null)
-								imgs.put(&quot;IMAGECOMMENT&quot;,chD.ImagesInfo.get(imageNo));
+									   Global.getProfile().dataDir+chD.getExistingDetails().Images.get(imageNo)+&quot;\&quot; border=0&gt;&quot;);
+							imgs.put(&quot;IMAGETEXT&quot;,chD.getExistingDetails().ImagesText.get(imageNo));
+							if (imageNo&lt;chD.getExistingDetails().ImagesInfo.size() &amp;&amp; chD.getExistingDetails().ImagesInfo.get(imageNo)!=null)
+								imgs.put(&quot;IMAGECOMMENT&quot;,chD.getExistingDetails().ImagesInfo.get(imageNo));
 							else
 								imgs.put(&quot;IMAGECOMMENT&quot;,&quot;&quot;);
 							imgs.put(&quot;I&quot;,&quot;'img&quot;+new Integer(imageNo).toString()+&quot;'&quot;);
@@ -161,10 +161,10 @@
 						tpl.setParam(&quot;IMAGES&quot;,imageVect);
 					}
 					
-					Vector logVect=new Vector(chD.CacheLogs.size());
-					for (int i=0; i&lt;chD.CacheLogs.size(); i++) {
+					Vector logVect=new Vector(chD.getExistingDetails().CacheLogs.size());
+					for (int i=0; i&lt;chD.getExistingDetails().CacheLogs.size(); i++) {
 						Hashtable logs=new Hashtable();
-						String log=STRreplace.replace(chD.CacheLogs.getLog(i).toHtml(),&quot;<A HREF="http://www.geocaching.com/images/icons/">http://www.geocaching.com/images/icons/</A>&quot;,&quot;&quot;);
+						String log=STRreplace.replace(chD.getExistingDetails().CacheLogs.getLog(i).toHtml(),&quot;<A HREF="http://www.geocaching.com/images/icons/">http://www.geocaching.com/images/icons/</A>&quot;,&quot;&quot;);
 						int posGt=log.indexOf('&gt;'); // Find the icon which defines the type of log
 						if (posGt&lt;0) {
 							logs.put(&quot;LOG&quot;,log);
@@ -184,7 +184,7 @@
 					}
 					tpl.setParam(&quot;LOGS&quot;,logVect);
 					if (!chD.is_available()) tpl.setParam(&quot;UNAVAILABLE&quot;,&quot;1&quot;);
-					if (!chD.Hints.equals(&quot;null&quot;))tpl.setParam(&quot;HINT&quot;,Common.rot13(chD.Hints));
+					if (!chD.getExistingDetails().Hints.equals(&quot;null&quot;))tpl.setParam(&quot;HINT&quot;,Common.rot13(chD.getExistingDetails().Hints));
 					
 					if (chD.hasAddiWpt()) {
 						Vector addiVect=new Vector(chD.addiWpts.size());
@@ -195,9 +195,7 @@
 							addis.put(&quot;NAME&quot;,ch.getCacheName());
 							addis.put(&quot;LATLON&quot;,ch.LatLon);
 							addis.put(&quot;IMG&quot;,&quot;&lt;img src=\&quot;&quot;+CacheType.type2pic(ch.getType())+&quot;\&quot;&gt;&quot;);
-							CacheHolderDetail chDA=new CacheHolderDetail(ch);
-							chDA.readCache(Global.getProfile().dataDir);
-							addis.put(&quot;LONGDESC&quot;,chDA.LongDescription); // Do we need to treat longDesc as above ?
+							addis.put(&quot;LONGDESC&quot;,ch.getExistingDetails().LongDescription); // Do we need to treat longDesc as above ?
 							addiVect.add(addis);
 						}
 						tpl.setParam(&quot;ADDIS&quot;,addiVect);

Modified: trunk/src/CacheWolf/SpiderGC.java
===================================================================
--- trunk/src/CacheWolf/SpiderGC.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/SpiderGC.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -211,7 +211,8 @@
 	public int spiderSingle(int number, InfoBox infB, boolean forceLogin){
 		int ret=-1;
 		this.infB = infB;
-		CacheHolder ch = cacheDB.get(number);
+		CacheHolder ch = new CacheHolder(); // cacheDB.get(number);
+		ch.setWayPoint(cacheDB.get(number).getWayPoint());
 		if (ch.isAddiWpt()) return -1;  // No point re-spidering an addi waypoint, comes with parent
 
 		// check if we need to login
@@ -219,25 +220,18 @@
 			if (this.login()!=FormBase.IDOK) return -1;
 			// loggedIn is already set by this.login()
 		}
-		CacheHolderDetail chD=ch.getCacheDetails(true); //new CacheHolderDetail(ch);
 		try{
-/*			// Get all existing details of the cache
-			try {
-				chD.readCache(profile.dataDir);
-			} catch (IOException ioex) {
-				pref.log(&quot;No .XML file found for cache &quot;+chD.wayPoint);
-			};
-*/			// Read the cache data from GC.COM and compare to old data
+			// Read the cache data from GC.COM and compare to old data
 			boolean loadAllLogs = (MAXLOGS &gt; 5);
-			ret=getCacheByWaypointName(chD,true,true,false,loadAllLogs);
+			ret=getCacheByWaypointName(ch,true,true,false,loadAllLogs);
 			// Save the spidered data
 			if (ret == 1) {
 				pref.log(&quot;Saving to:&quot; + profile.dataDir);
-				chD.saveCacheDetails(profile.dataDir);
-				cacheDB.get(number).update(chD);
+				cacheDB.get(number).update(ch);
+				ch.save();
 			}
 		}catch(Exception ex){
-			pref.log(&quot;Error spidering &quot; + chD.getWayPoint() + &quot; in spiderSingle&quot;);
+			pref.log(&quot;Error spidering &quot; + ch.getWayPoint() + &quot; in spiderSingle&quot;);
 		}
 		return ret;
 	} // spiderSingle
@@ -284,7 +278,7 @@
 	public void doIt(boolean spiderAllFinds){
 		String postStr, dummy, ln, wpt;
 		Regex lineRex;
-		CacheHolderDetail chD;
+		CacheHolder holder;
 		CWPoint origin = pref.curCentrePt; // No need to copy curCentrePt as it is only read and not written
 		if ( !spiderAllFinds &amp;&amp; !origin.isValid()) {
 			(new MessageBox(MyLocale.getMsg(5500,&quot;Error&quot;), MyLocale.getMsg(5509,&quot;Coordinates for centre must be set&quot;), FormBase.OKB)).execute();
@@ -468,13 +462,9 @@
 									cachesToUpdate.put(ch.getWayPoint(), ch);
 								}
 								ch.setArchived(is_archived_GC);
-								chD=ch.getCacheDetails(true,false);
-								ch.detailsAdded();
 							} else if (ch.is_available()!=is_available_GC) { // Update the database with the cache status
 								pref.log(&quot;Updating status of &quot;+waypoint+&quot; to &quot;+(is_available_GC?&quot;available&quot;:&quot;not available&quot;));
 								ch.setAvailable(is_available_GC);
-								chD=ch.getCacheDetails(true,false);
-								ch.detailsAdded();
 							} else {
 								cachesToUpdate.remove( ch.getWayPoint() );
 							}
@@ -511,7 +501,6 @@
 					}catch(Exception ex){
 						//Vm.debug(&quot;Couldn't get the next page&quot;);
 						pref.log(&quot;Error getting next page&quot;);
-					}finally{
 					}
 				}
 				//Vm.debug(&quot;Distance is now: &quot; + distance);
@@ -556,18 +545,18 @@
 			// Get only caches not already available in the DB
 			if(cacheDB.getIndex(wpt) == -1){
 				infB.setInfo(MyLocale.getMsg(5513,&quot;Loading: &quot;) + wpt +&quot; (&quot; + (i+1) + &quot; / &quot; + totalCachesToLoad + &quot;)&quot;);
-				chD = new CacheHolderDetail();
-				chD.setWayPoint(wpt);
-				int test = getCacheByWaypointName(chD,false,getImages,doNotgetFound,loadAllLogs);
+				holder = new CacheHolder();
+				holder.setWayPoint(wpt);
+				int test = getCacheByWaypointName(holder,false,getImages,doNotgetFound,loadAllLogs);
 				if (test == -1) {
 					infB.close(0);
 					break;
 				} else if (test == 0) {
 					spiderErrors++;
 				} else {
-					if (!chD.is_found() || !doNotgetFound ) {
-						chD.saveCacheDetails(profile.dataDir);
-						cacheDB.add(new CacheHolder(chD)); 
+					if (!holder.is_found() || !doNotgetFound ) {
+						cacheDB.add(holder); 
+						holder.save();
 					}
 				}
 			}
@@ -618,7 +607,7 @@
 	 *     This is normally false when spidering from GPXImport as the logs are part of the GPX file, and true otherwise
 	 * @return -1 if the infoBox was closed (cancel spidering), 0 if there was an error (continue with next cache), 1 if everything ok
 	 */
-	private int getCacheByWaypointName(CacheHolderDetail chD, boolean isUpdate, boolean fetchImages, boolean doNotGetFound, boolean fetchAllLogs) {
+	private int getCacheByWaypointName(CacheHolder ch, boolean isUpdate, boolean fetchImages, boolean doNotGetFound, boolean fetchAllLogs) {
 		int ret = 1;
 		while (true) {
 			String completeWebPage;
@@ -627,33 +616,33 @@
 			while (spiderTrys++&lt;MAX_SPIDER_TRYS) {
 				ret = 1;
 				try{
-					String doc = p.getProp(&quot;getPageByName&quot;) + chD.getWayPoint() +(fetchAllLogs?p.getProp(&quot;fetchAllLogs&quot;):&quot;&quot;);
-					pref.log(&quot;Fetching: &quot; + chD.getWayPoint());
+					String doc = p.getProp(&quot;getPageByName&quot;) + ch.getWayPoint() +(fetchAllLogs?p.getProp(&quot;fetchAllLogs&quot;):&quot;&quot;);
+					pref.log(&quot;Fetching: &quot; + ch.getWayPoint());
 					completeWebPage = fetch(doc);
 					if	( completeWebPage.equals(&quot;&quot;)) {
-						pref.log(&quot;Could not fetch &quot; + chD.getWayPoint());
+						pref.log(&quot;Could not fetch &quot; + ch.getWayPoint());
 						if (!infB.isClosed) {
 							continue;
 						} else {
-							chD.setIncomplete(true);
+							ch.setIncomplete(true);
 							return -1;
 						}
 					}
 				}catch(Exception ex){
-					pref.log(&quot;Could not fetch &quot; + chD.getWayPoint(),ex);
+					pref.log(&quot;Could not fetch &quot; + ch.getWayPoint(),ex);
 					if (!infB.isClosed) {
 						continue;
 					} else {
-						chD.setIncomplete(true);
+						ch.setIncomplete(true);
 						return -1;
 					}
 				}
 				// Only analyse the cache data and fetch pictures if user has not closed the progress window
 				if (!infB.isClosed) {
 					try{
-						chD.setNew(!isUpdate);
-						chD.setUpdated(false);
-						chD.setLog_updated(false);
+						ch.setNew(!isUpdate);
+						ch.setUpdated(false);
+						ch.setLog_updated(false);
 
 						//first check if coordinates are available to prevent deleting existing coorinates
 						String latLon = getLatLon(completeWebPage);
@@ -663,99 +652,99 @@
 							continue; // Restart the spider
 						}
 
-						chD.setHTML(true);
-						chD.setAvailable(true);
-						chD.setArchived(false);
-						chD.setIncomplete(true);
+						ch.setHTML(true);
+						ch.setAvailable(true);
+						ch.setArchived(false);
+						ch.setIncomplete(true);
 						// Save size of logs to be able to check whether any new logs were added
 						//int logsz = chD.CacheLogs.size();
 						//chD.CacheLogs.clear();
-						chD.addiWpts.clear();
-						chD.Images.clear();
-						chD.ImagesText.clear();
-						chD.ImagesInfo.clear();
+						ch.addiWpts.clear();
+						ch.getFreshDetails().Images.clear();
+						ch.getFreshDetails().ImagesText.clear();
+						ch.getFreshDetails().ImagesInfo.clear();
 
-						if(completeWebPage.indexOf(p.getProp(&quot;cacheUnavailable&quot;)) &gt;= 0) chD.setAvailable(false);
-						if(completeWebPage.indexOf(p.getProp(&quot;cacheArchived&quot;)) &gt;= 0) chD.setArchived(true);
+						if(completeWebPage.indexOf(p.getProp(&quot;cacheUnavailable&quot;)) &gt;= 0) ch.setAvailable(false);
+						if(completeWebPage.indexOf(p.getProp(&quot;cacheArchived&quot;)) &gt;= 0) ch.setArchived(true);
 						//==========
 						// General Cache Data
 						//==========
-						chD.setLatLon(latLon);
-						pref.log(&quot;LatLon: &quot; + chD.LatLon);
-						if (pref.debug) pref.log(&quot;chD.pos: &quot; + chD.pos.toString());
+						ch.setLatLon(latLon);
+						pref.log(&quot;LatLon: &quot; + ch.LatLon);
+						if (pref.debug) pref.log(&quot;chD.pos: &quot; + ch.pos.toString());
 
 						pref.log(&quot;Trying description&quot;);
-						chD.setLongDescription(getLongDesc(completeWebPage));
+						ch.getFreshDetails().setLongDescription(getLongDesc(completeWebPage));
 						pref.log(&quot;Got description&quot;);
 
 						pref.log(&quot;Getting cache name&quot;);
-						chD.setCacheName(SafeXML.cleanback(getName(completeWebPage)));
-						if (pref.debug) pref.log(&quot;Name: &quot; + chD.getCacheName()); else pref.log(&quot;Got name&quot;);
+						ch.setCacheName(SafeXML.cleanback(getName(completeWebPage)));
+						if (pref.debug) pref.log(&quot;Name: &quot; + ch.getCacheName()); else pref.log(&quot;Got name&quot;);
 						
 						pref.log(&quot;Trying location (country/state)&quot;);
 						String location = getLocation(completeWebPage);
 						if (location.length() != 0) {
 							int countryStart = location.indexOf(&quot;,&quot;);
 							if (countryStart &gt; -1) {
-								chD.Country = SafeXML.cleanback(location.substring(countryStart + 1).trim());
-								chD.State = SafeXML.cleanback(location.substring(0, countryStart).trim());								
+								ch.getFreshDetails().Country = SafeXML.cleanback(location.substring(countryStart + 1).trim());
+								ch.getFreshDetails().State = SafeXML.cleanback(location.substring(0, countryStart).trim());								
 							} else {
-								chD.Country = location.trim();
-								chD.State = &quot;&quot;;
+								ch.getFreshDetails().Country = location.trim();
+								ch.getFreshDetails().State = &quot;&quot;;
 							}
 							pref.log(&quot;Got location (country/state)&quot;);							
 						} else {
-							chD.Country = &quot;&quot;;
-							chD.State = &quot;&quot;;
+							ch.getFreshDetails().Country = &quot;&quot;;
+							ch.getFreshDetails().State = &quot;&quot;;
 							pref.log(&quot;No location (country/state) found&quot;);
 						}
 
 						pref.log(&quot;Trying owner&quot;);
-						chD.setCacheOwner(SafeXML.cleanback(getOwner(completeWebPage)).trim());
-						if(chD.getCacheOwner().equals(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; chD.getCacheOwner().equals(pref.myAlias2))) chD.setOwned(true);
-						if (pref.debug) pref.log(&quot;Owner: &quot; + chD.getCacheOwner() +&quot;; is_owned = &quot;+chD.is_owned()+&quot;;  alias1,2 = [&quot;+pref.myAlias+&quot;|&quot;+pref.myAlias2+&quot;]&quot;);
+						ch.setCacheOwner(SafeXML.cleanback(getOwner(completeWebPage)).trim());
+						if(ch.getCacheOwner().equals(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; ch.getCacheOwner().equals(pref.myAlias2))) ch.setOwned(true);
+						if (pref.debug) pref.log(&quot;Owner: &quot; + ch.getCacheOwner() +&quot;; is_owned = &quot;+ch.is_owned()+&quot;;  alias1,2 = [&quot;+pref.myAlias+&quot;|&quot;+pref.myAlias2+&quot;]&quot;);
 						else pref.log(&quot;Got owner&quot;);
 
 
 						pref.log(&quot;Trying date hidden&quot;);
-						chD.setDateHidden(DateFormat.MDY2YMD(getDateHidden(completeWebPage)));
-						if (pref.debug) pref.log(&quot;Hidden: &quot; + chD.getDateHidden());
+						ch.setDateHidden(DateFormat.MDY2YMD(getDateHidden(completeWebPage)));
+						if (pref.debug) pref.log(&quot;Hidden: &quot; + ch.getDateHidden());
 						else pref.log(&quot;Got date hidden&quot;);
 
 						pref.log(&quot;Trying hints&quot;);
-						chD.setHints(getHints(completeWebPage));
-						if (pref.debug) pref.log(&quot;Hints: &quot; + chD.Hints);
+						ch.getFreshDetails().setHints(getHints(completeWebPage));
+						if (pref.debug) pref.log(&quot;Hints: &quot; + ch.getFreshDetails().Hints);
 						else pref.log(&quot;Got hints&quot;);
 
 						pref.log(&quot;Trying size&quot;);
-						chD.setCacheSize(getSize(completeWebPage));
-						if (pref.debug) pref.log(&quot;Size: &quot; + chD.getCacheSize());
+						ch.setCacheSize(getSize(completeWebPage));
+						if (pref.debug) pref.log(&quot;Size: &quot; + ch.getCacheSize());
 						else pref.log(&quot;Got size&quot;);
 
 						pref.log(&quot;Trying difficulty&quot;);
-						chD.setHard(getDiff(completeWebPage));
-						if (pref.debug) pref.log(&quot;Hard: &quot; + chD.getHard());
+						ch.setHard(getDiff(completeWebPage));
+						if (pref.debug) pref.log(&quot;Hard: &quot; + ch.getHard());
 						else pref.log(&quot;Got difficulty&quot;);
 
 						pref.log(&quot;Trying terrain&quot;);
-						chD.setTerrain(getTerr(completeWebPage));
-						if (pref.debug) pref.log(&quot;Terr: &quot; + chD.getTerrain());
+						ch.setTerrain(getTerr(completeWebPage));
+						if (pref.debug) pref.log(&quot;Terr: &quot; + ch.getTerrain());
 						else pref.log(&quot;Got terrain&quot;);
 
 						pref.log(&quot;Trying cache type&quot;);
-						chD.setType(getType(completeWebPage));
-						if (pref.debug) pref.log(&quot;Type: &quot; + chD.getType());
+						ch.setType(getType(completeWebPage));
+						if (pref.debug) pref.log(&quot;Type: &quot; + ch.getType());
 						else pref.log(&quot;Got cache type&quot;);
 
 						//==========
 						// Logs
 						//==========
 						pref.log(&quot;Trying logs&quot;);
-						chD.setCacheLogs(getLogs(completeWebPage, chD));
+						ch.getFreshDetails().setCacheLogs(getLogs(completeWebPage, ch.getFreshDetails()));
 						pref.log(&quot;Found logs&quot;);
 
 						// If the switch is set to not store found caches and we found the cache =&gt; return
-						if (chD.is_found() &amp;&amp; doNotGetFound) {
+						if (ch.is_found() &amp;&amp; doNotGetFound) {
 							if (infB.isClosed) {
 								return -1;
 							} else {
@@ -767,15 +756,15 @@
 						// Bugs
 						//==========
 						// As there may be several bugs, we check whether the user has aborted
-						if (!infB.isClosed) getBugs(chD,completeWebPage);
-						chD.setHas_bugs(chD.Travelbugs.size()&gt;0);
+						if (!infB.isClosed) getBugs(ch.getFreshDetails(),completeWebPage);
+						ch.setHas_bugs(ch.getFreshDetails().Travelbugs.size()&gt;0);
 
 						//==========
 						// Images
 						//==========
 						if(fetchImages){
 							pref.log(&quot;Trying images&quot;);
-							getImages(completeWebPage, chD);
+							getImages(completeWebPage, ch.getFreshDetails());
 							pref.log(&quot;Got images&quot;);
 						}
 						//==========
@@ -783,20 +772,20 @@
 						//==========
 
 						pref.log(&quot;Getting additional waypoints&quot;);
-						getAddWaypoints(completeWebPage, chD.getWayPoint(), chD.is_found());
+						getAddWaypoints(completeWebPage, ch.getWayPoint(), ch.is_found());
 						pref.log(&quot;Got additional waypoints&quot;);
 
 						//==========
 						// Attributes
 						//==========
 						pref.log(&quot;Getting attributes&quot;);
-						getAttributes(completeWebPage, chD);
+						getAttributes(completeWebPage, ch.getFreshDetails());
 						pref.log(&quot;Got attributes&quot;);
-						if (chD.is_new()) chD.setUpdated(false);
-						chD.setIncomplete(false);
+						if (ch.is_new()) ch.setUpdated(false);
+						ch.setIncomplete(false);
 						break;
 					}catch(Exception ex){
-						pref.log(&quot;Error reading cache: &quot;+chD.getWayPoint());
+						pref.log(&quot;Error reading cache: &quot;+ch.getWayPoint());
 						pref.log(&quot;Exception in getCacheByWaypointName: &quot;,ex);
 					}
 					finally{}
@@ -1031,8 +1020,8 @@
 			String d=DateFormat.logdate2YMD(exDate.findNext());
 			if((icon.equals(p.getProp(&quot;icon_smile&quot;)) || icon.equals(p.getProp(&quot;icon_camera&quot;)) || icon.equals(p.getProp(&quot;icon_attended&quot;))) &amp;&amp;
 				(name.equalsIgnoreCase(pref.myAlias) || (pref.myAlias2.length()&gt;0 &amp;&amp; name.equalsIgnoreCase(pref.myAlias2))) )  {
-				chD.setFound(true);
-				chD.setCacheStatus(d);
+				chD.getParent().setFound(true);
+				chD.getParent().setCacheStatus(d);
 				chD.OwnLogId = logId;
 				chD.OwnLog = new Log(icon,d,name,logText);
 			}
@@ -1048,7 +1037,7 @@
 			exLogId.setSource(singleLog);
 			// We cannot simply stop if we have reached MAXLOGS just in case we are waiting for
 			// a log by our alias that happened earlier.
-			if (nLogs&gt;=MAXLOGS &amp;&amp; chD.is_found() &amp;&amp; (chD.OwnLogId.length() != 0) &amp;&amp; (chD.OwnLog != null) &amp;&amp; !(chD.OwnLog.getDate().equals(&quot;1900-01-01&quot;))) break;
+			if (nLogs&gt;=MAXLOGS &amp;&amp; chD.getParent().is_found() &amp;&amp; (chD.OwnLogId.length() != 0) &amp;&amp; (chD.OwnLog != null) &amp;&amp; !(chD.OwnLog.getDate().equals(&quot;1900-01-01&quot;))) break;
 		}
 		if (nLogs&gt;MAXLOGS) {
 			reslts.add(Log.maxLog());
@@ -1118,7 +1107,7 @@
 		//========
 		String longDesc = &quot;&quot;;
 		try {
-			if (chD.getWayPoint().startsWith(&quot;TC&quot;)) longDesc = doc;
+			if (chD.getParent().getWayPoint().startsWith(&quot;TC&quot;)) longDesc = doc;
 			else
 				longDesc = getLongDesc(doc);
 			longDesc = STRreplace.replace(longDesc, &quot;&lt;img&quot;, &quot;&lt;IMG&quot;);
@@ -1144,7 +1133,7 @@
 					if(imgType.startsWith(&quot;.png&quot;) || imgType.startsWith(&quot;.jpg&quot;) || imgType.startsWith(&quot;.gif&quot;)){
 						// Check whether image was already spidered for this cache
 						idxUrl=spideredUrls.find(imgUrl);
-						imgName = chD.getWayPoint() + &quot;_&quot; + Convert.toString(imgCounter);
+						imgName = chD.getParent().getWayPoint() + &quot;_&quot; + Convert.toString(imgCounter);
 						if (idxUrl&lt;0) { // New image
 							pref.log(&quot;Loading image: &quot; + imgUrl+&quot; as &quot;+imgName);
 							spiderImage(imgUrl, imgName+imgType);
@@ -1152,7 +1141,7 @@
 							spideredUrls.add(imgUrl);
 						} else { // Image already spidered as wayPoint_'idxUrl'
 							pref.log(&quot;Already loaded image: &quot; + imgUrl);
-							oldImgName = chD.getWayPoint() + &quot;_&quot; + Convert.toString(idxUrl);
+							oldImgName = chD.getParent().getWayPoint() + &quot;_&quot; + Convert.toString(idxUrl);
 							chD.Images.add(oldImgName+imgType); // Store name of old image as image to load
 						}
 						chD.ImagesText.add(imgName); // Keep the image name
@@ -1191,14 +1180,14 @@
 					if(imgType.startsWith(&quot;.png&quot;) || imgType.startsWith(&quot;.jpg&quot;) || imgType.startsWith(&quot;.gif&quot;)){
 						// Check whether image was already spidered for this cache
 						idxUrl=spideredUrls.find(imgUrl);
-						imgName = chD.getWayPoint() + &quot;_&quot; + Convert.toString(imgCounter);
+						imgName = chD.getParent().getWayPoint() + &quot;_&quot; + Convert.toString(imgCounter);
 						if (idxUrl&lt;0) { // New image
 							pref.log(&quot;Loading image: &quot; + imgUrl);
 							spiderImage(imgUrl, imgName+imgType);
 							chD.Images.add(imgName+imgType);
 						} else { // Image already spidered as wayPoint_ 'idxUrl'
 							pref.log(&quot;Already loaded image: &quot; + imgUrl);
-							oldImgName = chD.getWayPoint() + &quot;_&quot; + Convert.toString(idxUrl);
+							oldImgName = chD.getParent().getWayPoint() + &quot;_&quot; + Convert.toString(idxUrl);
 							chD.Images.add(oldImgName+imgType); // Store name of old image as image to load
 						}
 						chD.ImagesText.add(exImgName.findNext()); // Keep the image description
@@ -1231,7 +1220,7 @@
 						// Check whether image was already spidered for this cache
 						idxUrl=spideredUrls.find(imgUrl);
 						if (idxUrl&lt;0) { // New image
-							imgName = chD.getWayPoint() + &quot;_&quot; + Convert.toString(imgCounter);
+							imgName = chD.getParent().getWayPoint() + &quot;_&quot; + Convert.toString(imgCounter);
 							pref.log(&quot;Loading image: &quot; + imgUrl+&quot; as &quot;+imgName);
 							spiderImage(imgUrl, imgName+imgType);
 							chD.Images.add(imgName+imgType);
@@ -1317,7 +1306,7 @@
 			rowBlock = exRowBlock.findNext();
 			rowBlock = exRowBlock.findNext();
 			while(exRowBlock.endOfSearch()==false){
-				CacheHolderDetail cxD = new CacheHolderDetail();
+				CacheHolder hd = null;
 				Extractor exPrefix=new Extractor(rowBlock,p.getProp(&quot;prefixExStart&quot;),p.getProp(&quot;prefixExEnd&quot;),0,true);
 				String prefix=exPrefix.findNext();
 				String adWayPoint;
@@ -1328,35 +1317,36 @@
 				counter++;
 				int idx=profile.getCacheIndex(adWayPoint);
 				if (idx&gt;=0) {
-					cxD=new CacheHolderDetail(cacheDB.get(idx));
-					try{ // If addi exists, try to read it to preserve the notes
-						cxD.readCache(profile.dataDir);
-					} catch (Exception ex) {};
+					// Creating new CacheHolder, but accessing old cache.xml file
+					hd=new CacheHolder();
+					hd.setWayPoint(adWayPoint);
+					hd.getExistingDetails(); // Accessing Details reads file if not yet done
 				} else {
-					cxD=new CacheHolderDetail(); cxD.setWayPoint(adWayPoint);
+					hd=new CacheHolder(); 
+					hd.setWayPoint(adWayPoint);
 				}
-				cxD.setUpdated(false); 
-				cxD.setNew(false);
+				hd.setUpdated(false); 
+				hd.setNew(false);
 				nameRex.search(rowBlock);
 				koordRex.search(rowBlock);
 				typeRex.search(rowBlock);
-				cxD.setCacheName(nameRex.stringMatched(1));
-				if(koordRex.didMatch()) cxD.setLatLon(koordRex.stringMatched(1));
-				if(typeRex.didMatch()) cxD.setType(CacheType.typeText2Number(&quot;Waypoint|&quot;+typeRex.stringMatched(1)));
+				hd.setCacheName(nameRex.stringMatched(1));
+				if(koordRex.didMatch()) hd.setLatLon(koordRex.stringMatched(1));
+				if(typeRex.didMatch()) hd.setType(CacheType.typeText2Number(&quot;Waypoint|&quot;+typeRex.stringMatched(1)));
 				rowBlock = exRowBlock.findNext();
 				descRex.search(rowBlock);
-				cxD.setLongDescription(descRex.stringMatched(1));
-				cxD.setFound(is_found);
-				cxD.saveCacheDetails(profile.dataDir);
+				hd.getFreshDetails().setLongDescription(descRex.stringMatched(1));
+				hd.setFound(is_found);
+				hd.save();
 				if (idx&lt;0){
-					cxD.setNew(true); 
-					cxD.setUpdated(false);
-					cacheDB.add(new CacheHolder(cxD));
+					hd.setNew(true); 
+					hd.setUpdated(false);
+					cacheDB.add(hd);
 				}else {
 					CacheHolder cx=cacheDB.get(idx);
 					if (cx.is_Checked &amp;&amp; // Only re-spider existing addi waypoints that are ticked
 				 	   !cx.is_filtered()) { // and are visible (i.e.  not filtered)
-					   cx.update(cxD);
+					   cx.update(hd);
 					   cx.is_Checked=true;
 					}
 				}
@@ -1375,8 +1365,8 @@
 			chD.attributes.add(attribute);
 			attribute=attEx.findNext();
 		}
-		chD.setAttributesYes(chD.attributes.attributesYes);
-		chD.setAttributesNo(chD.attributes.attributesNo);
+		chD.getParent().setAttributesYes(chD.attributes.attributesYes);
+		chD.getParent().setAttributesNo(chD.attributes.attributesNo);
 	}
 
 

Modified: trunk/src/CacheWolf/TravelbugJourneyScreen.java
===================================================================
--- trunk/src/CacheWolf/TravelbugJourneyScreen.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/TravelbugJourneyScreen.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -67,13 +67,8 @@
 			ch=cacheDB.get(curCacheNo);
 			cache=MyLocale.getMsg(6022,&quot;: Current cache: &quot;)+ch.getWayPoint()+&quot; - &quot;+ch.getCacheName();
 			waypoint=ch.getWayPoint();
-			chD=new CacheHolderDetail(ch);
-			try {
-				chD.readCache(Global.getProfile().dataDir);
-			}catch (Exception ex) {
-				Global.getPref().log(&quot;Failed to read cache &quot;+ch.getWayPoint());
-			};
-			tblSrcCache=chD.Travelbugs;
+			chD=ch.getExistingDetails();
+			tblSrcCache=ch.getExistingDetails().Travelbugs;
 		}
 		title=&quot;Travelbugs&quot;+cache;
 		tcTbJourneyList=new tbListControl();
@@ -253,8 +248,8 @@
 			}
 			// If the list of travelbugs in the cache was modified, we need to save the cache too
 			if (chDmodified) {
-				chD.saveCacheDetails(Global.getProfile().dataDir);
 				ch.setHas_bugs(chD.Travelbugs.size()&gt;0);
+				ch.save();
 			}
 			Vm.showWait(false);
 			chD=null;

Modified: trunk/src/CacheWolf/myTableControl.java
===================================================================
--- trunk/src/CacheWolf/myTableControl.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/myTableControl.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -189,9 +189,8 @@
 							nDeleted++;
 							h.progress = ((float)nDeleted)/(float)allCount;
 							h.changed();
-							dm.deleteCacheFiles(ch.getWayPoint(),profile.dataDir);
 							cacheDB.removeElementAt(i);
-							ch.releaseCacheDetails();
+							dm.deleteCacheFiles(ch.getWayPoint(),profile.dataDir);
 							ch=null;
 							if (pbf.isClosed) break;
 						}
@@ -250,7 +249,7 @@
 		if (selectedItem == miOpenOffline) {
 			if(browserPathIsValid()){
 				ShowCacheInBrowser sc=new ShowCacheInBrowser();
-				sc.showCache(cacheDB.get(tbp.getSelectedCache()).getCacheDetails(false, true));
+				sc.showCache(cacheDB.get(tbp.getSelectedCache()));
 			}
 		}
 		if (selectedItem == miOpen){

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/myTableModel.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -24,6 +24,7 @@
 	private static final Color COLOR_SELECTED	= new Color(198,198,198);
 	private static final Color COLOR_ARCHFND_FG	= new Color(255,0,0); // Archived &amp;&amp; Found
 	private static final Color COLOR_ARCHFND_BG	= new Color(152,251,152);	
+	private static final Color COLOR_DETAILS_LOADED		= new Color(229,206,235);
 	private CacheDB cacheDB;
 	/** How the columns are mapped onto the list view. If colMap[i]=j, it means that
 	 * the element j (as per the list below) is visible in column i. 
@@ -180,6 +181,7 @@
 				else if( ch.is_owned())     ta.fillColor = COLOR_OWNED;
 				else if( ch.is_found())     ta.fillColor = COLOR_FOUND;
 				else if( ch.is_flaged)        ta.fillColor = COLOR_FLAGED;
+				else if( Global.getPref().debug &amp;&amp; ch.detailsLoaded()) ta.fillColor = COLOR_DETAILS_LOADED;
 			} catch (Exception e) {};
 		} else if (row==-1 &amp;&amp; colMap[col]==0 &amp;&amp; Global.getProfile().showBlacklisted()) ta.fillColor=Color.Black;
 		return ta;

Modified: trunk/src/CacheWolf/navi/CWGPSPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/CWGPSPoint.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/CacheWolf/navi/CWGPSPoint.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -143,7 +143,7 @@
 		if (doLogging){
 			try {
 				logFile.close();
-			} catch (IOException e) {}
+			} catch (IOException e) {/*Too lazy to do something */}
 			if (logTimer &gt; 0) {
 				Vm.cancelTimer(logTimer);
 				logTimer = 0;

Modified: trunk/src/exp/ASCExporter.java
===================================================================
--- trunk/src/exp/ASCExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/ASCExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -19,7 +19,7 @@
 		this();
 	}
 	
-	public String record (CacheHolderDetail holder, String lat, String lon){
+	public String record (CacheHolder holder, String lat, String lon){
 		StringBuffer strBuf = new StringBuffer(100);
 		String dummy;
 		dummy = holder.getCacheName();

Modified: trunk/src/exp/ExploristExporter.java
===================================================================
--- trunk/src/exp/ExploristExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/ExploristExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -105,7 +105,6 @@
 		String fileBaseName;
 		String str = null;
 		CacheHolder ch;
-		CacheHolderDetail holder;
 		ProgressBarForm pbf = new ProgressBarForm();
 		Handle h = new Handle();
 
@@ -148,18 +147,10 @@
 										/ 200 + &quot;.gs&quot;))));
 					}
 
-					holder = new CacheHolderDetail(ch);
 					expCount++;
 					h.progress = (float) expCount / (float) counter;
 					h.changed();
-					try {
-						if (needCacheDetails) {
-							holder.readCache(profile.dataDir);
-						}
-					} catch (IOException e) {
-						continue;
-					}
-					str = record(holder);
+					str = record(ch);
 					if (str != null)
 						outp.print(str);
 				}// if
@@ -205,7 +196,8 @@
 	 *            cachedata
 	 * @return formated cache data
 	 */
-	public String record(CacheHolderDetail chD) {
+	public String record(CacheHolder ch) {
+		CacheHolderDetail det = ch.getExistingDetails();
 		/*
 		static protected final int GC_AW_PARKING = 50;
 		static protected final int GC_AW_STAGE_OF_MULTI = 51;
@@ -216,65 +208,65 @@
 		*/
 		StringBuffer sb = new StringBuffer();
 		sb.append(&quot;$PMGNGEO,&quot;);
-		sb.append(chD.pos.getLatDeg(CWPoint.DMM));
-		sb.append(chD.pos.getLatMin(CWPoint.DMM));
+		sb.append(ch.pos.getLatDeg(CWPoint.DMM));
+		sb.append(ch.pos.getLatMin(CWPoint.DMM));
 		sb.append(&quot;,&quot;);
 		sb.append(&quot;N,&quot;);
-		sb.append(chD.pos.getLonDeg(CWPoint.DMM));
-		sb.append(chD.pos.getLonMin(CWPoint.DMM));
+		sb.append(ch.pos.getLonDeg(CWPoint.DMM));
+		sb.append(ch.pos.getLonMin(CWPoint.DMM));
 		sb.append(&quot;,&quot;);
 		sb.append(&quot;E,&quot;);
 		sb.append(&quot;0000,&quot;); // Height
 		sb.append(&quot;M,&quot;); // in meter
-		sb.append(chD.getWayPoint());
+		sb.append(ch.getWayPoint());
 		sb.append(&quot;,&quot;);
 		String add = &quot;&quot;;
-		if (chD.isAddiWpt()) {
-			if (chD.getType() == 50) {
+		if (ch.isAddiWpt()) {
+			if (ch.getType() == 50) {
 				add = &quot;Pa:&quot;;
-			} else if (chD.getType() == 51) {
+			} else if (ch.getType() == 51) {
 				add = &quot;St:&quot;;
-			} else if (chD.getType() == 52) {
+			} else if (ch.getType() == 52) {
 				add = &quot;Qu:&quot;; 
-			} else if (chD.getType() == 53) {	
+			} else if (ch.getType() == 53) {	
 				add = &quot;Fi:&quot;;
-			} else if (chD.getType() == 54) {
+			} else if (ch.getType() == 54) {
 				add = &quot;Tr:&quot;;
-			} else if (chD.getType() == 55) {	
+			} else if (ch.getType() == 55) {	
 				add = &quot;Re:&quot;;
 			}
-			sb.append(add).append(removeCommas(chD.getCacheName()));
+			sb.append(add).append(removeCommas(ch.getCacheName()));
 		} else {
-			sb.append(removeCommas(chD.getCacheName()));
+			sb.append(removeCommas(ch.getCacheName()));
 		}		
 		sb.append(&quot;,&quot;);
-		sb.append(removeCommas(chD.getCacheOwner()));
+		sb.append(removeCommas(ch.getCacheOwner()));
 		sb.append(&quot;,&quot;);
-		sb.append(removeCommas(Common.rot13(chD.Hints)));
+		sb.append(removeCommas(Common.rot13(det.Hints)));
 		sb.append(&quot;,&quot;);
 		
 		if (!add.equals(&quot;&quot;)) { // Set Picture in Explorist to Virtual
 			sb.append(&quot;Virtual Cache&quot;);
-		} else if (chD.getType() != 8) { // Rewrite Unknown Caches
-			sb.append(CacheType.transType(chD.getType()));
+		} else if (ch.getType() != 8) { // Rewrite Unknown Caches
+			sb.append(CacheType.transType(ch.getType()));
 		} else {
 			sb.append(&quot;Mystery Cache&quot;);
 		}
 		sb.append(&quot;,&quot;);
-		sb.append(toGsDateFormat(chD.getDateHidden()));  // created - DDMMYYY, YYY = year - 1900
+		sb.append(toGsDateFormat(ch.getDateHidden()));  // created - DDMMYYY, YYY = year - 1900
 		sb.append(&quot;,&quot;);
 		String lastFound = &quot;0000&quot;;
-		for (int i = 0; i &lt; chD.CacheLogs.size(); i++) {
-			if (chD.CacheLogs.getLog(i).isFoundLog() &amp;&amp; chD.CacheLogs.getLog(i).getDate().compareTo(lastFound) &gt; 0 ) {
-				lastFound = chD.CacheLogs.getLog(i).getDate();
+		for (int i = 0; i &lt; det.CacheLogs.size(); i++) {
+			if (det.CacheLogs.getLog(i).isFoundLog() &amp;&amp; det.CacheLogs.getLog(i).getDate().compareTo(lastFound) &gt; 0 ) {
+				lastFound = det.CacheLogs.getLog(i).getDate();
 			}
 		}
 		
 		sb.append(toGsDateFormat(lastFound)); // lastFound - DDMMYYY, YYY = year - 1900
 		sb.append(&quot;,&quot;);
-		sb.append(removeCommas(chD.getHard()));
+		sb.append(removeCommas(ch.getHard()));
 		sb.append(&quot;,&quot;);
-		sb.append(removeCommas(chD.getTerrain()));
+		sb.append(removeCommas(ch.getTerrain()));
 		sb.append(&quot;*41&quot;);
 		return Exporter.simplifyString(sb.toString() + &quot;\r\n&quot;);
 	}

Modified: trunk/src/exp/Exporter.java
===================================================================
--- trunk/src/exp/Exporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/Exporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -74,7 +74,6 @@
 		File outFile;
 		String str;
 		CacheHolder ch;
-		CacheHolderDetail holder;
 		ProgressBarForm pbf = new ProgressBarForm();
 		Handle h = new Handle();
 
@@ -101,29 +100,25 @@
 			PrintWriter outp =  new PrintWriter(new BufferedWriter(new FileWriter(outFile)));
 			str = this.header();
 			if (str != null) outp.print(str);
-			holder=new CacheHolderDetail();
 			for(int i = 0; i&lt;cacheDB.size(); i++){
 				ch=cacheDB.get(i);
 				if(ch.is_black() == false &amp;&amp; ch.is_filtered() == false){
 					expCount++;
 					h.progress = (float)expCount/(float)counter;
 					h.changed();
-					if (needCacheDetails) holder = ch.getCacheDetails(false, false);
-					else holder.update(ch);
-					if (needCacheDetails &amp;&amp; holder == null) continue;
 					switch (this.howManyParams) {
 					case NO_PARAMS:
-						str = record(holder);
+						str = record(ch);
 						break;
 					case LAT_LON:
-						if (holder.pos.isValid() == false) continue;
-						str = record(holder, holder.pos.getLatDeg(CWPoint.DD).replace('.', this.decimalSeparator),
-								     holder.pos.getLonDeg(CWPoint.DD).replace('.', this.decimalSeparator));
+						if (ch.pos.isValid() == false) continue;
+						str = record(ch, ch.pos.getLatDeg(CWPoint.DD).replace('.', this.decimalSeparator),
+								     ch.pos.getLonDeg(CWPoint.DD).replace('.', this.decimalSeparator));
 						break;
 					case LAT_LON|COUNT: 
-						if (holder.pos.isValid() == false) continue;
-						str = record(holder, holder.pos.getLatDeg(CWPoint.DD).replace('.', this.decimalSeparator),
-									 holder.pos.getLonDeg(CWPoint.DD).replace('.', this.decimalSeparator),
+						if (ch.pos.isValid() == false) continue;
+						str = record(ch, ch.pos.getLatDeg(CWPoint.DD).replace('.', this.decimalSeparator),
+									 ch.pos.getLonDeg(CWPoint.DD).replace('.', this.decimalSeparator),
 											 i);
 						break;
 					default:
@@ -219,7 +214,7 @@
 	 * @param ch	cachedata
 	 * @return formated cache data
 	 */	
-	public String record(CacheHolderDetail chD){
+	public String record(CacheHolder chD){
 		return null;
 	}
 
@@ -230,7 +225,7 @@
 	 * @param lon
 	 * @return formated cache data
 	 */
-	public String record(CacheHolderDetail ch, String lat, String lon){
+	public String record(CacheHolder ch, String lat, String lon){
 		return null;
 	}
 	/**
@@ -241,7 +236,7 @@
 	 * @param count of actual record
 	 * @return formated cache data
 	 */
-	public String record(CacheHolderDetail ch, String lat, String lon, int count){
+	public String record(CacheHolder ch, String lat, String lon, int count){
 		return null;
 	}
 	

Modified: trunk/src/exp/GPXExporter.java
===================================================================
--- trunk/src/exp/GPXExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/GPXExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -50,9 +50,9 @@
 		return strBuf.toString();
 	}
 	
-	public String record(CacheHolderDetail ch, String lat, String lon, int counter) {
+	public String record(CacheHolder ch, String lat, String lon, int counter) {
 		StringBuffer strBuf = new StringBuffer(1000);
-
+		CacheHolderDetail det = ch.getExistingDetails();
 		try{
 			strBuf.append(&quot;  &lt;wpt lat=\&quot;&quot;+lat+&quot;\&quot; lon=\&quot;&quot;+lon+&quot;\&quot;&gt;\r\n&quot;);
 		
@@ -60,7 +60,7 @@
 			strBuf.append(&quot;    &lt;time&gt;&quot;).append(tim.toString()).append(&quot;T00:00:00.0000000-07:00&lt;/time&gt;\r\n&quot;);
 			strBuf.append(&quot;    &lt;name&gt;&quot;).append(ch.getWayPoint()).append(&quot;&lt;/name&gt;\r\n&quot;);
 			if (ch.isAddiWpt()){
-				strBuf.append(&quot;    &lt;cmt&gt;&quot;).append(SafeXML.cleanGPX(ch.LongDescription)).append(&quot;&lt;/cmt&gt;\r\n&quot;);
+				strBuf.append(&quot;    &lt;cmt&gt;&quot;).append(SafeXML.cleanGPX(det.LongDescription)).append(&quot;&lt;/cmt&gt;\r\n&quot;);
 			}
 			strBuf.append(&quot;    &lt;desc&gt;&quot;).append(SafeXML.cleanGPX(ch.getCacheName())).append(&quot; by &quot;).append(SafeXML.cleanGPX(ch.getCacheOwner())).append(&quot;&lt;/desc&gt;\r\n&quot;);
 			strBuf.append(&quot;    &lt;url&gt;<A HREF="http://www.geocaching.com/seek/cache_details.aspx?wp=">http://www.geocaching.com/seek/cache_details.aspx?wp=</A>&quot;).append(ch.getWayPoint()).append(&quot;&amp;Submit6=Find&lt;/url&gt;\r\n&quot;);
@@ -93,53 +93,53 @@
 				}
 				strBuf.append(&quot;      &lt;groundspeak:terrain&gt;&quot;).append(diffTerr).append(&quot;&lt;/groundspeak:terrain&gt;\r\n&quot;);
 				
-				strBuf.append(&quot;      &lt;groundspeak:country&gt;&quot;).append(SafeXML.cleanGPX(ch.Country)+&quot;&lt;/groundspeak:country&gt;\r\n&quot;);
-				strBuf.append(&quot;      &lt;groundspeak:state&gt;&quot;).append(SafeXML.cleanGPX(ch.State)+&quot;&lt;/groundspeak:state&gt;\r\n&quot;);
+				strBuf.append(&quot;      &lt;groundspeak:country&gt;&quot;).append(SafeXML.cleanGPX(det.Country)+&quot;&lt;/groundspeak:country&gt;\r\n&quot;);
+				strBuf.append(&quot;      &lt;groundspeak:state&gt;&quot;).append(SafeXML.cleanGPX(det.State)+&quot;&lt;/groundspeak:state&gt;\r\n&quot;);
 												
 				String dummyHTML = ch.is_HTML() ? STRING_TRUE:STRING_FALSE;
 				strBuf.append(&quot;      &lt;groundspeak:long_description html=\&quot;&quot; ).append( dummyHTML ).append( &quot;\&quot;&gt;\r\n&quot;);
-				strBuf.append(&quot;      &quot;).append(SafeXML.cleanGPX(ch.LongDescription));
+				strBuf.append(&quot;      &quot;).append(SafeXML.cleanGPX(det.LongDescription));
 				strBuf.append(&quot;      \n&lt;/groundspeak:long_description&gt;\r\n&quot;);
-				strBuf.append(&quot;	  &lt;groundspeak:encoded_hints&gt;&quot;).append(SafeXML.cleanGPX(Common.rot13(ch.Hints))).append(&quot;&lt;/groundspeak:encoded_hints&gt;\r\n&quot;);
+				strBuf.append(&quot;	  &lt;groundspeak:encoded_hints&gt;&quot;).append(SafeXML.cleanGPX(Common.rot13(det.Hints))).append(&quot;&lt;/groundspeak:encoded_hints&gt;\r\n&quot;);
 				strBuf.append(&quot;      &lt;groundspeak:logs&gt;\r\n&quot;);
 				if ( Global.getPref().exportGpxAsMyFinds &amp;&amp; ch.is_found() ) {
-					if ( ch.OwnLogId.length() != 0 ) {
-						strBuf.append(&quot;        &lt;groundspeak:log id=\&quot;&quot; ).append( ch.OwnLogId ).append( &quot;\&quot;&gt;\r\n&quot;);						
+					if ( det.OwnLogId.length() != 0 ) {
+						strBuf.append(&quot;        &lt;groundspeak:log id=\&quot;&quot; ).append( det.OwnLogId ).append( &quot;\&quot;&gt;\r\n&quot;);						
 					} else {
 						strBuf.append(&quot;        &lt;groundspeak:log id=\&quot;&quot; ).append( Integer.toString(counter) ).append( &quot;\&quot;&gt;\r\n&quot;);
 					}
 					strBuf.append(&quot;          &lt;groundspeak:date&gt;&quot;).append(SafeXML.cleanGPX(ch.GetStatusDate())).append(&quot;T&quot;).append(SafeXML.cleanGPX(ch.GetStatusTime())).append(&quot;:00&lt;/groundspeak:date&gt;\r\n&quot;);
-					if ( ch.OwnLog != null ) {
-						strBuf.append(&quot;          &lt;groundspeak:type&gt;&quot;).append(image2TypeText(ch.OwnLog.getIcon())).append(&quot;&lt;/groundspeak:type&gt;\r\n&quot;);
+					if ( det.OwnLog != null ) {
+						strBuf.append(&quot;          &lt;groundspeak:type&gt;&quot;).append(image2TypeText(det.OwnLog.getIcon())).append(&quot;&lt;/groundspeak:type&gt;\r\n&quot;);
 					} else {
 						strBuf.append(&quot;          &lt;groundspeak:type&gt;Found it&lt;/groundspeak:type&gt;\r\n&quot;);
 					}
 					strBuf.append(&quot;          &lt;groundspeak:finder id=\&quot;&quot;).append(SafeXML.cleanGPX(Global.getPref().gcMemberId)).append(&quot;\&quot;&gt;&quot;).append(SafeXML.cleanGPX(Global.getPref().myAlias)).append(&quot;&lt;/groundspeak:finder&gt;\r\n&quot;);
-					if ( ch.OwnLog != null ) {
-						strBuf.append(&quot;          &lt;groundspeak:text encoded=\&quot;False\&quot;&gt;&quot;).append(SafeXML.cleanGPX(ch.OwnLog.getMessage())).append(&quot;&lt;/groundspeak:text&gt;\r\n&quot;);
+					if ( det.OwnLog != null ) {
+						strBuf.append(&quot;          &lt;groundspeak:text encoded=\&quot;False\&quot;&gt;&quot;).append(SafeXML.cleanGPX(det.OwnLog.getMessage())).append(&quot;&lt;/groundspeak:text&gt;\r\n&quot;);
 					} else {
 						strBuf.append(&quot;          &lt;groundspeak:text encoded=\&quot;False\&quot;&gt;&lt;/groundspeak:text&gt;\r\n&quot;);		
 					}
 					strBuf.append(&quot;        &lt;/groundspeak:log&gt;\r\n&quot;);
 				} else {
-					int numberOfLogs = java.lang.Math.min(Global.getPref().numberOfLogsToExport, ch.CacheLogs.size());
-					if (numberOfLogs &lt; 0) numberOfLogs = ch.CacheLogs.size();
+					int numberOfLogs = java.lang.Math.min(Global.getPref().numberOfLogsToExport, det.CacheLogs.size());
+					if (numberOfLogs &lt; 0) numberOfLogs = det.CacheLogs.size();
 					for (int i = 0; i &lt; numberOfLogs; i++) {
 						strBuf.append(&quot;        &lt;groundspeak:log id=\&quot;&quot; ).append( Integer.toString(i) ).append( &quot;\&quot;&gt;\r\n&quot;);
-						strBuf.append(&quot;          &lt;groundspeak:date&gt;&quot;).append(SafeXML.cleanGPX(ch.CacheLogs.getLog(i).getDate())).append(&quot;T00:00:00&lt;/groundspeak:date&gt;\r\n&quot;);
-						strBuf.append(&quot;          &lt;groundspeak:type&gt;&quot;).append(image2TypeText(ch.CacheLogs.getLog(i).getIcon())).append(&quot;&lt;/groundspeak:type&gt;\r\n&quot;);
-						strBuf.append(&quot;          &lt;groundspeak:finder id=\&quot;\&quot;&gt;&quot;).append(SafeXML.cleanGPX(ch.CacheLogs.getLog(i).getLogger())).append(&quot;&lt;/groundspeak:finder&gt;\r\n&quot;);
-						strBuf.append(&quot;          &lt;groundspeak:text encoded=\&quot;False\&quot;&gt;&quot;).append(SafeXML.cleanGPX(ch.CacheLogs.getLog(i).getMessage())).append(&quot;&lt;/groundspeak:text&gt;\r\n&quot;);
+						strBuf.append(&quot;          &lt;groundspeak:date&gt;&quot;).append(SafeXML.cleanGPX(det.CacheLogs.getLog(i).getDate())).append(&quot;T00:00:00&lt;/groundspeak:date&gt;\r\n&quot;);
+						strBuf.append(&quot;          &lt;groundspeak:type&gt;&quot;).append(image2TypeText(det.CacheLogs.getLog(i).getIcon())).append(&quot;&lt;/groundspeak:type&gt;\r\n&quot;);
+						strBuf.append(&quot;          &lt;groundspeak:finder id=\&quot;\&quot;&gt;&quot;).append(SafeXML.cleanGPX(det.CacheLogs.getLog(i).getLogger())).append(&quot;&lt;/groundspeak:finder&gt;\r\n&quot;);
+						strBuf.append(&quot;          &lt;groundspeak:text encoded=\&quot;False\&quot;&gt;&quot;).append(SafeXML.cleanGPX(det.CacheLogs.getLog(i).getMessage())).append(&quot;&lt;/groundspeak:text&gt;\r\n&quot;);
 						strBuf.append(&quot;        &lt;/groundspeak:log&gt;\r\n&quot;);
 					}
 				}
 				strBuf.append(&quot;      &lt;/groundspeak:logs&gt;\r\n&quot;);
-				if ( Global.getPref().exportTravelbugs &amp;&amp; (ch.Travelbugs.size() &gt; 0) ) {
-					ch.Travelbugs.size();
+				if ( Global.getPref().exportTravelbugs &amp;&amp; (det.Travelbugs.size() &gt; 0) ) {
+					det.Travelbugs.size();
 					strBuf.append(&quot;      &lt;groundspeak:travelbugs&gt;\r\n&quot;);
-					for (int i = 0; i &lt; ch.Travelbugs.size(); i++) {
+					for (int i = 0; i &lt; det.Travelbugs.size(); i++) {
 						strBuf.append(&quot;        &lt;groundspeak:travelbug id=\&quot;&quot;).append(Integer.toString(i)).append(&quot;\&quot; ref=\&quot;\&quot;&gt;\r\n&quot;);
-						strBuf.append(&quot;          &lt;groundspeak:name&gt;&quot;).append(SafeXML.cleanGPX(ch.Travelbugs.getTB(i).getName())).append(&quot;&lt;/groundspeak:name&gt;\r\n&quot;);
+						strBuf.append(&quot;          &lt;groundspeak:name&gt;&quot;).append(SafeXML.cleanGPX(det.Travelbugs.getTB(i).getName())).append(&quot;&lt;/groundspeak:name&gt;\r\n&quot;);
 						strBuf.append(&quot;        &lt;/groundspeak:travelbug&gt;\r\n&quot;);						
 					}
 					strBuf.append(&quot;      &lt;/groundspeak:travelbugs&gt;\r\n&quot;);					

Modified: trunk/src/exp/HTMLExporter.java
===================================================================
--- trunk/src/exp/HTMLExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/HTMLExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -40,7 +40,7 @@
 	}
 	
 	public void doIt(){
-		CacheHolderDetail holder;
+		CacheHolderDetail det;
 		CacheHolder ch;
 		ProgressBarForm pbf = new ProgressBarForm();
 		Handle h = new Handle();
@@ -83,63 +83,63 @@
 
 				ch = cacheDB.get(i);
 				if(	ch.is_black() == false &amp;&amp; ch.is_filtered() == false){
-					holder=ch.getCacheDetails(false,true);
+					det=ch.getExistingDetails();
 					varParams = new Hashtable();
-					varParams.put(&quot;TYPE&quot;, CacheType.transType(holder.getType()));
-					varParams.put(&quot;SIZE&quot;, holder.getCacheSize());
-					varParams.put(&quot;WAYPOINT&quot;, holder.getWayPoint());
-					varParams.put(&quot;NAME&quot;, holder.getCacheName());
-					varParams.put(&quot;OWNER&quot;, holder.getCacheOwner());
-					varParams.put(&quot;DIFFICULTY&quot;, holder.getHard());
-					varParams.put(&quot;TERRAIN&quot;, holder.getTerrain());
-					varParams.put(&quot;DISTANCE&quot;, holder.getDistance());
-					varParams.put(&quot;BEARING&quot;, holder.bearing);
-					varParams.put(&quot;LATLON&quot;, holder.LatLon);
-					varParams.put(&quot;STATUS&quot;, holder.getCacheStatus());
-					varParams.put(&quot;DATE&quot;, holder.getDateHidden());
+					varParams.put(&quot;TYPE&quot;, CacheType.transType(ch.getType()));
+					varParams.put(&quot;SIZE&quot;, ch.getCacheSize());
+					varParams.put(&quot;WAYPOINT&quot;, ch.getWayPoint());
+					varParams.put(&quot;NAME&quot;, ch.getCacheName());
+					varParams.put(&quot;OWNER&quot;, ch.getCacheOwner());
+					varParams.put(&quot;DIFFICULTY&quot;, ch.getHard());
+					varParams.put(&quot;TERRAIN&quot;, ch.getTerrain());
+					varParams.put(&quot;DISTANCE&quot;, ch.getDistance());
+					varParams.put(&quot;BEARING&quot;, ch.bearing);
+					varParams.put(&quot;LATLON&quot;, ch.LatLon);
+					varParams.put(&quot;STATUS&quot;, ch.getCacheStatus());
+					varParams.put(&quot;DATE&quot;, ch.getDateHidden());
 					cache_index.add(varParams);
 					//We can generate the individual page here!
 					try{
 						Template page_tpl = new Template(template_init_page);
-						page_tpl.setParam(&quot;TYPE&quot;, CacheType.transType(holder.getType()));
-						page_tpl.setParam(&quot;SIZE&quot;, holder.getCacheSize());
-						page_tpl.setParam(&quot;WAYPOINT&quot;, holder.getWayPoint());
-						page_tpl.setParam(&quot;NAME&quot;, holder.getCacheName());
-						page_tpl.setParam(&quot;OWNER&quot;, holder.getCacheOwner());
-						page_tpl.setParam(&quot;DIFFICULTY&quot;, holder.getHard());
-						page_tpl.setParam(&quot;TERRAIN&quot;, holder.getTerrain());
-						page_tpl.setParam(&quot;DISTANCE&quot;, holder.getDistance());
-						page_tpl.setParam(&quot;BEARING&quot;, holder.bearing);
-						page_tpl.setParam(&quot;LATLON&quot;, holder.LatLon);
-						page_tpl.setParam(&quot;STATUS&quot;, holder.getCacheStatus());
-						page_tpl.setParam(&quot;DATE&quot;, holder.getDateHidden());
-						if (holder.is_HTML())
-							page_tpl.setParam(&quot;DESCRIPTION&quot;, modifyLongDesc(holder,targetDir));
+						page_tpl.setParam(&quot;TYPE&quot;, CacheType.transType(ch.getType()));
+						page_tpl.setParam(&quot;SIZE&quot;, ch.getCacheSize());
+						page_tpl.setParam(&quot;WAYPOINT&quot;, ch.getWayPoint());
+						page_tpl.setParam(&quot;NAME&quot;, ch.getCacheName());
+						page_tpl.setParam(&quot;OWNER&quot;, ch.getCacheOwner());
+						page_tpl.setParam(&quot;DIFFICULTY&quot;, ch.getHard());
+						page_tpl.setParam(&quot;TERRAIN&quot;, ch.getTerrain());
+						page_tpl.setParam(&quot;DISTANCE&quot;, ch.getDistance());
+						page_tpl.setParam(&quot;BEARING&quot;, ch.bearing);
+						page_tpl.setParam(&quot;LATLON&quot;, ch.LatLon);
+						page_tpl.setParam(&quot;STATUS&quot;, ch.getCacheStatus());
+						page_tpl.setParam(&quot;DATE&quot;, ch.getDateHidden());
+						if (ch.is_HTML())
+							page_tpl.setParam(&quot;DESCRIPTION&quot;, modifyLongDesc(det,targetDir));
 						else {
 							String dummyText = new String();
-							dummyText = STRreplace.replace(holder.LongDescription, &quot;\n&quot;, &quot;&lt;br&gt;&quot;);
+							dummyText = STRreplace.replace(det.LongDescription, &quot;\n&quot;, &quot;&lt;br&gt;&quot;);
 							page_tpl.setParam(&quot;DESCRIPTION&quot;,dummyText);
 							
 						}
-						page_tpl.setParam(&quot;HINTS&quot;, holder.Hints);
-						page_tpl.setParam(&quot;DECRYPTEDHINTS&quot;, Common.rot13(holder.Hints));
+						page_tpl.setParam(&quot;HINTS&quot;, det.Hints);
+						page_tpl.setParam(&quot;DECRYPTEDHINTS&quot;, Common.rot13(det.Hints));
 						StringBuffer sb=new StringBuffer(2000);
-						for(int j = 0; j&lt;holder.CacheLogs.size(); j++){
-							sb.append(STRreplace.replace(holder.CacheLogs.getLog(j).toHtml(),&quot;<A HREF="http://www.geocaching.com/images/icons/">http://www.geocaching.com/images/icons/</A>&quot;,null));
+						for(int j = 0; j&lt;det.CacheLogs.size(); j++){
+							sb.append(STRreplace.replace(det.CacheLogs.getLog(j).toHtml(),&quot;<A HREF="http://www.geocaching.com/images/icons/">http://www.geocaching.com/images/icons/</A>&quot;,null));
 							sb.append(&quot;&lt;br&gt;&quot;);
-							icon=holder.CacheLogs.getLog(j).getIcon();
+							icon=det.CacheLogs.getLog(j).getIcon();
 							if (logIcons.find(icon)&lt;0) logIcons.add(icon); // Add the icon to list of icons to copy to dest directory
 						}
 						page_tpl.setParam(&quot;LOGS&quot;, sb.toString());
-						page_tpl.setParam(&quot;NOTES&quot;, STRreplace.replace(holder.CacheNotes, &quot;\n&quot;,&quot;&lt;br&gt;&quot;)); 
+						page_tpl.setParam(&quot;NOTES&quot;, STRreplace.replace(det.CacheNotes, &quot;\n&quot;,&quot;&lt;br&gt;&quot;)); 
 						// Cache Images
 						cacheImg.clear();
-						for(int j = 0; j&lt;holder.Images.size(); j++){
+						for(int j = 0; j&lt;det.Images.size(); j++){
 							imgParams = new Hashtable();
-							String imgFile = new String((String)holder.Images.get(j));
+							String imgFile = new String((String)det.Images.get(j));
 							imgParams.put(&quot;FILE&quot;, imgFile);
-							if (j &lt; holder.ImagesText.size())
-								imgParams.put(&quot;TEXT&quot;,holder.ImagesText.get(j));
+							if (j &lt; det.ImagesText.size())
+								imgParams.put(&quot;TEXT&quot;,det.ImagesText.get(j));
 							else
 								imgParams.put(&quot;TEXT&quot;,imgFile);
 							DataMover.copy(profile.dataDir + imgFile,targetDir + imgFile);
@@ -148,12 +148,12 @@
 						page_tpl.setParam(&quot;cacheImg&quot;, cacheImg);
 						// Log images
 						logImg.clear();
-						for(int j = 0; j&lt;holder.LogImages.size(); j++){
+						for(int j = 0; j&lt;det.LogImages.size(); j++){
 							logImgParams = new Hashtable();
-							String logImgFile = (String) holder.LogImages.get(j);
+							String logImgFile = (String) det.LogImages.get(j);
 							logImgParams.put(&quot;FILE&quot;, logImgFile);
-							if (j &lt; holder.LogImagesText.size())
-								logImgParams.put(&quot;TEXT&quot;,holder.LogImagesText.get(j));
+							if (j &lt; det.LogImagesText.size())
+								logImgParams.put(&quot;TEXT&quot;,det.LogImagesText.get(j));
 							else
 								logImgParams.put(&quot;TEXT&quot;,logImgFile);
 							DataMover.copy(profile.dataDir + logImgFile,targetDir + logImgFile);
@@ -162,12 +162,12 @@
 						page_tpl.setParam(&quot;logImg&quot;, logImg);
 						// User images
 						usrImg.clear();
-						for(int j = 0; j&lt;holder.UserImages.size(); j++){
+						for(int j = 0; j&lt;det.UserImages.size(); j++){
 							usrImgParams = new Hashtable();
-							String usrImgFile = new String((String)holder.UserImages.get(j));
+							String usrImgFile = new String((String)det.UserImages.get(j));
 							usrImgParams.put(&quot;FILE&quot;, usrImgFile);
-							if (j &lt; holder.UserImagesText.size())
-								usrImgParams.put(&quot;TEXT&quot;,holder.UserImagesText.get(j));
+							if (j &lt; det.UserImagesText.size())
+								usrImgParams.put(&quot;TEXT&quot;,det.UserImagesText.get(j));
 							else
 								usrImgParams.put(&quot;TEXT&quot;,usrImgFile);
 							DataMover.copy(profile.dataDir + usrImgFile,targetDir + usrImgFile);
@@ -178,7 +178,7 @@
 						// Map images
 						mapImg.clear();
 						mapImgParams = new Hashtable();
-						String mapImgFile = new String(holder.getWayPoint() + &quot;_map.gif&quot;);
+						String mapImgFile = new String(ch.getWayPoint() + &quot;_map.gif&quot;);
 						// check if map file exists
 						File test = new File(profile.dataDir + mapImgFile);
 						if (test.exists()) {
@@ -188,7 +188,7 @@
 							mapImg.add(mapImgParams);
 							
 							mapImgParams = new Hashtable();
-							mapImgFile = holder.getWayPoint() + &quot;_map_2.gif&quot;;
+							mapImgFile = ch.getWayPoint() + &quot;_map_2.gif&quot;;
 							mapImgParams.put(&quot;FILE&quot;, mapImgFile);
 							mapImgParams.put(&quot;TEXT&quot;,mapImgFile);
 							DataMover.copy(profile.dataDir + mapImgFile,targetDir + mapImgFile);
@@ -198,7 +198,7 @@
 						}
 
 						
-						PrintWriter pagefile = new PrintWriter(new BufferedWriter(new FileWriter(targetDir + holder.getWayPoint()+&quot;.html&quot;)));
+						PrintWriter pagefile = new PrintWriter(new BufferedWriter(new FileWriter(targetDir + ch.getWayPoint()+&quot;.html&quot;)));
 						pagefile.print(page_tpl.output());
 						pagefile.close();
 					}catch(Exception e){

Modified: trunk/src/exp/KMLExporter.java
===================================================================
--- trunk/src/exp/KMLExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/KMLExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -109,30 +109,23 @@
 						h.progress = (float)expCount/(float)counter;
 						h.changed();
 						
-						holder=new CacheHolderDetail(ch);
-						try {
-							holder.readCache(profile.dataDir);
-						} catch (IOException e) {
-							continue;
-						}
-						if (holder.pos.isValid()){
-							str = record(holder, holder.pos.getLatDeg(CWPoint.DD).replace('.', this.decimalSeparator),
-								     holder.pos.getLonDeg(CWPoint.DD).replace('.', this.decimalSeparator));
+						if (ch.pos.isValid()){
+							str = record(ch, ch.pos.getLatDeg(CWPoint.DD).replace('.', this.decimalSeparator),
+								     ch.pos.getLonDeg(CWPoint.DD).replace('.', this.decimalSeparator));
 							if (str != null) outp.print(str);
 						}
 						if (ch.hasAddiWpt()){
 							boolean createdAdditionalWaypointsFolder = false;
 							for(int j = 0; j&lt;ch.addiWpts.size(); j++){
 								addiWpt = (CacheHolder) ch.addiWpts.get(j);
-								holder=new CacheHolderDetail(addiWpt);
 								expCount++;
-								if (holder.pos.isValid() &amp;&amp;  ! holder.is_filtered()){
+								if (ch.pos.isValid() &amp;&amp;  ! addiWpt.is_filtered()){
 									if (! createdAdditionalWaypointsFolder) {
 										outp.print(startFolder(&quot;Additional Waypoints&quot;, false));
 										createdAdditionalWaypointsFolder = true;
 									}
-									str = record(holder, holder.pos.getLatDeg(CWPoint.DD).replace('.', this.decimalSeparator),
-										     holder.pos.getLonDeg(CWPoint.DD).replace('.', this.decimalSeparator));
+									str = record(addiWpt, addiWpt.pos.getLatDeg(CWPoint.DD).replace('.', this.decimalSeparator),
+											addiWpt.pos.getLonDeg(CWPoint.DD).replace('.', this.decimalSeparator));
 									if (str != null) outp.print(str);
 								}
 								
@@ -272,12 +265,13 @@
 	}
 
 
-	public String record(CacheHolderDetail ch, String lat, String lon){
+	public String record(CacheHolder ch, String lat, String lon){
 		StringBuffer strBuf = new StringBuffer(200);
+		CacheHolderDetail det = ch.getExistingDetails();
 		
 		strBuf.append(&quot;   &lt;Placemark&gt;\r\n&quot;);
-		if (ch.URL != null){
-			strBuf.append(&quot;      &lt;description&gt;&quot;+SafeXML.clean(ch.URL)+&quot;&lt;/description&gt;\r\n&quot;);
+		if (det.URL != null){
+			strBuf.append(&quot;      &lt;description&gt;&quot;+SafeXML.clean(det.URL)+&quot;&lt;/description&gt;\r\n&quot;);
 		}
 		strBuf.append(&quot;      &lt;name&gt;&quot;+ ch.getWayPoint() + &quot; - &quot; + SafeXML.clean(ch.getCacheName()) +&quot;&lt;/name&gt;\r\n&quot;);
 		strBuf.append(&quot;      &lt;LookAt&gt;\r\n&quot;);
@@ -313,7 +307,7 @@
 		return strBuf.toString();
 	}
 	
-	private String getColor(CacheHolderDetail ch){
+	private String getColor(CacheHolder ch){
 		if (ch.is_found()) return COLOR_FOUND;
 		if (ch.is_owned()) return COLOR_OWNED;
 		if (ch.is_archived() || !ch.is_available()) return COLOR_NOT_AVAILABLE;

Modified: trunk/src/exp/LocExporter.java
===================================================================
--- trunk/src/exp/LocExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/LocExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -35,14 +35,16 @@
 		return &quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&lt;loc version=\&quot;1.0\&quot; src=\&quot;EasyGPS\&quot;&gt;\r\n&quot;;
 	}
 	
-	public String record(CacheHolderDetail chD){
+	public String record(CacheHolder ch){
+		CacheHolderDetail det = ch.getExistingDetails();
+		
 		// filter out not valid coords
-		if (!chD.pos.isValid()) return null;
+		if (!ch.pos.isValid()) return null;
 		StringBuffer strBuf = new StringBuffer(200);
 		strBuf.append(&quot;&lt;waypoint&gt;\r\n   &lt;name id=\&quot;&quot;);
-		String wptName=simplifyString(chD.getWayPoint());
+		String wptName=simplifyString(ch.getWayPoint());
 		if (Global.getPref().addDetailsToWaypoint) {
-			wptName += getShortDetails( chD );			
+			wptName += getShortDetails( ch );			
 		}
 		if (Global.getPref().garminMaxLen==0)
 			strBuf.append(wptName);
@@ -52,25 +54,25 @@
 			} catch (Exception ex){ pref.log(&quot;Invalid value for garmin.MaxWaypointLength&quot;); }
 		}
 		strBuf.append(&quot;\&quot;&gt;&lt;![CDATA[&quot;);
-		strBuf.append(simplifyString(chD.getCacheName()));
+		strBuf.append(simplifyString(ch.getCacheName()));
 		if (Global.getPref().addDetailsToName) {
 			if ( !Global.getPref().addDetailsToWaypoint ) {
-				strBuf.append( getShortDetails( chD ) );
+				strBuf.append( getShortDetails( ch ) );
 			}
-			if ( (!chD.Hints.equals(&quot;null&quot;)) &amp;&amp; (chD.Hints.length() &gt; 0) ) {
+			if ( (!det.Hints.equals(&quot;null&quot;)) &amp;&amp; (det.Hints.length() &gt; 0) ) {
 				strBuf.append(&quot;:&quot;);
-				strBuf.append( simplifyString(Common.rot13(chD.Hints)) );			
+				strBuf.append( simplifyString(Common.rot13(det.Hints)) );			
 			}
 		}
 		strBuf.append(&quot;]]&gt;&lt;/name&gt;\r\n   &lt;coord lat=\&quot;&quot;);
-		strBuf.append(chD.pos.getLatDeg(CWPoint.DD));
+		strBuf.append(ch.pos.getLatDeg(CWPoint.DD));
 		strBuf.append(&quot;\&quot; lon=\&quot;&quot;);
-		strBuf.append(chD.pos.getLonDeg(CWPoint.DD));
+		strBuf.append(ch.pos.getLonDeg(CWPoint.DD));
 		strBuf.append(&quot;\&quot;/&gt;\r\n   &lt;type&gt;&quot;);
 		if (gm!=null) {
-			strBuf.append(gm.getIcon(chD));
+			strBuf.append(gm.getIcon(ch));
 		} else {
-			if (chD.is_found())
+			if (ch.is_found())
 				strBuf.append(&quot;Geocache Found&quot;);
 			else
 				strBuf.append(&quot;Geocache&quot;);
@@ -115,19 +117,19 @@
 			}
 		}		
 		
-		public String getIcon(CacheHolderDetail chD) {
+		public String getIcon(CacheHolder ch) {
 			// First check if there is a mapping for &quot;cache found&quot;
-			if (chD.is_found()) {
+			if (ch.is_found()) {
 				for (int i=0; i&lt;mapSize; i++)
 					// TODO Geht das noch sch&#246;ner...? ................ &lt;------------------------------&gt;
-					if (symbols[i].onlyIfFound!=null &amp;&amp; symbols[i].type.equals(String.valueOf(chD.getType()))) return symbols[i].name;
+					if (symbols[i].onlyIfFound!=null &amp;&amp; symbols[i].type.equals(String.valueOf(ch.getType()))) return symbols[i].name;
 			}
 			// Now try mapping the cache irrespective of the &quot;found&quot; status
 			for (int i=0; i&lt;mapSize; i++)
-				if (symbols[i].type.equals(String.valueOf(chD.getType()))) return symbols[i].name;
+				if (symbols[i].type.equals(String.valueOf(ch.getType()))) return symbols[i].name;
 		
 			// If it is not a mapped type, just use the standard mapping
-			if (chD.is_found())
+			if (ch.is_found())
 				return &quot;Geocache Found&quot;;
 			else
 				return &quot;Geocache&quot;;

Modified: trunk/src/exp/MSARCSVExporter.java
===================================================================
--- trunk/src/exp/MSARCSVExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/MSARCSVExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -22,7 +22,7 @@
 		return &quot;Name;Breitengrad;L\u00E4ngengrad;Typ1;Typ2;Waypoint;Datum;Hyperlink\r&quot;;
 	}
 
-	public String record(CacheHolderDetail ch, String lat, String lon) {
+	public String record(CacheHolder ch, String lat, String lon) {
 		StringBuffer str = new StringBuffer(200);
 		str.append(&quot;\&quot;&quot; + ch.getWayPoint() + &quot; - &quot; + ch.getCacheName() + &quot;\&quot;;&quot;);
 		str.append(lat + &quot;;&quot; + lon +&quot;;&quot;);
@@ -30,7 +30,7 @@
 		str.append(&quot;\&quot;&quot; + ch.getCacheSize() + &quot;\&quot;;&quot;);
 		str.append(&quot;\&quot;&quot; + ch.getWayPoint() + &quot;\&quot;;&quot;);
 		str.append(&quot;\&quot;&quot; + ch.getDateHidden() + &quot;\&quot;;&quot;);
-		str.append(&quot;\&quot;&quot; + ch.URL + &quot;\&quot;\r\n&quot;);
+		str.append(&quot;\&quot;&quot; + ch.getExistingDetails().URL + &quot;\&quot;\r\n&quot;);
 
 		return str.toString();
 	}

Modified: trunk/src/exp/OVLExporter.java
===================================================================
--- trunk/src/exp/OVLExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/OVLExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -14,7 +14,7 @@
 		this.setHowManyParams(LAT_LON|COUNT);
 	}
 	
-	public String record(CacheHolderDetail ch, String lat, String lon, int counter){
+	public String record(CacheHolder ch, String lat, String lon, int counter){
 		StringBuffer str = new StringBuffer(200);
 		double tmp;
 		str.append(&quot;[Symbol &quot;+Convert.toString(2*counter + 1)+&quot;]\r\n&quot;);

Modified: trunk/src/exp/OziExporter.java
===================================================================
--- trunk/src/exp/OziExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/OziExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -23,7 +23,7 @@
 		return strBuf.toString();
 	}
 
-	public String record(CacheHolderDetail ch, String lat, String lon){
+	public String record(CacheHolder ch, String lat, String lon){
 		StringBuffer strBuf = new StringBuffer(200);
 		String tmpName;
 

Modified: trunk/src/exp/PCX5Exporter.java
===================================================================
--- trunk/src/exp/PCX5Exporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/PCX5Exporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -34,7 +34,7 @@
 		return strBuf.toString();
 	}
 	
-	public String record(CacheHolderDetail ch){
+	public String record(CacheHolder ch){
 		StringBuffer strBuf = new StringBuffer(200);
 		String latlonstr, dummy;
 

Modified: trunk/src/exp/TPLExporter.java
===================================================================
--- trunk/src/exp/TPLExporter.java	2009-04-14 08:37:14 UTC (rev 1747)
+++ trunk/src/exp/TPLExporter.java	2009-04-17 16:41:09 UTC (rev 1748)
@@ -146,7 +146,7 @@
 	}
 	
 	public void doIt(){
-		CacheHolderDetail holder;
+		CacheHolderDetail det;
 		CacheHolder ch;
 		ProgressBarForm pbf = new ProgressBarForm();
 		ewe.sys.Handle h = new ewe.sys.Handle();
@@ -184,56 +184,50 @@
 
 			for(int i = 0; i&lt;counter;i++){
 				ch = cacheDB.get(i);
+				det = ch.getExistingDetails();
 				h.progress = (float)i/(float)counter;
 				h.changed();
 				if(ch.is_black() == false &amp;&amp; ch.is_filtered() == false){
 					if (ch.pos.isValid() == false) continue;
-					holder=new CacheHolderDetail(ch);
-					try{
-						holder.readCache(profile.dataDir);
-					}catch(Exception e){
-						Vm.debug(&quot;Problem reading cache page&quot;);
-						Global.getPref().log(&quot;Exception in TplExporter = Problem reading cache page, Cache: &quot; + holder.getWayPoint(), e, true);
-					}
 					try {
 						Regex dec = new Regex(&quot;[,.]&quot;,myFilter.decSep);
 						if (myFilter.badChars != null) rex = new Regex(&quot;[&quot;+myFilter.badChars+&quot;]&quot;,&quot;&quot;);
 						varParams = new Hashtable();
-						varParams.put(&quot;TYPE&quot;, CacheType.transType(holder.getType()));
-						varParams.put(&quot;SHORTTYPE&quot;, CacheType.transType(holder.getType()).substring(0,1));
-						varParams.put(&quot;SIZE&quot;, holder.getCacheSize());
-						varParams.put(&quot;SHORTSIZE&quot;, holder.getCacheSize().substring(0,1));
-						varParams.put(&quot;WAYPOINT&quot;, holder.getWayPoint());
-						varParams.put(&quot;OWNER&quot;, holder.getCacheOwner());
-						varParams.put(&quot;DIFFICULTY&quot;, dec.replaceAll(holder.getHard()));
-						varParams.put(&quot;TERRAIN&quot;, dec.replaceAll(holder.getTerrain()));
-						varParams.put(&quot;DISTANCE&quot;, dec.replaceAll(holder.getDistance()));
-						varParams.put(&quot;BEARING&quot;, holder.bearing);
-						varParams.put(&quot;LATLON&quot;, holder.LatLon);
-						varParams.put(&quot;LAT&quot;, dec.replaceAll(holder.pos.getLatDeg(CWPoint.DD)));
-						varParams.put(&quot;LON&quot;, dec.replaceAll(holder.pos.getLonDeg(CWPoint.DD)));
-						varParams.put(&quot;STATUS&quot;, holder.getCacheStatus());
-						varParams.put(&quot;STATUS_DATE&quot;, holder.GetStatusDate());
-						varParams.put(&quot;STATUS_TIME&quot;, holder.GetStatusTime());
-						varParams.put(&quot;DATE&quot;, holder.getDateHidden());
-						varParams.put(&quot;URL&quot;, holder.URL);
-						varParams.put(&quot;DESCRIPTION&quot;, holder.LongDescription);
+						varParams.put(&quot;TYPE&quot;, CacheType.transType(ch.getType()));
+						varParams.put(&quot;SHORTTYPE&quot;, CacheType.transType(ch.getType()).substring(0,1));
+						varParams.put(&quot;SIZE&quot;, ch.getCacheSize());
+						varParams.put(&quot;SHORTSIZE&quot;, ch.getCacheSize().substring(0,1));
+						varParams.put(&quot;WAYPOINT&quot;, ch.getWayPoint());
+						varParams.put(&quot;OWNER&quot;, ch.getCacheOwner());
+						varParams.put(&quot;DIFFICULTY&quot;, dec.replaceAll(ch.getHard()));
+						varParams.put(&quot;TERRAIN&quot;, dec.replaceAll(ch.getTerrain()));
+						varParams.put(&quot;DISTANCE&quot;, dec.replaceAll(ch.getDistance()));
+						varParams.put(&quot;BEARING&quot;, ch.bearing);
+						varParams.put(&quot;LATLON&quot;, ch.LatLon);
+						varParams.put(&quot;LAT&quot;, dec.replaceAll(ch.pos.getLatDeg(CWPoint.DD)));
+						varParams.put(&quot;LON&quot;, dec.replaceAll(ch.pos.getLonDeg(CWPoint.DD)));
+						varParams.put(&quot;STATUS&quot;, ch.getCacheStatus());
+						varParams.put(&quot;STATUS_DATE&quot;, ch.GetStatusDate());
+						varParams.put(&quot;STATUS_TIME&quot;, ch.GetStatusTime());
+						varParams.put(&quot;DATE&quot;, ch.getDateHidden());
+						varParams.put(&quot;URL&quot;, det.URL);
+						varParams.put(&quot;DESCRIPTION&quot;, det.LongDescription);
 						if (myFilter.badChars != null) {
-							varParams.put(&quot;NAME&quot;, rex.replaceAll(holder.getCacheName()));
-							varParams.put(&quot;NOTES&quot;, rex.replaceAll(holder.CacheNotes));
-							varParams.put(&quot;HINTS&quot;, rex.replaceAll(holder.Hints));
-							varParams.put(&quot;DECRYPTEDHINTS&quot;, rex.replaceAll(Common.rot13(holder.Hints)));
+							varParams.put(&quot;NAME&quot;, rex.replaceAll(ch.getCacheName()));
+							varParams.put(&quot;NOTES&quot;, rex.replaceAll(det.CacheNotes));
+							varParams.put(&quot;HINTS&quot;, rex.replaceAll(det.Hints));
+							varParams.put(&quot;DECRYPTEDHINTS&quot;, rex.replaceAll(Common.rot13(det.Hints)));
 						} else {
-							varParams.put(&quot;NAME&quot;, holder.getCacheName());
-							varParams.put(&quot;NOTES&quot;, holder.CacheNotes);
-							varParams.put(&quot;HINTS&quot;, holder.Hints);
-							varParams.put(&quot;DECRYPTEDHINTS&quot;, Common.rot13(holder.Hints));
+							varParams.put(&quot;NAME&quot;, ch.getCacheName());
+							varParams.put(&quot;NOTES&quot;, det.CacheNotes);
+							varParams.put(&quot;HINTS&quot;, det.Hints);
+							varParams.put(&quot;DECRYPTEDHINTS&quot;, Common.rot13(det.Hints));
 						}
 						cache_index.add(varParams);
 					}catch(Exception e){
-						Vm.debug(&quot;Problem getting Parameter, Cache: &quot; + holder.getWayPoint());
+						Vm.debug(&quot;Problem getting Parameter, Cache: &quot; + ch.getWayPoint());
 						e.printStackTrace();
-						Global.getPref().log(&quot;Exception in TplExporter = Problem getting Parameter, Cache: &quot; + holder.getWayPoint(), e, true);
+						Global.getPref().log(&quot;Exception in TplExporter = Problem getting Parameter, Cache: &quot; + ch.getWayPoint(), e, true);
 					}
 				}
 			}


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001665.html">[Cachewolf-svn] r1747 - trunk/src/CacheWolf
</A></li>
	<LI>Next message: <A HREF="001667.html">[Cachewolf-svn] r1749 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1666">[ date ]</a>
              <a href="thread.html#1666">[ thread ]</a>
              <a href="subject.html#1666">[ subject ]</a>
              <a href="author.html#1666">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
