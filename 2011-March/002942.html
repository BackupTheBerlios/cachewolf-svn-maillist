<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r2951 - in trunk: res_noewe res_noewe/languages	src/CacheWolf/exp src/CacheWolf/imp src/CacheWolf/navi
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2011-March/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2951%20-%20in%20trunk%3A%20res_noewe%20res_noewe/languages%0A%09src/CacheWolf/exp%20src/CacheWolf/imp%20src/CacheWolf/navi&In-Reply-To=%3C20110308205734.95AE2481120%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002941.html">
   <LINK REL="Next"  HREF="002945.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r2951 - in trunk: res_noewe res_noewe/languages	src/CacheWolf/exp src/CacheWolf/imp src/CacheWolf/navi</H1>
    <B>araber95 at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2951%20-%20in%20trunk%3A%20res_noewe%20res_noewe/languages%0A%09src/CacheWolf/exp%20src/CacheWolf/imp%20src/CacheWolf/navi&In-Reply-To=%3C20110308205734.95AE2481120%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r2951 - in trunk: res_noewe res_noewe/languages	src/CacheWolf/exp src/CacheWolf/imp src/CacheWolf/navi">araber95 at mail.berlios.de
       </A><BR>
    <I>Tue Mar  8 09:57:34 CET 2011</I>
    <P><UL>
        <LI>Previous message: <A HREF="002941.html">[Cachewolf-svn] r2950 - in trunk: res_noewe src/CacheWolf	src/CacheWolf/imp
</A></li>
        <LI>Next message: <A HREF="002945.html">[Cachewolf-svn] r2954 - trunk/res_noewe
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2942">[ date ]</a>
              <a href="thread.html#2942">[ thread ]</a>
              <a href="subject.html#2942">[ subject ]</a>
              <a href="author.html#2942">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: araber95
Date: 2011-03-08 21:57:34 +0100 (Tue, 08 Mar 2011)
New Revision: 2951

Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/res_noewe/languages/PL.cfg
   trunk/res_noewe/languages/SV.cfg
   trunk/res_noewe/spider.def
   trunk/src/CacheWolf/exp/LocExporter.java
   trunk/src/CacheWolf/exp/OziExporter.java
   trunk/src/CacheWolf/imp/GCVoteImporter.java
   trunk/src/CacheWolf/imp/GPXImporter.java
   trunk/src/CacheWolf/navi/Area.java
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/MapLoaderGui.java
   trunk/src/CacheWolf/navi/MovingMap.java
Log:
1. choice : download maptile only if there is a cache
2. spider.def: update 1 (size) after gc update of today

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/res_noewe/languages/DE.cfg	2011-03-08 20:57:34 UTC (rev 2951)
@@ -94,6 +94,7 @@
 162=Kalibrierte herunterladen
 163=von OC Funde
 164=nur bei OC gelistet
+165=Lade nur, wenn mit Cache
 170=Datenverzeichnis w&#228;hlen
 171=Profil existiert nicht:+
 172=Kann das Kartenverzeichnis nicht erstellen:

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/res_noewe/languages/EN.cfg	2011-03-08 20:57:34 UTC (rev 2951)
@@ -94,6 +94,7 @@
 162=Download calibrated
 163 = OC finds
 164 = only available at OC
+165 = load only, if with cache
 170=Select data directory
 171=Profile does not exist:+
 172=Error: cannot create maps directory:

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/res_noewe/languages/FR.cfg	2011-03-08 20:57:34 UTC (rev 2951)
@@ -94,6 +94,7 @@
 162=T&#233;l&#233;charger calibr&#233;e
 163 = OC trouve
 164 = uniquement disponible chez OC
+165 = seulement, si avec une cache
 170=Choisir dossier de base pour les profiles
 171=Profile n'existe pas:+
 172=Ne peut pas cr&#233;er dossier pour des cartes:

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/res_noewe/languages/NL.cfg	2011-03-08 20:57:34 UTC (rev 2951)
@@ -94,6 +94,7 @@
 162=Gekalibreerde kaarten downloaden.
 163 = OC vindt
 164 = alleen verkrijgbaar bij OC
+165 = alleen downloaden, als met cache
 170=Selecteer basis map voor cache data.
 171=Profiel bestaat niet:+
 172=Fout: kan kaarten map niet maken:\n.

Modified: trunk/res_noewe/languages/PL.cfg
===================================================================
--- trunk/res_noewe/languages/PL.cfg	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/res_noewe/languages/PL.cfg	2011-03-08 20:57:34 UTC (rev 2951)
@@ -94,6 +94,7 @@
 162=Sciagnij skalibrowane
 163 = OC stwierdzi
 164 = dost&#281;pne tylko w OC
+165 = tylko w&#243;wczas, gdy z pami&#281;ci podr&#281;cznej
 170=Wybierz folder z danymi
 171=Profil nie istnieje:+
 172=Blad: nie mozna utworzyc katalogu map:

Modified: trunk/res_noewe/languages/SV.cfg
===================================================================
--- trunk/res_noewe/languages/SV.cfg	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/res_noewe/languages/SV.cfg	2011-03-08 20:57:34 UTC (rev 2951)
@@ -94,6 +94,7 @@
 162=Ladda kalibrerad
 163 = OC finner
 164 = endast tillg&#228;nglig p&#229; OC
+165 = endast h&#228;mta om med cache
 170=V&#228;lj databas
 171=profil finns inte:+
 172=Fel: kan inte skapa kartor katalog:

Modified: trunk/res_noewe/spider.def
===================================================================
--- trunk/res_noewe/spider.def	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/res_noewe/spider.def	2011-03-08 20:57:34 UTC (rev 2951)
@@ -116,7 +116,7 @@
 cacheOwnerRex      = &amp;wid(?:(?s).*?)&gt;((?s).*?)&lt;
 dateHiddenRex      = (?:Hidden|Event\ Date)\\s*:\\s*((?s).*?)&lt;
 hintsRex           = &lt;div id=&quot;div_hint&quot; class=&quot;HalfLeft&quot;&gt;\\s*((?s).*?)\\s*&lt;/div&gt;
-sizeRex            = alt=&quot;Size:\ ((?s).*?)&quot;\ /&gt;&amp;nbsp&lt;small&gt;
+sizeRex            = alt=&quot;Size:\ ((?s).*?)&quot;
 difficultyRex      = difficulty\ of\ (.*?),
 terrainRex         = terrain\ of\ (.*?)\\.\\ 
 cacheTypeRex       = /images/WptTypes/(.*?)\\.gif&quot;\ alt=&quot;

Modified: trunk/src/CacheWolf/exp/LocExporter.java
===================================================================
--- trunk/src/CacheWolf/exp/LocExporter.java	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/src/CacheWolf/exp/LocExporter.java	2011-03-08 20:57:34 UTC (rev 2951)
@@ -29,8 +29,6 @@
 import CacheWolf.CacheHolderDetail;
 import CacheWolf.Common;
 import CacheWolf.Global;
-import ewe.io.File;
-import ewe.io.FileBase;
 
 
 /**

Modified: trunk/src/CacheWolf/exp/OziExporter.java
===================================================================
--- trunk/src/CacheWolf/exp/OziExporter.java	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/src/CacheWolf/exp/OziExporter.java	2011-03-08 20:57:34 UTC (rev 2951)
@@ -29,9 +29,8 @@
 import CacheWolf.CacheType;
 import CacheWolf.Preferences;
 import CacheWolf.Profile;
-import ewe.io.File;
-import ewe.io.FileBase;
 
+
 /**
 *	Class to export the cache database (index) to an OziExplorer File
 */

Modified: trunk/src/CacheWolf/imp/GCVoteImporter.java
===================================================================
--- trunk/src/CacheWolf/imp/GCVoteImporter.java	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/src/CacheWolf/imp/GCVoteImporter.java	2011-03-08 20:57:34 UTC (rev 2951)
@@ -28,22 +28,16 @@
 import CacheWolf.CacheDB;
 import CacheWolf.CacheHolder;
 import CacheWolf.Common;
-import CacheWolf.HttpConnection;
 import CacheWolf.MyLocale;
 import CacheWolf.Preferences;
 import CacheWolf.Profile;
 import CacheWolf.UrlFetcher;
-import CacheWolf.imp.SpiderGC.SpiderProperties;
-import ewe.io.IOException;
-import ewe.io.JavaUtf8Codec;
 import ewe.io.Reader;
 import ewe.io.StringReader;
-import ewe.net.Socket;
 import ewe.sys.Handle;
 import ewe.ui.FormBase;
 import ewe.ui.MessageBox;
 import ewe.ui.ProgressBarForm;
-import ewe.util.CharArray;
 import ewesoft.xml.MinML;
 import ewesoft.xml.sax.AttributeList;
 

Modified: trunk/src/CacheWolf/imp/GPXImporter.java
===================================================================
--- trunk/src/CacheWolf/imp/GPXImporter.java	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/src/CacheWolf/imp/GPXImporter.java	2011-03-08 20:57:34 UTC (rev 2951)
@@ -30,7 +30,6 @@
 import CacheWolf.Attribute;
 import CacheWolf.CacheDB;
 import CacheWolf.CacheHolder;
-import CacheWolf.CacheImages;
 import CacheWolf.CacheSize;
 import CacheWolf.CacheTerrDiff;
 import CacheWolf.CacheType;
@@ -55,11 +54,9 @@
 import ewe.io.IOException;
 import ewe.net.MalformedURLException;
 import ewe.net.URL;
-import ewe.sys.Convert;
 import ewe.sys.Time;
 import ewe.sys.Vm;
 import ewe.ui.FormBase;
-import ewe.ui.MessageBox;
 import ewe.util.Enumeration;
 import ewe.util.Vector;
 import ewe.util.zip.ZipEntry;

Modified: trunk/src/CacheWolf/navi/Area.java
===================================================================
--- trunk/src/CacheWolf/navi/Area.java	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/src/CacheWolf/navi/Area.java	2011-03-08 20:57:34 UTC (rev 2951)
@@ -47,6 +47,11 @@
 		 topleft = new CWPoint(tl);
 		 buttomright = new CWPoint(br);
 	 }
+	 
+	 public Area(CWPoint tl, CWPoint br) {
+		 topleft = tl;
+		 buttomright = br;
+	 }
 
 	 public final boolean isInBound(TrackPoint p) {
 		 if (topleft.latDec &gt;= p.latDec &amp;&amp; topleft.lonDec &lt;= p.lonDec 

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2011-03-08 20:57:34 UTC (rev 2951)
@@ -26,9 +26,10 @@
 package CacheWolf.navi;
 
 import CacheWolf.CWPoint;
+import CacheWolf.CacheDB;
+import CacheWolf.CacheHolder;
 import CacheWolf.Common;
 import CacheWolf.Global;
-import CacheWolf.HttpConnection;
 import CacheWolf.InfoBox;
 import CacheWolf.MyLocale;
 import CacheWolf.STRreplace;
@@ -39,19 +40,16 @@
 import ewe.io.File;
 import ewe.io.FileBase;
 import ewe.io.FileInputStream;
-import ewe.io.FileOutputStream;
 import ewe.io.FileReader;
 import ewe.io.FileWriter;
 import ewe.io.IOException;
 import ewe.io.PrintWriter;
-import ewe.net.Socket;
 import ewe.sys.Convert;
 import ewe.sys.Double;
 import ewe.sys.Time;
 import ewe.sys.Vm;
 import ewe.ui.FormBase;
 import ewe.ui.MessageBox;
-import ewe.util.ByteArray;
 import ewe.util.Properties;
 import ewe.util.StandardComparer;
 import ewe.util.Utils;
@@ -83,6 +81,7 @@
 	CWPoint buttomright;
 	Point tilesSize;
 	float tileScale;
+	boolean fetchOnlyMapWithCache=false;
 
 	/**
 	 *
@@ -126,6 +125,10 @@
 		}
 	}
 
+	public void setFetchOnlyMapWithCache(boolean value) {
+		fetchOnlyMapWithCache=value;
+	}
+	
 	public String[] getAvailableOnlineMapServices(){
 		int s = onlineMapServices.size();
 		String[] services = new String[s];
@@ -227,20 +230,39 @@
 		for (int row = 1; row &lt;= numMapsY; row++) {
 			lon = topleft.lonDec;
 			for (int col = 1; col &lt;= numMapsX; col++) {
-				if (progressInfobox != null)
-					progressInfobox.setInfo(MyLocale.getMsg(4802, &quot;Downloading calibrated (georeferenced) \n map image \n '&quot;) + currentOnlineMapService.getName()+MyLocale.getMsg(4803, &quot;' \n Downloading tile \n row&quot;)+&quot; &quot;+row+&quot; / &quot;+numMapsY+MyLocale.getMsg(4804, &quot; column&quot;)+&quot; &quot;+ col + &quot; / &quot;+numMapsX);
 				center.set(lat, lon);
-				try {
-					downloadMap(center, tileScale, tilesSize, tilesPath);
-				} catch (Exception e) {
-					this.progressInfobox.addWarning(MyLocale.getMsg(4805, &quot;Tile&quot;)+&quot; &quot; + row + &quot;/&quot; + col + MyLocale.getMsg(4806, &quot;: Ignoring error:&quot;)+&quot; &quot; + e.getMessage()+&quot;\n&quot;);
+				if (!fetchOnlyMapWithCache || hasCache(center,latinc,loninc)) {					
+					if (progressInfobox != null)
+						progressInfobox.setInfo(MyLocale.getMsg(4802, &quot;Downloading calibrated (georeferenced) \n map image \n '&quot;) + currentOnlineMapService.getName()+MyLocale.getMsg(4803, &quot;' \n Downloading tile \n row&quot;)+&quot; &quot;+row+&quot; / &quot;+numMapsY+MyLocale.getMsg(4804, &quot; column&quot;)+&quot; &quot;+ col + &quot; / &quot;+numMapsX);
+					try {
+						downloadMap(center, tileScale, tilesSize, tilesPath);
+					} catch (Exception e) {
+						this.progressInfobox.addWarning(MyLocale.getMsg(4805, &quot;Tile&quot;)+&quot; &quot; + row + &quot;/&quot; + col + MyLocale.getMsg(4806, &quot;: Ignoring error:&quot;)+&quot; &quot; + e.getMessage()+&quot;\n&quot;);
+					}
+					if (progressInfobox.isClosed) return;
 				}
-				if (progressInfobox.isClosed) return;
 				lon += loninc;
 			}
 			lat += latinc;
 		}
 	}
+	private boolean hasCache(CWPoint center, double latinc, double loninc) {
+		double lat = center.latDec - (latinc / 2.0);
+		double lon = center.lonDec - (loninc / 2.0);
+		CWPoint tl = new CWPoint(lat,lon);
+		lat = center.latDec + (latinc / 2.0);
+		lon = center.lonDec + (loninc / 2.0);
+		CWPoint br = new CWPoint(lat,lon);
+		Area maparea = new Area(tl,br);
+		CacheDB cacheDB = Global.getProfile().cacheDB;
+		for (int i = 0; i &lt; cacheDB.size(); i++) {
+			CacheHolder ch = cacheDB.get(i);
+			if (maparea.isInBound(ch.pos)) {
+				return true;
+			}
+		}
+		return false;
+	}
 
 	public void setProgressInfoBox (InfoBox progrssInfoboxi) {
 		progressInfobox = progrssInfoboxi;
@@ -259,107 +281,111 @@
 		String imagename = mio.setName(path, filename);
 		String imagetype = currentOnlineMapService.getImageFileExt();
 		String url = currentOnlineMapService.getUrlForCenterScale(center, scale, pixelsize);
-		if (currentOnlineMapService instanceof ExpediaMapService) {
-			downloadImage(url, path+imagename+imagetype);
-		}
-		else {
-			WebMapService wms = (WebMapService) currentOnlineMapService;
-			
-			if (wms.requestUrlPart.startsWith(&quot;REQUEST&quot;)) {
+		String fName = path + imagename + imagetype;
+		FileBugfix fn = new FileBugfix(path + imagename + &quot;.wfl&quot;);
+		FileBugfix fn1 = new FileBugfix(fName);						
+		if (!fn.exists() || fn.length()==0 || !fn1.exists() || fn1.length()==0) {
+			if (currentOnlineMapService instanceof ExpediaMapService) {
 				downloadImage(url, path+imagename+imagetype);
 			}
 			else {
-				Area maparea = wms.CenterScaleToArea(center, scale, pixelsize);
-				CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
-				CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
-
-				String mapProgramPath = wms.versionUrlPart+&quot;/&quot;;
-				mapProgramPath = mapProgramPath.replace('/', FileBase.separatorChar);
-				String mapProgram = mapProgramPath+wms.MainUrl;
-				File f=new FileBugfix(mapProgram);
-				if (!f.exists() || !f.canRead()) {
-					MessageBox mb=new MessageBox(MyLocale.getMsg(321,&quot;Error&quot;),MyLocale.getMsg(1834,&quot;Please enter the correct path to Kosmos.Console.exe into the wms-file.&quot;),ewe.ui.MessageBox.OKB);
-					mb.execute();
-					return;
+				WebMapService wms = (WebMapService) currentOnlineMapService;				
+				if (wms.requestUrlPart.startsWith(&quot;REQUEST&quot;)) {
+					downloadImage(url, path+imagename+imagetype);
 				}
-				
-				String mapProgramParams = &quot;&quot;;
-				
-				if (wms.requestUrlPart.equalsIgnoreCase(&quot;Kosmos&quot;)) {					
-					// minx miny maxx maxy + pixelsize.x
-					mapProgramParams=&quot;bitmapgen&quot; +
-						&quot; \&quot;&quot;+FileBase.getProgramDirectory().replace('/',File.separatorChar)+&quot;\\&quot;+wms.serviceTypeUrlPart+&quot;\&quot;&quot;+
-						&quot; \&quot;&quot;+path.replace('/', File.separatorChar)+imagename+imagetype+&quot;\&quot;&quot;+
-						&quot; -mb &quot; +
-						buttomleft.toString(TransformCoordinates.LAT_LON).replace(',',' ') + &quot; &quot; +
-						topright.toString(TransformCoordinates.LAT_LON).replace(',',' ') +
-						&quot; -w &quot;+pixelsize.x;				
-					Vm.exec(mapProgram, mapProgramParams, 0, true);				
-				}
-				else { 
-					if (wms.requestUrlPart.equalsIgnoreCase(&quot;Maperitive&quot;)) {
-						// Maperitive runs on Windows and Linux
-						// generating scriptfile for Maperitive from wmsfile
-						String cwPath = FileBase.getProgramDirectory().replace('/',FileBase.separatorChar) + FileBase.separatorChar;
-						String scriptFileName = cwPath + &quot;maperitive.script&quot;;
-						
-						PrintWriter outp =  new PrintWriter(new BufferedWriter(new FileWriter(scriptFileName)));
-						outp.println(&quot;use-ruleset alias=default&quot;);
-						outp.println(&quot;clear-map&quot;);
+				else {
+					Area maparea = wms.CenterScaleToArea(center, scale, pixelsize);
+					CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
+					CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
 
-						if (wms.serviceTypeUrlPart.equals(&quot;&quot;)) {
-							outp.println(&quot;add-web-map&quot;);
-						}
-						else {
-							outp.println(&quot;add-web-map provider=&quot; + wms.serviceTypeUrlPart);
-						}
-						
-						if (!wms.stylesUrlPart.equals(&quot;&quot;)) {
-							String myrules = mapProgramPath + wms.stylesUrlPart.replace('/',FileBase.separatorChar);
-							outp.println(&quot;use-ruleset location=&quot; + myrules);
-							// outp.println(&quot;apply-ruleset&quot;);
-						}
-						if (!wms.layersUrlPart.equals(&quot;&quot;)) {
+					String mapProgramPath = wms.versionUrlPart+&quot;/&quot;;
+					mapProgramPath = mapProgramPath.replace('/', FileBase.separatorChar);
+					String mapProgram = mapProgramPath+wms.MainUrl;
+					File f=new FileBugfix(mapProgram);
+					if (!f.exists() || !f.canRead()) {
+						MessageBox mb=new MessageBox(MyLocale.getMsg(321,&quot;Error&quot;),MyLocale.getMsg(1834,&quot;Please enter the correct path to Kosmos.Console.exe into the wms-file.&quot;),ewe.ui.MessageBox.OKB);
+						mb.execute();
+						return;
+					}
+					
+					String mapProgramParams = &quot;&quot;;
+					
+					if (wms.requestUrlPart.equalsIgnoreCase(&quot;Kosmos&quot;)) {					
+						// minx miny maxx maxy + pixelsize.x
+						mapProgramParams=&quot;bitmapgen&quot; +
+							&quot; \&quot;&quot;+FileBase.getProgramDirectory().replace('/',File.separatorChar)+&quot;\\&quot;+wms.serviceTypeUrlPart+&quot;\&quot;&quot;+
+							&quot; \&quot;&quot;+path.replace('/', File.separatorChar)+imagename+imagetype+&quot;\&quot;&quot;+
+							&quot; -mb &quot; +
+							buttomleft.toString(TransformCoordinates.LAT_LON).replace(',',' ') + &quot; &quot; +
+							topright.toString(TransformCoordinates.LAT_LON).replace(',',' ') +
+							&quot; -w &quot;+pixelsize.x;				
+						Vm.exec(mapProgram, mapProgramParams, 0, true);				
+					}
+					else {						
+						if (wms.requestUrlPart.equalsIgnoreCase(&quot;Maperitive&quot;)) {
+							// Maperitive runs on Windows and Linux
+							// generating scriptfile for Maperitive from wmsfile
+							String cwPath = FileBase.getProgramDirectory().replace('/',FileBase.separatorChar) + FileBase.separatorChar;
+							String scriptFileName = cwPath + &quot;maperitive.script&quot;;
+							
+							PrintWriter outp =  new PrintWriter(new BufferedWriter(new FileWriter(scriptFileName)));
+							outp.println(&quot;use-ruleset alias=default&quot;);
 							outp.println(&quot;clear-map&quot;);
-							outp.println(&quot;load-source &quot; + mapProgramPath + wms.layersUrlPart.replace('/',FileBase.separatorChar));
-							// implicit does apply-ruleset
+
+							if (wms.serviceTypeUrlPart.equals(&quot;&quot;)) {
+								outp.println(&quot;add-web-map&quot;);
+							}
+							else {
+								outp.println(&quot;add-web-map provider=&quot; + wms.serviceTypeUrlPart);
+							}
+							
+							if (!wms.stylesUrlPart.equals(&quot;&quot;)) {
+								String myrules = mapProgramPath + wms.stylesUrlPart.replace('/',FileBase.separatorChar);
+								outp.println(&quot;use-ruleset location=&quot; + myrules);
+								// outp.println(&quot;apply-ruleset&quot;);
+							}
+							if (!wms.layersUrlPart.equals(&quot;&quot;)) {
+								outp.println(&quot;clear-map&quot;);
+								outp.println(&quot;load-source &quot; + mapProgramPath + wms.layersUrlPart.replace('/',FileBase.separatorChar));
+								// implicit does apply-ruleset
+							}
+							
+							String koords = buttomleft.toString(TransformCoordinates.LON_LAT) + &quot;,&quot; + topright.toString(TransformCoordinates.LON_LAT);
+							outp.println(&quot;bounds-set &quot;+koords);
+							outp.println(&quot;zoom-bounds&quot;);
+							if ( path.indexOf(':') == 1) {
+								outp.print(&quot;export-bitmap file=&quot; + &quot;\&quot;&quot; + fName + &quot;\&quot;&quot;);
+							}
+							else {
+								outp.print(&quot;export-bitmap file=&quot; + fName);
+							}
+							outp.print(&quot; bounds=&quot;+ koords);
+							String pxSize = &quot; width=&quot;+pixelsize.x + &quot; height=&quot;+pixelsize.y;						
+							outp.print(pxSize);
+							outp.println(&quot; kml=false&quot;);
+							outp.close();
+							// executing the generated script
+							if (mapProgram.indexOf(':') == 1) {
+								mapProgramParams = &quot;-exitafter &quot; + &quot;\&quot;&quot; + scriptFileName + &quot;\&quot;&quot;;
+							}
+							else {
+								mapProgramParams = &quot;-exitafter &quot; + scriptFileName;								
+							}
+							Vm.exec(mapProgram, mapProgramParams, 0, true);
+							// preparation for generating wfl from the ozi map-file
+							Vector GCPs = map2wfl(path+imagename);
+							mio.evalGCP(GCPs, pixelsize.x, pixelsize.y);
+							// can not supress genaration of pgw,jgw-file
+							FileBugfix pgwFile = new FileBugfix(path + imagename + &quot;.pgw&quot;); // seems to bee for png
+							pgwFile.delete();
+							FileBugfix jgwFile = new FileBugfix(path + imagename + &quot;.jgw&quot;); // seems to bee for jpg
+							jgwFile.delete();
 						}
-						
-						String koords = buttomleft.toString(TransformCoordinates.LON_LAT) + &quot;,&quot; + topright.toString(TransformCoordinates.LON_LAT);
-						outp.println(&quot;bounds-set &quot;+koords);
-						outp.println(&quot;zoom-bounds&quot;);
-						if ( path.indexOf(':') == 1) {
-							outp.print(&quot;export-bitmap file=&quot; + &quot;\&quot;&quot; + path + imagename + imagetype + &quot;\&quot;&quot;);
-						}
-						else {
-							outp.print(&quot;export-bitmap file=&quot; + path + imagename + imagetype);
-						}
-						outp.print(&quot; bounds=&quot;+ koords);
-						String pxSize = &quot; width=&quot;+pixelsize.x + &quot; height=&quot;+pixelsize.y;						
-						outp.print(pxSize);
-						outp.println(&quot; kml=false&quot;);
-						outp.close();
-						// executing the generated script
-						if (mapProgram.indexOf(':') == 1) {
-							mapProgramParams = &quot;-exitafter &quot; + &quot;\&quot;&quot; + scriptFileName + &quot;\&quot;&quot;;
-						}
-						else {
-							mapProgramParams = &quot;-exitafter &quot; + scriptFileName;								
-						}
-						Vm.exec(mapProgram, mapProgramParams, 0, true);
-						// preparation for generating wfl from the ozi map-file
-						Vector GCPs = map2wfl(path+imagename);
-						mio.evalGCP(GCPs, pixelsize.x, pixelsize.y);
-						// can not supress genaration of pgw,jgw-file
-						File pgwFile = new File(path + imagename + &quot;.pgw&quot;); // seems to bee for png
-						pgwFile.delete();
-						File jgwFile = new File(path + imagename + &quot;.jgw&quot;); // seems to bee for jpg
-						jgwFile.delete();
 					}
-				}
-			}			
+				}			
+			}
+			mio.saveWFL();
 		}
-		mio.saveWFL();
 	}
 
 	private Vector map2wfl(String pathAndImageName) {

Modified: trunk/src/CacheWolf/navi/MapLoaderGui.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoaderGui.java	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/src/CacheWolf/navi/MapLoaderGui.java	2011-03-08 20:57:34 UTC (rev 2951)
@@ -88,9 +88,9 @@
 	mComboBox scaleInputPerCache = new mComboBox();
 	mLabel overlappingLbl = new mLabel(MyLocale.getMsg(1808,&quot;overlapping in pixel:&quot;));
     mInput overlappingInput = new mInput(&quot;&quot;+pref.mapOverlapping);
-	mCheckBox overviewChkBox = new mCheckBox(MyLocale.getMsg(1809,&quot;download an overview map&quot;));
+	mCheckBox overviewChkBox = new mCheckBox(MyLocale.getMsg(1809,&quot;download an overview map&quot;));	
+	mCheckBox fetchOnlyMapWithCacheChkBox = new mCheckBox(MyLocale.getMsg(165,&quot;only for caches&quot;));	
 	mCheckBox overviewChkBoxPerCache = new mCheckBox(MyLocale.getMsg(1809,&quot;download an overview map&quot;));
-
     mCheckBox smallTiles = new mCheckBox (MyLocale.getMsg (4280, &quot;Small Tiles&quot;));
     mCheckBox bigTiles = new mCheckBox (MyLocale.getMsg (4282, &quot;BigTiles&quot;));
     CheckBoxGroup tileSize = new CheckBoxGroup ();
@@ -168,7 +168,9 @@
 		pnlTiles.addNext(overlappingLbl);
 		pnlTiles.addLast(overlappingInput);
 		overviewChkBox.setState(false);
-		pnlTiles.addLast(overviewChkBox);
+		pnlTiles.addNext(overviewChkBox);
+		fetchOnlyMapWithCacheChkBox.setState(false);
+		pnlTiles.addLast(fetchOnlyMapWithCacheChkBox);
 		pnlTiles.addNext(smallTiles);
 		pnlTiles.addLast(bigTiles);
 		smallTiles.setGroup(tileSize);
@@ -342,6 +344,7 @@
 		}
 		if (!perCache){  // download tiles
 			mapLoader.setProgressInfoBox(progressBox);
+			mapLoader.setFetchOnlyMapWithCache(fetchOnlyMapWithCacheChkBox.getState());
 			mapLoader.downlaodTiles(mapsDir);
 		} else { // per cache
 			CacheHolder ch;

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2011-03-06 13:13:38 UTC (rev 2950)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2011-03-08 20:57:34 UTC (rev 2951)
@@ -168,7 +168,6 @@
 		}
 	}
 
-	public boolean getShowCachesOnMap() {return pref.showCachesOnMap; }
 	public void setShowCachesOnMap(boolean value) {
 		if (value != pref.showCachesOnMap) {
 			pref.showCachesOnMap=value;
@@ -432,7 +431,7 @@
 		if (Global.getProfile().selectionChanged) {
 			// this means marking has changed
 			Global.getProfile().selectionChanged = false;
-			if (getShowCachesOnMap()) removeAllMapSymbols(); // not really needed: hopefully removed by showCachesOnMap
+			if (pref.showCachesOnMap) removeAllMapSymbols(); // not really needed: hopefully removed by showCachesOnMap
 		}
 		setMarkedCache(Global.mainTab.ch); // this is the selected one (not necessary marked)
 		showCachesOnMap();
@@ -1062,7 +1061,7 @@
 			if (screenArea.isInBound(ch.pos)) {
 				// because visible and valid don't change while showing map --&gt;need no remove
 				if (ch.isVisible() &amp;&amp; ch.pos.isValid()) {
-					if (getShowCachesOnMap()) {
+					if (pref.showCachesOnMap) {
 						addSymbolIfNecessary(ch.cacheName, ch, GuiImageBroker.getTypeImage(ch.getType(),true), ch.pos);
 					}
 					else {
@@ -1096,7 +1095,7 @@
 			}
 			if (gotoPosCH != null) {
 				if (screenArea.isInBound(gotoPosCH.pos)) {
-					if (!getShowCachesOnMap()) {
+					if (!pref.showCachesOnMap) {
 						addSymbolIfNecessary(gotoPosCH.cacheName, gotoPosCH, GuiImageBroker.getTypeImage(gotoPosCH.getType(),true), gotoPosCH.pos);
 					}
 					addSymbolOnTop(&quot;goto&quot;, gotoPosCH, &quot;goto_map.png&quot;, gotoPos.where);


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002941.html">[Cachewolf-svn] r2950 - in trunk: res_noewe src/CacheWolf	src/CacheWolf/imp
</A></li>
	<LI>Next message: <A HREF="002945.html">[Cachewolf-svn] r2954 - trunk/res_noewe
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2942">[ date ]</a>
              <a href="thread.html#2942">[ thread ]</a>
              <a href="subject.html#2942">[ subject ]</a>
              <a href="author.html#2942">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
