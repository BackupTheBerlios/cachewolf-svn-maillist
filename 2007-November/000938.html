<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r1045 - in trunk: res_noewe src/CacheWolf	src/CacheWolf/navi
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2007-November/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r1045%20-%20in%20trunk%3A%20res_noewe%20src/CacheWolf%0A%09src/CacheWolf/navi&In-Reply-To=%3C200711061718.lA6HIctg001252%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000937.html">
   <LINK REL="Next"  HREF="000939.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r1045 - in trunk: res_noewe src/CacheWolf	src/CacheWolf/navi</H1>
    <B>pfeffer at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r1045%20-%20in%20trunk%3A%20res_noewe%20src/CacheWolf%0A%09src/CacheWolf/navi&In-Reply-To=%3C200711061718.lA6HIctg001252%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r1045 - in trunk: res_noewe src/CacheWolf	src/CacheWolf/navi">pfeffer at mail.berlios.de
       </A><BR>
    <I>Tue Nov  6 18:18:38 CET 2007</I>
    <P><UL>
        <LI>Previous message: <A HREF="000937.html">[Cachewolf-svn] r1044 - trunk/src/CacheWolf
</A></li>
        <LI>Next message: <A HREF="000939.html">[Cachewolf-svn] r1046 - in trunk/src/CacheWolf: . navi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#938">[ date ]</a>
              <a href="thread.html#938">[ thread ]</a>
              <a href="subject.html#938">[ subject ]</a>
              <a href="author.html#938">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: pfeffer
Date: 2007-11-06 18:18:11 +0100 (Tue, 06 Nov 2007)
New Revision: 1045

Modified:
   trunk/res_noewe/luftbild-nrw.wms
   trunk/src/CacheWolf/CWPoint.java
   trunk/src/CacheWolf/Common.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/navi/Area.java
   trunk/src/CacheWolf/navi/GkPoint.java
   trunk/src/CacheWolf/navi/MapInfoObject.java
   trunk/src/CacheWolf/navi/MapLoader.java
   trunk/src/CacheWolf/navi/MapLoaderGui.java
   trunk/src/CacheWolf/navi/MovingMap.java
   trunk/src/CacheWolf/navi/TransformCoordinates.java
Log:
WMS now complete. Please refer to luftbild-NRW.wms to define your own WMS
Please notice that scales can have a decimal seperator now and that they can be smaller than 1m per pixel are supported by some WMS


Modified: trunk/res_noewe/luftbild-nrw.wms
===================================================================
--- trunk/res_noewe/luftbild-nrw.wms	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/res_noewe/luftbild-nrw.wms	2007-11-06 17:18:11 UTC (rev 1045)
@@ -1,14 +1,49 @@
-Name: Luftbild NRW
-MainUrl: <A HREF="http://www.gis2.nrw.de/wmsconnector/wms/luftbild?SERVICE=WMS">http://www.gis2.nrw.de/wmsconnector/wms/luftbild?SERVICE=WMS</A>
-LayersName: Luftbild NRW
-VersionUrlPart: VERSION=1.1.0
-CoordinateReferenceSystemCacheWolf: 31466
-CoordinateReferenceSystemUrlPart: SRS=EPSG:31466
-RequestUrlPart: REQUEST=GetMap
-LayersUrlPart: LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
-StylesUrlPart: STYLES=
-ImageFormatUrlPart: FORMAT=image/jpeg
-BoundingBoxTopLeftWGS84: N 52.7691 E 5.673
-BoundingBoxButtomRightWGS84: N 49.9944 E 10.142
-MinScale: 0.1795783591567183
-MaxScale: 5.611823723647454
+# This is an example and explantion of an wms definition file.
+# You can add your own .wms file to the program directory of
+# cachwolf and the new service will be available in the download maps dialog
+#
+# For a list of WMS Services available in Germany see: <A HREF="http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten">http://deutschlandviewer.bayern.de/deutschlandviewer/D_Viewer_Hilfe/Hilfe_D_Viewer.htm#Geodaten</A>
+# This example is made up from there &quot;Digitales Orthophoto&quot; under section &quot;Nordrhein-Westfalen&quot;
+# download the getCapabilieties URL, save and open it in a text editor. 
+# used here: <A HREF="http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&amp;VERSION=1.1.0&amp;SERVICE=WMS">http://www.gis2.nrw.de/wmsconnector/wms/luftbild?REQUEST=GetCapabilities&amp;VERSION=1.1.0&amp;SERVICE=WMS</A>
+# 
+#friendly name, choose yourself
+Name:	Luftbild NRW 
+# taken from getCapabilieties answer: &lt;HTTP&gt;&lt;GET&gt;&lt;OnlineResource xlink:href=
+MainUrl:	<A HREF="http://www.gis2.nrw.de/wmsconnector/wms/luftbild?">http://www.gis2.nrw.de/wmsconnector/wms/luftbild?</A> 
+#friendly name of the layer combination, choose yourself
+LayersName: 
+# this is fix
+ServiceTypeUrlPart:	SERVICE=WMS 
+# taken from the getCapabilities request: &lt;WMT_MS_Capabilities version=
+VersionUrlPart:	VERSION=1.1.0 
+# The EPSG-Code, supported by cachewolf: german gau&#223;-kr&#252;ger (31466, 31467, 31468, 31469) and WGS84 (4326)
+# You get a list of supported coordinate systems in the getCapabilieties answer under &lt;Layer&gt;&lt;SRS&gt;
+# plases feel free to ask for another coordinate system to be supported by cachewolf if you need it
+CoordinateReferenceSystemCacheWolf:	31466 
+# this usually will match the number above
+CoordinateReferenceSystemUrlPart:	SRS=EPSG:31466
+# Post not supported by Cachewolf --&gt; dont change this
+RequestUrlPart:	REQUEST=GetMap
+# comma seperated (without spaces) list of layers to combine
+# all of supported layers you get from the getCapabilities request &lt;Layer&gt;&lt;Name&gt;
+# these names are to be used. Special characters must be URL-encode
+LayersUrlPart:	LAYERS=Orthophoto%20Str.%202,Orthophoto%20Str.%203
+# if the WMS supports different rendering styles, select the one you need here
+# comma seperated (without spaces) list of style commands for map rendering (do not delete this item even if it is empty
+StylesUrlPart:	STYLES=
+# format, dont forget to set ImageFileExtension accordingly
+# you get a list of supported image formats from getCapabilieties answer: &lt;GetMap&gt;&lt;Format&gt;
+ImageFormatUrlPart:	FORMAT=image/jpeg
+# Limits of the service in WGS84 coordinates. 
+# You can use any format here, which is accepted by the input coordinates dialog in cachewolf
+# taken from getCapabilieties answer: &lt;BoundingBox SRS=&quot;EPSG:4326&quot;, dont forget to add &quot;N&quot;/&quot;S&quot; and &quot;E&quot;/&quot;W&quot;
+BoundingBoxTopLeftWGS84:	N 52.7691 E 5.673
+BoundingBoxButtomRightWGS84:	N 49.9944 E 10.142
+# scale range that the service supports in meters per pixel (measured diagonal)
+# taken from the getCapabilities request &quot;&lt;Layer&gt;&lt;ScaleHint min=&quot;
+MinScale:	0.1795783591567183
+MaxScale:	5.611823723647454
+# set this according to ImageFormatUrlPart
+ImageFileExtension: .jpg
+

Modified: trunk/src/CacheWolf/CWPoint.java
===================================================================
--- trunk/src/CacheWolf/CWPoint.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/CWPoint.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -281,6 +281,19 @@
 	}
 	
 	/**
+	 * shift the point
+	 * @param meters positiv to north (east), negativ to south (west)
+	 * @param direction 0 north-south, 1 east-west
+	 */
+	public void shift(double meters, int direction) {
+		double meters2deglon = 1/(1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0)));
+		switch (direction) { // TODO use ellipsoid distance calculations for better accuracy
+			case 0: latDec += meters *  meters2deglon; return;
+			case 1: lonDec += meters * (meters2deglon / Math.cos(latDec / 180 * Math.PI));return;
+		}
+	}
+
+	/**
 	 * mark the Point as invalid
 	 *
 	 */
@@ -577,21 +590,9 @@
 						+  getEWLetter() + &quot; &quot; + getLonDeg(format) + &quot;&#176; &quot; + getLonMin(format) + &quot;\' &quot; + getLonSec(format) + &quot;\&quot;&quot;;
 		case UTM:	return getUTMZone()  + &quot; E &quot; + getUTMEasting()+ &quot; N &quot; + getUTMNorthing();
 		case LON_LAT:
-			Double latD = new Double();
-			latD.decimalPlaces = 8;
-			latD.set(latDec);
-			Double lonD = new Double();
-			lonD.decimalPlaces = 8;
-			lonD.set(lonDec);
-			return latD.toString().replace(',', '.') + &quot;,&quot; + lonD.toString().replace(',', '.');
+			return Common.DoubleToString(lonDec, 8) +  &quot;,&quot; + Common.DoubleToString(latDec, 8);
 		case LAT_LON:
-			Double latD2 = new Double();
-			latD2.decimalPlaces = 8;
-			latD2.set(latDec);
-			Double lonD2 = new Double();
-			lonD2.decimalPlaces = 8;
-			lonD2.set(lonDec);
-			return  lonD2.toString().replace(',', '.') + &quot;,&quot; + latD2.toString().replace(',', '.');
+			return Common.DoubleToString(latDec, 8) +  &quot;,&quot; + Common.DoubleToString(lonDec, 8);
 		default: return &quot;Unknown Format: &quot; + format;
 
 		}

Modified: trunk/src/CacheWolf/Common.java
===================================================================
--- trunk/src/CacheWolf/Common.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/Common.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -109,6 +109,7 @@
 	
 	public static String ClearForFileName(String str) {
 		String ret = str.replace('?', '_');
+		ret = str.replace(' ', '-');
 		return ret;
 	}
 	
@@ -141,5 +142,13 @@
 		if (dot &lt; 0) return &quot;&quot;;
 		return fn.substring(dot, fn.length());
 	}
+	
+	public static String DoubleToString(double d, int decimalplaces) {
+		ewe.sys.Double e = new ewe.sys.Double();
+		e.set(d);
+		e.decimalPlaces = decimalplaces;
+		return e.toString().replace(',', '.');
 
+	}
+
 }

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/Preferences.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -368,7 +368,7 @@
     // Maps
 	//////////////////////////////////////////////////////////////////////////////////////
 
-	public String mapsPath = &quot;maps/standard&quot;;
+	private static final String mapsPath = &quot;maps/standard&quot;;
 	
 	/**
 	 * Gibt den vom Benutzer gesetzten Pfad zu den Maps
@@ -378,8 +378,11 @@
 	   return customMapsPath;	
 	}
 	
-	void saveCustomMapsPath(String mapspath) {
-		customMapsPath=mapsPath;
+	public void saveCustomMapsPath(String mapspath_) {
+		if (!customMapsPath.equals(mapspath_)) {
+			customMapsPath=new String(mapspath_);
+			savePreferences();
+		}
 	}
 	
 	/**
@@ -391,25 +394,33 @@
 	 * it returns  &lt;baseDir&gt;/maps/expedia - the place where
 	 * the automatically downloaded maps are placed.
 	 * 
-	 * Later the maps-path shall be saved in the preferences
+	 * 
 	 */
 	public String getMapLoadPath() {
+		saveCustomMapsPath(getMapLoadPathInternal());
+		return getCustomMapsPath();
+	}
+	private String getMapLoadPathInternal() {
 		// here could also a list of map-types displayed...
 		// standard dir
-		File t = new FileBugfix(getMapManuallySavePath(false));
+		String ret = getCustomMapsPath(); 
+		if (ret != null) return ret; 
+		ret = getMapManuallySavePath(false);
+		File t = new FileBugfix(ret);
 		String[] f = t.list(&quot;*.wfl&quot;, File.LIST_ALWAYS_INCLUDE_DIRECTORIES | File.LIST_FILES_ONLY);
 		if (f != null &amp;&amp; f.length &gt; 0) return  baseDir + mapsPath;
 		f = t.list(&quot;*.wfl&quot;, File.LIST_DIRECTORIES_ONLY | File.LIST_ALWAYS_INCLUDE_DIRECTORIES);
 		if (f != null &amp;&amp; f.length &gt; 0) { // see if in a subdir of &lt;baseDir&gt;/maps/standard are .wfl files
 			String[] f2;
 			for (int i = 0; i&lt; f.length; i++) {
-				t.set(null, getMapManuallySavePath(false)+&quot;/&quot;+f[i]);
+				t.set(null, ret+&quot;/&quot;+f[i]);
 				f2 = t.list(&quot;*.wfl&quot;, File.LIST_FILES_ONLY);
-				if (f2 != null &amp;&amp; f2.length &gt; 0) return  getMapManuallySavePath(false);
+				if (f2 != null &amp;&amp; f2.length &gt; 0) return  ret;
 			}
 		}
 		// lagacy dir 
-		t.set(null, File.getProgramDirectory() + &quot;/maps&quot;);
+		ret = File.getProgramDirectory() + &quot;/maps&quot;;
+		t.set(null, ret);
 		f = t.list(&quot;*.wfl&quot;, File.LIST_FILES_ONLY);
 		if (f != null &amp;&amp; f.length &gt; 0) {
 			MessageBox inf = new MessageBox(&quot;Information&quot;, &quot;The directory for calibrated maps \nhas moved in this program version\n to '&lt;profiles directory&gt;/maps/standard'\n Do you want to move your calibrated maps there now?&quot;, MessageBox.YESB | MessageBox.NOB);
@@ -418,7 +429,7 @@
 				File spF = new File(sp);
 				if (!spF.exists()) spF.mkdirs();
 				String image;
-				String lagacypath = File.getProgramDirectory() + &quot;/maps/&quot;;
+				String lagacypath = ret;
 				for (int i=0; i&lt;f.length; i++) {
 					t.set(null, lagacypath+f[i]);
 					spF.set(null, sp+&quot;/&quot;+f[i]);
@@ -432,7 +443,7 @@
 				t.delete();
 				return sp;
 			}
-			else return  File.getProgramDirectory() + &quot;/maps&quot;;
+			else return  ret;
 		}
 		// expedia dir
 		return getMapExpediaLoadPath(); 
@@ -457,9 +468,9 @@
 	/**
 	 * to this path the automatically downloaded maps are saved
 	 */
-	public String getMapExpediaSavePath() {
+	public String getMapDownloadSavePath(String mapkind) {
 		String subdir = Global.getProfile().dataDir.substring(Global.getPref().baseDir.length());
-		String mapsDir = Global.getPref().baseDir + &quot;maps/expedia/&quot; + subdir;
+		String mapsDir = Global.getPref().baseDir + &quot;maps/&quot; + Common.ClearForFileName(mapkind)+ &quot;/&quot; + subdir;
 		if (!(new File(mapsDir).isDirectory())) { // dir exists? 
 			if (new File(mapsDir).mkdirs() == false) // dir creation failed?
 			{(new MessageBox(MyLocale.getMsg(321,&quot;Error&quot;), MyLocale.getMsg(172,&quot;Error: cannot create maps directory: \n&quot;)+new File(mapsDir).getParentFile(), MessageBox.OKB)).exec();

Modified: trunk/src/CacheWolf/navi/Area.java
===================================================================
--- trunk/src/CacheWolf/navi/Area.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/Area.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -138,4 +138,8 @@
 	 public String toString() {
 		 return topleft.toString() + &quot;, &quot; + buttomright.toString();
 	 }
+	 
+	 public CWPoint getCenter() {
+		 return new CWPoint((topleft.latDec + buttomright.latDec)/2, (topleft.lonDec + buttomright.lonDec)/2);
+	 }
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/GkPoint.java
===================================================================
--- trunk/src/CacheWolf/navi/GkPoint.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/GkPoint.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -30,4 +30,16 @@
 		e.decimalPlaces = decimalplaces;
 		return prefix + e.toString().replace(',', '.') + seperator + n.toString().replace(',', '.');
 	}
+	
+	/**
+	 * shift the point
+	 * @param meters positiv to north (east), negativ to south (west)
+	 * @param direction 0 north-south, 1 east-west
+	 */
+	public void shift(double meters, int direction) {
+		switch (direction) { // TODO this works corectly only within an 3 degrees stripe
+			case 0: northing += meters; return;
+			case 1: easting += meters; return;
+		}
+	}
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapInfoObject.java
===================================================================
--- trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/MapInfoObject.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -32,8 +32,6 @@
 	// lat of lower right corner of image
 
 	public double[] affine = {0,0,0,0};
-	//public double lowlat = 0;
-	//public double lowlon = 0;
 	public double transLatX, transLatY, transLonX, transLonY; // this are needed for the inervers calculation from lat/lon to x/y
 	public CWPoint center = new CWPoint();
 	public float sizeKm = 0; // diagonale
@@ -42,8 +40,11 @@
 	public Point shift = new Point (0,0);
 	public CWPoint OrigUpperLeft; // this is only valid after zooming 
 	public float rotationRad; // contains the rotation of the map == north direction in rad
+	/** full path to the respective worldfile, including &quot;.wfl&quot;*/
 	public String fileNameWFL = new String();
-	public String fileName = new String();
+	/** filename wihout directory */
+//	public String fileName = new String();
+	/** name of the map, introduced to allow 'maps' without an image (empty maps) */ 
 	public String mapName = new String();
 	//private Character digSep = new Character(' ');
 	static private String digSep = MyLocale.getDigSeparator();
@@ -52,7 +53,7 @@
 		//double testA = Convert.toDouble(&quot;1,50&quot;) + Convert.toDouble(&quot;3,00&quot;);
 		//if(testA == 4.5) digSep = &quot;,&quot;; else digSep = &quot;.&quot;;
 	}
-	
+
 	public MapInfoObject(MapInfoObject map) {
 		super (map.topleft, map.buttomright);
 		mapName = map.mapName;
@@ -63,7 +64,7 @@
 		OrigUpperLeft = new CWPoint (map.OrigUpperLeft);
 		zoomFactor = map.zoomFactor;
 		shift.set(map.shift);
-		fileName = new String(map.fileName);
+		//	fileName = new String(map.fileName);
 		fileNameWFL = new String(map.fileNameWFL);
 		mapName = new String(mapName);
 		doCalculations();
@@ -86,8 +87,8 @@
 		topleft.lonDec=0; //left
 		buttomright.latDec = 0; //buttom
 		buttomright.lonDec = 1; //right
-		*/OrigUpperLeft = new CWPoint(topleft);
-		doCalculations();
+		 */OrigUpperLeft = new CWPoint(topleft);
+		 doCalculations();
 	}
 
 	/**
@@ -113,22 +114,35 @@
 		OrigUpperLeft = new CWPoint(topleft);
 		doCalculations();
 	}
-	
+
 	public MapInfoObject(String mapsPath, String thisMap) throws IOException, ArithmeticException {
 		super();
 		loadwfl(mapsPath, thisMap);
 	}
 
+	/**
+	 * 
+	 * @param path
+	 * @param n without &quot;.wfl&quot;
+	 * @return name of the map including fast-find-prefix
+	 */
+	public String setName(String path, String n) {
+		String pref = getFfPrefix();
+		mapName = pref + n;
+		fileNameWFL = path + pref + mapName + &quot;.wfl&quot;;
+		return mapName;
+	}
+
 	/** 
 	 * @return the filename of the associated map image, &quot;&quot; if no file is associated, null if associated file could not be found
 	 */
 	public String getImageFilename() {
-		if (fileName == null || fileName.length() &gt; 0) return fileName;
-		if (fileNameWFL.length() == 0) return &quot;&quot;;
+		// if (fileName == null || fileName.length() &gt; 0) return fileName; 
+		if (fileNameWFL.length() == 0) return &quot;&quot;; // no image associated (empty map)
 		String n = fileNameWFL.substring(0, fileNameWFL.lastIndexOf(&quot;.&quot;));
 		return Common.getImageName(n);
 	}
-	
+
 	/**
 	 * Method to load a .wfl-file
 	 * @param mapsPath path to the map inclunding / at the end
@@ -165,7 +179,7 @@
 			buttomright.lonDec = Convert.toDouble(line);
 
 			fileNameWFL = mapsPath + thisMap + &quot;.wfl&quot;;
-			fileName = &quot;&quot;; //mapsPath + thisMap + &quot;.png&quot;;
+//			fileName = &quot;&quot;; //mapsPath + thisMap + &quot;.png&quot;;
 			mapName = thisMap;
 			in.close();
 			if( !topleft.isValid() ) {
@@ -235,7 +249,7 @@
 		affine[1] = beta.matrix[1][0];
 		affine[3] = beta.matrix[2][0];
 		topleft.lonDec = beta.matrix[0][0];
-		
+
 		buttomright = calcLatLon(imageWidth, imageHeight);
 		doCalculations();
 		//Vm.debug(&quot;A B C&quot; + affine[0] + &quot; &quot; + affine[2] + &quot; &quot; + affine[4]);
@@ -274,6 +288,11 @@
 		} catch (ArithmeticException ex) { throw new ArithmeticException(&quot;Not allowed values in affine\n (matrix cannot be inverted)\n in file \n&quot; + fileNameWFL); }
 	}
 
+	public void saveWFL() throws IOException, IllegalArgumentException {
+		File dateiF = new File(fileNameWFL);
+		String tmp = dateiF.getDrivePath(); // contains the name and the extension
+		saveWFL(tmp, mapName);
+	}
 
 	/**
 	 *	Method to save a world file (.wfl)
@@ -297,14 +316,14 @@
 		if (digSep.equals(&quot;,&quot;)) towrite=towrite.replace(',', '.');
 		outp.print(towrite);
 		outp.close();
-		this.fileName = &quot;&quot;; // this will be set in getImageFilenam //mapsPath + &quot;/&quot; + mapFileName + &quot;.png&quot;;
+//		this.fileName = &quot;&quot;; // this will be set in getImageFilenam //mapsPath + &quot;/&quot; + mapFileName + &quot;.png&quot;;
 		this.fileNameWFL = mapsPath + &quot;/&quot; + mapFileName + &quot;.wfl&quot;;
 		this.mapName = mapFileName;
 	}
 
 //	public boolean inBound(CWPoint pos){
 	//	boolean isInBound = false;
-		/*
+	/*
 		Vm.debug(mapName);
 		Vm.debug(&quot;Top: &quot; + affine[4]);
 		Vm.debug(&quot;Bottom: &quot; + lowlat);
@@ -312,8 +331,8 @@
 		Vm.debug(&quot;Left: &quot; + affine[5]);
 		Vm.debug(&quot;Right: &quot; + lowlon);
 		Vm.debug(&quot;Test: &quot; + pos.lonDec);
-		 */
-//		if(topleft.latDec &gt;= pos.latDec &amp;&amp; pos.latDec &gt;= buttomright.latDec &amp;&amp; topleft.lonDec &lt;= pos.lonDec &amp;&amp; pos.lonDec &lt;= buttomright.lonDec) isInBound = true;
+	 */
+//	if(topleft.latDec &gt;= pos.latDec &amp;&amp; pos.latDec &gt;= buttomright.latDec &amp;&amp; topleft.lonDec &lt;= pos.lonDec &amp;&amp; pos.lonDec &lt;= buttomright.lonDec) isInBound = true;
 	//	return isInBound;
 	//}
 
@@ -344,12 +363,12 @@
 		doCalculations(); // TODO lowlat neu berechnen?
 	}
 
-/*	public boolean inBound(double lati, double loni){
+	/*	public boolean inBound(double lati, double loni){
 		boolean isInBound = false;
 		if(topleft.latDec &gt;= lati &amp;&amp; lati &gt;= buttomright.latDec &amp;&amp; topleft.lonDec &lt;= loni &amp;&amp; loni &lt;= buttomright.lonDec) isInBound = true;
 		return isInBound;
 	}
-	*/
+	 */
 	/**
 	 * Method to calculate bitmap x,y of the current map using
 	 * lat and lon target coordinates. There ist no garanty that
@@ -385,7 +404,7 @@
 	public CWPoint calcLatLon(Point p) {
 		return calcLatLon(p.x, p.y);
 	}
-	
+
 	/**
 	 * Get the prefix used for easy and fast finding of the best map
 	 * The filname of the .wfl and respective image should start with this
@@ -395,35 +414,31 @@
 	public String getFfPrefix() {
 		return &quot;FF1&quot;+getEasyFindString()+&quot;E-&quot;;
 	}
-	
-/*	public Area getArea(){
-		return new Area(new CWPoint(topleft), new CWPoint(buttomright));
-	} */
 }
 
-/**
- *	Class based on CWPoint but intended to handle bitmap x and y
- *	Used for georeferencing bitmaps.
- */
-class GCPoint extends CWPoint{
-	public int bitMapX = 0;
-	public int bitMapY = 0;
+	/**
+	 *	Class based on CWPoint but intended to handle bitmap x and y
+	 *	Used for georeferencing bitmaps.
+	 */
+	class GCPoint extends CWPoint{
+		public int bitMapX = 0;
+		public int bitMapY = 0;
 
-	public GCPoint(){
-	}
+		public GCPoint(){
+		}
 
-	public GCPoint(CWPoint p) {
-		super(p);
-	}
+		public GCPoint(CWPoint p) {
+			super(p);
+		}
 
-	public GCPoint(double lat, double lon){
-		this.latDec = lat;
-		this.lonDec = lon;
-		this.utmValid = false;
-	}
-	public GCPoint(CWPoint ll, Point px) {
-		super(ll);
-		bitMapX = px.x;
-		bitMapY = px.y;
-	}
-}
\ No newline at end of file
+		public GCPoint(double lat, double lon){
+			this.latDec = lat;
+			this.lonDec = lon;
+			this.utmValid = false;
+		}
+		public GCPoint(CWPoint ll, Point px) {
+			super(ll);
+			bitMapX = px.x;
+			bitMapY = px.y;
+		}
+	}
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapLoader.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoader.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/MapLoader.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -1,8 +1,10 @@
 package CacheWolf.navi;
 
 import CacheWolf.CWPoint;
+import CacheWolf.Common;
 import CacheWolf.HttpConnection;
 import CacheWolf.InfoBox;
+import CacheWolf.Preferences;
 import ewe.ui.*;
 import ewe.io.*;
 import ewe.fx.*;
@@ -12,6 +14,8 @@
 import ewe.net.*;
 import java.lang.Math;
 
+import utils.FileBugfix;
+
 /**
  *
  */
@@ -27,12 +31,8 @@
 	String port = new String();
 	InfoBox progressInfobox;
 
-	final static float downloadMapScaleFactorExpedia_east = 3950;
-	final static float MAPBLAST_METERS_PER_PIXEL = 1.0f/2817.947378f;
-	final static float EXPEDIA_METERS_PER_PIXEL = downloadMapScaleFactorExpedia_east * MAPBLAST_METERS_PER_PIXEL; 
-
 	Vector onlineMapServices = new Vector();
-
+	OnlineMapService currentOnlineMapService;
 	int numMapsY;
 	int numMapsX;
 	double latinc;
@@ -40,15 +40,62 @@
 	CWPoint topleft;
 	CWPoint buttomright;
 	Point tilesSize;
-	int tileScale;
+	float tileScale;
 
 	public MapLoader(String prxy, String prt){
 		port = prt;
 		proxy = prxy;
 		progressInfobox = null;
+		onlineMapServices = new Vector();
+		String dateien[];
+		FileBugfix files = new FileBugfix(&quot;.&quot;);
+		String FileName;
+		OnlineMapService tempOMS;
+		tempOMS = new ExpediaMapService();
+		onlineMapServices.add(tempOMS);
+		MessageBox f = null; 
+		dateien = files.list(&quot;*.wms&quot;, File.LIST_FILES_ONLY); //&quot;*.xyz&quot; doesn't work on some systems -&gt; use FileBugFix
+		for(int i = 0; i &lt; dateien.length;i++){
+			FileName = dateien[i];
+			try {
+				tempOMS = new WebMapService(FileName);
+				onlineMapServices.add(tempOMS);
+			}catch(Exception ex){ 
+				if (f == null) (f=new MessageBox(&quot;Warning&quot;, &quot;Ignoring error while \n reading web map service definition file \n&quot;+ex.toString(), MessageBox.OKB)).exec();
+			}
+		}
+		
 	}
+	
+	public String[] getAvailableOnlineMapServices(){
+		int s = onlineMapServices.size();
+		String[] services = new String[s];
+		for (int i=0; i &lt; s; i++) {
+			services[i]=onlineMapServices.get(i).toString();
+		}
+		return services;
+	}
+	
+	public void setCurrentMapService(int index) {
+		currentOnlineMapService = (OnlineMapService) onlineMapServices.get(index);
+	}
 
 	/**
+	 * calculates the Expedia Alti = scale which fits in distance to its edges
+	 * @param center
+	 * @param distance in meters
+	 * @return meters per pixel calculatet in a way that the circle around center
+	 * is completly within the map
+	 */
+
+	public static float getScale(CWPoint center, float distance, Point size) {
+		float scaleLatO = distance * 2 / size.y;
+		float scaleLonO = distance * 2 / size.x;
+		float scaleO = (scaleLatO &lt; scaleLonO ? scaleLonO : scaleLatO);
+		return scaleO;
+	}
+
+	/**
 	 * download maps from expedia at zoomlevel alti and save the maps and the .wfl 
 	 * in path
 	 * @param center centre of all tiles
@@ -59,7 +106,7 @@
 	 * @param path without &quot;/&quot; at the end
 	 * 
 	 */
-	public void setTiles (CWPoint center, float radius, int scale, Point size, int overlapping) {
+	public void setTiles (CWPoint center, float radius, float scale, Point size, int overlapping) {
 		double metersPerLat = (1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0)));
 		double metersPerLon = metersPerLat * java.lang.Math.cos(center.latDec/180*java.lang.Math.PI);
 		topleft = new CWPoint(center.latDec + (radius / metersPerLat), center.lonDec - (radius / metersPerLon));
@@ -68,16 +115,16 @@
 		this.setTiles(topleft, buttomright, scale, size, overlapping);
 	}
 
-	public void setTiles(CWPoint toplefti, CWPoint buttomrighti, int scale, Point size, int overlapping) {
+	public void setTiles(CWPoint toplefti, CWPoint buttomrighti, float scale, Point size, int overlapping) {
 		//if (toplefti.latDec &lt;= buttomrighti.latDec || toplefti.lonDec &gt;= toplefti.lonDec) throw new IllegalArgumentException(&quot;topleft must be left and above buttom right&quot;);
 		topleft = new CWPoint(toplefti);
 		buttomright = new CWPoint(buttomrighti);
 		double metersPerLat = (1000*(new CWPoint(0,0)).getDistance(new CWPoint(1,0)));
 		double metersPerLon = metersPerLat * java.lang.Math.cos((toplefti.latDec + buttomright.latDec)/2/180*java.lang.Math.PI);
+		double metersperpixel = currentOnlineMapService.getMetersPerPixel(scale);
+		double pixelsPerLat = metersPerLat / metersperpixel;
+		double pixelsPerLon = metersPerLon / metersperpixel;
 
-		double pixelsPerLat = metersPerLat / (EXPEDIA_METERS_PER_PIXEL * scale);
-		double pixelsPerLon = metersPerLon / (EXPEDIA_METERS_PER_PIXEL * scale);
-
 		//over all pixelsize without borders
 		double pixelsY = (topleft.latDec - buttomright.latDec) * pixelsPerLat; 
 		double pixelsX = -(topleft.lonDec - buttomright.lonDec) * pixelsPerLon ; 
@@ -116,40 +163,26 @@
 	public void downlaodTiles(String tilesPath) {
 		double lat = topleft.latDec;
 		double lon = topleft.lonDec;
+		CWPoint center = new CWPoint();
 		for (int row = 1; row &lt;= numMapsY; row++) {
 			lon = topleft.lonDec;
 			for (int col = 1; col &lt;= numMapsX; col++) {
 				if (progressInfobox != null)
-					progressInfobox.setInfo(&quot;Downloading calibrated (georeferenced) \n map image from www.expedia.com \n Downloading tile \n row &quot;+row+&quot; / &quot;+numMapsY+&quot; column &quot;+ col + &quot; / &quot;+numMapsX);
-				downloadMap(lat, lon, tileScale, tilesSize.x, tilesSize.y, tilesPath);
+					progressInfobox.setInfo(&quot;Downloading calibrated (georeferenced) \n map image \n '&quot; + currentOnlineMapService.getName()+&quot;' \n Downloading tile \n row &quot;+row+&quot; / &quot;+numMapsY+&quot; column &quot;+ col + &quot; / &quot;+numMapsX);
+				center.set(lat, lon);
+				downloadMap(center, tileScale, tilesSize, tilesPath);
+				if (progressInfobox.isClosed) return;
 				lon += loninc;
 			}
 			lat += latinc;
 		}
 	}
 
-	/*
-	public void loadTo(String a, String b) {
-		//loadTo(a, b, &quot;50.74&quot;, &quot;7.095&quot;);
-	}
-	 */
-
 	public void setProgressInfoBox (InfoBox progrssInfoboxi) {
 		progressInfobox = progrssInfoboxi;
 	}
-	/**
-	 * calculates the Expedia Alti = scale which fits in distance to its edges
-	 * @param center
-	 * @param distance in meters
-	 */
-	public static int getExpediaAlti(CWPoint center, float distance, Point size) {
-		int scaleLatO = (int) java.lang.Math.ceil(( distance * 2 / EXPEDIA_METERS_PER_PIXEL / size.y));
-		int scaleLonO = (int) java.lang.Math.ceil(( distance * 2 / EXPEDIA_METERS_PER_PIXEL / size.x));
-		int scaleO = (scaleLatO &lt; scaleLonO ? scaleLonO : scaleLatO);
-		//loadTo((topleft.latDec + buttomright.latDec)/2, (topleft.lonDec + buttomright.lonDec)/2, scaleO, size.x, size.y, path+&quot;/expedia_alti&quot;+scaleO+&quot;_lat&quot;+latD.toString()+&quot;_lon&quot;+lonD.toString());
-		return scaleO;
-	}
 
+	/*
 	public static String createExpediaFilename(double lat, double lon, int alti) {
 		Double latD = new Double(), lonD = new Double();
 		latD.decimalPlaces = 4;
@@ -158,111 +191,199 @@
 		lonD.set(lon);
 		return &quot;expedia_alti&quot;+alti+&quot;_lat&quot;+latD.toString().replace(',', '.')+&quot;_lon&quot;+lonD.toString().replace(',', '.')+&quot;.gif&quot;;
 	}
-
 	public void downloadMap(double lat, double lon, int alti, int PixelWidth, int PixelHeight, String path){
 		loadTo(lat, lon, alti, PixelWidth, PixelHeight, path+&quot;/&quot;+createExpediaFilename(lat, lon, alti));
 	}
+	 */
 
-	public void loadTo(double lat, double lon, int alti, int PixelWidth, int PixelHeight, String datei){
-		HttpConnection connImg, conn2;
-		Socket sockImg, sock2;
-		InputStream is;
+	public void downloadMap(Area surArea, Point pixelsize, String path){
+		try {
+			MapInfoObject mio = currentOnlineMapService.getMapInfoObject(surArea, pixelsize);
+			String filename = createFilename(mio.getCenter(), mio.scale);
+			String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
+			String url = currentOnlineMapService.getUrlForBoundingBox(surArea, pixelsize);
+			downloadUrl(url, path+&quot;/&quot;+imagename);
+			mio.saveWFL();
+		} catch (Exception e) {
+			this.progressInfobox.addWarning(&quot;Ignoring error during map download, saving or calibration:\n&quot; + e.getMessage()+&quot;\n&quot;);
+		}
+	}
+
+	public void downloadMap(CWPoint center, float scale, Point pixelsize, String path){
+		try {
+			MapInfoObject mio = currentOnlineMapService.getMapInfoObject(center, scale, pixelsize);
+			String filename = createFilename(mio.getCenter(), mio.scale);
+			String imagename = mio.setName(path, filename) + currentOnlineMapService.getImageFileExt();
+			String url = currentOnlineMapService.getUrlForCenterScale(center, scale, pixelsize);
+			downloadUrl(url, path+&quot;/&quot;+imagename);
+			mio.saveWFL();
+		} catch (Exception e) {
+			this.progressInfobox.addWarning(&quot;Ignoring error during map download, saving or calibration:\n&quot; + e.getMessage()+&quot;\n&quot;);
+		}
+	}
+	
+	public String createFilename(CWPoint center, float scale) {
+		String filename = Common.ClearForFileName(currentOnlineMapService.getName()+&quot;_s&quot;+Common.DoubleToString(scale, 1)
+		+ &quot;_c&quot; + center.toString(CWPoint.LAT_LON).replace(',', '-'));
+		return filename;
+	}
+
+	/**
+	 * @param url usual URL. If a redirect is requiered (as in the case of 
+	 * Expedia, add an &quot;R&quot; before &quot;<A HREF="http://">http://</A>&quot; --&gt; Don't download the url, retry until getting a http-redirect
+	 * this is necessary for expedia as it delivers the image only after a http-redirect
+	 * and sometimes doesn't send a redirect on the first try 
+	 * @param datei path and name of file to save to
+	 */
+	public void downloadUrl(String url, String datei){
+		HttpConnection connImg; // TODO move proxy-handling in a global http-class
+		Socket sockImg;
 		FileOutputStream fos;
 		ByteArray daten;
-		String quelle = new String();
-		String zone;
-		// prepare MapInfoObject and get fileprefix
-		File dateiF = new File(datei); // change!!!
-		String tmp = dateiF.getName(); // contains the name and the extension
-		String name = tmp.substring(0, tmp.lastIndexOf(&quot;.&quot;));
-		float metersPerPixel = (float) (alti)*EXPEDIA_METERS_PER_PIXEL;
-		MapInfoObject cal = new MapInfoObject(metersPerPixel, new CWPoint(lat,lon),  PixelWidth, PixelHeight, name);
-		String pref = cal.getFfPrefix();
-		cal.mapName = pref + cal.mapName;
-		cal.fileNameWFL = pref + cal.fileNameWFL;
-		datei = dateiF.getPath()+&quot;/&quot;+ pref + tmp;
-		// download image
-		if (lon &lt;= -10) zone = &quot;USA0409&quot;;
-		else zone = &quot;EUR0809&quot;;
-
-		/*
-		 * information from: DownloadMouseMode.properties in project GPSylon ( in directory gpsylon_src-0.5.2\plugins\downloadmousemode\auxiliary\org\dinopolis\gpstool\plugin\downloadmousemode and DownloadMapCalculator.java in Dir gpsylon_src-0.5.2\plugins\downloadmousemode\src\org\dinopolis\gpstool\plugin\downloadmousemode 
-		 * download.map.url.expedia_east=http\://www.expedia.com/pub/agent.dll?qscr=mrdt&amp;ID=3XNsF.&amp;CenP={0,number,#.########},{1,number,#.########}&amp;Lang=EUR0809&amp;Alti={2,number,#}&amp;Size={3,number,#},{4,number,#}&amp;Offs=0.000000,0.000000\&amp;BCheck=1
-		 * download.map.url.expedia_east.title=Url of Expedia Europe
-		 * download.map.scale_factor.expedia_east=3950
-		 */
-		Double latD = new Double();
-		latD.decimalPlaces = 8;
-		latD.set(lat);
-		Double lonD = new Double();
-		lonD.decimalPlaces = 8;
-		lonD.set(lon);
-		quelle = &quot;<A HREF="http://www.expedia.de/pub/agent.dll?qscr=mrdt">http://www.expedia.de/pub/agent.dll?qscr=mrdt</A>&quot;;
-		quelle = quelle + &quot;&amp;ID=3kQaz.&quot;;
-		quelle = quelle + &quot;&amp;CenP=&quot; + latD.toString().replace(',', '.') + &quot;,&quot; + lonD.toString().replace(',', '.');
-		quelle = quelle + &quot;&amp;Alti=&quot;+Convert.toString(alti)+&quot;&amp;Lang=&quot;+zone+&quot;&amp;Size=&quot;+Convert.toString(PixelWidth)+&quot;,&quot;+Convert.toString(PixelHeight)+&quot;&amp;Offs=0,0&amp;MapS=0&quot;; //&amp;Pins=|&quot; + latD.toString().replace(',', '.') + &quot;,&quot; + lonD.toString().replace(',', '.') + &quot;|5|&quot;;
-		//Vm.debug(lat + &quot;,&quot; + lon);
+		String realurl;
+		boolean forceredirect;
+		if (url.startsWith(&quot;R&quot;)) {
+			forceredirect = true;
+			realurl = url.substring(1, url.length());
+		} else {
+			forceredirect = false;
+			realurl = url;
+		}
 		if(proxy.length()&gt;0){
-			connImg = new HttpConnection(proxy, Convert.parseInt(port), quelle);
+			connImg = new HttpConnection(proxy, Convert.parseInt(port), realurl);
 			//Vm.debug(&quot;Loading quelle: &quot; + quelle);
 		}else{
-			connImg = new HttpConnection(quelle);
+			connImg = new HttpConnection(realurl);
 		}
-		//datei = &quot;d:\\temp\\test_map.bmp&quot;;
 		connImg.setRequestorProperty(&quot;USER_AGENT&quot;, &quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0&quot;);
 		connImg.setRequestorProperty(&quot;Connection&quot;, &quot;close&quot;);
 		connImg.setRequestorProperty(&quot;Cookie&quot;, &quot;jscript=1; path=/;&quot;);
 		connImg.documentIsEncoded = true;
 		try{
-			dateiF = new File(datei);
+			File dateiF = new File(datei);
 			if(!dateiF.exists()){
 				int i=0;
-				quelle = null;
-				while (quelle == null &amp;&amp; i &lt; 5) { // this is necessary because expedia sometimes doesn't directly anser with the redirect to the map-image, but give a page in between. Solved the problem by retrying see also: <A HREF="http://www.geoclub.de/viewtopic.php?p=305071#305071">http://www.geoclub.de/viewtopic.php?p=305071#305071</A>
-					sockImg = connImg.connect();
+				sockImg = connImg.connect();
+				String quelle = connImg.getRedirectTo();
+				boolean redirrected = false;
+				while (i &lt; 5 &amp;&amp; (quelle != null || (forceredirect &amp;&amp; !redirrected))) { // this is necessary because expedia sometimes doesn't directly anser with the redirect to the map-image, but give a page in between. Solved the problem by retrying see also: <A HREF="http://www.geoclub.de/viewtopic.php?p=305071#305071">http://www.geoclub.de/viewtopic.php?p=305071#305071</A>
 					//Vm.debug(&quot;Redirect: &quot; + i + connImg.getRedirectTo());
-					quelle = connImg.getRedirectTo();
-					sockImg.close();
+					if (quelle != null) {
+						redirrected = true;
+						sockImg.close();
+						connImg = connImg.getRedirectedConnection(quelle);
+						sockImg = connImg.connect();
+						quelle = connImg.getRedirectTo();
+					}
 					i++;
 				}
 				if (i &gt; 4) throw new IOException(&quot;loadTo: failed to download map: didn't get http-redirect&quot;);
-				if(proxy.length()&gt;0){
-					connImg = new HttpConnection(proxy, Convert.parseInt(port), quelle);
-				}else{
-					connImg = new HttpConnection(quelle);
-				}
-				connImg.setRequestorProperty(&quot;USER_AGENT&quot;, &quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0&quot;);
-				connImg.setRequestorProperty(&quot;Connection&quot;, &quot;close&quot;);
-				connImg.setRequestorProperty(&quot;Cookie&quot;, &quot;jscript=1; path=/;&quot;);
-				connImg.documentIsEncoded = true;
-				sock2 = connImg.connect();
-				daten = connImg.readData(sock2);
+				daten = connImg.readData(sockImg);
 				fos = new FileOutputStream(dateiF);
 				fos.write(daten.toBytes());
 				fos.close();
-				sock2.close();
+				sockImg.close();
 			}
 			//Vm.debug(&quot;done&quot;);
 		}catch(IOException e){
 			(new MessageBox(&quot;Error&quot;, &quot;Error while downloading or saving map:\n&quot;+e.getMessage(), MessageBox.OKB)).exec();
 		}
-		try {
-			cal.saveWFL(dateiF.getDrivePath(), cal.fileNameWFL);
-		} catch (IOException e) {
-			(new MessageBox(&quot;Error&quot;, &quot;Error saving calibration file:\n&quot;+e.getMessage(), MessageBox.OKB)).exec();
-		}
+//		(new MessageBox(&quot;Error&quot;, &quot;Error saving calibration file:\n&quot;+e.getMessage(), MessageBox.OKB)).exec();
+
 	}
 }
 
 class OnlineMapService {
 	String name;
 	String MainUrl; //<A HREF="http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS">http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS</A>
+	/** including &quot;.&quot; */
+	String imageFileExt; // &quot;.gif&quot;, &quot;.jpg&quot;...
+
+	/** 
+	 * This method is used in case the online map service provides only certain steps of 
+	 * zoomlevels. In this case the scale in meters per pixel must be returned, which
+	 * will be used instead of the wished scale. 
+	 * 
+	 * @param scale
+	 * @return
+	 */
+	public float getMetersPerPixel(float scale) {
+		return scale;
+	}
+
+	public String getImageFileExt() {
+		return imageFileExt;
+	}
+
+	/** 
+	 * Overlaod this to integrate name of layers
+	 * @return friendly service name
+	 */
+	public String getName() {
+		return name;
+	}
+	/**
+	 * Overload this and return the URL to the map image, don't call super
+	 * Alternatively overload getUrlForBoundingBox
+	 * You must overload either this method or getUrlForBoundingBox
+	 * @param center
+	 * @param scale
+	 * @param pixelsize
+	 * @return
+	 */
+	public String getUrlForCenterScale(CWPoint center, float scale, Point pixelsize) {
+		Area bbox = CenterScaleToArea(center, scale, pixelsize);
+		String url = getUrlForBoundingBox(bbox, pixelsize);
+		return url;
+	}
+
+	public String getUrlForBoundingBox(Area surArea, Point pixelsize) {
+		CWPoint center = new CWPoint((surArea.topleft.latDec + surArea.buttomright.latDec)/2, (surArea.topleft.lonDec + surArea.buttomright.lonDec)/2);
+		double radiuslat = (new CWPoint(center.latDec, surArea.buttomright.lonDec)).getDistance(surArea.buttomright);
+		double radiuslon = (new CWPoint(surArea.buttomright.latDec, center.lonDec)).getDistance(surArea.buttomright);
+		float radius, scale;
+		if (radiuslat &lt;= radiuslon) {
+			radius = (float) radiuslon;
+			scale = (float) (radiuslon / (double) pixelsize.x);
+		} else {
+			radius = (float) radiuslat;
+			scale = (float) (radiuslat / (double) pixelsize.y);
+		}
+		String ret = getUrlForCenterScale(center, scale, pixelsize);
+		//int expediaAlti = ((ExpediaMapService)currentOnlineMapService).getZoomlevel(center, radius * 1000, pixelsize);
+		return ret;
+		//throw new IllegalArgumentException(&quot;OnlineMapService: getUrlForBoundingBox:\n This method must be overloaded in order to be able to use it&quot;);
+	}
+
+	public Area CenterScaleToArea(CWPoint center, float scale, Point pixelsize) {
+		Area bbox = new Area();
+		bbox.topleft = new CWPoint (center);
+		bbox.topleft.shift(-pixelsize.x * scale / 2, 1);
+		bbox.topleft.shift(pixelsize.y * scale /2, 0);
+		bbox.buttomright = new CWPoint (center);
+		bbox.buttomright.shift(pixelsize.x * scale / 2, 1);
+		bbox.buttomright.shift(-pixelsize.y * scale /2, 0);
+		return bbox;
+	}
+	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
+		throw new IllegalArgumentException(&quot;OnlineMapService: getMapInfoObject(Area maparea, Point pixelsize):\n This method must be overloaded in order to be able to use it&quot;);
+	}
+
+	public MapInfoObject getMapInfoObject(CWPoint center, float scale, Point pixelsize) {
+		return getMapInfoObject(CenterScaleToArea(center, scale, pixelsize), pixelsize);
+		//throw new IllegalArgumentException(&quot;OnlineMapService: (CWPoint center, double zoomlevel, Point pixelsize):\n This method must be overloaded in order to be able to use it&quot;);
+	}
+	
+	public String toString() {
+		return getName();
+	}
 }
 
 class WebMapService extends OnlineMapService {
 	String layersName;
 	String layersUrlPart; //
 	String versionUrlPart; // VERSION=1.1.0
+	String serviceTypeUrlPart; //&quot;SERVICE=WMS&quot; 
 	int coordinateReferenceSystem; // WGS84: 4326, German GK: 31466 / 
 	String coordinateReferenceSystemUrlPart; //&amp;SRS=EPSG:31466
 	String requestUrlPart;
@@ -271,41 +392,55 @@
 	Area boundingBox;
 	double minscale;
 	double maxscale;
-	
+
+	public String getName() {
+		if (layersName == null || layersName.length() == 0)	return name;
+		return name + &quot;_&quot; + layersName;
+	}
+
+	/**
+	 * 
+	 * @param filename without file extension
+	 * @throws IOException
+	 * @throws IllegalArgumentException
+	 */
 	public WebMapService (String filename) throws IOException, IllegalArgumentException{
-		FileInputStream in = new FileInputStream(filename + &quot;.wms&quot;);
+		FileInputStream in = new FileInputStream(filename);
 		Properties wms = new Properties();
 		wms.load(in);
 		in.close();
-		name = wms.getProperty(&quot;Name&quot;, null);
-		if (name == null) throw new IllegalArgumentException(&quot;WebMapService: property &gt;Name:&lt; missing in file:\n&quot; + filename);
-		MainUrl = wms.getProperty(&quot;MainUrl&quot;, null);
-		if (MainUrl == null) throw new IllegalArgumentException(&quot;WebMapService: property &gt;MainUrl:&lt; missing in file:\n&quot; + filename);
-		layersName = wms.getProperty(&quot;LayersName&quot;, &quot;missing layersname&quot;);
-		layersUrlPart = wms.getProperty(&quot;LayersUrlPart&quot;, &quot;&quot;);
-		versionUrlPart = wms.getProperty(&quot;VersionUrlPart&quot;, &quot;&quot;);
-		coordinateReferenceSystem = Convert.toInt(wms.getProperty(&quot;CoordinateReferenceSystemCacheWolf&quot;, &quot;0&quot;));
+		name = wms.getProperty(&quot;Name&quot;, &quot;&quot;).trim();
+		if (name == &quot;&quot;) throw new IllegalArgumentException(&quot;WebMapService: property &gt;Name:&lt; missing in file:\n&quot; + filename);
+		MainUrl = wms.getProperty(&quot;MainUrl&quot;, &quot;&quot;).trim();;
+		if (MainUrl == &quot;&quot;) throw new IllegalArgumentException(&quot;WebMapService: property &gt;MainUrl:&lt; missing in file:\n&quot; + filename);
+		layersName = wms.getProperty(&quot;LayersName&quot;, &quot;missing layersname&quot;).trim();
+		serviceTypeUrlPart = wms.getProperty(&quot;ServiceTypeUrlPart&quot;, &quot;SERVICE=WMS&quot;).trim();
+		layersUrlPart = wms.getProperty(&quot;LayersUrlPart&quot;, &quot;&quot;).trim();;
+		versionUrlPart = wms.getProperty(&quot;VersionUrlPart&quot;, &quot;&quot;).trim();;
+		coordinateReferenceSystem = Convert.toInt(wms.getProperty(&quot;CoordinateReferenceSystemCacheWolf&quot;, &quot;0&quot;).trim());
 		if (!TransformCoordinates.isSupported(coordinateReferenceSystem)) throw new IllegalArgumentException(&quot;Coordinate reference system not supported by CacheWolf:\n&quot; + coordinateReferenceSystem);
-		coordinateReferenceSystemUrlPart = wms.getProperty(&quot;CoordinateReferenceSystemUrlPart&quot;, null);
-		if (coordinateReferenceSystemUrlPart == null) throw new IllegalArgumentException(&quot;CoordinateReferenceSystemUrlPart: property &gt;MainUrl:&lt; missing in file:\n&quot; + filename);
-		requestUrlPart = wms.getProperty(&quot;RequestUrlPart&quot;, &quot;&quot;);
-		imageFormatUrlPart = wms.getProperty(&quot;ImageFormatUrlPart&quot;, &quot;REQUEST=GetMap&quot;);
-		stylesUrlPart = wms.getProperty(&quot;StylesUrlPart&quot;, &quot;&quot;);
-		String topleftS = wms.getProperty(&quot;BoundingBoxTopLeftWGS84&quot;, &quot;&quot;);
-		String buttomrightS = wms.getProperty(&quot;BoundingBoxButtomRightWGS84&quot;, &quot;&quot;);
+		coordinateReferenceSystemUrlPart = wms.getProperty(&quot;CoordinateReferenceSystemUrlPart&quot;, &quot;&quot;).trim();
+		if (coordinateReferenceSystemUrlPart == &quot;&quot;) throw new IllegalArgumentException(&quot;CoordinateReferenceSystemUrlPart: property &gt;MainUrl:&lt; missing in file:\n&quot; + filename);
+		requestUrlPart = wms.getProperty(&quot;RequestUrlPart&quot;, &quot;REQUEST=GetMap&quot;).trim();
+		imageFormatUrlPart = wms.getProperty(&quot;ImageFormatUrlPart&quot;, &quot;&quot;).trim();
+		stylesUrlPart = wms.getProperty(&quot;StylesUrlPart&quot;, &quot;&quot;).trim();
+		String topleftS = wms.getProperty(&quot;BoundingBoxTopLeftWGS84&quot;, &quot;&quot;).trim();
+		String buttomrightS = wms.getProperty(&quot;BoundingBoxButtomRightWGS84&quot;, &quot;&quot;).trim();
 		CWPoint topleft = new CWPoint(topleftS);
 		CWPoint buttomright = new CWPoint(buttomrightS);
 		if (!topleft.isValid()) topleft.set(90, -180);
 		if (!buttomright.isValid()) buttomright.set(-90, 180);
 		boundingBox = new Area (topleft, buttomright);
-		minscale = Convert.toDouble(wms.getProperty(&quot;MinScale&quot;, &quot;0&quot;));
-		maxscale = Convert.toDouble(wms.getProperty(&quot;MaxScale&quot;, Convert.toString(java.lang.Double.MAX_VALUE)));
+		minscale = Convert.toDouble(wms.getProperty(&quot;MinScale&quot;, &quot;0&quot;).trim());
+		maxscale = Convert.toDouble(wms.getProperty(&quot;MaxScale&quot;, Convert.toString(java.lang.Double.MAX_VALUE)).trim());
+		imageFileExt = wms.getProperty(&quot;ImageFileExtension&quot;, &quot;&quot;).trim();
+		if (imageFileExt == &quot;&quot;) throw new IllegalArgumentException(&quot;WebMapService: property &gt;ImageFileExtension:&lt; missing in file:\n&quot; + filename);
 	}
 
 	public String getUrlForBoundingBox(Area maparea, Point pixelsize) {
-		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException(&quot;area: &quot; + maparea.toString() + &quot;not covered by service: &quot; + name + &quot;service area: &quot; + boundingBox.toString());
+		if (!boundingBox.isOverlapping(maparea)) throw new IllegalArgumentException(&quot;area: &quot; + maparea.toString() + &quot; not covered by service: &quot; + name + &quot;, service area: &quot; + boundingBox.toString());
 		double scale = maparea.buttomright.getDistance(maparea.topleft) * 1000 / Math.sqrt(pixelsize.x * pixelsize.x + pixelsize.y * pixelsize.y); // meters per pixel measured diagonal
-		if ( scale &lt; minscale || scale &gt; maxscale) throw new IllegalArgumentException(&quot;scale not support by online map service: &quot; + scale + &quot;\n supported scale range: &quot; + minscale + &quot;-&quot; + maxscale);
+		if ( scale &lt; minscale || scale &gt; maxscale) throw new IllegalArgumentException(&quot;scale not support by online map service: &quot; + scale + &quot;, supported scale range: &quot; + minscale + &quot; - &quot; + maxscale);
 		// <A HREF="http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS&amp;VERSION=1.1.0&amp;REQUEST=GetMap&amp;SRS=EPSG:31466&amp;BBOX=2577567.0149,5607721.7566,2578567.0077,5608721.7602&amp;WIDTH=500&amp;HEIGHT=500&amp;LAYERS=Raster:TK25_KMF:Farbkombination&amp;STYLES=&amp;FORMAT=image/png">http://www.geoserver.nrw.de/GeoOgcWms1.3/servlet/TK25?SERVICE=WMS&amp;VERSION=1.1.0&amp;REQUEST=GetMap&amp;SRS=EPSG:31466&amp;BBOX=2577567.0149,5607721.7566,2578567.0077,5608721.7602&amp;WIDTH=500&amp;HEIGHT=500&amp;LAYERS=Raster:TK25_KMF:Farbkombination&amp;STYLES=&amp;FORMAT=image/png</A>
 		CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
 		CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
@@ -315,40 +450,94 @@
 		else if (coordinateReferenceSystem == TransformCoordinates.EPSG_WGS84) 
 			bbox += buttomleft.toString(CWPoint.LON_LAT)  + &quot;,&quot; + topright.toString(CWPoint.LON_LAT);
 		else throw new IllegalArgumentException(&quot;Coordinate system not supported by cachewolf: &quot; + coordinateReferenceSystem);
-		String ret = MainUrl + &quot;&amp;&quot;+ versionUrlPart + &quot;&amp;&quot; + requestUrlPart + &quot;&amp;&quot; + 
+		String ret = MainUrl + &quot;SERVICE=WMS&quot; + &quot;&amp;&quot;+ versionUrlPart + &quot;&amp;&quot; + requestUrlPart + &quot;&amp;&quot; + 
 		coordinateReferenceSystemUrlPart + &quot;&amp;&quot; + bbox + 
 		&quot;&amp;WIDTH=&quot; + pixelsize.x + &quot;&amp;HEIGHT=&quot; + pixelsize.y + &quot;&amp;&quot; + 
 		layersUrlPart + &quot;&amp;&quot; + stylesUrlPart + &quot;&amp;&quot; + imageFormatUrlPart; 
 		return ret;
 	}
 
+
 	public MapInfoObject getMapInfoObject(Area maparea, Point pixelsize) {
 		Vector georef = new Vector(4);
 
 		// calculate a rectangle in the according coordinate reference system
 		CWPoint buttomleft = new CWPoint (maparea.buttomright.latDec, maparea.topleft.lonDec);
 		CWPoint topright = new CWPoint (maparea.topleft.latDec, maparea.buttomright.lonDec);
-		CWPoint topleft;
-		CWPoint buttomright;
-		if (coordinateReferenceSystem == 31466 || coordinateReferenceSystem == 31467) {
+		CWPoint topleft = new CWPoint(maparea.topleft);
+		CWPoint buttomright = new CWPoint(maparea.buttomright);
+		double metersperpixalhorizontal = ( buttomright.getDistance(buttomleft) + topleft.getDistance(topright))/2 * 1000 / pixelsize.x; 
+		double metersperpixalvertical = ( buttomright.getDistance(topright) + topleft.getDistance(buttomright))/2 * 1000 / pixelsize.y;
+		if (TransformCoordinates.isGermanGk(coordinateReferenceSystem)) {
 			GkPoint buttomleftgk = TransformCoordinates.wgs84ToGkGermany(buttomleft);
 			GkPoint toprightgk = TransformCoordinates.wgs84ToGkGermany(topright);
+			// bounding box in WMS is defined around the pixels, not exactly on the pixels --&gt; the bounding box must be reduced on all edges by half a pixel
+			buttomleftgk.shift(metersperpixalhorizontal / 2, 1);
+			buttomleftgk.shift(metersperpixalvertical / 2, 0);
+			toprightgk.shift(-metersperpixalhorizontal / 2, 1);
+			toprightgk.shift(-metersperpixalvertical / 2, 0);
 			GkPoint topleftgk = new GkPoint(buttomleftgk.easting, toprightgk.northing);
 			GkPoint buttomrightgk = new GkPoint(toprightgk.easting, buttomleftgk.northing);
+
 			topleft = TransformCoordinates.gkGermanyToWgs84(topleftgk);
 			buttomright = TransformCoordinates.gkGermanyToWgs84(buttomrightgk);
-		} else if (coordinateReferenceSystem == 4326) {
-			topleft = maparea.topleft;
-			buttomright = maparea.buttomright;
+			buttomleft = TransformCoordinates.gkGermanyToWgs84(buttomleftgk);
+			topright = TransformCoordinates.gkGermanyToWgs84(toprightgk);
+		} else if (coordinateReferenceSystem == TransformCoordinates.EPSG_WGS84) {
+			// bounding box in WMS is defined around the pixels, not exactly on the pixels --&gt; the bounding box must be reduced on all edges by half a pixel
+			topleft.shift(metersperpixalhorizontal / 2, 1);
+			topleft.shift(-metersperpixalvertical / 2, 0);
+			buttomright.shift(-metersperpixalhorizontal, 1);
+			buttomright.shift(metersperpixalhorizontal, 0);
+			buttomleft = new CWPoint (buttomright.latDec, topleft.lonDec);
+			topright = new CWPoint (topleft.latDec, buttomright.lonDec);
 		} else throw new IllegalArgumentException(&quot;getMapInfoObject: Coordinate system not supported by cachewolf: &quot; + coordinateReferenceSystem);
-
 		georef.add(new GCPoint(topleft, new Point(0, 0)));
 		georef.add(new GCPoint(buttomright, new Point(pixelsize.x, pixelsize.y)));
 		georef.add(new GCPoint(buttomleft, new Point(0, pixelsize.y)));
 		georef.add(new GCPoint(topright, new Point(pixelsize.x, 0)));
-		
+
 		MapInfoObject ret = new MapInfoObject();
 		ret.evalGCP(georef, pixelsize.x, pixelsize.y);
 		return ret;
 	}
+}
+
+class ExpediaMapService extends OnlineMapService {
+	/*
+	 * information from: DownloadMouseMode.properties in project GPSylon ( in directory gpsylon_src-0.5.2\plugins\downloadmousemode\auxiliary\org\dinopolis\gpstool\plugin\downloadmousemode and DownloadMapCalculator.java in Dir gpsylon_src-0.5.2\plugins\downloadmousemode\src\org\dinopolis\gpstool\plugin\downloadmousemode 
+	 * download.map.url.expedia_east=http\://www.expedia.com/pub/agent.dll?qscr=mrdt&amp;ID=3XNsF.&amp;CenP={0,number,#.########},{1,number,#.########}&amp;Lang=EUR0809&amp;Alti={2,number,#}&amp;Size={3,number,#},{4,number,#}&amp;Offs=0.000000,0.000000\&amp;BCheck=1
+	 * download.map.url.expedia_east.title=Url of Expedia Europe
+	 * download.map.scale_factor.expedia_east=3950
+	 */
+	final static float downloadMapScaleFactorExpedia_east = 3950;
+	final static float MAPBLAST_METERS_PER_PIXEL = 1.0f/2817.947378f;
+	final static float EXPEDIA_METERS_PER_PIXEL = downloadMapScaleFactorExpedia_east * MAPBLAST_METERS_PER_PIXEL; 
+	
+	public ExpediaMapService() {
+		name = &quot;Expedia&quot;;
+		MainUrl = &quot;<A HREF="Rhttp://www.expedia.de/pub/agent.dll?qscr=mrdt&amp;ID=3kQaz.">Rhttp://www.expedia.de/pub/agent.dll?qscr=mrdt&amp;ID=3kQaz.</A>&quot;; //&quot;<A HREF="Rhttp://">Rhttp://</A>&quot; forces doenloadUrl to retry the URL until it gets an http-redirect and then downloads from there 
+		imageFileExt = &quot;.gif&quot;;
+	}
+	
+	public float getMetersPerPixel(float scale) {
+		return (float) Math.ceil(scale) * EXPEDIA_METERS_PER_PIXEL;
+	}
+
+	public String getUrlForCenterScale(CWPoint center, float scale, Point pixelsize) {
+		int zoomlevel = (int)(Math.ceil(scale / EXPEDIA_METERS_PER_PIXEL));
+		String zone;
+		if (center.lonDec &lt;= -10) zone = &quot;USA0409&quot;;
+		else zone = &quot;EUR0809&quot;;
+		String quelle = MainUrl + &quot;&amp;CenP=&quot; + center.toString(CWPoint.LAT_LON);
+		quelle = quelle + &quot;&amp;Alti=&quot;+Convert.toString(zoomlevel)+&quot;&amp;Lang=&quot;+zone+&quot;&amp;Size=&quot;+Convert.toString(pixelsize.x)+&quot;,&quot;+Convert.toString(pixelsize.y)+&quot;&amp;Offs=0,0&amp;MapS=0&quot;; //&amp;Pins=|&quot; + latD.toString().replace(',', '.') + &quot;,&quot; + lonD.toString().replace(',', '.') + &quot;|5|&quot;;
+		return quelle;
+	}
+
+	public MapInfoObject getMapInfoObject(CWPoint center, float scale, Point pixelsize) {
+		float metersPerPixel = (float) getMetersPerPixel(scale);
+		MapInfoObject cal = new MapInfoObject(metersPerPixel, center,  pixelsize.x, pixelsize.y, name);
+		return cal;
+	}
+
 }
\ No newline at end of file

Modified: trunk/src/CacheWolf/navi/MapLoaderGui.java
===================================================================
--- trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/MapLoaderGui.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -26,7 +26,8 @@
 	CellPanel pnlTiles = new CellPanel();
 	CellPanel pnlPerCache = new CellPanel();
 
-	final String descString = &quot;Download georeferenced maps from expedia.com&quot;;
+	final String descString = &quot;Download georeferenced maps\n Select online service:&quot;;
+	mChoice mapServiceChoice;
 	mCheckBox forCachesChkBox = new mCheckBox(&quot;for&quot;);
 	mChoice forSelectedChkBox = new mChoice(new String[] {&quot;all&quot;, &quot;selected&quot;}, 0);
 	mChoice forSelectedChkBoxPerCache = new mChoice(new String[] {&quot;all&quot;, &quot;selected&quot;}, 1);
@@ -44,6 +45,7 @@
 	mCheckBox overviewChkBox = new mCheckBox(&quot;download an overview map&quot;);
 	mCheckBox overviewChkBoxPerCache = new mCheckBox(&quot;download an overview map&quot;);
 
+	MapLoader mapLoader;
 	CWPoint center;
 	Vector cacheDB;
 	boolean perCache;
@@ -60,11 +62,15 @@
 		pref = Global.getPref(); // myPreferences sollte sp&#228;ter auch diese Einstellungen speichern
 		center = new CWPoint(pref.curCentrePt);
 		cacheDB = cacheDBi;
-		// tiles panel
-		MessageArea desc = new MessageArea(descString);
+		mapLoader = new MapLoader(Global.getPref().myproxy, Global.getPref().myproxyport);
+		
+		mapServiceChoice = new mChoice(mapLoader.getAvailableOnlineMapServices(), 0);
+		MessageArea desc = new MessageArea(descString); 
 		desc.modifyAll(mTextPad.NotEditable | mTextPad.DisplayOnly | mTextPad.NoFocus, mTextPad.TakesKeyFocus);
 		desc.borderStyle = mTextPad.BDR_NOBORDER;
-		pnlTiles.addLast(desc);
+		this.addLast(desc);
+		this.addLast(mapServiceChoice);
+		// tiles panel
 		pnlTiles.addNext(forCachesChkBox);
 		pnlTiles.addNext(forSelectedChkBox);
 		pnlTiles.addLast(cachesLbl);
@@ -96,7 +102,6 @@
 		mTab.addCard(pnlTiles, MyLocale.getMsg(1804, &quot;Tiles&quot;), MyLocale.getMsg(1804, &quot;Tiles&quot;));
 
 		// per cache panel
-		pnlPerCache.addLast(new MessageArea(descString));
 		pnlPerCache.addNext(new mLabel(&quot;Download one map for&quot;), CellConstants.DONTSTRETCH, (CellConstants.DONTFILL));
 		pnlPerCache.addNext(forSelectedChkBoxPerCache, CellConstants.DONTSTRETCH, (CellConstants.DONTFILL));
 		pnlPerCache.addLast(new mLabel(&quot;caches&quot;), CellConstants.DONTSTRETCH, (CellConstants.DONTFILL));
@@ -115,17 +120,21 @@
 		this.addLast(mTab);
 	}
 	public String getMapsDir() {
-		return Global.getPref().getMapExpediaSavePath();
+		String ret = Global.getPref().getMapDownloadSavePath(mapLoader.currentOnlineMapService.getName());
+		Global.getPref().saveCustomMapsPath(ret);
+		return ret;
 	}
 	public void downloadTiles() {
 		String mapsDir = getMapsDir();
 		if (mapsDir == null) return;
-		InfoBox progressBox = new InfoBox(&quot;Downloading georeferenced maps&quot;, &quot;Downloading georeferenced maps\n from www.expedia.com&quot;);
-		progressBox.setPreferredSize(230, 150);
+		InfoBox progressBox = new InfoBox(&quot;Downloading georeferenced maps&quot;, &quot;Downloading georeferenced maps\n \n \n \n \n&quot;, InfoBox.PROGRESS_WITH_WARNINGS);
+		progressBox.setPreferredSize(220, 300);
+		progressBox.setInfoHeight(180);
+		progressBox.relayout(false);
 		progressBox.exec();
+		mapLoader.setProgressInfoBox(progressBox);
 		Vm.showWait(true);
 		ewe.fx.Point size = new ewe.fx.Point(1000,1000); // Size of the downloaded maps
-		MapLoader ml = new MapLoader(Global.getPref().myproxy, Global.getPref().myproxyport);
 		if (forCachesChkBox.getState() || perCache) {
 			Area surArea = Global.getProfile().getSourroundingArea(onlySelected); // calculate map boundaries from cacheDB
 			if (surArea == null) {
@@ -134,24 +143,19 @@
 				progressBox.close(0);
 				return;
 			}
-			ml.setTiles(surArea.topleft, surArea.buttomright, (int)scale, size, overlapping );
-			// calculate radius and centre for overview map
-			center = new CWPoint((surArea.topleft.latDec + surArea.buttomright.latDec)/2, (surArea.topleft.lonDec + surArea.buttomright.lonDec)/2);
-			double radiuslat = (new CWPoint(center.latDec, surArea.buttomright.lonDec)).getDistance(surArea.buttomright);
-			double radiuslon = (new CWPoint(surArea.buttomright.latDec, center.lonDec)).getDistance(surArea.buttomright);
-			radius = (float) (radiuslat &lt; radiuslon ? radiuslon : radiuslat);
+			mapLoader.setTiles(surArea.topleft, surArea.buttomright, scale, size, overlapping );
 		} else 
 		{ // calculate from centre point an radius
-			ml.setTiles(center, radius * 1000, (int)scale, size, overlapping);
+			mapLoader.setTiles(center, radius * 1000, scale, size, overlapping);
 		}
 		if (overviewmap) {
 			progressBox.setInfo(&quot;downloading overview map&quot;); 
-			int expediaAlti = MapLoader.getExpediaAlti(center, radius * 1000, size);
-			ml.downloadMap(center.latDec, center.lonDec, expediaAlti, size.x, size.y, mapsDir);
+			float scale = MapLoader.getScale(center, radius * 1000, size);
+			mapLoader.downloadMap(center, scale, size, mapsDir);
 		}
 		if (!perCache){  // download tiles
-			ml.setProgressInfoBox(progressBox);
-			ml.downlaodTiles(mapsDir);
+			mapLoader.setProgressInfoBox(progressBox);
+			mapLoader.downlaodTiles(mapsDir);
 		} else { // per cache
 			CacheHolder ch; 
 			CWPoint tmpca = new CWPoint();
@@ -167,17 +171,20 @@
 					}
 					if (ch.pos.isValid() &amp;&amp; ch.pos.latDec != 0 &amp;&amp; ch.pos.lonDec != 0) { // TODO != 0 sollte verschwinden, sobald das handling von nicht gesetzten Koos &#252;berall korrekt ist
 						numdownloaded++;
-						progressBox.setInfo(&quot;Downloading map from expedia.de\n&quot;+numdownloaded+&quot; / &quot;+numCaches+&quot;\n for cache:\n&quot;+ch.CacheName);
-						ml.downloadMap(ch.pos.latDec, ch.pos.lonDec, (int)scale, size.x, size.y, mapsDir);
+						progressBox.setInfo(&quot;Downloading map '&quot;+mapLoader.currentOnlineMapService.getName()+&quot;'\n&quot;+numdownloaded+&quot; / &quot;+numCaches+&quot;\n for cache:\n&quot;+ch.CacheName);
+						mapLoader.downloadMap(ch.pos, scale, size, mapsDir);
 					}
 				}
 			}
 		}
 		Vm.showWait(false);
-		ml.setProgressInfoBox(null);
-		progressBox.close(0);
+		progressBox.addWarning(&quot;Finished downloading and calibration of maps&quot;);
+		progressBox.addOkButton();
+		progressBox.waitUntilClosed();
+		mapLoader.setProgressInfoBox(null);
+		//progressBox.close(0);
 		if(Global.mainTab.mm != null) Global.mainTab.mm.mapsloaded = false; 
-		(new MessageBox(&quot;Expedia maps&quot;, &quot;Downloaded and calibrated the maps successfully&quot;, MessageBox.OKB)).execute();
+	//	(new MessageBox(&quot;Download maps&quot;, &quot;Downloaded and calibrated the maps successfully&quot;, MessageBox.OKB)).execute();
 	}
 
 
@@ -209,6 +216,7 @@
 				this.close(Form.IDCANCEL);
 			}
 			if (ev.target == okBtiles || ev.target == okBPerCache){
+				mapLoader.setCurrentMapService(mapServiceChoice.selectedIndex);
 				if (ev.target == okBtiles) { // get tiles
 					perCache = false;
 					if (forSelectedChkBox.getSelectedItem().toString().equalsIgnoreCase(&quot;all&quot;)) onlySelected = false;
@@ -238,10 +246,10 @@
 					overviewmap = overviewChkBoxPerCache.getState();
 					scale = Convert.toFloat(scaleInputPerCache.getText());
 				}
-				if (scale &lt; 1 || scale != java.lang.Math.floor(scale)) {
+		/*		if (scale &lt; 1 || scale != java.lang.Math.floor(scale)) {
 					(new MessageBox(&quot;Error&quot;, &quot;'Approx. meter pro pixel' must be greater than 0 and must not contain a point&quot;, MessageBox.OKB)).execute();
 					return;
-				}
+				} */
 				this.close(Form.IDOK); 
 				this.downloadTiles();
 			}

Modified: trunk/src/CacheWolf/navi/MovingMap.java
===================================================================
--- trunk/src/CacheWolf/navi/MovingMap.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/MovingMap.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -38,7 +38,7 @@
 	CWPoint TrackOverlaySetCenterTopLeft;
 	Vector tracks;
 	MapInfoObject currentMap = null;
-	String mapPath;
+	//String mapPath;
 	Navigate myNavigation;
 	boolean running = false;
 
@@ -88,7 +88,7 @@
 		this.setPreferredSize(pref.myAppWidth, pref.myAppHeight);
 		this.title = &quot;Moving Map&quot;;
 		this.backGround = new Color(254,254,254); // background must not be black because black is interpreted as transparent and transparent images above (eg trackoverlay) want be drawn in windows-VM, so be care, don|t use white either
-		this.mapPath = Global.getPref().getMapLoadPath();
+		//this.mapPath = Global.getPref().getMapLoadPath();
 
 		mmp = new MovingMapPanel(this);
 		this.addLast(mmp);
@@ -176,7 +176,7 @@
 	public void loadMaps(String mapsPath, double lat){
 		if (loadingMapList) return;
 		loadingMapList = true;
-		this.mapPath = mapsPath;
+		//this.mapPath = mapsPath;
 		Vm.showWait(this, true);
 		resetCenterOfMap();
 		InfoBox inf = new InfoBox(&quot;Info&quot;, &quot;Loading list of maps...&quot;);
@@ -840,7 +840,7 @@
 		if (dontUpdatePos || loadingMapList) return; // avoid multi-threading problems
 		Vm.debug(&quot;updatepos, lat: &quot;+lat+&quot; lon: &quot;+lon);
 		if (!mapsloaded) {
-			loadMaps(mapPath, lat);
+			loadMaps(Global.getPref().getMapLoadPath(), lat);
 			lastCompareX = Integer.MAX_VALUE;
 			lastCompareY = Integer.MAX_VALUE;
 			autoSelectMap = true;
@@ -1634,7 +1634,8 @@
 							fc.addMask(&quot;*.wfl&quot;);
 							fc.setTitle((String)MyLocale.getMsg(4200,&quot;Select map directory:&quot;));
 							if(fc.execute() != FileChooser.IDCANCEL){
-								mm.loadMaps(fc.getChosen().toString(), mm.posCircleLat);
+								Global.getPref().saveCustomMapsPath(fc.getChosen().toString());
+								mm.loadMaps(Global.getPref().getMapLoadPath(), mm.posCircleLat);
 								mm.forceMapLoad();
 							}
 						}

Modified: trunk/src/CacheWolf/navi/TransformCoordinates.java
===================================================================
--- trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-03 20:25:09 UTC (rev 1044)
+++ trunk/src/CacheWolf/navi/TransformCoordinates.java	2007-11-06 17:18:11 UTC (rev 1045)
@@ -29,7 +29,7 @@
 	public static final int EPSG_GK5 = 31469; 
 
 	private static final Ellipsoid BESSEL = new Ellipsoid(6377397.155, 6356078.962);
-	private static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
+	public static final Ellipsoid WGS84 = new Ellipsoid(6378137.000, 6356752.314);
 
 
 	//	 taken from <A HREF="http://www.geoclub.de/files/GK_nach_GPS.xls">http://www.geoclub.de/files/GK_nach_GPS.xls</A> &quot;Parametersatz 4 = Deutschland Nord&quot;
@@ -296,7 +296,7 @@
 }
 
 class Ellipsoid {
-	double a, b;
+	public double a, b;
 	public Ellipsoid(double ai, double bi) {
 		a = ai;
 		b = bi;


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000937.html">[Cachewolf-svn] r1044 - trunk/src/CacheWolf
</A></li>
	<LI>Next message: <A HREF="000939.html">[Cachewolf-svn] r1046 - in trunk/src/CacheWolf: . navi
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#938">[ date ]</a>
              <a href="thread.html#938">[ thread ]</a>
              <a href="subject.html#938">[ subject ]</a>
              <a href="author.html#938">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
