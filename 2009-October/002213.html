<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r2289 - in trunk: res_noewe/languages src/CacheWolf
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2009-October/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2289%20-%20in%20trunk%3A%20res_noewe/languages%20src/CacheWolf&In-Reply-To=%3C200910162130.n9GLUJms025077%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="002212.html">
   <LINK REL="Next"  HREF="002214.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r2289 - in trunk: res_noewe/languages src/CacheWolf</H1>
    <B>pfeffer at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r2289%20-%20in%20trunk%3A%20res_noewe/languages%20src/CacheWolf&In-Reply-To=%3C200910162130.n9GLUJms025077%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r2289 - in trunk: res_noewe/languages src/CacheWolf">pfeffer at mail.berlios.de
       </A><BR>
    <I>Fri Oct 16 23:30:19 CEST 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="002212.html">[Cachewolf-svn] r2288 - trunk/src/CacheWolf/imp
</A></li>
        <LI>Next message: <A HREF="002214.html">[Cachewolf-svn] r2290 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2213">[ date ]</a>
              <a href="thread.html#2213">[ thread ]</a>
              <a href="subject.html#2213">[ subject ]</a>
              <a href="author.html#2213">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: pfeffer
Date: 2009-10-16 23:30:13 +0200 (Fri, 16 Oct 2009)
New Revision: 2289

Added:
   trunk/src/CacheWolf/GeoCodeGui.java
   trunk/src/CacheWolf/GeocoderOsm.java
Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/res_noewe/languages/PL.cfg
   trunk/src/CacheWolf/CoordsScreen.java
   trunk/src/CacheWolf/HttpConnection.java
   trunk/src/CacheWolf/UrlFetcher.java
Log:
CoordsScreen: New feature: online search for place names (using the OpenStreetMap XML-interface)

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/res_noewe/languages/DE.cfg	2009-10-16 21:30:13 UTC (rev 2289)
@@ -416,6 +416,7 @@
 		1411=Bitte g%fcltige Koordinaten eingeben.
 		1412=Koordinaten ung%fcltig. Trotzdem %fcbernehmen?
 		1413=L%f6schen
+		1414=Suchen
 		1500=Ziel:
 		1501=Aktuell
 		1502=Grad
@@ -916,6 +917,15 @@
 		7121=Daten per GPSD empfangen von
 		7122=Die GPS-Daten werden per GPSD von einem anderen Server oder localhost empfangen (statt per seriellem Port)
 		7200=Aufruf: CacheWolf [-c &lt;Pfad zur Einstellungsdatei&gt;] [-debug]
+        7300=Stra%dfe/POI
+        7301=Stadt
+        7302=Suchen
+        7303=Abbr.
+        7304=berlin, deutschland
+        7305=Hauptbahnhof
+        7306=suche...
+        7307=abgebrochen durch Nutzer
+        7308=Fehler bei der online Verbindung
 		{..}
 	{..}
 {..}

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/res_noewe/languages/EN.cfg	2009-10-16 21:30:13 UTC (rev 2289)
@@ -416,6 +416,7 @@
 		1411=Please enter valid coordinates
 		1412=Coordinates invalid. Apply anyway?
 		1413=Clear
+		1414=Search
 		1500=DST:
 		1501=Current
 		1502=deg
@@ -899,6 +900,15 @@
 		7121=Receive GPS from gpsd host
 		7122=GPS data will be received from a gpsd server, not from a serial port
 		7200=Usage: CacheWolf [-c &lt;path to pref.xml&gt;] [-debug]
+        7300=Street/POI
+        7301=City
+        7302=Search
+        7303=Cancel
+        7304=new york, usa
+        7305=wallstreet
+        7306=searching...
+        7307=Canceled by user
+        7308=Could not connect
 		{..}
 	{..}
 {..}

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/res_noewe/languages/FR.cfg	2009-10-16 21:30:13 UTC (rev 2289)
@@ -412,6 +412,7 @@
 		1411=Entrez coordonn%e9es valides, svp.
 		1412=Coordonn%e9es pas valides. Prendre-les quand-m&#234;me ?
 		1413=Effacer
+		1414=Recherche
 		1500=Destination:
 		1501=Actuel
 		1502=Degr%e9
@@ -870,6 +871,14 @@
 		7021=Ce type de version
 		7022=Type de version
 		7023=Erreur en t%e9l%e9chargeant les informations de version
-		{..}
+        7300=Street / POI 
+        7301=Ville 
+        7302=Recherche 
+        7303=Annuler 
+        7304=paris
+        7305=avenue des champs-elysees 
+        7306=Recherche en cours... 
+        7307=Annul%e9 par l'utilisateur 
+        7308=Impossible de se connecter		{..}
 	{..}
 {..}

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/res_noewe/languages/NL.cfg	2009-10-16 21:30:13 UTC (rev 2289)
@@ -389,6 +389,7 @@
 		1404=Afstand
 		1405=Om co%f6rdinaten te laden van GC, geef onder in GCxxxx.
 		1406=Geef co%f6rdinaten in (alle formaten mogelijk) of GCxxxx.
+		1414=Zoeken
 		1500=Doel:
 		1501=Huidig
 		1502=Graden
@@ -657,6 +658,15 @@
 		6104=Cassiopeia
 		6105=Zwaan
 		6106=Zuiderkruis
-		{..}
+    7300=Straat / POI 
+    7301=Stad 
+    7302=Zoeken 
+    7303=Annuleren 
+    7304=Amsterdam 
+    7305=centraal station
+    7306=zoeken... 
+    7307=geannuleerd door gebruiker 
+    7308=Kan geen verbinding		
+    {..}
 	{..}
 {..}

Modified: trunk/res_noewe/languages/PL.cfg
===================================================================
--- trunk/res_noewe/languages/PL.cfg	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/res_noewe/languages/PL.cfg	2009-10-16 21:30:13 UTC (rev 2289)
@@ -414,6 +414,7 @@
                 1411=Wprowadz poprawne wspolrzedne
                 1412=Niepoprawne wspolrzedne. Uzyc tak czy tak?
                 1413=Czysto
+                1414=Szukaj
                 1500=DST:
                 1501=Aktualna
                 1502=deg
@@ -894,6 +895,15 @@
                 7121=Pobierz dane GPS z gpsd host
                 7122=Dane GPS beda pobrane z serwera gpsd, nie z portu szeregowego
                 7200=Uzytkowanie: CacheWolf [-c &lt;path to pref.xml&gt;] [-debug]
-                {..}
+                7300=Ulica/POI 
+                7301=Miasto 
+                7302=Szukaj 
+                7303=Anuluj 
+                7304=warszawa 
+                7305=stare Miasto
+                7306=Szukaj... 
+                7307=Anulowane przez uzytkownika 
+                7308=Nie mozna polaczyc
+             {..}
        {..}
 {..}

Modified: trunk/src/CacheWolf/CoordsScreen.java
===================================================================
--- trunk/src/CacheWolf/CoordsScreen.java	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/src/CacheWolf/CoordsScreen.java	2009-10-16 21:30:13 UTC (rev 2289)
@@ -23,7 +23,7 @@
 	mInput inpNSDeg, inpNSm, inpNSs, inpEWDeg, inpEWm, inpEWs;
 	mInput inpUTMZone, inpUTMNorthing, inpUTMEasting;
 	mInput inpText;
-	mButton btnCancel, btnApply, btnCopy, btnPaste, btnParse, btnGps, btnClear;
+	mButton btnCancel, btnApply, btnCopy, btnPaste, btnParse, btnGps, btnClear, btnSearch;
 	CWPoint coordInp = new CWPoint();
 	CellPanel topLinePanel = new CellPanel();
 	CellPanel mainPanel = new CellPanel();
@@ -60,8 +60,6 @@
 		chkDD.setGroup(chkFormat); chkDD.exitKeys=exitKeys;
 		chkDMM.setGroup(chkFormat);chkDMM.exitKeys=exitKeys;
 		chkDMS.setGroup(chkFormat);chkDMS.exitKeys=exitKeys;
-		//	chkUTM.setGroup(chkFormat);chkUTM.exitKeys=exitKeys;
-		//localCooSystem.setGroup(chkFormat);chkGK.exitKeys=exitKeys;
 		chkCustom.setGroup(chkFormat);chkCustom.exitKeys=exitKeys;
 		this.addLast(topLinePanel,CellConstants.DONTSTRETCH, CellConstants.WEST);
 
@@ -87,7 +85,8 @@
 		} else {
 			mainPanel.addNext(new mLabel(MyLocale.getMsg(1400,&quot;Zone&quot;)),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.SOUTHWEST));
 			mainPanel.addNext(new mLabel(MyLocale.getMsg(1402,&quot;Easting&quot;)),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.SOUTHWEST));
-			mainPanel.addLast(new mLabel(MyLocale.getMsg(1401,&quot;Northing&quot;)),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.SOUTHWEST));
+			mainPanel.addNext(new mLabel(MyLocale.getMsg(1401,&quot;Northing&quot;)),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.SOUTHWEST));
+			mainPanel.addLast(btnSearch = new mButton(MyLocale.getMsg(1414,&quot;Search&quot;)),CellConstants.HSTRETCH, (CellConstants.HFILL));
 		}
 
 		mainPanel.addNext(inpUTMZone = new mInput(),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
@@ -303,6 +302,15 @@
 				currFormat = getLocalSystem(combineToFormatSel(chkFormat.getSelectedIndex(), localCooSystem.getInt()));
 				setFields(coord,currFormat);
 			}
+			
+			if (ev.target == btnSearch) {
+				GeoCodeGui s = new GeoCodeGui(); 
+				int ok = s.execute();
+				if (ok == FormBase.IDOK) {
+					currFormat = getLocalSystem(combineToFormatSel(chkFormat.getSelectedIndex(), localCooSystem.getInt()));
+					setFields(s.coordInp,currFormat);
+				}
+			}
 		}
 		super.onEvent(ev);
 	}

Added: trunk/src/CacheWolf/GeoCodeGui.java
===================================================================
--- trunk/src/CacheWolf/GeoCodeGui.java	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/src/CacheWolf/GeoCodeGui.java	2009-10-16 21:30:13 UTC (rev 2289)
@@ -0,0 +1,149 @@
+package CacheWolf;
+
+import ewe.io.IOException;
+import ewe.sys.Handle;
+import ewe.sys.HandleStoppedException;
+import ewe.sys.mThread;
+import ewe.ui.CellConstants;
+import ewe.ui.CellPanel;
+import ewe.ui.ControlEvent;
+import ewe.ui.Event;
+import ewe.ui.Form;
+import ewe.ui.HtmlDisplay;
+import ewe.ui.IKeys;
+import ewe.ui.ScrollBarPanel;
+import ewe.ui.mButton;
+import ewe.ui.mInput;
+import ewe.ui.mLabel;
+import ewe.util.ByteArray;
+import ewe.util.Vector;
+import ewesoft.xml.sax.SAXException;
+
+/**
+ * Class for entering an address and convert it to lat/lon
+ * starting index in language files: 7300 
+ */
+
+public class GeoCodeGui extends Form {
+
+	mInput streetInp, cityInp;
+	mButton searchBtn, searchCancelBtn, btnCancel, btnOk;
+	CWPoint coordInp = new CWPoint();
+	CellPanel topLinePanel = new CellPanel();
+	CellPanel mainPanel = new CellPanel();
+	HtmlDisplay foundTxt;
+	int exitKeys[]={75009};
+
+	Vector geoCodeAnsw;
+	String searchText;
+	Handle[] fetchHandle = new Handle[1];
+
+	public GeoCodeGui()
+	{
+		topLinePanel.addNext(new mLabel(MyLocale.getMsg(7300, &quot;Street/POI&quot;)),CellConstants.DONTSTRETCH, CellConstants.WEST);
+		topLinePanel.addLast(streetInp = new mInput(MyLocale.getMsg(7305, &quot;Hauptbahnhof&quot;)),CellConstants.STRETCH, CellConstants.FILL | CellConstants.WEST);
+		//streetInp.setPreferredSize(500, 20);
+		topLinePanel.addNext(new mLabel(MyLocale.getMsg(7301, &quot;City&quot;)),CellConstants.DONTSTRETCH, CellConstants.WEST);
+		topLinePanel.addNext(cityInp   = new mInput(MyLocale.getMsg(7304, &quot;M&#252;nchen, Deutschland&quot;)),CellConstants.HSTRETCH, CellConstants.HFILL | CellConstants.WEST);
+		topLinePanel.addNext(searchBtn = new mButton(MyLocale.getMsg(7302, &quot;Search&quot;)),CellConstants.DONTSTRETCH,CellConstants.WEST);
+		topLinePanel.addLast(searchCancelBtn = new mButton(MyLocale.getMsg(7303, &quot;Cancel&quot;)),CellConstants.DONTSTRETCH,CellConstants.WEST);
+		// inpText.toolTip=MyLocale.getMsg(1406,&quot;Enter coordinates in any format or GCxxxxx&quot;);
+
+		this.addLast(topLinePanel,CellConstants.STRETCH, CellConstants.FILL | CellConstants.WEST);
+
+		// Description of found sites
+		foundTxt     = new HtmlDisplay();
+		foundTxt.setPreferredSize(200, 200);
+		ScrollBarPanel sbp = new MyScrollBarPanel(foundTxt, 0);
+		sbp.setClientConstraints(ScrollBarPanel.HCONTRACT|ScrollBarPanel.HCONTRACT);
+		mainPanel.addLast(sbp, CellConstants.STRETCH, CellConstants.FILL | CellConstants.WEST);
+
+		// Buttons for cancel and apply
+		btnCancel = new mButton(MyLocale.getMsg(614,&quot;Cancel&quot;));
+		btnCancel.setHotKey(0, IKeys.ESCAPE);
+		mainPanel.addNext(btnCancel, CellConstants.HSTRETCH, (CellConstants.HFILL));
+		//btnCancel.setTag(SPAN,new Dimension(4,1));
+		mainPanel.addNext(btnOk = new mButton(MyLocale.getMsg(615,&quot;Apply&quot;)),CellConstants.HSTRETCH, (CellConstants.HFILL));
+
+		//add Panels
+		this.addLast(mainPanel,CellConstants.STRETCH, CellConstants.FILL | CellConstants.WEST);
+	}
+
+	public void onEvent(Event ev){
+
+		//Vm.debug(ev.toString());
+		// Ensure that the Enter key moves to the appropriate field
+		// for Checkboxes and Choice controls this is done via the exitKeys
+		// For input fields we use the wantReturn field
+		if(ev instanceof ControlEvent &amp;&amp; ev.type == ControlEvent.PRESSED){
+			if (ev.target == searchBtn ){
+				foundTxt.setHtml(MyLocale.getMsg(7306, &quot;searching...&quot;));
+				// only insert &quot;,&quot; if city AND street is set
+				searchText = streetInp.text.trim();
+				if (searchText.length() &gt; 0) {
+					if (cityInp.text.trim().length() &gt; 0) searchText = searchText + &quot;,&quot;+cityInp.text;
+				} else searchText = cityInp.text;
+
+				mThread thrdfetch = 
+					new mThread() {
+					public void run() {
+						try {
+							fetchHandle[0] = null;
+							geoCodeAnsw = GeocoderOsm.geocode(searchText, fetchHandle);
+						} catch (IOException e) {
+							geoCodeAnsw = new Vector();
+							geoCodeAnsw.add(new GeocodeAnswer(new CWPoint(), &quot;IOExecption&quot;));
+						} catch (SAXException e) {
+							geoCodeAnsw = new Vector();
+							geoCodeAnsw.add(new GeocodeAnswer(new CWPoint(), &quot;SAXException&quot;));
+						} catch (HandleStoppedException ie) {
+							geoCodeAnsw = new Vector();
+							if (fetchHandle[0].stopReason == 4321)
+								geoCodeAnsw.add(new GeocodeAnswer(new CWPoint(), MyLocale.getMsg(7307, &quot;Canceled by user&quot;)));
+							else geoCodeAnsw.add(new GeocodeAnswer(new CWPoint(), MyLocale.getMsg(7308, &quot;Could not connect&quot;)));
+						} catch (InterruptedException ie) {
+							geoCodeAnsw = new Vector();
+							if (fetchHandle[0].stopReason == 4321)
+								geoCodeAnsw.add(new GeocodeAnswer(new CWPoint(), MyLocale.getMsg(7307, &quot;Canceled by user&quot;)));
+							else geoCodeAnsw.add(new GeocodeAnswer(new CWPoint(), MyLocale.getMsg(7308, &quot;Could not connect&quot;)));
+
+						}
+						// foundTxt.startHtml();
+						if (geoCodeAnsw.size() == 0) foundTxt.setHtml(&quot;nothing found&quot;);
+						else {
+							GeocodeAnswer ga = (GeocodeAnswer)geoCodeAnsw.get(0);
+							foundTxt.setHtml(ga.where.toString() + &quot;&lt;br&gt;&quot; + ga.foundname);
+						}
+						fetchHandle[0] = null;
+					}
+				};
+				thrdfetch.start();
+			}
+
+			if (ev.target == searchCancelBtn){
+				if (fetchHandle != null &amp;&amp; fetchHandle[0] != null)
+				{
+					fetchHandle[0].stop(4321);
+					fetchHandle[0].set(Handle.Stopped);
+				}
+			}
+
+			if (ev.target == btnCancel){
+				this.close(IDCANCEL);
+			}
+
+			if (ev.target == btnOk){
+				if (geoCodeAnsw != null &amp;&amp; geoCodeAnsw.size() &gt; 0)
+				coordInp = ((GeocodeAnswer)geoCodeAnsw.get(0)).where;
+				else coordInp.makeInvalid();
+				this.close(IDOK);
+			}
+
+		}
+		super.onEvent(ev);
+	}
+
+}
+
+
+

Added: trunk/src/CacheWolf/GeocoderOsm.java
===================================================================
--- trunk/src/CacheWolf/GeocoderOsm.java	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/src/CacheWolf/GeocoderOsm.java	2009-10-16 21:30:13 UTC (rev 2289)
@@ -0,0 +1,59 @@
+package CacheWolf;
+
+import ewe.io.ByteArrayInputStream;
+import ewe.io.IO;
+import ewe.io.IOException;
+import ewe.io.InputStreamReader;
+import ewe.sys.Handle;
+import ewe.sys.HandleStoppedException;
+import ewe.util.ByteArray;
+import ewe.util.Vector;
+import ewesoft.xml.XMLDecoder;
+import ewesoft.xml.XMLElement;
+import ewesoft.xml.sax.SAXException;
+
+public class GeocoderOsm {
+
+	private static final String geocoderUrl = &quot;<A HREF="http://gazetteer.openstreetmap.org/namefinder/search.xml?max=1&amp;find=">http://gazetteer.openstreetmap.org/namefinder/search.xml?max=1&amp;find=</A>&quot;;  
+
+	public static Vector geocode(String address, Handle[] h) 
+	throws SAXException, IOException, HandleStoppedException, InterruptedException {
+		ByteArray answ = UrlFetcher.fetchByteArray((geocoderUrl+UrlFetcher.toUtf8Url(address)), null, h);
+		XMLDecoder xmldec = new XMLDecoder();
+		xmldec.parse(new InputStreamReader(new ByteArrayInputStream(answ), IO.JAVA_UTF8_CODEC));
+		Vector erg = new Vector();
+		if ( &quot;searchresults&quot;.equalsIgnoreCase((String)xmldec.document.tag) ) {
+			XMLElement xe, xe2;
+			String desc, lat, lon;
+			desc = null;
+			CWPoint where = new CWPoint();
+			if (xmldec.document != null &amp;&amp; xmldec.document.subElements != null) {
+				for (int i=0;  i &lt; xmldec.document.subElements.size(); i++) {
+					xe = (XMLElement) xmldec.document.subElements.elementAt(i);
+					if (xe.tag.equalsIgnoreCase(&quot;named&quot;)) {
+						lat = (String) xe.attributes.getPropertyValues(&quot;lat&quot;).get(0);
+						lon = (String) xe.attributes.getPropertyValues(&quot;lon&quot;).get(0);
+						where.set(Common.parseDouble(lat), Common.parseDouble(lon));
+						for (int j = 0; j &lt; xe.subElements.size(); j++) {
+							xe2 = (XMLElement) xe.subElements.elementAt(j);
+							if ( xe2.tag.equalsIgnoreCase(&quot;description&quot;)) { desc = xe2.text; break; }  
+						}
+						erg.add(new GeocodeAnswer(where, desc));
+					}
+				}
+			}
+		}
+		return erg;
+	}
+
+}
+
+class GeocodeAnswer {
+	String foundname;
+	CWPoint where;
+	public GeocodeAnswer(CWPoint where_, String desc_) {
+		where = new CWPoint(where_);
+		foundname = desc_;
+	}
+}
+

Modified: trunk/src/CacheWolf/HttpConnection.java
===================================================================
--- trunk/src/CacheWolf/HttpConnection.java	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/src/CacheWolf/HttpConnection.java	2009-10-16 21:30:13 UTC (rev 2289)
@@ -618,12 +618,12 @@
 	
 	FIXME: never referenced
  */
-////===================================================================
-//public Handle readInData() 
-////===================================================================
-//{
-//	return readInData(connectedSocket);
-//}
+//===================================================================
+public Handle readInData() 
+//===================================================================
+{
+	return readInData(connectedSocket);
+}
 /**
 * Get an InputStream to read in the data. This is a very important method as it is used by
 * the readInData() method.
@@ -733,7 +733,7 @@
  * Success, then the returnValue of the IOHandle will hold the connected socket.
  */
 //===================================================================
-private Handle connectAsync()
+public Handle connectAsync()
 //===================================================================
 {
 	return connectAsync(new AsciiCodec());

Modified: trunk/src/CacheWolf/UrlFetcher.java
===================================================================
--- trunk/src/CacheWolf/UrlFetcher.java	2009-10-16 21:02:28 UTC (rev 2288)
+++ trunk/src/CacheWolf/UrlFetcher.java	2009-10-16 21:30:13 UTC (rev 2289)
@@ -1,10 +1,13 @@
 package CacheWolf;
 
+import ewe.io.AsciiCodec;
 import ewe.io.ByteArrayInputStream;
 import ewe.io.IOException;
 import ewe.io.JavaUtf8Codec;
 import ewe.net.Socket;
 import ewe.net.URL;
+import ewe.sys.Handle;
+import ewe.sys.HandleStoppedException;
 import ewe.util.ByteArray;
 import ewe.util.CharArray;
 import ewe.util.Properties;
@@ -25,15 +28,28 @@
 		props.load(new ByteArrayInputStream(doc));
 		return props; 
 	}
-	
-	
+
+	public static ByteArray fetchByteArray(String url, CharArray realurl) throws IOException {
+		Handle[] hndl = new Handle[1];
+		try {
+		return fetchByteArray(url, realurl, hndl);
+		} catch ( InterruptedException e) {
+			throw new IOException(&quot;Error reading data.&quot;);
+		} catch ( HandleStoppedException e) {
+			throw new IOException(&quot;Error reading data.&quot;);
+		}
+	}
+
 	/**
 	 * @param url - if url-not-allowed chars are contained, they will be automatically encoded
 	 * @param if non null, realurl will be filled with the real url, which can differ from the given url, in case url returns a http-redirect
 	 * @return
 	 * @throws IOException
+	 * @throws InterruptedException 
+	 * @throws HandleStoppedException 
 	 */
-	public static ByteArray fetchByteArray(String url, CharArray realurl) throws IOException {	
+	public static ByteArray fetchByteArray(String url, CharArray realurl, Handle[] hndl) 
+	throws IOException, HandleStoppedException, InterruptedException {	
 		final int maxRedirections = 5;
 		HttpConnection conn = null;
 		Socket sock = null;
@@ -46,7 +62,9 @@
 			conn.setRequestorProperty(&quot;USER_AGENT&quot;, &quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.7.5) Gecko/20041107 Firefox/1.0&quot;);
 			conn.setRequestorProperty(&quot;Connection&quot;, &quot;close&quot;);
 			conn.documentIsEncoded = isUrlEncoded(urltmp);
-			sock = conn.connect();
+			hndl[0] = conn.connectAsync();
+			hndl[0].waitOn(Handle.Success);
+			sock = (Socket)hndl[0].returnValue; //&quot;Could not connect.&quot;);
 			if (conn.responseCode &gt;= 400) throw new IOException(&quot;URL: &quot;+ urltmp + &quot;\nhttp response code: &quot; + conn.responseCode);
 			urltmp = conn.getRedirectTo();
 			if(urltmp!=null){
@@ -58,11 +76,18 @@
 			}
 		} while (urltmp != null &amp;&amp; i &lt;= maxRedirections ); 
 		if (i &gt; maxRedirections) throw new IOException(&quot;too many http redirections while trying to fetch: &quot;+url + &quot; only &quot;+maxRedirections+&quot; are allowed&quot;);
-		ByteArray daten = conn.readData(sock);
-		sock.close();
+		hndl[0] = conn.readInData();
+		ByteArray daten;
+		try{
+			hndl[0].waitOn(Handle.Success);
+		}finally {
+			sock.close();
+		}
+		daten = (ByteArray)hndl[0].returnValue;
+		// ByteArray daten = conn.readData(sock);
 		return daten;
 	}
-	
+
 	/**
 	 * @param url
 	 * @return true, if the string seems to be already URL encoded (that is, it contains only url-allowd chars), false otherwise
@@ -82,4 +107,61 @@
 		}
 		return true;
 	}
+	/**
+	 * This method encodes an URL containing special characters
+	 * using the UTF-8 codec in %nn%nn notation&lt;br&gt;
+	 * Note that the encoding for URLs is not generally defined. Usually
+	 * cp1252 or UTF-8 is used. It depends on what the server expects,
+	 * what encoding you must use.
+	 * @param cc
+	 * @return
+	 * @throws IOException
+	 */
+	public final static String toUtf8Url(String cc) throws IOException {
+		JavaUtf8Codec coder = new JavaUtf8Codec();
+		ByteArray utf8 = new ByteArray();
+		coder.encodeText(cc.toCharArray(), 0, cc.length(), true, utf8);
+		AsciiCodec asciicod = new AsciiCodec();
+		CharArray utf8bytes = new CharArray();
+		asciicod.decodeText(utf8.data, 0, utf8.length, true, utf8bytes);
+		return encodeURL(utf8bytes.toString(), false);
+	}
+	
+	final static String hex = ewe.util.TextEncoder.hex;
+	/**
+	 * Encode the URL using %## notation.
+	 * Note: this fixes a bug in ewe.net.URL.encodeURL(): that routine
+	 * assumes all chars to be &lt; 127.
+	 * This method is mainly copied from there
+	 * @param url The unencoded URL.
+	 * @param spaceToPlus true if you wish a space to be encoded as a '+', false to encode it as %20
+	 * @return The encoded URL.
+	 */
+	//===================================================================
+	public static String encodeURL(String url, boolean spaceToPlus)
+	//===================================================================
+	{
+		char [] what = ewe.sys.Vm.getStringChars(url);
+		int max = what.length;
+		char [] dest = new char[max+max/2];
+		char d = 0;
+		for (int i = 0; i&lt;max; i++){
+			if (d &gt;= dest.length-2) {
+				char [] n = new char[dest.length+dest.length/2+3];
+				ewe.sys.Vm.copyArray(dest,0,n,0,d);
+				dest = n;
+			}
+			char c = what[i];
+			if (spaceToPlus &amp;&amp; c == ' ') c = '+';
+			else if (c &lt;= ' ' || c &gt;= 127 || c == '+' || c == '&amp;' || c == '%' || c == '=' || c == '|' || c == '{' || c == '}'){
+				dest[d++] = '%';
+				dest[d++] = hex.charAt((c &gt;&gt; 4) &amp; 0xf);
+				dest[d++] = hex.charAt(c &amp; 0xf);
+				continue;
+			}
+			dest[d++] = c;
+		}
+		return new String(dest,0,d);
+	}
+
 }
\ No newline at end of file


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="002212.html">[Cachewolf-svn] r2288 - trunk/src/CacheWolf/imp
</A></li>
	<LI>Next message: <A HREF="002214.html">[Cachewolf-svn] r2290 - trunk/src/CacheWolf
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#2213">[ date ]</a>
              <a href="thread.html#2213">[ thread ]</a>
              <a href="subject.html#2213">[ subject ]</a>
              <a href="author.html#2213">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
