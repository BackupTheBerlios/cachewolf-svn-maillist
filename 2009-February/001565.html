<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [Cachewolf-svn] r1655 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/navi src/exp
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/cachewolf-svn/2009-February/index.html" >
   <LINK REL="made" HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r1655%20-%20in%20trunk%3A%20res_noewe/languages%20src/CacheWolf%0A%09src/CacheWolf/navi%20src/exp&In-Reply-To=%3C200902261911.n1QJBkP8026425%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="001564.html">
   <LINK REL="Next"  HREF="001566.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[Cachewolf-svn] r1655 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/navi src/exp</H1>
    <B>engywuck at mail.berlios.de</B> 
    <A HREF="mailto:cachewolf-svn%40lists.berlios.de?Subject=Re%3A%20%5BCachewolf-svn%5D%20r1655%20-%20in%20trunk%3A%20res_noewe/languages%20src/CacheWolf%0A%09src/CacheWolf/navi%20src/exp&In-Reply-To=%3C200902261911.n1QJBkP8026425%40sheep.berlios.de%3E"
       TITLE="[Cachewolf-svn] r1655 - in trunk: res_noewe/languages src/CacheWolf	src/CacheWolf/navi src/exp">engywuck at mail.berlios.de
       </A><BR>
    <I>Thu Feb 26 20:11:46 CET 2009</I>
    <P><UL>
        <LI>Previous message: <A HREF="001564.html">[Cachewolf-svn] r1654 - trunk/src/CacheWolf
</A></li>
        <LI>Next message: <A HREF="001566.html">[Cachewolf-svn] r1656 - trunk/res_noewe/languages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1565">[ date ]</a>
              <a href="thread.html#1565">[ thread ]</a>
              <a href="subject.html#1565">[ subject ]</a>
              <a href="author.html#1565">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: engywuck
Date: 2009-02-26 20:11:37 +0100 (Thu, 26 Feb 2009)
New Revision: 1655

Added:
   trunk/src/CacheWolf/navi/Metrics.java
Modified:
   trunk/res_noewe/languages/DE.cfg
   trunk/res_noewe/languages/EN.cfg
   trunk/res_noewe/languages/FR.cfg
   trunk/res_noewe/languages/NL.cfg
   trunk/src/CacheWolf/CacheHolder.java
   trunk/src/CacheWolf/CalcPanel.java
   trunk/src/CacheWolf/Filter.java
   trunk/src/CacheWolf/FilterScreen.java
   trunk/src/CacheWolf/MyComparer.java
   trunk/src/CacheWolf/OCXMLImporterScreen.java
   trunk/src/CacheWolf/Parser.java
   trunk/src/CacheWolf/Preferences.java
   trunk/src/CacheWolf/PreferencesScreen.java
   trunk/src/CacheWolf/ShowCacheInBrowser.java
   trunk/src/CacheWolf/myTableModel.java
   trunk/src/CacheWolf/navi/GotoPanel.java
   trunk/src/exp/HTMLExporter.java
   trunk/src/exp/TPLExporter.java
Log:
Support for imperial units. (<A HREF="http://www.geoclub.de/viewtopic.php?f=40&amp;t=31674">http://www.geoclub.de/viewtopic.php?f=40&amp;t=31674</A>)
Moving map is still missing, because I have no idea what is going on there...

Modified: trunk/res_noewe/languages/DE.cfg
===================================================================
--- trunk/res_noewe/languages/DE.cfg	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/res_noewe/languages/DE.cfg	2009-02-26 19:11:37 UTC (rev 1655)
@@ -148,6 +148,9 @@
 		351=Notizen hinzuf%fcgen/%e4ndern
 		400=Dekodieren
 		500=Umschalten
+		588=L%e4ngeneinheiten
+		589=Metrisch (km)
+		590=Imperial (Meilen)
 		591=Leer f%fcr Sprache des Betriebssystems%0aoder 2 Zeichen f%fcr andere Sprache , z.B. DE, EN
 		592=Sprache (braucht Neustart)
 		593=Password ist hier optional.%0aNur eingeben wenn es in pref.xml%0agespeichert werden soll.

Modified: trunk/res_noewe/languages/EN.cfg
===================================================================
--- trunk/res_noewe/languages/EN.cfg	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/res_noewe/languages/EN.cfg	2009-02-26 19:11:37 UTC (rev 1655)
@@ -149,6 +149,9 @@
 		351=Add/Edit notes
 		400=Dekode
 		500=Switch
+		588=Unit System
+		589=Metric (km)
+		590=Imperial (mi.)
 		591=Leave empty for default language or%0aadd 2 character language, e.g. DE, EN
 		592=Language (needs restart)
 		593=Password is optional here.%0aEnter only if you want to store it in pref.xml

Modified: trunk/res_noewe/languages/FR.cfg
===================================================================
--- trunk/res_noewe/languages/FR.cfg	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/res_noewe/languages/FR.cfg	2009-02-26 19:11:37 UTC (rev 1655)
@@ -148,6 +148,9 @@
 		351=Ajouter/changer notes
 		400=D%e9coder
 		500=Changer
+		588=Syst%e8me de mesure
+		589=M%e9trique (km)
+		590=Imp%e9rial (milles)
 		591=Vide pour langue de syst%e8me d'exploitation%0aou deux aract%e8res pour autre langure, p.ex. DE, EN
 		592=Langue (faut redemarrer)
 		593=Le mot de passe est optionel ici.%0aL'entrer seulement s'il doit enregistrer en fichier pref.xml

Modified: trunk/res_noewe/languages/NL.cfg
===================================================================
--- trunk/res_noewe/languages/NL.cfg	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/res_noewe/languages/NL.cfg	2009-02-26 19:11:37 UTC (rev 1655)
@@ -140,6 +140,9 @@
 		351=Toevoegen/wijzigingen notities.
 		400=Decoderen
 		500=Omdraaien
+		588=
+		589=
+		590=
 		591=Laat leeg voor standaard taal of%0avoeg 2 karakters toe voor taal, bv. DE,EN,NL
 		592=Taal(herstart noodzakelijk)
 		593=Password is optioneel.%0aAlleen gebruiken als je het wil opslaan in pref.xml.

Modified: trunk/src/CacheWolf/CacheHolder.java
===================================================================
--- trunk/src/CacheWolf/CacheHolder.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/CacheHolder.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -1,9 +1,12 @@
 package CacheWolf;
 
+import CacheWolf.navi.Metrics;
+
 import com.stevesoft.ewe_pat.Regex;
 
 import ewe.io.IOException;
 import ewe.sys.Convert;
+import ewe.sys.Vm;
 import ewe.ui.FormBase;
 import ewe.ui.MessageBox;
 import ewe.util.Vector;
@@ -14,8 +17,11 @@
  *	classes and methods to get more information.
  *	
  */
+/**
+ * @author torsti
+ *
+ */
 public class CacheHolder {
-	protected static final String NODISTANCE = &quot;? km&quot;;
 	protected static final String NOBEARING = &quot;?&quot;;
 	protected static final String EMPTY = &quot;&quot;;
 
@@ -36,9 +42,10 @@
 	/** The size of the cache (as per GC cache sizes Micro, Small, ....) */
 	public String CacheSize = &quot;None&quot;;
 	/** The distance from the centre in km */
-	public double kilom = 0;
-	/** The formatted distance such as &quot;x.xx km&quot; */
-	public String distance = NODISTANCE;
+	public double kilom = -1; int bla = 0;
+	public double lastKilom = -2; // Cache last value
+	public int lastMetric = -1; // Cache last metric
+	public String lastDistance = &quot;&quot;; // Cache last distance
 	/** The bearing N, NNE, NE, ENE ... from the current centre to this point */
 	public String bearing = NOBEARING;
 	/** The angle (0=North, 180=South) from the current centre to this point */
@@ -229,6 +236,45 @@
 		}
 	}
 
+	/**
+	 * Returns the distance in formatted output. Using kilometers when metric system is active,
+	 * using miles when imperial system is active.
+	 * 
+	 * @return The current distance.
+	 */
+	public String getDistance() {
+		String result = null;
+		String newUnit = null;
+
+		if (this.kilom == this.lastKilom &amp;&amp; Global.getPref().metricSystem == this.lastMetric) {
+			result = this.lastDistance;
+		} else {
+			if (this.kilom &gt;= 0) {
+				double newValue = 0;
+				switch (Global.getPref().metricSystem) {
+				case Metrics.METRIC:
+					newValue = this.kilom;
+					newUnit = Metrics.getUnit(Metrics.KILOMETER);
+					break;
+				case Metrics.IMPERIAL:
+					newValue = Metrics.convertUnit(this.kilom, Metrics.KILOMETER, Metrics.MILES);
+					newUnit = Metrics.getUnit(Metrics.MILES);
+					break;
+				}
+				result = MyLocale.formatDouble(newValue, &quot;0.00&quot;) + &quot; &quot; + newUnit;
+			} else {
+				result = &quot;? &quot;
+				        + (Global.getPref().metricSystem == Metrics.METRIC ? Metrics
+				                .getUnit(Metrics.KILOMETER) : Metrics.getUnit(Metrics.MILES));
+			}
+			// Caching values, so reevaluation is only done when really needed
+			this.lastKilom = this.kilom;
+			this.lastMetric = Global.getPref().metricSystem;
+			this.lastDistance = result;
+		}
+		return result;
+	}
+	
 	public void update(CacheHolder ch) {
 		update(ch, false);
 	}
@@ -267,7 +313,6 @@
 		this.DateHidden = ch.DateHidden;
 		this.CacheSize = ch.CacheSize;
 		this.kilom = ch.kilom;
-		this.distance = ch.distance;
 		this.bearing = ch.bearing;
 		this.degrees = ch.degrees;
 		this.hard = ch.hard;
@@ -389,9 +434,8 @@
 			kilom = pos.getDistance(toPoint);
 			degrees = toPoint.getBearing(pos);
 			bearing = CWPoint.getDirection(degrees);
-			distance = MyLocale.formatDouble(kilom,&quot;0.00&quot;)+&quot; km&quot;;
 		} else {
-			distance = NODISTANCE;
+			kilom = -1;
 			bearing = NOBEARING;
 		}
 	}

Modified: trunk/src/CacheWolf/CalcPanel.java
===================================================================
--- trunk/src/CacheWolf/CalcPanel.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/CalcPanel.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import CacheWolf.navi.Metrics;
 import ewe.ui.*;
 import ewe.ui.formatted.TextDisplay;
 import ewe.util.Vector;
@@ -90,7 +91,11 @@
 			inpDistance.setPreferredSize(fm.getTextWidth(&quot;99999999&quot;),fm.getHeight()*4/3);
 		}
 		BottomP.addLast(chcDistUnit = new mChoice(new String[]{&quot;m&quot;, &quot;km&quot;, MyLocale.getMsg(1407,&quot;steps&quot;), MyLocale.getMsg(1408,&quot;feet&quot;), MyLocale.getMsg(1409,&quot;yards&quot;), MyLocale.getMsg(1410,&quot;miles&quot;)},0),CellConstants.DONTSTRETCH, (CellConstants.HFILL|CellConstants.WEST)).setTag(CellConstants.INSETS,new ewe.fx.Insets(0,2,0,0));
-		chcDistUnit.setInt(0);
+		if (Global.getPref().metricSystem == Metrics.METRIC) {
+			chcDistUnit.setInt(0); // Meter
+		} else {
+			chcDistUnit.setInt(3); // Feet
+		}
 		
 		// Buttons for calc and save
 		BottomP.addNext(btnCalc = new mButton(&quot;Calc&quot;),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));

Modified: trunk/src/CacheWolf/Filter.java
===================================================================
--- trunk/src/CacheWolf/Filter.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/Filter.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -413,7 +413,7 @@
 			// Filter criterium 3: Distance
 			///////////////////////////////
 			if(fscDist&gt;0.0){
-				dummyd1 = Common.parseDouble(ch.distance.substring(0,ch.distance.length()-3)); 
+				dummyd1 = ch.kilom; 
 				if(distdirec == SMALLER &amp;&amp; dummyd1 &gt; fscDist)  { ch.is_filtered=true; continue; }
 				if(distdirec == GREATER &amp;&amp; dummyd1 &lt; fscDist)  { ch.is_filtered=true; continue; }
 			}

Modified: trunk/src/CacheWolf/FilterScreen.java
===================================================================
--- trunk/src/CacheWolf/FilterScreen.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/FilterScreen.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -1,4 +1,5 @@
 package CacheWolf;
+import CacheWolf.navi.Metrics;
 import ewe.ui.*;
 import ewe.io.*;
 import ewe.fx.*;
@@ -322,7 +323,13 @@
 				chcDist.select(0);
 			else
 				chcDist.select(1);
-			inpDist.setText(prof.filterDist.substring(1));
+			String dist = prof.filterDist.substring(1);
+			if (Global.getPref().metricSystem == Metrics.IMPERIAL) {
+				double distValue = java.lang.Double.valueOf(dist);
+				double newDistValue = Metrics.convertUnit(distValue, Metrics.KILOMETER, Metrics.MILES);
+				dist = String.valueOf(newDistValue);
+			}
+			inpDist.setText(dist);
 		} else {
 			chcDist.select(0);
 			inpDist.setText(&quot;&quot;);
@@ -626,10 +633,22 @@
 							(chkVeryLarge.state ? &quot;1&quot; : &quot;0&quot;)+
 							(chkOther.state ? &quot;1&quot; : &quot;0&quot;);
 				
+				// Distance: If Metric system is set to imperial units,
+				//           then the entered value is meant to be miles,
+				//           otherwise it's kilometer.
+				double distValue = java.lang.Double.NaN;
+				String rawDistance = inpDist.getText().replace(',', '.');
+				String newDistance = rawDistance; // initial Value;
+				if (! rawDistance.trim().equals(&quot;&quot;)) {
+					distValue = java.lang.Double.valueOf(rawDistance);
+					if (Global.getPref().metricSystem == Metrics.IMPERIAL){
+						newDistance = String.valueOf(Metrics.convertUnit(distValue, Metrics.MILES, Metrics.KILOMETER));
+					}
+				}
 				if(chcDist.selectedIndex == 0) { 
-					pfl.filterDist=&quot;L&quot;+inpDist.getText();
+					pfl.filterDist=&quot;L&quot;+newDistance;
 				} else { 
-					pfl.filterDist=&quot;G&quot;+inpDist.getText();
+					pfl.filterDist=&quot;G&quot;+newDistance;
 				}
 					
 				if(chcDiff.selectedIndex == 0) { 

Modified: trunk/src/CacheWolf/MyComparer.java
===================================================================
--- trunk/src/CacheWolf/MyComparer.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/MyComparer.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -65,12 +65,8 @@
 		} else if (colToCompare==10) {
 			for (int i=0; i&lt;visibleSize; i++) {
 				CacheHolder ch=(CacheHolder) cacheDB.get(i);
-				int p=ch.distance.indexOf(&quot;,&quot;);
-				if (p&lt;0) p=ch.distance.indexOf(&quot;.&quot;);
-				if (p&gt;=0 &amp;&amp; p&lt;=5)
-					ch.sort=&quot;00000&quot;.substring(0,5-p)+ch.distance;
-				else
-					ch.sort=ch.distance;
+				// CHECK Is the formatting correctly done?
+				ch.sort = MyLocale.formatDouble(ch.kilom*1000, &quot;000000000000&quot;);
 			}
 		} else if (colToCompare==11) {
 			for (int i=0; i&lt;visibleSize; i++) {

Modified: trunk/src/CacheWolf/OCXMLImporterScreen.java
===================================================================
--- trunk/src/CacheWolf/OCXMLImporterScreen.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/OCXMLImporterScreen.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -47,7 +47,7 @@
 			}
 			distanceInput.setText(dist1);
 			this.addNext(distanceInput,CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
-			this.addLast(distUnit = new mLabel(&quot; km&quot;),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
+			this.addLast(distUnit = new mLabel(&quot; km/mi.&quot;),CellConstants.DONTSTRETCH, (CellConstants.DONTFILL|CellConstants.WEST));
 		}
 
 		if ((options &amp; IMAGES) &gt; 0) {

Modified: trunk/src/CacheWolf/Parser.java
===================================================================
--- trunk/src/CacheWolf/Parser.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/Parser.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -45,6 +45,7 @@
 package CacheWolf;
 
 import ewe.util.*;
+import CacheWolf.navi.Metrics;
 import CacheWolf.navi.Navigate;
 
 import com.stevesoft.ewe_pat.*;
@@ -478,11 +479,18 @@
     private double funcDistance() throws Exception {
     	String coordB=popCalcStackAsString();
     	String coordA=popCalcStackAsString();
+    	double result = 0;
 		// Attention: isValidCoord has sideeffect of setting cwPt
     	if (!isValidCoord(coordA)) err(MyLocale.getMsg(1712,&quot;Invalid coordinate: &quot;)+coordA);
 		if (!isValidCoord(coordB)) err(MyLocale.getMsg(1712,&quot;Invalid coordinate: &quot;)+coordB);
     	cwPt.set(coordA);
-    	return cwPt.getDistance(new CWPoint(coordB))*1000.0;
+    	double distKM = cwPt.getDistance(new CWPoint(coordB));
+    	result = distKM*1000.0;
+    	if (Global.getPref().metricSystem == Metrics.IMPERIAL) {
+    		result = Metrics.convertUnit(distKM, Metrics.KILOMETER, Metrics.MILES);
+    		result = Metrics.convertUnit(result, Metrics.MILES, Metrics.YARDS);
+    	}
+    	return result;
     }
 
     /**
@@ -620,7 +628,13 @@
     	String coord=popCalcStackAsString();
 		if (!isValidCoord(coord)) err(MyLocale.getMsg(1712,&quot;Invalid coordinate: &quot;)+coord);
     	cwPt.set(coord);
-    	return cwPt.project(degrees,distance/1000.0).toString();
+    	if (Global.getPref().metricSystem == Metrics.IMPERIAL) {
+    		distance = Metrics.convertUnit(distance, Metrics.YARDS, Metrics.MILES);
+    		distance = Metrics.convertUnit(distance, Metrics.MILES, Metrics.KILOMETER);
+    	} else {
+    		distance = distance / 1000.0;
+    	}
+    	return cwPt.project(degrees,distance).toString();
     }
 
     /** Convert Radiants into degrees */

Modified: trunk/src/CacheWolf/Preferences.java
===================================================================
--- trunk/src/CacheWolf/Preferences.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/Preferences.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -1,4 +1,5 @@
 package CacheWolf;
+import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.io.*;
 import ewe.sys.*;
@@ -193,6 +194,8 @@
 	public int deleteDetails=5;
 	/** The locale code (DE, EN, ...) */
 	public String language=&quot;&quot;;
+	/** The metric system to use */
+	public int metricSystem = Metrics.METRIC;
 
 	//////////////////////////////////////////////
 	/** The debug switch (Can be used to activate dormant code) by adding
@@ -365,6 +368,13 @@
 			if (maxDetails&lt;2) maxDetails=2;
 			if (deleteDetails&lt;1) deleteDetails=1;
 		}
+		else if (name.equals(&quot;metric&quot;)) {
+			metricSystem=Common.parseInt(atts.getValue(&quot;type&quot;));
+			if (metricSystem != Metrics.METRIC &amp;&amp;
+					metricSystem != Metrics.IMPERIAL) {
+				metricSystem = Metrics.METRIC;
+			}
+		}
 		else if (name.equals(&quot;locale&quot;)) {
 			language = atts.getValue(&quot;language&quot;);
 		}
@@ -425,6 +435,7 @@
 			outp.print(&quot;    &lt;spider forcelogin=\&quot;&quot; + SafeXML.strxmlencode(forceLogin) + &quot;\&quot;/&gt;\n&quot;);
 			outp.print(&quot;    &lt;gotopanel northcentered=\&quot;&quot; + SafeXML.strxmlencode(northCenteredGoto) + &quot;\&quot; /&gt;\n&quot;);
 			outp.print(&quot;    &lt;details cacheSize=\&quot;&quot; + SafeXML.strxmlencode(maxDetails) + &quot;\&quot; delete=\&quot;&quot; + SafeXML.strxmlencode(deleteDetails) + &quot;\&quot;/&gt;\n&quot;);
+			outp.print(&quot;    &lt;metric type=\&quot;&quot; + SafeXML.strxmlencode(metricSystem) + &quot;\&quot;/&gt;\n&quot;);
 			if (customMapsPath!=null) outp.print(&quot;	&lt;mapspath dir = \&quot;&quot; + SafeXML.strxmlencode(customMapsPath.replace('\\','/')) + &quot;\&quot;/&gt;\n&quot;);
 			if (debug) outp.print(&quot;    &lt;debug value=\&quot;true\&quot; /&gt;\n&quot;); // Keep the debug switch if it is set
 			// save last path of different exporters

Modified: trunk/src/CacheWolf/PreferencesScreen.java
===================================================================
--- trunk/src/CacheWolf/PreferencesScreen.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/PreferencesScreen.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -1,5 +1,6 @@
 package CacheWolf;
 
+import CacheWolf.navi.Metrics;
 import utils.FileBugfix;
 import ewe.ui.*;
 import ewe.io.*;
@@ -15,7 +16,7 @@
 */
 public class PreferencesScreen extends Form {
 	mButton cancelB, applyB, brwBt, gpsB,btnCentre;
-	mChoice NS, EW, inpLanguage;
+	mChoice NS, EW, inpLanguage, inpMetric;
 	mInput NSDeg, NSm, EWDeg, EWm, DataDir, Proxy, ProxyPort, Alias, nLogs, Browser, fontSize, inpGPS, 
 	       inpLogsPerPage,inpMaxLogsToSpider,inpPassword;
 	mCheckBox dif, ter, loc, own, hid, stat, dist, bear, chkAutoLoad, chkShowDeletedImg, chkMenuAtTop, 
@@ -208,7 +209,11 @@
 		pnlMore.addLast(inpLanguage=new mChoice(langs, curlang),DONTSTRETCH,DONTFILL|WEST);
 		//inpLanguage.setPreferredSize(20,-1);
 		inpLanguage.setToolTip(MyLocale.getMsg(591,&quot;Select \&quot;auto\&quot; for system language or select your preferred language, e.g. DE or EN&quot;));
-		
+		String [] metriken = {MyLocale.getMsg(589, &quot;Metric (km)&quot;), 
+				              MyLocale.getMsg(590, &quot;Imperial (mi)&quot;)};
+		pnlMore.addNext(new mLabel(MyLocale.getMsg(588, &quot;Length units&quot;)),DONTSTRETCH,DONTFILL|WEST);
+		int currMetrik = pref.metricSystem == Metrics.METRIC ? 0 : 1;
+		pnlMore.addLast(inpMetric=new mChoice(metriken, currMetrik),DONTSTRETCH,DONTFILL|WEST);
 		/////////////////////////////////////////////////////////
 		// Fourth/Fifth panel - Listview and Travelbugs
 		/////////////////////////////////////////////////////////
@@ -302,6 +307,7 @@
 				pref.listColMap=tccList.getSelectedCols();
 				pref.descShowImg=chkDescShowImg.getState();
 				Global.mainTab.tbP.myMod.setColumnNamesAndWidths();
+				pref.metricSystem = inpMetric.getInt() == 0 ? Metrics.METRIC : Metrics.IMPERIAL;
 				pref.savePreferences();
 				pref.dirty = true; // Need to update table in case columns were enabled/disabled
 				this.close(0);

Modified: trunk/src/CacheWolf/ShowCacheInBrowser.java
===================================================================
--- trunk/src/CacheWolf/ShowCacheInBrowser.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/ShowCacheInBrowser.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -78,7 +78,7 @@
 					tpl.setParam(&quot;DIFFICULTY&quot;, (String) diff.get(chD.hard.replace(',','.')));
 					if (chD.terrain.endsWith(&quot;.0&quot;)) chD.terrain=chD.terrain.substring(0,chD.terrain.length()-2);
 					tpl.setParam(&quot;TERRAIN&quot;, (String) terr.get(chD.terrain.replace(',','.')));
-					tpl.setParam(&quot;DISTANCE&quot;, chD.distance.replace(',','.'));
+					tpl.setParam(&quot;DISTANCE&quot;, chD.getDistance().replace(',','.'));
 					tpl.setParam(&quot;BEARING&quot;, chD.bearing);
 					if (chD.pos!=null &amp;&amp; chD.pos.isValid()) {
 						tpl.setParam(&quot;LATLON&quot;, chD.LatLon);

Modified: trunk/src/CacheWolf/myTableModel.java
===================================================================
--- trunk/src/CacheWolf/myTableModel.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/myTableModel.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -255,7 +255,7 @@
 					case 9: // Status
 						return ch.CacheStatus;
 					case 10: // Distance
-						return ch.distance;
+						return ch.getDistance();
 					case 11: // Bearing
 						return ch.bearing;
 					case 12: // Size

Modified: trunk/src/CacheWolf/navi/GotoPanel.java
===================================================================
--- trunk/src/CacheWolf/navi/GotoPanel.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/navi/GotoPanel.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -545,19 +545,36 @@
 		
 		g.setColor(Color.Black);		
 		
+		int metricSystem = Global.getPref().metricSystem;
 		Double tmp = new Double();
 		strTemp = &quot;&quot;;
-		if ( distance &gt;= 0.0f ) {
-			tmp.set(distance);
-			if (tmp.value &gt;= 1){
-				strTemp = MyLocale.formatDouble(tmp,&quot;0.000&quot;)+ &quot; km&quot;;
+		double newDistance = 0;
+		int bigUnit = -1; 
+		int smallUnit = -1;
+		double threshold = -1;
+		// Allow for different metric systems
+		if (metricSystem == Metrics.METRIC) {
+			bigUnit = Metrics.KILOMETER;
+			smallUnit = Metrics.METER;
+			threshold = 1.0;
+			newDistance = distance;
+		} else if (metricSystem == Metrics.IMPERIAL) {
+			// Why these values? See: <A HREF="http://tinyurl.com/b4nn9m">http://tinyurl.com/b4nn9m</A>
+			bigUnit = Metrics.MILES;
+			smallUnit = Metrics.FEET;
+			threshold = 0.1;
+			newDistance = Metrics.convertUnit(distance, Metrics.KILOMETER, Metrics.MILES);
+		}
+		if ( newDistance &gt;= 0.0f ) {
+			tmp.set(newDistance);
+			if (tmp.value &gt;= threshold){
+				strTemp = MyLocale.formatDouble(tmp,&quot;0.000&quot;)+ &quot; &quot; + Metrics.getUnit(bigUnit);
+			} else {
+				tmp.set(Metrics.convertUnit(tmp.value, bigUnit, smallUnit));
+				strTemp = tmp.toString(3,0,0) + &quot; &quot; + Metrics.getUnit(smallUnit);
 			}
-			else {
-				tmp.set(tmp.value * 1000);
-				strTemp = tmp.toString(3,0,0) + &quot; m&quot;;
-			}
 		}
-		else strTemp = &quot;--- km&quot;;
+		else strTemp = &quot;--- &quot;+Metrics.getUnit(bigUnit);
 		g.drawText(strTemp, 2, lineHeight);
 		
 		tmp.set(gotoDir);
@@ -574,14 +591,25 @@
 		
 		Double tmp = new Double();
 
-		tmp.set(m_speed);
-		String strSpeed = &quot;- km/h&quot;;
-		if (m_speed &gt;= 0) {
-			if (m_speed &gt;= 100) {
-				strSpeed = MyLocale.formatDouble(tmp,&quot;0&quot;) + &quot; km/h&quot;;				
+		String strSpeed = null;
+		String unit = null;
+
+		// Allow for different metric systems
+		if (Global.getPref().metricSystem == Metrics.METRIC) {
+			tmp.set(m_speed);
+			unit = &quot; km&quot;;
+			strSpeed = &quot;- km/k&quot;;
+		} else if (Global.getPref().metricSystem == Metrics.IMPERIAL) {
+			tmp.set(Metrics.convertUnit(m_speed, Metrics.KILOMETER, Metrics.MILES));
+			unit = &quot; mph&quot;;
+			strSpeed = &quot;- mph&quot;;
+		}
+		if (tmp.value &gt;= 0) {
+			if (tmp.value &gt;= 100) {
+				strSpeed = MyLocale.formatDouble(tmp,&quot;0&quot;) + unit;				
 			}
 			else {
-				strSpeed = MyLocale.formatDouble(tmp,&quot;0.0&quot;) + &quot; km/h&quot;;
+				strSpeed = MyLocale.formatDouble(tmp,&quot;0.0&quot;) + unit;
 			}
 		}
 		

Added: trunk/src/CacheWolf/navi/Metrics.java
===================================================================
--- trunk/src/CacheWolf/navi/Metrics.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/CacheWolf/navi/Metrics.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -0,0 +1,106 @@
+/**
+ * 
+ */
+package CacheWolf.navi;
+
+/**
+ * @author Engywuck
+ *
+ */
+public final class Metrics {
+
+	/** Constant for use of metric units */
+	public static final int METRIC = 1;
+	/** Constant for use of imperial units */
+	public static final int IMPERIAL = 2;
+	
+	public static final int KILOMETER = 10;
+	public static final int METER  = 11;
+	
+	public static final int MILES = 20;
+	public static final int YARDS = 21;
+	public static final int FEET  = 22;
+	
+	private static final double FCT_MILE2KILOMETER = 1.609344;
+	private static final double FCT_MILE2YARD = 1760;
+	private static final double FCT_MILE2FOOT = 5280;
+	
+	public static final double convertUnit(double value, int sourceUnit, int targetUnit) {
+		double result = Double.NaN;
+		if (sourceUnit == targetUnit) {
+			result = value;
+		} else {
+			switch (sourceUnit) {
+			case KILOMETER:
+				switch (targetUnit) {
+				case MILES:
+					result = value / FCT_MILE2KILOMETER;
+					break;
+				}
+				break;
+			case MILES:
+				switch (targetUnit) {
+				case KILOMETER:
+					result = value * FCT_MILE2KILOMETER;
+					break;
+				case YARDS:
+					result = value * FCT_MILE2YARD;
+					break;
+				case FEET:
+					result = value * FCT_MILE2FOOT;
+					break;
+				}
+				break;
+			case YARDS:
+				switch (targetUnit) {
+				case MILES:
+					result = value / FCT_MILE2YARD;
+					break;
+				case FEET:
+					result = value / FCT_MILE2YARD * FCT_MILE2FOOT;
+					break;
+				}
+				break;
+			case FEET:
+				switch (targetUnit) {
+				case MILES:
+					result = value / FCT_MILE2FOOT;
+					break;
+				case YARDS:
+					result = value * FCT_MILE2YARD / FCT_MILE2FOOT;
+					break;
+				}
+				break;
+			}
+		}
+		if (result == Double.NaN) {
+			// TODO Meldung verbessern
+			throw new UnsupportedOperationException(&quot;Cannot convert&quot;);
+		}
+		return result;
+	}
+	
+	public static final String getUnit(int unit) {
+		String result=null;
+		switch (unit) {
+		case KILOMETER:
+			result = &quot;km&quot;;
+			break;
+		case METER:
+			result = &quot;m&quot;;
+			break;
+		case MILES:
+			result = &quot;mi.&quot;;
+			break;
+		case YARDS:
+			result = &quot;yd.&quot;;
+			break;
+		case FEET:
+			result = &quot;ft.&quot;;
+			break;
+		default:
+			throw new UnsupportedOperationException(&quot;Unknown unit: &quot;+String.valueOf(unit));			
+		}
+		return result;
+	}
+}

Modified: trunk/src/exp/HTMLExporter.java
===================================================================
--- trunk/src/exp/HTMLExporter.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/exp/HTMLExporter.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -92,7 +92,7 @@
 					varParams.put(&quot;OWNER&quot;, holder.CacheOwner);
 					varParams.put(&quot;DIFFICULTY&quot;, holder.hard);
 					varParams.put(&quot;TERRAIN&quot;, holder.terrain);
-					varParams.put(&quot;DISTANCE&quot;, holder.distance);
+					varParams.put(&quot;DISTANCE&quot;, holder.getDistance());
 					varParams.put(&quot;BEARING&quot;, holder.bearing);
 					varParams.put(&quot;LATLON&quot;, holder.LatLon);
 					varParams.put(&quot;STATUS&quot;, holder.CacheStatus);
@@ -108,7 +108,7 @@
 						page_tpl.setParam(&quot;OWNER&quot;, holder.CacheOwner);
 						page_tpl.setParam(&quot;DIFFICULTY&quot;, holder.hard);
 						page_tpl.setParam(&quot;TERRAIN&quot;, holder.terrain);
-						page_tpl.setParam(&quot;DISTANCE&quot;, holder.distance);
+						page_tpl.setParam(&quot;DISTANCE&quot;, holder.getDistance());
 						page_tpl.setParam(&quot;BEARING&quot;, holder.bearing);
 						page_tpl.setParam(&quot;LATLON&quot;, holder.LatLon);
 						page_tpl.setParam(&quot;STATUS&quot;, holder.CacheStatus);

Modified: trunk/src/exp/TPLExporter.java
===================================================================
--- trunk/src/exp/TPLExporter.java	2009-02-25 19:28:26 UTC (rev 1654)
+++ trunk/src/exp/TPLExporter.java	2009-02-26 19:11:37 UTC (rev 1655)
@@ -206,7 +206,7 @@
 						varParams.put(&quot;OWNER&quot;, holder.CacheOwner);
 						varParams.put(&quot;DIFFICULTY&quot;, dec.replaceAll(holder.hard));
 						varParams.put(&quot;TERRAIN&quot;, dec.replaceAll(holder.terrain));
-						varParams.put(&quot;DISTANCE&quot;, dec.replaceAll(holder.distance));
+						varParams.put(&quot;DISTANCE&quot;, dec.replaceAll(holder.getDistance()));
 						varParams.put(&quot;BEARING&quot;, holder.bearing);
 						varParams.put(&quot;LATLON&quot;, holder.LatLon);
 						varParams.put(&quot;LAT&quot;, dec.replaceAll(holder.pos.getLatDeg(CWPoint.DD)));


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="001564.html">[Cachewolf-svn] r1654 - trunk/src/CacheWolf
</A></li>
	<LI>Next message: <A HREF="001566.html">[Cachewolf-svn] r1656 - trunk/res_noewe/languages
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#1565">[ date ]</a>
              <a href="thread.html#1565">[ thread ]</a>
              <a href="subject.html#1565">[ subject ]</a>
              <a href="author.html#1565">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/cachewolf-svn">More information about the Cachewolf-svn
mailing list</a><br>
</body></html>
